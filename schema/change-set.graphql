# =============================================================================
# Change Set Schema - Atomic Multi-Resource Operations
# =============================================================================
# This schema defines types and operations for atomic multi-resource changes.
# Change sets group related configuration changes and apply them atomically,
# with automatic rollback on failure.
#
# Reference: NAS-4.14 - Implement Change Sets (Atomic Multi-Resource Operations)
# Reference: ADR-012 - Universal State v2
# Reference: FR-STM-013 - Atomic multi-resource operations
# =============================================================================

# -----------------------------------------------------------------------------
# Change Set Status Enum
# -----------------------------------------------------------------------------

"""
Change set lifecycle status
"""
enum ChangeSetStatus {
  "Initial state - adding items, not yet validated"
  DRAFT

  "Running validation on all items"
  VALIDATING

  "All items validated, ready to apply"
  READY

  "Applying resources in dependency order"
  APPLYING

  "All resources applied successfully"
  COMPLETED

  "Apply failed, may have partial application"
  FAILED

  "Rolling back applied changes"
  ROLLING_BACK

  "Rollback completed successfully"
  ROLLED_BACK

  "Rollback partially failed - manual intervention needed"
  PARTIAL_FAILURE

  "User cancelled the operation"
  CANCELLED
}

# -----------------------------------------------------------------------------
# Change Operation Enum
# -----------------------------------------------------------------------------

"""
Type of operation to perform on a resource
"""
enum ChangeOperation {
  "Create a new resource"
  CREATE

  "Update an existing resource"
  UPDATE

  "Delete an existing resource"
  DELETE
}

# -----------------------------------------------------------------------------
# Change Set Item Status Enum
# -----------------------------------------------------------------------------

"""
Status of individual items within a change set
"""
enum ChangeSetItemStatus {
  "Waiting to be applied"
  PENDING

  "Currently being applied"
  APPLYING

  "Successfully applied"
  APPLIED

  "Application failed"
  FAILED

  "Successfully rolled back"
  ROLLED_BACK

  "Rollback failed - manual intervention needed"
  ROLLBACK_FAILED

  "Skipped due to dependency failure"
  SKIPPED
}

# -----------------------------------------------------------------------------
# Change Set Types
# -----------------------------------------------------------------------------

"""
Individual item within a change set
"""
type ChangeSetItem {
  "Unique identifier for this item"
  id: ID!

  "Resource type identifier"
  resourceType: String!

  "Resource category"
  resourceCategory: ResourceCategory!

  "Existing resource UUID (null for create operations)"
  resourceUuid: ID

  "User-friendly name"
  name: String!

  "Optional description"
  description: String

  "Operation to perform"
  operation: ChangeOperation!

  "New/updated configuration"
  configuration: JSON!

  "Previous state (for rollback)"
  previousState: JSON

  "Item IDs this depends on"
  dependencies: [ID!]!

  "Current status"
  status: ChangeSetItemStatus!

  "Error message if failed"
  error: String

  "Apply started timestamp"
  applyStartedAt: DateTime

  "Apply completed timestamp"
  applyCompletedAt: DateTime

  "Order in which this item will be applied"
  applyOrder: Int!
}

"""
Validation error for a change set item
"""
type ChangeSetValidationError {
  "Item ID with validation error"
  itemId: ID!

  "Field path within the item configuration"
  field: String!

  "Error message"
  message: String!

  "Severity level"
  severity: ValidationSeverity!

  "Error code"
  code: String
}

"""
Conflict between change set items
"""
type ChangeSetConflict {
  "First conflicting item ID"
  itemId1: ID!

  "Second conflicting item ID or resource UUID"
  itemId2OrResourceUuid: ID!

  "Whether conflict is with existing resource"
  isExternalConflict: Boolean!

  "Description of the conflict"
  description: String!

  "Suggested resolution"
  resolution: String
}

"""
Validation result for a change set
"""
type ChangeSetValidationResult {
  "Whether the change set can be applied"
  canApply: Boolean!

  "Validation errors (blocking)"
  errors: [ChangeSetValidationError!]!

  "Validation warnings (non-blocking)"
  warnings: [ChangeSetValidationError!]!

  "Detected conflicts"
  conflicts: [ChangeSetConflict!]!

  "Missing dependencies"
  missingDependencies: [MissingDependency!]!

  "Circular dependencies (if any)"
  circularDependencies: [[ID!]!]
}

"""
Missing dependency information
"""
type MissingDependency {
  "Item ID with missing dependency"
  itemId: ID!

  "Missing resource type"
  missingResourceType: String!

  "Missing resource ID"
  missingResourceId: ID!
}

"""
Detailed error for failed change sets
"""
type ChangeSetError {
  "Error message"
  message: String!

  "Item ID that caused the failure"
  failedItemId: ID!

  "Error code"
  code: String

  "Items applied before failure"
  partiallyAppliedItemIds: [ID!]!

  "Items that failed rollback"
  failedRollbackItemIds: [ID!]!

  "Whether manual intervention is required"
  requiresManualIntervention: Boolean!
}

"""
Rollback step for recovery
"""
type RollbackStep {
  "Item ID being rolled back"
  itemId: ID!

  "Rollback operation"
  operation: RollbackOperation!

  "State to restore"
  restoreState: JSON

  "Resource UUID on router"
  resourceUuid: ID

  "Whether rollback succeeded"
  success: Boolean!

  "Error message if failed"
  error: String

  "Order in rollback sequence"
  rollbackOrder: Int!
}

"""
Rollback operation type
"""
enum RollbackOperation {
  "Delete a created resource"
  DELETE

  "Restore a deleted resource"
  RESTORE

  "Revert an updated resource"
  REVERT
}

"""
A change set representing an atomic multi-resource operation
"""
type ChangeSet {
  "Unique identifier (ULID)"
  id: ID!

  "Human-readable name"
  name: String!

  "Optional description"
  description: String

  "Router ID this change set applies to"
  routerId: ID!

  "Items in this change set"
  items: [ChangeSetItem!]!

  "Current status"
  status: ChangeSetStatus!

  "Validation result"
  validation: ChangeSetValidationResult

  "Rollback plan"
  rollbackPlan: [RollbackStep!]!

  "Error information (if failed)"
  error: ChangeSetError

  "Created timestamp"
  createdAt: DateTime!

  "Apply started timestamp"
  applyStartedAt: DateTime

  "Completed timestamp"
  completedAt: DateTime

  "User who created the change set"
  createdBy: String

  "Source wizard/feature"
  source: String

  "Version for optimistic concurrency"
  version: Int!
}

"""
Summary of a change set for list displays
"""
type ChangeSetSummary {
  "Change set ID"
  id: ID!

  "Name"
  name: String!

  "Current status"
  status: ChangeSetStatus!

  "Operation counts"
  operationCounts: OperationCounts!

  "Total items"
  totalItems: Int!

  "Created timestamp"
  createdAt: DateTime!

  "Has validation errors"
  hasErrors: Boolean!

  "Has validation warnings"
  hasWarnings: Boolean!
}

"""
Operation counts by type
"""
type OperationCounts {
  create: Int!
  update: Int!
  delete: Int!
}

# -----------------------------------------------------------------------------
# Progress Event for Subscriptions
# -----------------------------------------------------------------------------

"""
Progress event for real-time updates during apply
"""
type ChangeSetProgressEvent {
  "Change set ID"
  changeSetId: ID!

  "Current status"
  status: ChangeSetStatus!

  "Currently processing item"
  currentItem: CurrentItemInfo

  "Number of items applied"
  appliedCount: Int!

  "Total number of items"
  totalCount: Int!

  "Progress percentage (0-100)"
  progressPercent: Float!

  "Estimated time remaining in milliseconds"
  estimatedRemainingMs: Int

  "Error if failed"
  error: ChangeSetError

  "Timestamp of this event"
  timestamp: DateTime!
}

"""
Current item information in progress event
"""
type CurrentItemInfo {
  id: ID!
  name: String!
  operation: ChangeOperation!
  status: ChangeSetItemStatus!
}

# -----------------------------------------------------------------------------
# Queries
# -----------------------------------------------------------------------------

extend type Query {
  """
  Get a change set by ID
  """
  changeSet(
    "Change set ID"
    id: ID!
    "Router the change set belongs to"
    routerId: ID!
  ): ChangeSet

  """
  List change sets for a router
  """
  changeSets(
    "Router to query"
    routerId: ID!
    "Filter by status"
    status: ChangeSetStatus
    "Include completed/failed (default: false)"
    includeCompleted: Boolean = false
  ): [ChangeSetSummary!]!
}

# -----------------------------------------------------------------------------
# Mutations
# -----------------------------------------------------------------------------

extend type Mutation {
  """
  Create a new change set
  """
  createChangeSet(input: CreateChangeSetInput!): CreateChangeSetPayload!

  """
  Add an item to a change set
  """
  addChangeSetItem(
    changeSetId: ID!
    input: ChangeSetItemInput!
  ): AddChangeSetItemPayload!

  """
  Update an item in a change set
  """
  updateChangeSetItem(
    changeSetId: ID!
    itemId: ID!
    input: UpdateChangeSetItemInput!
  ): UpdateChangeSetItemPayload!

  """
  Remove an item from a change set
  """
  removeChangeSetItem(
    changeSetId: ID!
    itemId: ID!
  ): RemoveChangeSetItemPayload!

  """
  Validate a change set (all items)
  """
  validateChangeSet(changeSetId: ID!): ValidateChangeSetPayload!

  """
  Apply a change set atomically to the router
  """
  applyChangeSet(changeSetId: ID!): ApplyChangeSetPayload!

  """
  Cancel an in-progress change set application
  """
  cancelChangeSet(changeSetId: ID!): CancelChangeSetPayload!

  """
  Force rollback of a failed change set
  """
  rollbackChangeSet(changeSetId: ID!): RollbackChangeSetPayload!

  """
  Delete a change set (only if not applying)
  """
  deleteChangeSet(changeSetId: ID!): DeleteChangeSetPayload!
}

# -----------------------------------------------------------------------------
# Mutation Inputs
# -----------------------------------------------------------------------------

"""
Input for creating a new change set
"""
input CreateChangeSetInput {
  "Router to apply changes to"
  routerId: ID!

  "Human-readable name"
  name: String!

  "Optional description"
  description: String

  "Source wizard/feature"
  source: String
}

"""
Input for adding an item to a change set
"""
input ChangeSetItemInput {
  "Resource type identifier"
  resourceType: String!

  "Resource category"
  resourceCategory: ResourceCategory!

  "Existing resource UUID (for update/delete)"
  resourceUuid: ID

  "User-friendly name"
  name: String!

  "Optional description"
  description: String

  "Operation to perform"
  operation: ChangeOperation!

  "Configuration"
  configuration: JSON!

  "Previous state (for rollback on update/delete)"
  previousState: JSON

  "Item IDs this depends on"
  dependencies: [ID!]
}

"""
Input for updating an item in a change set
"""
input UpdateChangeSetItemInput {
  "Updated name"
  name: String

  "Updated description"
  description: String

  "Updated configuration"
  configuration: JSON

  "Updated dependencies"
  dependencies: [ID!]
}

# -----------------------------------------------------------------------------
# Mutation Payloads
# -----------------------------------------------------------------------------

type CreateChangeSetPayload {
  "The created change set"
  changeSet: ChangeSet
  "Errors that occurred"
  errors: [MutationError!]
}

type AddChangeSetItemPayload {
  "The updated change set"
  changeSet: ChangeSet
  "The added item ID"
  itemId: ID
  "Errors that occurred"
  errors: [MutationError!]
}

type UpdateChangeSetItemPayload {
  "The updated change set"
  changeSet: ChangeSet
  "Errors that occurred"
  errors: [MutationError!]
}

type RemoveChangeSetItemPayload {
  "The updated change set"
  changeSet: ChangeSet
  "Errors that occurred"
  errors: [MutationError!]
}

type ValidateChangeSetPayload {
  "The validated change set"
  changeSet: ChangeSet
  "Validation result"
  validation: ChangeSetValidationResult
  "Errors that occurred"
  errors: [MutationError!]
}

type ApplyChangeSetPayload {
  "Change set ID"
  changeSetId: ID!
  "Current status"
  status: ChangeSetStatus!
  "Errors that occurred"
  errors: [MutationError!]
}

type CancelChangeSetPayload {
  "The cancelled change set"
  changeSet: ChangeSet
  "Whether cancel was successful"
  success: Boolean!
  "Errors that occurred"
  errors: [MutationError!]
}

type RollbackChangeSetPayload {
  "The rolled back change set"
  changeSet: ChangeSet
  "Whether rollback was successful"
  success: Boolean!
  "Items that failed to rollback"
  failedItems: [ID!]
  "Errors that occurred"
  errors: [MutationError!]
}

type DeleteChangeSetPayload {
  "Whether deletion was successful"
  success: Boolean!
  "Errors that occurred"
  errors: [MutationError!]
}

# -----------------------------------------------------------------------------
# Subscriptions
# -----------------------------------------------------------------------------

extend type Subscription {
  """
  Subscribe to change set application progress
  """
  changeSetProgress(
    "Change set ID"
    changeSetId: ID!
  ): ChangeSetProgressEvent!

  """
  Subscribe to change set status changes
  """
  changeSetStatusChanged(
    "Router to subscribe to"
    routerId: ID!
  ): ChangeSetStatusEvent!
}

"""
Change set status change event
"""
type ChangeSetStatusEvent {
  "Change set ID"
  changeSetId: ID!

  "Previous status"
  previousStatus: ChangeSetStatus!

  "New status"
  newStatus: ChangeSetStatus!

  "Error if failed"
  error: ChangeSetError

  "Timestamp"
  timestamp: DateTime!
}
