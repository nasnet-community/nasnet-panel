# ============================================
# TRAFFIC STATISTICS INPUTS AND OPERATIONS
# ============================================

"""
Input for setting a traffic quota on a service instance.
"""
input SetTrafficQuotaInput {
  """
  Router ID
  """
  routerID: ID!

  """
  Instance ID to set quota on
  """
  instanceID: ID!

  """
  Maximum bytes allowed per period (0 = unlimited)
  """
  limitBytes: Int! @validate(min: 0)

  """
  Quota period
  """
  period: QuotaPeriod!

  """
  Action to take when quota is reached
  """
  action: QuotaAction!

  """
  Warning threshold percentage (0-100, default 80)
  """
  warningThreshold: Int @validate(min: 0, max: 100)
}

"""
Payload for traffic quota mutation.
"""
type TrafficQuotaPayload {
  """
  Whether the operation succeeded
  """
  success: Boolean!

  """
  Updated or created quota (null if failed)
  """
  quota: TrafficQuota

  """
  Mutation errors
  """
  errors: [MutationError!]
}

"""
Traffic statistics update event for subscriptions.
Emitted when traffic stats are updated (every 10 seconds).
"""
type TrafficStatsEvent {
  """
  Instance ID
  """
  instanceID: ID!

  """
  Router ID
  """
  routerID: ID!

  """
  Total bytes uploaded
  """
  totalUploadBytes: Int!

  """
  Total bytes downloaded
  """
  totalDownloadBytes: Int!

  """
  Upload bytes since last update
  """
  deltaUploadBytes: Int!

  """
  Download bytes since last update
  """
  deltaDownloadBytes: Int!

  """
  Whether quota warning was triggered
  """
  quotaWarning: Boolean!

  """
  Whether quota limit was reached
  """
  quotaLimitReached: Boolean!

  """
  Timestamp of this update
  """
  timestamp: DateTime!
}

extend type Query {
  """
  Get traffic statistics for a service instance.
  Includes current totals, historical data, and per-device breakdown.
  Requires authentication.
  """
  serviceTrafficStats(
    """
    Router ID
    """
    routerID: ID!

    """
    Instance ID
    """
    instanceID: ID!

    """
    Time range for history (hours, default 24)
    """
    historyHours: Int
  ): ServiceTrafficStats! @auth

  """
  Get per-device traffic breakdown for a service instance.
  Shows which devices are using bandwidth through this service.
  Requires authentication.
  """
  serviceDeviceBreakdown(
    """
    Router ID
    """
    routerID: ID!

    """
    Instance ID
    """
    instanceID: ID!
  ): [DeviceTrafficBreakdown!]! @auth
}

extend type Mutation {
  """
  Set or update traffic quota for a service instance.
  Creates mangle rules to track traffic and enforces limits.
  Requires operator role or higher.
  """
  setTrafficQuota(input: SetTrafficQuotaInput!): TrafficQuotaPayload! @auth(requires: "operator")

  """
  Remove traffic quota from a service instance.
  Removes tracking mangle rules and quota configuration.
  Requires operator role or higher.
  """
  resetTrafficQuota(
    """
    Router ID
    """
    routerID: ID!

    """
    Instance ID
    """
    instanceID: ID!
  ): TrafficQuotaPayload! @auth(requires: "operator")
}

extend type Subscription {
  """
  Subscribe to traffic statistics updates for a service instance.
  Emits updates every 10 seconds with current traffic totals and deltas.
  Requires authentication.
  """
  serviceTrafficUpdated(
    """
    Router ID to subscribe to
    """
    routerID: ID!

    """
    Instance ID to monitor
    """
    instanceID: ID!
  ): TrafficStatsEvent! @auth
}
