# ============================================
# UPDATE MANAGER INPUTS AND OPERATIONS
# ============================================

"""
Input for configuring update check schedule for an instance.
"""
input UpdateCheckScheduleInput {
  """Router ID"""
  routerID: ID!

  """Instance ID"""
  instanceID: ID!

  """Update check schedule (e.g., '6h', '12h', '24h', 'manual')"""
  checkSchedule: String!

  """Minimum severity to auto-apply (CRITICAL, MAJOR, MINOR, PATCH, MANUAL)"""
  autoApplyThreshold: String!
}

extend type Query {
  """
  Get available updates for all instances on a router.
  Returns instances that have updates available.
  """
  availableUpdates(
    """Router ID"""
    routerID: ID!
  ): [UpdateInfo!]!

  """
  Get update information for a specific instance.
  Returns null if no update available.
  """
  instanceUpdateInfo(
    """Router ID"""
    routerID: ID!

    """Instance ID"""
    instanceID: ID!
  ): UpdateInfo
}

extend type Mutation {
  """
  Manually trigger update check for all instances.
  Queries GitHub Releases API for new versions.
  """
  checkForUpdates(
    """Router ID"""
    routerID: ID!
  ): Int!

  """
  Apply an available update to a service instance.
  Uses atomic 6-phase update with rollback on failure.
  """
  updateInstance(
    """Router ID"""
    routerID: ID!

    """Instance ID to update"""
    instanceID: ID!
  ): UpdateResult!

  """
  Update all instances that have critical updates available.
  Returns number of instances updated.
  """
  updateAllInstances(
    """Router ID"""
    routerID: ID!

    """Minimum severity to update (default: CRITICAL)"""
    minSeverity: UpdateSeverity
  ): Int!

  """
  Rollback an instance to its backed-up version.
  Only works if a backup exists (has_backup=true).
  """
  rollbackInstance(
    """Router ID"""
    routerID: ID!

    """Instance ID to rollback"""
    instanceID: ID!
  ): UpdateResult!

  """
  Configure update schedule and auto-apply policy for an instance.
  """
  configureUpdateSchedule(input: UpdateCheckScheduleInput!): ServiceInstance!
}

extend type Subscription {
  """
  Subscribe to update progress for a router.
  Emits progress updates during atomic update process.
  """
  updateProgress(
    """Router ID to subscribe to"""
    routerID: ID!
  ): UpdateProgress!
}
