# Health Monitoring Schema (NAS-8.6: Service Health Monitoring)
# This schema provides real-time health status tracking for service instances
# with composite probes (PID + TCP/HTTP) and auto-restart on failure.

"""
Health status enumeration for service instances
"""
enum InstanceHealthState {
  HEALTHY # All probes passing
  UNHEALTHY # Consecutive failures exceeded threshold
  UNKNOWN # Not yet checked or no probe configured
  CHECKING # Probe in progress
}

"""
Connection status from health probe checks
"""
enum HealthConnectionState {
  CONNECTED # TCP/HTTP probe succeeded
  CONNECTING # Probe in progress
  FAILED # Probe failed
}

"""
Comprehensive health status for a service instance
Combines process liveness, connection status, and latency metrics
"""
type ServiceInstanceHealth {
  """
  Current health state of the instance
  """
  status: InstanceHealthState!

  """
  Whether the service process is alive (PID check)
  """
  processAlive: Boolean!

  """
  Connection status from TCP/HTTP health probe
  """
  connectionStatus: HealthConnectionState!

  """
  Health probe round-trip latency in milliseconds (null if probe hasn't run)
  """
  latencyMs: Int

  """
  Timestamp of when the instance was last healthy (null if never healthy)
  """
  lastHealthy: DateTime

  """
  Number of consecutive health check failures
  """
  consecutiveFails: Int!

  """
  Instance uptime in seconds (null if not running)
  """
  uptimeSeconds: Int
}

"""
Health check configuration for a service instance
"""
type ServiceInstanceHealthConfig {
  """
  Health check interval in seconds (10-300, default: 30)
  """
  intervalSeconds: Int!

  """
  Consecutive failures before marking unhealthy (1-10, default: 3)
  """
  failureThreshold: Int!

  """
  Whether to auto-restart on health check failure (default: true)
  """
  autoRestart: Boolean!
}

"""
Input for configuring health check settings
"""
input ConfigureHealthCheckInput {
  """
  Instance ID to configure
  """
  instanceID: ID!

  """
  Health check interval in seconds (10-300)
  """
  intervalSeconds: Int

  """
  Consecutive failures before marking unhealthy (1-10)
  """
  failureThreshold: Int

  """
  Whether to enable auto-restart on failure
  """
  autoRestart: Boolean
}

extend type Query {
  """
  Get current health status for a service instance
  Returns null if instance not found or health monitoring not enabled
  """
  instanceHealth(
    """
    Router ID
    """
    routerID: ID!
    """
    Service instance ID
    """
    instanceID: ID!
  ): ServiceInstanceHealth
}

extend type Mutation {
  """
  Configure health check settings for a service instance
  Allows adjusting check interval, failure threshold, and auto-restart behavior
  """
  configureHealthCheck(input: ConfigureHealthCheckInput!): ServiceInstanceHealth!
}

extend type Subscription {
  """
  Real-time health status changes for a service instance
  Streams updates when health state transitions (HEALTHY â†” UNHEALTHY)
  """
  instanceHealthChanged(
    """
    Router ID to filter events
    """
    routerID: ID!
    """
    Optional instance ID to filter specific instance (null = all instances on router)
    """
    instanceID: ID
  ): ServiceInstanceHealth!
}
