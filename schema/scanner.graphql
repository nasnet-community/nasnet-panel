# =============================================================================
# Network Scanner GraphQL Schema
# =============================================================================
# Types for router auto-discovery and network scanning functionality.
# Enables users to discover MikroTik routers on their network without knowing
# their IP addresses.
#
# Story: NAS-3.4 - Implement Router Auto Scanner
# =============================================================================

# -----------------------------------------------------------------------------
# Scan Status Enum
# -----------------------------------------------------------------------------

"""
Status of a network scan operation
"""
enum ScanStatus {
  "Scan is queued and waiting to start"
  PENDING
  "Scan is actively running"
  RUNNING
  "Scan completed successfully"
  COMPLETED
  "Scan was cancelled by user"
  CANCELLED
  "Scan failed with an error"
  FAILED
}

# -----------------------------------------------------------------------------
# Core Types
# -----------------------------------------------------------------------------

"""
Information about a discovered RouterOS device
"""
type RouterOSInfo {
  "RouterOS version string (e.g., '7.12', '6.49.8')"
  version: String
  "Router board name (e.g., 'hAP acÂ³', 'CCR2004-1G-12S+2XS')"
  boardName: String
  "CPU architecture (e.g., 'arm', 'x86', 'mips')"
  architecture: String
  "Platform identifier"
  platform: String
}

"""
A device discovered during a network scan.
Only confirmed MikroTik devices are returned (confidence >= 40).
"""
type DiscoveredDevice {
  "IP address of the discovered device"
  ip: String!
  "Hostname (if reverse DNS resolves)"
  hostname: String
  "Open ports found on the device"
  ports: [Int!]!
  "Device type classification"
  deviceType: String!
  "Device vendor (always 'MikroTik' for returned results)"
  vendor: String
  "RouterOS-specific information (version, board, architecture)"
  routerOSInfo: RouterOSInfo
  "Confidence score for RouterOS detection (40-100)"
  confidence: Int!
  "Detected services (mikrotik-api, mikrotik-winbox, mikrotik-rest, etc.)"
  services: [String!]!
}

"""
A network scan task that tracks scan progress and results.
Scans are asynchronous - start with mutation, poll/subscribe for progress.
"""
type ScanTask {
  "Unique task identifier"
  id: ID!
  "Target subnet (CIDR notation, IP range, or gateway scan indicator)"
  subnet: String!
  "Current scan status"
  status: ScanStatus!
  "Scan progress percentage (0-100)"
  progress: Int!
  "Discovered devices (populated as scan progresses)"
  results: [DiscoveredDevice!]!
  "When the scan was started"
  startTime: DateTime!
  "When the scan completed (null if still running)"
  endTime: DateTime
  "Error message if scan failed"
  error: String
  "Total IPs to scan (for progress calculation)"
  totalIPs: Int
  "Number of IPs scanned so far"
  scannedIPs: Int
}

"""
Real-time progress event for scan subscriptions
"""
type ScanProgressEvent {
  "Task ID this event belongs to"
  taskId: ID!
  "Current progress percentage (0-100)"
  progress: Int!
  "Number of MikroTik devices found so far"
  devicesFound: Int!
  "IP address currently being scanned"
  currentIP: String
  "Current scan status"
  status: ScanStatus!
  "Timestamp of this progress update"
  timestamp: DateTime!
}

# -----------------------------------------------------------------------------
# Input Types
# -----------------------------------------------------------------------------

"""
Input for starting a network scan
"""
input ScanNetworkInput {
  "Target subnet in CIDR notation (e.g., '192.168.88.0/24') or IP range (e.g., '192.168.1.1-192.168.1.100')"
  subnet: String! @validate(minLength: 7, maxLength: 43)
}

# -----------------------------------------------------------------------------
# Mutation Payloads
# -----------------------------------------------------------------------------

type ScanNetworkPayload {
  "The created scan task"
  task: ScanTask
  "Errors that occurred"
  errors: [MutationError!]
}

type CancelScanPayload {
  "The cancelled scan task"
  task: ScanTask
  "Errors that occurred"
  errors: [MutationError!]
}

# -----------------------------------------------------------------------------
# Query Extensions
# -----------------------------------------------------------------------------

extend type Query {
  "Get the status of a scan task by ID"
  scanStatus(taskId: ID!): ScanTask

  "Get scan history (recent scans)"
  scanHistory(
    "Maximum number of results to return"
    limit: Int = 10
  ): [ScanTask!]!
}

# -----------------------------------------------------------------------------
# Mutation Extensions
# -----------------------------------------------------------------------------

extend type Mutation {
  """
  Start a network scan for MikroTik routers.
  Returns a task ID that can be used to track progress via subscription or polling.

  Supported subnet formats:
  - CIDR: "192.168.88.0/24" (scans 254 usable IPs)
  - Range: "192.168.1.1-192.168.1.100" (scans specified range)
  - Single IP: "192.168.88.1" (scans one IP)

  Performance: /24 scan completes in 1-2 seconds with 20 concurrent workers.
  """
  scanNetwork(input: ScanNetworkInput!): ScanNetworkPayload!

  """
  Start an automatic gateway scan.
  Scans common gateway IPs (192.168.0-255.1) to find MikroTik routers.
  This is useful when the user doesn't know which subnet to scan.

  Only returns verified MikroTik RouterOS devices (confidence >= 40).
  """
  autoScanGateways: ScanNetworkPayload!

  """
  Cancel a running scan.
  The scan will stop within 1 second and partial results are preserved.
  """
  cancelScan(taskId: ID!): CancelScanPayload!
}

# -----------------------------------------------------------------------------
# Subscription Extensions
# -----------------------------------------------------------------------------

extend type Subscription {
  """
  Subscribe to real-time scan progress updates.
  Emits events every 5% progress or every 2 seconds, whichever is sooner.
  """
  scanProgress(taskId: ID!): ScanProgressEvent!
}
