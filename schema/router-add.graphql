# =============================================================================
# Router Addition GraphQL Schema Extension
# =============================================================================
# This schema provides types and operations for manually adding routers with
# credential validation, protocol preference, and connection testing.
# Story: NAS-3.8 - Implement Manual Router Addition Flow
# =============================================================================

# -----------------------------------------------------------------------------
# Protocol Preference Enum
# -----------------------------------------------------------------------------

"""
User preference for which protocol to use when connecting to a router.
AUTO will try protocols in the recommended fallback order.
"""
enum ProtocolPreference {
  "Automatically detect best protocol (REST -> API -> API_SSL -> SSH -> Telnet)"
  AUTO
  "Force REST API protocol (RouterOS 7.1+)"
  REST
  "Force Binary API protocol (port 8728)"
  API
  "Force TLS-encrypted binary API (port 8729)"
  API_SSL
  "Force SSH protocol (port 22)"
  SSH
  "Force Telnet protocol (port 23, insecure - use only as last resort)"
  TELNET
}

# -----------------------------------------------------------------------------
# Input Types
# -----------------------------------------------------------------------------

"""
Input for manually adding a new router with full credentials and protocol preference.
This is the primary input type for the addRouter mutation.
"""
input AddRouterInput {
  """
  Router hostname or IP address.
  Can be an IPv4 address (e.g., '192.168.88.1'), IPv6 address, or hostname (e.g., 'router.local').
  Hostnames will trigger DNS resolution with caching.
  """
  host: String! @validate(minLength: 1, maxLength: 253)

  """
  Connection port. If not specified, defaults to protocol-specific port:
  - REST: 443 (or 80 for HTTP)
  - API: 8728
  - API_SSL: 8729
  - SSH: 22
  - Telnet: 23
  """
  port: Int @validate(min: 1, max: 65535)

  """
  Username for authentication.
  For MikroTik routers, this is typically 'admin' or a custom user.
  """
  username: String! @validate(minLength: 1, maxLength: 64)

  """
  Password for authentication.
  This value is encrypted before storage and never logged.
  """
  password: String! @sensitive

  """
  Protocol preference for connection.
  Defaults to AUTO which tries protocols in recommended order.
  """
  protocolPreference: ProtocolPreference

  """
  User-friendly display name for the router.
  If not provided, a name will be generated from the host.
  """
  name: String @validate(maxLength: 128)
}

# -----------------------------------------------------------------------------
# Connection Test Result
# -----------------------------------------------------------------------------

"""
Result of a connection test attempt, including protocol detection results.
"""
type ConnectionTestResult {
  "Whether the connection was successful"
  success: Boolean!

  "Protocol that was successfully used"
  protocolUsed: Protocol

  "Response time in milliseconds"
  responseTimeMs: Int

  "RouterOS version detected (if connection succeeded)"
  routerVersion: String

  "Router model detected (if connection succeeded)"
  routerModel: String

  "Router board name (if connection succeeded)"
  boardName: String

  "Uptime of the router (if connection succeeded)"
  uptime: Duration

  "List of protocols that were attempted"
  protocolsAttempted: [Protocol!]!

  "Whether the router supports containers"
  supportsContainers: Boolean

  "Architecture of the router (arm, arm64, x86, etc.)"
  architecture: String

  "Error details if connection failed"
  error: ConnectionError
}

"""
Detailed error information for connection failures.
Used to provide actionable feedback to the user.
"""
type ConnectionError {
  "Error code for programmatic handling"
  code: ConnectionErrorCode!

  "Human-readable error message"
  message: String!

  "Protocol that failed (if specific to a protocol)"
  protocol: Protocol

  "Whether the error is likely transient and retryable"
  retryable: Boolean!

  "Suggested user action to resolve the error"
  suggestedAction: String

  "Timeout in milliseconds (if timeout error)"
  timeoutMs: Int
}

"""
Error codes for connection failures.
Each code has specific meaning and recovery suggestions.
"""
enum ConnectionErrorCode {
  "Authentication failed - invalid username or password"
  AUTH_FAILED
  "Network unreachable - cannot reach the host"
  NETWORK_UNREACHABLE
  "Connection refused - port is closed or blocked"
  CONNECTION_REFUSED
  "No compatible protocol found after trying all options"
  PROTOCOL_MISMATCH
  "Connection or response timed out"
  TIMEOUT
  "DNS resolution failed for hostname"
  DNS_FAILED
  "Router with same host/port already exists"
  DUPLICATE_ROUTER
  "TLS/SSL handshake failed"
  TLS_ERROR
  "Router responded but is not a MikroTik device"
  NOT_MIKROTIK
  "Unknown or unexpected error"
  UNKNOWN
}

# -----------------------------------------------------------------------------
# Mutation Payload
# -----------------------------------------------------------------------------

"""
Field-level validation error with suggestions for fixing.
"""
type ValidationError {
  "Field path that failed validation (e.g., 'input.host', 'input.port')"
  field: String!

  "Error code for the validation failure"
  code: String!

  "Human-readable error message"
  message: String!

  "Suggestion for fixing the validation error"
  suggestion: String

  "The invalid value (redacted for sensitive fields)"
  providedValue: String
}

"""
Payload returned from the addRouter mutation.
Contains either the created router or validation/connection errors.
"""
type AddRouterPayload {
  "The newly created router (null if errors occurred)"
  router: Router

  "Connection test result from initial connection attempt"
  connectionResult: ConnectionTestResult

  "Field-level validation errors for retry"
  validationErrors: [ValidationError!]

  "General errors that occurred during creation"
  errors: [MutationError!]
}

# -----------------------------------------------------------------------------
# Mutation Extension
# -----------------------------------------------------------------------------

extend type Mutation {
  """
  Add a new router by entering its IP address and credentials.

  This mutation will:
  1. Validate input fields (host format, port range, etc.)
  2. Check for duplicate routers (same host/port)
  3. Resolve hostname to IP if necessary (with DNS caching)
  4. Test connection using protocol preference (or auto-detect)
  5. Store router with encrypted credentials on success
  6. Emit RouterAddedEvent for real-time updates

  Returns validation errors if input is invalid, or connection errors
  if the router cannot be reached or authenticated.
  """
  addRouter(input: AddRouterInput!): AddRouterPayload!

  """
  Test connection to a router without adding it.
  Useful for validating credentials before committing.
  """
  testRouterCredentials(input: AddRouterInput!): ConnectionTestResult!
}

# -----------------------------------------------------------------------------
# Subscription Extension
# -----------------------------------------------------------------------------

extend type Subscription {
  """
  Subscribe to router addition events.
  Emits when a new router is successfully added to the system.
  """
  routerAdded: RouterAddedEvent!
}

"""
Event emitted when a new router is added.
"""
type RouterAddedEvent {
  "The newly added router"
  router: Router!

  "Protocol used for initial connection"
  protocolUsed: Protocol!

  "User who added the router (if authenticated)"
  addedBy: String

  "Timestamp of addition"
  timestamp: DateTime!
}
