# =============================================================================
# Connection Diagnostics - Circuit Breaker and Operations
# =============================================================================
# Circuit breaker status type and query/mutation/subscription extensions
# for diagnostics.
# Story: NAS-3.10 - Implement Connection Diagnostics
# =============================================================================

# -----------------------------------------------------------------------------
# Circuit Breaker Types
# -----------------------------------------------------------------------------

"""
Circuit breaker status for a router
"""
type CircuitBreakerStatus {
  "Router ID"
  routerId: ID!
  "Current circuit breaker state"
  state: CircuitBreakerState!
  "Number of consecutive failures"
  failureCount: Int!
  "Failure threshold before circuit opens"
  failureThreshold: Int!
  "Seconds until auto-retry (when circuit is open)"
  cooldownRemainingSeconds: Int
  "When the last failure occurred"
  lastFailureAt: DateTime
  "When the last success occurred"
  lastSuccessAt: DateTime
}

# -----------------------------------------------------------------------------
# Query Extensions
# -----------------------------------------------------------------------------

extend type Query {
  """
  Get recent connection attempts for a router.
  Returns the most recent attempts, ordered newest first.
  """
  connectionAttempts(
    "Router ID to get attempts for"
    routerId: ID!
    "Maximum number of attempts to return (default: 10)"
    limit: Int = 10
  ): [ConnectionAttempt!]!

  """
  Get circuit breaker status for a router.
  Shows current state, failure counts, and cooldown timing.
  """
  circuitBreakerStatus(routerId: ID!): CircuitBreakerStatus!
}

# -----------------------------------------------------------------------------
# Mutation Extensions
# -----------------------------------------------------------------------------

extend type Mutation {
  """
  Run comprehensive diagnostics on a router connection.
  Performs network reachability check, port scanning, TLS validation,
  and authentication testing. Rate limited to 1 request per 10 seconds per router.
  """
  runDiagnostics(routerId: ID!): DiagnosticReport!

  """
  Manually reset the circuit breaker for a router.
  This allows immediate reconnection attempts even if the circuit is open.
  Use with caution as it bypasses the backoff protection.
  """
  resetCircuitBreaker(routerId: ID!): CircuitBreakerStatus!
}

# -----------------------------------------------------------------------------
# Subscription Extensions
# -----------------------------------------------------------------------------

extend type Subscription {
  """
  Subscribe to circuit breaker state changes for a router.
  Emits an event whenever the circuit breaker transitions between states.
  """
  circuitBreakerStateChanged(
    "Router ID to monitor (optional, all routers if not specified)"
    routerId: ID
  ): CircuitBreakerStatus!
}
