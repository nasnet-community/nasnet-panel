# =============================================================================
# Credential Management GraphQL Schema
# =============================================================================
# This schema defines types and operations for managing router credentials.
#
# Security Notes:
# - Passwords are NEVER returned in any query or mutation response
# - All credential fields use AES-256-GCM encryption at rest
# - Credential changes are logged to the audit trail (without values)
# - The @sensitive directive marks fields that should be redacted in logs
# =============================================================================

# -----------------------------------------------------------------------------
# Credential Types
# -----------------------------------------------------------------------------

"""
Router credential information (non-sensitive).
Password is never included - only metadata about credentials.
"""
type RouterCredentials {
  "Router ID these credentials belong to"
  routerId: ID!
  "Username for router authentication"
  username: String!
  "Whether a password is stored"
  hasPassword: Boolean!
  "Encryption algorithm used (always 'AES-256-GCM')"
  encryptionStatus: String!
  "Encryption key version (for rotation tracking)"
  keyVersion: Int!
  "When credentials were last updated"
  lastUpdated: DateTime!
  "When credentials were first created"
  createdAt: DateTime!
}

"""
Input for updating router credentials.
Both username and password must be provided.
"""
input CredentialsInput {
  "Username for router authentication"
  username: String! @validate(minLength: 1, maxLength: 64) @sensitive
  "Password for router authentication"
  password: String! @validate(minLength: 1, maxLength: 128) @sensitive
}

"""
Result of updating router credentials.
"""
type CredentialUpdatePayload {
  "Whether the update was successful"
  success: Boolean!
  "Human-readable message about the operation"
  message: String!
  "Updated credential info (without password)"
  credentials: RouterCredentials
  "Error code if update failed"
  errorCode: CredentialErrorCode
  "Errors that occurred during update"
  errors: [MutationError!]
}

"""
Error codes specific to credential operations.
"""
enum CredentialErrorCode {
  "Authentication failed with new credentials"
  AUTH_FAILED
  "Connection timed out when testing credentials"
  TIMEOUT
  "Connection was refused"
  CONNECTION_REFUSED
  "Router not found"
  ROUTER_NOT_FOUND
  "Credentials not found for router"
  CREDENTIALS_NOT_FOUND
  "Encryption failed"
  ENCRYPTION_FAILED
  "Decryption failed (key may have rotated)"
  DECRYPTION_FAILED
  "Invalid input provided"
  INVALID_INPUT
}

# -----------------------------------------------------------------------------
# Bulk Testing Types
# -----------------------------------------------------------------------------

"""
Result of testing all router credentials.
"""
type TestAllCredentialsPayload {
  "Total number of routers tested"
  totalRouters: Int!
  "Number of successful credential tests"
  successCount: Int!
  "Number of failed credential tests"
  failureCount: Int!
  "Per-router test results"
  results: [CredentialTestResult!]!
}

"""
Result of testing a single router's credentials.
"""
type CredentialTestResult {
  "Router ID that was tested"
  routerId: ID!
  "Router name for display"
  routerName: String!
  "Whether the test was successful"
  success: Boolean!
  "Connection status"
  status: CredentialTestStatus!
  "Response time in milliseconds (if successful)"
  responseTimeMs: Int
  "Error message if test failed"
  error: String
}

"""
Status of a credential test.
"""
enum CredentialTestStatus {
  "Credentials are valid and connection succeeded"
  SUCCESS
  "Authentication failed"
  AUTH_FAILED
  "Connection timed out"
  TIMEOUT
  "Connection was refused"
  CONNECTION_REFUSED
  "Network unreachable"
  NETWORK_ERROR
  "No credentials stored for this router"
  NO_CREDENTIALS
  "Unknown error occurred"
  ERROR
}

# -----------------------------------------------------------------------------
# Export Security Types
# -----------------------------------------------------------------------------

"""
Options for exporting router configuration.
"""
input ExportConfigInput {
  "Router ID to export configuration from"
  routerId: ID!
  "Whether to include credentials (requires encryptionKey if true)"
  includeCredentials: Boolean
  "User-provided encryption key for credential export (required if includeCredentials is true)"
  encryptionKey: String @sensitive
}

"""
Result of exporting router configuration.
"""
type ExportConfigPayload {
  "Whether the export was successful"
  success: Boolean!
  "Exported configuration data (JSON format)"
  config: JSON
  "Security warning message about credential handling"
  securityWarning: String
  "Errors that occurred during export"
  errors: [MutationError!]
}

# -----------------------------------------------------------------------------
# Query Extensions
# -----------------------------------------------------------------------------

extend type Query {
  "Get credential information for a router (password is never returned)"
  routerCredentials(routerId: ID!): RouterCredentials @auth
}

# -----------------------------------------------------------------------------
# Mutation Extensions
# -----------------------------------------------------------------------------

extend type Mutation {
  """
  Update router credentials.
  Tests the new credentials before saving.
  Old credentials are preserved if the test fails.
  """
  updateRouterCredentials(
    routerId: ID!
    input: CredentialsInput!
  ): CredentialUpdatePayload! @auth

  """
  Test all router credentials in parallel.
  Returns aggregate results with per-router status.
  """
  testAllCredentials: TestAllCredentialsPayload! @auth

  """
  Export router configuration with optional credential handling.
  Credentials are excluded by default for security.
  If includeCredentials is true, an encryptionKey must be provided.
  """
  exportRouterConfig(input: ExportConfigInput!): ExportConfigPayload! @auth
}
