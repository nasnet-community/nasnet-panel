name: PR Check

on:
  pull_request:
    branches:
      - main
      - master

permissions:
  actions: read
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20
  # Coverage thresholds (warning mode, not blocking)
  COVERAGE_LINE_THRESHOLD: 80
  COVERAGE_BRANCH_THRESHOLD: 75

jobs:
  # ============================================================================
  # Stage 1: Fast Feedback (< 5 min target)
  # Run lint, typecheck, and unit tests in parallel
  # ============================================================================

  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      affected-lint: ${{ steps.affected.outputs.lint }}
      affected-test: ${{ steps.affected.outputs.test }}
      affected-build: ${{ steps.affected.outputs.build }}
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Determine affected projects
        id: affected
        run: |
          echo "lint=$(npx nx show projects --affected -t lint --base=origin/${{ github.base_ref }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "test=$(npx nx show projects --affected -t test --base=origin/${{ github.base_ref }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "build=$(npx nx show projects --affected -t build --base=origin/${{ github.base_ref }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.affected-lint != ''
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
            echo "✓ Nx Cloud enabled"
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Run lint (affected)
        run: npx nx affected -t lint --base=origin/${{ github.base_ref }}

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Run typecheck (affected)
        run: npx nx affected -t typecheck --base=origin/${{ github.base_ref }}

  codegen-check:
    name: GraphQL Codegen Sync
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Check GraphQL codegen sync
        run: |
          echo "Running GraphQL code generation..."
          npm run codegen:ts || {
            echo "::error::TypeScript codegen failed"
            exit 1
          }

          echo "Checking for uncommitted changes in generated files..."
          if git diff --exit-code libs/api-client/generated/; then
            echo "✓ Generated TypeScript code is in sync with schema"
          else
            echo "::error::Generated TypeScript code is out of sync with GraphQL schema"
            echo ""
            echo "The following files have uncommitted changes:"
            git diff --name-only libs/api-client/generated/
            echo ""
            echo "Please run 'npm run codegen' and commit the generated files."
            exit 1
          fi

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.affected-test != ''
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Run frontend tests (affected)
        run: npx nx affected -t test --base=origin/${{ github.base_ref }} --coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: |
            coverage/
            **/coverage/
          retention-days: 7

      - name: Check coverage thresholds
        if: always()
        run: |
          echo "::notice::Coverage check is in warning mode (not blocking)"
          echo "Line coverage threshold: $COVERAGE_LINE_THRESHOLD%"
          echo "Branch coverage threshold: $COVERAGE_BRANCH_THRESHOLD%"
          # Coverage is enforced by vitest.config.ts thresholds
          # When ready to block on coverage, uncomment the following:
          # if [ -f "coverage/coverage-summary.json" ]; then
          #   npx nyc check-coverage --lines $COVERAGE_LINE_THRESHOLD --branches $COVERAGE_BRANCH_THRESHOLD
          # fi

  test-backend:
    name: Backend Tests (Go)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: apps/backend/go.sum

      - name: Run Go tests
        working-directory: apps/backend
        run: |
          go test -v -tags=test -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: apps/backend/coverage.out
          retention-days: 7

      - name: Check Go coverage thresholds
        working-directory: apps/backend
        if: always()
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Go coverage: ${COVERAGE}%"
          echo "::notice::Go coverage threshold check is in warning mode"
          # When ready to block on coverage, uncomment:
          # if (( $(echo "$COVERAGE < $COVERAGE_LINE_THRESHOLD" | bc -l) )); then
          #   echo "::error::Go coverage ${COVERAGE}% is below threshold $COVERAGE_LINE_THRESHOLD%"
          #   exit 1
          # fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-frontend, test-backend]
    # Run build even if lint/test are skipped (no affected projects)
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Build (affected)
        run: npx nx affected -t build --base=origin/${{ github.base_ref }}

      - name: Check bundle size
        run: |
          if [ -f "dist/apps/connect/index.html" ]; then
            npm run build:check || echo "::warning::Bundle size check failed"
          else
            echo "No connect build output to check"
          fi

  # ============================================================================
  # Storybook Build Validation
  # ============================================================================

  storybook:
    name: Storybook Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Build Storybook (Primitives)
        run: npx nx run ui-primitives:build-storybook

      - name: Build Storybook (Patterns)
        run: npx nx run ui-patterns:build-storybook

      - name: Upload Storybook Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: storybook-preview
          path: |
            dist/storybook/ui-primitives
            dist/storybook/ui-patterns
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Docker Build Validation (PR only - no push)
  # ============================================================================

  docker-build:
    name: Docker Build (validate)
    runs-on: ubuntu-latest
    needs: build
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Build Docker image (amd64 only for PR)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file apps/backend/Dockerfile \
            --tag nasnet-test:pr-${{ github.event.pull_request.number }} \
            --load \
            .

      - name: Check Docker image size
        run: |
          SIZE=$(docker image inspect nasnet-test:pr-${{ github.event.pull_request.number }} --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"

          # Hard limit: 20MB (blocking)
          if [ $SIZE_MB -gt 20 ]; then
            echo "::error::Docker image size (${SIZE_MB}MB) exceeds hard limit of 20MB"
            exit 1
          fi

          # Warning threshold: 15MB
          if [ $SIZE_MB -gt 15 ]; then
            echo "::warning::Docker image size (${SIZE_MB}MB) exceeds warning threshold of 15MB"
          else
            echo "✓ Docker image size is within limits"
          fi

  # ============================================================================
  # Final Status Check
  # ============================================================================

  pr-status:
    name: PR Status
    runs-on: ubuntu-latest
    needs: [lint, typecheck, codegen-check, test-frontend, test-backend, build, docker-build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "TypeScript: ${{ needs.typecheck.result }}"
          echo "Codegen: ${{ needs.codegen-check.result }}"
          echo "Frontend Tests: ${{ needs.test-frontend.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Docker: ${{ needs.docker-build.result }}"

          # Fail if any required job failed
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.codegen-check.result }}" == "failure" ]] || \
             [[ "${{ needs.test-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.test-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
            echo "::error::One or more checks failed"
            exit 1
          fi

          echo "✓ All PR checks passed"

      - name: Nx Cloud fix recommendations
        if: always()
        run: |
          echo "Check Nx Cloud dashboard for detailed build insights and fix recommendations"
