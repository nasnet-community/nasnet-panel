name: PR Check

on:
  pull_request:
    branches:
      - main

permissions:
  actions: read
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20
  # Coverage thresholds (warning mode, not blocking)
  COVERAGE_LINE_THRESHOLD: 80
  COVERAGE_BRANCH_THRESHOLD: 75

jobs:
  # ============================================================================
  # Stage 0: Detect Changes (path filtering)
  # ============================================================================

  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      schema: ${{ steps.filter.outputs.schema }}
      docker: ${{ steps.filter.outputs.docker }}
      storybook: ${{ steps.filter.outputs.storybook }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dorny/paths-filter@55c2c1448f86e01eaae002a5a3a9624417608d84 # v3.0.2
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/connect/**'
              - 'libs/**'
              - 'package*.json'
              - 'tsconfig*.json'
            backend:
              - 'apps/backend/**'
              - 'schema/**'
            schema:
              - 'schema/**'
            docker:
              - 'apps/backend/Dockerfile'
              - '.dockerignore'
            storybook:
              - 'libs/ui/**'
              - 'libs/features/*/src/**/*.stories.*'
              - 'apps/connect/.storybook/**'

  # ============================================================================
  # Stage 1: Fast Feedback (< 5 min target)
  # Run lint, typecheck, and unit tests in parallel
  # ============================================================================

  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.schema == 'true'
    outputs:
      affected-lint: ${{ steps.affected.outputs.lint }}
      affected-test: ${{ steps.affected.outputs.test }}
      affected-build: ${{ steps.affected.outputs.build }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Determine affected projects
        id: affected
        run: |
          echo "lint=$(npx nx show projects --affected -t lint --base=origin/${{ github.base_ref }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "test=$(npx nx show projects --affected -t test --base=origin/${{ github.base_ref }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          echo "build=$(npx nx show projects --affected -t build --base=origin/${{ github.base_ref }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, setup]
    if: needs.setup.outputs.affected-lint != ''
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
            echo "✓ Nx Cloud enabled"
          fi

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Run lint (affected)
        run: npx nx affected -t lint --base=origin/${{ github.base_ref }}

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, setup]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.schema == 'true'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
          fi

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Run typecheck (affected)
        run: npx nx affected -t typecheck --base=origin/${{ github.base_ref }}

  codegen-check:
    name: GraphQL Codegen Sync
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes]
    if: needs.changes.outputs.schema == 'true' || needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Check TypeScript codegen sync
        run: |
          echo "Running GraphQL code generation..."
          npm run codegen:ts || {
            echo "::error::TypeScript codegen failed"
            exit 1
          }

          echo "Checking for uncommitted changes in generated files..."
          if git diff --exit-code libs/api-client/generated/; then
            echo "✓ Generated TypeScript code is in sync with schema"
          else
            echo "::error::Generated TypeScript code is out of sync with GraphQL schema"
            echo ""
            echo "The following files have uncommitted changes:"
            git diff --name-only libs/api-client/generated/
            echo ""
            echo "Please run 'npm run codegen' and commit the generated files."
            exit 1
          fi

      - name: Setup Go
        if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.schema == 'true'
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - name: Check Go codegen sync
        if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.schema == 'true'
        working-directory: apps/backend
        run: |
          go generate ./...
          if ! git diff --exit-code; then
            echo "::error::Go generated code is out of sync. Run 'npm run codegen:go' and commit."
            git diff --name-only
            exit 1
          fi
          echo "✓ Generated Go code is in sync"

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, setup]
    if: needs.setup.outputs.affected-test != ''
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
          fi

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Run frontend tests (affected)
        run: npx nx affected -t test --base=origin/${{ github.base_ref }} --coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        if: always()
        with:
          name: frontend-coverage
          path: |
            coverage/
            **/coverage/
          retention-days: 7

      - name: Check coverage thresholds
        if: always()
        run: |
          echo "::notice::Coverage check is in warning mode (not blocking)"
          echo "Line coverage threshold: $COVERAGE_LINE_THRESHOLD%"
          echo "Branch coverage threshold: $COVERAGE_BRANCH_THRESHOLD%"
          # Coverage is enforced by vitest.config.ts thresholds
          # When ready to block on coverage, uncomment the following:
          # if [ -f "coverage/coverage-summary.json" ]; then
          #   npx nyc check-coverage --lines $COVERAGE_LINE_THRESHOLD --branches $COVERAGE_BRANCH_THRESHOLD
          # fi

  # ============================================================================
  # Backend Quality Gates
  # ============================================================================

  lint-backend:
    name: Go Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes]
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - uses: golangci/golangci-lint-action@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v6.5.2
        with:
          version: latest
          working-directory: apps/backend
          args: --timeout=5m

  test-backend:
    name: Backend Tests (Go)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes]
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - name: Go vet
        working-directory: apps/backend
        run: go vet ./...

      - name: Run Go tests
        working-directory: apps/backend
        run: |
          go test -v -tags=test -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

      - name: Upload Go coverage
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        if: always()
        with:
          name: backend-coverage
          path: apps/backend/coverage.out
          retention-days: 7

      - name: Check Go coverage thresholds
        working-directory: apps/backend
        if: always()
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Go coverage: ${COVERAGE}%"
          echo "::notice::Go coverage threshold check is in warning mode"
          # When ready to block on coverage, uncomment:
          # if (( $(echo "$COVERAGE < $COVERAGE_LINE_THRESHOLD" | bc -l) )); then
          #   echo "::error::Go coverage ${COVERAGE}% is below threshold $COVERAGE_LINE_THRESHOLD%"
          #   exit 1
          # fi

  govulncheck:
    name: Go Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes]
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        working-directory: apps/backend
        run: govulncheck ./...

  # ============================================================================
  # Stage 2: Build & Integration
  # ============================================================================

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, lint, typecheck, test-frontend, test-backend]
    # Run build even if lint/test are skipped (no affected projects or no changes)
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
          fi

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Build (affected)
        run: npx nx affected -t build --base=origin/${{ github.base_ref }}

      - name: Check bundle size
        run: |
          if [ -f "dist/apps/connect/index.html" ]; then
            npm run build:check || echo "::warning::Bundle size check failed"
          else
            echo "No connect build output to check"
          fi

  # ============================================================================
  # Storybook Build Validation
  # ============================================================================

  storybook:
    name: Storybook Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, lint, typecheck]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled') &&
      (needs.changes.outputs.storybook == 'true' || needs.changes.outputs.frontend == 'true')
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - name: Build Storybook (Primitives)
        run: npx nx run ui-primitives:build-storybook

      - name: Build Storybook (Patterns)
        run: npx nx run ui-patterns:build-storybook

      - name: Upload Storybook Artifacts
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: storybook-preview
          path: |
            dist/storybook/ui-primitives
            dist/storybook/ui-patterns
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Docker Build Validation (PR only - no push)
  # ============================================================================

  docker-build:
    name: Docker Build (validate)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [changes, build]
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled') &&
      (needs.changes.outputs.backend == 'true' || needs.changes.outputs.docker == 'true')
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --no-audit --no-fund

      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build Docker image (amd64 only for PR)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file apps/backend/Dockerfile \
            --tag nasnet-test:pr-${{ github.event.pull_request.number }} \
            --load \
            .

      - name: Check Docker image size
        run: |
          SIZE=$(docker image inspect nasnet-test:pr-${{ github.event.pull_request.number }} --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"

          # Hard limit: 20MB (blocking)
          if [ $SIZE_MB -gt 20 ]; then
            echo "::error::Docker image size (${SIZE_MB}MB) exceeds hard limit of 20MB"
            exit 1
          fi

          # Warning threshold: 15MB
          if [ $SIZE_MB -gt 15 ]; then
            echo "::warning::Docker image size (${SIZE_MB}MB) exceeds warning threshold of 15MB"
          else
            echo "✓ Docker image size is within limits"
          fi

  # ============================================================================
  # Final Status Check
  # ============================================================================

  pr-status:
    name: PR Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      [
        changes,
        lint,
        typecheck,
        codegen-check,
        test-frontend,
        test-backend,
        lint-backend,
        govulncheck,
        build,
        storybook,
        docker-build,
      ]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "=== PR Check Results ==="
          echo "Changes:         ${{ needs.changes.result }}"
          echo "Lint:            ${{ needs.lint.result }}"
          echo "TypeScript:      ${{ needs.typecheck.result }}"
          echo "Codegen:         ${{ needs.codegen-check.result }}"
          echo "Frontend Tests:  ${{ needs.test-frontend.result }}"
          echo "Go Lint:         ${{ needs.lint-backend.result }}"
          echo "Backend Tests:   ${{ needs.test-backend.result }}"
          echo "Govulncheck:     ${{ needs.govulncheck.result }}"
          echo "Build:           ${{ needs.build.result }}"
          echo "Storybook:       ${{ needs.storybook.result }}"
          echo "Docker:          ${{ needs.docker-build.result }}"

          # Fail only on actual failures, not skips
          FAILED=false
          for result in \
            "${{ needs.changes.result }}" \
            "${{ needs.lint.result }}" \
            "${{ needs.typecheck.result }}" \
            "${{ needs.codegen-check.result }}" \
            "${{ needs.test-frontend.result }}" \
            "${{ needs.lint-backend.result }}" \
            "${{ needs.test-backend.result }}" \
            "${{ needs.govulncheck.result }}" \
            "${{ needs.build.result }}" \
            "${{ needs.storybook.result }}" \
            "${{ needs.docker-build.result }}"; do
            if [[ "$result" == "failure" ]]; then
              FAILED=true
            fi
          done

          if [[ "$FAILED" == "true" ]]; then
            echo "::error::One or more checks failed"
            exit 1
          fi

          echo "✓ All PR checks passed (skipped jobs are acceptable)"

      - name: Nx Cloud fix recommendations
        if: always()
        run: |
          echo "Check Nx Cloud dashboard for detailed build insights and fix recommendations"
