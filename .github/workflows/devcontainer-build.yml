# DevContainer Build and Publish Workflow
# Builds and publishes the pre-built DevContainer image to GHCR
#
# This workflow ensures:
# - Pre-built image is available at ghcr.io/<owner>/nasnet-devcontainer
# - Image is tagged with :latest, :main, and git SHA
# - Multi-arch support (amd64, arm64) for cross-platform compatibility
# - Image size is optimized for fast startup (<60s target)

name: DevContainer Build

on:
  push:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer-build.yml'
  pull_request:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer-build.yml'
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push image to GHCR'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Rebuild weekly to get latest security patches
    - cron: '0 0 * * 0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-devcontainer

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME_LOWER=${IMAGE_NAME,,}" >> $GITHUB_ENV

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value={{date 'YYYYMMDD'}},enable={{is_default_branch}}

      - name: Build DevContainer image
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: .
          file: .devcontainer/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Build single-arch for testing
          docker build -t test-devcontainer -f .devcontainer/Dockerfile .

          # Test that system dependencies are available (Go/Node come from features, not the image)
          docker run --rm test-devcontainer bash -c "curl --version > /dev/null && echo 'curl: OK'"
          docker run --rm test-devcontainer bash -c "jq --version && echo 'jq: OK'"
          docker run --rm test-devcontainer bash -c "upx --version > /dev/null 2>&1 && echo 'upx: OK'"
          docker run --rm test-devcontainer bash -c "gcc --version > /dev/null && echo 'gcc: OK'"
          docker run --rm test-devcontainer bash -c "git --version && echo 'git: OK'"

          echo "✓ DevContainer base image tests passed (Go/Node installed via features at creation time)"

      - name: Image size report
        if: github.event_name != 'pull_request'
        run: |
          # Pull the image to get size info
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest || true

          SIZE=$(docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest --format "{{.Size}}" 2>/dev/null || echo "N/A")
          echo "## DevContainer Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** ${SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '{ "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest" }' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Verify the published image works end-to-end
  verify:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME_LOWER=${IMAGE_NAME,,}" >> $GITHUB_ENV

      - name: Pull and test image
        run: |
          # Pull the published image
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest

          # Verify system deps are available (Go/Node come from features, not the image)
          echo "Testing system deps..."
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest bash -c "curl --version > /dev/null && echo 'curl: OK'"
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest bash -c "jq --version && echo 'jq: OK'"
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest bash -c "gcc --version > /dev/null && echo 'gcc: OK'"
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest bash -c "git --version && echo 'git: OK'"

          echo "✓ Base image verifications passed (Go/Node installed via features at creation time)"

      - name: Startup time test
        run: |
          START=$(date +%s%N)
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest echo "Container started"
          END=$(date +%s%N)

          DURATION=$(( ($END - $START) / 1000000 ))
          echo "Container cold start: ${DURATION}ms"

          # Target: Container should start in <5 seconds (image pull not included)
          if [ $DURATION -lt 5000 ]; then
            echo "✓ Startup time: ${DURATION}ms (target: <5000ms)"
          else
            echo "⚠ Startup time: ${DURATION}ms exceeds target of 5000ms"
          fi
