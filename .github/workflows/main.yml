name: Main Branch Validation

on:
  push:
    branches:
      - main
  schedule:
    # Nightly build at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      full_matrix:
        description: 'Run full test matrix'
        type: boolean
        default: false

permissions:
  actions: read
  contents: read

concurrency:
  group: main-${{ github.sha }}
  cancel-in-progress: false

env:
  NODE_VERSION: 20

jobs:
  # ============================================================================
  # Full Validation (all projects, not just affected)
  # ============================================================================

  validate:
    name: Full Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Nx Cloud
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: |
          if [ -n "$NX_CLOUD_ACCESS_TOKEN" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=$NX_CLOUD_ACCESS_TOKEN" >> $GITHUB_ENV
            echo "✓ Nx Cloud enabled"
          fi

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run lint (all projects)
        run: npx nx run-many -t lint

      - name: Run typecheck (all projects)
        run: npx nx run-many -t typecheck

      - name: Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version-file: apps/backend/go.mod
          cache-dependency-path: apps/backend/go.sum

      - name: Go vulnerability scan
        working-directory: apps/backend
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Run tests (all projects)
        run: npx nx run-many -t test --coverage

      - name: Run build (all projects)
        run: npx nx run-many -t build

      - name: Build Storybook (Primitives)
        run: npx nx run ui-primitives:build-storybook

      - name: Build Storybook (Patterns)
        run: npx nx run ui-patterns:build-storybook

      - name: Build Storybook (Connect)
        run: npx nx run connect:build-storybook

      - name: Upload Storybook Artifacts
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: storybook
          path: |
            dist/storybook/ui-primitives
            dist/storybook/ui-patterns
            dist/storybook/connect
          if-no-files-found: ignore

      - name: Nx Cloud fix recommendations
        run: npx nx fix-ci
        if: always()

  # ============================================================================
  # Bundle Size Analysis
  # ============================================================================

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Build with analysis
        run: npm run build:check

      - name: Upload bundle stats
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: bundle-stats
          path: |
            dist/apps/connect/stats.html
            dist/apps/connect/stats.json
          if-no-files-found: ignore

  # ============================================================================
  # Docker Build (validate multi-arch)
  # ============================================================================

  docker-validate:
    name: Docker Multi-Arch Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
          - linux/arm/v7
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build Docker image (${{ matrix.platform }})
        run: |
          PLATFORM_TAG=$(echo "${{ matrix.platform }}" | tr '/' '-')
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --file apps/backend/Dockerfile \
            --tag nasnet-validate:$PLATFORM_TAG \
            .

  # ============================================================================
  # Nightly Extended Tests (only on schedule or manual trigger)
  # ============================================================================

  nightly-tests:
    name: Nightly Extended Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.full_matrix == 'true')
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci --no-audit --no-fund

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npx nx e2e connect-e2e --reporter=html
        continue-on-error: true

      - name: Upload E2E report
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        if: always()
        with:
          name: e2e-report
          path: dist/.playwright/apps/connect-e2e/

      # Future: Add these when infrastructure is ready
      # - name: Run mutation testing
      # - name: Run load testing
      # - name: Run security scan (OWASP ZAP)

  # ============================================================================
  # Notification on Failure
  # ============================================================================

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, docker-validate]
    if: failure()
    steps:
      - name: Create failure annotation
        run: |
          echo "::error::Main branch validation failed. Check the workflow logs for details."
          echo "Failed jobs need attention before releases can proceed."

  # ============================================================================
  # Success Summary
  # ============================================================================

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, bundle-analysis, docker-validate]
    if: always()
    steps:
      - name: Report status
        run: |
          echo "## Main Branch Validation Summary"
          echo ""
          echo "| Check | Status |"
          echo "|-------|--------|"
          echo "| Full Validation | ${{ needs.validate.result }} |"
          echo "| Bundle Analysis | ${{ needs.bundle-analysis.result }} |"
          echo "| Docker Multi-Arch | ${{ needs.docker-validate.result }} |"
          echo ""

          if [[ "${{ needs.validate.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-validate.result }}" == "failure" ]]; then
            echo "::error::Main branch validation failed"
            exit 1
          fi

          echo "✓ All validations passed"
