import { Meta, Controls, Story } from "@storybook/blocks";
import * as FormStories from "./Form.stories";

<Meta of={FormStories} />

# Form

The Form component provides a powerful, flexible way to build forms in your application. It handles form state management, validation, and submission, while working seamlessly with all other form components in the Connect design system.

## Features

- **State Management**: Tracks field values, errors, touched state, and dirty state
- **Validation**: Supports client-side validation with customizable validation rules
- **Submission Handling**: Manages form submission and prevents default browser behavior when needed
- **Reset Functionality**: Allows resetting form to initial values
- **Field Registration**: Automatically registers and tracks form fields
- **Accessibility**: Follows best practices for form accessibility

## Usage

The Form component serves as a container for form controls and manages their state. It works with all Connect form components such as `TextArea`, `DatePicker`, `FileUpload`, `Slider`, etc.

```tsx
import { component$, $ } from "@builder.io/qwik";
import { Form, FormField } from "@connect/core/form";

export default component$(() => {
  const handleSubmit$ = $((values) => {
    console.log("Form submitted with values:", values);
    // Process form submission
  });

  return (
    <Form
      onSubmit$={handleSubmit$}
      initialValues={{
        name: "",
        email: "",
      }}
    >
      <FormField name="name" label="Name" required>
        <input
          type="text"
          name="name"
          class="w-full rounded-md border border-gray-300 px-3 py-2"
        />
      </FormField>

      <FormField name="email" label="Email" required>
        <input
          type="email"
          name="email"
          class="w-full rounded-md border border-gray-300 px-3 py-2"
        />
      </FormField>

      <div class="mt-4 flex justify-end">
        <button
          type="submit"
          class="rounded-md bg-blue-600 px-4 py-2 text-white"
        >
          Submit
        </button>
      </div>
    </Form>
  );
});
```

## Form Validation

The Form component supports multiple validation strategies:

### 1. HTML5 Validation

By default, the Form component uses HTML5 validation. You can disable this by setting the `noValidate` prop to `true`.

```tsx
<Form noValidate={false}>{/* Form fields */}</Form>
```

### 2. Custom Validation via onValidate$

You can provide a custom validation function via the `onValidate$` prop:

```tsx
const handleValidate$ = $((values) => {
  const errors = {};

  if (!values.email.includes("@")) {
    errors.email = "Please enter a valid email";
  }

  if (values.password.length < 8) {
    errors.password = "Password must be at least 8 characters";
  }

  return errors;
});

<Form
  onValidate$={handleValidate$}
  // Other props
>
  {/* Form fields */}
</Form>;
```

### 3. Field-Level Validation

You can also specify validation directly on form fields:

```tsx
<FormField
  name="email"
  label="Email"
  validate={[
    {
      validator: $((value) => {
        if (!value.includes("@")) {
          return "Please enter a valid email";
        }
        return undefined;
      }),
    },
  ]}
>
  <input type="email" name="email" />
</FormField>
```

## Handling Form Submission

The Form component handles form submission via the `onSubmit$` prop:

```tsx
const handleSubmit$ = $((values, event) => {
  // Process form submission
  console.log("Form values:", values);

  // You can access the native event if needed
  console.log("Form event:", event);
});

<Form onSubmit$={handleSubmit$}>{/* Form fields */}</Form>;
```

## Form Layouts

### Basic Layout

By default, form fields are stacked vertically:

```tsx
<Form>
  <FormField name="field1" label="Field 1">
    <input type="text" name="field1" />
  </FormField>

  <FormField name="field2" label="Field 2">
    <input type="text" name="field2" />
  </FormField>
</Form>
```

### Multi-Column Layout

You can create multi-column layouts using CSS Grid or Flexbox:

```tsx
<Form>
  <div class="grid grid-cols-2 gap-4">
    <FormField name="firstName" label="First Name">
      <input type="text" name="firstName" />
    </FormField>

    <FormField name="lastName" label="Last Name">
      <input type="text" name="lastName" />
    </FormField>
  </div>

  <FormField name="email" label="Email">
    <input type="email" name="email" />
  </FormField>
</Form>
```

## Integration with Connect Form Components

The Form component works seamlessly with all Connect form components:

```tsx
<Form>
  <FormField name="message" label="Message">
    <TextArea name="message" rows={4} resize="vertical" />
  </FormField>

  <FormField name="birthdate" label="Birth Date">
    <DatePicker name="birthdate" />
  </FormField>

  <FormField name="age" label="Age">
    <Slider name="age" min={18} max={100} />
  </FormField>

  <FormField name="files" label="Documents">
    <FileUpload name="files" multiple accept=".pdf,.docx" />
  </FormField>

  <FormField name="subscribe" label="Subscribe">
    <Checkbox name="subscribe" label="Subscribe to newsletter" />
  </FormField>
</Form>
```

## Form Field States

The Form component and FormField components support various states:

- **Required**: Marks the field as required
- **Disabled**: Disables user interaction with the field
- **Read-Only**: Allows viewing but not editing the field
- **Error**: Shows an error state with a message
- **Success**: Shows a success state
- **Warning**: Shows a warning state

```tsx
<Form>
  <FormField name="required" label="Required Field" required>
    <input type="text" name="required" />
  </FormField>

  <FormField name="disabled" label="Disabled Field" disabled>
    <input type="text" name="disabled" disabled />
  </FormField>

  <FormField name="readonly" label="Read-Only Field" readOnly>
    <input type="text" name="readonly" readOnly />
  </FormField>

  <FormField name="error" label="Error Field" error="This field has an error">
    <input type="text" name="error" />
  </FormField>

  <FormField name="success" label="Success Field" success>
    <input type="text" name="success" />
  </FormField>

  <FormField
    name="warning"
    label="Warning Field"
    warning
    helperText="There's a potential issue with this input"
  >
    <input type="text" name="warning" />
  </FormField>
</Form>
```

## API Reference

### Form Props

<Controls />

### FormField Props

| Prop       | Type    | Default        | Description                                                 |
| ---------- | ------- | -------------- | ----------------------------------------------------------- |
| name       | string  | required       | Name of the form field. Should be unique within the form.   |
| label      | string  | undefined      | Label for the form field.                                   |
| helperText | string  | undefined      | Helper text to display below the field.                     |
| error      | string  | undefined      | Error message to display. Takes precedence over helperText. |
| success    | boolean | false          | Whether to display the field in a success state.            |
| warning    | boolean | false          | Whether to display the field in a warning state.            |
| required   | boolean | false          | Whether the field is required.                              |
| disabled   | boolean | false          | Whether the field is disabled.                              |
| readOnly   | boolean | false          | Whether the field is read-only.                             |
| class      | string  | undefined      | Additional CSS classes to apply to the field.               |
| id         | string  | auto-generated | ID for the field. Generated automatically if not provided.  |

## Accessibility

The Form component and FormField components follow accessibility best practices:

- Labels are properly associated with form controls using `for` attributes
- Required fields are marked with both visual indicators and `aria-required`
- Error states use `aria-invalid` and error messages are associated with their fields
- Form submit buttons use appropriate button roles and types

## Advanced Usage

### Using Form Context

You can access form context within your components using the `useFormContext` hook:

```tsx
import { component$, $ } from "@builder.io/qwik";
import { useFormContext } from "@connect/core/form";

export const MyCustomField = component$(() => {
  const form = useFormContext();

  const handleButtonClick = $(() => {
    // Access form state and methods
    form.setFieldValue$("fieldName", "newValue");
    console.log("Current form state:", form.state);
  });

  return (
    <div>
      <button onClick$={handleButtonClick}>Set Value</button>
    </div>
  );
});
```

### Using Form Field Context

You can access field context within your custom form controls using the `useFormFieldContext` hook:

```tsx
import { component$, $ } from "@builder.io/qwik";
import { useFormFieldContext } from "@connect/core/form";

export const MyCustomInput = component$(() => {
  const field = useFormFieldContext();

  return (
    <input
      type="text"
      name={field.name}
      value={field.value}
      required={field.required}
      disabled={field.disabled}
      onChange$={(e) => field.onChange$((e.target as HTMLInputElement).value)}
      onBlur$={field.onBlur$}
      onFocus$={field.onFocus$}
    />
  );
});
```
