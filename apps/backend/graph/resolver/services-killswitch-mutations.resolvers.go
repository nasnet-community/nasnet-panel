package resolver

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.86

import (
	"backend/generated/ent"
	"backend/generated/ent/devicerouting"
	"backend/graph/model"
	"backend/internal/apperrors"
	"context"
)

// SetKillSwitch resolves the setKillSwitch mutation.
func (r *mutationResolver) SetKillSwitch(ctx context.Context, input model.SetKillSwitchInput) (*model.DeviceRouting, error) {
	// Validate inputs
	if validationErr := validateKillSwitchInput(input); validationErr != nil {
		return nil, validationErr
	}

	// Verify kill switch manager is configured
	if r.KillSwitchManager == nil {
		return nil, apperrors.NewResourceError(
			apperrors.CodeDependencyNotReady,
			"kill switch manager not configured",
			"KillSwitchManager",
			"",
		)
	}

	// Query the existing device routing
	dr, err := r.db.DeviceRouting.
		Query().
		Where(devicerouting.DeviceIDEQ(input.DeviceID)).
		Only(ctx)
	if err != nil {
		if ent.IsNotFound(err) {
			return nil, apperrors.NewResourceError(
				apperrors.CodeResourceNotFound,
				"device routing not found",
				"DeviceRouting",
				input.DeviceID,
			)
		}
		return nil, apperrors.Wrap(
			err,
			apperrors.CodeResourceNotFound,
			apperrors.CategoryResource,
			"failed to query device routing",
		)
	}

	// Verify device routing is not nil
	if dr == nil {
		return nil, apperrors.NewResourceError(
			apperrors.CodeResourceNotFound,
			"device routing is nil after query",
			"DeviceRouting",
			input.DeviceID,
		)
	}

	// Apply kill switch configuration
	if input.Enabled {
		killSwitchMode, fallbackInterfaceID := mapKillSwitchMode(input)
		enableErr := r.KillSwitchManager.Enable(ctx, dr.ID, killSwitchMode, fallbackInterfaceID)
		if enableErr != nil {
			return nil, apperrors.Wrap(
				enableErr,
				apperrors.CodeCommandFailed,
				apperrors.CategoryProtocol,
				"failed to enable kill switch",
			)
		}
	} else {
		disableErr := r.KillSwitchManager.Disable(ctx, dr.ID)
		if disableErr != nil {
			return nil, apperrors.Wrap(
				disableErr,
				apperrors.CodeCommandFailed,
				apperrors.CategoryProtocol,
				"failed to disable kill switch",
			)
		}
	}

	// Query the updated routing from DB
	updatedRouting, queryErr := r.db.DeviceRouting.Get(ctx, dr.ID)
	if queryErr != nil {
		return nil, apperrors.Wrap(
			queryErr,
			apperrors.CodeResourceNotFound,
			apperrors.CategoryResource,
			"failed to query updated routing",
		)
	}

	return convertDeviceRouting(updatedRouting), nil
}
