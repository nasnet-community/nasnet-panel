package resolver

// This file contains subscriptions for update progress tracking.
// Code generated by github.com/99designs/gqlgen version v0.17.86

import (
	"backend/graph/model"
	"context"
	"time"
)

// UpdateProgress subscribes to real-time update progress events.
func (r *subscriptionResolver) UpdateProgress(ctx context.Context, routerID string) (<-chan *model.UpdateProgress, error) {
	progressChan := make(chan *model.UpdateProgress, 10)

	go func() {
		defer close(progressChan)

		select {
		case <-ctx.Done():
			return
		case progressChan <- &model.UpdateProgress{
			InstanceID: routerID,
			Stage:      model.UpdateStageStaging,
			Progress:   0,
			Message:    "Waiting for update to start",
			Timestamp:  time.Now(),
		}:
		}

		ticker := time.NewTicker(30 * time.Second)
		defer ticker.Stop()

		for {
			select {
			case <-ctx.Done():
				return
			case <-ticker.C:
				select {
				case progressChan <- &model.UpdateProgress{
					InstanceID: routerID,
					Stage:      model.UpdateStageStaging,
					Progress:   0,
					Message:    "No active update",
					Timestamp:  time.Now(),
				}:
				default:
				}
			}
		}
	}()

	return progressChan, nil
}
