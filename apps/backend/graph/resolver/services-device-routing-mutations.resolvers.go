package resolver

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.86

import (
	"backend/generated/ent/devicerouting"
	"backend/graph/model"
	"backend/internal/apperrors"
	"context"
)

// AssignDeviceRouting resolves the assignDeviceRouting mutation.
func (r *mutationResolver) AssignDeviceRouting(ctx context.Context, input model.AssignDeviceRoutingInput) (*model.DeviceRouting, error) {
	// Validate inputs
	if input.RouterID == "" {
		return nil, apperrors.NewValidationError("routerID", "", "required")
	}
	if input.DeviceID == "" {
		return nil, apperrors.NewValidationError("deviceID", "", "required")
	}
	if input.MacAddress == "" {
		return nil, apperrors.NewValidationError("macAddress", "", "required")
	}
	if input.RoutingMark == "" {
		return nil, apperrors.NewValidationError("routingMark", "", "required")
	}

	// Verify PBR engine is configured
	if r.PBREngine == nil {
		return nil, apperrors.NewResourceError(apperrors.CodeDependencyNotReady, "PBR engine not configured", "PBREngine", "")
	}

	// Assign device routing
	result, err := r.PBREngine.AssignDeviceRouting(
		ctx,
		input.DeviceID,
		input.MacAddress,
		input.RoutingMark,
		input.InstanceID,
	)
	if err != nil {
		return nil, apperrors.Wrap(err, apperrors.CodeCommandFailed, apperrors.CategoryProtocol, "failed to assign device routing")
	}

	if !result.Success {
		errMsg := "device routing assignment failed"
		if result.Error != nil {
			return nil, apperrors.Wrap(result.Error, apperrors.CodeCommandFailed, apperrors.CategoryProtocol, errMsg)
		}
		return nil, apperrors.NewRouterError(apperrors.CodeCommandFailed, apperrors.CategoryProtocol, errMsg)
	}

	// Query the created routing from DB
	dr, err := r.db.DeviceRouting.
		Query().
		Where(devicerouting.DeviceIDEQ(input.DeviceID)).
		Only(ctx)
	if err != nil {
		return nil, apperrors.Wrap(err, apperrors.CodeResourceNotFound, apperrors.CategoryResource, "failed to query created routing")
	}

	// Verify device routing is not nil
	if dr == nil {
		return nil, apperrors.NewResourceError(apperrors.CodeResourceNotFound, "created device routing is nil", "DeviceRouting", input.DeviceID)
	}

	return convertDeviceRouting(dr), nil
}

// RemoveDeviceRouting resolves the removeDeviceRouting mutation.
func (r *mutationResolver) RemoveDeviceRouting(ctx context.Context, routerID string, deviceID string) (bool, error) {
	// Validate inputs
	if routerID == "" {
		return false, apperrors.NewValidationError("routerID", "", "required")
	}
	if deviceID == "" {
		return false, apperrors.NewValidationError("deviceID", "", "required")
	}

	// Verify PBR engine is configured
	if r.PBREngine == nil {
		return false, apperrors.NewResourceError(apperrors.CodeDependencyNotReady, "PBR engine not configured", "PBREngine", "")
	}

	// Remove device routing
	if err := r.PBREngine.RemoveDeviceRouting(ctx, deviceID); err != nil {
		return false, apperrors.Wrap(err, apperrors.CodeCommandFailed, apperrors.CategoryProtocol, "failed to remove device routing")
	}

	return true, nil
}

// BulkAssignRouting resolves the bulkAssignRouting mutation.
func (r *mutationResolver) BulkAssignRouting(ctx context.Context, input model.BulkAssignRoutingInput) (*model.BulkRoutingResult, error) {
	// Validate inputs
	if input.RouterID == "" {
		return nil, apperrors.NewValidationError("routerID", "", "required")
	}
	if len(input.Assignments) == 0 {
		return nil, apperrors.NewValidationError("assignments", 0, "at least one assignment is required")
	}

	// Verify PBR engine is configured
	if r.PBREngine == nil {
		return nil, apperrors.NewResourceError(apperrors.CodeDependencyNotReady, "PBR engine not configured", "PBREngine", "")
	}

	// Convert input to engine format
	assignments := make([]struct {
		DeviceID    string
		MacAddress  string
		RoutingMark string
		InstanceID  string
	}, len(input.Assignments))

	for i, a := range input.Assignments {
		assignments[i].DeviceID = a.DeviceID
		assignments[i].MacAddress = a.MacAddress
		assignments[i].RoutingMark = a.RoutingMark
		assignments[i].InstanceID = a.InstanceID
	}

	// Execute bulk assignment
	results := r.PBREngine.BulkAssignRouting(ctx, assignments)

	// Convert results to GraphQL model
	return convertBulkRoutingResult(results), nil
}
