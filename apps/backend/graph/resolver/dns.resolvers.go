package resolver

// This file will be generated by gqlgen. It is only meant as a bootstrap
// file template for your own modifications. If you make changes and
// regenerate, these changes will be lost.

import (
	"context"
	"backend/graph/model"
	"backend/internal/dns"
)

// RunDnsLookup is the resolver for the runDnsLookup field.
func (r *mutationResolver) RunDnsLookup(ctx context.Context, input model.DnsLookupInput) (*model.DnsLookupResult, error) {
	// Map GraphQL input to service input
	svcInput := &dns.DnsLookupInput{
		DeviceId:   input.DeviceID,
		Hostname:   input.Hostname,
		RecordType: string(input.RecordType),
		Server:     input.Server,
		Timeout:    input.Timeout,
	}

	// Call service
	result, err := r.DnsService.PerformLookup(ctx, svcInput)
	if err != nil {
		return nil, err
	}

	// Map service result to GraphQL result
	return mapDnsLookupResultToGraphQL(result), nil
}

// DnsServers is the resolver for the dnsServers field.
func (r *queryResolver) DnsServers(ctx context.Context, deviceID string) (*model.DnsServers, error) {
	servers, err := r.DnsService.GetConfiguredServers(ctx, deviceID)
	if err != nil {
		return nil, err
	}

	return mapDnsServersToGraphQL(servers), nil
}

// mapDnsLookupResultToGraphQL maps service DnsLookupResult to GraphQL model
func mapDnsLookupResultToGraphQL(result *dns.DnsLookupResult) *model.DnsLookupResult {
	records := make([]*model.DnsRecord, len(result.Records))
	for i, r := range result.Records {
		records[i] = &model.DnsRecord{
			Name:     r.Name,
			Type:     model.DnsRecordType(r.Type),
			TTL:      r.TTL,
			Data:     r.Data,
			Priority: r.Priority,
			Weight:   r.Weight,
			Port:     r.Port,
		}
	}

	return &model.DnsLookupResult{
		Hostname:      result.Hostname,
		RecordType:    model.DnsRecordType(result.RecordType),
		Status:        model.DnsLookupStatus(result.Status),
		Records:       records,
		Server:        result.Server,
		QueryTime:     result.QueryTime,
		Authoritative: result.Authoritative,
		Error:         result.Error,
		Timestamp:     result.Timestamp,
	}
}

// mapDnsServersToGraphQL maps service DnsServers to GraphQL model
func mapDnsServersToGraphQL(servers *dns.DnsServers) *model.DnsServers {
	gqlServers := make([]*model.DnsServer, len(servers.Servers))
	for i, s := range servers.Servers {
		gqlServers[i] = &model.DnsServer{
			Address:     s.Address,
			IsPrimary:   s.IsPrimary,
			IsSecondary: s.IsSecondary,
		}
	}

	return &model.DnsServers{
		Servers:   gqlServers,
		Primary:   servers.Primary,
		Secondary: servers.Secondary,
	}
}
