{
  "$schema": "https://json.schemastore.org/nx-project.json",
  "name": "backend",
  "projectType": "application",
  "root": "apps/backend",
  "sourceRoot": "apps/backend",
  "tags": ["type:api", "lang:go", "routeros"],
  "targets": {
    "serve": {
      "executor": "nx:run-commands",
      "options": { "command": "air", "cwd": "apps/backend" }
    },
    "server": {
      "executor": "nx:run-commands",
      "options": { "command": "air", "cwd": "apps/backend" }
    },
    "build": {
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/apps/backend"],
      "options": {
        "command": "node tools/copy-frontend.mjs && cd apps/backend && go build -tags=prod -ldflags=\"-s -w\" -o ../../dist/apps/backend/backend ./cmd/nnc/",
        "cwd": "."
      },
      "dependsOn": ["connect:build"]
    },
    "codegen": {
      "executor": "nx:run-commands",
      "options": { "command": "go generate ./graph/...", "cwd": "apps/backend" }
    },
    "serve-prod": {
      "executor": "nx:run-commands",
      "options": { "command": "../../dist/apps/backend/backend", "cwd": "apps/backend" },
      "dependsOn": ["build"]
    },
    "test": {
      "executor": "nx:run-commands",
      "options": { "command": "go test -tags=dev ./...", "cwd": "apps/backend" }
    },
    "lint": {
      "executor": "nx:run-commands",
      "options": {
        "command": "node -e \"const{execSync}=require('child_process');const p=require('path');const gcl=p.resolve(__dirname,'../../.bin/custom-gcl'+(process.platform==='win32'?'.exe':''));try{execSync(gcl+' version',{stdio:'ignore'});}catch{console.log('custom-gcl not found. Run: cd <root> && golangci-lint custom');process.exit(0);}try{execSync(gcl+' run --tests=false --allow-parallel-runners --config ../../.golangci.yml ./...',{stdio:'inherit',cwd:'.'});}catch(e){process.exit(e.status||1);}\"",
        "cwd": "apps/backend"
      }
    },
    "lint:fix": {
      "executor": "nx:run-commands",
      "options": {
        "command": "node -e \"const{execSync}=require('child_process');const p=require('path');const gcl=p.resolve(__dirname,'../../.bin/custom-gcl'+(process.platform==='win32'?'.exe':''));try{execSync(gcl+' version',{stdio:'ignore'});}catch{console.log('custom-gcl not found. Run: cd <root> && golangci-lint custom');process.exit(0);}try{execSync(gcl+' run --tests=false --allow-parallel-runners --config ../../.golangci.yml --fix ./...',{stdio:'inherit',cwd:'.'});}catch(e){process.exit(e.status||1);}\"",
        "cwd": "apps/backend"
      }
    },
    "build:check": {
      "executor": "nx:run-commands",
      "options": { "command": "go build ./cmd/nnc/", "cwd": "apps/backend" }
    },
    "typecheck": {
      "executor": "nx:run-commands",
      "options": { "command": "go vet ./...", "cwd": "apps/backend" }
    },
    "check": {
      "executor": "nx:run-commands",
      "options": {
        "commands": ["nx run backend:typecheck", "nx run backend:lint"],
        "parallel": false
      }
    },
    "vulncheck": {
      "executor": "nx:run-commands",
      "options": {
        "command": "go install golang.org/x/vuln/cmd/govulncheck@latest && govulncheck ./...",
        "cwd": "apps/backend"
      }
    },
    "wire": {
      "executor": "nx:run-commands",
      "options": {
        "command": "wire ./internal/bootstrap/",
        "cwd": "apps/backend"
      }
    },
    "docker:build": {
      "executor": "nx:run-commands",
      "options": {
        "cwd": ".",
        "command": "docker buildx build --platform=${PLATFORMS:-linux/amd64,linux/arm64,linux/arm/v7} -f apps/backend/Dockerfile --tag ghcr.io/$GHCR_REPOSITORY:latest ${DOCKERHUB_REPO:+--tag docker.io/$DOCKERHUB_REPO:latest} ${PUSH:+--push} ."
      }
    },
    "docker:build-local": {
      "executor": "nx:run-commands",
      "options": {
        "cwd": ".",
        "command": "node tools/docker/cli.mjs build-local --tag nasnet:local --platform linux/amd64"
      }
    },
    "docker:export-tar": {
      "executor": "nx:run-commands",
      "options": {
        "cwd": ".",
        "command": "node tools/docker/cli.mjs export-tar --tag nasnet:local --out dist/images/nasnet-local-amd64.tar.gz"
      }
    },
    "docker:build-export": {
      "executor": "nx:run-commands",
      "options": {
        "cwd": ".",
        "command": "node tools/docker/cli.mjs build-export --tag nasnet:local --platform linux/amd64 --out dist/images/nasnet-local-amd64.tar.gz"
      }
    },
    "docker:build-export-multi": {
      "executor": "nx:run-commands",
      "options": {
        "cwd": ".",
        "command": "node tools/docker/cli.mjs build-export-multi --tag nasnet --base_out dist/images"
      }
    }
  }
}
