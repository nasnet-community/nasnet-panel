# GraphQL Code Consolidation Migration Plan

## Status: BLOCKED - Waiting for Task #1 (ent migration)

## Overview
This migration moves GraphQL generated code from `apps/backend/graph/` to `apps/backend/generated/graphql/`.

## Configuration Changes (✅ COMPLETED)

### gqlgen.yml updates:
- ✅ `exec.filename`: `graph/generated.go` → `generated/graphql/generated.go`
- ✅ `exec.package`: `graph` → `graphql`
- ✅ `model.filename`: `graph/model/models_gen.go` → `generated/graphql/models.go`
- ✅ `model.package`: `model` → `graphql`
- ✅ `autobind`: Added `backend/generated/graphql`
- ✅ Custom scalar mappings: Still point to `backend/graph/model` (correct)

## Files to Keep in backend/graph/model (Custom Code)

These files contain manually-written types and should NOT be moved:
- `auth.go` - Authentication types
- `node.go` - Node interface implementations
- `scalars.go` - Custom scalar types (IPv4, MAC, CIDR, Port, PortRange, Duration, Bandwidth, Size, ULID)
- `scalars_test.go` - Custom scalar tests

## Files to Delete (Old Generated Code)

After successful migration:
- `apps/backend/graph/generated.go` - Move to `generated/graphql/generated.go`
- `apps/backend/graph/model/models_gen.go` - Move to `generated/graphql/models.go`

## Duplicate Resolver Files Issue

⚠️ **BLOCKER**: There are duplicate resolver files causing compilation errors:

### Stub files (auto-generated by gqlgen, contain panic):
- `graph/resolver/schema.resolvers.go`
- `graph/resolver/alerts-rule-mutations.resolvers.go`
- `graph/resolver/alerts-rule-queries.resolvers.go`
- And many more...

### Implementation files (actual code):
- `graph/resolver/alerts.resolvers.go`
- `graph/resolver/core-mutations-subscriptions.resolvers.go`
- `graph/resolver/core-queries.resolvers.go`
- And many more...

**Resolution**: The stub files should be deleted. They were generated before the implementation was split into separate files.

## Import Updates Required

### Pattern 1: Generated model types
**From:** `import "backend/graph/model"`
**To:** `import "backend/generated/graphql"`

Files using generated types (e.g., `AddRouterInput`, `MutationError`, etc.) should use the new import.

**Affected files:** ~110 files (need to analyze which ones)

### Pattern 2: Exec/resolver types
**From:** `import "backend/graph"`
**To:** `import "backend/generated/graphql"`

Files importing the generated exec code.

**Affected files:** 7 files
- `cmd/nnc/main_dev.go`
- `cmd/nnc/routes_prod.go`
- `graph/resolver/schema.resolvers.go` (should be deleted)
- `graphql_test.go`
- `internal/troubleshoot/integration_test.go`
- `main.dev.go`
- `main.prod.go`

### Pattern 3: Custom scalars (NO CHANGE)
**Keep:** `import "backend/graph/model"`

Files using custom scalars (IPv4, MAC, CIDR, etc.) should keep the original import.

## Dependencies

### BLOCKER: Task #1 must complete first
Resolver files import `backend/generated/ent/*`:
- `backend/generated/ent`
- `backend/generated/ent/alert`
- `backend/generated/ent/alertrule`
- And many more...

Without Task #1 completing the ent migration, gqlgen cannot validate the resolver files.

## Migration Steps (To Execute After Task #1)

1. **Delete duplicate stub files**
   ```bash
   cd apps/backend/graph/resolver
   rm schema.resolvers.go
   # Delete other auto-generated stub files that duplicate implementations
   ```

2. **Run gqlgen to generate in new location**
   ```bash
   cd apps/backend
   go run github.com/99designs/gqlgen@latest generate
   ```

3. **Update imports in 7 exec files**
   - Replace `"backend/graph"` → `"backend/generated/graphql"`

4. **Analyze and update model imports**
   - For files using generated types: `"backend/graph/model"` → `"backend/generated/graphql"`
   - For files using custom scalars: Keep `"backend/graph/model"`

5. **Delete old generated files**
   ```bash
   rm apps/backend/graph/generated.go
   rm apps/backend/graph/model/models_gen.go
   ```

6. **Verify compilation**
   ```bash
   cd apps/backend
   go build ./...
   ```

7. **Run tests**
   ```bash
   cd apps/backend
   go test ./...
   ```

## Success Criteria

- [x] gqlgen.yml configured to output to `apps/backend/generated/graphql/`
- [ ] Generated files exist in new location
- [ ] Old generated files deleted
- [ ] All imports updated correctly
- [ ] Custom scalar imports still point to `backend/graph/model`
- [ ] Code compiles successfully
- [ ] All tests pass

## Notes

- The migration is straightforward once Task #1 completes
- Custom scalars remain in their original location (by design)
- The main challenge is distinguishing generated type imports from custom scalar imports
