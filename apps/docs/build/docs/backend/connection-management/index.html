<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-backend docs-version-current docs-doc-page docs-doc-id-connection-management" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Connection Management | NasNet Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nasnet.dev/docs/backend/connection-management"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-backend-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-backend-current"><meta data-rh="true" property="og:title" content="Connection Management | NasNet Docs"><meta data-rh="true" name="description" content="Per-router connection pool with circuit breaker protection, exponential-backoff reconnection, periodic health monitoring, and hardware/software capability detection with 24-hour caching."><meta data-rh="true" property="og:description" content="Per-router connection pool with circuit breaker protection, exponential-backoff reconnection, periodic health monitoring, and hardware/software capability detection with 24-hour caching."><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://nasnet.dev/docs/backend/connection-management"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/backend/connection-management" hreflang="en"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/backend/connection-management" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Connection Management","item":"https://nasnet.dev/docs/backend/connection-management"}]}</script><link rel="stylesheet" href="/assets/css/styles.82d9e831.css">
<script src="/assets/js/runtime~main.ca82720f.js" defer="defer"></script>
<script src="/assets/js/main.ffff147f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_G6ar" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--light_DIHH" style="border-radius:6px"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--dark_Bv2M" style="border-radius:6px"></div><b class="navbar__title text--truncate">NasNet Docs</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/frontend/intro">Frontend (Connect)</a></li><li><a class="dropdown__link" href="/docs/backend/intro">Backend (Go)</a></li><li><a class="dropdown__link" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Libraries</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/ui/intro">UI Components</a></li><li><a class="dropdown__link" href="/docs/features/intro">Feature Modules</a></li><li><a class="dropdown__link" href="/docs/api-client/intro">API Client</a></li><li><a class="dropdown__link" href="/docs/state/intro">State Management</a></li><li><a class="dropdown__link" href="/docs/core/intro">Core Types</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Components</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/storybook/primitives/">UI Primitives</a></li><li><a class="dropdown__link" href="/storybook/patterns/">UI Patterns</a></li><li><a class="dropdown__link" href="/storybook/connect/">Connect App</a></li></ul></div><a class="navbar__item navbar__link" href="/api">API Reference</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/nasnet-community/nasnet-panel/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Changelog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><a class="navbar__item navbar__link" href="/nx-graph/">Nx Graph</a><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_OLSw colorModeToggle_Hg9V"><button class="clean-btn toggleButton_wYmb toggleButtonDisabled_vaDU" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ lightToggleIcon_Sxwe"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ darkToggleIcon_Yem1"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ systemToggleIcon_txm5"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_bmvg"><div class="navbar__search searchBarContainer_YZIh" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_eCKk" value=""><div class="loadingRing_pJhT searchBarLoadingRing_NsvA"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_UyTV"><div class="docsWrapper_XLvK"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_z1FD" type="button"></button><div class="docRoot_HciC"><aside class="theme-doc-sidebar-container docSidebarContainer_e5ai"><div class="sidebarViewport_N8x0"><div class="sidebar_vJCc"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_qiME"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/intro"><span title="Introduction" class="linkLabel_PuAu">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/alert-system"><span title="Alert System" class="linkLabel_PuAu">Alert System</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/application-bootstrap"><span title="Application Bootstrap" class="linkLabel_PuAu">Application Bootstrap</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/build-and-deploy"><span title="Build and Deploy" class="linkLabel_PuAu">Build and Deploy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/config-generation"><span title="Config Generation" class="linkLabel_PuAu">Config Generation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/backend/connection-management"><span title="Connection Management" class="linkLabel_PuAu">Connection Management</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/data-layer"><span title="Data Layer" class="linkLabel_PuAu">Data Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/error-handling"><span title="Error Handling &amp; Structured Logging" class="linkLabel_PuAu">Error Handling &amp; Structured Logging</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/event-system"><span title="Event System" class="linkLabel_PuAu">Event System</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/feature-marketplace"><span title="Feature Marketplace" class="linkLabel_PuAu">Feature Marketplace</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_d9ci menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/backend/flows/alert-lifecycle-flow"><span title="flows" class="categoryLinkLabel_Oe72">flows</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/getting-started"><span title="Getting Started" class="linkLabel_PuAu">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/graphql-api"><span title="GraphQL API Layer" class="linkLabel_PuAu">GraphQL API Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/"><span title="NasNet Backend — Master Index" class="linkLabel_PuAu">NasNet Backend — Master Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/network-services"><span title="Network Services" class="linkLabel_PuAu">Network Services</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/process-isolation"><span title="Process Isolation" class="linkLabel_PuAu">Process Isolation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/provisioning-engine"><span title="Provisioning Engine" class="linkLabel_PuAu">Provisioning Engine</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/router-communication"><span title="Router Communication" class="linkLabel_PuAu">Router Communication</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/router-services"><span title="Router Services" class="linkLabel_PuAu">Router Services</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/security"><span title="Security" class="linkLabel_PuAu">Security</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/service-orchestrator"><span title="Service Orchestrator" class="linkLabel_PuAu">Service Orchestrator</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/translator-layer"><span title="Translator Layer" class="linkLabel_PuAu">Translator Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/validation-pipeline"><span title="Validation Pipeline" class="linkLabel_PuAu">Validation Pipeline</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/virtual-interface-factory"><span title="Virtual Interface Factory (VIF)" class="linkLabel_PuAu">Virtual Interface Factory (VIF)</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_namt"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_YAwJ"><div class="docItemContainer_Rv5Z"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_zCmv" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JFrk"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Connection Management</span></li></ul></nav><div class="tocCollapsible_O_Qc theme-doc-toc-mobile tocMobile_tjDr"><button type="button" class="clean-btn tocCollapsibleButton_htYj">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Connection Management</h1></header>
<blockquote>
<p>Per-router connection pool with circuit breaker protection, exponential-backoff reconnection, periodic health monitoring, and hardware/software capability detection with 24-hour caching.</p>
</blockquote>
<p><strong>Packages:</strong> <code>internal/connection/</code>, <code>internal/capability/</code>
<strong>Key Files:</strong> <code>connection/pool.go</code>, <code>connection/circuit.go</code>, <code>connection/manager_reconnect.go</code>, <code>connection/state.go</code>, <code>connection/manager.go</code>, <code>connection/health.go</code>, <code>capability/detector.go</code>, <code>capability/cache.go</code>, <code>capability/types.go</code>
<strong>Prerequisites:</strong> [See: router-communication.md §Protocol Adapters], [See: event-system.md §Event Bus], [See: application-bootstrap.md §Boot Sequence]</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<p>Connection management in NasNetConnect is split into two cooperating packages:</p>
<ul>
<li class=""><strong><code>internal/connection</code></strong> — Manages the lifecycle of each router connection (connect, disconnect, reconnect, health check) using a connection pool, per-router circuit breakers, and exponential-backoff retry loops.</li>
<li class=""><strong><code>internal/capability</code></strong> — Detects what the connected router supports (hardware, software version, container support) and caches the result for 24 hours with background lazy refresh.</li>
</ul>
<p>Both packages are initialized during application bootstrap and wired together through the <code>Manager</code> type, which exposes a single, consistent API for the rest of the codebase to use.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="architecture">Architecture<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture" translate="no">​</a></h2>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ┌────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │           Manager                   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  ┌──────────┐  ┌────────────────┐  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> GraphQL Resolvers  │  │   Pool   │  │ CircuitBreaker │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> ──────────────────►│  │ [routerId│  │ Factory        │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> Bootstrap / Events │  │ →Conn]   │  └────────────────┘  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  └──────────┘         │             │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │        │              │per router   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │        ▼              ▼             │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  ┌──────────────────────────────┐  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │ Connection                    │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │  Status (State machine)       │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │  Client (RouterClient iface)  │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │  CircuitBreaker               │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │  reconnectCancel              │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │  healthCancel                 │  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  └────────────────────────── ────┘  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    └────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                              │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              ┌───────────────┼───────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              ▼               ▼               ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      startReconnection  startHealthMonitoring  EventBus</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       (goroutine)         (goroutine)        (StatusChanged)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    ┌────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │   capability.Service               │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  ┌──────────┐  ┌──────────────┐   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │ Detector │  │ MemoryCache  │   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  │ (5 steps)│  │ (24h TTL)    │   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    │  └──────────┘  └──────────────┘   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    └────────────────────────────────────┘</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="package-reference-internalconnection">Package Reference: <code>internal/connection</code><a href="#package-reference-internalconnection" class="hash-link" aria-label="Direct link to package-reference-internalconnection" title="Direct link to package-reference-internalconnection" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="protocols">Protocols<a href="#protocols" class="hash-link" aria-label="Direct link to Protocols" title="Direct link to Protocols" translate="no">​</a></h3>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Protocol </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ProtocolREST    Protocol </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;REST&quot;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// RouterOS REST API (7.1+), port 80/443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ProtocolAPI     Protocol </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;API&quot;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// Binary API, port 8728</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ProtocolAPISSL  Protocol </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;API_SSL&quot;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// TLS binary API, port 8729</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ProtocolSSH     Protocol </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SSH&quot;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// SSH, port 22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ProtocolTelnet  Protocol </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;TELNET&quot;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// Telnet, port 23</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p>The <code>RouterClient</code> interface abstracts protocol adapters:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> RouterClient </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Connect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Disconnect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">IsConnected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Ping</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Protocol</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>A <code>ClientFactory</code> is provided at <code>Manager</code> construction time; it selects the appropriate adapter based on the connection configuration and available protocol.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="connection-state-machine-statego">Connection State Machine (<code>state.go</code>)<a href="#connection-state-machine-statego" class="hash-link" aria-label="Direct link to connection-state-machine-statego" title="Direct link to connection-state-machine-statego" translate="no">​</a></h3>
<p>Each connection progresses through a finite set of states with validated transitions:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">DISCONNECTED ──► CONNECTING ──► CONNECTED ──► RECONNECTING ──► CONNECTED</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                     │                               │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                     └──────────► ERROR ◄────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                   └──► DISCONNECTED (manual reset)</span><br></span></code></pre></div></div>
<table><thead><tr><th>State</th><th>Meaning</th></tr></thead><tbody><tr><td><code>StateDisconnected</code></td><td>No active connection</td></tr><tr><td><code>StateConnecting</code></td><td>Connection attempt in progress</td></tr><tr><td><code>StateConnected</code></td><td>Active and responsive</td></tr><tr><td><code>StateReconnecting</code></td><td>Lost connection, exponential-backoff retry active</td></tr><tr><td><code>StateError</code></td><td>Permanently failed; manual reconnect required</td></tr></tbody></table>
<p><code>Status.SetState(newState)</code> enforces the transition table — invalid transitions return <code>ErrInvalidStateTransition</code>. Convenience methods also record timestamps and reset counters:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetConnected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// records ConnectedAt, clears error fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetDisconnected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">         </span><span class="token comment" style="color:rgb(98, 114, 164)">// records DisconnectedAt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetReconnecting</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">attempt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> nextAt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">errMsg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">                </span><span class="token comment" style="color:rgb(98, 114, 164)">// records LastError, LastErrorTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">RecordHealthCheck</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">passed </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// tracks HealthChecksPassed/Failed</span><br></span></code></pre></div></div>
<p><code>DisconnectReason</code> encodes why the connection dropped:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReasonManual          </span><span class="token comment" style="color:rgb(98, 114, 164)">// user action — no auto-reconnect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReasonNetworkFailure  </span><span class="token comment" style="color:rgb(98, 114, 164)">// transient — triggers auto-reconnect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReasonAuthFailure     </span><span class="token comment" style="color:rgb(98, 114, 164)">// config error — no auto-reconnect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReasonTimeout         </span><span class="token comment" style="color:rgb(98, 114, 164)">// transient — triggers auto-reconnect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReasonCircuitOpen     </span><span class="token comment" style="color:rgb(98, 114, 164)">// circuit breaker handles recovery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReasonShutdown        </span><span class="token comment" style="color:rgb(98, 114, 164)">// graceful app exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p><code>reason.ShouldAutoReconnect()</code> returns <code>true</code> only for <code>NetworkFailure</code> and <code>Timeout</code>.</p>
<p>The <code>Status</code> struct surfaces all observable connection fields to the GraphQL API:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Status </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    State               State</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Protocol            </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    PreferredProtocol   </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ConnectedAt         </span><span class="token operator">*</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectedAt      </span><span class="token operator">*</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LastError           </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LastErrorTime       </span><span class="token operator">*</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DisconnectReason    DisconnectReason</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ReconnectAttempts   </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    NextReconnectAt     </span><span class="token operator">*</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CircuitBreakerState </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// &quot;CLOSED&quot;, &quot;OPEN&quot;, &quot;HALF_OPEN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Version             </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    LastHealthCheck     </span><span class="token operator">*</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    HealthChecksPassed  </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    HealthChecksFailed  </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="connection-pool-poolgo">Connection Pool (<code>pool.go</code>)<a href="#connection-pool-poolgo" class="hash-link" aria-label="Direct link to connection-pool-poolgo" title="Direct link to connection-pool-poolgo" translate="no">​</a></h3>
<p><code>Pool</code> is a thread-safe map of <code>routerID → *Connection</code>:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Pool </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">/* sync.RWMutex-guarded map */</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewPool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Pool                       </span><span class="token comment" style="color:rgb(98, 114, 164)">// unlimited connections</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewPoolWithLimit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">max </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Pool       </span><span class="token comment" style="color:rgb(98, 114, 164)">// returns nil from GetOrCreate if full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Connection</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">GetOrCreate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">CircuitBreaker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Connection</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">conn </span><span class="token operator">*</span><span class="token plain">Connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Remove</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Connection</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">GetAll</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">*</span><span class="token plain">Connection</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Count</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">CountByState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">state State</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">p </span><span class="token operator">*</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">CloseAll</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// cancels goroutines, disconnects all clients</span><br></span></code></pre></div></div>
<p><code>Connection</code> holds the per-router state:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Connection </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RouterID        </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Status          </span><span class="token operator">*</span><span class="token plain">Status</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Client          RouterClient</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CircuitBreaker  </span><span class="token operator">*</span><span class="token plain">CircuitBreaker</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// private: config, reconnectCancel, healthCancel, mu, manualDisconnect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>Thread-safe accessors use <code>sync.RWMutex</code>:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsConnected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">UpdateStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">Status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// atomic write with lock</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Status              </span><span class="token comment" style="color:rgb(98, 114, 164)">// returns a copy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RouterClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> RouterClient</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetPreferredProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetManuallyDisconnected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p>Reconnect rate-limiting (10-second minimum between manual attempts):</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">canAttempt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> waitTime </span><span class="token operator">:=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">CanAttemptReconnect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">RecordReconnectAttempt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p><code>TransitionError</code> is returned when an invalid state transition is attempted:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> TransitionError </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RouterID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    From</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> To State</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Reason   </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="circuit-breaker-circuitgo">Circuit Breaker (<code>circuit.go</code>)<a href="#circuit-breaker-circuitgo" class="hash-link" aria-label="Direct link to circuit-breaker-circuitgo" title="Direct link to circuit-breaker-circuitgo" translate="no">​</a></h3>
<p>Each router connection has its own <code>CircuitBreaker</code> instance backed by <code>github.com/sony/gobreaker/v2</code>.</p>
<p><strong>Default configuration</strong> (<code>DefaultCircuitBreakerConfig()</code>):</p>
<table><thead><tr><th>Setting</th><th>Default</th><th>Meaning</th></tr></thead><tbody><tr><td><code>MaxFailures</code></td><td>3</td><td>Consecutive failures before OPEN</td></tr><tr><td><code>Timeout</code></td><td>5 minutes</td><td>Cooldown before HALF_OPEN probe</td></tr><tr><td><code>MaxRequests</code></td><td>1</td><td>Probe requests allowed in HALF_OPEN</td></tr></tbody></table>
<p><strong>States:</strong></p>
<table><thead><tr><th>State</th><th>Behaviour</th></tr></thead><tbody><tr><td><code>CLOSED</code></td><td>Normal; all requests pass through</td></tr><tr><td><code>OPEN</code></td><td>Rejects all requests immediately; starts <code>HealthMonitor</code> background probing</td></tr><tr><td><code>HALF_OPEN</code></td><td>Allows one probe request; success → CLOSED, failure → OPEN</td></tr></tbody></table>
<p><strong>State transition callback</strong> — wired at <code>Manager</code> construction to update the connection&#x27;s <code>Status.CircuitBreakerState</code> and emit a log entry:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">WithOnStateChange</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">fn </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> from</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> to gobreaker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">State</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> CircuitBreakerOption</span><br></span></code></pre></div></div>
<p><strong>Execution wrappers:</strong></p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Wraps a function; returns &quot;open circuit: &lt;original error&gt;&quot; if OPEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Execute</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ExecuteWithContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Inspection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">State</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> gobreaker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">State</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">StateString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// &quot;CLOSED&quot; | &quot;OPEN&quot; | &quot;HALF_OPEN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsOpen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsClosed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsHalfOpen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Counts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> gobreaker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Counts  </span><span class="token comment" style="color:rgb(98, 114, 164)">// Requests, TotalSuccesses, TotalFailures, etc.</span><br></span></code></pre></div></div>
<p><code>CircuitBreakerFactory</code> creates per-router breakers from shared configuration:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">factory </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewCircuitBreakerFactory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> onStateChangeFn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cb </span><span class="token operator">:=</span><span class="token plain"> factory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Create</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// named &quot;router-&lt;routerID&gt;&quot;</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="connection-manager-managergo">Connection Manager (<code>manager.go</code>)<a href="#connection-manager-managergo" class="hash-link" aria-label="Direct link to connection-manager-managergo" title="Direct link to connection-manager-managergo" translate="no">​</a></h3>
<p><code>Manager</code> orchestrates the pool, circuit breakers, reconnect loops, and health monitoring:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Manager </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pool          </span><span class="token operator">*</span><span class="token plain">Pool</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cbFactory     </span><span class="token operator">*</span><span class="token plain">CircuitBreakerFactory</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    eventBus      events</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">EventBus</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger        </span><span class="token operator">*</span><span class="token plain">zap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Logger</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clientFactory ClientFactory</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    backoffConfig BackoffConfig</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    healthConfig  HealthConfig</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// private: mu, closed, wg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><strong>Construction:</strong></p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr </span><span class="token operator">:=</span><span class="token plain"> connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewManager</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">eventBus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> clientFactory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">DefaultManagerConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p><code>DefaultManagerConfig()</code> composes the defaults from all sub-systems:</p>
<table><thead><tr><th>Sub-system</th><th>Key Default</th></tr></thead><tbody><tr><td>Circuit breaker</td><td>3 failures → OPEN, 5-min timeout</td></tr><tr><td>Backoff</td><td>initial=1s, max=30s, multiplier=2, jitter=0.5</td></tr><tr><td>Health check</td><td>interval=30s, timeout=5s, threshold=3 failures</td></tr></tbody></table>
<p><strong>Core operations:</strong></p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Establish connection (circuit-breaker-protected)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Connect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Close connection with reason</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Disconnect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> DisconnectReason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Manual reconnect (rate-limited: 10s between attempts)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Reconnect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Retrieve status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetConnection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">Connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetAllConnections</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">*</span><span class="token plain">Connection</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Change preferred protocol (for next connect)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetPreferredProtocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Remove and disconnect a router</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">RemoveConnection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Graceful shutdown (waits for goroutines)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Aggregate statistics</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Stats</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> ManagerStats  </span><span class="token comment" style="color:rgb(98, 114, 164)">// TotalConnections, Connected, Connecting, …</span><br></span></code></pre></div></div>
<p><strong>Connection error handling</strong> — <code>handleConnectionError()</code>:</p>
<ol>
<li class="">Updates <code>Status</code> to <code>StateError</code>.</li>
<li class="">Publishes a <code>StatusChanged</code> event on the event bus.</li>
<li class="">Unless manually disconnected or circuit breaker is OPEN, calls <code>startReconnection()</code>.</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="exponential-backoff-reconnection-manager_reconnectgo">Exponential Backoff Reconnection (<code>manager_reconnect.go</code>)<a href="#exponential-backoff-reconnection-manager_reconnectgo" class="hash-link" aria-label="Direct link to exponential-backoff-reconnection-manager_reconnectgo" title="Direct link to exponential-backoff-reconnection-manager_reconnectgo" translate="no">​</a></h3>
<p><code>startReconnection()</code> spawns a goroutine that calls <code>reconnectLoop()</code>:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// BackoffConfig defaults (per story spec)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">DefaultBackoffConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    InitialInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MaxInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">         </span><span class="token number">30</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Multiplier</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">          </span><span class="token number">2.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    RandomizationFactor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// ±50% jitter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    MaxElapsedTime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">      </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// never give up automatically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><strong>Reconnect loop logic:</strong></p>
<ol>
<li class="">Transition to <code>StateReconnecting</code>, publish event.</li>
<li class="">Create <code>backoff.ExponentialBackOffWithContext</code> (respects context cancellation).</li>
<li class="">On each attempt:
a. Bail if <code>manualDisconnect</code> → <code>backoff.Permanent(err)</code>.
b. Bail if circuit breaker is OPEN → <code>backoff.Permanent(err)</code>.
c. Call <code>clientFactory.CreateClient()</code> + <code>client.Connect()</code> inside <code>cb.ExecuteWithContext()</code>.
d. Record <code>lastReconnectAttempt</code>, increment <code>ReconnectAttempts</code>.</li>
<li class="">On permanent failure:<!-- -->
<ul>
<li class="">If manual disconnect: → <code>StateDisconnected</code>.</li>
<li class="">Otherwise: → <code>StateError</code>.</li>
</ul>
</li>
<li class="">On success:<!-- -->
<ul>
<li class="">Set client on connection.</li>
<li class="">Transition to <code>StateConnected</code>.</li>
<li class="">Publish event.</li>
<li class="">Call <code>startHealthMonitoring()</code>.</li>
</ul>
</li>
</ol>
<p>The backoff goroutine holds a <code>context.CancelFunc</code> stored on <code>Connection.reconnectCancel</code> so it can be cancelled by <code>Disconnect()</code> or <code>Close()</code>.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="health-monitoring-healthgo-manager_healthgo">Health Monitoring (<code>health.go</code>, <code>manager_health.go</code>)<a href="#health-monitoring-healthgo-manager_healthgo" class="hash-link" aria-label="Direct link to health-monitoring-healthgo-manager_healthgo" title="Direct link to health-monitoring-healthgo-manager_healthgo" translate="no">​</a></h3>
<p><strong>Periodic health checks</strong> (<code>startHealthMonitoring</code>):</p>
<p>After a successful connection (or reconnection), a goroutine runs <code>Ping()</code> on the established client every <code>HealthConfig.Interval</code> (default 30 s). Three consecutive failures (configurable via <code>HealthConfig.FailureThreshold</code>) trigger automatic reconnection.</p>
<p><strong><code>HealthMonitor</code></strong> — handles background probing during the OPEN circuit-breaker window:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> HealthMonitor </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">/* manager, eventBus, interval=30s, timeout=5s */</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// For circuit-OPEN routers: probe without going through the breaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">StartBackgroundMonitoring</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">StopBackgroundMonitoring</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">StopAll</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// On-demand health check (goes through established client)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> hm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">CheckHealth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// → HealthResult{RouterID, Healthy, CheckedAt, ResponseTimeMs, Error}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Is the connection currently healthy?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsHealthy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Detailed stats</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">stats</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> hm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetHealthStats</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// → HealthStats{RouterID, ConsecutivePassed, ConsecutiveFailed, LastCheck, IsHealthy}</span><br></span></code></pre></div></div>
<p>Background health check events are published on the event bus as <code>MetricUpdatedEvent</code> with metric name <code>&quot;health_check&quot;</code>.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="package-reference-internalcapability">Package Reference: <code>internal/capability</code><a href="#package-reference-internalcapability" class="hash-link" aria-label="Direct link to package-reference-internalcapability" title="Direct link to package-reference-internalcapability" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview-1">Overview<a href="#overview-1" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Capability detection interrogates a connected router to build a complete profile of what it supports: hardware specs, RouterOS version, installed packages, and container configuration. Results are cached in an in-memory L1 cache with a 24-hour TTL and stale-while-revalidate at the 12-hour mark.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="core-types-typesgo">Core Types (<code>types.go</code>)<a href="#core-types-typesgo" class="hash-link" aria-label="Direct link to core-types-typesgo" title="Direct link to core-types-typesgo" translate="no">​</a></h3>
<p><strong>Capability constants:</strong></p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityContainer  Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;CONTAINER&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityVIF        Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;VIF&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityWireless   Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;WIRELESS&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityRouting    Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ROUTING&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityFirewall   Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;FIREWALL&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityMPLS       Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;MPLS&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityIPv6       Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;IPV6&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityWireGuard  Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;WIREGUARD&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityRESTAPI    Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;REST_API&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityBinaryAPI  Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;BINARY_API&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityACME       Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ACME&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    CapabilityWiFiWave2  Capability </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;WIFI_WAVE2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// … and more</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p><strong>Support levels:</strong></p>
<table><thead><tr><th>Level</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><code>LevelNone</code></td><td>0</td><td>Not supported — hide in UI</td></tr><tr><td><code>LevelBasic</code></td><td>1</td><td>Limited support — show with warnings</td></tr><tr><td><code>LevelAdvanced</code></td><td>2</td><td>Full RouterOS native support</td></tr><tr><td><code>LevelFull</code></td><td>3</td><td>Complete including container-based features</td></tr></tbody></table>
<p>The <code>@capability</code> directive uses level ≥ 1 (<code>BASIC</code>) as its threshold.</p>
<p><strong><code>Capabilities</code> struct</strong> — the complete capability profile:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Capabilities </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Hardware     HardwareInfo    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Architecture, Model, TotalMemory, CPUCount, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Software     SoftwareInfo    </span><span class="token comment" style="color:rgb(98, 114, 164)">// Version (RouterOSVersion), InstalledPackages, LicenseLevel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Container    ContainerInfo   </span><span class="token comment" style="color:rgb(98, 114, 164)">// PackageInstalled, Enabled, StorageAvailable, MaxContainers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Entries      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">Capability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">Entry  </span><span class="token comment" style="color:rgb(98, 114, 164)">// capability → {Level, Description, Guidance}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DetectedAt   time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ExpiresAt    time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Time       </span><span class="token comment" style="color:rgb(98, 114, 164)">// DetectedAt + 24h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    IsRefreshing </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>Key methods on <code>Capabilities</code>:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetLevel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">cap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Level</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HasCapability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">cap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> minLevel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsExpired</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">IsStale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)">// &gt; 12h since detection → trigger background refresh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SetEntry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">cap</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> guidance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">CheckVIFRequirements</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> VIFRequirements  </span><span class="token comment" style="color:rgb(98, 114, 164)">// detailed VIF readiness report</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">VIFGuidance</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">VIFGuidanceStep         </span><span class="token comment" style="color:rgb(98, 114, 164)">// step-by-step remediation</span><br></span></code></pre></div></div>
<p><strong><code>RouterOSVersion</code></strong> — parsed semantic version with feature gates:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SupportsREST</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 7.1+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SupportsContainers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 7.4+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SupportsVIF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain">         </span><span class="token comment" style="color:rgb(98, 114, 164)">// 7.13+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">SupportsWireGuard</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// 7.0+</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="detector-detectorgo">Detector (<code>detector.go</code>)<a href="#detector-detectorgo" class="hash-link" aria-label="Direct link to detector-detectorgo" title="Direct link to detector-detectorgo" translate="no">​</a></h3>
<p>The detector queries the router through a <code>RouterPort</code> interface (satisfied by any router adapter):</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> RouterPort </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">QueryState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> query StateQuery</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">StateResult</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><code>Detect(ctx, port)</code> runs five steps in sequence:</p>
<table><thead><tr><th>Step</th><th>RouterOS Path</th><th>Purpose</th></tr></thead><tbody><tr><td>1</td><td><code>/system/resource</code></td><td>Version, architecture, CPU count, memory, storage, board</td></tr><tr><td>2</td><td><code>/system/package</code></td><td>Installed package list; sets <code>HasWirelessChip</code>, <code>HasLTEModule</code>, <code>PackageInstalled</code> (container)</td></tr><tr><td>3</td><td><code>/system/routerboard</code></td><td>Hardware model (non-fatal if missing)</td></tr><tr><td>4</td><td><code>/container/config</code></td><td>Container enabled, registry configured; computes <code>MaxContainers</code></td></tr><tr><td>5</td><td>(in-memory)</td><td><code>computeCapabilityLevels()</code> — derives <code>Entries</code> map from gathered data</td></tr></tbody></table>
<p>The routerboard step is non-fatal: CHR and cloud instances may not expose this path.</p>
<p>Container <code>MaxContainers</code> is estimated as: <code>min(totalMemory / 50MB, 10)</code>.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="capability-cache-cachego">Capability Cache (<code>cache.go</code>)<a href="#capability-cache-cachego" class="hash-link" aria-label="Direct link to capability-cache-cachego" title="Direct link to capability-cache-cachego" translate="no">​</a></h3>
<p><code>Cache</code> interface backed by <code>memoryCache</code> (in-memory, no persistence):</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Cache </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Get</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">*</span><span class="token plain">Capabilities</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// nil, false if expired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> caps </span><span class="token operator">*</span><span class="token plain">Capabilities</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// stores with ExpiresAt from caps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">Invalidate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">InvalidateAll</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">MarkRefreshing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> refreshing </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">IsRefreshing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">routerID </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewMemoryCache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Cache</span><br></span></code></pre></div></div>
<p><code>Get</code> returns a copy of capabilities with <code>IsRefreshing = true</code> injected if a background refresh is in progress — so callers always get a valid snapshot, never a stale pointer.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="capability-service-cachego">Capability Service (<code>cache.go</code>)<a href="#capability-service-cachego" class="hash-link" aria-label="Direct link to capability-service-cachego" title="Direct link to capability-service-cachego" translate="no">​</a></h3>
<p><code>Service</code> wraps detector + cache with stale-while-revalidate semantics:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Service </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    detector Detector</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cache    Cache</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">detector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Service</span><br></span></code></pre></div></div>
<p><strong><code>GetCapabilities(ctx, routerID, portGetter)</code>:</strong></p>
<ol>
<li class="">Cache hit → return immediately.</li>
<li class="">If cached but stale (&gt; 12h) and not already refreshing → spawn <code>backgroundRefresh()</code> goroutine, still return cached data.</li>
<li class="">Cache miss → <code>detectAndCache()</code> (blocking).</li>
</ol>
<p><strong><code>RefreshCapabilities(ctx, routerID, portGetter)</code></strong> — force re-detect, bypass cache.</p>
<p><strong><code>Invalidate(routerID)</code></strong> — used when the router is disconnected or credentials change.</p>
<p>Background refresh is silent on failure — it never degrades currently-serving cached data.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="version-compatibility-integration-version_integrationgo">Version Compatibility Integration (<code>version_integration.go</code>)<a href="#version-compatibility-integration-version_integrationgo" class="hash-link" aria-label="Direct link to version-compatibility-integration-version_integrationgo" title="Direct link to version-compatibility-integration-version_integrationgo" translate="no">​</a></h3>
<p><code>VersionCapabilityIntegration</code> bridges the hardware-detected <code>Capabilities</code> with the version-based <code>router/compatibility.Service</code>:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">integration </span><span class="token operator">:=</span><span class="token plain"> capability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewVersionCapabilityIntegration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Enrich capabilities entries based on version feature gates</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">integration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">EnhanceCapabilities</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> isCHR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Query specific feature support (version + package check)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">info </span><span class="token operator">:=</span><span class="token plain"> integration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetFeatureSupport</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;rest_api&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> isCHR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// → FeatureSupportInfo{Supported, Reason, UpgradeURL, RequiredPkg}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Batch queries</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">supported </span><span class="token operator">:=</span><span class="token plain"> integration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetSupportedFeatures</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> isCHR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unsupported </span><span class="token operator">:=</span><span class="token plain"> integration</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetUnsupportedFeatures</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">caps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> isCHR</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p><code>EnhanceCapabilities</code> sets capability entries for: <code>REST_API</code>, <code>BINARY_API</code>, <code>ZEROTIER</code>, <code>ACME</code>, <code>WIFI_WAVE2</code> — combining version gate checks with installed-package checks.</p>
<p>Version conversion helpers:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">capability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ConvertToCompatibilityVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RouterOSVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> compatibility</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Version</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">capability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ConvertFromCompatibilityVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">compatibility</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> RouterOSVersion</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="interaction-with-router-adapters">Interaction with Router Adapters<a href="#interaction-with-router-adapters" class="hash-link" aria-label="Direct link to Interaction with Router Adapters" title="Direct link to Interaction with Router Adapters" translate="no">​</a></h2>
<p>The <code>connection.Manager</code> depends on a <code>ClientFactory</code> that is provided at construction. The factory is responsible for selecting and constructing the correct protocol adapter (REST, API, SSH, Telnet). This is wired during bootstrap:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// See: application-bootstrap.md §Boot Sequence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mgr </span><span class="token operator">:=</span><span class="token plain"> connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewManager</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">eventBus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerClientFactory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p>When <code>Manager.Connect()</code> is called, it passes the connection <code>Config</code> (host, port, credentials, preferred protocol) to <code>ClientFactory.CreateClient()</code>. The factory implements fallback chain logic — it tries the preferred protocol first, then falls back through REST → API → SSH → Telnet until one succeeds. [See: router-communication.md §Fallback Chain]</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="edge-cases--operational-notes">Edge Cases &amp; Operational Notes<a href="#edge-cases--operational-notes" class="hash-link" aria-label="Direct link to Edge Cases &amp; Operational Notes" title="Direct link to Edge Cases &amp; Operational Notes" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="manual-vs-automatic-disconnect">Manual vs. Automatic Disconnect<a href="#manual-vs-automatic-disconnect" class="hash-link" aria-label="Direct link to Manual vs. Automatic Disconnect" title="Direct link to Manual vs. Automatic Disconnect" translate="no">​</a></h3>
<p><code>manualDisconnect = true</code> (set by <code>Disconnect(_, DisconnectReasonManual)</code>) suppresses:</p>
<ul>
<li class="">Automatic reconnect trigger after <code>handleConnectionError</code>.</li>
<li class="">The reconnect loop&#x27;s retry attempts (returns <code>backoff.Permanent</code>).</li>
<li class="">The background health monitor&#x27;s ability to re-establish the connection.</li>
</ul>
<p>Calling <code>Reconnect()</code> clears this flag before attempting.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="circuit-breaker-and-reconnect-interaction">Circuit Breaker and Reconnect Interaction<a href="#circuit-breaker-and-reconnect-interaction" class="hash-link" aria-label="Direct link to Circuit Breaker and Reconnect Interaction" title="Direct link to Circuit Breaker and Reconnect Interaction" translate="no">​</a></h3>
<p>When the circuit breaker is OPEN:</p>
<ul>
<li class=""><code>reconnectLoop</code> returns <code>backoff.Permanent</code> immediately (avoids wasteful retries).</li>
<li class=""><code>HealthMonitor.StartBackgroundMonitoring()</code> begins external probing at 30-second intervals without going through the breaker.</li>
<li class="">If a probe succeeds, the event bus fires <code>health_check</code> passed → upstream logic can trigger a manual reconnect to close the breaker via the HALF_OPEN probe.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="pool-limits">Pool Limits<a href="#pool-limits" class="hash-link" aria-label="Direct link to Pool Limits" title="Direct link to Pool Limits" translate="no">​</a></h3>
<p><code>NewPoolWithLimit(max)</code> creates a pool that returns <code>nil</code> from <code>GetOrCreate</code> when full. The Manager logs a <code>Warn</code> and <code>Connect</code> returns an error. Default production configuration uses an unlimited pool (<code>NewPool()</code>).</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="capability-cache-invalidation">Capability Cache Invalidation<a href="#capability-cache-invalidation" class="hash-link" aria-label="Direct link to Capability Cache Invalidation" title="Direct link to Capability Cache Invalidation" translate="no">​</a></h3>
<p>Cache entries are automatically invalidated when:</p>
<ul>
<li class=""><code>Service.Invalidate(routerID)</code> is called explicitly (e.g., router removal).</li>
<li class=""><code>Service.RefreshCapabilities()</code> is called (explicit re-detect).</li>
<li class="">The 24-hour TTL expires (on next <code>Get</code> call).</li>
</ul>
<p>There is no proactive eviction — stale entries remain until queried.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="vif-requirements">VIF Requirements<a href="#vif-requirements" class="hash-link" aria-label="Direct link to VIF Requirements" title="Direct link to VIF Requirements" translate="no">​</a></h3>
<p>The <code>CheckVIFRequirements()</code> method provides a structured checklist used by the UI to guide users through enabling VIF:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">1. RouterOS 7.13+ ✓ / ✗</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2. Container package installed ✓ / ✗</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">3. Container feature enabled ✓ / ✗</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">4. ≥ 100 MB free storage ✓ / ✗</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">5. arm64/x86_64 architecture (network namespace) ✓ / ✗</span><br></span></code></pre></div></div>
<p><code>VIFGuidance()</code> returns ordered <code>VIFGuidanceStep</code> items with RouterOS commands for the resolver to surface in the API.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="cross-references">Cross-References<a href="#cross-references" class="hash-link" aria-label="Direct link to Cross-References" title="Direct link to Cross-References" translate="no">​</a></h2>
<ul>
<li class="">[See: application-bootstrap.md §Boot Sequence] — Manager and capability service construction</li>
<li class="">[See: router-communication.md §Protocol Adapters] — ClientFactory and RouterClient implementations</li>
<li class="">[See: router-communication.md §Fallback Chain] — Protocol selection logic</li>
<li class="">[See: event-system.md §Events] — <code>StatusChangedEvent</code>, <code>MetricUpdatedEvent</code> published by Manager and HealthMonitor</li>
<li class="">[See: graphql-api.md §Directives] — <code>@capability</code> directive consuming <code>Capabilities</code> from context</li>
<li class="">[See: error-handling.md §Error Types] — <code>TransitionError</code>, <code>RouterError</code> used in this package</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_HJkF"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/connection-management.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UohW" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_g62E"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/backend/config-generation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Config Generation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/backend/data-layer"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Data Layer</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_TN1Q thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a></li><li><a href="#package-reference-internalconnection" class="table-of-contents__link toc-highlight">Package Reference: <code>internal/connection</code></a><ul><li><a href="#protocols" class="table-of-contents__link toc-highlight">Protocols</a></li><li><a href="#connection-state-machine-statego" class="table-of-contents__link toc-highlight">Connection State Machine (<code>state.go</code>)</a></li><li><a href="#connection-pool-poolgo" class="table-of-contents__link toc-highlight">Connection Pool (<code>pool.go</code>)</a></li><li><a href="#circuit-breaker-circuitgo" class="table-of-contents__link toc-highlight">Circuit Breaker (<code>circuit.go</code>)</a></li><li><a href="#connection-manager-managergo" class="table-of-contents__link toc-highlight">Connection Manager (<code>manager.go</code>)</a></li><li><a href="#exponential-backoff-reconnection-manager_reconnectgo" class="table-of-contents__link toc-highlight">Exponential Backoff Reconnection (<code>manager_reconnect.go</code>)</a></li><li><a href="#health-monitoring-healthgo-manager_healthgo" class="table-of-contents__link toc-highlight">Health Monitoring (<code>health.go</code>, <code>manager_health.go</code>)</a></li></ul></li><li><a href="#package-reference-internalcapability" class="table-of-contents__link toc-highlight">Package Reference: <code>internal/capability</code></a><ul><li><a href="#overview-1" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#core-types-typesgo" class="table-of-contents__link toc-highlight">Core Types (<code>types.go</code>)</a></li><li><a href="#detector-detectorgo" class="table-of-contents__link toc-highlight">Detector (<code>detector.go</code>)</a></li><li><a href="#capability-cache-cachego" class="table-of-contents__link toc-highlight">Capability Cache (<code>cache.go</code>)</a></li><li><a href="#capability-service-cachego" class="table-of-contents__link toc-highlight">Capability Service (<code>cache.go</code>)</a></li><li><a href="#version-compatibility-integration-version_integrationgo" class="table-of-contents__link toc-highlight">Version Compatibility Integration (<code>version_integration.go</code>)</a></li></ul></li><li><a href="#interaction-with-router-adapters" class="table-of-contents__link toc-highlight">Interaction with Router Adapters</a></li><li><a href="#edge-cases--operational-notes" class="table-of-contents__link toc-highlight">Edge Cases &amp; Operational Notes</a><ul><li><a href="#manual-vs-automatic-disconnect" class="table-of-contents__link toc-highlight">Manual vs. Automatic Disconnect</a></li><li><a href="#circuit-breaker-and-reconnect-interaction" class="table-of-contents__link toc-highlight">Circuit Breaker and Reconnect Interaction</a></li><li><a href="#pool-limits" class="table-of-contents__link toc-highlight">Pool Limits</a></li><li><a href="#capability-cache-invalidation" class="table-of-contents__link toc-highlight">Capability Cache Invalidation</a></li><li><a href="#vif-requirements" class="table-of-contents__link toc-highlight">VIF Requirements</a></li></ul></li><li><a href="#cross-references" class="table-of-contents__link toc-highlight">Cross-References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apps</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/frontend/intro">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/backend/intro">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Libraries</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/ui/intro">UI Components</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/intro">Feature Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api-client/intro">API Client</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/state/intro">State Management</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/core/intro">Core Types</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">API</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/api">Schema Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/category/queries">Queries</a></li><li class="footer__item"><a class="footer__link-item" href="/category/mutations">Mutations</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/primitives/">Storybook (Primitives)</a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/patterns/">Storybook (Patterns)</a></li><li class="footer__item"><a class="footer__link-item" href="/nx-graph/">Nx Graph</a></li><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/Docs/architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">Architecture<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2026 NasNet · Built with Docusaurus</div></div></div></footer></div>
</body>
</html>