<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-backend docs-version-current docs-doc-page docs-doc-id-flows/config-provisioning-flow" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Flow: Config Provisioning | NasNet Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nasnet.dev/docs/backend/flows/config-provisioning-flow"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-backend-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-backend-current"><meta data-rh="true" property="og:title" content="Flow: Config Provisioning | NasNet Docs"><meta data-rh="true" name="description" content="Traces how a desired router configuration is applied through an 8-phase pipeline, with verification and automatic rollback on failure."><meta data-rh="true" property="og:description" content="Traces how a desired router configuration is applied through an 8-phase pipeline, with verification and automatic rollback on failure."><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://nasnet.dev/docs/backend/flows/config-provisioning-flow"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/backend/flows/config-provisioning-flow" hreflang="en"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/backend/flows/config-provisioning-flow" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Flow: Config Provisioning","item":"https://nasnet.dev/docs/backend/flows/config-provisioning-flow"}]}</script><link rel="stylesheet" href="/assets/css/styles.82d9e831.css">
<script src="/assets/js/runtime~main.ca82720f.js" defer="defer"></script>
<script src="/assets/js/main.ffff147f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_G6ar" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--light_DIHH" style="border-radius:6px"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--dark_Bv2M" style="border-radius:6px"></div><b class="navbar__title text--truncate">NasNet Docs</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/frontend/intro">Frontend (Connect)</a></li><li><a class="dropdown__link" href="/docs/backend/intro">Backend (Go)</a></li><li><a class="dropdown__link" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Libraries</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/ui/intro">UI Components</a></li><li><a class="dropdown__link" href="/docs/features/intro">Feature Modules</a></li><li><a class="dropdown__link" href="/docs/api-client/intro">API Client</a></li><li><a class="dropdown__link" href="/docs/state/intro">State Management</a></li><li><a class="dropdown__link" href="/docs/core/intro">Core Types</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Components</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/storybook/primitives/">UI Primitives</a></li><li><a class="dropdown__link" href="/storybook/patterns/">UI Patterns</a></li><li><a class="dropdown__link" href="/storybook/connect/">Connect App</a></li></ul></div><a class="navbar__item navbar__link" href="/api">API Reference</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/nasnet-community/nasnet-panel/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Changelog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><a class="navbar__item navbar__link" href="/nx-graph/">Nx Graph</a><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_OLSw colorModeToggle_Hg9V"><button class="clean-btn toggleButton_wYmb toggleButtonDisabled_vaDU" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ lightToggleIcon_Sxwe"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ darkToggleIcon_Yem1"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ systemToggleIcon_txm5"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_bmvg"><div class="navbar__search searchBarContainer_YZIh" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_eCKk" value=""><div class="loadingRing_pJhT searchBarLoadingRing_NsvA"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_UyTV"><div class="docsWrapper_XLvK"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_z1FD" type="button"></button><div class="docRoot_HciC"><aside class="theme-doc-sidebar-container docSidebarContainer_e5ai"><div class="sidebarViewport_N8x0"><div class="sidebar_vJCc"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_qiME"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/intro"><span title="Introduction" class="linkLabel_PuAu">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/alert-system"><span title="Alert System" class="linkLabel_PuAu">Alert System</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/application-bootstrap"><span title="Application Bootstrap" class="linkLabel_PuAu">Application Bootstrap</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/build-and-deploy"><span title="Build and Deploy" class="linkLabel_PuAu">Build and Deploy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/config-generation"><span title="Config Generation" class="linkLabel_PuAu">Config Generation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/connection-management"><span title="Connection Management" class="linkLabel_PuAu">Connection Management</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/data-layer"><span title="Data Layer" class="linkLabel_PuAu">Data Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/error-handling"><span title="Error Handling &amp; Structured Logging" class="linkLabel_PuAu">Error Handling &amp; Structured Logging</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/event-system"><span title="Event System" class="linkLabel_PuAu">Event System</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/feature-marketplace"><span title="Feature Marketplace" class="linkLabel_PuAu">Feature Marketplace</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_d9ci menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/backend/flows/alert-lifecycle-flow"><span title="flows" class="categoryLinkLabel_Oe72">flows</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/alert-lifecycle-flow"><span title="Flow: Alert Lifecycle" class="linkLabel_PuAu">Flow: Alert Lifecycle</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/backend/flows/config-provisioning-flow"><span title="Flow: Config Provisioning" class="linkLabel_PuAu">Flow: Config Provisioning</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/device-routing-chain-flow"><span title="Flow: Device Routing Chain" class="linkLabel_PuAu">Flow: Device Routing Chain</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/graphql-request-lifecycle"><span title="Flow: GraphQL Request Lifecycle" class="linkLabel_PuAu">Flow: GraphQL Request Lifecycle</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/router-connection-flow"><span title="Flow: Router Connection Establishment" class="linkLabel_PuAu">Flow: Router Connection Establishment</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/service-installation-flow"><span title="Flow: Service Installation" class="linkLabel_PuAu">Flow: Service Installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/service-update-flow"><span title="Flow: Service Update" class="linkLabel_PuAu">Flow: Service Update</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/getting-started"><span title="Getting Started" class="linkLabel_PuAu">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/graphql-api"><span title="GraphQL API Layer" class="linkLabel_PuAu">GraphQL API Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/"><span title="NasNet Backend — Master Index" class="linkLabel_PuAu">NasNet Backend — Master Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/network-services"><span title="Network Services" class="linkLabel_PuAu">Network Services</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/process-isolation"><span title="Process Isolation" class="linkLabel_PuAu">Process Isolation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/provisioning-engine"><span title="Provisioning Engine" class="linkLabel_PuAu">Provisioning Engine</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/router-communication"><span title="Router Communication" class="linkLabel_PuAu">Router Communication</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/router-services"><span title="Router Services" class="linkLabel_PuAu">Router Services</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/security"><span title="Security" class="linkLabel_PuAu">Security</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/service-orchestrator"><span title="Service Orchestrator" class="linkLabel_PuAu">Service Orchestrator</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/translator-layer"><span title="Translator Layer" class="linkLabel_PuAu">Translator Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/validation-pipeline"><span title="Validation Pipeline" class="linkLabel_PuAu">Validation Pipeline</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/virtual-interface-factory"><span title="Virtual Interface Factory (VIF)" class="linkLabel_PuAu">Virtual Interface Factory (VIF)</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_namt"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_YAwJ"><div class="docItemContainer_Rv5Z"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_zCmv" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JFrk"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">flows</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Flow: Config Provisioning</span></li></ul></nav><div class="tocCollapsible_O_Qc theme-doc-toc-mobile tocMobile_tjDr"><button type="button" class="clean-btn tocCollapsibleButton_htYj">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Flow: Config Provisioning</h1></header>
<blockquote>
<p>Traces how a desired router configuration is applied through an 8-phase pipeline, with verification and automatic rollback on failure.</p>
</blockquote>
<p><strong>Touches:</strong> <code>graph/resolver/changeset-*.resolvers.go</code>, <code>internal/provisioning/orchestrator/</code>, <code>internal/router/batch/</code>, <code>internal/services/provisioning/</code>
<strong>Entry Point:</strong> <code>ApplyChangeset</code> mutation in <code>graph/resolver/changeset-operations.resolvers.go</code>
<strong>Prerequisites:</strong></p>
<ul>
<li class="">[See: 03-graphql-api.md §Changesets] — changeset creation and the Apply-Confirm-Merge pattern</li>
<li class="">[See: 08-provisioning-engine.md] — 8-phase pipeline and phase classification</li>
<li class="">[See: 04-router-communication.md §Batch] — batch executor and rollback mechanics</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<p>Configuration provisioning follows the Apply-Confirm-Merge pattern. A changeset is first assembled client-side (Draft state), then submitted for application. The Orchestrator decomposes the desired state into router commands, groups them by phase, and executes them sequentially. If any phase fails, the entire operation is rolled back in reverse order (Phase 8 → Phase 1). All created resource <code>.id</code>s are tracked for precise rollback using O(1) remove commands.</p>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="sequence-diagram">Sequence Diagram<a href="#sequence-diagram" class="hash-link" aria-label="Direct link to Sequence Diagram" title="Direct link to Sequence Diagram" translate="no">​</a></h2>
<!-- -->
<p><strong>Rollback scenario (Phase 6 routing fails):</strong></p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-1-changeset-mutation-entry">Step 1: Changeset Mutation Entry<a href="#step-1-changeset-mutation-entry" class="hash-link" aria-label="Direct link to Step 1: Changeset Mutation Entry" title="Direct link to Step 1: Changeset Mutation Entry" translate="no">​</a></h3>
<ul>
<li class="">Client calls <code>ApplyChangeset(changesetID)</code> GraphQL mutation</li>
<li class=""><strong>File:</strong> <code>graph/resolver/changeset-operations.resolvers.go</code></li>
<li class="">Resolver loads the changeset from database (status must be <code>&quot;draft&quot;</code> or <code>&quot;pending&quot;</code>)</li>
<li class="">Updates changeset status to <code>&quot;applying&quot;</code></li>
<li class="">Validates router connection is alive (via connection pool)</li>
<li class="">Returns a <code>jobID</code> immediately; actual application is async</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-2-state-decomposition">Step 2: State Decomposition<a href="#step-2-state-decomposition" class="hash-link" aria-label="Direct link to Step 2: State Decomposition" title="Direct link to Step 2: State Decomposition" translate="no">​</a></h3>
<ul>
<li class=""><code>ProvisioningService.Apply(ctx, changeset)</code> is called in a goroutine</li>
<li class=""><strong>File:</strong> <code>internal/services/provisioning/apply.go</code></li>
<li class="">Reads the changeset&#x27;s desired state (Universal State v2 8-layer model)</li>
<li class="">Decomposes each resource layer into concrete RouterOS commands:<!-- -->
<ul>
<li class="">Each resource → <code>router.Command{Path, Action, Args}</code></li>
<li class="">Actions: <code>&quot;add&quot;</code> for new resources, <code>&quot;set&quot;</code> for updates, <code>&quot;remove&quot;</code> for deletions</li>
</ul>
</li>
<li class="">Groups commands by their target RouterOS path prefix</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-3-phase-classification">Step 3: Phase Classification<a href="#step-3-phase-classification" class="hash-link" aria-label="Direct link to Step 3: Phase Classification" title="Direct link to Step 3: Phase Classification" translate="no">​</a></h3>
<ul>
<li class=""><code>orchestrator.ClassifyResourcePath(path)</code> maps each command to one of 8 phases</li>
<li class=""><strong>File:</strong> <code>internal/provisioning/orchestrator/phases.go:227</code></li>
<li class="">Uses longest-prefix matching against <code>AllPhases</code> path tables</li>
<li class="">Phase execution order (1→8):<!-- -->
<ol>
<li class=""><code>INTERFACE_SETUP</code> — bridges, WireGuard, PPPoE, VLAN, LTE, WiFi</li>
<li class=""><code>TUNNEL_PEERS</code> — WireGuard peers, IPsec profiles/peers/proposals</li>
<li class=""><code>IP_ADDRESS_POOLS</code> — IP pools, IP address assignments</li>
<li class=""><code>PPP_VPN_SERVERS</code> — PPP profiles/secrets, VPN server endpoints</li>
<li class=""><code>DHCP_NETWORKING</code> — DHCP servers, bridge ports, interface list members</li>
<li class=""><code>ROUTING</code> — routing tables, static routes, PBR rules</li>
<li class=""><code>FIREWALL</code> — address lists, mangle, NAT, filter, raw rules</li>
<li class=""><code>SYSTEM_DNS</code> — DNS, NTP, system identity, scheduler, certificates</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-4-sequential-phase-execution">Step 4: Sequential Phase Execution<a href="#step-4-sequential-phase-execution" class="hash-link" aria-label="Direct link to Step 4: Sequential Phase Execution" title="Direct link to Step 4: Sequential Phase Execution" translate="no">​</a></h3>
<ul>
<li class=""><code>Orchestrator.RunPhases(ctx, commands)</code> iterates phases 1 through 8</li>
<li class=""><strong>File:</strong> <code>internal/provisioning/orchestrator/</code> (orchestrator main)</li>
<li class="">Within each phase, commands are executed sequentially (order matters for dependencies)</li>
<li class="">Each successful <code>&quot;add&quot;</code> command returns a RouterOS <code>.id</code> (e.g., <code>&quot;*3&quot;</code>)</li>
<li class="">Created resource IDs are tracked in <code>PhaseResult.ResourceIDs[]</code> for rollback</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-5-batch-command-execution">Step 5: Batch Command Execution<a href="#step-5-batch-command-execution" class="hash-link" aria-label="Direct link to Step 5: Batch Command Execution" title="Direct link to Step 5: Batch Command Execution" translate="no">​</a></h3>
<ul>
<li class=""><code>Job.Execute()</code> runs the actual commands through <code>executeCommands(ctx)</code></li>
<li class=""><strong>File:</strong> <code>internal/router/batch/executor.go</code> and <code>executor_run.go</code></li>
<li class="">Each command goes through the circuit-breaker-wrapped router adapter</li>
<li class=""><code>DryRun: true</code> mode logs commands without executing (for preview)</li>
<li class=""><code>RollbackEnabled: true</code> pushes inverse commands onto the <code>rollbackStack</code> as commands succeed</li>
<li class="">Progress is tracked: <code>{Total, Current, Percent, Succeeded, Failed, Skipped}</code></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-6-command-execution-via-routerport">Step 6: Command Execution via RouterPort<a href="#step-6-command-execution-via-routerport" class="hash-link" aria-label="Direct link to Step 6: Command Execution via RouterPort" title="Direct link to Step 6: Command Execution via RouterPort" translate="no">​</a></h3>
<ul>
<li class="">Each command is translated to the protocol-specific wire format</li>
<li class="">REST adapter: HTTP POST <code>/{path}/add</code> with JSON body</li>
<li class="">API adapter: binary RouterOS API protocol</li>
<li class="">SSH adapter: <code>/path action key=value</code> CLI syntax</li>
<li class="">Router returns: <code>{&quot;.id&quot;: &quot;*N&quot;}</code> for created resources (RouterOS internal ID)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-7-verification-step">Step 7: Verification Step<a href="#step-7-verification-step" class="hash-link" aria-label="Direct link to Step 7: Verification Step" title="Direct link to Step 7: Verification Step" translate="no">​</a></h3>
<ul>
<li class="">After all 8 phases complete, a verification query is executed</li>
<li class="">Queries <code>/system/identity</code> and one or two key resources to confirm changes persisted</li>
<li class="">On success: changeset status updated to <code>&quot;applied&quot;</code>; <code>ChangesetApplied</code> event published</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-8-rollback-on-failure">Step 8: Rollback on Failure<a href="#step-8-rollback-on-failure" class="hash-link" aria-label="Direct link to Step 8: Rollback on Failure" title="Direct link to Step 8: Rollback on Failure" translate="no">​</a></h3>
<ul>
<li class="">If ANY phase fails, <code>Orchestrator.Rollback(ctx, results)</code> is called</li>
<li class=""><strong>File:</strong> <code>internal/provisioning/orchestrator/rollback.go:30</code></li>
<li class="">Iterates <code>results[]</code> in <strong>reverse</strong> order (Phase 8 → Phase 1)</li>
<li class="">Within each phase, resource IDs are removed in <strong>reverse creation order</strong></li>
<li class="">For each resource: <code>ExecuteCommand(ctx, {Path, Action: &quot;remove&quot;, Args: {&quot;.id&quot;: res.ID}})</code></li>
<li class="">Failures are accumulated in <code>RollbackResult.Errors[]</code> but rollback continues (best-effort)</li>
<li class="">Only <code>&quot;add&quot;</code> resources are removed; <code>&quot;set&quot;</code> changes cannot be automatically reversed (logged)</li>
<li class="">Final summary: <code>{TotalResources, Removed, Failed}</code> logged</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="rollback-mechanics">Rollback Mechanics<a href="#rollback-mechanics" class="hash-link" aria-label="Direct link to Rollback Mechanics" title="Direct link to Rollback Mechanics" translate="no">​</a></h2>
<p>The rollback is precise because each successful <code>&quot;add&quot;</code> command captures the RouterOS <code>.id</code>:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">PhaseResult{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Phase: PhaseRouting,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ResourceIDs: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {Path: &quot;/routing/table&quot;, ID: &quot;*9&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {Path: &quot;/ip/route&quot;,      ID: &quot;*12&quot;},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Rollback removes in reverse: <code>/ip/route remove .id=*12</code> then <code>/routing/table remove .id=*9</code>.</p>
<p>This means rollback never queries the router to find what to remove — it uses the exact IDs returned during apply, making rollback O(1) per resource.</p>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="error-handling">Error Handling<a href="#error-handling" class="hash-link" aria-label="Direct link to Error Handling" title="Direct link to Error Handling" translate="no">​</a></h2>
<table><thead><tr><th>Phase</th><th>Failure</th><th>Recovery</th></tr></thead><tbody><tr><td>Phase 1-7 failure</td><td>Command error</td><td>Rollback phases N → 1; changeset status → <code>&quot;failed&quot;</code></td></tr><tr><td>Phase 8 failure</td><td>Last phase fails</td><td>Rollback phases 8 → 1</td></tr><tr><td>Rollback command fails</td><td>Remove fails</td><td>Log warning; continue with next resource (best-effort)</td></tr><tr><td>Connection lost mid-phase</td><td>Circuit breaker opens</td><td>Phase command returns error → triggers rollback</td></tr><tr><td>Verification fails</td><td>Resources not visible</td><td>Rollback triggered; changeset marked failed</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="observability">Observability<a href="#observability" class="hash-link" aria-label="Direct link to Observability" title="Direct link to Observability" translate="no">​</a></h2>
<p><strong>Events emitted (event bus):</strong></p>
<ul>
<li class=""><code>changeset.applying</code> — when application starts</li>
<li class=""><code>changeset.applied</code> — on successful completion</li>
<li class=""><code>changeset.failed</code> — on error with reason</li>
<li class=""><code>changeset.rolled_back</code> — after rollback completes</li>
</ul>
<p><strong>Logs generated:</strong></p>
<ul>
<li class=""><code>INFO: rolling back provisioned resource</code> with phase, path, and ID for each rollback</li>
<li class=""><code>WARN: rollback remove failed</code> with error details</li>
<li class=""><code>INFO: rollback complete</code> with total/removed/failed counts</li>
<li class="">Phase-level progress: <code>INFO: executing phase N: PHASE_NAME</code></li>
</ul>
<p><strong>Metrics:</strong></p>
<ul>
<li class="">Changeset duration: tracked from <code>applying</code> → <code>applied</code> or <code>failed</code></li>
<li class="">Rollback success rate: <code>Removed / TotalResources</code> ratio</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="cross-references">Cross-References<a href="#cross-references" class="hash-link" aria-label="Direct link to Cross-References" title="Direct link to Cross-References" translate="no">​</a></h2>
<ul>
<li class="">[See: 08-provisioning-engine.md §Phases] — phase definitions and path classifications</li>
<li class="">[See: 08-provisioning-engine.md §Orchestrator] — orchestrator implementation details</li>
<li class="">[See: 04-router-communication.md §Batch] — batch job executor and rollback stack</li>
<li class="">[See: 02-application-bootstrap.md §DataArchitecture] — Universal State v2 8-layer model</li>
<li class="">[See: 03-graphql-api.md §Changesets] — changeset GraphQL schema and mutations</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_HJkF"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/flows/config-provisioning-flow.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UohW" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_g62E"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/backend/flows/alert-lifecycle-flow"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Flow: Alert Lifecycle</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/backend/flows/device-routing-chain-flow"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Flow: Device Routing Chain</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_TN1Q thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#sequence-diagram" class="table-of-contents__link toc-highlight">Sequence Diagram</a></li><li><a href="#step-by-step-walkthrough" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a><ul><li><a href="#step-1-changeset-mutation-entry" class="table-of-contents__link toc-highlight">Step 1: Changeset Mutation Entry</a></li><li><a href="#step-2-state-decomposition" class="table-of-contents__link toc-highlight">Step 2: State Decomposition</a></li><li><a href="#step-3-phase-classification" class="table-of-contents__link toc-highlight">Step 3: Phase Classification</a></li><li><a href="#step-4-sequential-phase-execution" class="table-of-contents__link toc-highlight">Step 4: Sequential Phase Execution</a></li><li><a href="#step-5-batch-command-execution" class="table-of-contents__link toc-highlight">Step 5: Batch Command Execution</a></li><li><a href="#step-6-command-execution-via-routerport" class="table-of-contents__link toc-highlight">Step 6: Command Execution via RouterPort</a></li><li><a href="#step-7-verification-step" class="table-of-contents__link toc-highlight">Step 7: Verification Step</a></li><li><a href="#step-8-rollback-on-failure" class="table-of-contents__link toc-highlight">Step 8: Rollback on Failure</a></li></ul></li><li><a href="#rollback-mechanics" class="table-of-contents__link toc-highlight">Rollback Mechanics</a></li><li><a href="#error-handling" class="table-of-contents__link toc-highlight">Error Handling</a></li><li><a href="#observability" class="table-of-contents__link toc-highlight">Observability</a></li><li><a href="#cross-references" class="table-of-contents__link toc-highlight">Cross-References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apps</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/frontend/intro">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/backend/intro">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Libraries</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/ui/intro">UI Components</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/intro">Feature Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api-client/intro">API Client</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/state/intro">State Management</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/core/intro">Core Types</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">API</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/api">Schema Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/category/queries">Queries</a></li><li class="footer__item"><a class="footer__link-item" href="/category/mutations">Mutations</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/primitives/">Storybook (Primitives)</a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/patterns/">Storybook (Patterns)</a></li><li class="footer__item"><a class="footer__link-item" href="/nx-graph/">Nx Graph</a></li><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/Docs/architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">Architecture<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2026 NasNet · Built with Docusaurus</div></div></div></footer></div>
</body>
</html>