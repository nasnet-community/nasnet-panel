<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-backend docs-version-current docs-doc-page docs-doc-id-flows/graphql-request-lifecycle" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Flow: GraphQL Request Lifecycle | NasNet Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nasnet.dev/docs/backend/flows/graphql-request-lifecycle"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-backend-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-backend-current"><meta data-rh="true" property="og:title" content="Flow: GraphQL Request Lifecycle | NasNet Docs"><meta data-rh="true" name="description" content="Traces the complete path of a GraphQL request from TCP arrival at the Echo HTTP server through"><meta data-rh="true" property="og:description" content="Traces the complete path of a GraphQL request from TCP arrival at the Echo HTTP server through"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://nasnet.dev/docs/backend/flows/graphql-request-lifecycle"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/backend/flows/graphql-request-lifecycle" hreflang="en"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/backend/flows/graphql-request-lifecycle" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Flow: GraphQL Request Lifecycle","item":"https://nasnet.dev/docs/backend/flows/graphql-request-lifecycle"}]}</script><link rel="stylesheet" href="/assets/css/styles.82d9e831.css">
<script src="/assets/js/runtime~main.ca82720f.js" defer="defer"></script>
<script src="/assets/js/main.ffff147f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_G6ar" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--light_DIHH" style="border-radius:6px"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--dark_Bv2M" style="border-radius:6px"></div><b class="navbar__title text--truncate">NasNet Docs</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/frontend/intro">Frontend (Connect)</a></li><li><a class="dropdown__link" href="/docs/backend/intro">Backend (Go)</a></li><li><a class="dropdown__link" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Libraries</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/ui/intro">UI Components</a></li><li><a class="dropdown__link" href="/docs/features/intro">Feature Modules</a></li><li><a class="dropdown__link" href="/docs/api-client/intro">API Client</a></li><li><a class="dropdown__link" href="/docs/state/intro">State Management</a></li><li><a class="dropdown__link" href="/docs/core/intro">Core Types</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Components</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/storybook/primitives/">UI Primitives</a></li><li><a class="dropdown__link" href="/storybook/patterns/">UI Patterns</a></li><li><a class="dropdown__link" href="/storybook/connect/">Connect App</a></li></ul></div><a class="navbar__item navbar__link" href="/api">API Reference</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/nasnet-community/nasnet-panel/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Changelog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><a class="navbar__item navbar__link" href="/nx-graph/">Nx Graph</a><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_OLSw colorModeToggle_Hg9V"><button class="clean-btn toggleButton_wYmb toggleButtonDisabled_vaDU" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ lightToggleIcon_Sxwe"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ darkToggleIcon_Yem1"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ systemToggleIcon_txm5"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_bmvg"><div class="navbar__search searchBarContainer_YZIh" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_eCKk" value=""><div class="loadingRing_pJhT searchBarLoadingRing_NsvA"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_UyTV"><div class="docsWrapper_XLvK"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_z1FD" type="button"></button><div class="docRoot_HciC"><aside class="theme-doc-sidebar-container docSidebarContainer_e5ai"><div class="sidebarViewport_N8x0"><div class="sidebar_vJCc"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_qiME"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/intro"><span title="Introduction" class="linkLabel_PuAu">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/alert-system"><span title="Alert System" class="linkLabel_PuAu">Alert System</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/application-bootstrap"><span title="Application Bootstrap" class="linkLabel_PuAu">Application Bootstrap</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/build-and-deploy"><span title="Build and Deploy" class="linkLabel_PuAu">Build and Deploy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/config-generation"><span title="Config Generation" class="linkLabel_PuAu">Config Generation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/connection-management"><span title="Connection Management" class="linkLabel_PuAu">Connection Management</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/data-layer"><span title="Data Layer" class="linkLabel_PuAu">Data Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/error-handling"><span title="Error Handling &amp; Structured Logging" class="linkLabel_PuAu">Error Handling &amp; Structured Logging</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/event-system"><span title="Event System" class="linkLabel_PuAu">Event System</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/feature-marketplace"><span title="Feature Marketplace" class="linkLabel_PuAu">Feature Marketplace</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_d9ci menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/backend/flows/alert-lifecycle-flow"><span title="flows" class="categoryLinkLabel_Oe72">flows</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/alert-lifecycle-flow"><span title="Flow: Alert Lifecycle" class="linkLabel_PuAu">Flow: Alert Lifecycle</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/config-provisioning-flow"><span title="Flow: Config Provisioning" class="linkLabel_PuAu">Flow: Config Provisioning</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/device-routing-chain-flow"><span title="Flow: Device Routing Chain" class="linkLabel_PuAu">Flow: Device Routing Chain</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/backend/flows/graphql-request-lifecycle"><span title="Flow: GraphQL Request Lifecycle" class="linkLabel_PuAu">Flow: GraphQL Request Lifecycle</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/router-connection-flow"><span title="Flow: Router Connection Establishment" class="linkLabel_PuAu">Flow: Router Connection Establishment</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/service-installation-flow"><span title="Flow: Service Installation" class="linkLabel_PuAu">Flow: Service Installation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/flows/service-update-flow"><span title="Flow: Service Update" class="linkLabel_PuAu">Flow: Service Update</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/getting-started"><span title="Getting Started" class="linkLabel_PuAu">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/graphql-api"><span title="GraphQL API Layer" class="linkLabel_PuAu">GraphQL API Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/"><span title="NasNet Backend — Master Index" class="linkLabel_PuAu">NasNet Backend — Master Index</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/network-services"><span title="Network Services" class="linkLabel_PuAu">Network Services</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/process-isolation"><span title="Process Isolation" class="linkLabel_PuAu">Process Isolation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/provisioning-engine"><span title="Provisioning Engine" class="linkLabel_PuAu">Provisioning Engine</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/router-communication"><span title="Router Communication" class="linkLabel_PuAu">Router Communication</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/router-services"><span title="Router Services" class="linkLabel_PuAu">Router Services</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/security"><span title="Security" class="linkLabel_PuAu">Security</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/service-orchestrator"><span title="Service Orchestrator" class="linkLabel_PuAu">Service Orchestrator</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/translator-layer"><span title="Translator Layer" class="linkLabel_PuAu">Translator Layer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/validation-pipeline"><span title="Validation Pipeline" class="linkLabel_PuAu">Validation Pipeline</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/backend/virtual-interface-factory"><span title="Virtual Interface Factory (VIF)" class="linkLabel_PuAu">Virtual Interface Factory (VIF)</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_namt"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_YAwJ"><div class="docItemContainer_Rv5Z"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_zCmv" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JFrk"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">flows</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Flow: GraphQL Request Lifecycle</span></li></ul></nav><div class="tocCollapsible_O_Qc theme-doc-toc-mobile tocMobile_tjDr"><button type="button" class="clean-btn tocCollapsibleButton_htYj">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Flow: GraphQL Request Lifecycle</h1></header>
<blockquote>
<p>Traces the complete path of a GraphQL request from TCP arrival at the Echo HTTP server through
middleware, directive evaluation, DataLoader batching, resolver execution, router command dispatch
via the fallback chain, and response serialization back to the client.</p>
</blockquote>
<p><strong>Touches:</strong> <code>internal/server/</code>, <code>internal/middleware/</code>, <code>internal/graphql/directives/</code>,
<code>internal/graphql/loaders/</code>, <code>graph/resolver/</code>, <code>internal/router/</code> <strong>Entry Point:</strong> Echo HTTP
listener on <code>0.0.0.0:80</code> (production) or <code>0.0.0.0:8080</code> (development) <strong>Prerequisites:</strong></p>
<ul>
<li class="">[See: 03-graphql-api.md §Resolvers] — resolver layer architecture and generated code</li>
<li class="">[See: 04-router-communication.md §FallbackChain] — protocol negotiation and command dispatch</li>
<li class="">[See: 12-security.md §JWT Authentication] — token validation internals</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<p>Every GraphQL operation (query, mutation, or subscription) passes through a well-defined stack:
Echo&#x27;s HTTP server, a middleware chain for correlation and authentication, the gqlgen-generated
executor which applies custom directives, per-request DataLoaders for batched database reads, domain
resolvers that translate operations to RouterOS commands, the fallback chain for protocol-agnostic
command dispatch, and finally error presentation and JSON serialization.</p>
<p>The entire path is synchronous within a single goroutine for queries/mutations. Subscriptions follow
the same middleware path but diverge at execution by establishing a WebSocket upgrade and streaming
events from the event bus.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="high-level-sequence-diagram">High-Level Sequence Diagram<a href="#high-level-sequence-diagram" class="hash-link" aria-label="Direct link to High-Level Sequence Diagram" title="Direct link to High-Level Sequence Diagram" translate="no">​</a></h2>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-1-tcp-arrival-and-echo-routing">Step 1: TCP Arrival and Echo Routing<a href="#step-1-tcp-arrival-and-echo-routing" class="hash-link" aria-label="Direct link to Step 1: TCP Arrival and Echo Routing" title="Direct link to Step 1: TCP Arrival and Echo Routing" translate="no">​</a></h3>
<p>The Echo HTTP server (<code>internal/server/server.go</code>) listens on <code>0.0.0.0:{PORT}</code> (defaults: 80 in
production, 8080 in development). Echo&#x27;s router matches the incoming <code>POST /graphql</code> path and
dispatches to the registered GraphQL handler.</p>
<p><strong>Server configuration</strong> (<code>DefaultProdConfig</code>):</p>
<ul>
<li class=""><code>ReadTimeout: 30s</code> — maximum time to read the full request body</li>
<li class=""><code>WriteTimeout: 30s</code> — maximum time to write the response</li>
<li class=""><code>IdleTimeout: 60s</code> — keep-alive idle timeout</li>
</ul>
<p>The server uses <code>echo.New()</code> with <code>HideBanner: true</code> and <code>HidePort: true</code> for clean log output.
Graceful shutdown is managed via <code>SIGINT</code>/<code>SIGTERM</code> handling with a 15-second drain window.</p>
<p><strong>File:</strong> <code>internal/server/server.go</code></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-2-middleware-stack">Step 2: Middleware Stack<a href="#step-2-middleware-stack" class="hash-link" aria-label="Direct link to Step 2: Middleware Stack" title="Direct link to Step 2: Middleware Stack" translate="no">​</a></h3>
<p>Middleware executes in registration order before the GraphQL handler is invoked. Two key middlewares
run for every GraphQL request:</p>
<h4 class="anchor anchorTargetStickyNavbar_SAay" id="2a-request-id-middleware">2a. Request ID Middleware<a href="#2a-request-id-middleware" class="hash-link" aria-label="Direct link to 2a. Request ID Middleware" title="Direct link to 2a. Request ID Middleware" translate="no">​</a></h4>
<p><strong>File:</strong> <code>internal/middleware/request_id.go</code></p>
<!-- -->
<p>The ULID is stored in context via <code>apperrors.WithRequestID()</code> and propagates through the entire call
stack. It surfaces in:</p>
<ul>
<li class="">Error responses (as <code>extensions.requestId</code>)</li>
<li class="">Structured log fields (<code>request_id</code>)</li>
<li class="">Event bus events emitted during request handling</li>
</ul>
<p><strong>Key constant:</strong> <code>RequestIDHeader = &quot;X-Request-ID&quot;</code></p>
<h4 class="anchor anchorTargetStickyNavbar_SAay" id="2b-auth-middleware">2b. Auth Middleware<a href="#2b-auth-middleware" class="hash-link" aria-label="Direct link to 2b. Auth Middleware" title="Direct link to 2b. Auth Middleware" translate="no">​</a></h4>
<p><strong>File:</strong> <code>internal/middleware/auth.go</code></p>
<!-- -->
<p>The authenticated <code>AuthUser</code> is available in all downstream resolvers via
<code>middleware.UserFromContext(ctx)</code>.</p>
<p><strong>Supported auth methods:</strong></p>
<table><thead><tr><th>Method</th><th>Header/Cookie</th><th>Flow</th></tr></thead><tbody><tr><td>JWT Bearer</td><td><code>Authorization: Bearer &lt;token&gt;</code></td><td>Validate → decode claims</td></tr><tr><td>Session cookie</td><td><code>access_token</code> cookie (HttpOnly)</td><td>Validate → decode claims</td></tr><tr><td>API key</td><td><code>X-API-Key: nas_xxx</code></td><td>Call <code>APIKeyValidator</code></td></tr></tbody></table>
<p>[See: 12-security.md §JWT Authentication] for token structure and signing details.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-3-graphql-handler-entry">Step 3: GraphQL Handler Entry<a href="#step-3-graphql-handler-entry" class="hash-link" aria-label="Direct link to Step 3: GraphQL Handler Entry" title="Direct link to Step 3: GraphQL Handler Entry" translate="no">​</a></h3>
<p>The gqlgen-generated GraphQL handler receives the parsed HTTP request and begins operation
processing:</p>
<ol>
<li class=""><strong>Parse operation</strong> — deserialize the JSON body (<code>{ query, variables, operationName }</code>)</li>
<li class=""><strong>Validate schema</strong> — check that field selections and arguments are valid per the schema</li>
<li class=""><strong>Complexity calculation</strong> — prevent expensive queries (depth limiting, field counting)</li>
<li class=""><strong>DataLoader initialization</strong> — create per-request batching loaders (see Step 4)</li>
<li class=""><strong>Directive evaluation</strong> — apply <code>@auth</code>, <code>@validate</code>, <code>@sensitive</code>, <code>@capability</code> directives
(see Step 5)</li>
<li class=""><strong>Resolver dispatch</strong> — call root resolvers for selected fields (see Step 6)</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-4-dataloader-initialization-per-request">Step 4: DataLoader Initialization (Per-Request)<a href="#step-4-dataloader-initialization-per-request" class="hash-link" aria-label="Direct link to Step 4: DataLoader Initialization (Per-Request)" title="Direct link to Step 4: DataLoader Initialization (Per-Request)" translate="no">​</a></h3>
<p><strong>Files:</strong> <code>internal/graphql/loaders/resource_loader.go</code>,
<code>internal/graphql/loaders/router_loader.go</code>, <code>internal/graphql/loaders/helpers.go</code></p>
<p>DataLoaders are initialized fresh per request (not shared across requests) to prevent cross-request
cache pollution:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Request context</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ ResourceLoader    (batches resource IDs → single DB query)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ RouterLoader      (batches router IDs → single DB query)</span><br></span></code></pre></div></div>
<p><strong>How DataLoader batching works:</strong></p>
<p>When a resolver calls <code>loader.Load(ctx, id)</code>, the DataLoader does not immediately execute a database
query. Instead, it collects all load calls made during the same scheduler tick, then fires a single
batch query:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Resolver A: loader.Load(ctx, &quot;id-1&quot;)  ┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Resolver B: loader.Load(ctx, &quot;id-2&quot;)  ├─ collected → db.Query(WHERE id IN (&quot;id-1&quot;,&quot;id-2&quot;,&quot;id-3&quot;))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Resolver C: loader.Load(ctx, &quot;id-3&quot;)  ┘</span><br></span></code></pre></div></div>
<p>The <code>mapToResults()</code> helper maps batch results back to the original key order, handling partial
failures with per-key <code>NotFoundError</code>.</p>
<p><strong>Batch capacity:</strong> 100 keys per batch (configurable). Prevents unbounded queries on large result
sets.</p>
<p><strong>After mutations:</strong> Call <code>loader.Clear(ctx, id)</code> or <code>loader.ClearAll()</code> to invalidate cached
entries and ensure fresh reads.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-5-custom-directive-evaluation">Step 5: Custom Directive Evaluation<a href="#step-5-custom-directive-evaluation" class="hash-link" aria-label="Direct link to Step 5: Custom Directive Evaluation" title="Direct link to Step 5: Custom Directive Evaluation" translate="no">​</a></h3>
<p><strong>File:</strong> <code>internal/graphql/directives/directives.go</code></p>
<p>Four custom directives intercept field resolution before resolver functions execute:</p>
<h4 class="anchor anchorTargetStickyNavbar_SAay" id="auth--authorization">@auth — Authorization<a href="#auth--authorization" class="hash-link" aria-label="Direct link to @auth — Authorization" title="Direct link to @auth — Authorization" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@auth(requires: &quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ GetAuthInfo(ctx) — reads auth info placed by middleware</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ authInfo.Authenticated == false → gqlerror A401 (auth/authentication-required)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ requires != nil → check authInfo.Roles contains required role</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      └─ missing role → gqlerror A401 (auth/insufficient-permissions)</span><br></span></code></pre></div></div>
<p>Note: The HTTP-layer <code>AuthMiddleware</code> enforces authentication for all requests. The <code>@auth</code>
directive provides <strong>field-level</strong> role checks within already-authenticated requests.</p>
<h4 class="anchor anchorTargetStickyNavbar_SAay" id="validate--input-validation">@validate — Input Validation<a href="#validate--input-validation" class="hash-link" aria-label="Direct link to @validate — Input Validation" title="Direct link to @validate — Input Validation" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@validate(minLength: 1, maxLength: 255, format: IPV4)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ Resolve field value first (calls next(ctx))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ Numeric: validateNumericRange(min, max)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ String: validateStringConstraints(minLength, maxLength, pattern, format)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      └─ format: EMAIL | URL | UUID | IPV4 | IPV6 | MAC | CIDR | HOSTNAME | FQDN</span><br></span></code></pre></div></div>
<p>Validation errors are returned as <code>gqlerror.Error</code> with <code>extensions.code = &quot;V400&quot;</code> and a
<code>suggestedFix</code> field for the client.</p>
<h4 class="anchor anchorTargetStickyNavbar_SAay" id="sensitive--log-redaction">@sensitive — Log Redaction<a href="#sensitive--log-redaction" class="hash-link" aria-label="Direct link to @sensitive — Log Redaction" title="Direct link to @sensitive — Log Redaction" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@sensitive</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ Track field path in ctx[sensitiveContextKey]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ createValidationError() checks: if field is sensitive → value = &quot;[REDACTED]&quot;</span><br></span></code></pre></div></div>
<p>Marks fields containing credentials or PII. The directive does not prevent the value from being
returned to the client — it prevents the value from appearing in error extensions and logs.</p>
<h4 class="anchor anchorTargetStickyNavbar_SAay" id="capability--router-feature-gating">@capability — Router Feature Gating<a href="#capability--router-feature-gating" class="hash-link" aria-label="Direct link to @capability — Router Feature Gating" title="Direct link to @capability — Router Feature Gating" translate="no">​</a></h4>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">@capability(requires: [&quot;wireguard&quot;, &quot;container&quot;])</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ GetCapabilities(ctx) — capabilities loaded per-request from CapabilityService</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ Check each required cap against capMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ Missing caps → gqlerror C403 (capability/unsupported) with missingCapabilities list</span><br></span></code></pre></div></div>
<p>Router capabilities are detected once per connection and cached by <code>CapabilityService</code>. They are
injected into the request context before the GraphQL handler runs.</p>
<p>[See: 17-validation-pipeline.md] for complete validation error structure and error codes.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-6-resolver-execution">Step 6: Resolver Execution<a href="#step-6-resolver-execution" class="hash-link" aria-label="Direct link to Step 6: Resolver Execution" title="Direct link to Step 6: Resolver Execution" translate="no">​</a></h3>
<p><strong>Files:</strong> <code>graph/resolver/resolver.go</code>, <code>graph/resolver/common_helpers.go</code></p>
<p>The <code>Resolver</code> struct holds references to all domain services injected at startup. Each generated
resolver file (e.g., <code>core-queries.resolvers.go</code>, <code>services-crud-ops.resolvers.go</code>) implements
methods on <code>*queryResolver</code> or <code>*mutationResolver</code> which embed <code>*Resolver</code>.</p>
<p><strong>Context helpers used in resolvers:</strong></p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Extract authenticated user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user </span><span class="token operator">:=</span><span class="token plain"> middleware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">UserFromContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Extract request ID for error correlation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">requestID </span><span class="token operator">:=</span><span class="token plain"> apperrors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetRequestID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Extract user ID (validated, returns error if unauthenticated)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">userID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getUserIDFromContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div>
<p><strong>Typical query resolver pattern:</strong></p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resolver.GetRouter(ctx, id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ middleware.UserFromContext(ctx)           → verify authenticated</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ r.RouterService.GetByID(ctx, id)         → service call</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │   └─ entDB.Router.Query().Where(id)       → database read</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ convert ent.Router → model.Router        → return GraphQL type</span><br></span></code></pre></div></div>
<p><strong>Typical mutation resolver pattern:</strong></p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">resolver.UpdateFirewallRule(ctx, input)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ middleware.UserFromContext(ctx)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ validate input (service-level)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ r.RouterService.GetConnection(ctx, routerID) → get RouterPort</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ build Command{Path: &quot;/ip/firewall/filter/set&quot;, Params: {...}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ conn.ExecuteCommand(ctx, cmd)             → send to router</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ update local DB record</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ return updated model</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-7-router-command-translation">Step 7: Router Command Translation<a href="#step-7-router-command-translation" class="hash-link" aria-label="Direct link to Step 7: Router Command Translation" title="Direct link to Step 7: Router Command Translation" translate="no">​</a></h3>
<p>Before commands reach the wire, they are translated from the GraphQL input model to
RouterOS-specific command parameters.</p>
<p><strong>Key layer:</strong> <code>internal/router/ssh/translator.go</code> (SSH adapter) and
<code>internal/router/adapters/mikrotik/</code> (API/REST adapters).</p>
<p>The translation layer handles:</p>
<ul>
<li class="">Field name mapping (camelCase GraphQL fields → kebab-case RouterOS properties)</li>
<li class="">Type coercion (Go booleans → <code>&quot;yes&quot;/&quot;no&quot;</code> strings for RouterOS)</li>
<li class="">Duration formatting (Go <code>time.Duration</code> → RouterOS duration strings like <code>&quot;1h30m&quot;</code>)</li>
<li class="">Enumeration mapping (GraphQL enum values → RouterOS constants)</li>
</ul>
<p>[See: 16-translator-layer.md] for complete field mapping tables and formatter implementations.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-8-routeros-command-execution-via-fallbackchain">Step 8: RouterOS Command Execution via FallbackChain<a href="#step-8-routeros-command-execution-via-fallbackchain" class="hash-link" aria-label="Direct link to Step 8: RouterOS Command Execution via FallbackChain" title="Direct link to Step 8: RouterOS Command Execution via FallbackChain" translate="no">​</a></h3>
<p><strong>File:</strong> <code>internal/router/fallback_chain.go</code></p>
<p>Every router command executes through the <code>FallbackChain</code>, which provides:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FallbackChain.ExecuteCommand(ctx, cmd)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ fc.mu.RLock() → get currentPort (adapter) + currentProto</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ CircuitBreaker.Execute(func):</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │   ├─ CB state == Open → return error (skip this protocol)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │   ├─ CB state == HalfOpen → allow 1 test request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │   └─ CB state == Closed → allow request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │       └─ adapter.ExecuteCommand(ctx, cmd)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │           ├─ REST adapter: HTTP PUT/POST to RouterOS REST API</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │           ├─ API adapter: binary RouterOS API sentence</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │           ├─ SSH adapter: SSH command via translator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │           └─ Telnet adapter: legacy terminal commands</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├─ On success → return *CommandResult</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └─ On error:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ├─ CB records failure</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ├─ If CB opens → go fc.attemptReconnect(background ctx)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      └─ Return error to resolver</span><br></span></code></pre></div></div>
<p><strong>Protocol fallback order:</strong></p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">REST → API → API+SSL → SSH → Telnet</span><br></span></code></pre></div></div>
<p>Each protocol has its own circuit breaker (3 consecutive failures → open for 5 minutes).</p>
<p><strong>Automatic reconnection:</strong> When a circuit breaker opens, a background goroutine attempts
reconnection through the fallback chain, trying each protocol in order and skipping open circuits.
Status changes are published as <code>RouterStatusChangedEvent</code> on the event bus (within 100ms).</p>
<p>[See: 04-router-communication.md §FallbackChain] for circuit breaker state machine and reconnection
details. [See: 15-connection-management.md] for the connection pool and per-router connection lifecycle.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-9-response-translation">Step 9: Response Translation<a href="#step-9-response-translation" class="hash-link" aria-label="Direct link to Step 9: Response Translation" title="Direct link to Step 9: Response Translation" translate="no">​</a></h3>
<p>After the router returns raw output (e.g., RouterOS API response maps or SSH parsed tables), the
translator converts it back to Go structs and then to GraphQL model types.</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">RouterOS response (map[string]string or []map[string]string)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├─ SSH adapter: parser (terse/table/keyvalue/detail)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ├─ API adapter: binary sentence → Go map</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    └─ REST adapter: JSON → Go map</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    └─ Translator.ResponseToModel(rawOutput, targetType)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        └─ Field mapper: &quot;mac-address&quot; → MacAddress, &quot;tx-byte&quot; → TxBytes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        └─ Return *model.Interface or []model.FirewallRule etc.</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-10-error-presentation">Step 10: Error Presentation<a href="#step-10-error-presentation" class="hash-link" aria-label="Direct link to Step 10: Error Presentation" title="Direct link to Step 10: Error Presentation" translate="no">​</a></h3>
<p><strong>File:</strong> <code>internal/apperrors/</code> (see internal errors package)</p>
<p>Errors propagate up through the resolver stack as Go errors. The gqlgen error presenter converts
them to <code>gqlerror.Error</code> entries in the <code>errors</code> array of the GraphQL response.</p>
<p><strong>Error categories and codes:</strong></p>
<table><thead><tr><th>Code</th><th>Category</th><th>Example</th></tr></thead><tbody><tr><td><code>V400</code></td><td>Validation</td><td><code>@validate</code> directive violation</td></tr><tr><td><code>A401</code></td><td>Auth</td><td>Missing authentication, insufficient role</td></tr><tr><td><code>C403</code></td><td>Capability</td><td>Router lacks required feature</td></tr><tr><td><code>N404</code></td><td>Not found</td><td>Resource not in database</td></tr><tr><td><code>R500</code></td><td>Router</td><td>RouterOS command failed</td></tr><tr><td><code>S503</code></td><td>Service</td><td>Backend service unavailable</td></tr></tbody></table>
<p>In production mode (<code>GO_ENV=production</code>), error messages are sanitized:</p>
<ul>
<li class="">Internal implementation details stripped</li>
<li class="">Sensitive field values redacted (<code>[REDACTED]</code>)</li>
<li class="">Stack traces removed from response</li>
</ul>
<p>The <code>requestId</code> field in every error extension enables correlation with server logs.</p>
<p>[See: 14-error-handling.md] for complete error code taxonomy, redaction rules, and suggestion generation.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-11-response-serialization">Step 11: Response Serialization<a href="#step-11-response-serialization" class="hash-link" aria-label="Direct link to Step 11: Response Serialization" title="Direct link to Step 11: Response Serialization" translate="no">​</a></h3>
<p>gqlgen assembles the final JSON response:</p>
<div class="language-json codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-json codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;data&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;router&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;01JZABC123&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;HomeRouter&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;interfaces&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;errors&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;extensions&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p>For partial success (some fields errored, others succeeded): both <code>data</code> and <code>errors</code> are populated.
GraphQL clients must handle this case.</p>
<p>For complete failure (auth error, parse error): <code>data</code> is <code>null</code>, <code>errors</code> array is non-empty.</p>
<p>The HTTP status code is always <code>200 OK</code> for valid GraphQL responses, even when the <code>errors</code> array is
non-empty. HTTP 4xx/5xx are only returned for transport-level failures (malformed JSON body,
connection errors).</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="subscription-lifecycle-websocket">Subscription Lifecycle (WebSocket)<a href="#subscription-lifecycle-websocket" class="hash-link" aria-label="Direct link to Subscription Lifecycle (WebSocket)" title="Direct link to Subscription Lifecycle (WebSocket)" translate="no">​</a></h2>
<p>Subscriptions diverge from queries/mutations after Step 2 (middleware):</p>
<!-- -->
<p>Auth middleware applies identically on the WebSocket upgrade request. The subscription resolver
creates a channel, subscribes to the appropriate event bus topic, and streams events until the
client disconnects or sends <code>complete</code>.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="full-timing-breakdown">Full Timing Breakdown<a href="#full-timing-breakdown" class="hash-link" aria-label="Direct link to Full Timing Breakdown" title="Direct link to Full Timing Breakdown" translate="no">​</a></h2>
<table><thead><tr><th>Phase</th><th>Typical Duration</th></tr></thead><tbody><tr><td>TCP + Echo routing</td><td><code>&lt;1ms</code></td></tr><tr><td>Request ID generation (ULID)</td><td><code>&lt;0.1ms</code></td></tr><tr><td>JWT validation</td><td>1–3ms</td></tr><tr><td>GraphQL parse + validate</td><td>1–5ms</td></tr><tr><td>Directive evaluation</td><td><code>&lt;1ms</code> per field</td></tr><tr><td>DataLoader scheduling (tick)</td><td>~1ms wait</td></tr><tr><td>DataLoader batch DB query</td><td>1–10ms</td></tr><tr><td>Resolver logic</td><td><code>&lt;1ms</code></td></tr><tr><td>Router command (REST)</td><td>10–50ms</td></tr><tr><td>Router command (SSH)</td><td>50–200ms</td></tr><tr><td>Response serialization</td><td><code>&lt;1ms</code></td></tr><tr><td><strong>Total (REST path)</strong></td><td><strong>~20–70ms</strong></td></tr><tr><td><strong>Total (SSH path)</strong></td><td><strong>~60–220ms</strong></td></tr></tbody></table>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="cross-references">Cross-References<a href="#cross-references" class="hash-link" aria-label="Direct link to Cross-References" title="Direct link to Cross-References" translate="no">​</a></h2>
<ul>
<li class="">[See: 03-graphql-api.md §Resolvers] — resolver structure, generated files, schema-first
conventions</li>
<li class="">[See: 03-graphql-api.md §Mutations] — mutation resolver patterns, changeset flow</li>
<li class="">[See: 04-router-communication.md §FallbackChain] — protocol selection, circuit breaker state
machine</li>
<li class="">[See: 12-security.md §JWT Authentication] — token structure, claims, signing algorithm</li>
<li class="">[See: 14-error-handling.md] — error code taxonomy, redaction, suggestions</li>
<li class="">[See: 15-connection-management.md] — connection pool, per-router lifecycle, reconnection</li>
<li class="">[See: 16-translator-layer.md] — field mapping, type coercion, response translation</li>
<li class="">[See: 17-validation-pipeline.md] — @validate directive constraints and error format</li>
<li class="">[See: 05-event-system.md] — event bus topics consumed by subscription resolvers</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_HJkF"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/flows/graphql-request-lifecycle.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UohW" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_g62E"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/backend/flows/device-routing-chain-flow"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Flow: Device Routing Chain</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/backend/flows/router-connection-flow"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Flow: Router Connection Establishment</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_TN1Q thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#high-level-sequence-diagram" class="table-of-contents__link toc-highlight">High-Level Sequence Diagram</a></li><li><a href="#step-by-step-walkthrough" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a><ul><li><a href="#step-1-tcp-arrival-and-echo-routing" class="table-of-contents__link toc-highlight">Step 1: TCP Arrival and Echo Routing</a></li><li><a href="#step-2-middleware-stack" class="table-of-contents__link toc-highlight">Step 2: Middleware Stack</a></li><li><a href="#step-3-graphql-handler-entry" class="table-of-contents__link toc-highlight">Step 3: GraphQL Handler Entry</a></li><li><a href="#step-4-dataloader-initialization-per-request" class="table-of-contents__link toc-highlight">Step 4: DataLoader Initialization (Per-Request)</a></li><li><a href="#step-5-custom-directive-evaluation" class="table-of-contents__link toc-highlight">Step 5: Custom Directive Evaluation</a></li><li><a href="#step-6-resolver-execution" class="table-of-contents__link toc-highlight">Step 6: Resolver Execution</a></li><li><a href="#step-7-router-command-translation" class="table-of-contents__link toc-highlight">Step 7: Router Command Translation</a></li><li><a href="#step-8-routeros-command-execution-via-fallbackchain" class="table-of-contents__link toc-highlight">Step 8: RouterOS Command Execution via FallbackChain</a></li><li><a href="#step-9-response-translation" class="table-of-contents__link toc-highlight">Step 9: Response Translation</a></li><li><a href="#step-10-error-presentation" class="table-of-contents__link toc-highlight">Step 10: Error Presentation</a></li><li><a href="#step-11-response-serialization" class="table-of-contents__link toc-highlight">Step 11: Response Serialization</a></li></ul></li><li><a href="#subscription-lifecycle-websocket" class="table-of-contents__link toc-highlight">Subscription Lifecycle (WebSocket)</a></li><li><a href="#full-timing-breakdown" class="table-of-contents__link toc-highlight">Full Timing Breakdown</a></li><li><a href="#cross-references" class="table-of-contents__link toc-highlight">Cross-References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apps</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/frontend/intro">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/backend/intro">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Libraries</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/ui/intro">UI Components</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/intro">Feature Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api-client/intro">API Client</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/state/intro">State Management</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/core/intro">Core Types</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">API</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/api">Schema Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/category/queries">Queries</a></li><li class="footer__item"><a class="footer__link-item" href="/category/mutations">Mutations</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/primitives/">Storybook (Primitives)</a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/patterns/">Storybook (Patterns)</a></li><li class="footer__item"><a class="footer__link-item" href="/nx-graph/">Nx Graph</a></li><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/Docs/architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">Architecture<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2026 NasNet · Built with Docusaurus</div></div></div></footer></div>
</body>
</html>