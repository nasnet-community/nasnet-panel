<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-features docs-version-current docs-doc-page docs-doc-id-cross-cutting-flows" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Cross-Cutting Flows | NasNet Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nasnet.dev/docs/features/cross-cutting-flows"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-features-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-features-current"><meta data-rh="true" property="og:title" content="Cross-Cutting Flows | NasNet Docs"><meta data-rh="true" name="description" content="This document traces six end-to-end flows that span multiple packages. Each flow shows how data moves from user interaction through frontend state, API client, GraphQL schema, and into the backend."><meta data-rh="true" property="og:description" content="This document traces six end-to-end flows that span multiple packages. Each flow shows how data moves from user interaction through frontend state, API client, GraphQL schema, and into the backend."><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://nasnet.dev/docs/features/cross-cutting-flows"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/features/cross-cutting-flows" hreflang="en"><link data-rh="true" rel="alternate" href="https://nasnet.dev/docs/features/cross-cutting-flows" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Cross-Cutting Flows","item":"https://nasnet.dev/docs/features/cross-cutting-flows"}]}</script><link rel="stylesheet" href="/assets/css/styles.82d9e831.css">
<script src="/assets/js/runtime~main.ca82720f.js" defer="defer"></script>
<script src="/assets/js/main.ffff147f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_G6ar" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--light_DIHH" style="border-radius:6px"><img src="/img/hero-logo.jpg" alt="NasNet Logo" class="themedComponent_DHUr themedComponent--dark_Bv2M" style="border-radius:6px"></div><b class="navbar__title text--truncate">NasNet Docs</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/frontend/intro">Frontend (Connect)</a></li><li><a class="dropdown__link" href="/docs/backend/intro">Backend (Go)</a></li><li><a class="dropdown__link" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Libraries</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/ui/intro">UI Components</a></li><li><a class="dropdown__link" href="/docs/features/intro">Feature Modules</a></li><li><a class="dropdown__link" href="/docs/api-client/intro">API Client</a></li><li><a class="dropdown__link" href="/docs/state/intro">State Management</a></li><li><a class="dropdown__link" href="/docs/core/intro">Core Types</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Components</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/storybook/primitives/">UI Primitives</a></li><li><a class="dropdown__link" href="/storybook/patterns/">UI Patterns</a></li><li><a class="dropdown__link" href="/storybook/connect/">Connect App</a></li></ul></div><a class="navbar__item navbar__link" href="/api">API Reference</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/nasnet-community/nasnet-panel/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Changelog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><a class="navbar__item navbar__link" href="/nx-graph/">Nx Graph</a><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" aria-label="GitHub repository">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_OLSw colorModeToggle_Hg9V"><button class="clean-btn toggleButton_wYmb toggleButtonDisabled_vaDU" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ lightToggleIcon_Sxwe"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ darkToggleIcon_Yem1"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_KEbZ systemToggleIcon_txm5"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_bmvg"><div class="navbar__search searchBarContainer_YZIh" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_eCKk" value=""><div class="loadingRing_pJhT searchBarLoadingRing_NsvA"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_UyTV"><div class="docsWrapper_XLvK"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_z1FD" type="button"></button><div class="docRoot_HciC"><aside class="theme-doc-sidebar-container docSidebarContainer_e5ai"><div class="sidebarViewport_N8x0"><div class="sidebar_vJCc"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_qiME"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/intro"><span title="Introduction" class="linkLabel_PuAu">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/api-client-and-graphql"><span title="API Client and GraphQL" class="linkLabel_PuAu">API Client and GraphQL</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/architecture-overview"><span title="Architecture Overview" class="linkLabel_PuAu">Architecture Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/features/cross-cutting-flows"><span title="Cross-Cutting Flows" class="linkLabel_PuAu">Cross-Cutting Flows</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/error-handling"><span title="Error Handling Architecture" class="linkLabel_PuAu">Error Handling Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-alerts"><span title="Feature Module: Alerts (libs/features/alerts)" class="linkLabel_PuAu">Feature Module: Alerts (libs/features/alerts)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-dashboard"><span title="Feature: Dashboard (libs/features/dashboard)" class="linkLabel_PuAu">Feature: Dashboard (libs/features/dashboard)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-diagnostics"><span title="Feature: Diagnostics (libs/features/diagnostics)" class="linkLabel_PuAu">Feature: Diagnostics (libs/features/diagnostics)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-firewall"><span title="Feature Module: Firewall (libs/features/firewall)" class="linkLabel_PuAu">Feature Module: Firewall (libs/features/firewall)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-logs"><span title="Feature: Logs (libs/features/logs)" class="linkLabel_PuAu">Feature: Logs (libs/features/logs)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-minor"><span title="Feature: Wireless, Router Discovery, and Configuration Import" class="linkLabel_PuAu">Feature: Wireless, Router Discovery, and Configuration Import</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-network"><span title="Feature: Network (libs/features/network)" class="linkLabel_PuAu">Feature: Network (libs/features/network)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-services"><span title="Feature Services Module (libs/features/services)" class="linkLabel_PuAu">Feature Services Module (libs/features/services)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/feature-vpn"><span title="VPN Feature Module Documentation" class="linkLabel_PuAu">VPN Feature Module Documentation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/"><span title="Feature Library Documentation" class="linkLabel_PuAu">Feature Library Documentation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/routing-and-navigation"><span title="Routing and Navigation Architecture" class="linkLabel_PuAu">Routing and Navigation Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/state-management"><span title="State Management Guide" class="linkLabel_PuAu">State Management Guide</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/testing-and-storybook"><span title="Testing and Storybook" class="linkLabel_PuAu">Testing and Storybook</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/features/xstate-machines"><span title="XState Machines Reference" class="linkLabel_PuAu">XState Machines Reference</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_namt"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_YAwJ"><div class="docItemContainer_Rv5Z"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_zCmv" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JFrk"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Cross-Cutting Flows</span></li></ul></nav><div class="tocCollapsible_O_Qc theme-doc-toc-mobile tocMobile_tjDr"><button type="button" class="clean-btn tocCollapsibleButton_htYj">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Cross-Cutting Flows</h1></header>
<p>This document traces six end-to-end flows that span multiple packages. Each flow shows how data moves from user interaction through frontend state, API client, GraphQL schema, and into the backend.</p>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents" translate="no">​</a></h2>
<ol>
<li class=""><a href="#1-apply-confirm-merge-pipeline" class="">Apply-Confirm-Merge Pipeline</a></li>
<li class=""><a href="#2-firewall-template-safety-pipeline" class="">Firewall Template Safety Pipeline</a></li>
<li class=""><a href="#3-service-install-flow" class="">Service Install Flow</a></li>
<li class=""><a href="#4-diagnostics-troubleshoot-wizard" class="">Diagnostics Troubleshoot Wizard</a></li>
<li class=""><a href="#5-alert-notification-dispatch-chain" class="">Alert Notification Dispatch Chain</a></li>
<li class=""><a href="#6-vif-pattern-for-service-isolation" class="">VIF Pattern for Service Isolation</a></li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="1-apply-confirm-merge-pipeline">1. Apply-Confirm-Merge Pipeline<a href="#1-apply-confirm-merge-pipeline" class="hash-link" aria-label="Direct link to 1. Apply-Confirm-Merge Pipeline" title="Direct link to 1. Apply-Confirm-Merge Pipeline" translate="no">​</a></h2>
<p>The Apply-Confirm-Merge pipeline is the core safety mechanism for all configuration changes. It prevents accidental network lockouts by requiring explicit validation, preview, and (for high-risk operations) acknowledgment before any change reaches the router.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">User edits form</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> [change-set.store]  ─── Zustand, persisted to sessionStorage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> [configPipelineMachine]  ─── XState FSM (12 states)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ├─ draft → validating → invalid (show errors)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │                    └─ previewing → confirming (high-risk)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │                                 └─ applying → verifying → active</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │                                                         └─ rollback → rolled_back</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       └─ error (manual intervention)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> [useChangeSetMutations]  ─── @nasnet/api-client/queries</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> schema/changeset/  ─── GraphQL change set operations</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ▼</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> apps/backend/graph/resolver/changeset-operations.resolvers.go</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="package-chain">Package Chain<a href="#package-chain" class="hash-link" aria-label="Direct link to Package Chain" title="Direct link to Package Chain" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">libs/features/*/components</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → libs/state/stores/src/change-set/change-set.store.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → libs/state/machines/src/configPipelineMachine.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → libs/api-client/queries/src/change-set/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        → schema/changeset/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          → apps/backend/graph/resolver/changeset-*.resolvers.go</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h3>
<p><strong>Step 1: User Edits a Form</strong></p>
<p>The user changes a field in a configuration form (e.g., WireGuard MTU, DHCP lease time). The form uses React Hook Form + Zod and calls into the feature-level hook:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// In a feature component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> createChangeSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> addItem </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useChangeSetStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> changeSetId </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">createChangeSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Update WireGuard Config&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  routerId</span><span class="token operator">:</span><span class="token plain"> currentRouterId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  source</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;wireguard-form&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">addItem</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">changeSetId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;WireGuard Interface&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  resourceType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;vpn.wireguard&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  operation</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;UPDATE&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  configuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> mtu</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1420</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> privateKey</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;...&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dependencies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p>The store is persisted to <code>localStorage</code> under the key <code>nasnet-change-sets</code> (only DRAFT and READY status change sets survive page refresh).</p>
<p><strong>Step 2: Machine Start</strong></p>
<p>The config pipeline machine is instantiated per resource type via <code>createConfigPipelineMachine&lt;TConfig&gt;</code>:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// libs/state/machines/src/configPipelineMachine.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> machine </span><span class="token operator">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:rgb(80, 250, 123)">createConfigPipelineMachine</span><span class="token generic-function generic class-name operator">&lt;</span><span class="token generic-function generic class-name maybe-class-name">WireGuardConfig</span><span class="token generic-function generic class-name operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">runValidationPipeline</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> errors </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">validateWireGuardConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> diff </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">computeConfigDiff</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> errors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> diff </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">applyConfig</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> config </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> backup </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">getBackup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">applyWireGuardConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> rollbackData</span><span class="token operator">:</span><span class="token plain"> backup </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">verifyApplied</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> status </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">checkWireGuardStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resourceId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">running</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name known-class-name class-name">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;WireGuard failed to start&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">executeRollback</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rollbackData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">restoreWireGuardConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">rollbackData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onSuccess</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">showSuccess</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Configuration applied&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onRollback</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">showWarning</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Configuration rolled back&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p><strong>Step 3: 12-State Validation Pipeline</strong></p>
<p>The machine transitions through states automatically:</p>
<table><thead><tr><th>State</th><th>Description</th><th>Transitions Out</th></tr></thead><tbody><tr><td><code>idle</code></td><td>Waiting for edit</td><td><code>EDIT</code> → <code>draft</code></td></tr><tr><td><code>draft</code></td><td>Editing in progress</td><td><code>VALIDATE</code> → <code>validating</code>, <code>CANCEL</code> → <code>idle</code></td></tr><tr><td><code>validating</code></td><td>Running 7-stage pipeline</td><td>onDone → <code>invalid</code> or <code>previewing</code></td></tr><tr><td><code>invalid</code></td><td>Validation errors shown</td><td><code>EDIT</code> → <code>draft</code></td></tr><tr><td><code>previewing</code></td><td>Diff shown to user</td><td><code>CONFIRM</code> → <code>confirming</code> (high-risk) or <code>applying</code> (normal)</td></tr><tr><td><code>confirming</code></td><td>User acknowledges risk</td><td><code>ACKNOWLEDGED</code> → <code>applying</code>, <code>CANCEL</code> → <code>previewing</code></td></tr><tr><td><code>applying</code></td><td>Mutation sent to backend</td><td>onDone → <code>verifying</code>, onError → <code>error</code></td></tr><tr><td><code>verifying</code></td><td>Backend confirms change</td><td>onDone → <code>active</code>, onError → <code>rollback</code></td></tr><tr><td><code>active</code></td><td>Success (final)</td><td>—</td></tr><tr><td><code>rollback</code></td><td>Executing rollback</td><td>onDone → <code>rolled_back</code>, onError → <code>error</code></td></tr><tr><td><code>rolled_back</code></td><td>Rollback complete (final)</td><td>—</td></tr><tr><td><code>error</code></td><td>Unrecoverable</td><td><code>RETRY</code> → <code>validating</code>, <code>FORCE_ROLLBACK</code> → <code>rollback</code>, <code>RESET</code> → <code>idle</code></td></tr></tbody></table>
<p><strong>Step 4: Drift Detection</strong></p>
<p>After <code>verifying</code>, drift detection runs via <code>useApplyConfirmDrift</code> and <code>useDriftDetection</code> from <code>libs/state/stores/src/drift-detection/</code>. If the confirmed state diverges from the router&#x27;s actual state, a drift warning appears and the reconciliation scheduler re-queues the operation.</p>
<p><strong>Step 5: GraphQL Mutation</strong></p>
<p>The <code>useChangeSetMutations</code> hook sends the atomic change set to the backend:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// libs/api-client/queries/src/change-set/useChangeSetMutations.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> applyChangeSet </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useChangeSetMutations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">applyChangeSet</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> changeSetId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerId </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p><strong>Step 6: Backend Processing</strong></p>
<p><code>apps/backend/graph/resolver/changeset-operations.resolvers.go</code> orchestrates:</p>
<ol>
<li class="">Deserializes the change set items</li>
<li class="">Resolves dependency order (topological sort)</li>
<li class="">Applies items sequentially</li>
<li class="">Records rollback plan per item</li>
<li class="">Returns apply result with confirmed states</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="error-handling-and-rollback">Error Handling and Rollback<a href="#error-handling-and-rollback" class="hash-link" aria-label="Direct link to Error Handling and Rollback" title="Direct link to Error Handling and Rollback" translate="no">​</a></h3>
<p>If <code>verifyApplied</code> throws, the machine automatically transitions to <code>rollback</code> and calls <code>executeRollback</code> with the saved <code>rollbackData</code>. The <code>rollbackData</code> is captured in <code>setRollbackData</code> action immediately after <code>applying</code> succeeds (before <code>verifying</code>).</p>
<p>If the user manually triggers <code>FORCE_ROLLBACK</code> from <code>error</code> state, the guard <code>hasRollbackData</code> must pass.</p>
<p>Utility helpers:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token imports"> isPipelineProcessing</span><span class="token imports punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token imports"> isPipelineCancellable</span><span class="token imports punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token imports"> getPipelineStateDescription </span><span class="token imports punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;@nasnet/state/machines&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">isPipelineProcessing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">showSpinner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token function" style="color:rgb(80, 250, 123)">isPipelineCancellable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">showCancelButton</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="2-firewall-template-safety-pipeline">2. Firewall Template Safety Pipeline<a href="#2-firewall-template-safety-pipeline" class="hash-link" aria-label="Direct link to 2. Firewall Template Safety Pipeline" title="Direct link to 2. Firewall Template Safety Pipeline" translate="no">​</a></h2>
<p>Firewall templates are pre-built rule sets that can be applied to a router&#x27;s firewall in bulk. The safety pipeline ensures the user reviews and can undo the change.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview-1">Overview<a href="#overview-1" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">TemplatesPage  →  TemplateApplyFlow  →  templateApplyMachine</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                                        │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                              ┌─────────┴────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                              │ 7 validation stages  │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                              └─────  ─────┬───────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                                         │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                              GraphQL mutation (applyTemplate)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                                         │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                              10-second undo window</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │                              (UNDO event → rollback)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      └─ subscription → onTemplateApplied → refresh rules</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="package-chain-1">Package Chain<a href="#package-chain-1" class="hash-link" aria-label="Direct link to Package Chain" title="Direct link to Package Chain" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">libs/features/firewall/src/pages/TemplatesPage.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → libs/features/firewall/src/components/TemplateApplyFlow.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → libs/state/machines (createTemplateApplyMachine variant)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → libs/api-client/queries/src/firewall/templates.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        → schema/firewall/firewall-address-template-mutations.graphql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          → apps/backend/graph/resolver/firewall-address-template-mutations.resolvers.go</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough-1">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough-1" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h3>
<p><strong>Step 1: Template Browse</strong></p>
<p><code>TemplatesPage.tsx</code> renders the templates catalog. Users can filter by category (Security, Monitoring, etc.) and preview template details via <code>TemplateDetailPanel</code>.</p>
<p><strong>Step 2: Apply Initiation</strong></p>
<p><code>TemplateApplyFlow.tsx</code> is mounted when the user clicks &quot;Apply&quot;. It accepts:</p>
<ul>
<li class=""><code>templateId</code> - the template to apply</li>
<li class=""><code>routerId</code> - target router</li>
<li class=""><code>onSuccess</code> / <code>onCancel</code> callbacks</li>
</ul>
<p><strong>Step 3: Validation</strong></p>
<p>The underlying machine runs 7 validation stages before allowing apply:</p>
<ol>
<li class="">Syntax validation (rule format)</li>
<li class="">Conflict detection (duplicate rules)</li>
<li class="">Dependency checks (required interfaces exist)</li>
<li class="">Platform capability check (router supports required features)</li>
<li class="">Security analysis (no overly permissive rules)</li>
<li class="">IP address sanity check</li>
<li class="">Final summary</li>
</ol>
<p><strong>Step 4: Apply Mutation</strong></p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// libs/api-client/queries/src/firewall/templates.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> applyTemplate </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useFirewallTemplates</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">applyTemplate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> templateId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> routerId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> dryRun</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p><strong>Step 5: 10-Second Undo Window</strong></p>
<p>After successful apply, the machine enters a <code>pendingUndo</code> state with a 10-second countdown. The <code>UndoFloatingButton.tsx</code> component renders a floating action button showing the remaining time. If the user clicks Undo:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">UNDO event → machine transitions to undoing state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           → sends rollback mutation (removeAppliedRules)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           → on success: machine returns to idle</span><br></span></code></pre></div></div>
<p>If no undo is triggered within 10 seconds, the machine moves to <code>committed</code> (final state).</p>
<p><strong>Step 6: Rules Refresh</strong></p>
<p>On <code>committed</code>, <code>refetchQueries</code> for filter rules, mangle rules, NAT rules, and raw rules is triggered to reflect the new state.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="error-handling">Error Handling<a href="#error-handling" class="hash-link" aria-label="Direct link to Error Handling" title="Direct link to Error Handling" translate="no">​</a></h3>
<p>If the <code>apply</code> mutation fails:</p>
<ul>
<li class="">Machine moves to <code>applyError</code> state</li>
<li class="">Error message is shown with a &quot;Try Again&quot; option</li>
<li class="">No partial rollback is needed since firewall rule creation is atomic per template</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="3-service-install-flow">3. Service Install Flow<a href="#3-service-install-flow" class="hash-link" aria-label="Direct link to 3. Service Install Flow" title="Direct link to 3. Service Install Flow" translate="no">​</a></h2>
<p>Installing a network service (Tor, sing-box, Xray-core, etc.) from the feature marketplace involves browsing, configuration, installation, and real-time progress tracking.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview-2">Overview<a href="#overview-2" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ServicesPage (browse)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TemplateBrowser → service selection</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ServiceDetailPage → install button</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">useInstanceMutations.installService</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">GraphQL: installService mutation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Backend: provisioning orchestrator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WebSocket subscription: onInstallProgress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Frontend: progress UI update</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">On success: navigate to ServiceDetailPage</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="package-chain-2">Package Chain<a href="#package-chain-2" class="hash-link" aria-label="Direct link to Package Chain" title="Direct link to Package Chain" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">libs/features/services/src/pages/ServicesPage.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → libs/features/services/src/components/templates/TemplateFilters.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → libs/api-client/queries/src/services/useAvailableServices.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → schema/services/services-templates-ops.graphql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">libs/features/services/src/pages/ServiceDetailPage.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → libs/api-client/queries/src/services/useInstanceMutations.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → schema/services/services-types.graphql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → apps/backend/graph/resolver/services-crud-ops.resolvers.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        → apps/backend/internal/orchestrator/lifecycle/lifecycle_installer.go</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough-2">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough-2" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h3>
<p><strong>Step 1: Browsing Available Services</strong></p>
<p><code>ServicesPage.tsx</code> fetches available services:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> loading </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useAvailableServices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> routerId </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p>The query returns services from the feature registry, filtered by router capability (e.g., container support required).</p>
<p><strong>Step 2: Template Filtering and Selection</strong></p>
<p><code>TemplateFilters.tsx</code> provides category, search, and compatibility filters. The service list is organized by category (VPN, Privacy, Monitoring, etc.).</p>
<p><strong>Step 3: Configuration</strong></p>
<p><code>ServiceDetailPage.tsx</code> presents a dynamic configuration form driven by the service&#x27;s JSON schema. The <code>ServiceConfigForm</code> component renders the appropriate fields using <code>DynamicField</code> components (TextField, NumberField, PasswordField, Select, MultiSelect, ArrayField).</p>
<p><strong>Step 4: Install Mutation</strong></p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> installService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> loading </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useInstanceMutations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">installService</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  serviceId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;tor&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  routerId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  configuration</span><span class="token operator">:</span><span class="token plain"> formValues</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  storageConfig</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/usb/tor&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p><strong>Step 5: Progress Tracking via Subscription</strong></p>
<p>Installation is asynchronous on the backend. The frontend subscribes to install progress events:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">useResourceStateSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">instanceUuid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onStateChange</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">newState</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;RUNNING&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">setInstalled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p>The backend sends state transitions: <code>PENDING</code> → <code>DOWNLOADING</code> → <code>INSTALLING</code> → <code>CONFIGURING</code> → <code>RUNNING</code>.</p>
<p><strong>Step 6: Navigation on Success</strong></p>
<p>On <code>RUNNING</code> state, the user is navigated to the service&#x27;s detail page where they can configure, start/stop/restart, view logs, and monitor resources.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="dependency-resolution">Dependency Resolution<a href="#dependency-resolution" class="hash-link" aria-label="Direct link to Dependency Resolution" title="Direct link to Dependency Resolution" translate="no">​</a></h3>
<p>Before install, <code>useDependencies</code> checks if required services are running (e.g., sing-box depends on certain kernel modules). If dependencies are missing, <code>StopDependentsDialog</code> may be shown.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="error-handling-1">Error Handling<a href="#error-handling-1" class="hash-link" aria-label="Direct link to Error Handling" title="Direct link to Error Handling" translate="no">​</a></h3>
<p>If install fails, the backend automatically rolls back:</p>
<ol>
<li class="">Removes downloaded binaries</li>
<li class="">Removes created virtual interfaces</li>
<li class="">Removes allocated VLANs</li>
<li class="">Returns <code>FAILED</code> state with error message</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="4-diagnostics-troubleshoot-wizard">4. Diagnostics Troubleshoot Wizard<a href="#4-diagnostics-troubleshoot-wizard" class="hash-link" aria-label="Direct link to 4. Diagnostics Troubleshoot Wizard" title="Direct link to 4. Diagnostics Troubleshoot Wizard" translate="no">​</a></h2>
<p>The Troubleshoot Wizard guides users through diagnosing &quot;No Internet&quot; connectivity problems. It runs five sequential diagnostic steps, collects results, identifies issues, and suggests fixes.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview-3">Overview<a href="#overview-3" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">TroubleshootWizard (root)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ├── [mobile] TroubleshootWizardMobile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      └── [desktop] TroubleshootWizardDesktop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         useTroubleshootWizard hook</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         createTroubleshootMachine (XState)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         diagnostic-executor → GraphQL mutations</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         fix-registry → fix-applicator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         verify after fix</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="package-chain-3">Package Chain<a href="#package-chain-3" class="hash-link" aria-label="Direct link to Package Chain" title="Direct link to Package Chain" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">libs/features/diagnostics/src/components/TroubleshootWizard/TroubleshootWizard.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → libs/features/diagnostics/src/components/TroubleshootWizard/TroubleshootWizardDesktop.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → libs/features/diagnostics/src/components/TroubleshootWizard/TroubleshootWizardMobile.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → libs/features/diagnostics/src/hooks/useTroubleshootWizard.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → libs/features/diagnostics/src/services/diagnostic-executor.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        → libs/api-client/core (apolloClient.mutate)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          → schema/diagnostics/diagnostics-troubleshoot-ops.graphql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            → apps/backend/graph/resolver/diagnostics-troubleshoot-ops.resolvers.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              → apps/backend/internal/troubleshoot/service.go</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough-3">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough-3" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h3>
<p><strong>Step 1: Wizard Entry</strong></p>
<p><code>TroubleshootWizard</code> auto-detects platform and renders the appropriate presenter. It accepts:</p>
<ul>
<li class=""><code>routerId</code> - the router to diagnose</li>
<li class=""><code>autoStart</code> - skip idle screen and begin immediately</li>
<li class=""><code>ispInfo</code> - optional ISP contact details for ISP-related failures</li>
<li class=""><code>onClose</code> - close callback</li>
</ul>
<p><strong>Step 2: Machine Start</strong></p>
<p><code>createTroubleshootMachine</code> creates an XState machine that orchestrates the five diagnostic steps in sequence:</p>
<ol>
<li class=""><strong>WAN</strong> - Is the WAN interface up and getting a DHCP lease?</li>
<li class=""><strong>Gateway</strong> - Can the router ping the default gateway?</li>
<li class=""><strong>Internet</strong> - Can the router reach the internet (ping 8.8.8.8)?</li>
<li class=""><strong>DNS</strong> - Is DNS resolution working?</li>
<li class=""><strong>NAT</strong> - Is NAT/masquerade configured correctly?</li>
</ol>
<p><strong>Step 3: Diagnostic Execution</strong></p>
<p><code>diagnostic-executor.ts</code> translates step IDs to <code>TroubleshootStepType</code> enum values and calls the backend:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// libs/features/diagnostics/src/services/diagnostic-executor.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">executeDiagnosticStep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  stepId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  routerId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  sessionId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator">&lt;</span><span class="token maybe-class-name">StepResult</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> stepType </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">STEP_ID_TO_TYPE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">stepId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// &#x27;wan&#x27; → TroubleshootStepType.WAN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> data </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> apolloClient</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">mutate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    mutation</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">RUN_TROUBLESHOOT_STEP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    variables</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> input</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> routerId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> sessionId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> stepType </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">runTroubleshootStep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">step</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<p><strong>Step 4: DiagnosticStep UI</strong></p>
<p>Each step is displayed via <code>DiagnosticStep.tsx</code> with status (pending, running, success, failure) and the result message and timing.</p>
<p><strong>Step 5: Fix Registry and Application</strong></p>
<p>When a step fails, <code>fix-registry</code> maps the <code>issueCode</code> to available fixes:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">issueCode: &#x27;WAN_DHCP_FAILED&#x27;  →  fix: &#x27;Release and renew DHCP lease&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">issueCode: &#x27;DNS_TIMEOUT&#x27;      →  fix: &#x27;Use backup DNS servers (8.8.8.8, 1.1.1.1)&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">issueCode: &#x27;NAT_MISSING&#x27;      →  fix: &#x27;Add masquerade rule on WAN interface&#x27;</span><br></span></code></pre></div></div>
<p><code>fix-applicator.ts</code> applies the fix using GraphQL mutations (DHCP release, DNS config change, firewall rule add), then re-runs the failed step to verify.</p>
<p><strong>Step 6: WizardSummary</strong></p>
<p>When all steps are complete (or no more fixes are available), <code>WizardSummary.tsx</code> shows:</p>
<ul>
<li class="">Overall pass/fail</li>
<li class="">Per-step results</li>
<li class="">Fix suggestions for remaining failures</li>
<li class="">ISP contact info if the failure is external (e.g., ISP outage)</li>
</ul>
<p><code>StepAnnouncer.tsx</code> provides ARIA live region announcements for each step transition, ensuring screen reader accessibility during the automated diagnostic sequence.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="error-handling-2">Error Handling<a href="#error-handling-2" class="hash-link" aria-label="Direct link to Error Handling" title="Direct link to Error Handling" translate="no">​</a></h3>
<p><code>diagnostic-executor.ts</code> handles three error types:</p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Unknown step ID - returns actionable error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">stepType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> success</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> message</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string string" style="color:rgb(255, 121, 198)">Unsupported diagnostic step. Supported: wan, gateway, internet, dns, nat</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Missing result - indicates backend overload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> success</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> message</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;No result received. The backend may be overloaded.&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Network error - returns error message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> success</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> message</span><span class="token operator">:</span><span class="token plain"> error </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name known-class-name class-name">Error</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">message</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Please check your router connection&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="5-alert-notification-dispatch-chain">5. Alert Notification Dispatch Chain<a href="#5-alert-notification-dispatch-chain" class="hash-link" aria-label="Direct link to 5. Alert Notification Dispatch Chain" title="Direct link to 5. Alert Notification Dispatch Chain" translate="no">​</a></h2>
<p>The alert notification system delivers real-time and queued notifications from backend alert rule evaluation through multiple delivery channels to the frontend.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview-4">Overview<a href="#overview-4" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Router metrics / events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">backend alert engine (engine.go + engine_evaluate.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">throttle queue (alert_queue.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">quiet hours filter (quiet_hours_queue.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">notification dispatcher (dispatcher.go + dispatcher_routing.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">┌──────┴──────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ channels:                                    │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - in-app (push/inapp.go)                   │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - email (http/email.go)                    │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - webhook (http/webhook.go)                │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - ntfy (push/ntfy.go)                      │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - pushover (push/pushover.go)              │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - telegram (push/telegram.go)              │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└──────┬──────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">GraphQL subscription (alerts-subscriptions-channel.graphql)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">frontend useResourceStateSubscription / useDigestQueueCount</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">alert-notification.store (Zustand)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AlertBadge component (QueuedAlertBadge shows count)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="package-chain-4">Package Chain<a href="#package-chain-4" class="hash-link" aria-label="Direct link to Package Chain" title="Direct link to Package Chain" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apps/backend/internal/alerts/engine.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → apps/backend/internal/alerts/engine_evaluate.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → apps/backend/internal/alerts/throttle/alert_queue.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → apps/backend/internal/alerts/throttle/quiet_hours_queue.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        → apps/backend/internal/notifications/dispatcher.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          → apps/backend/internal/notifications/channels/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            → apps/backend/graph/resolver/alerts-subscriptions-channel.resolvers.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              → GraphQL subscription event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                → libs/api-client/queries/src/alerts/useDigestQueueCount.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                  → libs/state/stores/src/alert-notification.store.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    → libs/features/alerts/src/components/AlertBadge.tsx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    → libs/features/alerts/src/components/QueuedAlertBadge.tsx</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough-4">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough-4" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h3>
<p><strong>Step 1: Alert Engine Evaluation</strong></p>
<p>The backend alert engine runs on a configurable schedule. For each active alert rule, it evaluates conditions against current router metrics or events.</p>
<p>The engine uses the bridge pattern (<code>alerts/bridge/bridge.go</code>) to receive metric updates from the monitoring subsystem without tight coupling.</p>
<p><strong>Step 2: Throttle and Storm Protection</strong></p>
<p><code>alert_queue.go</code> implements throttling to prevent alert floods:</p>
<ul>
<li class="">Each rule has a <code>cooldown</code> period (minimum interval between firings)</li>
<li class=""><code>quiet_hours_queue.go</code> checks the configured quiet hours schedule and timezone before dispatching</li>
<li class="">Alerts outside quiet hours are held and dispatched at the quiet period end, or dropped if <code>dropOnQuietHours</code> is set</li>
</ul>
<p><strong>Step 3: Notification Dispatch</strong></p>
<p><code>dispatcher.go</code> routes each alert to configured channels. <code>dispatcher_routing.go</code> handles channel selection based on rule configuration (severity, channel assignment).</p>
<p><strong>Step 4: In-App Notification</strong></p>
<p>The in-app channel (<code>push/inapp.go</code>) publishes the notification to the GraphQL subscription system. The backend GraphQL resolver broadcasts via WebSocket.</p>
<p><strong>Step 5: Frontend Subscription</strong></p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// Digest queue count (badge count)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> count </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useDigestQueueCount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> routerId </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Full digest history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> notifications </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useDigestHistory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> routerId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> limit</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">50</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre></div></div>
<p><code>alert-notification.store.ts</code> maintains the notification list with unread count, read state, and snooze functionality.</p>
<p><strong>Step 6: UI Components</strong></p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">AlertBadge      - shows colored badge with severity indicator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">QueuedAlertBadge - shows numeric count of queued (unread) alerts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AlertList       - expandable list of recent alerts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">AlertRuleForm   - create/edit alert rules</span><br></span></code></pre></div></div>
<p>The <code>InAppNotificationPreferences.tsx</code> component lets users configure:</p>
<ul>
<li class="">Which alert severities trigger in-app notifications</li>
<li class="">Notification sound preferences</li>
<li class="">Auto-dismiss timing</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="alert-rule-templates">Alert Rule Templates<a href="#alert-rule-templates" class="hash-link" aria-label="Direct link to Alert Rule Templates" title="Direct link to Alert Rule Templates" translate="no">​</a></h3>
<p>Alert rule templates (<code>alerts/useAlertRuleTemplates</code>) provide pre-built rule configurations (high CPU, low disk, VPN tunnel down, etc.) that users can customize and apply.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="6-vif-pattern-for-service-isolation">6. VIF Pattern for Service Isolation<a href="#6-vif-pattern-for-service-isolation" class="hash-link" aria-label="Direct link to 6. VIF Pattern for Service Isolation" title="Direct link to 6. VIF Pattern for Service Isolation" translate="no">​</a></h2>
<p>Virtual Interface (VIF) is the core network isolation mechanism that gives each installed service its own private network namespace within the MikroTik router. This prevents services from interfering with each other or with the router&#x27;s main routing table.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="overview-5">Overview<a href="#overview-5" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Service install request</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">VIF factory (vif/interface_factory.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">┌──────┴──────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│ Creates:                                     │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - Virtual bridge interface                 │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - VLAN allocation (vlan_allocator.go)       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - Gateway configuration (gateway_config.go) │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│  - Virtual interface entry in DB            │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└──────┬──────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Kill Switch Coordinator</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(vif/isolation/kill_switch_coordinator.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Bridge membership management</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(services/bridge/service.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">VLAN tag assignment</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Virtual interface persisted to ent schema (schema/virtualinterface.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">GraphQL: useVirtualInterfaces hook</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       │</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Frontend: VIF status display</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="package-chain-5">Package Chain<a href="#package-chain-5" class="hash-link" aria-label="Direct link to Package Chain" title="Direct link to Package Chain" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">apps/backend/internal/vif/interface_factory.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → apps/backend/internal/vif/bridge.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → apps/backend/internal/network/vlan_allocator.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → apps/backend/internal/adapters/ent_vlan_allocation_repo.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        → apps/backend/generated/ent/virtualinterface.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apps/backend/internal/vif/isolation/kill_switch_listener.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → apps/backend/internal/vif/isolation/kill_switch_coordinator.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">libs/api-client/queries/src/services/useVirtualInterfaces.ts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → schema/services/services-isolation.graphql</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → apps/backend/graph/resolver/services-isolation.resolvers.go</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="step-by-step-walkthrough-5">Step-by-Step Walkthrough<a href="#step-by-step-walkthrough-5" class="hash-link" aria-label="Direct link to Step-by-Step Walkthrough" title="Direct link to Step-by-Step Walkthrough" translate="no">​</a></h3>
<p><strong>Step 1: VIF Allocation</strong></p>
<p>When a service is installed, the VIF factory creates the virtual network topology:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interface_factory.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├── Allocate VLAN ID from pool (vlan_allocator.go)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├── Create bridge interface on router</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ├── Configure gateway IP for the bridge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  └── Persist VirtualInterface entity to database</span><br></span></code></pre></div></div>
<p>The VLAN allocator maintains a pool of available VLAN IDs (typically 100–4094) and assigns the next available one. VLAN IDs are persisted to the <code>ent</code> schema via <code>ent_vlan_allocation_repo.go</code>.</p>
<p><strong>Step 2: Gateway Configuration</strong></p>
<p><code>gateway_config.go</code> and <code>gateway_manager.go</code> manage the gateway IP address that the service will use as its default route:</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Service VIF subnet: 172.16.X.0/30 (per VLAN)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Gateway IP:         172.16.X.1 (router-side)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Service IP:         172.16.X.2 (service-side)</span><br></span></code></pre></div></div>
<p><strong>Step 3: Kill Switch</strong></p>
<p>The kill switch coordinator (<code>vif/isolation/kill_switch_coordinator.go</code>) monitors VPN tunnel state. When the upstream VPN tunnel goes down:</p>
<ol>
<li class=""><code>kill_switch_listener.go</code> detects the state change</li>
<li class="">Coordinator blocks all traffic through the service&#x27;s bridge</li>
<li class="">Service traffic stops immediately (kill switch active)</li>
<li class="">When VPN recovers, coordinator restores traffic flow</li>
</ol>
<p>This ensures services with VPN-dependency never leak traffic over unprotected connections.</p>
<p><strong>Step 4: Bridge Port Management</strong></p>
<p><code>services/bridge/service.go</code> handles port membership in the bridge:</p>
<ul>
<li class="">Adds service container ports to the bridge on start</li>
<li class="">Removes ports on stop</li>
<li class="">Manages VLAN tagging for traffic isolation</li>
<li class=""><code>vlans.go</code> ensures correct VLAN membership per service</li>
</ul>
<p><strong>Step 5: Chain Routing</strong></p>
<p><code>vif/routing/chain_router.go</code> manages multi-hop routing for service chains (e.g., traffic → WireGuard → Tor → internet):</p>
<div class="language-text codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-text codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vif/routing/chain_router.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  → chain_router_hops.go  (per-hop configuration)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    → chain_latency.go    (latency measurement per hop)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      → pbr_engine.go     (policy-based routing rules)</span><br></span></code></pre></div></div>
<p><strong>Step 6: Frontend VIF Status</strong></p>
<div class="language-typescript codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-typescript codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// libs/api-client/queries/src/services/useVirtualInterfaces.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> interfaces</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> loading </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">useVirtualInterfaces</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> serviceId </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Each interface includes:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// - vlanId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// - bridgeName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// - gatewayIp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// - status (active/inactive)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// - killSwitchActive (boolean)</span><br></span></code></pre></div></div>
<p>The <code>GatewayStatusCard.tsx</code> component displays real-time VIF health including gateway ping latency and kill switch state.</p>
<p><strong>Step 7: Traffic Statistics</strong></p>
<p><code>vif/traffic/aggregator.go</code> collects per-interface traffic statistics (bytes in/out, packets, drops). <code>vif/traffic/quota_enforcer.go</code> enforces configured data quotas by blocking traffic when the limit is reached.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="vif-schema">VIF Schema<a href="#vif-schema" class="hash-link" aria-label="Direct link to VIF Schema" title="Direct link to VIF Schema" translate="no">​</a></h3>
<p>The VIF is persisted in the <code>virtualinterface</code> ent entity:</p>
<div class="language-go codeBlockContainer_ZGJx theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_kX1v"><pre tabindex="0" class="prism-code language-go codeBlock_TAPP thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_AdAo"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// apps/backend/internal/ent-schema/schema/virtualinterface.go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// Fields: ID, ServiceID, VLANID, BridgeName, GatewayIP, Status, CreatedAt</span><br></span></code></pre></div></div>
<p>This maps to the GraphQL <code>VirtualInterface</code> type in <code>schema/services/services-isolation.graphql</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_SAay" id="isolation-verification">Isolation Verification<a href="#isolation-verification" class="hash-link" aria-label="Direct link to Isolation Verification" title="Direct link to Isolation Verification" translate="no">​</a></h3>
<p><code>apps/backend/internal/orchestrator/isolation/isolation_verifier.go</code> periodically verifies that isolation rules are correctly applied. If verification fails (e.g., bridge membership mismatch), it triggers automatic reapplication and emits an alert event.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_SAay" id="cross-references">Cross-References<a href="#cross-references" class="hash-link" aria-label="Direct link to Cross-References" title="Direct link to Cross-References" translate="no">​</a></h2>
<ul>
<li class="">API client details: <code>libs/features/docs/api-client-and-graphql.md</code></li>
<li class="">State management (Zustand stores, XState machines): <code>libs/features/docs/state-management.md</code></li>
<li class="">Backend architecture: <code>Docs/architecture/backend-architecture.md</code></li>
<li class="">Novel patterns (VIF, Safety Pipeline, etc.): <code>Docs/architecture/novel-pattern-designs.md</code></li>
<li class="">Universal State v2 resource model: <code>Docs/architecture/data-architecture.md</code></li>
<li class="">ADR-012 (Universal State v2): <code>Docs/architecture/adrs/012-universal-state-v2.md</code></li>
<li class="">ADR-017 (Three-Layer Component Architecture): <code>Docs/architecture/adrs/017-three-layer-component-architecture.md</code></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_HJkF"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/features/docs/cross-cutting-flows.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_UohW" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_g62E"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/features/architecture-overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Architecture Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/features/error-handling"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Error Handling Architecture</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_TN1Q thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#1-apply-confirm-merge-pipeline" class="table-of-contents__link toc-highlight">1. Apply-Confirm-Merge Pipeline</a><ul><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#package-chain" class="table-of-contents__link toc-highlight">Package Chain</a></li><li><a href="#step-by-step-walkthrough" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a></li><li><a href="#error-handling-and-rollback" class="table-of-contents__link toc-highlight">Error Handling and Rollback</a></li></ul></li><li><a href="#2-firewall-template-safety-pipeline" class="table-of-contents__link toc-highlight">2. Firewall Template Safety Pipeline</a><ul><li><a href="#overview-1" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#package-chain-1" class="table-of-contents__link toc-highlight">Package Chain</a></li><li><a href="#step-by-step-walkthrough-1" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a></li><li><a href="#error-handling" class="table-of-contents__link toc-highlight">Error Handling</a></li></ul></li><li><a href="#3-service-install-flow" class="table-of-contents__link toc-highlight">3. Service Install Flow</a><ul><li><a href="#overview-2" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#package-chain-2" class="table-of-contents__link toc-highlight">Package Chain</a></li><li><a href="#step-by-step-walkthrough-2" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a></li><li><a href="#dependency-resolution" class="table-of-contents__link toc-highlight">Dependency Resolution</a></li><li><a href="#error-handling-1" class="table-of-contents__link toc-highlight">Error Handling</a></li></ul></li><li><a href="#4-diagnostics-troubleshoot-wizard" class="table-of-contents__link toc-highlight">4. Diagnostics Troubleshoot Wizard</a><ul><li><a href="#overview-3" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#package-chain-3" class="table-of-contents__link toc-highlight">Package Chain</a></li><li><a href="#step-by-step-walkthrough-3" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a></li><li><a href="#error-handling-2" class="table-of-contents__link toc-highlight">Error Handling</a></li></ul></li><li><a href="#5-alert-notification-dispatch-chain" class="table-of-contents__link toc-highlight">5. Alert Notification Dispatch Chain</a><ul><li><a href="#overview-4" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#package-chain-4" class="table-of-contents__link toc-highlight">Package Chain</a></li><li><a href="#step-by-step-walkthrough-4" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a></li><li><a href="#alert-rule-templates" class="table-of-contents__link toc-highlight">Alert Rule Templates</a></li></ul></li><li><a href="#6-vif-pattern-for-service-isolation" class="table-of-contents__link toc-highlight">6. VIF Pattern for Service Isolation</a><ul><li><a href="#overview-5" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#package-chain-5" class="table-of-contents__link toc-highlight">Package Chain</a></li><li><a href="#step-by-step-walkthrough-5" class="table-of-contents__link toc-highlight">Step-by-Step Walkthrough</a></li><li><a href="#vif-schema" class="table-of-contents__link toc-highlight">VIF Schema</a></li><li><a href="#isolation-verification" class="table-of-contents__link toc-highlight">Isolation Verification</a></li></ul></li><li><a href="#cross-references" class="table-of-contents__link toc-highlight">Cross-References</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Apps</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/frontend/intro">Frontend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/backend/intro">Backend</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/testing/intro">E2E Testing</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Libraries</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/ui/intro">UI Components</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/intro">Feature Modules</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/api-client/intro">API Client</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/state/intro">State Management</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/core/intro">Core Types</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">API</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/api">Schema Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/category/queries">Queries</a></li><li class="footer__item"><a class="footer__link-item" href="/category/mutations">Mutations</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/primitives/">Storybook (Primitives)</a></li><li class="footer__item"><a class="footer__link-item" href="/storybook/patterns/">Storybook (Patterns)</a></li><li class="footer__item"><a class="footer__link-item" href="/nx-graph/">Nx Graph</a></li><li class="footer__item"><a href="https://github.com/nasnet-community/nasnet-panel/tree/main/Docs/architecture" target="_blank" rel="noopener noreferrer" class="footer__link-item">Architecture<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_awgD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2026 NasNet · Built with Docusaurus</div></div></div></footer></div>
</body>
</html>