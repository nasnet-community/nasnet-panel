"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[84243],{56248:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"guides/change-set-operations","title":"Change Set Operations: Atomic Multi-Resource Transactions","description":"Reference: ADR-012, FR-STM-013 | libs/core/types/src/resource/change-set.ts | libs/core/utils/src/graph/dependency-graph.ts","source":"@site/../../libs/core/docs/guides/change-set-operations.md","sourceDirName":"guides","slug":"/guides/change-set-operations","permalink":"/docs/core/guides/change-set-operations","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/core/docs/guides/change-set-operations.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Security Patterns","permalink":"/docs/core/guides/security-patterns"},"next":{"title":"Device Detection Pipeline Guide","permalink":"/docs/core/guides/device-detection-pipeline"}}');var l=t(31085),a=t(71184);const s={},i="Change Set Operations: Atomic Multi-Resource Transactions",o={},c=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Problem Statement",id:"problem-statement",level:2},{value:"Change Set Lifecycle",id:"change-set-lifecycle",level:2},{value:"Status Helpers",id:"status-helpers",level:3},{value:"Change Set Structure",id:"change-set-structure",level:2},{value:"Change Operations",id:"change-operations",level:3},{value:"Dependency Graph",id:"dependency-graph",level:2},{value:"Dependency Analysis Types",id:"dependency-analysis-types",level:3},{value:"Parallel Execution",id:"parallel-execution",level:2},{value:"Rollback Mechanism",id:"rollback-mechanism",level:2},{value:"Cycle Detection",id:"cycle-detection",level:2},{value:"Conflict Detection",id:"conflict-detection",level:2},{value:"Practical Examples",id:"practical-examples",level:2},{value:"Example 1: LAN Setup with Dependencies",id:"example-1-lan-setup-with-dependencies",level:3},{value:"Example 2: Update with Conflict Detection",id:"example-2-update-with-conflict-detection",level:3},{value:"Example 3: Monitor Progress",id:"example-3-monitor-progress",level:3},{value:"See Also",id:"see-also",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"change-set-operations-atomic-multi-resource-transactions",children:"Change Set Operations: Atomic Multi-Resource Transactions"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Reference:"})," ADR-012, FR-STM-013 | ",(0,l.jsx)(n.code,{children:"libs/core/types/src/resource/change-set.ts"})," | ",(0,l.jsx)(n.code,{children:"libs/core/utils/src/graph/dependency-graph.ts"})]}),"\n",(0,l.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#problem-statement",children:"Problem Statement"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#change-set-lifecycle",children:"Change Set Lifecycle"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#change-set-structure",children:"Change Set Structure"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#dependency-graph",children:"Dependency Graph"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#parallel-execution",children:"Parallel Execution"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#rollback-mechanism",children:"Rollback Mechanism"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#cycle-detection",children:"Cycle Detection"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#conflict-detection",children:"Conflict Detection"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#practical-examples",children:"Practical Examples"})}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"problem-statement",children:"Problem Statement"}),"\n",(0,l.jsx)(n.p,{children:"Creating a LAN network requires multiple coordinated operations:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Create bridge interface"}),"\n",(0,l.jsx)(n.li,{children:"Add physical ports to bridge"}),"\n",(0,l.jsx)(n.li,{children:"Create DHCP server on bridge"}),"\n",(0,l.jsx)(n.li,{children:"Create firewall rules for the bridge"}),"\n",(0,l.jsx)(n.li,{children:"Set up routing policies"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"If step 2 fails, we're left with a bridge that doesn't work. If step 4 fails after step 3, we have a DHCP server without firewall protection."}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Problem:"})," These operations depend on each other. We need:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"All or nothing"})," - Either all succeed or all rollback"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Correct order"})," - Dependencies run first"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Parallel where possible"})," - Steps 2, 3, 4 can run in parallel (all depend on 1)"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Automatic rollback"})," - If step 4 fails, undo steps 1-3 in reverse order"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Failure tracking"})," - Know exactly what failed and what was rolled back"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Solution:"})," Change sets provide atomic transactions for multi-resource operations."]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"change-set-lifecycle",children:"Change Set Lifecycle"}),"\n",(0,l.jsx)(n.p,{children:"Change sets progress through well-defined states."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 State: DRAFT                                             \u2502\n\u2502 \u251c\u2500 User adds items to change set                         \u2502\n\u2502 \u251c\u2500 Can add, remove, edit items freely                    \u2502\n\u2502 \u2514\u2500 Transitions to: VALIDATING                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502 user.validate()\n               \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 State: VALIDATING                                        \u2502\n\u2502 \u251c\u2500 Running full validation pipeline on all items         \u2502\n\u2502 \u251c\u2500 Checking dependencies, conflicts, platform support   \u2502\n\u2502 \u2514\u2500 Transitions to: READY or DRAFT (if errors)           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502 validation passed\n               \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 State: READY                                             \u2502\n\u2502 \u251c\u2500 Validation passed, safe to apply                      \u2502\n\u2502 \u251c\u2500 Depends shown, ready for execution                    \u2502\n\u2502 \u2514\u2500 Transitions to: APPLYING or DRAFT (if cancelled)      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502 user.apply()\n               \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 State: APPLYING                                          \u2502\n\u2502 \u251c\u2500 Applying items in dependency order                    \u2502\n\u2502 \u251c\u2500 Posting progress events for UI updates                \u2502\n\u2502 \u2514\u2500 Transitions to: COMPLETED, FAILED, or ROLLING_BACK    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n       \u2502               \u2502\n       \u25bc (success)     \u25bc (error)\n    COMPLETED      ROLLING_BACK (auto)\n       \u2502               \u2502\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 Final State (No More Changes)                    \u2502\n         \u251c\u2500 COMPLETED - all items applied                   \u2502\n         \u251c\u2500 FAILED - apply failed, not rolled back          \u2502\n         \u251c\u2500 ROLLED_BACK - apply failed, successfully rolled \u2502\n         \u251c\u2500 PARTIAL_FAILURE - rollback itself failed        \u2502\n         \u2502  (requires manual intervention)                  \u2502\n         \u2514\u2500 CANCELLED - user cancelled before apply         \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(n.h3,{id:"status-helpers",children:"Status Helpers"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import {\n  isChangeSetPending,\n  isChangeSetProcessing,\n  isChangeSetFinal,\n  isChangeSetCancellable,\n} from '@nasnet/core/types';\n\nfunction handleChangeSet(changeSet: ChangeSet) {\n  if (isChangeSetPending(changeSet.status)) {\n    // DRAFT, VALIDATING, READY - can still edit\n    console.log('Change set is pending, can edit items');\n  }\n\n  if (isChangeSetProcessing(changeSet.status)) {\n    // VALIDATING, APPLYING, ROLLING_BACK - in progress\n    showProgressSpinner();\n  }\n\n  if (isChangeSetFinal(changeSet.status)) {\n    // COMPLETED, FAILED, ROLLED_BACK, PARTIAL_FAILURE, CANCELLED\n    // No more changes possible\n    disableEditButtons();\n  }\n\n  if (isChangeSetCancellable(changeSet.status)) {\n    // DRAFT, VALIDATING, READY, APPLYING - can cancel\n    showCancelButton();\n  }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"change-set-structure",children:"Change Set Structure"}),"\n",(0,l.jsx)(n.p,{children:"A change set bundles multiple resource operations."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import type {\n  ChangeSet,\n  ChangeSetItem,\n  ChangeSetStatus,\n  ChangeOperation,\n  ChangeSetItemStatus,\n} from '@nasnet/core/types';\n\n// Complete change set structure\nconst changeSet: ChangeSet = {\n  // Identity\n  id: 'cs-2024-02-27-001',              // ULID\n  name: 'Create LAN Network',\n  description: 'Setup LAN with DHCP and firewall',\n  routerId: 'router-01',\n  createdBy: 'admin@example.com',\n  source: 'lan-setup-wizard',            // Where it came from\n  version: 1,                             // For optimistic locking\n\n  // Status and progress\n  status: 'READY' as ChangeSetStatus,\n  createdAt: new Date('2024-02-27T10:00:00Z'),\n  applyStartedAt: null,\n  completedAt: null,\n\n  // Items (individual resource operations)\n  items: [\n    {\n      id: 'bridge-1',\n      resourceUuid: null,                 // CREATE operation - no UUID yet\n      resourceType: 'network.bridge',\n      resourceCategory: 'NETWORK',\n      name: 'Create LAN Bridge',\n      description: 'Main bridge for LAN',\n      operation: 'CREATE' as ChangeOperation,\n      configuration: {\n        name: 'br-lan',\n        mtu: 1500,\n        enabled: true,\n      },\n      previousState: null,                // CREATE - no previous state\n      dependencies: [],                   // Root node - no dependencies\n      status: 'PENDING' as ChangeSetItemStatus,\n      error: null,\n      applyStartedAt: null,\n      applyCompletedAt: null,\n      confirmedState: null,\n      applyOrder: 0,                      // Applied first\n    },\n    {\n      id: 'dhcp-1',\n      resourceUuid: null,\n      resourceType: 'dhcp.server',\n      resourceCategory: 'NETWORK',\n      name: 'Create DHCP Server',\n      operation: 'CREATE' as ChangeOperation,\n      configuration: {\n        interface: 'br-lan',\n        addressPool: '192.168.1.100-200',\n        gateway: '192.168.1.1',\n        dns1: '8.8.8.8',\n      },\n      previousState: null,\n      dependencies: ['bridge-1'],         // Depends on bridge\n      status: 'PENDING' as ChangeSetItemStatus,\n      error: null,\n      applyStartedAt: null,\n      applyCompletedAt: null,\n      confirmedState: null,\n      applyOrder: 1,                      // Applied second\n    },\n  ],\n\n  // Validation (populated after validation phase)\n  validation: {\n    canApply: true,\n    errors: [],\n    warnings: [],\n    conflicts: [],\n    missingDependencies: [],\n    circularDependencies: null,\n  },\n\n  // Rollback plan (populated during/after apply)\n  rollbackPlan: [\n    {\n      itemId: 'dhcp-1',\n      operation: 'DELETE',                // Undo: delete created DHCP\n      restoreState: null,\n      resourceUuid: '.id=*1A',\n      success: false,\n      error: null,\n      rollbackOrder: 0,\n    },\n    {\n      itemId: 'bridge-1',\n      operation: 'DELETE',\n      restoreState: null,\n      resourceUuid: '.id=*19',\n      success: false,\n      error: null,\n      rollbackOrder: 1,                   // Rollback in reverse order\n    },\n  ],\n\n  // Error (if failed)\n  error: null,\n};\n"})}),"\n",(0,l.jsx)(n.h3,{id:"change-operations",children:"Change Operations"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import { ChangeOperation, getOperationColor, getOperationLabel } from '@nasnet/core/types';\n\n// Three basic operations\ntype ChangeOperation = 'CREATE' | 'UPDATE' | 'DELETE';\n\n// Usage helpers\nfunction renderOperation(op: ChangeOperation) {\n  const color = getOperationColor(op);    // green | amber | red\n  const label = getOperationLabel(op);    // 'Create' | 'Update' | 'Delete'\n\n  return <span className={`text-${color}-500`}>{label}</span>;\n}\n\n// Examples\nconst operations = {\n  CREATE: {\n    color: 'green',\n    label: 'Create',\n    previousState: null,\n    confirmedState: null,\n  },\n  UPDATE: {\n    color: 'amber',\n    label: 'Update',\n    previousState: { /* old config */ },\n    confirmedState: null,\n  },\n  DELETE: {\n    color: 'red',\n    label: 'Delete',\n    previousState: { /* config to delete */ },\n    confirmedState: null,\n  },\n};\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"dependency-graph",children:"Dependency Graph"}),"\n",(0,l.jsx)(n.p,{children:"Dependency graphs determine operation order using topological sorting."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import {\n  topologicalSort,\n  detectCycles,\n  analyzeDependencies,\n  buildDependencyGraph,\n} from '@nasnet/core/utils';\nimport type { DependencyNode } from '@nasnet/core/utils';\n\n// Define nodes with dependencies\nconst nodes: DependencyNode[] = [\n  { id: 'bridge', dependencies: [] },          // No deps - root\n  { id: 'dhcp', dependencies: ['bridge'] },    // Depends on bridge\n  { id: 'firewall', dependencies: ['bridge'] }, // Also depends on bridge\n];\n\n// Sort topologically\nconst result = topologicalSort(nodes);\nif (result.success) {\n  console.log('Apply order:', result.sortedIds);\n  // ['bridge', 'dhcp', 'firewall'] or ['bridge', 'firewall', 'dhcp']\n} else {\n  console.error('Circular dependency:', result.cycle);\n  // ['a', 'b', 'a'] means a\u2192b\u2192a cycle\n}\n\n// Analyze graph structure\nconst analysis = analyzeDependencies(nodes);\nconsole.log('Root nodes:', analysis.roots);           // ['bridge']\nconsole.log('Leaf nodes:', analysis.leaves);         // ['dhcp', 'firewall']\nconsole.log('Max depth:', analysis.maxDepth);        // 1 level\nconsole.log('Levels:', analysis.levels);             // [['bridge'], ['dhcp', 'firewall']]\n\n// Check for problems\nconst cycleCheck = detectCycles(nodes);\nif (cycleCheck.hasCycle) {\n  console.error('Cycles found:', cycleCheck.cycles);\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"dependency-analysis-types",children:"Dependency Analysis Types"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import type { DependencyAnalysis } from '@nasnet/core/utils';\n\ninterface DependencyAnalysis {\n  roots: string[];         // No dependencies - apply first\n  leaves: string[];        // No dependents - apply last\n  maxDepth: number;        // Longest dependency chain\n  levels: string[][];      // Nodes grouped by application level\n  missingDependencies: Array<{\n    nodeId: string;\n    missingDepId: string;\n  }>;\n}\n\n// Example with complex graph:\n// bridge\n//   \u251c\u2500 dhcp\n//   \u2514\u2500 firewall\n//       \u2514\u2500 nat (depends on firewall)\n\nconst complex = analyzeDependencies([\n  { id: 'bridge', dependencies: [] },\n  { id: 'dhcp', dependencies: ['bridge'] },\n  { id: 'firewall', dependencies: ['bridge'] },\n  { id: 'nat', dependencies: ['firewall'] },\n]);\n\nconsole.log(complex.roots);     // ['bridge']\nconsole.log(complex.leaves);    // ['dhcp', 'nat']\nconsole.log(complex.maxDepth);  // 2\nconsole.log(complex.levels);    // [['bridge'], ['dhcp', 'firewall'], ['nat']]\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"parallel-execution",children:"Parallel Execution"}),"\n",(0,l.jsx)(n.p,{children:"Identify nodes that can execute in parallel."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import { getParallelApplicableNodes } from '@nasnet/core/utils';\n\nconst changeSet = [\n  { id: 'bridge', dependencies: [] },\n  { id: 'dhcp', dependencies: ['bridge'] },\n  { id: 'firewall', dependencies: ['bridge'] },\n  { id: 'nat', dependencies: ['firewall'] },\n];\n\n// Start with empty applied set\nlet applied = new Set<string>();\n\n// Iteration 1: What can we apply first?\nlet applicableNow = getParallelApplicableNodes(changeSet, applied);\nconsole.log('Wave 1:', applicableNow);  // ['bridge']\n// Execute these in parallel\n\n// Iteration 2: After bridge is applied\napplied.add('bridge');\napplicableNow = getParallelApplicableNodes(changeSet, applied);\nconsole.log('Wave 2:', applicableNow);  // ['dhcp', 'firewall'] - both ready!\n// Execute dhcp and firewall in parallel\n\n// Iteration 3: After dhcp and firewall applied\napplied.add('dhcp');\napplied.add('firewall');\napplicableNow = getParallelApplicableNodes(changeSet, applied);\nconsole.log('Wave 3:', applicableNow);  // ['nat']\n// Execute nat\n\n// Iteration 4: All done\napplied.add('nat');\napplicableNow = getParallelApplicableNodes(changeSet, applied);\nconsole.log('Wave 4:', applicableNow);  // [] - nothing left\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Parallel executor pattern:"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"async function applyChangeSetParallel(changeSet: ChangeSet) {\n  const graph = buildDependencyGraph(changeSet.items);\n  const applied = new Set<string>();\n\n  while (applied.size < changeSet.items.length) {\n    // Find nodes ready to apply\n    const wave = getParallelApplicableNodes(graph, applied);\n\n    if (wave.length === 0) {\n      // Check for circular dependencies\n      throw new Error('Circular dependency or missing dependencies');\n    }\n\n    // Apply all in parallel\n    const promises = wave.map((itemId) =>\n      applyItem(changeSet.items.find((i) => i.id === itemId)!)\n    );\n\n    const results = await Promise.allSettled(promises);\n\n    // Check for failures\n    let anyFailed = false;\n    results.forEach((result, index) => {\n      if (result.status === 'fulfilled') {\n        applied.add(wave[index]);\n      } else {\n        anyFailed = true;\n        console.error(`Item ${wave[index]} failed:`, result.reason);\n      }\n    });\n\n    if (anyFailed) {\n      // Trigger rollback\n      await rollback(changeSet, applied);\n      throw new Error('Parallel apply failed');\n    }\n  }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"rollback-mechanism",children:"Rollback Mechanism"}),"\n",(0,l.jsx)(n.p,{children:"Automatic undo when something fails."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import type { RollbackStep, RollbackOperation } from '@nasnet/core/types';\n\n// Rollback plan: how to undo applied changes\nconst rollbackPlan: RollbackStep[] = [\n  {\n    itemId: 'nat-rule-1',\n    operation: 'DELETE' as RollbackOperation,  // Delete created resource\n    resourceUuid: '.id=*1C',\n    restoreState: null,\n    success: false,\n    error: null,\n    rollbackOrder: 0,  // First to rollback (reverse of apply order)\n  },\n  {\n    itemId: 'firewall-rule-1',\n    operation: 'DELETE',\n    resourceUuid: '.id=*1B',\n    restoreState: null,\n    success: false,\n    error: null,\n    rollbackOrder: 1,\n  },\n  {\n    itemId: 'bridge-port-1',\n    operation: 'DELETE',\n    resourceUuid: '.id=*1A',\n    restoreState: null,\n    success: false,\n    error: null,\n    rollbackOrder: 2,\n  },\n  {\n    itemId: 'bridge-1',\n    operation: 'DELETE',\n    resourceUuid: '.id=*19',\n    restoreState: null,\n    success: false,\n    error: null,\n    rollbackOrder: 3,  // Last to rollback\n  },\n];\n\n// Rollback types\ntype RollbackOperation = 'DELETE' | 'RESTORE' | 'REVERT';\n\n// DELETE: Remove created resource\n// RESTORE: Restore deleted resource from previousState\n// REVERT: Revert updated resource to previousState\n\nasync function executeRollback(rollbackPlan: RollbackStep[]) {\n  // Sort by rollbackOrder (reverse of apply order)\n  const sorted = rollbackPlan.sort((a, b) => b.rollbackOrder - a.rollbackOrder);\n\n  for (const step of sorted) {\n    try {\n      switch (step.operation) {\n        case 'DELETE':\n          await deleteResource(step.resourceUuid!);\n          break;\n\n        case 'RESTORE':\n          await createResource(step.restoreState!);\n          break;\n\n        case 'REVERT':\n          await updateResource(step.resourceUuid!, step.restoreState!);\n          break;\n      }\n\n      step.success = true;\n    } catch (error) {\n      step.error = (error as Error).message;\n      // Continue rolling back others\n    }\n  }\n\n  // Check if any rollbacks failed\n  const allSucceeded = rollbackPlan.every((s) => s.success);\n  if (!allSucceeded) {\n    return 'PARTIAL_FAILURE';  // Requires manual intervention\n  }\n\n  return 'ROLLED_BACK';\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"cycle-detection",children:"Cycle Detection"}),"\n",(0,l.jsx)(n.p,{children:"Detect and report circular dependencies."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import { detectCycles, validateDependencyGraph } from '@nasnet/core/utils';\n\n// Circular dependency example\nconst circular = [\n  { id: 'a', dependencies: ['b'] },\n  { id: 'b', dependencies: ['c'] },\n  { id: 'c', dependencies: ['a'] },  // c\u2192a creates cycle: a\u2192b\u2192c\u2192a\n];\n\nconst result = detectCycles(circular);\nconsole.log(result.hasCycle);  // true\nconsole.log(result.cycles);    // [['a', 'b', 'c']]\n\n// Full validation\nconst validation = validateDependencyGraph(circular);\nconsole.log(validation.valid);    // false\nconsole.log(validation.errors);   // ['Circular dependency: a \u2192 b \u2192 c \u2192 a']\n\n// Handle in UI\nfunction handleChangeSetValidation(changeSet: ChangeSet) {\n  if (changeSet.validation?.circularDependencies?.length) {\n    const cycles = changeSet.validation.circularDependencies;\n    showError(\n      `Circular dependencies detected: ${cycles\n        .map((c) => c.join('\u2192'))\n        .join(', ')}`\n    );\n  }\n\n  if (changeSet.validation?.missingDependencies?.length) {\n    showWarning(\n      `Missing dependencies: ${changeSet.validation.missingDependencies\n        .map((m) => `${m.itemId} requires ${m.missingResourceType}`)\n        .join(', ')}`\n    );\n  }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"conflict-detection",children:"Conflict Detection"}),"\n",(0,l.jsx)(n.p,{children:"Detect and handle conflicts between items or with existing resources."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import type { ChangeSetConflict } from '@nasnet/core/types';\n\n// Conflicts detected during validation\nconst conflicts: ChangeSetConflict[] = [\n  {\n    itemId1: 'dhcp-server-1',\n    itemId2OrResourceUuid: 'existing-dhcp-001',\n    isExternalConflict: true,              // Conflict with existing resource\n    description: 'Another DHCP server already exists on br-lan',\n    resolution: 'Delete the existing DHCP server first',\n  },\n  {\n    itemId1: 'port-forward-1',\n    itemId2OrResourceUuid: 'port-forward-2',\n    isExternalConflict: false,             // Conflict within change set\n    description: 'Both rules use the same port 8080',\n    resolution: 'Change one of the port numbers',\n  },\n];\n\n// Handle in UI\nfunction showConflictDialog(conflict: ChangeSetConflict) {\n  if (conflict.isExternalConflict) {\n    showModal(\n      `Conflict with existing resource: ${conflict.description}`,\n      [\n        { label: 'View Existing', action: () => viewResource(conflict.itemId2OrResourceUuid) },\n        { label: 'Delete Existing', action: () => deleteAndContinue() },\n        { label: 'Cancel', action: () => cancelChangeSet() },\n      ]\n    );\n  } else {\n    showModal(\n      `Conflict between items: ${conflict.description}`,\n      [\n        { label: 'Edit Items', action: () => editConflictingItems() },\n        { label: 'Cancel', action: () => cancelChangeSet() },\n      ]\n    );\n  }\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"practical-examples",children:"Practical Examples"}),"\n",(0,l.jsx)(n.h3,{id:"example-1-lan-setup-with-dependencies",children:"Example 1: LAN Setup with Dependencies"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import { ChangeSet, ChangeSetStatus, ChangeOperation } from '@nasnet/core/types';\n\nfunction createLANSetupChangeSet(): ChangeSet {\n  return {\n    id: 'cs-lan-setup',\n    name: 'Create LAN Network',\n    description: 'Setup LAN bridge with DHCP and firewall',\n    routerId: 'router-01',\n    status: 'DRAFT' as ChangeSetStatus,\n    version: 1,\n    createdAt: new Date(),\n    applyStartedAt: null,\n    completedAt: null,\n    createdBy: 'admin@example.com',\n    source: 'lan-wizard',\n\n    items: [\n      // Step 1: Create bridge (no dependencies)\n      {\n        id: 'item-1',\n        resourceUuid: null,\n        resourceType: 'network.bridge',\n        resourceCategory: 'NETWORK',\n        name: 'Create Bridge',\n        operation: 'CREATE' as ChangeOperation,\n        configuration: { name: 'br-lan', mtu: 1500 },\n        previousState: null,\n        dependencies: [],\n        status: 'PENDING',\n        error: null,\n        applyStartedAt: null,\n        applyCompletedAt: null,\n        confirmedState: null,\n        applyOrder: 0,\n      },\n\n      // Step 2: Add ports to bridge\n      {\n        id: 'item-2',\n        resourceUuid: null,\n        resourceType: 'network.bridge-port',\n        resourceCategory: 'NETWORK',\n        name: 'Add ether1 to bridge',\n        operation: 'CREATE' as ChangeOperation,\n        configuration: { interface: 'ether1', bridge: 'br-lan' },\n        previousState: null,\n        dependencies: ['item-1'],  // Depends on bridge existing\n        status: 'PENDING',\n        error: null,\n        applyStartedAt: null,\n        applyCompletedAt: null,\n        confirmedState: null,\n        applyOrder: 1,\n      },\n\n      // Step 3: Create DHCP server (also depends on bridge)\n      {\n        id: 'item-3',\n        resourceUuid: null,\n        resourceType: 'dhcp.server',\n        resourceCategory: 'NETWORK',\n        name: 'Create DHCP Server',\n        operation: 'CREATE' as ChangeOperation,\n        configuration: {\n          interface: 'br-lan',\n          addressPool: '192.168.1.100-200',\n          gateway: '192.168.1.1',\n        },\n        previousState: null,\n        dependencies: ['item-1'],  // Depends on bridge\n        status: 'PENDING',\n        error: null,\n        applyStartedAt: null,\n        applyCompletedAt: null,\n        confirmedState: null,\n        applyOrder: 1,  // Can run parallel with item-2\n      },\n\n      // Step 4: Firewall rule\n      {\n        id: 'item-4',\n        resourceUuid: null,\n        resourceType: 'firewall.filter',\n        resourceCategory: 'FIREWALL',\n        name: 'Allow LAN traffic',\n        operation: 'CREATE' as ChangeOperation,\n        configuration: {\n          'in-interface': 'br-lan',\n          action: 'accept',\n        },\n        previousState: null,\n        dependencies: ['item-1'],\n        status: 'PENDING',\n        error: null,\n        applyStartedAt: null,\n        applyCompletedAt: null,\n        confirmedState: null,\n        applyOrder: 1,  // Can run parallel\n      },\n    ],\n\n    validation: null,\n    rollbackPlan: [],\n    error: null,\n  };\n}\n\n// Usage\nconst changeSet = createLANSetupChangeSet();\n// Apply order: item-1 (bridge), then items 2-4 in parallel\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-2-update-with-conflict-detection",children:"Example 2: Update with Conflict Detection"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import { topologicalSort } from '@nasnet/core/utils';\n\nasync function handleChangeSetValidation(changeSet: ChangeSet) {\n  // Step 1: Check for circular dependencies\n  const graph = changeSet.items.map((item) => ({\n    id: item.id,\n    dependencies: item.dependencies,\n  }));\n\n  const sortResult = topologicalSort(graph);\n  if (!sortResult.success) {\n    showError(\n      `Circular dependency: ${sortResult.cycle?.join(' \u2192 ')}`\n    );\n    return;\n  }\n\n  // Step 2: Update apply order on items\n  sortResult.sortedIds.forEach((id, index) => {\n    const item = changeSet.items.find((i) => i.id === id);\n    if (item) {\n      item.applyOrder = index;\n    }\n  });\n\n  // Step 3: Show validation results\n  if (changeSet.validation?.conflicts?.length) {\n    showConflictWarning(changeSet.validation.conflicts);\n  }\n\n  if (changeSet.validation?.errors?.length) {\n    showErrorsList(changeSet.validation.errors);\n  }\n\n  // Step 4: Show preview of parallel execution\n  const { levels } = analyzeDependencies(graph);\n  showApplyPlan(levels);\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"example-3-monitor-progress",children:"Example 3: Monitor Progress"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"import { ChangeSetProgressEvent } from '@nasnet/core/types';\n\nfunction setupProgressListener(changeSetId: string) {\n  // Subscribe to progress events\n  const unsubscribe = onChangeSetProgress((event: ChangeSetProgressEvent) => {\n    if (event.changeSetId !== changeSetId) return;\n\n    // Update UI\n    const progress = event.progressPercent;\n    updateProgressBar(progress);\n\n    // Show current item\n    if (event.currentItem) {\n      showCurrentItem(\n        `${event.currentItem.operation} ${event.currentItem.name}`\n      );\n    }\n\n    // Show ETA\n    if (event.estimatedRemainingMs) {\n      const eta = new Date(Date.now() + event.estimatedRemainingMs);\n      showETA(eta);\n    }\n\n    // Handle completion\n    if (event.status === 'COMPLETED') {\n      showSuccess('All changes applied');\n      unsubscribe();\n    }\n\n    if (event.status === 'FAILED') {\n      showError(`Failed at ${event.currentItem?.name}`);\n      if (event.error) {\n        console.error(event.error.message);\n      }\n      unsubscribe();\n    }\n  });\n\n  return unsubscribe;\n}\n\n// Example UI\nfunction ChangeSetProgressMonitor({ changeSetId }: { changeSetId: string }) {\n  const [progress, setProgress] = useState(0);\n  const [current, setCurrent] = useState<string>('');\n  const [eta, setEta] = useState<Date | null>(null);\n\n  useEffect(() => {\n    return setupProgressListener(changeSetId);\n  }, [changeSetId]);\n\n  return (\n    <div className=\"progress-monitor\">\n      <progress value={progress} max={100} />\n      <p>{progress}% complete</p>\n      {current && <p>Processing: {current}</p>}\n      {eta && <p>ETA: {eta.toLocaleTimeString()}</p>}\n    </div>\n  );\n}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"universal-state-v2.md"})," - Resource model that change sets operate on"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"validation-pipeline.md"})," - Validation before change set apply"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"forms.md"})," - Using change sets in forms"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>i});var r=t(14041);const l={},a=r.createContext(l);function s(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);