"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[6256],{55521:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"graphql-api","title":"GraphQL API Layer","description":"Schema-first GraphQL API with domain-organized resolvers, custom directives, and DataLoader batching.","source":"@site/../backend/docs/graphql-api.md","sourceDirName":".","slug":"/graphql-api","permalink":"/docs/backend/graphql-api","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/graphql-api.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Getting Started","permalink":"/docs/backend/getting-started"},"next":{"title":"NasNet Backend \u2014 Master Index","permalink":"/docs/backend/"}}');var s=r(31085),t=r(71184);const l={},c="GraphQL API Layer",d={},a=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Schema Organization",id:"schema-organization",level:2},{value:"Schema-Level Directives",id:"schema-level-directives",level:2},{value:"Two-Layer Directive Model",id:"two-layer-directive-model",level:3},{value:"Platform Mapping Directives (Schema-Only)",id:"platform-mapping-directives-schema-only",level:3},{value:"@mikrotik",id:"mikrotik",level:4},{value:"@openwrt",id:"openwrt",level:4},{value:"@vyos",id:"vyos",level:4},{value:"Infrastructure Directives (Schema-Only)",id:"infrastructure-directives-schema-only",level:3},{value:"@realtime",id:"realtime",level:4},{value:"@cache",id:"cache",level:4},{value:"@migrateFrom",id:"migratefrom",level:4},{value:"Runtime-Implemented Directives",id:"runtime-implemented-directives",level:3},{value:"@validate \u2014 Applicable Locations",id:"validate--applicable-locations",level:4},{value:"@sensitive \u2014 Applicable Locations",id:"sensitive--applicable-locations",level:4},{value:"@auth \u2014 Applicable Locations",id:"auth--applicable-locations",level:4},{value:"@capability \u2014 Applicable Locations",id:"capability--applicable-locations",level:4},{value:"Complexity Analysis",id:"complexity-analysis",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Field Complexity Rules",id:"field-complexity-rules",level:3},{value:"Complexity Budget Guidelines",id:"complexity-budget-guidelines",level:3},{value:"Introspection",id:"introspection",level:3},{value:"Package Reference",id:"package-reference",level:2},{value:"graph/resolver",id:"graphresolver",level:3},{value:"Resolver Root Struct",id:"resolver-root-struct",level:4},{value:"File Naming Conventions",id:"file-naming-conventions",level:4},{value:"Domain Groupings",id:"domain-groupings",level:4},{value:"Helper Files",id:"helper-files",level:4},{value:"internal/graphql/directives",id:"internalgraphqldirectives",level:3},{value:"Directives struct",id:"directives-struct",level:4},{value:"@validate",id:"validate",level:4},{value:"@auth",id:"auth",level:4},{value:"@sensitive",id:"sensitive",level:4},{value:"@capability",id:"capability",level:4},{value:"internal/graphql/loaders",id:"internalgraphqlloaders",level:3},{value:"ResourceLoader",id:"resourceloader",level:4},{value:"RouterLoader",id:"routerloader",level:4},{value:"Batch Result Mapping (helpers.go)",id:"batch-result-mapping-helpersgo",level:4},{value:"Data Flow",id:"data-flow",level:2},{value:"Query Flow",id:"query-flow",level:3},{value:"Subscription Flow",id:"subscription-flow",level:3},{value:"Mutation + Event Pattern",id:"mutation--event-pattern",level:3},{value:"Configuration",id:"configuration-1",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"graphql-api-layer",children:"GraphQL API Layer"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Schema-first GraphQL API with domain-organized resolvers, custom directives, and DataLoader batching."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Packages:"})," ",(0,s.jsx)(n.code,{children:"graph/resolver/"}),", ",(0,s.jsx)(n.code,{children:"internal/graphql/directives/"}),", ",(0,s.jsx)(n.code,{children:"internal/graphql/loaders/"}),"\n",(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"graph/resolver/resolver.go"}),", ",(0,s.jsx)(n.code,{children:"internal/graphql/directives/directives.go"}),", ",(0,s.jsx)(n.code,{children:"internal/graphql/loaders/resource_loader.go"}),"\n",(0,s.jsx)(n.strong,{children:"Prerequisites:"})," [See: getting-started.md \xa7Project Structure], [See: application-bootstrap.md \xa7Service Wiring]"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["The GraphQL API is built with ",(0,s.jsx)(n.a,{href:"https://gqlgen.com/",children:"gqlgen"})," in schema-first mode. The schema (in ",(0,s.jsx)(n.code,{children:"schema/"}),") is the single source of truth; gqlgen generates Go interfaces that resolver files implement. Resolvers are organized by domain, each in a separate file. A single ",(0,s.jsx)(n.code,{children:"Resolver"})," root struct carries all service dependencies via dependency injection."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["HTTP Request<br/>(POST /graphql)"]\n    B["Echo Router"]\n    C["GraphQL Handler<br/>(gqlgen)"]\n    D["Directive Chain"]\n    D1["@auth"]\n    D2["@validate"]\n    D3["@capability"]\n    D4["@sensitive"]\n    E["Resolver Method<br/>(domain-specific file)"]\n    F["Service Layer<br/>(internal/services/*<br/>internal/alerts/*)"]\n    G["DataLoaders<br/>(batch DB lookups)"]\n    H["ent ORM"]\n    I["SQLite DB"]\n\n    A --\x3e B\n    B --\x3e C\n    C --\x3e D\n    D --\x3e D1\n    D1 --\x3e D2\n    D2 --\x3e D3\n    D3 --\x3e D4\n    D4 --\x3e E\n    E --\x3e F\n    F --\x3e G\n    G --\x3e H\n    H --\x3e I\n\n    style C fill:#4a90e2\n    style D fill:#f5a623\n    style E fill:#7ed321\n    style F fill:#bd10e0\n    style H fill:#50e3c2'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"schema-organization",children:"Schema Organization"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"schema/"})," directory contains ~150 ",(0,s.jsx)(n.code,{children:".graphql"})," files organized by domain:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Directory"}),(0,s.jsx)(n.th,{children:"Contents"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/core/"})}),(0,s.jsx)(n.td,{children:"Router types, interface queries/mutations, directives (20 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/resources/"})}),(0,s.jsx)(n.td,{children:"Universal State resource model, 8-layer types (12 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/changeset/"})}),(0,s.jsx)(n.td,{children:"Change set management, apply/confirm/merge flow (5 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/network/"})}),(0,s.jsx)(n.td,{children:"VLANs, IP addressing, routing, bridges, tunnels (14 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/wan/"})}),(0,s.jsx)(n.td,{children:"WAN interfaces, PPPoE, LTE configuration (5 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/firewall/"})}),(0,s.jsx)(n.td,{children:"Address lists, NAT, port knocking, filter rules (10 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/diagnostics/"})}),(0,s.jsx)(n.td,{children:"Troubleshooting, traceroute, DNS lookup (8 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/storage/"})}),(0,s.jsx)(n.td,{children:"External storage detection and management (3 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/alerts/"})}),(0,s.jsx)(n.td,{children:"Alert rules, webhooks, notification channels (24 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/services/"})}),(0,s.jsx)(n.td,{children:"Feature marketplace, routing, traffic control (27 files)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"schema/fragments/"})}),(0,s.jsx)(n.td,{children:"Client-side query fragments (3 files)"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Custom scalars (",(0,s.jsx)(n.code,{children:"schema/scalars.graphql"}),"): ",(0,s.jsx)(n.code,{children:"DateTime"}),", ",(0,s.jsx)(n.code,{children:"JSON"}),", ",(0,s.jsx)(n.code,{children:"IPv4"}),", ",(0,s.jsx)(n.code,{children:"IPv6"}),", ",(0,s.jsx)(n.code,{children:"MAC"}),", ",(0,s.jsx)(n.code,{children:"CIDR"}),", ",(0,s.jsx)(n.code,{children:"Port"}),", ",(0,s.jsx)(n.code,{children:"PortRange"}),", ",(0,s.jsx)(n.code,{children:"Duration"}),", ",(0,s.jsx)(n.code,{children:"Bandwidth"}),", ",(0,s.jsx)(n.code,{children:"Size"}),", ",(0,s.jsx)(n.code,{children:"ULID"}),"."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Scalar"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DateTime"})}),(0,s.jsx)(n.td,{children:"ISO 8601 datetime string"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"2024-01-15T10:30:00Z"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"JSON"})}),(0,s.jsx)(n.td,{children:"Arbitrary JSON for flexible configuration"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'{"key": "value"}'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"IPv4"})}),(0,s.jsx)(n.td,{children:"IPv4 address (XXX.XXX.XXX.XXX, 0-255 each)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"192.168.1.1"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"IPv6"})}),(0,s.jsx)(n.td,{children:"IPv6 address"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"2001:0db8::8a2e:0370:7334"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"MAC"})}),(0,s.jsx)(n.td,{children:"MAC address (colon or dash separated)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"00:1A:2B:3C:4D:5E"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CIDR"})}),(0,s.jsx)(n.td,{children:"Network address in CIDR notation"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"192.168.1.0/24"'})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Port"})}),(0,s.jsx)(n.td,{children:"TCP/UDP port number"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"8080"})," (1-65535)"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PortRange"})}),(0,s.jsx)(n.td,{children:"Port or port range string"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:'"80"'}),", ",(0,s.jsx)(n.code,{children:'"80-443"'}),", ",(0,s.jsx)(n.code,{children:'"80,443"'})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Duration"})}),(0,s.jsx)(n.td,{children:"RouterOS-format duration string"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:'"1d2h3m4s"'}),", ",(0,s.jsx)(n.code,{children:'"30s"'})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Bandwidth"})}),(0,s.jsx)(n.td,{children:"Bandwidth with unit"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:'"10M"'}),", ",(0,s.jsx)(n.code,{children:'"1G"'}),", ",(0,s.jsx)(n.code,{children:'"100k"'})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Size"})}),(0,s.jsx)(n.td,{children:"Size in bytes with optional unit"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:'"1024"'}),", ",(0,s.jsx)(n.code,{children:'"1k"'}),", ",(0,s.jsx)(n.code,{children:'"1G"'})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ULID"})}),(0,s.jsx)(n.td,{children:"26-char lexicographically sortable ID"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"01ARZ3NDEKTSV4RRFFQ69G5FAV"'})})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"schema-level-directives",children:"Schema-Level Directives"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"schema/core/"})," directory defines two categories of directives: those that are ",(0,s.jsx)(n.strong,{children:"schema annotations only"})," (metadata for codegen or documentation) and those that have ",(0,s.jsx)(n.strong,{children:"Go runtime implementations"})," in ",(0,s.jsx)(n.code,{children:"internal/graphql/directives/"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"two-layer-directive-model",children:"Two-Layer Directive Model"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph LR\n    A["schema/core/<br/>directives-*.graphql<br/>(SDL definitions)"]\n    B["gqlgen<br/>(reads SDL)"]\n    C["internal/graphql/<br/>directives.go<br/>(Go implementations)"]\n    D["routes_prod.go<br/>(register on server)"]\n\n    A --\x3e|generates| B\n    B --\x3e|implements| C\n    C --\x3e|wired into| D\n\n    style A fill:#f5a623\n    style C fill:#7ed321\n    style D fill:#4a90e2'}),"\n",(0,s.jsxs)(n.p,{children:["Directives defined in SDL but ",(0,s.jsx)(n.strong,{children:"without"})," a Go runtime implementation are ",(0,s.jsx)(n.strong,{children:"schema-only annotations"})," \u2014 they attach metadata that codegen tools (gqlgen, graphql-codegen) or documentation generators can read, but they do not intercept resolver execution."]}),"\n",(0,s.jsx)(n.h3,{id:"platform-mapping-directives-schema-only",children:"Platform Mapping Directives (Schema-Only)"}),"\n",(0,s.jsxs)(n.p,{children:["Defined in ",(0,s.jsx)(n.code,{children:"schema/core/core-directives-platform.graphql"}),". These map GraphQL fields to router-platform API paths. The resolver layer uses this metadata for translation \u2014 the directives themselves are not enforced at runtime by gqlgen."]}),"\n",(0,s.jsx)(n.h4,{id:"mikrotik",children:"@mikrotik"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @mikrotik(\n  path: String!        # RouterOS API path, e.g., '/ip/address'\n  field: String        # RouterOS field name if different from GraphQL field\n  cmd: String          # RouterOS command: print, add, set, remove\n) on FIELD_DEFINITION | OBJECT\n"})}),"\n",(0,s.jsx)(n.h4,{id:"openwrt",children:"@openwrt"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @openwrt(\n  ubus: String!        # Ubus namespace and method, e.g., 'network.interface'\n  method: String       # Ubus method: list, call, etc.\n  field: String        # Ubus response field name if different\n) on FIELD_DEFINITION | OBJECT\n"})}),"\n",(0,s.jsx)(n.h4,{id:"vyos",children:"@vyos"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @vyos(\n  path: String!        # VyOS configuration path, e.g., 'interfaces ethernet eth0'\n  field: String        # VyOS response field name if different\n) on FIELD_DEFINITION | OBJECT\n"})}),"\n",(0,s.jsx)(n.h3,{id:"infrastructure-directives-schema-only",children:"Infrastructure Directives (Schema-Only)"}),"\n",(0,s.jsx)(n.h4,{id:"realtime",children:"@realtime"}),"\n",(0,s.jsxs)(n.p,{children:["Marks a field as supporting real-time subscription updates. ",(0,s.jsx)(n.code,{children:"interval"})," and ",(0,s.jsx)(n.code,{children:"topic"})," are hints for the client and pub/sub routing layer."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @realtime(\n  interval: Int   # Update interval in milliseconds\n  topic: String   # Pub/sub channel name\n) on FIELD_DEFINITION\n"})}),"\n",(0,s.jsx)(n.h4,{id:"cache",children:"@cache"}),"\n",(0,s.jsxs)(n.p,{children:["Annotates a field with caching hints. Clients and intermediary caches can use ",(0,s.jsx)(n.code,{children:"maxAge"})," and ",(0,s.jsx)(n.code,{children:"scope"})," to decide cache lifetime."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @cache(\n  maxAge: Int!        # Maximum cache age in seconds\n  scope: CacheScope   # PRIVATE (user-specific) or PUBLIC (shared)\n) on FIELD_DEFINITION\n\nenum CacheScope { PRIVATE PUBLIC }\n"})}),"\n",(0,s.jsx)(n.h4,{id:"migratefrom",children:"@migrateFrom"}),"\n",(0,s.jsx)(n.p,{children:"Documents field renames and deprecation paths for API consumers."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @migrateFrom(\n  field: String!            # Old field/type name being replaced\n  removeInVersion: String   # Version when old field will be removed\n) on FIELD_DEFINITION | OBJECT | INPUT_FIELD_DEFINITION\n"})}),"\n",(0,s.jsx)(n.h3,{id:"runtime-implemented-directives",children:"Runtime-Implemented Directives"}),"\n",(0,s.jsxs)(n.p,{children:["The following directives are defined in SDL ",(0,s.jsx)(n.strong,{children:"and"})," have Go runtime implementations in ",(0,s.jsx)(n.code,{children:"internal/graphql/directives/directives.go"}),". They actively intercept resolver execution."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Directive"}),(0,s.jsx)(n.th,{children:"Schema file"}),(0,s.jsx)(n.th,{children:"Go handler"}),(0,s.jsx)(n.th,{children:"Error code"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"@auth"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"core-directives-platform.graphql"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Directives.Auth()"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"A401"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"@validate"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"core-directives-validation.graphql"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Directives.Validate()"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"V400"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"@sensitive"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"core-directives-validation.graphql"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Directives.Sensitive()"})}),(0,s.jsx)(n.td,{children:"N/A"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"@capability"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"core-directives-platform.graphql"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Directives.Capability()"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"C403"})})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"validate--applicable-locations",children:"@validate \u2014 Applicable Locations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"@validate"})," applies to ",(0,s.jsx)(n.code,{children:"INPUT_FIELD_DEFINITION | FIELD_DEFINITION | ARGUMENT_DEFINITION"}),". It validates the ",(0,s.jsx)(n.strong,{children:"resolved or input value"})," before the next resolver in the chain runs."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'input CreateUserInput {\n  email:    String! @validate(format: EMAIL)\n  username: String! @validate(minLength: 3, maxLength: 32, pattern: "^[a-z0-9_]+$")\n  age:      Int     @validate(min: 0, max: 150)\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ValidateFormat"})," enum values: ",(0,s.jsx)(n.code,{children:"EMAIL"}),", ",(0,s.jsx)(n.code,{children:"URL"}),", ",(0,s.jsx)(n.code,{children:"UUID"}),", ",(0,s.jsx)(n.code,{children:"IPV4"}),", ",(0,s.jsx)(n.code,{children:"IPV6"}),", ",(0,s.jsx)(n.code,{children:"MAC"}),", ",(0,s.jsx)(n.code,{children:"CIDR"}),", ",(0,s.jsx)(n.code,{children:"HOSTNAME"}),", ",(0,s.jsx)(n.code,{children:"FQDN"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"sensitive--applicable-locations",children:"@sensitive \u2014 Applicable Locations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"@sensitive"})," applies to ",(0,s.jsx)(n.code,{children:"FIELD_DEFINITION | INPUT_FIELD_DEFINITION | ARGUMENT_DEFINITION"}),". It tracks the field path in context; error reporting redacts the value."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"input CredentialsInput {\n  username: String!\n  password: String! @sensitive\n  apiKey:   String  @sensitive\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"auth--applicable-locations",children:"@auth \u2014 Applicable Locations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"@auth"})," applies to ",(0,s.jsx)(n.code,{children:"FIELD_DEFINITION | OBJECT"}),". When applied to an object type, all fields on that type require authentication."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @auth(\n  requires: String   # Optional role: 'admin', 'operator', 'viewer'\n) on FIELD_DEFINITION | OBJECT\n"})}),"\n",(0,s.jsx)(n.h4,{id:"capability--applicable-locations",children:"@capability \u2014 Applicable Locations"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"@capability"})," applies to ",(0,s.jsx)(n.code,{children:"FIELD_DEFINITION | OBJECT"}),". All listed capabilities must be present on the connected router or resolution is blocked."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"directive @capability(\n  requires: [String!]!\n) on FIELD_DEFINITION | OBJECT\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"complexity-analysis",children:"Complexity Analysis"}),"\n",(0,s.jsx)(n.p,{children:"gqlgen supports query complexity limiting to prevent deeply nested or overly broad queries from overloading the server. Complexity is assigned per field and accumulated over the entire query document before execution begins."}),"\n",(0,s.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Complexity is configured in the server setup (see ",(0,s.jsx)(n.code,{children:"apps/backend/cmd/nnc/routes_prod.go"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"srv := handler.NewDefaultServer(generated.NewExecutableSchema(cfg))\nsrv.Use(extension.FixedComplexityLimit(1000))\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The global limit of ",(0,s.jsx)(n.strong,{children:"1000 complexity units"})," applies per request. Queries exceeding this limit are rejected before any resolver executes."]}),"\n",(0,s.jsx)(n.h3,{id:"field-complexity-rules",children:"Field Complexity Rules"}),"\n",(0,s.jsxs)(n.p,{children:["Individual field complexity is registered via ",(0,s.jsx)(n.code,{children:"generated.ComplexityRoot"})," in ",(0,s.jsx)(n.code,{children:"graph/generated.go"}),". The default complexity is ",(0,s.jsx)(n.code,{children:"1"})," per field. Lists multiply by an estimated or actual count factor:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Example: listing routers multiplies by expected result count\nc.Query.Routers = func(childComplexity int, limit *int, offset *int) int {\n    n := 100  // assumed max without explicit limit\n    if limit != nil {\n        n = *limit\n    }\n    return childComplexity * n\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"complexity-budget-guidelines",children:"Complexity Budget Guidelines"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Operation type"}),(0,s.jsx)(n.th,{children:"Typical complexity"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Single field lookup"}),(0,s.jsx)(n.td,{children:"1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Object with 5 fields"}),(0,s.jsx)(n.td,{children:"5"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"List of 10 items \xd7 5 fields"}),(0,s.jsx)(n.td,{children:"50"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Subscription setup"}),(0,s.jsx)(n.td,{children:"10"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Nested list (10 \xd7 10 \xd7 5)"}),(0,s.jsx)(n.td,{children:"500"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Near-limit query"}),(0,s.jsx)(n.td,{children:"~900"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"introspection",children:"Introspection"}),"\n",(0,s.jsx)(n.p,{children:"Introspection queries are allowed unconditionally (they bypass complexity limiting). In production, introspection can be disabled via:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"srv.Use(extension.Introspection{})  // add to disable in production\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,s.jsx)(n.h3,{id:"graphresolver",children:"graph/resolver"}),"\n",(0,s.jsx)(n.h4,{id:"resolver-root-struct",children:"Resolver Root Struct"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"resolver.go"})," defines the central ",(0,s.jsx)(n.code,{children:"Resolver"})," struct that all resolver methods belong to:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Resolver struct {\n    db                  *ent.Client\n    EventBus            events.EventBus\n    EventPublisher      *events.Publisher\n    authService         *auth.Service\n    ScannerService      *scanner.ScannerService\n    CapabilityService   *capability.Service\n    RouterService       *services.RouterService\n    AlertService        *services.AlertService\n    InterfaceService    *services.InterfaceService\n    FirewallTemplateService *firewall.TemplateService\n    InstanceManager     *lifecycle.InstanceManager\n    ChainRouter         *routing.ChainRouter\n    PBREngine           *routing.PBREngine\n    KillSwitchManager   *isolation.KillSwitchManager\n    // ~40 more service fields...\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Constructor:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewResolverWithConfig(cfg Config) *Resolver\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"Config"})," struct mirrors the ",(0,s.jsx)(n.code,{children:"Resolver"})," struct field for field. All dependencies are injected at startup time; resolvers never construct services themselves."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"EventPublisher wiring:"})," if ",(0,s.jsx)(n.code,{children:"cfg.EventBus != nil"}),", a ",(0,s.jsx)(n.code,{children:"Publisher"})," is created automatically:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'r.EventPublisher = events.NewPublisher(cfg.EventBus, "graphql-resolver")\n'})}),"\n",(0,s.jsx)(n.h4,{id:"file-naming-conventions",children:"File Naming Conventions"}),"\n",(0,s.jsxs)(n.p,{children:["All resolver files in ",(0,s.jsx)(n.code,{children:"graph/resolver/"})," follow strict naming conventions:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Pattern"}),(0,s.jsx)(n.th,{children:"Purpose"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<domain>-<operation>-ops.resolvers.go"})}),(0,s.jsx)(n.td,{children:"Primary CRUD/operations"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"firewall-address-list-ops.resolvers.go"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<domain>-queries.resolvers.go"})}),(0,s.jsx)(n.td,{children:"Query-only resolvers"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"core-queries.resolvers.go"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<domain>-mutations.resolvers.go"})}),(0,s.jsx)(n.td,{children:"Mutation-only resolvers"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"network-mutations.resolvers.go"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<domain>-subscriptions.resolvers.go"})}),(0,s.jsx)(n.td,{children:"Subscription resolvers"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"services-updates-subscriptions.resolvers.go"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<domain>_helpers.go"})}),(0,s.jsxs)(n.td,{children:["Shared private helpers (no ",(0,s.jsx)(n.code,{children:".resolvers."}),")"]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"services_crud_helpers.go"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<domain>_helpers.resolvers.go"})}),(0,s.jsx)(n.td,{children:"Exported helpers shared between resolver files"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"device_routing_helpers.resolvers.go"})})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"domain-groupings",children:"Domain Groupings"}),"\n",(0,s.jsx)(n.p,{children:"Resolver files are grouped into these domains:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Domain prefix"}),(0,s.jsx)(n.th,{children:"Coverage"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"auth"})}),(0,s.jsx)(n.td,{children:"Login, logout, session management"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"core-*"})}),(0,s.jsx)(n.td,{children:"Router CRUD, connections, interface types, scanner"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"network-*"})}),(0,s.jsx)(n.td,{children:"Interfaces, VLANs, bridges, tunnels, port mirrors"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"wan-*"})}),(0,s.jsx)(n.td,{children:"WAN interface configuration and egress VLANs"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"firewall-*"})}),(0,s.jsx)(n.td,{children:"Address lists, NAT, port knocking, templates"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"diagnostics-*"})}),(0,s.jsx)(n.td,{children:"Traceroute, DNS lookup, circuit breaker, route lookup"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"services-*"})}),(0,s.jsx)(n.td,{children:"Feature lifecycle, traffic, routing, isolation, templates, updates, sharing"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"alerts-*"})}),(0,s.jsx)(n.td,{children:"Alert rules, channels, subscriptions, notification queries"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"resource-*"})}),(0,s.jsx)(n.td,{children:"Universal State resource layer"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"changeset-*"})}),(0,s.jsx)(n.td,{children:"Apply-Confirm-Merge changesets"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"storage-*"})}),(0,s.jsx)(n.td,{children:"External storage operations"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"health"})}),(0,s.jsx)(n.td,{children:"Health check resolver"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"port-registry"})}),(0,s.jsx)(n.td,{children:"Port allocation queries"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"provisioning-*"})}),(0,s.jsx)(n.td,{children:"Router provisioning phases"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"helper-files",children:"Helper Files"}),"\n",(0,s.jsx)(n.p,{children:"Helper files contain private logic shared by multiple resolver files in the same domain:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"alert_helpers.go"})," - alert severity mapping, notification dispatch helpers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"common_helpers.go"})," - shared pagination, context extraction utilities"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"services_crud_helpers.go"})," - service instance creation/update shared logic"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"services_killswitch_helpers.go"})," - kill switch rule management helpers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"provisioning_helpers.go"})," - provisioning phase execution helpers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"traffic_helpers.go"})," - traffic statistics helpers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"port_registry_helpers.go"})," - port allocation helper functions"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internalgraphqldirectives",children:"internal/graphql/directives"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Package:"})," ",(0,s.jsx)(n.code,{children:"internal/graphql/directives/"}),"\n",(0,s.jsx)(n.strong,{children:"Key file:"})," ",(0,s.jsx)(n.code,{children:"directives.go"})]}),"\n",(0,s.jsx)(n.h4,{id:"directives-struct",children:"Directives struct"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Directives struct {\n    config Config\n}\n\nfunc New(config Config) *Directives\nfunc NewDefault() *Directives\n"})}),"\n",(0,s.jsx)(n.p,{children:"Four directives are implemented:"}),"\n",(0,s.jsx)(n.h4,{id:"validate",children:"@validate"}),"\n",(0,s.jsx)(n.p,{children:"Validates field values at the resolver level before the field is returned."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (d *Directives) Validate(\n    ctx context.Context,\n    obj interface{},\n    next graphql.Resolver,\n    minVal *int, maxVal *int,\n    minLength *int, maxLength *int,\n    pattern *string,\n    format *ValidateFormat,\n) (interface{}, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Supported format constants (",(0,s.jsx)(n.code,{children:"ValidateFormat"}),"):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatEmail"})," (",(0,s.jsx)(n.code,{children:'"EMAIL"'}),") - email address"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatURL"})," (",(0,s.jsx)(n.code,{children:'"URL"'}),") - HTTP/HTTPS URL"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatUUID"})," (",(0,s.jsx)(n.code,{children:'"UUID"'}),") - UUID v4"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatIPv4"})," (",(0,s.jsx)(n.code,{children:'"IPV4"'}),") - IPv4 address"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatIPv6"})," (",(0,s.jsx)(n.code,{children:'"IPV6"'}),") - IPv6 address"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatMAC"})," (",(0,s.jsx)(n.code,{children:'"MAC"'}),") - MAC address"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatCIDR"})," (",(0,s.jsx)(n.code,{children:'"CIDR"'}),") - IPv4 CIDR notation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatHostname"})," (",(0,s.jsx)(n.code,{children:'"HOSTNAME"'}),") - single-label hostname"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"FormatFQDN"})," (",(0,s.jsx)(n.code,{children:'"FQDN"'}),") - fully qualified domain name"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Validation errors include error code ",(0,s.jsx)(n.code,{children:'"V400"'}),", the field path, the invalid value, a suggested fix, and a docs URL."]}),"\n",(0,s.jsx)(n.h4,{id:"auth",children:"@auth"}),"\n",(0,s.jsx)(n.p,{children:"Checks the request context for authentication and optional role."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (d *Directives) Auth(\n    ctx context.Context,\n    obj interface{},\n    next graphql.Resolver,\n    requires *string,\n) (interface{}, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"AuthInfo"})," is set on the context by the HTTP middleware before resolvers run:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type AuthInfo struct {\n    Authenticated bool\n    UserID        string\n    Roles         []string\n}\n\nfunc WithAuthInfo(ctx context.Context, info AuthInfo) context.Context\nfunc GetAuthInfo(ctx context.Context) (AuthInfo, bool)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Auth errors return code ",(0,s.jsx)(n.code,{children:'"A401"'}),". Role-check failures return code ",(0,s.jsx)(n.code,{children:'"A401"'})," with the required role name."]}),"\n",(0,s.jsx)(n.h4,{id:"sensitive",children:"@sensitive"}),"\n",(0,s.jsx)(n.p,{children:"Marks a field as containing sensitive data. Sensitive field paths are tracked in context so error messages redact them."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (d *Directives) Sensitive(\n    ctx context.Context,\n    obj interface{},\n    next graphql.Resolver,\n) (interface{}, error)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Context helpers:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func WithSensitiveTracking(ctx context.Context) context.Context\nfunc GetSensitiveFields(ctx context.Context) *SensitiveFields\n"})}),"\n",(0,s.jsx)(n.h4,{id:"capability",children:"@capability"}),"\n",(0,s.jsx)(n.p,{children:"Checks the router's capabilities before resolving a field. Requires a list of capability strings; if any are missing, resolution is blocked."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (d *Directives) Capability(\n    ctx context.Context,\n    obj interface{},\n    next graphql.Resolver,\n    requires []string,\n) (interface{}, error)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Context helpers:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func WithCapabilities(ctx context.Context, caps []string) context.Context\nfunc WithCapabilitiesFromDetection(ctx context.Context, capEntries map[string]int) context.Context\nfunc GetCapabilities(ctx context.Context) *RouterCapabilities\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Capability errors return code ",(0,s.jsx)(n.code,{children:'"C403"'})," and list which capabilities are missing."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internalgraphqlloaders",children:"internal/graphql/loaders"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Package:"})," ",(0,s.jsx)(n.code,{children:"internal/graphql/loaders/"})]}),"\n",(0,s.jsx)(n.p,{children:"DataLoaders solve the N+1 query problem by batching multiple lookups into a single DB query per request."}),"\n",(0,s.jsx)(n.h4,{id:"resourceloader",children:"ResourceLoader"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type ResourceLoader struct {\n    loader *dataloader.Loader[string, *ent.Resource]\n}\n\nfunc NewResourceLoader(db *ent.Client, stats *LoaderStats, devMode bool, logger *zap.Logger) *ResourceLoader\nfunc (l *ResourceLoader) Load(ctx context.Context, id string) (*ent.Resource, error)\nfunc (l *ResourceLoader) LoadAll(ctx context.Context, ids []string) ([]*ent.Resource, []error)\nfunc (l *ResourceLoader) Clear(ctx context.Context, id string)\nfunc (l *ResourceLoader) ClearAll()\nfunc (l *ResourceLoader) Prime(ctx context.Context, id string, res *ent.Resource)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Batch capacity: 100 items. Uses ",(0,s.jsx)(n.code,{children:"resource.IDIn(keys...)"})," for a single batched query."]}),"\n",(0,s.jsx)(n.h4,{id:"routerloader",children:"RouterLoader"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type RouterLoader struct {\n    loader *dataloader.Loader[string, *ent.Router]\n}\n\nfunc NewRouterLoader(db *ent.Client, stats *LoaderStats, devMode bool, logger *zap.Logger) *RouterLoader\n// Same Load/LoadAll/Clear/ClearAll/Prime interface as ResourceLoader\n"})}),"\n",(0,s.jsx)(n.h4,{id:"batch-result-mapping-helpersgo",children:"Batch Result Mapping (helpers.go)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// One-to-one: maps each key to exactly one item\nfunc mapToResults[K comparable, V any](\n    keys []K, items []V, err error, keyFunc func(V) K,\n) []*dataloader.Result[V]\n\n// One-to-many: maps each key to a slice of items\nfunc mapToSliceResults[K comparable, V any](\n    keys []K, items []V, err error, keyFunc func(V) K,\n) []*dataloader.Result[[]V]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Error types:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type NotFoundError struct{ Key interface{} }\ntype PartialBatchError struct {\n    SuccessCount int\n    FailureCount int\n    Errors       map[interface{}]error\n}\n\nfunc IsNotFoundError(err error) bool\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,s.jsx)(n.h3,{id:"query-flow",children:"Query Flow"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant EchoRouter as Echo Router\n    participant GQLHandler as GraphQL Handler\n    participant DirChain as Directive Chain\n    participant Resolver\n    participant Service\n    participant DataLoader\n    participant Database\n\n    Client->>EchoRouter: POST /graphql\n    EchoRouter->>GQLHandler: invoke\n    GQLHandler->>DirChain: auth \u2192 validate \u2192 capability \u2192 sensitive\n    DirChain->>Resolver: call resolver method\n    Resolver->>Service: business logic\n    Service->>DataLoader: batch lookup\n    DataLoader->>Database: query\n    Database--\x3e>DataLoader: results\n    DataLoader--\x3e>Service: cached results\n    Service--\x3e>Resolver: data\n    Resolver--\x3e>GQLHandler: response\n    GQLHandler--\x3e>Client: JSON"}),"\n",(0,s.jsx)(n.h3,{id:"subscription-flow",children:"Subscription Flow"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant WS as WebSocket\n    participant Resolver\n    participant EventBus\n    participant Service\n\n    Client->>WS: connect\n    WS->>Resolver: upgrade & setup subscription\n    Resolver->>EventBus: subscribe to topic\n    Service->>EventBus: publish event\n    EventBus->>Resolver: event received\n    Resolver->>WS: stream update\n    WS--\x3e>Client: WebSocket frame"}),"\n",(0,s.jsx)(n.h3,{id:"mutation--event-pattern",children:"Mutation + Event Pattern"}),"\n",(0,s.jsx)(n.p,{children:"Most mutations follow this pattern:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (r *mutationResolver) UpdateSomething(ctx context.Context, input model.UpdateInput) (*model.Result, error) {\n    // 1. Call service\n    result, err := r.SomeService.Update(ctx, input)\n    if err != nil {\n        return nil, err\n    }\n    // 2. Publish domain event (for subscriptions and audit)\n    if r.EventPublisher != nil {\n        _ = r.EventPublisher.PublishResourceUpdated(ctx, ...)\n    }\n    return result, nil\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration-1",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["The directives package is configured via ",(0,s.jsx)(n.code,{children:"Config"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Config struct {\n    ValidateEnabled   bool  // Default: true\n    AuthEnabled       bool  // Default: true\n    SensitiveEnabled  bool  // Default: true\n    CapabilityEnabled bool  // Default: true\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"All directives can be individually disabled (useful for testing)."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.p,{children:"All directive errors follow a structured format with GraphQL extensions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "errors": [{\n    "message": "human readable message",\n    "path": ["fieldPath"],\n    "extensions": {\n      "code": "V400 | A401 | C403",\n      "category": "validation | auth | capability",\n      "field": "$.path.to.field",\n      "suggestedFix": "...",\n      "docsUrl": "https://docs.nasnetconnect.io/api/errors/...",\n      "requestId": "01JXXXXX",\n      "recoverable": true | false\n    }\n  }]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Sensitive field values are automatically redacted in validation errors via ",(0,s.jsx)(n.code,{children:"redactIfSensitive()"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Integration tests"})," are in ",(0,s.jsx)(n.code,{children:"graph/resolver/*_test.go"}),". They construct a real ",(0,s.jsx)(n.code,{children:"Resolver"})," with mock or in-memory services."]}),"\n",(0,s.jsx)(n.p,{children:"Key test files:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"alerts_test.go"})," - alert rule CRUD and notification dispatch"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"alerts_integration_test.go"})," - end-to-end alert lifecycle"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"isolation_test.go"})," - kill switch and isolation verification"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"alert_rule_templates_test.go"})," - template CRUD"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"interface_stats_test.go"})," - telemetry query/subscription"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Directive tests"})," are in ",(0,s.jsx)(n.code,{children:"internal/graphql/directives/directives_test.go"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Test pattern:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func TestSomeResolver(t *testing.T) {\n    bus := events.NewInMemoryEventBus()\n    r := resolver.NewResolverWithConfig(resolver.Config{\n        EventBus:       bus,\n        SomeService:    &mockSomeService{},\n        // ...\n    })\n    // invoke resolver method directly\n    result, err := r.Query().SomeQuery(ctx, args)\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Event publishing in resolvers: [See: event-system.md \xa7Publisher]"}),"\n",(0,s.jsx)(n.li,{children:"How services are injected: [See: application-bootstrap.md \xa7Resolver Wiring]"}),"\n",(0,s.jsx)(n.li,{children:"Auth middleware populating AuthInfo: [See: security.md \xa7Auth Middleware Chain]"}),"\n",(0,s.jsx)(n.li,{children:"DataLoader usage with ent: [See: data-layer.md \xa7DataLoaders]"}),"\n",(0,s.jsxs)(n.li,{children:["Schema codegen: run ",(0,s.jsx)(n.code,{children:"npm run codegen:gqlgen"})," after modifying ",(0,s.jsx)(n.code,{children:".graphql"})," files"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>c});var i=r(14041);const s={},t=i.createContext(s);function l(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);