"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[15008],{70089:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"feature-marketplace","title":"Feature Marketplace","description":"Downloadable privacy and network services for MikroTik routers: manifest-driven binary distribution, cryptographic verification, atomic updates, config migration, and service import/export.","source":"@site/../backend/docs/feature-marketplace.md","sourceDirName":".","slug":"/feature-marketplace","permalink":"/docs/backend/feature-marketplace","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/feature-marketplace.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Event System","permalink":"/docs/backend/event-system"},"next":{"title":"Flow: Alert Lifecycle","permalink":"/docs/backend/flows/alert-lifecycle-flow"}}');var t=r(31085),s=r(71184);const a={},c="Feature Marketplace",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/common/manifest</code>",id:"internalcommonmanifest",level:3},{value:"<code>internal/features</code>",id:"internalfeatures",level:3},{value:"Bundled Feature Manifests (<code>internal/features/manifests/</code>)",id:"bundled-feature-manifests-internalfeaturesmanifests",level:3},{value:"<code>internal/features/verification</code>",id:"internalfeaturesverification",level:3},{value:"<code>internal/features/updates</code>",id:"internalfeaturesupdates",level:3},{value:"<code>internal/registry</code>",id:"internalregistry",level:3},{value:"<code>internal/features/sharing</code>",id:"internalfeaturessharing",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Feature Installation",id:"feature-installation",level:3},{value:"Atomic Update",id:"atomic-update",level:3},{value:"Crash Recovery",id:"crash-recovery",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function l(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"feature-marketplace",children:"Feature Marketplace"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Downloadable privacy and network services for MikroTik routers: manifest-driven binary distribution, cryptographic verification, atomic updates, config migration, and service import/export."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Packages:"})," ",(0,t.jsx)(n.code,{children:"internal/features/"}),", ",(0,t.jsx)(n.code,{children:"internal/features/updates/"}),", ",(0,t.jsx)(n.code,{children:"internal/features/sharing/"}),", ",(0,t.jsx)(n.code,{children:"internal/features/verification/"}),", ",(0,t.jsx)(n.code,{children:"internal/registry/"}),", ",(0,t.jsx)(n.code,{children:"internal/common/manifest/"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Key Files:"})," ",(0,t.jsx)(n.code,{children:"features/download.go"}),", ",(0,t.jsx)(n.code,{children:"features/config_migrator.go"}),", ",(0,t.jsx)(n.code,{children:"common/manifest/manifest.go"}),", ",(0,t.jsx)(n.code,{children:"features/updates/engine.go"}),", ",(0,t.jsx)(n.code,{children:"features/updates/journal.go"}),", ",(0,t.jsx)(n.code,{children:"features/updates/updater.go"}),", ",(0,t.jsx)(n.code,{children:"features/updates/scheduler.go"}),", ",(0,t.jsx)(n.code,{children:"features/verification/verifier.go"}),", ",(0,t.jsx)(n.code,{children:"features/verification/gpg_verify.go"}),", ",(0,t.jsx)(n.code,{children:"features/sharing/import.go"}),", ",(0,t.jsx)(n.code,{children:"registry/github.go"}),", ",(0,t.jsx)(n.code,{children:"registry/http.go"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Prerequisites:"})," [See: service-orchestrator.md \xa7InstanceManager], [See: data-layer.md \xa7FeatureRegistry]"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.p,{children:["The Feature Marketplace is a plugin system that extends a base MikroTik router management installation with downloadable network services. Each ",(0,t.jsx)(n.strong,{children:"feature"})," is a standalone binary (Tor, sing-box, Xray-core, MTProxy, Psiphon, AdGuard Home) described by a ",(0,t.jsx)(n.strong,{children:"manifest"})," that declares:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Resource requirements (RAM, disk, ports, architecture)"}),"\n",(0,t.jsx)(n.li,{children:"Binary download source (GitHub Releases with architecture mapping)"}),"\n",(0,t.jsx)(n.li,{children:"Configuration schema and defaults"}),"\n",(0,t.jsx)(n.li,{children:"Health check probes"}),"\n",(0,t.jsx)(n.li,{children:"Container port mappings"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The system handles the full feature lifecycle:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Browse \u2192 Install \u2192 Configure \u2192 Run \u2192 Monitor \u2192 Update \u2192 Rollback\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["Feature Marketplace"]\n    A --\x3e A1["FeatureRegistry<br/>embedded manifests<br/>JSON files in binary"]\n    A1 --\x3e A1A["manifest.go<br/>types & parsing<br/>internal/common/manifest"]\n\n    A --\x3e A2["DownloadManager<br/>download + SHA256 verification<br/>+ progress events"]\n    A2 --\x3e A2A["registry/http.go<br/>raw HTTP download<br/>with resume support"]\n\n    A --\x3e A3["Verifier<br/>SHA256 checksum +<br/>GPG signature verification"]\n    A3 --\x3e A3A["gpg_verify.go<br/>OpenPGP detached<br/>signature support"]\n\n    A --\x3e A4["MigratorRegistry<br/>per-feature config<br/>schema migrations"]\n\n    A --\x3e A5["UpdateEngine<br/>6-phase atomic update<br/>with journal + rollback"]\n    A5 --\x3e A5A["UpdateJournal<br/>SQLite WAL-mode<br/>crash-safe journal"]\n    A5 --\x3e A5B["UpdateService<br/>GitHub Releases<br/>version check<br/>ETag cached"]\n    A5 --\x3e A5C["UpdateScheduler<br/>periodic check<br/>+ quiet hours<br/>+ auto-apply"]\n\n    A --\x3e A6["registry/GitHubClient<br/>GitHub Releases API<br/>ETag caching<br/>rate limit aware"]\n\n    A --\x3e A7["sharing/Service<br/>export/import<br/>service configurations"]\n    A7 --\x3e A7A["import.go<br/>validation<br/>conflict detection<br/>dry-run"]'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,t.jsx)(n.h3,{id:"internalcommonmanifest",children:(0,t.jsx)(n.code,{children:"internal/common/manifest"})}),"\n",(0,t.jsx)(n.p,{children:"The canonical manifest type, shared across all feature-related packages."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"Manifest"})," struct"]})," (defined in ",(0,t.jsx)(n.code,{children:"manifest.go"}),"):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type Manifest struct {\n    ID          string   // "tor", "singbox", "xray", etc.\n    Name        string\n    Description string\n    Version     string\n    Category    string   // "Privacy", "VPN", etc.\n    Tags        []string\n\n    // Requirements\n    Architectures      []string // ["amd64", "arm64", "arm"]\n    MinRouterOSVersion string\n    RequiredPorts      []int\n    RequiredMemoryMB   int\n    RequiredDiskMB     int\n    MinRAM             int64   // bytes\n    RecommendedRAM     int64\n    CPUWeight          int     // relative scheduling weight\n\n    // Container configuration\n    DockerImage     string\n    DockerTag       string\n    EnvironmentVars map[string]string\n    Volumes         []VolumeMount\n    Ports           []PortMapping\n    NetworkMode     string\n\n    // Configuration\n    ConfigSchema  json.RawMessage // JSON Schema for user config\n    DefaultConfig map[string]any\n\n    // Binary source (for direct binary download, not Docker)\n    Source *Source\n\n    // Health monitoring\n    HealthCheck *HealthSpec\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"Source"})," \u2014 GitHub binary download descriptor:"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type Source struct {\n    GitHubOwner   string\n    GitHubRepo    string\n    BinaryName    string\n    ArchiveFormat string            // "tar.gz", "zip", "none"\n    ExtractPath   string            // filename inside archive\n    AssetArchMap  map[string]string // "amd64" \u2192 "linux-amd64"\n    ChecksumFiles []string          // ["checksums.txt", "SHA256SUMS"]\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"HealthSpec"})})," \u2014 Health check probe configuration:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type HealthSpec struct {\n    Type               string // "tcp", "http", "socks5"\n    TCPAddress         string\n    HTTPEndpoint       string\n    HTTPExpectedStatus int\n    IntervalSeconds    int\n    FailureThreshold   int\n    TimeoutSeconds     int\n    AutoRestart        bool\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"VerificationSpec"})})," and ",(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"GPGSpec"})})," \u2014 optional GPG signature verification configuration."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key functions:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'func ParseJSONBytes(data []byte) (*Manifest, error)\nfunc (m *Manifest) SupportsArchitecture(arch string) bool\nfunc (m *Manifest) GetFullImageName() string\nfunc NormalizeArchitecture(arch string) string  // "armv7l" \u2192 "arm", "aarch64" \u2192 "arm64"\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalfeatures",children:(0,t.jsx)(n.code,{children:"internal/features"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"manifest.go"})})," \u2014 type aliases re-exporting ",(0,t.jsx)(n.code,{children:"internal/common/manifest"})," types. This keeps the ",(0,t.jsx)(n.code,{children:"features"})," package as the single import point for callers."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"download.go"})," \u2014 DownloadManager"]})}),"\n",(0,t.jsx)(n.p,{children:"Downloads feature binaries with progress tracking, SHA256 verification, and event publishing."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type DownloadManager struct {\n    eventBus        events.EventBus\n    httpClient      *http.Client        // 30-minute timeout\n    baseDir         string\n    activeDownloads map[string]*DownloadProgress\n}\n\ntype DownloadProgress struct {\n    FeatureID       string\n    BytesDownloaded int64\n    TotalBytes      int64\n    Percent         float64\n    Status          string  // "starting", "downloading", "verifying", "complete", "failed"\n    Error           error\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"Download(ctx, featureID, url, expectedChecksum)"})})," flow:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Check for duplicate in-progress download (returns error if duplicate)"}),"\n",(0,t.jsxs)(n.li,{children:["Emit ",(0,t.jsx)(n.code,{children:"starting"})," progress event"]}),"\n",(0,t.jsxs)(n.li,{children:["Create ",(0,t.jsx)(n.code,{children:"{baseDir}/{featureID}/bin/"})," directory"]}),"\n",(0,t.jsx)(n.li,{children:"Download to temporary file via HTTP"}),"\n",(0,t.jsxs)(n.li,{children:["Verify SHA256 checksum against ",(0,t.jsx)(n.code,{children:"expectedChecksum"})]}),"\n",(0,t.jsx)(n.li,{children:"Atomic rename: temp \u2192 final path"}),"\n",(0,t.jsxs)(n.li,{children:["Set executable bit (",(0,t.jsx)(n.code,{children:"0o755"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Emit progress events at each step; ",(0,t.jsx)(n.code,{children:"failed"})," on any error"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Progress events are published to the event bus and consumed by the GraphQL subscription resolver to stream live download progress to the UI."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"config_migrator.go"})," \u2014 ConfigMigrator"]})}),"\n",(0,t.jsx)(n.p,{children:"Handles config schema evolution across feature versions."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type ConfigMigrator interface {\n    Migrate(ctx, oldVersion, newVersion string, config map[string]interface{}) (map[string]interface{}, error)\n    CanMigrate(oldVersion, newVersion string) bool\n    SupportedVersions() []string\n}\n\ntype NoOpMigrator struct{}  // Pass-through for features without migration needs\n\ntype MigratorRegistry struct {\n    migrators map[string]ConfigMigrator  // featureID \u2192 migrator\n}\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (r *MigratorRegistry) Register(featureID string, migrator ConfigMigrator) error\nfunc (r *MigratorRegistry) Get(featureID string) (ConfigMigrator, bool)\nfunc (r *MigratorRegistry) GetOrDefault(featureID string) ConfigMigrator  // returns NoOpMigrator if not found\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.h3,{id:"bundled-feature-manifests-internalfeaturesmanifests",children:["Bundled Feature Manifests (",(0,t.jsx)(n.code,{children:"internal/features/manifests/"}),")"]}),"\n",(0,t.jsx)(n.p,{children:"Six manifests are embedded in the binary at build time:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Manifest"}),(0,t.jsx)(n.th,{children:"ID"}),(0,t.jsx)(n.th,{children:"Category"}),(0,t.jsx)(n.th,{children:"Min RAM"}),(0,t.jsx)(n.th,{children:"Ports"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"tor.json"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"tor"})}),(0,t.jsx)(n.td,{children:"Privacy"}),(0,t.jsx)(n.td,{children:"30 MB"}),(0,t.jsx)(n.td,{children:"9001, 9030"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"singbox.json"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"singbox"})}),(0,t.jsx)(n.td,{children:"VPN"}),(0,t.jsx)(n.td,{children:"15 MB"}),(0,t.jsx)(n.td,{children:"1080, 8080"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"xray.json"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"xray"})}),(0,t.jsx)(n.td,{children:"VPN"}),(0,t.jsx)(n.td,{children:"15 MB"}),(0,t.jsx)(n.td,{children:"1080, 8080"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"mtproxy.json"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"mtproxy"})}),(0,t.jsx)(n.td,{children:"Privacy"}),(0,t.jsx)(n.td,{children:"8 MB"}),(0,t.jsx)(n.td,{children:"443"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"psiphon.json"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"psiphon"})}),(0,t.jsx)(n.td,{children:"Privacy"}),(0,t.jsx)(n.td,{children:"10 MB"}),(0,t.jsx)(n.td,{children:"varies"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"adguard.json"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"adguard"})}),(0,t.jsx)(n.td,{children:"Monitoring"}),(0,t.jsx)(n.td,{children:"32 MB"}),(0,t.jsx)(n.td,{children:"53, 80, 3000"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["Architecture support: all features support ",(0,t.jsx)(n.code,{children:"amd64"}),", ",(0,t.jsx)(n.code,{children:"arm64"}),", ",(0,t.jsx)(n.code,{children:"arm"})," (matching MikroTik CHR and router hardware)."]}),"\n",(0,t.jsxs)(n.p,{children:["Binary source: GitHub Releases with per-architecture asset naming (e.g., Tor ",(0,t.jsx)(n.code,{children:"linux-amd64"}),", sing-box ",(0,t.jsx)(n.code,{children:"linux_amd64"}),")."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalfeaturesverification",children:(0,t.jsx)(n.code,{children:"internal/features/verification"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"verifier.go"})," \u2014 Verifier"]})}),"\n",(0,t.jsx)(n.p,{children:"Main entry point for binary verification."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type Verifier struct {\n    publisher *events.Publisher\n}\n\ntype Result struct {\n    Valid       bool\n    Checksum    string  // SHA256 hex\n    VerifiedAt  string  // RFC3339\n    GPGResult   *GPGVerificationResult  // nil if GPG not performed\n}\n\ntype VerifyError struct {\n    FilePath string\n    Expected string\n    Actual   string\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"VerifyArchive(ctx, archivePath, checksumsPath, checksumsURL string, spec *Spec)"})})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Parse checksums file (GNU ",(0,t.jsx)(n.code,{children:"sha256sum"})," format: ",(0,t.jsx)(n.code,{children:"hash  filename"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Match archive filename to checksum entry"}),"\n",(0,t.jsx)(n.li,{children:"Compute SHA256 of downloaded archive"}),"\n",(0,t.jsx)(n.li,{children:"Compare hashes (constant-time comparison)"}),"\n",(0,t.jsxs)(n.li,{children:["Optionally verify GPG signature if ",(0,t.jsx)(n.code,{children:"Spec.GPG != nil"})]}),"\n",(0,t.jsxs)(n.li,{children:["Publish ",(0,t.jsx)(n.code,{children:"verification.complete"})," event"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"gpg_verify.go"})," \u2014 GPG Verification"]})}),"\n",(0,t.jsx)(n.p,{children:"Optional cryptographic signature verification using OpenPGP."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type GPGVerificationResult struct {\n    Valid       bool\n    KeyID       string\n    Fingerprint string\n    SignedBy    string\n    SignedAt    string\n    Error       error\n}\n\nfunc VerifyGPGSignature(ctx, filePath, signaturePath string, spec *GPGSpec) (*GPGVerificationResult, error)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Supports both armored (",(0,t.jsx)(n.code,{children:".asc"}),") and binary (",(0,t.jsx)(n.code,{children:".sig"}),") detached signatures. Falls back from armored to binary format automatically."]}),"\n",(0,t.jsxs)(n.p,{children:["Key retrieval: downloads public key from ",(0,t.jsx)(n.code,{children:"spec.KeyServerURL"})," if not cached locally."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Note: ",(0,t.jsx)(n.code,{children:"ErrGPGNotImplemented"})," is returned for features that declare GPG but the current release hasn't wired the key server. This is intentional \u2014 GPG is opt-in at the manifest level."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalfeaturesupdates",children:(0,t.jsx)(n.code,{children:"internal/features/updates"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"updater.go"})," \u2014 UpdateService"]})}),"\n",(0,t.jsx)(n.p,{children:"Version comparison and update metadata retrieval."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type UpdateSeverity string\nconst (\n    SeverityCritical UpdateSeverity = "CRITICAL"  // Security fixes\n    SeverityMajor    UpdateSeverity = "MAJOR"     // Breaking changes\n    SeverityMinor    UpdateSeverity = "MINOR"     // New features\n    SeverityPatch    UpdateSeverity = "PATCH"     // Bug fixes\n)\n\ntype UpdateInfo struct {\n    FeatureID        string\n    CurrentVersion   string\n    AvailableVersion string\n    Severity         UpdateSeverity\n    ReleaseNotes     string\n    PublishedAt      string\n    DownloadURL      string\n    ChecksumURL      string\n    Size             int64\n    Architecture     string\n}\n\nfunc (s *UpdateService) CheckForUpdate(ctx, featureID, currentVersion string) (*UpdateInfo, bool, error)\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Version comparison uses ",(0,t.jsx)(n.code,{children:"golang.org/x/mod/semver"}),". Severity is derived from semver bump type (major/minor/patch) with special-case ",(0,t.jsx)(n.code,{children:"CRITICAL"})," tag detection from release title."]}),"\n",(0,t.jsxs)(n.p,{children:["Uses ",(0,t.jsx)(n.code,{children:"GitHubClient.FetchLatestRelease"})," with ETag caching \u2014 no API calls if release hasn't changed."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"engine.go"})," \u2014 UpdateEngine"]})}),"\n",(0,t.jsx)(n.p,{children:"6-phase atomic update with crash recovery:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type UpdatePhase string\nconst (\n    PhaseStaging    UpdatePhase = "STAGING"    // 1. Download + verify new binary\n    PhaseBackup     UpdatePhase = "BACKUP"     // 2. Backup current binary + config\n    PhaseSwap       UpdatePhase = "SWAP"       // 3. Atomic rename new \u2192 current\n    PhaseMigration  UpdatePhase = "MIGRATION"  // 4. Run config migration\n    PhaseValidation UpdatePhase = "VALIDATION" // 5. Start + health check\n    PhaseCommit     UpdatePhase = "COMMIT"     // 6. Finalize (delete backup)\n    PhaseRollback   UpdatePhase = "ROLLBACK"   // restore backup on any failure\n)\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"UpdateEngine"})," dependencies:"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type UpdateEngineConfig struct {\n    DownloadManager  *DownloadManager\n    Verifier         *Verifier\n    Journal          *UpdateJournal\n    MigratorRegistry *MigratorRegistry\n    PathResolver     storage.PathResolverPort\n    BaseDir          string   // default: /var/lib/nasnet\n    EventBus         events.EventBus\n    HealthChecker    HealthChecker   // GetStatus(instanceID) (string, error)\n    InstanceStopper  InstanceStopper // Stop(ctx, instanceID) error\n    InstanceStarter  InstanceStarter // Start(ctx, instanceID) error\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Update flow:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"1. STAGING:    Download new binary to staging area, verify SHA256 + optional GPG\n2. BACKUP:     Copy current binary to {instanceID}.bak, backup config\n3. SWAP:       Atomic os.Rename(staged \u2192 current) \u2014 power-safe on POSIX\n4. MIGRATION:  MigratorRegistry.Get(featureID).Migrate(oldVer, newVer, config)\n5. VALIDATION: InstanceStarter.Start + HealthChecker.GetStatus (retry up to threshold)\n6. COMMIT:     Delete backup files, update DB version field\n           \u2514\u2500\u2500 On any failure after BACKUP: ROLLBACK phase restores backup\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Each phase transition is logged to ",(0,t.jsx)(n.code,{children:"UpdateJournal"})," before execution \u2014 enables crash recovery on restart."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"journal.go"})," \u2014 UpdateJournal"]})}),"\n",(0,t.jsxs)(n.p,{children:["Power-safe SQLite journal using WAL mode and ",(0,t.jsx)(n.code,{children:"PRAGMA synchronous=FULL"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type UpdateJournal struct {\n    db *sql.DB  // modernc.org/sqlite (pure Go, no CGO)\n}\n\ntype JournalEntry struct {\n    InstanceID   string\n    FeatureID    string\n    FromVersion  string\n    ToVersion    string\n    Phase        UpdatePhase\n    Status       string       // "pending", "success", "failed"\n    StartedAt    time.Time\n    CompletedAt  *time.Time\n    ErrorMessage string\n    Metadata     map[string]interface{}\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["On startup, ",(0,t.jsx)(n.code,{children:"UpdateEngine"})," checks the journal for incomplete updates (status=",(0,t.jsx)(n.code,{children:"pending"}),") and resumes or rolls them back."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"scheduler.go"})," \u2014 UpdateScheduler"]})}),"\n",(0,t.jsx)(n.p,{children:"Periodic background update checking with quiet hours support."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type UpdateSchedulerConfig struct {\n    UpdateService   *UpdateService\n    UpdateEngine    *UpdateEngine\n    Store           *ent.Client\n    EventBus        events.EventBus\n    CheckInterval   time.Duration // default: 6 hours\n    QuietHoursStart string        // HH:MM, e.g., "02:00"\n    QuietHoursEnd   string        // HH:MM, e.g., "06:00"\n    Timezone        string        // IANA, e.g., "America/New_York"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Quiet hours prevent auto-updates during peak usage hours. Checks respect ",(0,t.jsx)(n.code,{children:"auto_update"})," flag per service instance \u2014 if ",(0,t.jsx)(n.code,{children:"false"}),", only notifies via event (does not apply update)."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalregistry",children:(0,t.jsx)(n.code,{children:"internal/registry"})}),"\n",(0,t.jsx)(n.p,{children:"Low-level HTTP and GitHub Releases utilities."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"github.go"})," \u2014 GitHubClient"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type GitHubClient struct {\n    httpClient  *http.Client\n    etags       map[string]string   // URL \u2192 ETag cache\n    userAgent   string              // "NasNetConnect-UpdateManager/1.0"\n    maxRespSize int64               // 10 MB default\n}\n\ntype GitHubRelease struct {\n    TagName     string\n    Name        string\n    Body        string        // release notes\n    PublishedAt string\n    Assets      []GitHubAsset\n}\n\ntype GitHubAsset struct {\n    Name               string\n    BrowserDownloadURL string\n    Size               int64\n    ContentType        string\n}\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (gc *GitHubClient) FetchLatestRelease(ctx, owner, repo string) (*GitHubRelease, bool, error)\n// Returns: (release, wasModified, error)\n// wasModified=false if 304 Not Modified (ETag cache hit)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["ETag caching avoids repeated API calls for unchanged releases. Thread-safe via ",(0,t.jsx)(n.code,{children:"sync.RWMutex"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"http.go"})," \u2014 DownloadFile"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type DownloadConfig struct {\n    URL         string\n    DestPath    string\n    Timeout     time.Duration   // default: 5 minutes\n    ResumeFrom  int64           // byte offset for resume\n    MaxFileSize int64           // default: 500 MB\n    ProgressFn  func(downloaded, total int64)\n    HTTPClient  *http.Client\n}\n\nfunc DownloadFile(ctx context.Context, cfg DownloadConfig) (*DownloadResult, error)\n"})}),"\n",(0,t.jsx)(n.p,{children:"Supports HTTP range requests for download resumption. Progress callback enables live UI updates."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalfeaturessharing",children:(0,t.jsx)(n.code,{children:"internal/features/sharing"})}),"\n",(0,t.jsx)(n.p,{children:"Service configuration export and import for sharing between router instances."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"import.go"})})," \u2014 validation types and import logic:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type ImportValidationResult struct {\n    Valid                bool\n    Errors               []ValidationError        // blocking\n    Warnings             []ValidationWarning      // non-blocking\n    RedactedFields       []string                 // fields requiring user input\n    ConflictingInstances []*ent.ServiceInstance\n    RequiresUserInput    bool\n}\n\ntype ValidationError struct {\n    Stage   string  // "schema", "syntax", "cross-resource", "dependency", "conflict", "capability", "dry-run"\n    Field   string\n    Code    string  // "V400", "V403", "S602", etc.\n    Message string\n}\n\ntype ConflictResolutionStrategy string\nconst (\n    ConflictSkip      ConflictResolutionStrategy = "SKIP"\n    ConflictOverwrite ConflictResolutionStrategy = "OVERWRITE"\n    ConflictRename    ConflictResolutionStrategy = "RENAME"\n)\n\ntype ImportOptions struct {\n    RouterID            string\n    UserID              string\n    ConflictResolution  ConflictResolutionStrategy\n    RedactedFieldValues map[string]interface{}   // user-supplied for sensitive fields\n    DeviceFilter        []string                 // MAC addresses to filter\n    DryRun              bool\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"import_operations.go"})})," \u2014 Multi-stage validation pipeline:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Schema validation \u2014 package format correctness"}),"\n",(0,t.jsx)(n.li,{children:"Syntax validation \u2014 field types, required fields"}),"\n",(0,t.jsx)(n.li,{children:"Cross-resource validation \u2014 referenced instances exist"}),"\n",(0,t.jsx)(n.li,{children:"Dependency validation \u2014 dependency chain satisfiable"}),"\n",(0,t.jsx)(n.li,{children:"Conflict detection \u2014 name or port collisions"}),"\n",(0,t.jsx)(n.li,{children:"Capability check \u2014 router supports required features"}),"\n",(0,t.jsx)(n.li,{children:"Dry-run \u2014 simulate import without DB writes"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"ServiceExportPackage"})})," \u2014 contains serialized service config, routing rules, and device assignments (with sensitive fields redacted)."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,t.jsx)(n.h3,{id:"feature-installation",children:"Feature Installation"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["User clicks Install Tor"]\n    A --\x3e B["GraphQL: installFeature<br/>featureID: tor<br/>instanceName: my-relay"]\n\n    B --\x3e B1["FeatureRegistry.GetManifest tor<br/>\u2192 Manifest"]\n    B --\x3e B2["Validate: architecture supported<br/>ports available, RAM available"]\n    B --\x3e B3["Create ServiceInstance record<br/>status=installing"]\n    B --\x3e B4["DownloadManager.Download<br/>ctx, tor, url, checksum"]\n    B4 --\x3e B4A["HTTP GET with 30-min timeout"]\n    B4 --\x3e B4B["Progress events<br/>\u2192 GraphQL subscription<br/>\u2192 UI progress bar"]\n    B4 --\x3e B4C["SHA256 verify<br/>\u2192 Verifier.VerifyArchive"]\n\n    B --\x3e B5["Extract archive: tar.gz<br/>\u2192 binary at<br/>baseDir/tor/bin/tor"]\n    B --\x3e B6["Set binary as executable"]\n    B --\x3e B7["Update ServiceInstance<br/>status=installed, binary_path=..."]'}),"\n",(0,t.jsx)(n.h3,{id:"atomic-update",children:"Atomic Update"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["UpdateScheduler fires<br/>every 6 hours, outside quiet hours"]\n    A --\x3e A1["For each auto_update=true<br/>ServiceInstance"]\n    A1 --\x3e A2["UpdateService.CheckForUpdate<br/>\u2192 GitHub API<br/>ETag cached"]\n    A2 --\x3e A3["if new version available"]\n\n    A3 --\x3e B["UpdateEngine.ApplyUpdate<br/>ctx, instanceID, updateInfo"]\n\n    B --\x3e B1["Phase STAGING<br/>Download new binary<br/>to baseDir/id/staging/"]\n    B1 --\x3e B1A["Verifier.VerifyArchive<br/>\u2192 SHA256 + optional GPG"]\n    B1 --\x3e B1B["Journal.Record<br/>STAGING, success"]\n\n    B --\x3e B2["Phase BACKUP<br/>Copy current binary<br/>\u2192 id.bak"]\n    B2 --\x3e B2A["Journal.Record<br/>BACKUP, success"]\n\n    B --\x3e B3["Phase SWAP<br/>os.Rename staging \u2192 current<br/>\u2190 atomic on POSIX"]\n    B3 --\x3e B3A["Journal.Record<br/>SWAP, success"]\n\n    B --\x3e B4["Phase MIGRATION<br/>MigratorRegistry.Get featureID<br/>.Migrate oldVer, newVer, config"]\n    B4 --\x3e B4A["Journal.Record<br/>MIGRATION, success"]\n\n    B --\x3e B5["Phase VALIDATION<br/>InstanceStarter.Start instanceID"]\n    B5 --\x3e B5A["HealthChecker.GetStatus<br/>\u2192 poll until HEALTHY or timeout"]\n    B5 --\x3e B5B["Journal.Record<br/>VALIDATION, success"]\n\n    B --\x3e B6["Phase COMMIT<br/>Delete .bak file"]\n    B6 --\x3e B6A["Update ServiceInstance.version<br/>in DB"]\n    B6 --\x3e B6B["Journal.Record<br/>COMMIT, success"]\n\n    B --\x3e B7["On failure at any phase<br/>ROLLBACK: restore .bak<br/>restart old version"]\n    B7 --\x3e B7A["Journal.Record<br/>ROLLBACK, ..."]\n\n    B --\x3e C["Publish UpdateCompleted<br/>UpdateFailed event"]'}),"\n",(0,t.jsx)(n.h3,{id:"crash-recovery",children:"Crash Recovery"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["Power loss during Phase SWAP"]\n    A --\x3e B["System restarts"]\n    B --\x3e C["UpdateEngine.RecoverIncompleteUpdates"]\n\n    C --\x3e C1["Query UpdateJournal<br/>for status=pending entries"]\n    C --\x3e C2["For each incomplete update"]\n\n    C2 --\x3e C2A["If phase < SWAP:<br/>clean up staging<br/>no recovery needed"]\n    C2 --\x3e C2B["If phase >= SWAP but < COMMIT<br/>ROLLBACK \u2192 restore backup"]\n    C2 --\x3e C2C["If phase = COMMIT<br/>complete commit<br/>delete .bak"]\n\n    C --\x3e D["Log recovery outcome"]'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Feature storage layout (via ",(0,t.jsx)(n.code,{children:"storage.PathResolverPort"}),"):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"{baseDir}/\n    {featureID}/\n        bin/\n            {binaryName}        # Current binary\n            {binaryName}.bak    # Backup during update\n        staging/\n            {binaryName}        # New binary being staged\n        config/\n            config.json         # User config\n        logs/\n            {instanceID}.log    # Log output\n        update-journal.db       # SQLite WAL journal\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Default ",(0,t.jsx)(n.code,{children:"baseDir"}),": ",(0,t.jsx)(n.code,{children:"/var/lib/nasnet"})," (production), configurable via ",(0,t.jsx)(n.code,{children:"UpdateEngineConfig.BaseDir"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"GitHub rate limiting:"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"GitHubClient"})," uses ETag caching to stay within GitHub's unauthenticated rate limit (60 req/hour). With the default 6-hour check interval and ETag cache hits returning 304 (no quota cost), 6 features would consume at most 1 API request per check cycle when releases haven't changed."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error"}),(0,t.jsx)(n.th,{children:"Behavior"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Download network failure"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"DownloadManager"})," sets status ",(0,t.jsx)(n.code,{children:"failed"}),", publishes error event; retry is user-triggered"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"SHA256 mismatch"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"Verifier"})," returns ",(0,t.jsx)(n.code,{children:"VerifyError"}),"; downloaded file deleted"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"GPG verification failure"}),(0,t.jsxs)(n.td,{children:["Returns error if ",(0,t.jsx)(n.code,{children:"RequireGPG=true"}),"; skipped if ",(0,t.jsx)(n.code,{children:"false"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Update STAGING failure"}),(0,t.jsx)(n.td,{children:"No rollback needed; staging directory cleaned up"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Update POST-SWAP failure"}),(0,t.jsx)(n.td,{children:"Full ROLLBACK: binary + config restored from backup"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Import conflict"}),(0,t.jsxs)(n.td,{children:["Returns ",(0,t.jsx)(n.code,{children:"ValidationError"})," with code and resolution options"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Import dry-run failure"}),(0,t.jsx)(n.td,{children:"Returns validation result without DB changes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Journal write failure"}),(0,t.jsx)(n.td,{children:"Treated as critical \u2014 update aborted"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"internal/config/integration_test.go"})})}),"\n",(0,t.jsx)(n.p,{children:"Integration tests for service-specific config generation (adguard, tor, singbox, xray). Tests that config output matches expected structure for each architecture."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"features/sharing/import.go"})})}),"\n",(0,t.jsxs)(n.p,{children:["Extensive validation test coverage across all 7 validation stages. Mock ",(0,t.jsx)(n.code,{children:"FeatureRegistry"})," and ",(0,t.jsx)(n.code,{children:"ent.Client"})," used for isolation."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["[See: service-orchestrator.md \xa7lifecycle_installer] \u2014 ",(0,t.jsx)(n.code,{children:"DownloadManager"})," is called during installation"]}),"\n",(0,t.jsxs)(n.li,{children:["[See: service-orchestrator.md \xa7InstanceManager] \u2014 ",(0,t.jsx)(n.code,{children:"UpdateEngine"})," uses ",(0,t.jsx)(n.code,{children:"InstanceStopper"}),"/",(0,t.jsx)(n.code,{children:"InstanceStarter"})," interfaces from lifecycle"]}),"\n",(0,t.jsx)(n.li,{children:"[See: virtual-interface-factory.md \xa7BridgeOrchestrator] \u2014 Manifests drive VIF gateway configuration"}),"\n",(0,t.jsx)(n.li,{children:"[See: data-layer.md \xa7ServiceInstance] \u2014 Ent schema stores version, binary_path, auto_update flags"}),"\n",(0,t.jsx)(n.li,{children:"[See: event-system.md] \u2014 Download progress, update lifecycle, and verification events"}),"\n",(0,t.jsx)(n.li,{children:"[See: graphql-api.md \xa7services] \u2014 GraphQL mutations for install, update, import/export"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>c});var i=r(14041);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);