"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[43138],{12132:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"event-system","title":"Event System","description":"Typed, priority-based event bus built on Watermill GoChannel, connecting all backend subsystems through decoupled publish-subscribe communication.","source":"@site/../backend/docs/event-system.md","sourceDirName":".","slug":"/event-system","permalink":"/docs/backend/event-system","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/event-system.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Error Handling & Structured Logging","permalink":"/docs/backend/error-handling"},"next":{"title":"Feature Marketplace","permalink":"/docs/backend/feature-marketplace"}}');var s=t(31085),i=t(71184);const l={},c="Event System",d={},o=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"internal/events/types.go",id:"internaleventstypesgo",level:3},{value:"Event interface",id:"event-interface",level:4},{value:"BaseEvent",id:"baseevent",level:4},{value:"EventMetadata",id:"eventmetadata",level:4},{value:"Priority System",id:"priority-system",level:3},{value:"internal/events/bus.go",id:"internaleventsbusgo",level:3},{value:"EventBus interface",id:"eventbus-interface",level:4},{value:"NewEventBus",id:"neweventbus",level:4},{value:"SubscribableEventBus",id:"subscribableeventbus",level:4},{value:"internal/events/publisher_all.go",id:"internaleventspublisher_allgo",level:3},{value:"internal/events/bus_support.go",id:"internaleventsbus_supportgo",level:3},{value:"ParseEvent",id:"parseevent",level:4},{value:"priorityQueueManager",id:"priorityqueuemanager",level:4},{value:"Domain Event Types",id:"domain-event-types",level:3},{value:"Core Events (domain_events_core.go)",id:"core-events-domain_events_corego",level:4},{value:"Service Events (domain_events_service.go)",id:"service-events-domain_events_servicego",level:4},{value:"Storage Events (domain_events_service.go)",id:"storage-events-domain_events_servicego",level:4},{value:"Lifecycle Events (domain_events_lifecycle.go)",id:"lifecycle-events-domain_events_lifecyclego",level:4},{value:"Extended Events (domain_events_extended.go)",id:"extended-events-domain_events_extendedgo",level:4},{value:"internal/events/persistence_all.go",id:"internaleventspersistence_allgo",level:3},{value:"EventStore interface",id:"eventstore-interface",level:4},{value:"MemoryEventStore",id:"memoryeventstore",level:4},{value:"PersistentEventBus",id:"persistenteventbus",level:4},{value:"DailySync",id:"dailysync",level:4},{value:"internal/events/testing.go",id:"internaleventstestinggo",level:3},{value:"internal/events/classification.go",id:"internaleventsclassificationgo",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Publishing an Event",id:"publishing-an-event",level:3},{value:"Subscribing to Events",id:"subscribing-to-events",level:3},{value:"GraphQL Subscription Flow",id:"graphql-subscription-flow",level:3},{value:"Event Type Constants",id:"event-type-constants",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"event-system",children:"Event System"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Typed, priority-based event bus built on Watermill GoChannel, connecting all backend subsystems through decoupled publish-subscribe communication."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Packages:"})," ",(0,s.jsx)(n.code,{children:"internal/events/"}),"\n",(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"bus.go"}),", ",(0,s.jsx)(n.code,{children:"types.go"}),", ",(0,s.jsx)(n.code,{children:"publisher_all.go"}),", ",(0,s.jsx)(n.code,{children:"persistence_all.go"}),", ",(0,s.jsx)(n.code,{children:"testing.go"}),", ",(0,s.jsx)(n.code,{children:"bus_support.go"}),"\n",(0,s.jsx)(n.strong,{children:"Prerequisites:"})," [See: application-bootstrap.md \xa7Event System Bootstrap]"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The event system enables subsystems to communicate without direct coupling. Publishers emit typed events; subscribers receive and react to them. The bus is used for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"GraphQL subscriptions"})," - streaming real-time updates to the frontend"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Alert engine"})," - triggering alert evaluation on relevant events"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Audit logging"})," - recording significant security and operational events"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Orchestrator coordination"})," - service state changes driving lifecycle decisions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Cross-subsystem notifications"})," - storage, provisioning, isolation, templates"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The bus is backed by ",(0,s.jsx)(n.a,{href:"https://watermill.io/",children:"Watermill"})," ",(0,s.jsx)(n.code,{children:"GoChannel"})," (in-process pub/sub with configurable buffer). An optional ",(0,s.jsx)(n.code,{children:"PersistentEventBus"})," wrapper adds durable storage for critical events."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["Publisher<br/>(service/resolver)"]\n    B["EventBus.Publish"]\n    C{"Priority?"}\n    D["PriorityImmediate"]\n    E["Other Priorities"]\n    F["publishDirect<br/>(sync)"]\n    G["priorityQueueManager<br/>(async)"]\n    G1["Critical: 100ms"]\n    G2["Normal: 1s"]\n    G3["Low: 5s"]\n    G4["Background: 30s"]\n    H["Watermill<br/>GoChannel"]\n    I["Local Handlers"]\n    J["PersistentEventBus<br/>(optional)"]\n    K["EventStore<br/>Persistence"]\n\n    A --\x3e B\n    B --\x3e C\n    C --\x3e|Immediate| D\n    C --\x3e|Other| E\n    D --\x3e F\n    E --\x3e G\n    G --\x3e G1 & G2 & G3 & G4\n    G1 & G2 & G3 & G4 --\x3e F\n    F --\x3e H\n    F --\x3e I\n    H --\x3e I\n    H --\x3e J\n    J --\x3e K\n\n    style B fill:#4a90e2\n    style F fill:#7ed321\n    style H fill:#bd10e0\n    style K fill:#f5a623'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,s.jsx)(n.h3,{id:"internaleventstypesgo",children:"internal/events/types.go"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Core interfaces and base types."})}),"\n",(0,s.jsx)(n.h4,{id:"event-interface",children:"Event interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Event interface {\n    GetID() ulid.ULID\n    GetType() string\n    GetPriority() Priority\n    GetTimestamp() time.Time\n    GetSource() string\n    GetCorrelationID() string\n    Payload() ([]byte, error)\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"baseevent",children:"BaseEvent"}),"\n",(0,s.jsxs)(n.p,{children:["All domain events embed ",(0,s.jsx)(n.code,{children:"BaseEvent"})," to satisfy the ",(0,s.jsx)(n.code,{children:"Event"})," interface:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type BaseEvent struct {\n    ID        ulid.ULID     `json:"id"`\n    Type      string        `json:"type"`\n    Priority  Priority      `json:"priority"`\n    Timestamp time.Time     `json:"timestamp"`\n    Source    string        `json:"source"`\n    Metadata  EventMetadata `json:"metadata,omitempty"`\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Constructor:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewBaseEvent(eventType string, priority Priority, source string) BaseEvent\nfunc NewBaseEventWithMetadata(eventType string, priority Priority, source string, metadata EventMetadata) BaseEvent\n"})}),"\n",(0,s.jsx)(n.h4,{id:"eventmetadata",children:"EventMetadata"}),"\n",(0,s.jsx)(n.p,{children:"Carries distributed tracing correlation IDs and request context:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type EventMetadata struct {\n    CorrelationID string            `json:"correlationId,omitempty"`\n    CausationID   string            `json:"causationId,omitempty"`\n    UserID        string            `json:"userId,omitempty"`\n    RequestID     string            `json:"requestId,omitempty"`\n    RouterID      string            `json:"routerId,omitempty"`\n    Extra         map[string]string `json:"extra,omitempty"`\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"priority-system",children:"Priority System"}),"\n",(0,s.jsx)(n.p,{children:"Five priority levels control delivery latency and batching behavior:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Constant"}),(0,s.jsx)(n.th,{children:"Level"}),(0,s.jsx)(n.th,{children:"Target Latency"}),(0,s.jsx)(n.th,{children:"Batch Window"}),(0,s.jsx)(n.th,{children:"Persisted"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PriorityImmediate"})}),(0,s.jsx)(n.td,{children:"0"}),(0,s.jsx)(n.td,{children:"< 100ms"}),(0,s.jsx)(n.td,{children:"0 (no batching)"}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PriorityCritical"})}),(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:"< 1s"}),(0,s.jsx)(n.td,{children:"100ms"}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PriorityNormal"})}),(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:"< 5s"}),(0,s.jsx)(n.td,{children:"1s"}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PriorityLow"})}),(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"< 30s"}),(0,s.jsx)(n.td,{children:"5s"}),(0,s.jsx)(n.td,{children:"No"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PriorityBackground"})}),(0,s.jsx)(n.td,{children:"4"}),(0,s.jsx)(n.td,{children:"< 60s"}),(0,s.jsx)(n.td,{children:"30s"}),(0,s.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.code,{children:"PriorityImmediate"})," events bypass the queue entirely"]})," - they are published directly and synchronously."]}),"\n",(0,s.jsxs)(n.p,{children:["Helper methods on ",(0,s.jsx)(n.code,{children:"Priority"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (p Priority) TargetLatency() time.Duration\nfunc (p Priority) BatchWindow() time.Duration\nfunc (p Priority) ShouldPersist() bool\nfunc (p Priority) String() string\nfunc ParsePriority(s string) Priority\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internaleventsbusgo",children:"internal/events/bus.go"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"EventBus interface and Watermill implementation."})}),"\n",(0,s.jsx)(n.h4,{id:"eventbus-interface",children:"EventBus interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type EventBus interface {\n    Publish(ctx context.Context, event Event) error\n    Subscribe(eventType string, handler EventHandler) error\n    SubscribeAll(handler EventHandler) error\n    Close() error\n}\n\ntype EventHandler func(ctx context.Context, event Event) error\n"})}),"\n",(0,s.jsx)(n.h4,{id:"neweventbus",children:"NewEventBus"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewEventBus(opts EventBusOptions) (EventBus, error)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type EventBusOptions struct {\n    BufferSize         int                    // GoChannel buffer (default: 1000)\n    Logger             watermill.LoggerAdapter\n    ZapLogger          *zap.Logger\n    EnableReplay       bool\n    PersistenceEnabled bool\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Publish routing:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"PriorityImmediate"})," \u2192 ",(0,s.jsx)(n.code,{children:"publishDirect()"})," (synchronous, no batching)"]}),"\n",(0,s.jsxs)(n.li,{children:["All other priorities \u2192 ",(0,s.jsx)(n.code,{children:"priorityQueueManager.enqueue()"})," (batched delivery)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"publishDirect()"})," publishes to two Watermill topics:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["The specific event type topic (e.g., ",(0,s.jsx)(n.code,{children:'"router.status.changed"'}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:'"all"'})," catch-all topic"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Then it synchronously notifies all local Go handlers registered via ",(0,s.jsx)(n.code,{children:"Subscribe"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"subscribableeventbus",children:"SubscribableEventBus"}),"\n",(0,s.jsxs)(n.p,{children:["A typed extension of ",(0,s.jsx)(n.code,{children:"EventBus"})," providing type-safe subscription methods:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type SubscribableEventBus interface {\n    EventBus\n    OnRouterStatusChanged(handler func(ctx context.Context, event *RouterStatusChangedEvent) error) error\n    OnResourceUpdated(handler func(ctx context.Context, event *ResourceUpdatedEvent) error) error\n    OnFeatureCrashed(handler func(ctx context.Context, event *FeatureCrashedEvent) error) error\n    OnConfigApplyProgress(handler func(ctx context.Context, event *ConfigApplyProgressEvent) error) error\n    OnAuth(handler func(ctx context.Context, event *AuthEvent) error) error\n    OnFeatureInstalled(handler func(ctx context.Context, event *FeatureInstalledEvent) error) error\n    OnRouterConnected(handler func(ctx context.Context, event *RouterConnectedEvent) error) error\n    OnRouterDisconnected(handler func(ctx context.Context, event *RouterDisconnectedEvent) error) error\n    OnConfigApplied(handler func(ctx context.Context, event *ConfigAppliedEvent) error) error\n    OnRouterStatusChangedFor(routerID string, handler ...) error\n    OnResourceUpdatedFor(routerID string, handler ...) error\n    OnResourceUpdatedFiltered(filter ResourceFilter, handler ...) error\n}\n\nfunc NewSubscribableEventBus(opts EventBusOptions) (SubscribableEventBus, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"OnResourceUpdated"})," automatically subscribes to all three of ",(0,s.jsx)(n.code,{children:"ResourceCreated"}),", ",(0,s.jsx)(n.code,{children:"ResourceUpdated"}),", and ",(0,s.jsx)(n.code,{children:"ResourceDeleted"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ResourceFilter"})," allows per-router and per-resource-type filtering:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type ResourceFilter struct {\n    RouterID     string\n    ResourceType string\n    ChangeType   ChangeType // "create" | "update" | "delete"\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internaleventspublisher_allgo",children:"internal/events/publisher_all.go"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Publisher: convenience wrapper for publishing typed events."})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Publisher struct {\n    bus    EventBus\n    source string\n}\n\nfunc NewPublisher(bus EventBus, source string) *Publisher\nfunc (p *Publisher) Publish(ctx context.Context, event Event) error\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"Publisher"})," provides named methods for every domain event type, constructing the correct typed event and calling ",(0,s.jsx)(n.code,{children:"bus.Publish"}),". Example methods:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func (p *Publisher) PublishRouterStatusChanged(ctx context.Context, routerID string, status, previousStatus RouterStatus) error\nfunc (p *Publisher) PublishRouterStatusChangedWithError(ctx context.Context, routerID string, status, previousStatus RouterStatus, protocol, errorMessage string) error\nfunc (p *Publisher) PublishResourceCreated(ctx context.Context, resourceUUID ulid.ULID, resourceType, routerID string, version int) error\nfunc (p *Publisher) PublishResourceUpdated(ctx context.Context, resourceUUID ulid.ULID, resourceType, routerID string, version int, changedFields []string) error\nfunc (p *Publisher) PublishResourceDeleted(ctx context.Context, resourceUUID ulid.ULID, resourceType, routerID string) error\nfunc (p *Publisher) PublishAuthLogin(ctx context.Context, userID, ipAddress, userAgent string, success bool, failReason string) error\nfunc (p *Publisher) PublishAuthLogout(ctx context.Context, userID, ipAddress, userAgent string) error\nfunc (p *Publisher) PublishAuthSessionRevoked(ctx context.Context, userID, ipAddress, userAgent string) error\nfunc (p *Publisher) PublishAuthPasswordChanged(ctx context.Context, userID, ipAddress, userAgent string) error\nfunc (p *Publisher) PublishCredentialChanged(ctx context.Context, routerID, userID, ipAddress string) error\nfunc (p *Publisher) PublishFeatureCrashed(ctx context.Context, featureID, instanceID, routerID string, exitCode, crashCount int, lastError string, willRestart bool) error\nfunc (p *Publisher) PublishFeatureInstalled(ctx context.Context, featureID, featureName, version, routerID string) error\nfunc (p *Publisher) PublishStorageMounted(ctx context.Context, path string, totalMB, freeMB, usedMB uint64, usedPct float64, fsType string) error\nfunc (p *Publisher) PublishIsolationViolation(ctx context.Context, ...) error\nfunc (p *Publisher) PublishTemplateInstallStarted(ctx context.Context, ...) error\nfunc (p *Publisher) PublishBootSequenceStarted(ctx context.Context, instanceCount int, instanceIDs []string) error\n// ...and ~20 more typed publish methods\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The GraphQL resolver holds a ",(0,s.jsx)(n.code,{children:"*Publisher"})," and uses it after mutations:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'r.EventPublisher = events.NewPublisher(cfg.EventBus, "graphql-resolver")\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internaleventsbus_supportgo",children:"internal/events/bus_support.go"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Event parsing and priority queue management."})}),"\n",(0,s.jsx)(n.h4,{id:"parseevent",children:"ParseEvent"}),"\n",(0,s.jsx)(n.p,{children:"Deserializes a Watermill message back into a typed event:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func ParseEvent(msg *message.Message) (Event, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Uses a registry map ",(0,s.jsx)(n.code,{children:"eventFactories"})," (40+ entries) mapping event type strings to factory functions. Unknown types fall back to ",(0,s.jsx)(n.code,{children:"*BaseEvent"}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"priorityqueuemanager",children:"priorityQueueManager"}),"\n",(0,s.jsx)(n.p,{children:"Internal struct managing four queues (one per priority level):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type priorityQueueManager struct {\n    queues map[Priority][]Event\n    mu     sync.Mutex\n    stopCh chan struct{}\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"processPriorityQueues()"})," goroutine runs tickers at each priority's batch window:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Critical: 100ms ticker"}),"\n",(0,s.jsx)(n.li,{children:"Normal: 1s ticker"}),"\n",(0,s.jsx)(n.li,{children:"Low: 5s ticker"}),"\n",(0,s.jsx)(n.li,{children:"Background: 30s ticker"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["On each tick, ",(0,s.jsx)(n.code,{children:"drain()"})," removes all queued events for that priority and publishes them via ",(0,s.jsx)(n.code,{children:"publishDirect()"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"domain-event-types",children:"Domain Event Types"}),"\n",(0,s.jsxs)(n.p,{children:["Events are defined across several files in ",(0,s.jsx)(n.code,{children:"internal/events/"}),":"]}),"\n",(0,s.jsx)(n.h4,{id:"core-events-domain_events_corego",children:"Core Events (domain_events_core.go)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Priority"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"RouterStatusChangedEvent"})}),(0,s.jsx)(n.td,{children:"Immediate"}),(0,s.jsx)(n.td,{children:"Router connection status transitions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"RouterConnectedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Router connection established"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"RouterDisconnectedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Router connection lost"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CapabilitiesUpdatedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Router capabilities detected"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ResourceUpdatedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Resource created/updated/deleted"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"MetricUpdatedEvent"})}),(0,s.jsx)(n.td,{children:"Background"}),(0,s.jsx)(n.td,{children:"Interface statistics update"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LogAppendedEvent"})}),(0,s.jsx)(n.td,{children:"Background"}),(0,s.jsx)(n.td,{children:"Log entry appended"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ConfigApplyProgressEvent"})}),(0,s.jsx)(n.td,{children:"Critical"}),(0,s.jsx)(n.td,{children:"Config apply progress update"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ConfigAppliedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Config apply completed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"AuthEvent"})}),(0,s.jsx)(n.td,{children:"Critical"}),(0,s.jsx)(n.td,{children:"Auth login/logout/session/password events"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FeatureCrashedEvent"})}),(0,s.jsx)(n.td,{children:"Immediate"}),(0,s.jsx)(n.td,{children:"Feature process crash"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FeatureInstalledEvent"})}),(0,s.jsx)(n.td,{children:"Critical"}),(0,s.jsx)(n.td,{children:"Feature successfully installed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FeatureHealthChangedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Feature health state change"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"service-events-domain_events_servicego",children:"Service Events (domain_events_service.go)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Priority"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceStateChangedEvent"})}),(0,s.jsx)(n.td,{children:"Normal/Immediate"}),(0,s.jsxs)(n.td,{children:["Service state transitions; ",(0,s.jsx)(n.code,{children:"failed"}),"/",(0,s.jsx)(n.code,{children:"crashed"})," \u2192 Immediate"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceRestartedEvent"})}),(0,s.jsx)(n.td,{children:"Normal/Critical"}),(0,s.jsx)(n.td,{children:"Service restart (Critical if \u22653 crashes)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceHealthEvent"})}),(0,s.jsx)(n.td,{children:"Background"}),(0,s.jsx)(n.td,{children:"Health check result"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceCrashedEvent"})}),(0,s.jsx)(n.td,{children:"Immediate"}),(0,s.jsx)(n.td,{children:"Unexpected service crash"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceInstalledEvent"})}),(0,s.jsx)(n.td,{children:"Critical"}),(0,s.jsx)(n.td,{children:"Service installed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceRemovedEvent"})}),(0,s.jsx)(n.td,{children:"Critical"}),(0,s.jsx)(n.td,{children:"Service uninstalled"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceUpdateAvailableEvent"})}),(0,s.jsx)(n.td,{children:"Low"}),(0,s.jsx)(n.td,{children:"New version available"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceKillSwitchEvent"})}),(0,s.jsx)(n.td,{children:"Immediate"}),(0,s.jsx)(n.td,{children:"Emergency stop triggered"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceResourceWarningEvent"})}),(0,s.jsx)(n.td,{children:"Normal/Low/Critical"}),(0,s.jsx)(n.td,{children:"Resource threshold crossed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ServiceHealthFailingEvent"})}),(0,s.jsx)(n.td,{children:"Normal/Critical"}),(0,s.jsx)(n.td,{children:"Repeated health check failures"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Alert severity helpers:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func GetServiceEventSeverity(eventType string) AlertSeverity\nfunc GetServiceEventSeverityDynamic(event Event) AlertSeverity\n"})}),"\n",(0,s.jsx)(n.h4,{id:"storage-events-domain_events_servicego",children:"Storage Events (domain_events_service.go)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Priority"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StorageMountedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"External storage mounted"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StorageUnmountedEvent"})}),(0,s.jsx)(n.td,{children:"Critical"}),(0,s.jsx)(n.td,{children:"Storage unmounted unexpectedly"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StorageSpaceThresholdEvent"})}),(0,s.jsx)(n.td,{children:"Normal/Critical"}),(0,s.jsx)(n.td,{children:"Storage usage threshold crossed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StorageConfigChangedEvent"})}),(0,s.jsx)(n.td,{children:"Normal"}),(0,s.jsx)(n.td,{children:"Storage config updated"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"StorageUnavailableEvent"})}),(0,s.jsx)(n.td,{children:"Immediate"}),(0,s.jsx)(n.td,{children:"Feature's storage unavailable"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"lifecycle-events-domain_events_lifecyclego",children:"Lifecycle Events (domain_events_lifecycle.go)"}),"\n",(0,s.jsx)(n.p,{children:"Boot sequence, dependency graph, template installation events."}),"\n",(0,s.jsx)(n.h4,{id:"extended-events-domain_events_extendedgo",children:"Extended Events (domain_events_extended.go)"}),"\n",(0,s.jsx)(n.p,{children:"Binary verification, isolation violations, resource OOM, VLAN pool warnings, provisioning events."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internaleventspersistence_allgo",children:"internal/events/persistence_all.go"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"EventStore interface and persistence wrappers."})}),"\n",(0,s.jsx)(n.h4,{id:"eventstore-interface",children:"EventStore interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type EventStore interface {\n    PersistEvent(ctx context.Context, event Event) error\n    GetEventsSince(ctx context.Context, since time.Time) ([]Event, error)\n    GetUnprocessedEvents(ctx context.Context) ([]Event, error)\n    MarkProcessed(ctx context.Context, id ulid.ULID) error\n    ReplayEvents(ctx context.Context, handler EventHandler) error\n    Close() error\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"memoryeventstore",children:"MemoryEventStore"}),"\n",(0,s.jsx)(n.p,{children:"In-memory implementation for development and testing:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewMemoryEventStore(maxEvents int) *MemoryEventStore\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Only persists events where ",(0,s.jsx)(n.code,{children:"priority.ShouldPersist()"})," is true (Immediate, Critical, Normal)"]}),"\n",(0,s.jsx)(n.li,{children:"Evicts oldest 10% of events when at capacity"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReplayEvents()"})," processes unprocessed events and marks them complete"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"persistenteventbus",children:"PersistentEventBus"}),"\n",(0,s.jsxs)(n.p,{children:["Wraps any ",(0,s.jsx)(n.code,{children:"EventBus"})," and adds optional persistence:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewPersistentEventBus(bus EventBus, store EventStore) *PersistentEventBus\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Publish: delegates to wrapped bus, then calls ",(0,s.jsx)(n.code,{children:"store.PersistEvent()"})," asynchronously for events where ",(0,s.jsx)(n.code,{children:"ShouldImmediatelyPersist()"})," returns true"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReplayUnprocessedEvents(ctx)"})," - called on startup to replay missed events"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"dailysync",children:"DailySync"}),"\n",(0,s.jsx)(n.p,{children:"Runs at 02:00 daily to sync persisted events (per ADR-013):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewDailySync(store EventStore, bus EventBus) *DailySync\nfunc (ds *DailySync) Start(ctx context.Context)\nfunc (ds *DailySync) Stop()\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internaleventstestinggo",children:"internal/events/testing.go"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"InMemoryEventBus for unit tests."})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func NewInMemoryEventBus() *InMemoryEventBus\n"})}),"\n",(0,s.jsx)(n.p,{children:"The test bus:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Stores all published events in an in-memory slice"}),"\n",(0,s.jsx)(n.li,{children:"Calls registered handlers synchronously"}),"\n",(0,s.jsxs)(n.li,{children:["Supports wildcard subscriptions via ",(0,s.jsx)(n.code,{children:'SubscribeChannel(ctx, "wan.*")'})]}),"\n",(0,s.jsxs)(n.li,{children:["Provides ",(0,s.jsx)(n.code,{children:"GetAllEvents()"})," to inspect what was published"]}),"\n",(0,s.jsxs)(n.li,{children:["Provides ",(0,s.jsx)(n.code,{children:"Clear()"})," to reset state between tests"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type InMemoryEventBus struct {\n    mu         sync.RWMutex\n    handlers   map[string][]EventHandler\n    allHandler []EventHandler\n    allEvents  []Event\n    channels   map[string][]chan interface{}\n}\n\nfunc (b *InMemoryEventBus) GetAllEvents() []Event\nfunc (b *InMemoryEventBus) Clear()\nfunc (b *InMemoryEventBus) SubscribeChannel(ctx context.Context, pattern string) <-chan interface{}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Wildcard patterns: exact match or ",(0,s.jsx)(n.code,{children:'"prefix.*"'})," (e.g., ",(0,s.jsx)(n.code,{children:'"wan.*"'})," matches all events starting with ",(0,s.jsx)(n.code,{children:'"wan."'}),")."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internaleventsclassificationgo",children:"internal/events/classification.go"}),"\n",(0,s.jsxs)(n.p,{children:["Provides ",(0,s.jsx)(n.code,{children:"ShouldImmediatelyPersist(eventType string) bool"})," and ",(0,s.jsx)(n.code,{children:"ShouldBatchPersist(eventType string) bool"})," to classify which event types need persistent storage."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,s.jsx)(n.h3,{id:"publishing-an-event",children:"Publishing an Event"}),"\n",(0,s.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Service\n    participant Publisher\n    participant EventBus\n    participant Queue as Priority Queue\n    participant Watermill as Watermill Bus\n    participant Handlers\n\n    Service->>Publisher: PublishRouterStatusChanged()\n    Publisher->>EventBus: Publish(ctx, event)\n    alt Priority = Immediate\n        EventBus->>Watermill: publishDirect(event)\n    else Other Priority\n        EventBus->>Queue: enqueue(event)\n    end\n    Watermill->>Watermill: Serialize to JSON\n    Watermill->>Watermill: Publish to "router.status.changed" topic\n    Watermill->>Watermill: Publish to "all" topic\n    Watermill->>Handlers: Notify registered handlers\n    Handlers--\x3e>Service: Handler results'}),"\n",(0,s.jsx)(n.h3,{id:"subscribing-to-events",children:"Subscribing to Events"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// Type-safe subscription:\nbus.OnRouterStatusChanged(func(ctx context.Context, event *RouterStatusChangedEvent) error {\n    // react to router status change\n    return nil\n})\n\n// Generic subscription:\nbus.Subscribe("router.status.changed", func(ctx context.Context, event Event) error {\n    typed := event.(*RouterStatusChangedEvent)\n    return nil\n})\n\n// All events:\nbus.SubscribeAll(func(ctx context.Context, event Event) error {\n    // receives every event\n    return nil\n})\n'})}),"\n",(0,s.jsx)(n.h3,{id:"graphql-subscription-flow",children:"GraphQL Subscription Flow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// In a subscription resolver:\nfunc (r *subscriptionResolver) OnRouterStatusChanged(ctx context.Context) (<-chan *model.RouterStatus, error) {\n    ch := make(chan *model.RouterStatus, 10)\n    r.EventBus.Subscribe(events.EventTypeRouterStatusChanged, func(ctx context.Context, event events.Event) error {\n        typed := event.(*events.RouterStatusChangedEvent)\n        ch <- mapToGraphQL(typed)\n        return nil\n    })\n    return ch, nil\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"event-type-constants",children:"Event Type Constants"}),"\n",(0,s.jsx)(n.p,{children:"All event type string constants are defined alongside their event structs. Common constants:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'const (\n    EventTypeRouterStatusChanged  = "router.status.changed"\n    EventTypeRouterConnected      = "router.connected"\n    EventTypeRouterDisconnected   = "router.disconnected"\n    EventTypeResourceUpdated      = "resource.updated"\n    EventTypeResourceCreated      = "resource.created"\n    EventTypeResourceDeleted      = "resource.deleted"\n    EventTypeFeatureCrashed       = "feature.crashed"\n    EventTypeFeatureInstalled     = "feature.installed"\n    EventTypeConfigApplyProgress  = "config.apply.progress"\n    EventTypeConfigApplied        = "config.applied"\n    EventTypeAuth                 = "auth"\n    EventTypeAuthSessionRevoked   = "auth.session.revoked"\n    EventTypeAuthPasswordChanged  = "auth.password.changed"\n    EventTypeServiceStateChanged  = "service.state.changed"\n    EventTypeServiceCrashed       = "service.crashed"\n    EventTypeStorageMounted       = "storage.mounted"\n    EventTypeIsolationViolation   = "isolation.violation"\n    // ...40+ more\n)\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"EventBusOptions"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"EventBusOptions{\n    BufferSize:         1000,    // GoChannel output buffer per topic\n    Logger:             watermill.NewStdLogger(false, false),\n    ZapLogger:          zapLogger,\n    EnableReplay:       false,\n    PersistenceEnabled: false,\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"For production with persistence:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"bus, _ := events.NewEventBus(opts)\nstore := events.NewMemoryEventStore(10000)\npersistentBus := events.NewPersistentEventBus(bus, store)\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Handler panics are caught with ",(0,s.jsx)(n.code,{children:"recover()"})," in goroutines and logged; they do not crash the bus"]}),"\n",(0,s.jsx)(n.li,{children:"Handler errors are logged but do not prevent other handlers from running"}),"\n",(0,s.jsxs)(n.li,{children:["Failed persistence is flagged via ",(0,s.jsx)(n.code,{children:"IsPersistenceFailing()"})," but does not block publishing"]}),"\n",(0,s.jsx)(n.li,{children:"Bus closed state is checked before publish; returns error if closed"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"InMemoryEventBus"})," for all unit tests:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func TestSomethingPublishesEvent(t *testing.T) {\n    bus := events.NewInMemoryEventBus()\n    svc := NewMyService(bus)\n\n    svc.DoSomething(ctx)\n\n    allEvents := bus.GetAllEvents()\n    require.Len(t, allEvents, 1)\n    evt, ok := allEvents[0].(*events.RouterStatusChangedEvent)\n    require.True(t, ok)\n    assert.Equal(t, "connected", string(evt.Status))\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Test files: ",(0,s.jsx)(n.code,{children:"bus_test.go"}),", ",(0,s.jsx)(n.code,{children:"types_test.go"}),", ",(0,s.jsx)(n.code,{children:"domain_events_test.go"}),", ",(0,s.jsx)(n.code,{children:"service_events_test.go"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"How events connect to alert evaluation: [See: alert-system.md \xa7Alert Engine Event Triggers]"}),"\n",(0,s.jsx)(n.li,{children:"Event bus wiring at startup: [See: application-bootstrap.md \xa7Event System Bootstrap]"}),"\n",(0,s.jsx)(n.li,{children:"GraphQL subscriptions consuming events: [See: graphql-api.md \xa7Subscription Flow]"}),"\n",(0,s.jsx)(n.li,{children:"Credentials never published in events: [See: security.md \xa7Credential Management]"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>c});var r=t(14041);const s={},i=r.createContext(s);function l(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);