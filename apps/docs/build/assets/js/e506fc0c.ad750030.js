"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[67997],{57264:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"state-management/xstate-machines","title":"XState State Machines","description":"All machines live in libs/state/machines/src/. Import from @nasnet/state/machines.","source":"@site/../connect/docs/state-management/xstate-machines.md","sourceDirName":"state-management","slug":"/state-management/xstate-machines","permalink":"/docs/frontend/state-management/xstate-machines","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../connect/docs/state-management/xstate-machines.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"State Management Overview","permalink":"/docs/frontend/state-management/overview"},"next":{"title":"Zustand Stores Inventory","permalink":"/docs/frontend/state-management/zustand-stores"}}');var r=i(31085),s=i(71184);const c={},d="XState State Machines",a={},l=[{value:"Machine Index",id:"machine-index",level:2},{value:"Change Set Machine",id:"change-set-machine",level:2},{value:"State Diagram",id:"state-diagram",level:3},{value:"Context",id:"context",level:3},{value:"Events",id:"events",level:3},{value:"Guards",id:"guards",level:3},{value:"Creating and Using",id:"creating-and-using",level:3},{value:"Helper Functions",id:"helper-functions",level:3},{value:"Config Pipeline Machine",id:"config-pipeline-machine",level:2},{value:"State Diagram",id:"state-diagram-1",level:3},{value:"States",id:"states",level:3},{value:"Guards",id:"guards-1",level:3},{value:"Events",id:"events-1",level:3},{value:"Creating and Using",id:"creating-and-using-1",level:3},{value:"Helper Functions",id:"helper-functions-1",level:3},{value:"VPN Connection Machine",id:"vpn-connection-machine",level:2},{value:"State Diagram",id:"state-diagram-2",level:3},{value:"Configuration",id:"configuration",level:3},{value:"React Hook",id:"react-hook",level:3},{value:"Wizard Machine",id:"wizard-machine",level:2},{value:"State Diagram",id:"state-diagram-3",level:3},{value:"Configuration",id:"configuration-1",level:3},{value:"Events",id:"events-2",level:3},{value:"Usage",id:"usage",level:3},{value:"Resource Lifecycle Machine",id:"resource-lifecycle-machine",level:2},{value:"Machine Persistence",id:"machine-persistence",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"xstate-state-machines",children:"XState State Machines"})}),"\n",(0,r.jsxs)(n.p,{children:["All machines live in ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/"}),". Import from ",(0,r.jsx)(n.code,{children:"@nasnet/state/machines"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Machines are created via factory functions (not exported as bare machine instances) because they accept service implementations as dependencies. This keeps async side effects out of the machine definition and makes testing straightforward."}),"\n",(0,r.jsxs)(n.p,{children:["The codebase uses XState v5 (",(0,r.jsx)(n.code,{children:"setup(...).createMachine(...)"}),")."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"machine-index",children:"Machine Index"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Machine"}),(0,r.jsx)(n.th,{children:"Factory"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"changeSetMachine"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"createChangeSetMachine"})}),(0,r.jsx)(n.td,{children:"Atomic multi-resource apply with rollback"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"configPipelineMachine"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"createConfigPipelineMachine"})}),(0,r.jsx)(n.td,{children:"Safety pipeline: Draft \u2192 Validate \u2192 Preview \u2192 Apply \u2192 Verify"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"vpnConnectionMachine"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"createVPNConnectionMachine"})}),(0,r.jsx)(n.td,{children:"VPN lifecycle: connect, reconnect, metrics, disconnect"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"wizardMachine"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"createWizardMachine"})}),(0,r.jsx)(n.td,{children:"Generic multi-step wizard with per-step validation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"resourceLifecycleMachine"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"createResourceLifecycleMachine"})}),(0,r.jsx)(n.td,{children:"Single resource CRUD lifecycle"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"change-set-machine",children:"Change Set Machine"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/changeSetMachine.ts"})]}),"\n",(0,r.jsx)(n.p,{children:"Orchestrates applying a bundle of interdependent resource operations atomically. Items are applied in dependency order (topological sort). On any failure, applied items are rolled back in reverse order."}),"\n",(0,r.jsx)(n.h3,{id:"state-diagram",children:"State Diagram"}),"\n",(0,r.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e idle\n\n    idle --\x3e|START_VALIDATION| validating\n\n    validating --\x3e|onDone (has errors)| invalid\n    validating --\x3e|onDone (no errors)| ready\n\n    invalid --\x3e|EDIT| idle\n\n    ready --\x3e|CANCEL| cancelled\n    ready --\x3e|APPLY (guard: canApply)| applying\n\n    applying --\x3e|onError (item)| rollingBack\n\n    state applying {\n        [*] --\x3e applyingItem\n        applyingItem --\x3e|onDone| checkingMore\n        checkingMore --\x3e|hasMoreItems| applyingItem\n        checkingMore --\x3e|noMoreItems| done\n        checkingMore --\x3e|isCancelled| cancelledApplying\n    }\n\n    applying --\x3e|complete| completed\n    applying --\x3e|cancelled| cancelled\n\n    rollingBack --\x3e|onDone (all ok)| rolledBack\n    rollingBack --\x3e|onDone (some failed)| partialFailure\n\n    completed --\x3e [*]\n    cancelled --\x3e [*]\n    rolledBack --\x3e [*]\n    partialFailure --\x3e [*]\n\n    idle --\x3e|RESET| idle"}),"\n",(0,r.jsx)(n.h3,{id:"context",children:"Context"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"interface ChangeSetMachineContext {\n  changeSet: ChangeSet | null;\n  routerId: string | null;\n  validationResult: ChangeSetValidationResult | null;\n  currentItemIndex: number;\n  sortedItems: ChangeSetItem[];   // Topologically sorted on LOAD\n  appliedItems: ChangeSetItem[];  // Items successfully applied\n  rollbackPlan: RollbackStep[];   // Built in reverse order as items apply\n  error: ChangeSetError | null;\n  cancelRequested: boolean;\n  applyStartedAt: number | null;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"events",children:"Events"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Event"}),(0,r.jsx)(n.th,{children:"Trigger"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"LOAD"})}),(0,r.jsx)(n.td,{children:"Load a change set into the machine"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"START_VALIDATION"})}),(0,r.jsx)(n.td,{children:"Begin validation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"APPLY"})}),(0,r.jsxs)(n.td,{children:["Start applying (requires ",(0,r.jsx)(n.code,{children:"ready"})," state and ",(0,r.jsx)(n.code,{children:"canApply"})," guard)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CANCEL"})}),(0,r.jsx)(n.td,{children:"Request cancellation (safe-point stop if mid-apply)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FORCE_ROLLBACK"})}),(0,r.jsxs)(n.td,{children:["Manually trigger rollback from ",(0,r.jsx)(n.code,{children:"failed"})," or ",(0,r.jsx)(n.code,{children:"cancelled"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RETRY"})}),(0,r.jsxs)(n.td,{children:["Re-attempt from ",(0,r.jsx)(n.code,{children:"failed"})," (goes back to ",(0,r.jsx)(n.code,{children:"validating"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RESET"})}),(0,r.jsxs)(n.td,{children:["Clear all context, return to ",(0,r.jsx)(n.code,{children:"idle"})]})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"guards",children:"Guards"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Guard"}),(0,r.jsx)(n.th,{children:"Condition"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hasMoreItems"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"currentItemIndex < sortedItems.length"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"noMoreItems"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"currentItemIndex >= sortedItems.length"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"canApply"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"validationResult.canApply === true && sortedItems.length > 0"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hasAppliedItems"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"appliedItems.length > 0"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"isCancelled"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"cancelRequested === true"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hasValidationErrors"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"validationResult.errors.length > 0"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"creating-and-using",children:"Creating and Using"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { createChangeSetMachine } from '@nasnet/state/machines';\nimport { useActor } from '@xstate/react';\n\nconst machine = createChangeSetMachine({\n  validateChangeSet: async (changeSet) => {\n    const result = await apolloClient.query({ query: VALIDATE_CHANGE_SET, variables: { id: changeSet.id } });\n    return result.data.validateChangeSet;\n  },\n  applyItem: async ({ item, routerId }) => {\n    const result = await apolloClient.mutate({ mutation: APPLY_RESOURCE, variables: { routerId, item } });\n    return { confirmedState: result.data.confirmedState, resourceUuid: result.data.resourceUuid };\n  },\n  rollbackItem: async ({ rollbackStep, routerId }) => {\n    await apolloClient.mutate({ mutation: ROLLBACK_RESOURCE, variables: { routerId, ...rollbackStep } });\n  },\n  onProgress: (event) => {\n    console.log(`${event.appliedCount}/${event.totalCount} applied`);\n  },\n  onComplete: (changeSet) => showSuccess(`Applied ${changeSet.items.length} changes`),\n});\n\nconst [state, send] = useActor(machine);\n\nsend({ type: 'LOAD', changeSet, routerId });\nsend({ type: 'START_VALIDATION' });\n// After validation passes (state.value === 'ready'):\nsend({ type: 'APPLY' });\n"})}),"\n",(0,r.jsx)(n.h3,{id:"helper-functions",children:"Helper Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  isChangeSetProcessing,\n  isChangeSetFinal,\n  isChangeSetCancellable,\n  getChangeSetMachineStateDescription,\n} from '@nasnet/state/machines';\n\nisChangeSetProcessing('validating'); // true\nisChangeSetFinal('completed');       // true\ngetChangeSetMachineStateDescription('rollingBack'); // 'Rolling back changes...'\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"config-pipeline-machine",children:"Config Pipeline Machine"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/configPipelineMachine.ts"})]}),"\n",(0,r.jsx)(n.p,{children:"Implements the Apply-Confirm-Merge safety flow for configuration changes. Prevents accidental network lockouts by requiring explicit validation and preview steps before touching the router."}),"\n",(0,r.jsx)(n.h3,{id:"state-diagram-1",children:"State Diagram"}),"\n",(0,r.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e idle\n\n    idle --\x3e|EDIT| draft\n\n    draft --\x3e|VALIDATE| validating\n\n    validating --\x3e|onDone (hasErrors)| invalid\n    validating --\x3e|onDone (noErrors)| previewing\n\n    invalid --\x3e|EDIT| draft\n\n    previewing --\x3e|CONFIRM (isHighRisk)| confirming\n    previewing --\x3e|CONFIRM (isNotHighRisk)| applying\n    previewing --\x3e|EDIT| draft\n\n    confirming --\x3e|ACKNOWLEDGED| applying\n\n    applying --\x3e|onDone| verifying\n\n    verifying --\x3e|onDone (success)| active\n    verifying --\x3e|onError| rollback\n\n    rollback --\x3e|onDone| rolled_back\n\n    active --\x3e [*]\n    rolled_back --\x3e [*]\n    error --\x3e [*]\n\n    applying --\x3e|error| error\n    confirming --\x3e|error| error"}),"\n",(0,r.jsx)(n.h3,{id:"states",children:"States"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"State"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"idle"})}),(0,r.jsx)(n.td,{children:"Waiting for first edit"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"draft"})}),(0,r.jsx)(n.td,{children:"User is editing, changes not yet validated"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"validating"})}),(0,r.jsx)(n.td,{children:"Running the 7-stage validation pipeline"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"invalid"})}),(0,r.jsx)(n.td,{children:"Validation failed \u2014 errors shown to user"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"previewing"})}),(0,r.jsx)(n.td,{children:"Diff of changes shown to user"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"confirming"})}),(0,r.jsx)(n.td,{children:"Explicit acknowledgment required (high-risk operations only)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"applying"})}),(0,r.jsx)(n.td,{children:"Sending configuration to router"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"verifying"})}),(0,r.jsx)(n.td,{children:"Polling router to confirm changes took effect"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"active"})}),(0,r.jsx)(n.td,{children:"Configuration applied successfully (final)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"rollback"})}),(0,r.jsx)(n.td,{children:"Executing rollback to previous safe state"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"rolled_back"})}),(0,r.jsx)(n.td,{children:"Rollback complete (final)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"error"})}),(0,r.jsx)(n.td,{children:"Unrecoverable error \u2014 manual intervention needed"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"guards-1",children:"Guards"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Guard"}),(0,r.jsx)(n.th,{children:"Condition"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hasValidationErrors"})}),(0,r.jsx)(n.td,{children:"Validation returned errors"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"noValidationErrors"})}),(0,r.jsx)(n.td,{children:"Validation returned no errors"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"isHighRisk"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"context.diff.isHighRisk === true"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hasRollbackData"})}),(0,r.jsx)(n.td,{children:"Rollback data captured from apply step"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"events-1",children:"Events"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Event"}),(0,r.jsx)(n.th,{children:"Valid From State(s)"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EDIT"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"idle"}),", ",(0,r.jsx)(n.code,{children:"draft"}),", ",(0,r.jsx)(n.code,{children:"invalid"}),", ",(0,r.jsx)(n.code,{children:"previewing"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"VALIDATE"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"draft"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CONFIRM"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"previewing"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ACKNOWLEDGED"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"confirming"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RETRY"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"error"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"FORCE_ROLLBACK"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"error"})," (requires ",(0,r.jsx)(n.code,{children:"hasRollbackData"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CANCEL"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"draft"}),", ",(0,r.jsx)(n.code,{children:"invalid"}),", ",(0,r.jsx)(n.code,{children:"previewing"}),", ",(0,r.jsx)(n.code,{children:"confirming"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RESET"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"error"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"creating-and-using-1",children:"Creating and Using"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { createConfigPipelineMachine } from '@nasnet/state/machines';\nimport { useActor } from '@xstate/react';\n\nconst machine = createConfigPipelineMachine<WireGuardConfig>({\n  runValidationPipeline: async (config) => {\n    const errors = await validateWireGuardConfig(config);\n    const diff = await computeConfigDiff(config);\n    return { errors, diff };\n  },\n  applyConfig: async ({ resourceId, config }) => {\n    const backup = await getRouterConfig(resourceId);\n    await applyConfig(resourceId, config);\n    return { rollbackData: backup };\n  },\n  verifyApplied: async (resourceId) => {\n    const status = await checkStatus(resourceId);\n    if (!status.running) throw new Error('Service failed to start');\n  },\n  executeRollback: async (rollbackData) => {\n    await restoreConfig(rollbackData);\n  },\n  onSuccess: () => showSuccess('Configuration applied'),\n  onRollback: () => showWarning('Configuration rolled back'),\n});\n\nconst [state, send] = useActor(machine);\nsend({ type: 'EDIT', config: newConfig });\nsend({ type: 'VALIDATE' });\n"})}),"\n",(0,r.jsx)(n.h3,{id:"helper-functions-1",children:"Helper Functions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  isPipelineFinal,\n  isPipelineCancellable,\n  isPipelineProcessing,\n  getPipelineStateDescription,\n} from '@nasnet/state/machines';\n\nisPipelineProcessing('applying');        // true\ngetPipelineStateDescription('previewing'); // 'Review changes'\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"vpn-connection-machine",children:"VPN Connection Machine"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/vpnConnectionMachine.ts"})]}),"\n",(0,r.jsx)(n.p,{children:"Manages the lifecycle of a single VPN connection. Handles connection timeouts, automatic reconnection with exponential backoff, real-time metrics updates, and graceful disconnection."}),"\n",(0,r.jsx)(n.h3,{id:"state-diagram-2",children:"State Diagram"}),"\n",(0,r.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e disconnected\n\n    disconnected --\x3e|CONNECT| connecting\n\n    connecting --\x3e|onDone| connected\n    connecting --\x3e|CONNECTION_TIMEOUT| error\n\n    connected --\x3e|CONNECTION_LOST| reconnecting\n    connected --\x3e|DISCONNECT| disconnecting\n\n    reconnecting --\x3e|onDone| connected\n    reconnecting --\x3e|max attempts| disconnected\n\n    disconnecting --\x3e disconnected\n\n    error --\x3e|DISMISS| disconnected\n    error --\x3e|RETRY| connecting\n\n    disconnected --\x3e [*]"}),"\n",(0,r.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Connection timeout: 30 seconds"}),"\n",(0,r.jsx)(n.li,{children:"Reconnect timeout: 10 seconds"}),"\n",(0,r.jsx)(n.li,{children:"Max reconnect attempts: 3"}),"\n",(0,r.jsx)(n.li,{children:"Backoff: 1s, 2s, 4s, capped at 8s"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"react-hook",children:"React Hook"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import { useVPNConnection } from '@nasnet/state/machines';\n\nfunction VPNStatus() {\n  const vpn = useVPNConnection({\n    establishConnection: api.connectVPN,\n    attemptReconnect: api.reconnectVPN,\n    closeConnection: api.disconnectVPN,\n  });\n\n  return (\n    <div>\n      {vpn.isConnected && <MetricsDisplay metrics={vpn.metrics} />}\n      {vpn.isError && <ErrorMessage error={vpn.error} onRetry={vpn.retry} />}\n      <button onClick={() => vpn.isConnected ? vpn.disconnect() : vpn.connect('vpn.example.com', 'wireguard')}>\n        {vpn.isConnected ? 'Disconnect' : 'Connect'}\n      </button>\n    </div>\n  );\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"useVPNConnection"})," hook wraps ",(0,r.jsx)(n.code,{children:"useMachine"})," and exposes derived booleans (",(0,r.jsx)(n.code,{children:"isConnected"}),", ",(0,r.jsx)(n.code,{children:"isConnecting"}),", ",(0,r.jsx)(n.code,{children:"isError"}),") and action methods (",(0,r.jsx)(n.code,{children:"connect"}),", ",(0,r.jsx)(n.code,{children:"disconnect"}),", ",(0,r.jsx)(n.code,{children:"retry"}),", ",(0,r.jsx)(n.code,{children:"updateMetrics"}),", ",(0,r.jsx)(n.code,{children:"reportConnectionLost"}),")."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"wizard-machine",children:"Wizard Machine"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/wizardMachine.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["Generic multi-step wizard. The primary export is ",(0,r.jsx)(n.code,{children:"createWizardMachine"})," (V2 implementation, which correctly routes the last step to submission)."]}),"\n",(0,r.jsx)(n.h3,{id:"state-diagram-3",children:"State Diagram"}),"\n",(0,r.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e step\n\n    step --\x3e|NEXT| validating\n\n    validating --\x3e|onDone (valid + not lastStep)| step\n    validating --\x3e|onDone (valid + lastStep)| submitting\n    validating --\x3e|onDone (invalid)| step\n\n    submitting --\x3e|onDone| completed\n\n    step --\x3e|CANCEL| cancelled\n    validating --\x3e|CANCEL| cancelled\n    submitting --\x3e|CANCEL| cancelled\n\n    completed --\x3e [*]\n    cancelled --\x3e [*]"}),"\n",(0,r.jsx)(n.h3,{id:"configuration-1",children:"Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"interface WizardConfig<TData> {\n  id: string;\n  totalSteps: number;\n  validateStep: (step: number, data: Partial<TData>) => Promise<{ valid: boolean; errors?: Record<string, string> }>;\n  onSubmit: (data: TData) => Promise<void>;\n  initialData?: Partial<TData>;\n  persist?: boolean;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"events-2",children:"Events"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Event"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"NEXT"})}),(0,r.jsx)(n.td,{children:"Advance (triggers validation)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"BACK"})}),(0,r.jsx)(n.td,{children:"Go to previous step"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"GOTO"})}),(0,r.jsxs)(n.td,{children:["Jump to specific step (forward only if ",(0,r.jsx)(n.code,{children:"canSkip"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SET_DATA"})}),(0,r.jsx)(n.td,{children:"Merge data without advancing"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CLEAR_ERRORS"})}),(0,r.jsx)(n.td,{children:"Clear validation errors"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CANCEL"})}),(0,r.jsx)(n.td,{children:"Abandon wizard"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RESTORE"})}),(0,r.jsx)(n.td,{children:"Restore from persisted session"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"usage",children:"Usage"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { createWizardMachine } from '@nasnet/state/machines';\n\nconst vpnWizard = createWizardMachine<{ server: string; protocol: string }>({\n  id: 'vpn-setup',\n  totalSteps: 3,\n  validateStep: async (step, data) => {\n    if (step === 1 && !data.server) {\n      return { valid: false, errors: { server: 'Required' } };\n    }\n    return { valid: true };\n  },\n  onSubmit: async (data) => {\n    await api.createVPN(data);\n  },\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"useWizard"})," hook in ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/hooks/useWizard.ts"})," wraps ",(0,r.jsx)(n.code,{children:"useMachine"})," with a clean API:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import { useWizard } from '@nasnet/state/machines';\n\nconst { currentStep, totalSteps, data, errors, next, back, goTo, cancel } = useWizard(wizardConfig);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"resource-lifecycle-machine",children:"Resource Lifecycle Machine"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/resourceLifecycleMachine.ts"})]}),"\n",(0,r.jsx)(n.p,{children:"Manages the CRUD lifecycle of a single resource (create, update, delete) with optimistic UI and rollback on failure."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"machine-persistence",children:"Machine Persistence"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/persistence.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["Utilities to save and restore XState machine context to ",(0,r.jsx)(n.code,{children:"sessionStorage"}),". Used by the wizard machine's ",(0,r.jsx)(n.code,{children:"RESTORE"})," event for session recovery."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { saveMachineState, restoreMachineState } from '@nasnet/state/machines';\n\n// Save on every transition\nsaveMachineState('vpn-wizard', state.context);\n\n// Restore on mount\nconst saved = restoreMachineState('vpn-wizard');\nif (saved) send({ type: 'RESTORE', savedContext: saved });\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},71184:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>d});var t=i(14041);const r={},s=t.createContext(r);function c(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);