"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[67451],{11356:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"router-services","title":"Router Services","description":"Overview","source":"@site/../backend/docs/router-services.md","sourceDirName":".","slug":"/router-services","permalink":"/docs/backend/router-services","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/router-services.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Router Communication","permalink":"/docs/backend/router-communication"},"next":{"title":"Security","permalink":"/docs/backend/security"}}');var s=n(31085),i=n(71184);const o={},c="Router Services",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/services</code> \u2014 Router Session and Status",id:"internalservices--router-session-and-status",level:3},{value:"<code>internal/services/wan</code> \u2014 WAN Data Types",id:"internalserviceswan--wan-data-types",level:3},{value:"<code>internal/services/monitoring</code> \u2014 Port Mirrors and Telemetry",id:"internalservicesmonitoring--port-mirrors-and-telemetry",level:3},{value:"<code>internal/services/netif</code> \u2014 IP Address Service",id:"internalservicesnetif--ip-address-service",level:3},{value:"<code>internal/services/pollers</code> \u2014 Poller Configuration",id:"internalservicespollers--poller-configuration",level:3},{value:"<code>internal/services/routing</code> \u2014 IP Route CRUD",id:"internalservicesrouting--ip-route-crud",level:3},{value:"<code>internal/services/networking/vlan</code> \u2014 VLAN Port Operations",id:"internalservicesnetworkingvlan--vlan-port-operations",level:3},{value:"<code>internal/services/integration</code> \u2014 Webhook Service",id:"internalservicesintegration--webhook-service",level:3},{value:"<code>internal/services/svcalert</code> \u2014 Alert Digest",id:"internalservicessvcalert--alert-digest",level:3},{value:"<code>internal/network</code> \u2014 Port Registry",id:"internalnetwork--port-registry",level:3},{value:"<code>internal/network</code> \u2014 VLAN Allocator",id:"internalnetwork--vlan-allocator",level:3},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"router-services",children:"Router Services"})}),"\n",(0,s.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(r.p,{children:["The ",(0,s.jsx)(r.code,{children:"internal/services"})," layer contains all business logic that operates against MikroTik routers. Each service either embeds ",(0,s.jsx)(r.code,{children:"base.Service"})," (which holds a ",(0,s.jsx)(r.code,{children:"RouterPort"})," adapter) or depends on it directly. Services use a ",(0,s.jsx)(r.strong,{children:"hexagonal architecture"}),": they call the ",(0,s.jsx)(r.code,{children:"RouterPort"})," interface (or sub-interfaces detected via type assertion), never concrete adapter types."]}),"\n",(0,s.jsx)(r.p,{children:"This document covers the router-level services and the two network allocation registries (PortRegistry and VLANAllocator) that underpin service isolation."}),"\n",(0,s.jsx)(r.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                         \u2502         base.Service             \u2502\n                         \u2502  RouterPort (interface)          \u2502\n                         \u2502    RunCommand / RunBatch         \u2502\n                         \u2502    GetClient / GetConnection     \u2502\n                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                        \u2502 embedded by / used by\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                             \u2502                              \u2502\n          \u25bc                             \u25bc                              \u25bc\n  RouterService                  PortMirrorService            RoutingService\n  (session/status)               (monitoring)                 (ip/route CRUD)\n\n  IPAddressService         TelemetryService           VLANOperations\n  (ip/address CRUD)        (3-tier stats)             (vlan CRUD)\n\n  WebhookService           ServiceAlertDigest         WAN Types\n  (integration)            (svcalert)                 (data types)\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"Network Allocation Registries (package internal/network)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  PortRegistry                                                \u2502\n\u2502    map[routerID:port:protocol]PortAllocationEntity           \u2502\n\u2502    sync.RWMutex                                              \u2502\n\u2502    reservedPorts map[int]bool                                \u2502\n\u2502    AllocatePort / ReleasePort / IsPortAllocated              \u2502\n\u2502    DetectOrphans / CleanupOrphans                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  VLANAllocator                                               \u2502\n\u2502    pool 100\u2013199 (ingress 100\u2013149, egress 150\u2013199)            \u2502\n\u2502    subnet template: 10.99.{vlan_id}.0/24                     \u2502\n\u2502    IEEE 802.1Q: skip VLAN 1 and 4094                         \u2502\n\u2502    sync.RWMutex + in-memory set                              \u2502\n\u2502    AllocateVLAN / AllocateVLANWithPurpose / ReleaseVLAN      \u2502\n\u2502    80% / 95% pool utilisation events                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(r.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,s.jsxs)(r.h3,{id:"internalservices--router-session-and-status",children:[(0,s.jsx)(r.code,{children:"internal/services"})," \u2014 Router Session and Status"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"router_service_ops.go"})})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"RouterService"})," maintains a session\u2192routerID mapping so that each WebSocket/GraphQL subscription session knows which router it is talking to."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// GetActiveRouter returns the router entity for a session, or nil if none set.\nfunc (s *RouterService) GetActiveRouter(ctx context.Context, sessionID string) (*ent.Router, error)\n\n// SetActiveRouter validates the router exists, then records sessionID\u2192routerID.\nfunc (s *RouterService) SetActiveRouter(ctx context.Context, sessionID, routerID string) error\n\n// ClearActiveRouter removes the session's router binding.\nfunc (s *RouterService) ClearActiveRouter(sessionID string)\n\n// clearActiveRouterIfMatches removes all sessions bound to routerID (used on disconnect).\nfunc (s *RouterService) clearActiveRouterIfMatches(routerID string)\n\n// GetRouterStatus returns the current status string from the DB.\nfunc (s *RouterService) GetRouterStatus(ctx context.Context, routerID string) (string, error)\n\n// UpdateRouterStatus persists new status and publishes RouterStatusChangedEvent.\nfunc (s *RouterService) UpdateRouterStatus(ctx context.Context, routerID, newStatus, previousStatus string) error\n\n// GetAllRouters returns all routers (used by health checker to iterate).\nfunc (s *RouterService) GetAllRouters(ctx context.Context) ([]*ent.Router, error)\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Credential testing:"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// TestCredentials opens a test connection with supplied credentials.\n// Returns CredentialTestResult without modifying stored credentials.\nfunc (s *RouterService) TestCredentials(ctx context.Context, routerID, username, password string) *CredentialTestResult\n\ntype CredentialTestResult struct {\n    Success        bool\n    Status         string   // SUCCESS | AUTH_FAILED | TIMEOUT | CONNECTION_REFUSED | NETWORK_ERROR | ERROR\n    Error          string\n    ResponseTimeMs int\n}\n"})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"TestCredentials"})," builds a temporary ",(0,s.jsx)(r.code,{children:"connection.Config"})," with ",(0,s.jsx)(r.code,{children:"ProtocolREST"}),", calls ",(0,s.jsx)(r.code,{children:"connManager.Connect(ctx, testConnID, config)"}),", then immediately disconnects on success. The test connection ID uses the pattern ",(0,s.jsx)(r.code,{children:"test-{routerID}-{nanoseconds}"}),"."]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["Error classification in ",(0,s.jsx)(r.code,{children:"TestCredentials"}),":"]})}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Error string match"}),(0,s.jsx)(r.th,{children:"Status"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"authentication / login failed / unauthorized / permission denied"}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"AUTH_FAILED"})})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"timeout / context deadline exceeded"}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"TIMEOUT"})})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"connection refused / no route / network unreachable"}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"CONNECTION_REFUSED"})})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"network / dial"}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"NETWORK_ERROR"})})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"(other)"}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"ERROR"})})]})]})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Credential decryption:"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// decryptCredentials decodes base64-encoded encrypted fields and decrypts.\n// RouterSecret stores raw bytes; encryption service expects base64 strings.\nfunc (s *RouterService) decryptCredentials(secrets *ent.RouterSecret) (username, password string, err error)\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Status parsing helpers:"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'func parseRouterStatus(status string) router.Status\n// "online" \u2192 router.StatusOnline, "offline" \u2192 StatusOffline,\n// "degraded" \u2192 StatusDegraded, else \u2192 StatusUnknown\n\nfunc parseEventStatus(status string) events.RouterStatus\n// "online"/"connected" \u2192 RouterStatusConnected\n// "offline"/"disconnected" \u2192 RouterStatusDisconnected\n// "reconnecting"/"connecting" \u2192 RouterStatusReconnecting\n// "error" \u2192 RouterStatusError, else \u2192 RouterStatusUnknown\n'})}),"\n",(0,s.jsxs)(r.h3,{id:"internalserviceswan--wan-data-types",children:[(0,s.jsx)(r.code,{children:"internal/services/wan"})," \u2014 WAN Data Types"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"types.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// WANInterfaceData is the enriched WAN struct returned by resolvers.\ntype WANInterfaceData struct {\n    ID           string\n    Name         string\n    Type         string   // dhcp | pppoe | static | lte\n    Status       string\n    // Health fields\n    UpSince      *time.Time\n    DownSince    *time.Time\n    // Protocol-specific sub-structs (nil if not applicable)\n    DhcpClient   *DhcpClientData\n    PppoeClient  *PppoeClientData\n    StaticConfig *StaticIPConfigData\n    LteModem     *LteModemData\n    // Event history\n    RecentEvents []ConnectionEventData\n}\n\ntype DhcpClientData   { LeaseAddress, Gateway, DNSServers string; LeaseExpiry *time.Time }\ntype PppoeClientData  { ServiceName, Username string; SessionID int; RemoteAddress string }\ntype StaticIPConfigData { Address, Gateway string; DNSServers []string }\ntype LteModemData     { IMSI, IMEI, Operator string; SignalStrength int; APN string }\ntype ConnectionEventData { Timestamp time.Time; Event, Reason string }\n"})}),"\n",(0,s.jsx)(r.p,{children:"Input types mirror the data structs but use pointer fields for optional updates:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"type DhcpClientInput  { Interface string; UseHostname bool; ... }\ntype PppoeClientInput  { Interface, Username, Password, ServiceName string; ... }\ntype StaticIPInput     { Address, Gateway string; DNS []string; ... }\ntype LteModemInput     { APNName, Username, Password string; ... }\ntype HealthCheckInput  { Enabled bool; CheckInterval time.Duration; Target string }\n"})}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicesmonitoring--port-mirrors-and-telemetry",children:[(0,s.jsx)(r.code,{children:"internal/services/monitoring"})," \u2014 Port Mirrors and Telemetry"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:[(0,s.jsx)(r.code,{children:"port_mirror_service.go"})," + ",(0,s.jsx)(r.code,{children:"port_mirror_service_ops.go"})]})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"PortMirrorService"})," embeds ",(0,s.jsx)(r.code,{children:"base.Service"})," and checks for port-mirror capability via type assertion before any operation:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'type portMirrorCapable interface {\n    GetPortMirrors(ctx context.Context) ([]map[string]string, error)\n    CreatePortMirror(ctx context.Context, args map[string]string) error\n    UpdatePortMirror(ctx context.Context, id string, args map[string]string) error\n    DeletePortMirror(ctx context.Context, id string) error\n    EnablePortMirror(ctx context.Context, id string) error\n    DisablePortMirror(ctx context.Context, id string) error\n}\n\n// Capability check pattern:\ncap, ok := s.Port().(portMirrorCapable)\nif !ok {\n    return nil, fmt.Errorf("router does not support port mirrors")\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Operations:"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"func (s *PortMirrorService) GetPortMirrors(ctx context.Context, routerID string) ([]*model.PortMirror, error)\nfunc (s *PortMirrorService) GetPortMirror(ctx context.Context, routerID, mirrorID string) (*model.PortMirror, error)\nfunc (s *PortMirrorService) CreatePortMirror(ctx context.Context, routerID string, input model.PortMirrorInput) (*model.PortMirror, error)\nfunc (s *PortMirrorService) UpdatePortMirror(ctx context.Context, routerID, mirrorID string, input model.PortMirrorInput) (*model.PortMirror, error)\nfunc (s *PortMirrorService) DeletePortMirror(ctx context.Context, routerID, mirrorID string) error\nfunc (s *PortMirrorService) EnablePortMirror(ctx context.Context, routerID, mirrorID string) error\nfunc (s *PortMirrorService) DisablePortMirror(ctx context.Context, routerID, mirrorID string) error\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Validation (CreatePortMirror):"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"Name"})," must be non-empty"]}),"\n",(0,s.jsx)(r.li,{children:"At least one source interface required"}),"\n",(0,s.jsx)(r.li,{children:"Destination interface must not appear in source list"}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Statistics enrichment:"})," After fetching mirrors, ",(0,s.jsx)(r.code,{children:"getPortMirrorStats"})," is called to attach live packet/byte counters from the router."]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Events published:"})," ",(0,s.jsx)(r.code,{children:"port_mirror.created"}),", ",(0,s.jsx)(r.code,{children:"port_mirror.updated"}),", ",(0,s.jsx)(r.code,{children:"port_mirror.deleted"})," \u2014 each carries routerID + mirrorID payload."]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"telemetry_service.go"})})}),"\n",(0,s.jsx)(r.p,{children:"Three-tier telemetry stores interface traffic statistics at different resolutions:"}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Tier"}),(0,s.jsx)(r.th,{children:"Storage"}),(0,s.jsx)(r.th,{children:"Resolution"}),(0,s.jsx)(r.th,{children:"Retention"}),(0,s.jsx)(r.th,{children:"Source"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Hot"}),(0,s.jsx)(r.td,{children:"In-memory ring buffer (3600 points)"}),(0,s.jsx)(r.td,{children:"Full resolution"}),(0,s.jsx)(r.td,{children:"1 hour"}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:"stats.updated"})," events"]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Warm"}),(0,s.jsx)(r.td,{children:"5-minute bucket aggregation"}),(0,s.jsx)(r.td,{children:"5 minutes"}),(0,s.jsx)(r.td,{children:"24 hours"}),(0,s.jsx)(r.td,{children:"Computed from Hot ring"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Cold"}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:"ServiceTrafficHourly"})," ent records"]}),(0,s.jsx)(r.td,{children:"1 hour"}),(0,s.jsx)(r.td,{children:"30 days"}),(0,s.jsx)(r.td,{children:"Persisted from Warm"})]})]})]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// GetInterfaceStatsHistory returns stats using the appropriate tier based on age.\n// age \u2264 1h  \u2192 Hot tier (ring buffer)\n// age \u2264 24h \u2192 Warm tier (5-min aggregation)\n// else       \u2192 Cold tier (DB query)\nfunc (s *TelemetryService) GetInterfaceStatsHistory(\n    ctx context.Context,\n    instanceID string,\n    since time.Time,\n) ([]model.TrafficDataPoint, error)\n"})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"subscribeToStatsEvents"})," registers a handler on the event bus for ",(0,s.jsx)(r.code,{children:"stats.updated"})," events. Each event appends to the Hot ring buffer and triggers Warm/Cold aggregation when bucket boundaries are crossed."]}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicesnetif--ip-address-service",children:[(0,s.jsx)(r.code,{children:"internal/services/netif"})," \u2014 IP Address Service"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"ip_address_service.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// IPAddressService manages IP addresses on router interfaces.\n// Embeds a routerPort and maintains a 10s TTL cache keyed by routerID.\ntype IPAddressService struct {\n    routerPort RouterPort\n    eventBus   events.EventBus\n    cache      *ttlCache  // 10s TTL, invalidated on writes\n}\n\nfunc (s *IPAddressService) GetIPAddresses(ctx context.Context, routerID string) ([]*model.IPAddress, error)\nfunc (s *IPAddressService) GetIPAddress(ctx context.Context, routerID, addrID string) (*model.IPAddress, error)\nfunc (s *IPAddressService) CreateIPAddress(ctx context.Context, routerID string, input model.IPAddressInput) (*model.IPAddress, error)\nfunc (s *IPAddressService) UpdateIPAddress(ctx context.Context, routerID, addrID string, input model.IPAddressInput) (*model.IPAddress, error)\nfunc (s *IPAddressService) DeleteIPAddress(ctx context.Context, routerID, addrID string) error\nfunc (s *IPAddressService) GetDependencies(ctx context.Context, routerID, addrID string) (*model.IPAddressDependencies, error)\n"})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Cache strategy:"})," ",(0,s.jsx)(r.code,{children:"GetIPAddresses"})," populates a ",(0,s.jsx)(r.code,{children:"map[routerID][]IPAddress"})," cache with 10s TTL. Create/Update/Delete operations invalidate the cache for that routerID immediately."]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Events published:"})," ",(0,s.jsx)(r.code,{children:"ip-address-created"}),", ",(0,s.jsx)(r.code,{children:"ip-address-updated"}),", ",(0,s.jsx)(r.code,{children:"ip-address-deleted"}),"."]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"ip_conflicts.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// ConflictType describes the nature of an IP address conflict.\ntype ConflictType string\nconst (\n    ConflictExact         ConflictType = "EXACT"           // Same IP, different interface\n    ConflictSubnetOverlap ConflictType = "SUBNET_OVERLAP"  // Overlapping CIDR ranges\n    ConflictBroadcast     ConflictType = "BROADCAST"       // Matches subnet broadcast addr\n    ConflictNetwork       ConflictType = "NETWORK"         // Matches subnet network addr\n)\n\ntype IPConflict struct {\n    Type            ConflictType\n    ConflictingAddr *model.IPAddress\n    Message         string\n}\n\n// CheckConflict compares a candidate IP/prefix against all existing addresses.\nfunc CheckConflict(candidate *model.IPAddress, existing []*model.IPAddress) []IPConflict\n\n// GetDependencies fetches resources referencing this IP address.\nfunc GetDependencies(ctx context.Context, routerPort RouterPort, routerID, addrID string) (*model.IPAddressDependencies, error)\n'})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"GetDependencies"})," queries the router for:"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"DHCP server pools that use the IP's interface"}),"\n",(0,s.jsx)(r.li,{children:"Static routes with this IP as gateway"}),"\n",(0,s.jsx)(r.li,{children:"NAT rules targeting this IP"}),"\n",(0,s.jsx)(r.li,{children:"Firewall filter/address-list rules referencing this IP"}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"This data is surfaced to the UI before deletion to warn the user of downstream impacts."}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicespollers--poller-configuration",children:[(0,s.jsx)(r.code,{children:"internal/services/pollers"})," \u2014 Poller Configuration"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"types.go"})})}),"\n",(0,s.jsx)(r.p,{children:"Interval constants for the polling system:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"const (\n    MinPollingInterval     = 1 * time.Second\n    DefaultPollingInterval = 5 * time.Second\n    MaxPollingInterval     = 30 * time.Second\n\n    TrafficPollingInterval    = 10 * time.Second\n    MinTrafficPollingInterval = 5 * time.Second\n    MaxTrafficPollingInterval = 60 * time.Second\n)\n"})}),"\n",(0,s.jsx)(r.p,{children:"Helper functions for safely extracting RouterOS response values:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'func getStringOrEmpty(m map[string]string, key string) string\nfunc getIntOrZero(m map[string]string, key string) int\nfunc parseInt(s string) int       // returns 0 on parse failure\nfunc parseBytes(s string) int64   // handles "K", "M", "G" suffixes\n'})}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicesrouting--ip-route-crud",children:[(0,s.jsx)(r.code,{children:"internal/services/routing"})," \u2014 IP Route CRUD"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"service.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// Service manages /ip/route entries on the MikroTik router.\ntype Service struct {\n    base.Service\n}\n\nfunc (s *Service) CreateRoute(ctx context.Context, routerID string, input model.RouteInput) (*model.Route, error)\nfunc (s *Service) UpdateRoute(ctx context.Context, routerID, routeID string, input model.RouteInput) (*model.Route, error)\nfunc (s *Service) DeleteRoute(ctx context.Context, routerID, routeID string) error\n"})}),"\n",(0,s.jsx)(r.p,{children:"Each operation maps to a RouterOS command:"}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Method"}),(0,s.jsx)(r.th,{children:"RouterOS command"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"CreateRoute"})}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"/ip/route/add"})})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"UpdateRoute"})}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"/ip/route/set"})})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"DeleteRoute"})}),(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"/ip/route/remove"})})]})]})]}),"\n",(0,s.jsxs)(r.p,{children:["Uses ",(0,s.jsx)(r.code,{children:"base.CommandArgsBuilder"})," with ",(0,s.jsx)(r.code,{children:".IsSet()"})," guards for optional fields (gateway, distance, routing-mark, etc.) to avoid sending zero-value arguments to RouterOS."]}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicesnetworkingvlan--vlan-port-operations",children:[(0,s.jsx)(r.code,{children:"internal/services/networking/vlan"})," \u2014 VLAN Port Operations"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"operations.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// CheckVlanIDAvailable queries the router to see if a VLAN ID is in use.\n// excludeID: skip this VLAN entry (for update operations).\nfunc CheckVlanIDAvailable(ctx context.Context, port RouterPort, routerID string, vlanID int, excludeID string) (bool, error)\n\n// ConfigureVlanPort sets access or trunk mode on a bridge port.\nfunc ConfigureVlanPort(ctx context.Context, port RouterPort, routerID, portID string, input model.VlanPortInput) error\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"VLAN port modes:"})}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Mode"}),(0,s.jsx)(r.th,{children:"RouterOS settings applied"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"access"})}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:"frame-types: admit-only-untagged"}),", pvid = ",(0,s.jsx)(r.code,{children:"input.VLANID"})]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"trunk"})}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:"frame-types: admit-all"}),", allowed VLAN list set"]})]})]})]}),"\n",(0,s.jsxs)(r.p,{children:["Both modes call ",(0,s.jsx)(r.code,{children:"/interface/bridge/port/set"})," with the appropriate arguments."]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"mapVlanData"})," converts RouterOS string map responses to ",(0,s.jsx)(r.code,{children:"model.Vlan"})," structs (handles ID, name, VLAN ID, interface, comment fields)."]}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicesintegration--webhook-service",children:[(0,s.jsx)(r.code,{children:"internal/services/integration"})," \u2014 Webhook Service"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"webhook_service.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// Service provides webhook CRUD with AES-256-GCM credential encryption.\ntype Service struct {\n    db         *ent.Client\n    encryption *encryption.Service\n    dispatcher *notifications.Dispatcher\n    eventBus   events.EventBus\n    log        *zap.SugaredLogger\n}\n\n// WebhookCreateResult \u2014 signing secret is returned ONCE on creation only.\ntype WebhookCreateResult struct {\n    Webhook                *ent.Webhook\n    PlaintextSigningSecret string // ONE TIME ONLY \u2014 client must save this\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:[(0,s.jsx)(r.code,{children:"CreateWebhook"})," flow:"]})}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"validateWebhookURL(input.URL)"})," \u2192 SSRF protection via ",(0,s.jsx)(r.code,{children:"channelshttp.ValidateWebhookURL"})]}),"\n",(0,s.jsxs)(r.li,{children:["Generate 32-byte random signing secret \u2192 ",(0,s.jsx)(r.code,{children:"base64.StdEncoding.EncodeToString"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"encryption.Encrypt(plaintextSecret)"})," \u2192 AES-256-GCM ciphertext"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"extractNonce(encryptedSecret)"})," \u2192 first 12 bytes of decoded ciphertext"]}),"\n",(0,s.jsxs)(r.li,{children:["Encrypt ",(0,s.jsx)(r.code,{children:"AuthValue"})," map \u2192 JSON marshal \u2192 ",(0,s.jsx)(r.code,{children:"encryption.EncryptBytes"}),"; extract auth nonce"]}),"\n",(0,s.jsxs)(r.li,{children:["Persist to DB: ",(0,s.jsx)(r.code,{children:"SetSigningSecretEncrypted"}),", ",(0,s.jsx)(r.code,{children:"SetSigningNonce"}),", optional ",(0,s.jsx)(r.code,{children:"SetAuthValueEncrypted"}),", ",(0,s.jsx)(r.code,{children:"SetAuthNonce"})]}),"\n",(0,s.jsxs)(r.li,{children:["Publish ",(0,s.jsx)(r.code,{children:"webhook.created"})," event"]}),"\n",(0,s.jsxs)(r.li,{children:["Return ",(0,s.jsx)(r.code,{children:"WebhookCreateResult"})," with plaintext secret \u2014 ",(0,s.jsx)(r.strong,{children:"never stored in plaintext"})]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"func (s *Service) CreateWebhook(ctx context.Context, input CreateWebhookInput) (*WebhookCreateResult, error)\nfunc (s *Service) GetWebhook(ctx context.Context, webhookID string) (*ent.Webhook, error)\n// GetWebhookDecrypted is for internal use only \u2014 NEVER expose to GraphQL resolvers.\nfunc (s *Service) GetWebhookDecrypted(ctx context.Context, webhookID string) (*ent.Webhook, map[string]string, error)\nfunc (s *Service) UpdateWebhook(ctx context.Context, webhookID string, input UpdateWebhookInput) (*ent.Webhook, error)\nfunc (s *Service) DeleteWebhook(ctx context.Context, webhookID string) error\nfunc (s *Service) ListWebhooks(ctx context.Context, enabled *bool) ([]*ent.Webhook, error)\n"})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsxs)(r.strong,{children:[(0,s.jsx)(r.code,{children:"UpdateWebhook"}),":"]})," Re-encrypts auth credentials only when ",(0,s.jsx)(r.code,{children:"input.AuthValue"})," is non-nil. If ",(0,s.jsx)(r.code,{children:"input.AuthValue"})," is an empty map, clears the stored encrypted fields (",(0,s.jsx)(r.code,{children:"ClearAuthValueEncrypted"}),", ",(0,s.jsx)(r.code,{children:"ClearAuthNonce"}),"). The signing secret is ",(0,s.jsx)(r.strong,{children:"never returned or regenerated"})," on update."]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:[(0,s.jsx)(r.code,{children:"extractNonce"}),":"]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"// Decodes base64 ciphertext and returns the first 12 bytes (AES-GCM nonce size).\nfunc extractNonce(encryptedBase64 string) ([]byte, error)\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Events published: ",(0,s.jsx)(r.code,{children:"webhook.created"}),", ",(0,s.jsx)(r.code,{children:"webhook.updated"}),", ",(0,s.jsx)(r.code,{children:"webhook.deleted"}),"."]}),"\n",(0,s.jsxs)(r.h3,{id:"internalservicessvcalert--alert-digest",children:[(0,s.jsx)(r.code,{children:"internal/services/svcalert"})," \u2014 Alert Digest"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"service_digest.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// GetDigestQueueCount returns the number of pending alerts in the digest queue.\nfunc GetDigestQueueCount(ctx context.Context, store DigestStore) (int, error)\n\n// GetDigestHistory returns paginated digest history grouped by digestID.\n// Each entry includes: digestID, period (e.g. "last 24h"), alert count, timestamp.\nfunc GetDigestHistory(ctx context.Context, store DigestStore, limit, offset int) ([]*model.DigestEntry, error)\n\n// TriggerDigestNow forces an immediate digest evaluation outside the normal schedule.\nfunc TriggerDigestNow(ctx context.Context, engine DigestEngine) error\n'})}),"\n",(0,s.jsxs)(r.h3,{id:"internalnetwork--port-registry",children:[(0,s.jsx)(r.code,{children:"internal/network"})," \u2014 Port Registry"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"port_registry.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// PortRegistry allocates and tracks service ports across all router instances.\ntype PortRegistry struct {\n    store         StorePort\n    mu            sync.RWMutex\n    cache         map[string]PortAllocationEntity  // key: "routerID:port:protocol"\n    reservedPorts map[int]bool\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Base ports per service type:"})}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Service"}),(0,s.jsx)(r.th,{children:"Ports"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"tor"}),(0,s.jsx)(r.td,{children:"9050, 9151"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"singbox"}),(0,s.jsx)(r.td,{children:"1080"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"xray"}),(0,s.jsx)(r.td,{children:"1081"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"mtproxy"}),(0,s.jsx)(r.td,{children:"8888"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"psiphon"}),(0,s.jsx)(r.td,{children:"4443"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"adguard"}),(0,s.jsx)(r.td,{children:"53, 3000"})]})]})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Reserved system ports (never allocated):"})}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Port"}),(0,s.jsx)(r.th,{children:"Service"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"22"}),(0,s.jsx)(r.td,{children:"SSH"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"53"}),(0,s.jsx)(r.td,{children:"DNS"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"80"}),(0,s.jsx)(r.td,{children:"HTTP"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"443"}),(0,s.jsx)(r.td,{children:"HTTPS"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"8080"}),(0,s.jsx)(r.td,{children:"HTTP alt"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"8291"}),(0,s.jsx)(r.td,{children:"WinBox"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"8728"}),(0,s.jsx)(r.td,{children:"RouterOS API"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"8729"}),(0,s.jsx)(r.td,{children:"RouterOS API-SSL"})]})]})]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// AllocatePort finds next available port from base, persists, caches, returns allocated port.\n// Holds write lock for the entire find+persist cycle to prevent TOCTOU races.\nfunc (r *PortRegistry) AllocatePort(ctx context.Context, req PortAllocationRequest) (int, error)\n\n// ReleasePort removes the allocation from DB and cache.\nfunc (r *PortRegistry) ReleasePort(ctx context.Context, instanceID string, port int) error\n\n// IsPortAllocated checks if a specific port is registered to a specific instance.\nfunc (r *PortRegistry) IsPortAllocated(ctx context.Context, instanceID string, port int) (bool, error)\n\n// GetAllocationsByRouter returns all port allocations for a router.\nfunc (r *PortRegistry) GetAllocationsByRouter(ctx context.Context, routerID string) ([]PortAllocationEntity, error)\n\n// GetAllocationsByInstance returns all port allocations for a service instance.\nfunc (r *PortRegistry) GetAllocationsByInstance(ctx context.Context, instanceID string) ([]PortAllocationEntity, error)\n\n// DetectOrphans returns allocations whose instance no longer exists or is in "deleting" status.\nfunc (r *PortRegistry) DetectOrphans(ctx context.Context) ([]PortAllocationEntity, error)\n\n// CleanupOrphans releases all detected orphaned allocations.\nfunc (r *PortRegistry) CleanupOrphans(ctx context.Context) (int, error)\n'})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"findNextAvailablePortUnsafe"})})," (called under write lock):"]}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["Start at ",(0,s.jsx)(r.code,{children:"basePort"})," for the service type"]}),"\n",(0,s.jsxs)(r.li,{children:["Skip if port is in ",(0,s.jsx)(r.code,{children:"reservedPorts"})]}),"\n",(0,s.jsxs)(r.li,{children:["Skip if port already exists in ",(0,s.jsx)(r.code,{children:"cache"})]}),"\n",(0,s.jsxs)(r.li,{children:["Return first available port or error if ",(0,s.jsx)(r.code,{children:"basePort + maxSearch"})," exhausted"]}),"\n"]}),"\n",(0,s.jsxs)(r.h3,{id:"internalnetwork--vlan-allocator",children:[(0,s.jsx)(r.code,{children:"internal/network"})," \u2014 VLAN Allocator"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:(0,s.jsx)(r.code,{children:"vlan_allocator_types.go"})})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// Sentinel errors\nvar (\n    ErrPoolExhausted      = errors.New("vlan pool exhausted")\n    ErrInvalidRequest     = errors.New("invalid vlan request")\n    ErrVLANNotFound       = errors.New("vlan allocation not found")\n    ErrInvalidPoolConfig  = errors.New("invalid pool configuration")\n)\n\n// VLANAllocatorConfig defines the VLAN ID pool boundaries.\ntype VLANAllocatorConfig struct {\n    MinVLAN int  // default 100\n    MaxVLAN int  // default 199\n}\n\n// AllocateVLANRequest specifies what to allocate.\ntype AllocateVLANRequest struct {\n    InstanceID string\n    RouterID   string\n    Purpose    string  // "ingress" | "egress" | "" (any)\n    Label      string  // human-readable label\n}\n\n// AllocateVLANResponse contains the allocated VLAN details.\ntype AllocateVLANResponse struct {\n    VLANID  int\n    Subnet  string  // "10.99.{vlan_id}.0/24"\n    Gateway string  // "10.99.{vlan_id}.1"\n}\n\n// VLANPoolStatus is returned by GetPoolStatus.\ntype VLANPoolStatus struct {\n    Total     int\n    Used      int\n    Available int\n    MinVLAN   int\n    MaxVLAN   int\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:[(0,s.jsx)(r.code,{children:"vlan_allocator.go"})," + ",(0,s.jsx)(r.code,{children:"vlan_allocator_pool.go"})]})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'// VLANAllocator manages VLAN ID assignment with IEEE 802.1Q compliance.\ntype VLANAllocator struct {\n    store          VlanServicePort\n    eventBus       events.EventBus\n    mu             sync.RWMutex\n    allocated      map[int]bool  // in-memory set for fast lookup\n    cfg            VLANAllocatorConfig\n}\n\n// AllocateVLAN allocates the next available VLAN from the full pool.\nfunc (a *VLANAllocator) AllocateVLAN(ctx context.Context, req AllocateVLANRequest) (*AllocateVLANResponse, error)\n\n// AllocateVLANWithPurpose allocates from a purpose-specific sub-pool:\n//   "ingress" \u2192 IDs 100\u2013149\n//   "egress"  \u2192 IDs 150\u2013199\nfunc (a *VLANAllocator) AllocateVLANWithPurpose(ctx context.Context, req AllocateVLANRequest) (*AllocateVLANResponse, error)\n\n// ReleaseVLAN removes an allocation by instanceID.\nfunc (a *VLANAllocator) ReleaseVLAN(ctx context.Context, instanceID string) error\n\n// GetPoolStatus returns current utilisation statistics.\nfunc (a *VLANAllocator) GetPoolStatus(ctx context.Context) (*VLANPoolStatus, error)\n\n// UpdatePoolConfig changes pool boundaries; rejects if orphaned allocations exist outside new range.\n// Persists new config to GlobalSettings.\nfunc (a *VLANAllocator) UpdatePoolConfig(ctx context.Context, cfg VLANAllocatorConfig) error\n'})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"IEEE 802.1Q compliance:"})," IDs ",(0,s.jsx)(r.code,{children:"1"})," (default VLAN, reserved) and ",(0,s.jsx)(r.code,{children:"4094"})," (implementation-reserved) are never allocated. The allocator skips these when scanning the pool."]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Subnet derivation:"})," For VLAN ID ",(0,s.jsx)(r.code,{children:"N"}),", the allocated subnet is ",(0,s.jsx)(r.code,{children:"10.99.N.0/24"})," with gateway ",(0,s.jsx)(r.code,{children:"10.99.N.1"}),". This provides deterministic, non-overlapping address space for each service instance."]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["Pool utilisation events (",(0,s.jsx)(r.code,{children:"checkAndEmitPoolWarningUnsafe"}),", called under write lock after each allocation):"]})}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Threshold"}),(0,s.jsx)(r.th,{children:"Event"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"\u2265 80% used"}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:"vlan.pool.warning"})," (warning severity)"]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"\u2265 95% used"}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:"vlan.pool.critical"})," (critical severity)"]})]})]})]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsxs)(r.strong,{children:["Allocation flow (",(0,s.jsx)(r.code,{children:"AllocateVLAN"}),"):"]})}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["Check in-memory ",(0,s.jsx)(r.code,{children:"allocated"})," set (cache hit \u2192 skip)"]}),"\n",(0,s.jsxs)(r.li,{children:["Query DB via ",(0,s.jsx)(r.code,{children:"VlanServicePort.GetExistingAllocations"})," (persistent state)"]}),"\n",(0,s.jsxs)(r.li,{children:["Query router via ",(0,s.jsx)(r.code,{children:"VlanServicePort.CheckVlanConflict"})," (live router VLANs)"]}),"\n",(0,s.jsx)(r.li,{children:"Find first free ID in pool range, skipping 1 and 4094"}),"\n",(0,s.jsxs)(r.li,{children:["Persist via ",(0,s.jsx)(r.code,{children:"VlanServicePort.PersistAllocation"})]}),"\n",(0,s.jsx)(r.li,{children:"Add to in-memory set"}),"\n",(0,s.jsx)(r.li,{children:"Check and emit pool warning if applicable"}),"\n",(0,s.jsxs)(r.li,{children:["Return ",(0,s.jsx)(r.code,{children:"AllocateVLANResponse"})," with VLAN ID, subnet, and gateway"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["[See: 19-process-isolation.md \xa7Layer 3: Ports] \u2014 IsolationVerifier calls ",(0,s.jsx)(r.code,{children:"PortRegistry.IsPortAllocated"})]}),"\n",(0,s.jsx)(r.li,{children:"[See: 19-process-isolation.md \xa7Layer 1: IP Binding] \u2014 VLAN bind IP validation at pre-start"}),"\n",(0,s.jsx)(r.li,{children:"[See: 13-network-services.md \xa7Service Lifecycle] \u2014 orchestrator calls AllocatePort and AllocateVLAN during install"}),"\n",(0,s.jsx)(r.li,{children:"[See: 18-config-generation.md \xa7ValidateBindIP] \u2014 bind IP for service config must come from VLANAllocator subnet"}),"\n",(0,s.jsx)(r.li,{children:"[See: 11-alerts.md \xa7Webhook Delivery] \u2014 WebhookService used by alert dispatcher for outbound notifications"}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},71184:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>c});var t=n(14041);const s={},i=t.createContext(s);function o(e){const r=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);