"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[69264],{27005:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"machines/persistence","title":"State Persistence API","description":"The State Persistence API provides localStorage-based persistence for XState machines, enabling session recovery after browser close/crash. It\'s used by wizards, config pipelines, and other long-running workflows to let users resume from where they left off.","source":"@site/../../libs/state/docs/machines/persistence.md","sourceDirName":"machines","slug":"/machines/persistence","permalink":"/docs/state/machines/persistence","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/machines/persistence.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"XState Machines Overview","permalink":"/docs/state/machines/overview"},"next":{"title":"Resource Lifecycle Machine (Universal State v2)","permalink":"/docs/state/machines/resource-lifecycle"}}');var i=s(31085),a=s(71184);const r={},c="State Persistence API",o={},l=[{value:"Overview",id:"overview",level:2},{value:"Core Functions",id:"core-functions",level:2},{value:"<code>persistMachineState()</code>",id:"persistmachinestate",level:3},{value:"<code>restoreMachineState()</code>",id:"restoremachinestate",level:3},{value:"<code>clearMachineState()</code>",id:"clearmachinestate",level:3},{value:"<code>hasSavedSession()</code>",id:"hassavedsession",level:3},{value:"<code>getSessionAge()</code>",id:"getsessionage",level:3},{value:"<code>formatSessionAge()</code>",id:"formatsessionage",level:3},{value:"<code>clearAllMachineStates()</code>",id:"clearallmachinestates",level:3},{value:"<code>cleanupStaleSessions()</code>",id:"cleanupstalesessions",level:3},{value:"<code>getSavedMachineIds()</code>",id:"getsavedmachineids",level:3},{value:"<code>createSessionRecoveryOptions()</code>",id:"createsessionrecoveryoptions",level:3},{value:"Types",id:"types",level:2},{value:"<code>PersistedMachineState</code>",id:"persistedmachinestate",level:3},{value:"<code>SessionRecoveryOptions</code>",id:"sessionrecoveryoptions",level:3},{value:"Constants",id:"constants",level:2},{value:"Integration with Hooks",id:"integration-with-hooks",level:2},{value:"useWizard Hook",id:"usewizard-hook",level:3},{value:"Manual Integration",id:"manual-integration",level:3},{value:"Storage Structure",id:"storage-structure",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Unique Machine IDs",id:"1-unique-machine-ids",level:3},{value:"2. Exclude Non-Serializable Data",id:"2-exclude-non-serializable-data",level:3},{value:"3. Clear on Logout",id:"3-clear-on-logout",level:3},{value:"4. Cleanup on App Startup",id:"4-cleanup-on-app-startup",level:3},{value:"5. Handle Corrupted Data",id:"5-handle-corrupted-data",level:3},{value:"Testing Persistence",id:"testing-persistence",level:2},{value:"Storage Limits",id:"storage-limits",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"state-persistence-api",children:"State Persistence API"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.strong,{children:"State Persistence API"})," provides localStorage-based persistence for XState machines, enabling session recovery after browser close/crash. It's used by wizards, config pipelines, and other long-running workflows to let users resume from where they left off."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"libs/state/machines/src/persistence.ts"})]}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"The persistence module provides utilities for:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Saving machine state"})," - Automatically on every transition"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Restoring machine state"})," - Resume from previous session"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Session timeout"})," - Default: 24 hours (configurable)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cleanup"})," - Automatically remove stale sessions"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Type safety"})," - Full TypeScript support"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"core-functions",children:"Core Functions"}),"\n",(0,i.jsx)(n.h3,{id:"persistmachinestate",children:(0,i.jsx)(n.code,{children:"persistMachineState()"})}),"\n",(0,i.jsx)(n.p,{children:"Saves the current machine state to localStorage."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function persistMachineState<TContext>(\n  machineId: string,\n  stateValue: string,\n  context: TContext\n): void\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"machineId"})," - Unique identifier for the machine (e.g., ",(0,i.jsx)(n.code,{children:"'vpn-wizard'"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"stateValue"})," - Current state value (e.g., ",(0,i.jsx)(n.code,{children:"'step'"}),", ",(0,i.jsx)(n.code,{children:"'validating'"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"context"})," - Current machine context (all state data)"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { persistMachineState } from '@nasnet/state/machines';\n\n// In a machine action or side effect\npersistMachineState('vpn-setup', 'step', {\n  currentStep: 2,\n  totalSteps: 3,\n  data: { provider: 'wireguard' },\n  errors: {},\n  sessionId: 'uuid-123',\n});\n\n// Stored as:\n// localStorage['nasnet-machine-vpn-setup'] = {\n//   state: 'step',\n//   context: { currentStep: 2, ... },\n//   timestamp: 1234567890,\n//   machineId: 'vpn-setup'\n// }\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"When to use:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["In machine action: ",(0,i.jsx)(n.code,{children:"actions: { saveMachine: () => persistMachineState(...) }"})]}),"\n",(0,i.jsx)(n.li,{children:"In useEffect hook: Auto-persist on state changes"}),"\n",(0,i.jsx)(n.li,{children:"Manually on critical transitions"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"restoremachinestate",children:(0,i.jsx)(n.code,{children:"restoreMachineState()"})}),"\n",(0,i.jsx)(n.p,{children:"Restores machine state from localStorage."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function restoreMachineState<TContext>(\n  machineId: string,\n  maxAge: number = SESSION_TIMEOUT_MS  // 24 hours default\n): PersistedMachineState<TContext> | null\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Returns:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PersistedMachineState"})," - Saved state if valid and not expired"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"null"})," - If no saved state, expired, or corrupted"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { restoreMachineState } from '@nasnet/state/machines';\n\nconst saved = restoreMachineState<WizardContext>('vpn-wizard');\n\nif (saved) {\n  // Resume from saved state\n  send({ type: 'RESTORE', savedContext: saved.context });\n} else {\n  // No saved session, start fresh\n  console.log('Starting new wizard session');\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Automatic cleanup:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Expired sessions (older than maxAge) are deleted automatically"}),"\n",(0,i.jsx)(n.li,{children:"Corrupted data is deleted automatically"}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"null"})," for safety"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"clearmachinestate",children:(0,i.jsx)(n.code,{children:"clearMachineState()"})}),"\n",(0,i.jsx)(n.p,{children:"Deletes saved state for a machine."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function clearMachineState(machineId: string): void\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// After wizard completion\nclearMachineState('vpn-wizard');\n\n// After user logout\nclearMachineState('vpn-wizard');\nclearMachineState('device-pairing');\n"})}),"\n",(0,i.jsx)(n.h3,{id:"hassavedsession",children:(0,i.jsx)(n.code,{children:"hasSavedSession()"})}),"\n",(0,i.jsx)(n.p,{children:"Checks if a machine has a valid saved session."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function hasSavedSession(\n  machineId: string,\n  maxAge: number = SESSION_TIMEOUT_MS\n): boolean\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"function VPNSetupPage() {\n  const hasSaved = hasSavedSession('vpn-setup');\n\n  if (hasSaved) {\n    return <ResumePrompt />;\n  }\n\n  return <WizardForm />;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"getsessionage",children:(0,i.jsx)(n.code,{children:"getSessionAge()"})}),"\n",(0,i.jsx)(n.p,{children:"Gets the age of a saved session in milliseconds."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function getSessionAge(machineId: string): number | null\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Returns:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"number"})," - Age in milliseconds"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"null"})," - If no session exists"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const ageMs = getSessionAge('vpn-setup');\n\nif (ageMs && ageMs > 3600000) {  // 1 hour\n  console.log('Session is older than 1 hour');\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"formatsessionage",children:(0,i.jsx)(n.code,{children:"formatSessionAge()"})}),"\n",(0,i.jsx)(n.p,{children:"Formats session age for human display."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function formatSessionAge(ageMs: number): string\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Returns:"})," Human-readable age string (e.g., ",(0,i.jsx)(n.code,{children:'"2 hours ago"'}),", ",(0,i.jsx)(n.code,{children:'"just now"'}),")"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"const ageMs = getSessionAge('vpn-setup');\n\n{ageMs && (\n  <p>Your previous setup was {formatSessionAge(ageMs)}</p>\n)}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"clearallmachinestates",children:(0,i.jsx)(n.code,{children:"clearAllMachineStates()"})}),"\n",(0,i.jsx)(n.p,{children:"Clears all saved machine states (useful for logout)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function clearAllMachineStates(): void\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// On user logout\nfunction handleLogout() {\n  clearAllMachineStates();\n  navigate('/login');\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cleanupstalesessions",children:(0,i.jsx)(n.code,{children:"cleanupStaleSessions()"})}),"\n",(0,i.jsx)(n.p,{children:"Removes sessions older than specified age (default: 24 hours)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function cleanupStaleSessions(\n  maxAge: number = SESSION_TIMEOUT_MS\n): number  // Returns count of cleaned sessions\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// On app startup\nuseEffect(() => {\n  const cleaned = cleanupStaleSessions();\n  console.log(`Cleaned up ${cleaned} stale sessions`);\n}, []);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"getsavedmachineids",children:(0,i.jsx)(n.code,{children:"getSavedMachineIds()"})}),"\n",(0,i.jsx)(n.p,{children:"Gets all machine IDs with saved sessions."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function getSavedMachineIds(): string[]\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const saved = getSavedMachineIds();\nconsole.log('Machines with saved sessions:', saved);\n// Output: ['vpn-setup', 'device-pairing', 'dns-config']\n"})}),"\n",(0,i.jsx)(n.h3,{id:"createsessionrecoveryoptions",children:(0,i.jsx)(n.code,{children:"createSessionRecoveryOptions()"})}),"\n",(0,i.jsx)(n.p,{children:"Creates session recovery options with defaults."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export function createSessionRecoveryOptions(\n  options: Partial<SessionRecoveryOptions> = {}\n): Required<SessionRecoveryOptions>\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const recovery = createSessionRecoveryOptions({\n  maxAge: 3600000,  // 1 hour\n  promptBeforeRestore: true,\n  onRestore: () => console.log('Session restored!'),\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"types",children:"Types"}),"\n",(0,i.jsx)(n.h3,{id:"persistedmachinestate",children:(0,i.jsx)(n.code,{children:"PersistedMachineState"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"interface PersistedMachineState<TContext = unknown> {\n  /** Current state value (e.g., 'step', 'validating') */\n  state: string;\n\n  /** Machine context with all data */\n  context: TContext;\n\n  /** When state was saved (milliseconds since epoch) */\n  timestamp: number;\n\n  /** Machine ID for identification */\n  machineId: string;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"sessionrecoveryoptions",children:(0,i.jsx)(n.code,{children:"SessionRecoveryOptions"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"interface SessionRecoveryOptions {\n  /** Maximum age of session before stale (default: 24 hours) */\n  maxAge?: number;\n\n  /** Prompt before restoring? (default: true) */\n  promptBeforeRestore?: boolean;\n\n  /** Callback when session is restored */\n  onRestore?: () => void;\n\n  /** Callback when session is discarded */\n  onDiscard?: () => void;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"constants",children:"Constants"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"/** localStorage key prefix for all machines */\nexport const STORAGE_KEY_PREFIX = 'nasnet-machine-';\n\n/** Default session timeout: 24 hours in milliseconds */\nexport const SESSION_TIMEOUT_MS = 24 * 60 * 60 * 1000;\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Storage format:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"nasnet-machine-vpn-setup\nnasnet-machine-device-pairing\nnasnet-machine-dns-config\n"})}),"\n",(0,i.jsx)(n.h2,{id:"integration-with-hooks",children:"Integration with Hooks"}),"\n",(0,i.jsx)(n.h3,{id:"usewizard-hook",children:"useWizard Hook"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { useWizard } from '@nasnet/state/machines';\n\nfunction VPNSetup() {\n  const wizard = useWizard(config, {\n    autoPersist: true,      // Auto-save on every state change\n    autoRestore: false,     // Show resume prompt (not auto-restore)\n    onRestore: () => {\n      toast.info('Resuming previous setup...');\n    },\n  });\n\n  // Hook automatically:\n  // - Saves state on mount/updates (if autoPersist)\n  // - Checks for saved session on mount\n  // - Shows restore prompt (if !autoRestore)\n  // - Clears state on completion\n\n  if (wizard.canRestore) {\n    return (\n      <ResumePrompt\n        onResume={wizard.restore}\n        onDiscard={wizard.discardSession}\n        age={wizard.savedSessionAge}\n      />\n    );\n  }\n\n  return <WizardForm {...wizard} />;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"manual-integration",children:"Manual Integration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import {\n  persistMachineState,\n  restoreMachineState,\n  clearMachineState,\n} from '@nasnet/state/machines';\nimport { useMachine } from '@xstate/react';\n\nfunction CustomWizard() {\n  const machine = useMemo(() => createWizardMachine(config), []);\n  const [state, send] = useMachine(machine);\n\n  // Auto-persist on state changes\n  useEffect(() => {\n    const stateValue = typeof state.value === 'string'\n      ? state.value\n      : JSON.stringify(state.value);\n\n    persistMachineState('my-wizard', stateValue, state.context);\n  }, [state]);\n\n  // Restore on mount\n  useEffect(() => {\n    const saved = restoreMachineState('my-wizard');\n    if (saved) {\n      send({ type: 'RESTORE', savedContext: saved.context });\n    }\n  }, []);\n\n  // Clear on completion\n  useEffect(() => {\n    if (state.matches('completed')) {\n      clearMachineState('my-wizard');\n    }\n  }, [state.matches('completed')]);\n\n  return <div>{/* ... */}</div>;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"storage-structure",children:"Storage Structure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// Saved in localStorage as:\n{\n  "nasnet-machine-vpn-setup": {\n    "state": "step",\n    "context": {\n      "currentStep": 2,\n      "totalSteps": 3,\n      "data": {\n        "provider": "wireguard",\n        "serverAddress": "vpn.example.com"\n      },\n      "errors": {},\n      "sessionId": "f47ac10b-58cc-4372-a567-0e02b2c3d479"\n    },\n    "timestamp": 1676234567890,\n    "machineId": "vpn-setup"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Key insights:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Each machine ID has its own storage entry"}),"\n",(0,i.jsx)(n.li,{children:"Timestamp allows timeout detection"}),"\n",(0,i.jsx)(n.li,{children:"Full context is serialized (must be JSON-compatible)"}),"\n",(0,i.jsx)(n.li,{children:"MachineId is stored for validation"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-unique-machine-ids",children:"1. Unique Machine IDs"}),"\n",(0,i.jsx)(n.p,{children:"Use descriptive, unique IDs:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Good\n'vpn-setup'\n'device-pairing'\n'dns-config'\n'firewall-rule-editor'\n\n// Bad (too generic)\n'wizard'\n'form'\n'modal'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-exclude-non-serializable-data",children:"2. Exclude Non-Serializable Data"}),"\n",(0,i.jsx)(n.p,{children:"Don't store functions, refs, or complex objects in context:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Bad - functions not serializable\ncontext: {\n  validateStep: (step) => { /* ... */ },  // \u274c Won't serialize\n  data: { /* ... */ }\n}\n\n// Good - only store data\ncontext: {\n  data: { provider: 'wireguard' },        // \u2713 JSON-safe\n  errors: {},\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-clear-on-logout",children:"3. Clear on Logout"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"function useAuth() {\n  const logout = useCallback(async () => {\n    await api.logout();\n    clearAllMachineStates();  // Clear all wizard sessions\n    navigate('/login');\n  }, []);\n\n  return { logout };\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-cleanup-on-app-startup",children:"4. Cleanup on App Startup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"function App() {\n  useEffect(() => {\n    // Remove sessions older than 24 hours\n    cleanupStaleSessions();\n  }, []);\n\n  return <Routes>{/* ... */}</Routes>;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"5-handle-corrupted-data",children:"5. Handle Corrupted Data"}),"\n",(0,i.jsx)(n.p,{children:"The persistence API automatically handles corruption (deletes and returns null). For safety:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const saved = restoreMachineState('wizard-id');\n\nif (saved) {\n  // Data is guaranteed valid\n  send({ type: 'RESTORE', savedContext: saved.context });\n} else {\n  // Start fresh (safe fallback)\n  console.log('Starting new session');\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"testing-persistence",children:"Testing Persistence"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { persistMachineState, restoreMachineState, clearMachineState } from '@nasnet/state/machines';\n\ndescribe('Machine Persistence', () => {\n  afterEach(() => {\n    clearMachineState('test-machine');\n  });\n\n  it('should persist and restore state', () => {\n    // Persist\n    const context = { step: 1, data: { name: 'Test' } };\n    persistMachineState('test-machine', 'active', context);\n\n    // Restore\n    const saved = restoreMachineState('test-machine');\n    expect(saved?.context).toEqual(context);\n    expect(saved?.state).toBe('active');\n  });\n\n  it('should return null for non-existent session', () => {\n    const saved = restoreMachineState('nonexistent');\n    expect(saved).toBeNull();\n  });\n\n  it('should expire old sessions', () => {\n    // Persist with old timestamp\n    const oldContext = { step: 1 };\n    persistMachineState('test-machine', 'active', oldContext);\n\n    // Restore with 1ms max age (forces expiration)\n    const saved = restoreMachineState('test-machine', 1);\n    expect(saved).toBeNull();\n  });\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"storage-limits",children:"Storage Limits"}),"\n",(0,i.jsx)(n.p,{children:"localStorage has limits:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Chrome/Firefox:"})," ~5-10MB per domain"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Safari:"})," ~5MB per domain"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"IE:"})," ~10MB per domain"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"To stay safe:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Keep context objects small (< 100KB each)"}),"\n",(0,i.jsx)(n.li,{children:"Don't store large binary data"}),"\n",(0,i.jsx)(n.li,{children:"Periodically clean old sessions"}),"\n",(0,i.jsx)(n.li,{children:"Monitor localStorage usage"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"function getStorageUsage() {\n  const keys = getSavedMachineIds();\n  let total = 0;\n\n  keys.forEach(key => {\n    const stored = localStorage.getItem(`nasnet-machine-${key}`);\n    if (stored) {\n      total += stored.length;\n    }\n  });\n\n  return {\n    used: `${(total / 1024).toFixed(2)} KB`,\n    machines: keys.length,\n  };\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Wizard:"})," See ",(0,i.jsx)(n.code,{children:"wizard.md"})," for useWizard integration"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Overview:"})," See ",(0,i.jsx)(n.code,{children:"overview.md"})," for machine catalog"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Config Pipeline:"})," See ",(0,i.jsx)(n.code,{children:"config-pipeline.md"})," for long-running operations"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},71184:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>c});var t=s(14041);const i={},a=t.createContext(i);function r(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);