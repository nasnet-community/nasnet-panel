"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[25472],{28461:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"integrations/apollo-integration","title":"Apollo Client & Zustand Integration","description":"Apollo Client manages all server state (router config, logs, VPN lists, etc.) while Zustand stores manage UI state. The two systems are integrated through Apollo Links that access Zustand stores using .getState() to read current context (router ID, authentication tokens) without React hooks.","source":"@site/../../libs/state/docs/integrations/apollo-integration.md","sourceDirName":"integrations","slug":"/integrations/apollo-integration","permalink":"/docs/state/integrations/apollo-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/integrations/apollo-integration.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Accessibility (a11y) Provider","permalink":"/docs/state/integrations/a11y-provider"},"next":{"title":"Cross-Feature Communication via Stores","permalink":"/docs/state/integrations/cross-feature-sharing"}}');var o=t(31085),i=t(71184);const s={},a="Apollo Client & Zustand Integration",c={},l=[{value:"Architecture Overview",id:"architecture-overview",level:2},{value:"Pattern: Reading State Outside React",id:"pattern-reading-state-outside-react",level:2},{value:"getState() Pattern",id:"getstate-pattern",level:3},{value:"Apollo Auth Link",id:"apollo-auth-link",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"Authentication Priority",id:"authentication-priority",level:3},{value:"Headers Injected",id:"headers-injected",level:3},{value:"Usage in Apollo Setup",id:"usage-in-apollo-setup",level:3},{value:"Custom Token Getter",id:"custom-token-getter",level:3},{value:"Apollo Error Link",id:"apollo-error-link",level:2},{value:"Error Handling Flow",id:"error-handling-flow",level:3},{value:"Error Categories",id:"error-categories",level:3},{value:"Authentication Errors (UNAUTHENTICATED, 401)",id:"authentication-errors-unauthenticated-401",level:4},{value:"Network Errors",id:"network-errors",level:4},{value:"Validation Errors",id:"validation-errors",level:4},{value:"Error Codes",id:"error-codes",level:3},{value:"Usage in Apollo Setup",id:"usage-in-apollo-setup-1",level:3},{value:"Custom Error Handlers",id:"custom-error-handlers",level:3},{value:"Bidirectional Flow: Subscriptions to Zustand",id:"bidirectional-flow-subscriptions-to-zustand",level:2},{value:"Pattern: Update Store on Subscription Data",id:"pattern-update-store-on-subscription-data",level:3},{value:"Real Example: Alert Notifications",id:"real-example-alert-notifications",level:3},{value:"WebSocket Client State",id:"websocket-client-state",level:2},{value:"Connection State Shape",id:"connection-state-shape",level:3},{value:"WebSocket Lifecycle",id:"websocket-lifecycle",level:3},{value:"Complete Apollo Setup Example",id:"complete-apollo-setup-example",level:2},{value:"Token Refresh Integration",id:"token-refresh-integration",level:2},{value:"How Token Refresh Works",id:"how-token-refresh-works",level:3},{value:"Constants",id:"constants",level:3},{value:"useTokenRefresh Hook",id:"usetokenrefresh-hook",level:3},{value:"Error Recovery Integration",id:"error-recovery-integration",level:2},{value:"Recovery Architecture",id:"recovery-architecture",level:3},{value:"withRetry Function",id:"withretry-function",level:3},{value:"createRecoveryActions Function",id:"createrecoveryactions-function",level:3},{value:"Cache Clearing for Data Corruption",id:"cache-clearing-for-data-corruption",level:3},{value:"Reconnection Integration",id:"reconnection-integration",level:2},{value:"Reconnection Architecture",id:"reconnection-architecture",level:3},{value:"calculateBackoff Function",id:"calculatebackoff-function",level:3},{value:"createReconnectionManager Function",id:"createreconnectionmanager-function",level:3},{value:"createLatencyUpdater Function",id:"createlatencyupdater-function",level:3},{value:"Integration with Connection Store",id:"integration-with-connection-store",level:3},{value:"Testing Apollo-Zustand Integration",id:"testing-apollo-zustand-integration",level:2},{value:"Mock Auth Store in Tests",id:"mock-auth-store-in-tests",level:3},{value:"Mock Error Handler",id:"mock-error-handler",level:3},{value:"Section Guide",id:"section-guide",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"apollo-client--zustand-integration",children:"Apollo Client & Zustand Integration"})}),"\n",(0,o.jsxs)(n.p,{children:["Apollo Client manages all server state (router config, logs, VPN lists, etc.) while Zustand stores manage UI state. The two systems are integrated through ",(0,o.jsx)(n.strong,{children:"Apollo Links"})," that access Zustand stores using ",(0,o.jsx)(n.code,{children:".getState()"})," to read current context (router ID, authentication tokens) without React hooks."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Source:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-auth-link.ts"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-error-link.ts"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/state/stores/src/index.ts"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 React Components                                            \u2502\n\u2502 (useQuery, useMutation hooks)                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Apollo Client                                               \u2502\n\u2502 - InMemoryCache                                            \u2502\n\u2502 - HTTP Link                                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Apollo Links (Middleware)                                  \u2502\n\u2502                                                             \u2502\n\u2502 1. Auth Link: Reads useAuthStore.getState()               \u2502\n\u2502    \u2193 Injects X-Router-Id, Authorization headers           \u2502\n\u2502                                                             \u2502\n\u2502 2. Error Link: Reads useNotificationStore.getState()      \u2502\n\u2502    \u2193 Updates useAuthStore on 401                          \u2502\n\u2502    \u2193 Shows error notifications                            \u2502\n\u2502                                                             \u2502\n\u2502 3. WebSocket Link (for subscriptions)                     \u2502\n\u2502    \u2193 Reads connection state                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n                     \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Zustand Stores                                              \u2502\n\u2502                                                             \u2502\n\u2502 useAuthStore    - JWT token, user session                  \u2502\n\u2502 useConnectionStore - Current router ID, WebSocket state    \u2502\n\u2502 useNotificationStore - Error/success toasts               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,o.jsx)(n.h2,{id:"pattern-reading-state-outside-react",children:"Pattern: Reading State Outside React"}),"\n",(0,o.jsxs)(n.p,{children:["Apollo Links are middleware that runs ",(0,o.jsx)(n.strong,{children:"outside React hooks"}),". To access Zustand state, use ",(0,o.jsx)(n.code,{children:".getState()"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// \u2705 CORRECT - getState() reads current state outside React\nconst { currentRouterId } = useConnectionStore.getState();\nconst token = getAuthToken(); // calls useAuthStore.getState()\n\n// \u274c WRONG - Can't use hooks outside React components\nconst { currentRouterId } = useConnectionStore(); // Error!\n"})}),"\n",(0,o.jsx)(n.h3,{id:"getstate-pattern",children:"getState() Pattern"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { useAuthStore, useConnectionStore } from '@nasnet/state/stores';\n\n// In Apollo Link (not a React component)\nexport const authLink = setContext((_, { headers }) => {\n  // Read current state without React hooks\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorizationHeader(currentRouterId);\n\n  return {\n    headers: {\n      ...headers,\n      'X-Router-Id': currentRouterId || '',\n      ...(authorization && { Authorization: authorization }),\n    },\n  };\n});\n"})}),"\n",(0,o.jsx)(n.h2,{id:"apollo-auth-link",children:"Apollo Auth Link"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"auth link"})," injects authentication context into every GraphQL request."]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Source:"})," ",(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-auth-link.ts"})]}),"\n",(0,o.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Reads current router ID"})," from ",(0,o.jsx)(n.code,{children:"useConnectionStore.getState()"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Gets authorization header"})," (JWT or Basic auth) from ",(0,o.jsx)(n.code,{children:"useAuthStore"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Injects headers"})," into every GraphQL request"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"authentication-priority",children:"Authentication Priority"}),"\n",(0,o.jsx)(n.p,{children:"The auth link tries authentication in this order:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"function getAuthorizationHeader(routerId: string | null): string | undefined {\n  // 1. Try JWT Bearer token (primary)\n  const jwtToken = getAuthToken(); // from useAuthStore\n  if (jwtToken) {\n    return `Bearer ${jwtToken}`;\n  }\n\n  // 2. Fall back to Basic auth (router-specific credentials)\n  const credentials = getStoredCredentials(routerId); // from sessionStorage\n  if (credentials) {\n    return `Basic ${btoa(`${credentials.username}:${credentials.password}`)}`;\n  }\n\n  return undefined;\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"headers-injected",children:"Headers Injected"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Example request headers after auth link\n{\n  'X-Router-Id': 'router-123',           // Current router ID\n  'Authorization': 'Bearer eyJhb...',    // JWT token OR\n  'Authorization': 'Basic dXNlcjpwYXNz', // Basic auth\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"usage-in-apollo-setup",children:"Usage in Apollo Setup"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { ApolloClient, from } from '@apollo/client';\nimport { authLink } from '@nasnet/api-client/core';\n\nconst client = new ApolloClient({\n  link: from([\n    authLink,      // Inject auth headers first\n    errorLink,     // Handle errors\n    httpLink,      // Execute HTTP request\n  ]),\n  cache: new InMemoryCache(),\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"custom-token-getter",children:"Custom Token Getter"}),"\n",(0,o.jsx)(n.p,{children:"If you need custom authentication logic:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { createAuthLink } from '@nasnet/api-client/core';\n\nfunction getCustomToken(): string | null {\n  // Your custom logic here\n  return localStorage.getItem('custom-token');\n}\n\nconst customAuthLink = createAuthLink(getCustomToken);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"apollo-error-link",children:"Apollo Error Link"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"error link"})," handles GraphQL and network errors, updating stores and notifying users."]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Source:"})," ",(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-error-link.ts"})]}),"\n",(0,o.jsx)(n.h3,{id:"error-handling-flow",children:"Error Handling Flow"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'GraphQL Request\n    \u2502\n    \u251c\u2500 GraphQL Error (error code)\n    \u2502   \u2502\n    \u2502   \u251c\u2500 UNAUTHENTICATED / 401\n    \u2502   \u2502  \u2514\u2500 clearAuth() + show "Session expired" toast\n    \u2502   \u2502\n    \u2502   \u251c\u2500 FORBIDDEN / 403\n    \u2502   \u2502  \u2514\u2500 show "Access denied" toast\n    \u2502   \u2502\n    \u2502   \u251c\u2500 VALIDATION_FAILED\n    \u2502   \u2502  \u2514\u2500 skip (handled by form validation)\n    \u2502   \u2502\n    \u2502   \u2514\u2500 Other error\n    \u2502      \u2514\u2500 show user-friendly error message\n    \u2502\n    \u2514\u2500 Network Error (HTTP status)\n        \u2502\n        \u251c\u2500 401 Unauthorized\n        \u2502  \u2514\u2500 clearAuth() + redirect to login\n        \u2502\n        \u251c\u2500 403 Forbidden\n        \u2502  \u2514\u2500 show "Access denied" toast\n        \u2502\n        \u2514\u2500 Connection error\n           \u2514\u2500 show "Network error" notification\n'})}),"\n",(0,o.jsx)(n.h3,{id:"error-categories",children:"Error Categories"}),"\n",(0,o.jsx)(n.h4,{id:"authentication-errors-unauthenticated-401",children:"Authentication Errors (UNAUTHENTICATED, 401)"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"function handleAuthError(message?: string) {\n  // Clear auth state\n  useAuthStore.getState().clearAuth();\n\n  // Show notification\n  useNotificationStore.getState().addNotification({\n    type: 'error',\n    title: 'Session expired',\n    message: message || 'Your session has expired. Please log in again.',\n  });\n\n  // Dispatch event for listeners (e.g., router redirect)\n  window.dispatchEvent(new CustomEvent('auth:expired'));\n}\n"})}),"\n",(0,o.jsx)(n.h4,{id:"network-errors",children:"Network Errors"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"function handleNetworkError(error: Error) {\n  // Show notification\n  useNotificationStore.getState().addNotification({\n    type: 'error',\n    title: 'Network error',\n    message: 'Unable to reach the server. Please check your connection.',\n  });\n\n  // Dispatch event for network tracking\n  window.dispatchEvent(\n    new CustomEvent('network:error', { detail: { error } })\n  );\n}\n"})}),"\n",(0,o.jsx)(n.h4,{id:"validation-errors",children:"Validation Errors"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Validation errors are skipped in the error link\n// They're handled at the form level with React Hook Form\nif (checkValidationError(errorCode)) {\n  if (import.meta.env.DEV) {\n    console.warn('[Validation Error - handled by form]:', message);\n  }\n  continue; // Skip showing error toast\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"error-codes",children:"Error Codes"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Code"}),(0,o.jsx)(n.th,{children:"Handling"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"UNAUTHENTICATED"})}),(0,o.jsxs)(n.td,{children:['Clear auth, show "Session expired", dispatch ',(0,o.jsx)(n.code,{children:"auth:expired"})," event"]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"FORBIDDEN"})}),(0,o.jsx)(n.td,{children:'Show "Access denied" notification'})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"NOT_FOUND"})}),(0,o.jsx)(n.td,{children:'Show "Resource not found" notification'})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"VALIDATION_FAILED"})}),(0,o.jsx)(n.td,{children:"Skip (form handles)"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["HTTP ",(0,o.jsx)(n.code,{children:"401"})]}),(0,o.jsx)(n.td,{children:"Same as UNAUTHENTICATED"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["HTTP ",(0,o.jsx)(n.code,{children:"403"})]}),(0,o.jsx)(n.td,{children:"Same as FORBIDDEN"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"Network timeout/offline"}),(0,o.jsx)(n.td,{children:'Show "Network error" notification'})]})]})]}),"\n",(0,o.jsx)(n.h3,{id:"usage-in-apollo-setup-1",children:"Usage in Apollo Setup"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { ApolloClient, from } from '@apollo/client';\nimport { errorLink } from '@nasnet/api-client/core';\n\nconst client = new ApolloClient({\n  link: from([\n    errorLink,     // Handle errors first\n    authLink,      // Add auth headers\n    httpLink,      // Execute HTTP request\n  ]),\n  cache: new InMemoryCache(),\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"custom-error-handlers",children:"Custom Error Handlers"}),"\n",(0,o.jsx)(n.p,{children:"For custom error handling:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { createErrorLink } from '@nasnet/api-client/core';\n\nconst customErrorLink = createErrorLink({\n  onAuthError: (message) => {\n    console.log('Auth failed:', message);\n    // Custom redirect logic\n    window.location.href = '/login';\n  },\n  onNetworkError: (error) => {\n    console.error('Network failed:', error);\n    // Custom recovery logic\n  },\n});\n"})}),"\n",(0,o.jsx)(n.h2,{id:"bidirectional-flow-subscriptions-to-zustand",children:"Bidirectional Flow: Subscriptions to Zustand"}),"\n",(0,o.jsxs)(n.p,{children:["GraphQL ",(0,o.jsx)(n.strong,{children:"subscriptions"})," deliver real-time data that needs to update Zustand stores."]}),"\n",(0,o.jsx)(n.h3,{id:"pattern-update-store-on-subscription-data",children:"Pattern: Update Store on Subscription Data"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Example: Interface statistics subscription updates interface-stats store\nimport { useSubscribeInterfaceStats } from '@nasnet/api-client/queries';\nimport { useInterfaceStatsStore } from '@nasnet/state/stores';\n\nfunction InterfaceStatsMonitor() {\n  const { pollingInterval } = useInterfaceStatsStore();\n\n  // Subscribe with current polling interval\n  const { data } = useSubscribeInterfaceStats({\n    routerId: 'router-123',\n    interval: pollingInterval,\n  });\n\n  // Update store when polling interval changes\n  useEffect(() => {\n    // Apollo will re-subscribe with new interval\n  }, [pollingInterval]);\n\n  return <div>{/* Display stats */}</div>;\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"real-example-alert-notifications",children:"Real Example: Alert Notifications"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Subscribe to alerts\nconst { data: alertData } = useSubscribeAlerts({ routerId });\n\n// Store notifications in useAlertNotificationStore\nuseEffect(() => {\n  if (alertData?.alert) {\n    useAlertNotificationStore.getState().addNotification({\n      alertId: alertData.alert.id,\n      title: alertData.alert.title,\n      message: alertData.alert.message,\n      severity: alertData.alert.severity,\n      deviceId: alertData.alert.deviceId,\n      ruleId: alertData.alert.ruleId,\n    });\n  }\n}, [alertData]);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"websocket-client-state",children:"WebSocket Client State"}),"\n",(0,o.jsxs)(n.p,{children:["The Apollo WebSocket client maintains connection state in ",(0,o.jsx)(n.code,{children:"useConnectionStore"}),"."]}),"\n",(0,o.jsx)(n.h3,{id:"connection-state-shape",children:"Connection State Shape"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"interface ConnectionState {\n  // Current router ID\n  currentRouterId: string | null;\n\n  // WebSocket connection state\n  websocketConnected: boolean;\n  websocketError: Error | null;\n\n  // Connection metrics\n  lastMessageAt?: string;\n  messageCount: number;\n\n  // Actions\n  setCurrentRouterId: (id: string | null) => void;\n  setWebsocketConnected: (connected: boolean) => void;\n  setWebsocketError: (error: Error | null) => void;\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"websocket-lifecycle",children:"WebSocket Lifecycle"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Apollo WebSocket client\nconst wsLink = new GraphQLWsLink(\n  createClient({\n    url: import.meta.env.VITE_WS_URL,\n\n    // Track connection state\n    on: {\n      connected() {\n        useConnectionStore.getState().setWebsocketConnected(true);\n      },\n      error(error) {\n        useConnectionStore.getState().setWebsocketError(error);\n      },\n      closed() {\n        useConnectionStore.getState().setWebsocketConnected(false);\n      },\n    },\n  })\n);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"complete-apollo-setup-example",children:"Complete Apollo Setup Example"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// libs/api-client/core/src/apollo/client.ts\n\nimport { ApolloClient, from, InMemoryCache, ApolloLink } from '@apollo/client';\nimport { createHttpLink } from '@apollo/client/link/http';\nimport { GraphQLWsLink } from '@apollo/client/link/subscriptions';\nimport { getMainDefinition } from '@apollo/client/utilities';\n\nimport { authLink } from './apollo-auth-link';\nimport { errorLink } from './apollo-error-link';\n\n// HTTP Link for queries and mutations\nconst httpLink = createHttpLink({\n  uri: import.meta.env.VITE_API_URL + '/graphql',\n  credentials: 'include', // Send cookies\n});\n\n// WebSocket Link for subscriptions\nconst wsLink = new GraphQLWsLink(\n  createClient({\n    url: import.meta.env.VITE_WS_URL,\n  })\n);\n\n// Split: subscriptions use ws, others use http\nconst splitLink = ApolloLink.split(\n  ({ query }) => {\n    const definition = getMainDefinition(query);\n    return definition.kind === 'OperationDefinition' &&\n      definition.operation === 'subscription';\n  },\n  wsLink,\n  httpLink\n);\n\n// Chain all links in order\nexport const apolloClient = new ApolloClient({\n  link: from([\n    errorLink,      // Error handling (catches errors)\n    authLink,       // Auth context (adds headers)\n    splitLink,      // HTTP or WebSocket (executes request)\n  ]),\n  cache: new InMemoryCache(),\n  defaultOptions: {\n    watchQuery: { errorPolicy: 'all' },\n    query: { errorPolicy: 'all' },\n    mutate: { errorPolicy: 'all' },\n  },\n});\n"})}),"\n",(0,o.jsx)(n.h2,{id:"token-refresh-integration",children:"Token Refresh Integration"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"token refresh"})," system proactively renews JWT tokens before expiration to maintain user sessions seamlessly."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Source:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/state/stores/src/hooks/useTokenRefresh.ts"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-auth-link.ts"})}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"how-token-refresh-works",children:"How Token Refresh Works"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 useTokenRefresh Hook                 \u2502\n\u2502 - Checks every 60 seconds            \u2502\n\u2502 - Monitors token expiry              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n                   \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502 Is token expiring    \u2502\n        \u2502 in next 5 minutes?   \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 YES               NO\n         \u25bc                    \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502 Attempt Refresh    \u2502        \u2502\n\u2502 (max 3 attempts)   \u2502        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n         \u2502                    \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n    \u2502            \u2502             \u2502\n    \u25bc            \u25bc             \u2502\n Success     Failure           \u2502\n    \u2502         (retry)          \u2502\n    \u2502            \u2502             \u2502\n    \u2502      Max attempts       \u2502\n    \u2502         exceeded?        \u2502\n    \u2502            \u2502             \u2502\n    \u2502      \u250c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2510       \u2502\n    \u2502      \u2502 YES   NO  \u2502       \u2502\n    \u2502      \u25bc       \u25bc   \u2502       \u2502\n    \u2502   Re-auth  Retry \u2502       \u2502\n    \u2502   Required       \u2502       \u2502\n    \u2502                  \u25bc       \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n        Update Apollo Link\n        with new token\n"})}),"\n",(0,o.jsx)(n.h3,{id:"constants",children:"Constants"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Check interval for token expiry (1 minute)\nconst REFRESH_CHECK_INTERVAL_MS = 60_000;\n\n// Maximum refresh attempts before requiring re-authentication\nconst MAX_REFRESH_ATTEMPTS = 3;\n\n// Proactive refresh threshold (5 minutes before expiry)\nconst REFRESH_THRESHOLD_MS = 5 * 60_000;\n"})}),"\n",(0,o.jsx)(n.h3,{id:"usetokenrefresh-hook",children:"useTokenRefresh Hook"}),"\n",(0,o.jsx)(n.p,{children:"Monitors token expiry and automatically refreshes tokens before they expire."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Options:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"interface UseTokenRefreshOptions {\n  /**\n   * Callback to perform the actual token refresh\n   * Should call your refresh token endpoint\n   */\n  refreshTokenFn: () => Promise<TokenRefreshResult>;\n\n  /**\n   * Callback when re-authentication is required\n   * Called after max refresh attempts exceeded\n   */\n  onReauthRequired?: () => void;\n\n  /**\n   * Whether to show notifications (default: true)\n   */\n  showNotifications?: boolean;\n\n  /**\n   * Check interval in milliseconds (default: 60000)\n   */\n  checkInterval?: number;\n}\n\ninterface TokenRefreshResult {\n  token: string;           // New access token\n  expiresAt: Date;         // Expiration time\n  refreshToken?: string;   // Optional new refresh token\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Integration with Apollo:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { useTokenRefresh } from '@nasnet/state/stores';\nimport { useAuthMutation } from '@nasnet/api-client/queries';\n\nfunction AuthProvider({ children }) {\n  // Set up token refresh hook\n  useTokenRefresh({\n    refreshTokenFn: async () => {\n      // Call Apollo mutation to refresh token\n      const { data } = await refreshTokenMutation();\n      return {\n        token: data.refreshToken.token,\n        expiresAt: new Date(data.refreshToken.expiresAt),\n        refreshToken: data.refreshToken.refreshToken,\n      };\n    },\n\n    onReauthRequired: () => {\n      // Redirect to login\n      window.location.href = '/login';\n    },\n\n    showNotifications: true,  // Show \"Session expiring\" toast if max retries exceeded\n  });\n\n  return children;\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Flow diagram:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'1. Token check interval fires (every 60s)\n2. Is token expiring in next 5 minutes?\n   \u251c\u2500 NO \u2192 Wait for next interval\n   \u2514\u2500 YES \u2192 Attempt refresh\n3. Call refreshTokenFn()\n4. Success?\n   \u251c\u2500 YES \u2192 Update auth store with new token\n   \u2502        Update Apollo auth link headers\n   \u2502        Pending requests auto-retry \u2713\n   \u2514\u2500 NO \u2192 Increment retry attempts\n5. Retry count < 3?\n   \u251c\u2500 YES \u2192 Retry (with backoff delay)\n   \u2514\u2500 NO \u2192 Call onReauthRequired() callback\n           Show "Session expiring" toast\n           User must log in again\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Key benefits:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:'Users never see "Session expired" errors during normal operation'}),"\n",(0,o.jsx)(n.li,{children:"Background refresh keeps session alive across long workflows"}),"\n",(0,o.jsx)(n.li,{children:"Seamless retry of failed requests after token update"}),"\n",(0,o.jsx)(n.li,{children:"Configurable retry attempts and intervals"}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"error-recovery-integration",children:"Error Recovery Integration"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"error recovery"})," system provides utilities for automatically retrying failed operations and recovering from various error states."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Source:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/state/stores/src/utils/recovery.ts"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-error-link.ts"})}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"recovery-architecture",children:"Recovery Architecture"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 GraphQL Operation Fails          \u2502\n\u2502 (Network or GraphQL error)       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n                   \u25bc\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502 Error Link Catches   \u2502\n        \u2502 (middleware layer)   \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                   \u2502\n    GraphQL Error      Network Error\n    (400-level)        (connectivity)\n         \u2502                   \u2502\n         \u25bc                   \u25bc\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502 Check    \u2502      \u2502 Retry with   \u2502\n   \u2502 error    \u2502      \u2502 exponential  \u2502\n   \u2502 code     \u2502      \u2502 backoff      \u2502\n   \u2514\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502                 \u2502\n      \u251c\u2500 401 \u2192 Clear auth, show "Session expired"\n      \u251c\u2500 403 \u2192 Show "Access denied"\n      \u251c\u2500 404 \u2192 Show "Resource not found"\n      \u2514\u2500 Other \u2192 Show generic error + offer recovery\n'})}),"\n",(0,o.jsx)(n.h3,{id:"withretry-function",children:"withRetry Function"}),"\n",(0,o.jsx)(n.p,{children:"Executes an operation with automatic retry and exponential backoff."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Signature:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"function withRetry<T>(\n  operation: () => Promise<T>,\n  config: RetryConfig = {}\n): Promise<RetryResult<T>>\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"interface RetryConfig {\n  /** Maximum number of retry attempts (default: 3) */\n  maxRetries?: number;\n\n  /** Whether to show notifications (default: true) */\n  showNotifications?: boolean;\n\n  /** Callback before each retry */\n  onRetry?: (attempt: number, error: Error) => void;\n\n  /** Callback when max retries exceeded */\n  onMaxRetriesExceeded?: (error: Error) => void;\n\n  /** Predicate to determine if error is retryable */\n  shouldRetry?: (error: Error, attempt: number) => boolean;\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Example: Retry failed GraphQL query"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { withRetry } from '@nasnet/state/stores';\n\n// Retry fetching router data\nconst result = await withRetry(\n  () => fetchRouterConfig(routerId),\n  {\n    maxRetries: 3,\n    onRetry: (attempt, error) => {\n      console.log(`Retry ${attempt}: ${error.message}`);\n    },\n    shouldRetry: (error) => {\n      // Don't retry auth errors\n      return error.message !== 'Unauthorized';\n    },\n  }\n);\n\nif (result.success) {\n  console.log('Data:', result.data);\n} else {\n  console.error('Failed after', result.attempts, 'attempts:', result.error);\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Backoff timing:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Attempt 0: ~1s delay\nAttempt 1: ~2s delay\nAttempt 2: ~4s delay\nAttempt 3: ~8s delay (max)\n"})}),"\n",(0,o.jsx)(n.h3,{id:"createrecoveryactions-function",children:"createRecoveryActions Function"}),"\n",(0,o.jsx)(n.p,{children:"Creates a set of recovery actions for an error, giving users options to recover."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Returns:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"interface RecoveryActions {\n  retry: () => Promise<void>;           // Retry the operation\n  clearCacheAndRetry: () => Promise<void>; // Clear Apollo cache, then retry\n  copyReport: () => Promise<void>;      // Copy error details to clipboard\n  reportIssue: () => void;              // Open GitHub issue reporter\n  reload: () => void;                   // Reload the page\n  goHome: () => void;                   // Navigate to home\n  goBack: () => void;                   // Navigate back in history\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Example: Error recovery UI"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { createRecoveryActions } from '@nasnet/state/stores';\n\nfunction ErrorCard({ error, onRetry }) {\n  const actions = createRecoveryActions(error, onRetry, {\n    component: 'RouterDetailPanel',\n  });\n\n  return (\n    <div className=\"error-card\">\n      <h3>Error loading router</h3>\n      <p>{error.message}</p>\n\n      <div className=\"actions\">\n        <Button onClick={actions.retry}>\n          Retry\n        </Button>\n        <Button onClick={actions.clearCacheAndRetry}>\n          Clear Cache & Retry\n        </Button>\n        <Button onClick={actions.copyReport}>\n          Copy Error Details\n        </Button>\n        <Button onClick={actions.reportIssue}>\n          Report Issue\n        </Button>\n        <Button onClick={actions.goHome}>\n          Go Home\n        </Button>\n      </div>\n    </div>\n  );\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"cache-clearing-for-data-corruption",children:"Cache Clearing for Data Corruption"}),"\n",(0,o.jsx)(n.p,{children:"Clear Apollo cache and Zustand stores when data corruption is suspected:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { clearAllCache, clearCacheAndReload } from '@nasnet/state/stores';\n\n// Option 1: Clear cache and stay on page\nawait clearAllCache();\n// User can retry operations now\n\n// Option 2: Clear cache and reload\n// (for severe corruption)\nawait clearCacheAndReload();  // Reloads after 500ms\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"What gets cleared:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Apollo InMemoryCache"}),"\n",(0,o.jsx)(n.li,{children:"localStorage cache entries (apollo-*, *-cache)"}),"\n",(0,o.jsx)(n.li,{children:"sessionStorage cache entries (apollo-*, *-cache)"}),"\n",(0,o.jsx)(n.li,{children:"Zustand stores are NOT automatically cleared (only cache)"}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"reconnection-integration",children:"Reconnection Integration"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.strong,{children:"reconnection"})," system handles WebSocket reconnection with exponential backoff and integrates with Apollo subscriptions."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Source:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"libs/state/stores/src/utils/reconnect.ts"})}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"libs/api-client/core/src/apollo/"})," (WebSocket link)"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"reconnection-architecture",children:"Reconnection Architecture"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 WebSocket Disconnects    \u2502\n\u2502 (network loss)           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n               \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Attempt Reconnect    \u2502\n    \u2502 (exponential backoff) \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502             \u2502\n     Success        Failure\n        \u2502             \u2502\n        \u25bc             \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2510      Attempt < 10?\n    \u2502 OK \u2502      \u251c\u2500 YES \u2192 Wait & retry\n    \u2514\u2500\u2500\u2500\u2500\u2518      \u2514\u2500 NO \u2192 Give up, show error\n                       "Maximum reconnection attempts exceeded"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"calculatebackoff-function",children:"calculateBackoff Function"}),"\n",(0,o.jsx)(n.p,{children:"Calculates exponential backoff with jitter to prevent thundering herd."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Formula:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"delay = min(baseDelay * 2^attempt + jitter, maxDelay)\n       = min(1000 * 2^n + random(0-1000), 30000)\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Timing:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"calculateBackoff(0) \u2192 ~1-2s\ncalculateBackoff(1) \u2192 ~2-3s\ncalculateBackoff(2) \u2192 ~4-5s\ncalculateBackoff(3) \u2192 ~8-9s\ncalculateBackoff(4) \u2192 ~16-17s\ncalculateBackoff(5+) \u2192 ~30s (capped)\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Example:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { calculateBackoff } from '@nasnet/state/stores';\n\n// Get delay for attempt 2\nconst delay = calculateBackoff(2);  // ~4000-5000ms\nawait sleep(delay);\nawait reconnect();\n"})}),"\n",(0,o.jsx)(n.h3,{id:"createreconnectionmanager-function",children:"createReconnectionManager Function"}),"\n",(0,o.jsx)(n.p,{children:"Creates a manager for handling WebSocket reconnection with status tracking."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Configuration:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"interface ReconnectionManagerConfig {\n  maxAttempts?: number;        // Default: 10\n  connect: () => Promise<void>; // Actual connection function\n  onStatusChange?: (status: WebSocketStatus) => void;\n  showNotifications?: boolean;  // Default: true\n}\n\ntype WebSocketStatus = 'connecting' | 'connected' | 'disconnected' | 'error';\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Example: Apollo WebSocket reconnection"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { createReconnectionManager } from '@nasnet/state/stores';\nimport { GraphQLWsLink } from '@apollo/client/link/subscriptions';\nimport { createClient } from 'graphql-ws';\n\n// Create reconnection manager\nconst reconnectionManager = createReconnectionManager({\n  maxAttempts: 10,\n  connect: async () => {\n    // Create WebSocket connection\n    const wsLink = new GraphQLWsLink(\n      createClient({\n        url: import.meta.env.VITE_WS_URL,\n      })\n    );\n    // Connection is ready after this call\n  },\n  onStatusChange: (status) => {\n    console.log('WebSocket status:', status);\n    useConnectionStore.getState().setWsStatus(status);\n  },\n  showNotifications: true,  // Show toast on connection/reconnection\n});\n\n// Handle connection loss\nwindow.addEventListener('offline', () => {\n  reconnectionManager.start();\n});\n\n// Successful connection\nwindow.addEventListener('online', () => {\n  reconnectionManager.reset();\n  reconnectionManager.start();\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Manager API:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"manager.start();              // Start reconnection attempts\nmanager.stop();               // Stop trying to reconnect\nmanager.reset();              // Reset attempt counter\nmanager.getAttempts();        // Get current attempt number\nmanager.isActive();           // Check if reconnecting\n"})}),"\n",(0,o.jsx)(n.h3,{id:"createlatencyupdater-function",children:"createLatencyUpdater Function"}),"\n",(0,o.jsx)(n.p,{children:"Debounced latency updater to track WebSocket ping latency without excessive store updates."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { createLatencyUpdater } from '@nasnet/state/stores';\n\nconst updateLatency = createLatencyUpdater(100);  // Update at most every 100ms\n\n// In WebSocket ping handler\nwsClient.on('pong', (time) => {\n  const latencyMs = Date.now() - time;\n  updateLatency(currentRouterId, latencyMs);  // Debounced update\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Benefits:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Prevents excessive Zustand updates during high-frequency pings"}),"\n",(0,o.jsx)(n.li,{children:"Limits store updates to max 10/second (100ms interval)"}),"\n",(0,o.jsx)(n.li,{children:"Keeps connection latency visible without performance impact"}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"integration-with-connection-store",children:"Integration with Connection Store"}),"\n",(0,o.jsxs)(n.p,{children:["The reconnection utilities update ",(0,o.jsx)(n.code,{children:"useConnectionStore"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import {\n  useConnectionStore,\n  type WebSocketStatus,\n} from '@nasnet/state/stores';\n\n// Reconnection manager updates these\nuseConnectionStore.getState().setWsStatus('connecting');\nuseConnectionStore.getState().setWsStatus('connected');\nuseConnectionStore.getState().setWsStatus('error', 'Max attempts exceeded');\nuseConnectionStore.getState().incrementReconnectAttempts();\nuseConnectionStore.getState().resetReconnection();\nuseConnectionStore.getState().updateLatency(routerId, latencyMs);\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Reading connection state:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"// Check if WebSocket is connected\nconst connected = useConnectionStore(state => state.websocketConnected);\n\n// Get current latency\nconst latency = useConnectionStore(state => state.latencies[currentRouterId]);\n\n// Get reconnection attempts\nconst attempts = useConnectionStore(state => state.reconnectAttempts);\n"})}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"testing-apollo-zustand-integration",children:"Testing Apollo-Zustand Integration"}),"\n",(0,o.jsx)(n.h3,{id:"mock-auth-store-in-tests",children:"Mock Auth Store in Tests"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { useAuthStore } from '@nasnet/state/stores';\nimport { renderHook } from '@testing-library/react';\n\ntest('auth link injects token', () => {\n  // Mock the auth store\n  useAuthStore.setState({ token: 'test-token-123' });\n\n  // Your link should now use 'test-token-123'\n  const headers = authLink.getContext();\n  expect(headers.Authorization).toBe('Bearer test-token-123');\n\n  // Clean up\n  useAuthStore.getState().clearAuth();\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"mock-error-handler",children:"Mock Error Handler"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"test('error link handles 401 errors', async () => {\n  // Mock notification store to track calls\n  const addNotificationSpy = jest.spyOn(\n    useNotificationStore.getState(),\n    'addNotification'\n  );\n\n  // Trigger 401 error\n  const error = new Error('Unauthorized');\n  (error as any).statusCode = 401;\n\n  errorLink.onError(error);\n\n  // Verify notification was shown\n  expect(addNotificationSpy).toHaveBeenCalledWith(\n    expect.objectContaining({ type: 'error' })\n  );\n});\n"})}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"section-guide",children:"Section Guide"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Token Refresh Integration"})," - Proactive JWT token refresh to maintain sessions (see ",(0,o.jsx)(n.code,{children:"useTokenRefresh"})," hook)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Error Recovery Integration"})," - Retry logic, cache clearing, and error reporting (see ",(0,o.jsx)(n.code,{children:"withRetry"}),", ",(0,o.jsx)(n.code,{children:"createRecoveryActions"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Reconnection Integration"})," - WebSocket reconnection with exponential backoff (see ",(0,o.jsx)(n.code,{children:"createReconnectionManager"}),", ",(0,o.jsx)(n.code,{children:"createLatencyUpdater"}),")"]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,o.jsx)(n.p,{children:"Apollo Client and Zustand integration enables:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Auth Context"}),": Auth link reads ",(0,o.jsx)(n.code,{children:"useAuthStore.getState()"})," to inject JWT tokens"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Error Handling"}),": Error link updates ",(0,o.jsx)(n.code,{children:"useAuthStore"})," on 401, shows notifications via ",(0,o.jsx)(n.code,{children:"useNotificationStore"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Real-time Updates"}),": Subscriptions push data into Zustand stores (e.g., alerts, statistics)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Connection State"}),": WebSocket state lives in ",(0,o.jsx)(n.code,{children:"useConnectionStore"})," for reactive UI"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Separation of Concerns"}),": Apollo manages server state, Zustand manages UI state"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"This architecture keeps server and UI state cleanly separated while allowing them to communicate when needed."})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var r=t(14041);const o={},i=r.createContext(o);function s(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);