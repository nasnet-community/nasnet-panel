"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[72632],{21393:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"connection-management","title":"Connection Management","description":"Per-router connection pool with circuit breaker protection, exponential-backoff reconnection, periodic health monitoring, and hardware/software capability detection with 24-hour caching.","source":"@site/../backend/docs/connection-management.md","sourceDirName":".","slug":"/connection-management","permalink":"/docs/backend/connection-management","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/connection-management.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Config Generation","permalink":"/docs/backend/config-generation"},"next":{"title":"Data Layer","permalink":"/docs/backend/data-layer"}}');var c=t(31085),i=t(71184);const o={},s="Connection Management",a={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference: <code>internal/connection</code>",id:"package-reference-internalconnection",level:2},{value:"Protocols",id:"protocols",level:3},{value:"Connection State Machine (<code>state.go</code>)",id:"connection-state-machine-statego",level:3},{value:"Connection Pool (<code>pool.go</code>)",id:"connection-pool-poolgo",level:3},{value:"Circuit Breaker (<code>circuit.go</code>)",id:"circuit-breaker-circuitgo",level:3},{value:"Connection Manager (<code>manager.go</code>)",id:"connection-manager-managergo",level:3},{value:"Exponential Backoff Reconnection (<code>manager_reconnect.go</code>)",id:"exponential-backoff-reconnection-manager_reconnectgo",level:3},{value:"Health Monitoring (<code>health.go</code>, <code>manager_health.go</code>)",id:"health-monitoring-healthgo-manager_healthgo",level:3},{value:"Package Reference: <code>internal/capability</code>",id:"package-reference-internalcapability",level:2},{value:"Overview",id:"overview-1",level:3},{value:"Core Types (<code>types.go</code>)",id:"core-types-typesgo",level:3},{value:"Detector (<code>detector.go</code>)",id:"detector-detectorgo",level:3},{value:"Capability Cache (<code>cache.go</code>)",id:"capability-cache-cachego",level:3},{value:"Capability Service (<code>cache.go</code>)",id:"capability-service-cachego",level:3},{value:"Version Compatibility Integration (<code>version_integration.go</code>)",id:"version-compatibility-integration-version_integrationgo",level:3},{value:"Interaction with Router Adapters",id:"interaction-with-router-adapters",level:2},{value:"Edge Cases &amp; Operational Notes",id:"edge-cases--operational-notes",level:2},{value:"Manual vs. Automatic Disconnect",id:"manual-vs-automatic-disconnect",level:3},{value:"Circuit Breaker and Reconnect Interaction",id:"circuit-breaker-and-reconnect-interaction",level:3},{value:"Pool Limits",id:"pool-limits",level:3},{value:"Capability Cache Invalidation",id:"capability-cache-invalidation",level:3},{value:"VIF Requirements",id:"vif-requirements",level:3},{value:"Cross-References",id:"cross-references",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"connection-management",children:"Connection Management"})}),"\n",(0,c.jsxs)(n.blockquote,{children:["\n",(0,c.jsx)(n.p,{children:"Per-router connection pool with circuit breaker protection, exponential-backoff reconnection, periodic health monitoring, and hardware/software capability detection with 24-hour caching."}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Packages:"})," ",(0,c.jsx)(n.code,{children:"internal/connection/"}),", ",(0,c.jsx)(n.code,{children:"internal/capability/"}),"\n",(0,c.jsx)(n.strong,{children:"Key Files:"})," ",(0,c.jsx)(n.code,{children:"connection/pool.go"}),", ",(0,c.jsx)(n.code,{children:"connection/circuit.go"}),", ",(0,c.jsx)(n.code,{children:"connection/manager_reconnect.go"}),", ",(0,c.jsx)(n.code,{children:"connection/state.go"}),", ",(0,c.jsx)(n.code,{children:"connection/manager.go"}),", ",(0,c.jsx)(n.code,{children:"connection/health.go"}),", ",(0,c.jsx)(n.code,{children:"capability/detector.go"}),", ",(0,c.jsx)(n.code,{children:"capability/cache.go"}),", ",(0,c.jsx)(n.code,{children:"capability/types.go"}),"\n",(0,c.jsx)(n.strong,{children:"Prerequisites:"})," [See: router-communication.md \xa7Protocol Adapters], [See: event-system.md \xa7Event Bus], [See: application-bootstrap.md \xa7Boot Sequence]"]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,c.jsx)(n.p,{children:"Connection management in NasNetConnect is split into two cooperating packages:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"internal/connection"})})," \u2014 Manages the lifecycle of each router connection (connect, disconnect, reconnect, health check) using a connection pool, per-router circuit breakers, and exponential-backoff retry loops."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"internal/capability"})})," \u2014 Detects what the connected router supports (hardware, software version, container support) and caches the result for 24 hours with background lazy refresh."]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["Both packages are initialized during application bootstrap and wired together through the ",(0,c.jsx)(n.code,{children:"Manager"})," type, which exposes a single, consistent API for the rest of the codebase to use."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502           Manager                   \u2502\n                    \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n GraphQL Resolvers  \u2502  \u2502   Pool   \u2502  \u2502 CircuitBreaker \u2502  \u2502\n \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502  \u2502 [routerId\u2502  \u2502 Factory        \u2502  \u2502\n Bootstrap / Events \u2502  \u2502 \u2192Conn]   \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                    \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502             \u2502\n                    \u2502        \u2502              \u2502per router   \u2502\n                    \u2502        \u25bc              \u25bc             \u2502\n                    \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n                    \u2502  \u2502 Connection                    \u2502  \u2502\n                    \u2502  \u2502  Status (State machine)       \u2502  \u2502\n                    \u2502  \u2502  Client (RouterClient iface)  \u2502  \u2502\n                    \u2502  \u2502  CircuitBreaker               \u2502  \u2502\n                    \u2502  \u2502  reconnectCancel              \u2502  \u2502\n                    \u2502  \u2502  healthCancel                 \u2502  \u2502\n                    \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u25bc               \u25bc               \u25bc\n      startReconnection  startHealthMonitoring  EventBus\n       (goroutine)         (goroutine)        (StatusChanged)\n\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502   capability.Service               \u2502\n                    \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n                    \u2502  \u2502 Detector \u2502  \u2502 MemoryCache  \u2502   \u2502\n                    \u2502  \u2502 (5 steps)\u2502  \u2502 (24h TTL)    \u2502   \u2502\n                    \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h2,{id:"package-reference-internalconnection",children:["Package Reference: ",(0,c.jsx)(n.code,{children:"internal/connection"})]}),"\n",(0,c.jsx)(n.h3,{id:"protocols",children:"Protocols"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'type Protocol string\n\nconst (\n    ProtocolREST    Protocol = "REST"     // RouterOS REST API (7.1+), port 80/443\n    ProtocolAPI     Protocol = "API"      // Binary API, port 8728\n    ProtocolAPISSL  Protocol = "API_SSL"  // TLS binary API, port 8729\n    ProtocolSSH     Protocol = "SSH"      // SSH, port 22\n    ProtocolTelnet  Protocol = "TELNET"   // Telnet, port 23\n)\n'})}),"\n",(0,c.jsxs)(n.p,{children:["The ",(0,c.jsx)(n.code,{children:"RouterClient"})," interface abstracts protocol adapters:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type RouterClient interface {\n    Connect(ctx context.Context) error\n    Disconnect() error\n    IsConnected() bool\n    Ping(ctx context.Context) error\n    Protocol() Protocol\n    Version() string\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:["A ",(0,c.jsx)(n.code,{children:"ClientFactory"})," is provided at ",(0,c.jsx)(n.code,{children:"Manager"})," construction time; it selects the appropriate adapter based on the connection configuration and available protocol."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"connection-state-machine-statego",children:["Connection State Machine (",(0,c.jsx)(n.code,{children:"state.go"}),")"]}),"\n",(0,c.jsx)(n.p,{children:"Each connection progresses through a finite set of states with validated transitions:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"DISCONNECTED \u2500\u2500\u25ba CONNECTING \u2500\u2500\u25ba CONNECTED \u2500\u2500\u25ba RECONNECTING \u2500\u2500\u25ba CONNECTED\n                     \u2502                               \u2502\n                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba ERROR \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                   \u2502\n                                   \u2514\u2500\u2500\u25ba DISCONNECTED (manual reset)\n"})}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"State"}),(0,c.jsx)(n.th,{children:"Meaning"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"StateDisconnected"})}),(0,c.jsx)(n.td,{children:"No active connection"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"StateConnecting"})}),(0,c.jsx)(n.td,{children:"Connection attempt in progress"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"StateConnected"})}),(0,c.jsx)(n.td,{children:"Active and responsive"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"StateReconnecting"})}),(0,c.jsx)(n.td,{children:"Lost connection, exponential-backoff retry active"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"StateError"})}),(0,c.jsx)(n.td,{children:"Permanently failed; manual reconnect required"})]})]})]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Status.SetState(newState)"})," enforces the transition table \u2014 invalid transitions return ",(0,c.jsx)(n.code,{children:"ErrInvalidStateTransition"}),". Convenience methods also record timestamps and reset counters:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"status.SetConnected(protocol, version) // records ConnectedAt, clears error fields\nstatus.SetDisconnected(reason)         // records DisconnectedAt\nstatus.SetReconnecting(attempt, nextAt)\nstatus.SetError(errMsg)                // records LastError, LastErrorTime\nstatus.RecordHealthCheck(passed bool)  // tracks HealthChecksPassed/Failed\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"DisconnectReason"})," encodes why the connection dropped:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"const (\n    DisconnectReasonManual          // user action \u2014 no auto-reconnect\n    DisconnectReasonNetworkFailure  // transient \u2014 triggers auto-reconnect\n    DisconnectReasonAuthFailure     // config error \u2014 no auto-reconnect\n    DisconnectReasonTimeout         // transient \u2014 triggers auto-reconnect\n    DisconnectReasonCircuitOpen     // circuit breaker handles recovery\n    DisconnectReasonShutdown        // graceful app exit\n)\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"reason.ShouldAutoReconnect()"})," returns ",(0,c.jsx)(n.code,{children:"true"})," only for ",(0,c.jsx)(n.code,{children:"NetworkFailure"})," and ",(0,c.jsx)(n.code,{children:"Timeout"}),"."]}),"\n",(0,c.jsxs)(n.p,{children:["The ",(0,c.jsx)(n.code,{children:"Status"})," struct surfaces all observable connection fields to the GraphQL API:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'type Status struct {\n    State               State\n    Protocol            string\n    PreferredProtocol   string\n    ConnectedAt         *time.Time\n    DisconnectedAt      *time.Time\n    LastError           string\n    LastErrorTime       *time.Time\n    DisconnectReason    DisconnectReason\n    ReconnectAttempts   int\n    NextReconnectAt     *time.Time\n    CircuitBreakerState string   // "CLOSED", "OPEN", "HALF_OPEN"\n    Version             string\n    LastHealthCheck     *time.Time\n    HealthChecksPassed  int\n    HealthChecksFailed  int\n}\n'})}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"connection-pool-poolgo",children:["Connection Pool (",(0,c.jsx)(n.code,{children:"pool.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Pool"})," is a thread-safe map of ",(0,c.jsx)(n.code,{children:"routerID \u2192 *Connection"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Pool struct { /* sync.RWMutex-guarded map */ }\n\nfunc NewPool() *Pool                       // unlimited connections\nfunc NewPoolWithLimit(max int) *Pool       // returns nil from GetOrCreate if full\n\nfunc (p *Pool) Get(routerID) *Connection\nfunc (p *Pool) GetOrCreate(routerID, Config, *CircuitBreaker) *Connection\nfunc (p *Pool) Add(conn *Connection)\nfunc (p *Pool) Remove(routerID) *Connection\nfunc (p *Pool) GetAll() []*Connection\nfunc (p *Pool) Count() int\nfunc (p *Pool) CountByState(state State) int\nfunc (p *Pool) CloseAll(ctx) error   // cancels goroutines, disconnects all clients\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Connection"})," holds the per-router state:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Connection struct {\n    RouterID        string\n    Status          *Status\n    Client          RouterClient\n    CircuitBreaker  *CircuitBreaker\n    // private: config, reconnectCancel, healthCancel, mu, manualDisconnect\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Thread-safe accessors use ",(0,c.jsx)(n.code,{children:"sync.RWMutex"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"conn.IsConnected() bool\nconn.UpdateStatus(func(*Status))     // atomic write with lock\nconn.GetStatus() Status              // returns a copy\nconn.SetClient(RouterClient)\nconn.GetClient() RouterClient\nconn.SetPreferredProtocol(Protocol)\nconn.SetManuallyDisconnected(bool)\n"})}),"\n",(0,c.jsx)(n.p,{children:"Reconnect rate-limiting (10-second minimum between manual attempts):"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"canAttempt, waitTime := conn.CanAttemptReconnect()\nconn.RecordReconnectAttempt()\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"TransitionError"})," is returned when an invalid state transition is attempted:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type TransitionError struct {\n    RouterID string\n    From, To State\n    Reason   string\n}\n"})}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"circuit-breaker-circuitgo",children:["Circuit Breaker (",(0,c.jsx)(n.code,{children:"circuit.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:["Each router connection has its own ",(0,c.jsx)(n.code,{children:"CircuitBreaker"})," instance backed by ",(0,c.jsx)(n.code,{children:"github.com/sony/gobreaker/v2"}),"."]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Default configuration"})," (",(0,c.jsx)(n.code,{children:"DefaultCircuitBreakerConfig()"}),"):"]}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Setting"}),(0,c.jsx)(n.th,{children:"Default"}),(0,c.jsx)(n.th,{children:"Meaning"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"MaxFailures"})}),(0,c.jsx)(n.td,{children:"3"}),(0,c.jsx)(n.td,{children:"Consecutive failures before OPEN"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"Timeout"})}),(0,c.jsx)(n.td,{children:"5 minutes"}),(0,c.jsx)(n.td,{children:"Cooldown before HALF_OPEN probe"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"MaxRequests"})}),(0,c.jsx)(n.td,{children:"1"}),(0,c.jsx)(n.td,{children:"Probe requests allowed in HALF_OPEN"})]})]})]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"States:"})}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"State"}),(0,c.jsx)(n.th,{children:"Behaviour"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"CLOSED"})}),(0,c.jsx)(n.td,{children:"Normal; all requests pass through"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"OPEN"})}),(0,c.jsxs)(n.td,{children:["Rejects all requests immediately; starts ",(0,c.jsx)(n.code,{children:"HealthMonitor"})," background probing"]})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"HALF_OPEN"})}),(0,c.jsx)(n.td,{children:"Allows one probe request; success \u2192 CLOSED, failure \u2192 OPEN"})]})]})]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"State transition callback"})," \u2014 wired at ",(0,c.jsx)(n.code,{children:"Manager"})," construction to update the connection's ",(0,c.jsx)(n.code,{children:"Status.CircuitBreakerState"})," and emit a log entry:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"func WithOnStateChange(fn func(routerID string, from, to gobreaker.State)) CircuitBreakerOption\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Execution wrappers:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'// Wraps a function; returns "open circuit: <original error>" if OPEN\ncb.Execute(func() (any, error)) (any, error)\ncb.ExecuteWithContext(ctx, func(ctx) (any, error)) (any, error)\n\n// Inspection\ncb.State() gobreaker.State\ncb.StateString() string   // "CLOSED" | "OPEN" | "HALF_OPEN"\ncb.IsOpen() bool\ncb.IsClosed() bool\ncb.IsHalfOpen() bool\ncb.Counts() gobreaker.Counts  // Requests, TotalSuccesses, TotalFailures, etc.\n'})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"CircuitBreakerFactory"})," creates per-router breakers from shared configuration:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'factory := NewCircuitBreakerFactory(config, onStateChangeFn)\ncb := factory.Create(routerID) // named "router-<routerID>"\n'})}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"connection-manager-managergo",children:["Connection Manager (",(0,c.jsx)(n.code,{children:"manager.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Manager"})," orchestrates the pool, circuit breakers, reconnect loops, and health monitoring:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Manager struct {\n    pool          *Pool\n    cbFactory     *CircuitBreakerFactory\n    eventBus      events.EventBus\n    logger        *zap.Logger\n    clientFactory ClientFactory\n    backoffConfig BackoffConfig\n    healthConfig  HealthConfig\n    // private: mu, closed, wg\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Construction:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"mgr := connection.NewManager(eventBus, clientFactory, logger, connection.DefaultManagerConfig())\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"DefaultManagerConfig()"})," composes the defaults from all sub-systems:"]}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Sub-system"}),(0,c.jsx)(n.th,{children:"Key Default"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Circuit breaker"}),(0,c.jsx)(n.td,{children:"3 failures \u2192 OPEN, 5-min timeout"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Backoff"}),(0,c.jsx)(n.td,{children:"initial=1s, max=30s, multiplier=2, jitter=0.5"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"Health check"}),(0,c.jsx)(n.td,{children:"interval=30s, timeout=5s, threshold=3 failures"})]})]})]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Core operations:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"// Establish connection (circuit-breaker-protected)\nmgr.Connect(ctx, routerID, config) error\n\n// Close connection with reason\nmgr.Disconnect(routerID, DisconnectReason) error\n\n// Manual reconnect (rate-limited: 10s between attempts)\nmgr.Reconnect(ctx, routerID) error\n\n// Retrieve status\nmgr.GetStatus(routerID) (Status, error)\nmgr.GetConnection(routerID) (*Connection, error)\nmgr.GetAllConnections() []*Connection\n\n// Change preferred protocol (for next connect)\nmgr.SetPreferredProtocol(routerID, Protocol) error\n\n// Remove and disconnect a router\nmgr.RemoveConnection(routerID) error\n\n// Graceful shutdown (waits for goroutines)\nmgr.Close() error\n\n// Aggregate statistics\nmgr.Stats() ManagerStats  // TotalConnections, Connected, Connecting, \u2026\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Connection error handling"})," \u2014 ",(0,c.jsx)(n.code,{children:"handleConnectionError()"}),":"]}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["Updates ",(0,c.jsx)(n.code,{children:"Status"})," to ",(0,c.jsx)(n.code,{children:"StateError"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["Publishes a ",(0,c.jsx)(n.code,{children:"StatusChanged"})," event on the event bus."]}),"\n",(0,c.jsxs)(n.li,{children:["Unless manually disconnected or circuit breaker is OPEN, calls ",(0,c.jsx)(n.code,{children:"startReconnection()"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"exponential-backoff-reconnection-manager_reconnectgo",children:["Exponential Backoff Reconnection (",(0,c.jsx)(n.code,{children:"manager_reconnect.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"startReconnection()"})," spawns a goroutine that calls ",(0,c.jsx)(n.code,{children:"reconnectLoop()"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"// BackoffConfig defaults (per story spec)\nDefaultBackoffConfig() = {\n    InitialInterval:     1 * time.Second,\n    MaxInterval:         30 * time.Second,\n    Multiplier:          2.0,\n    RandomizationFactor: 0.5,   // \xb150% jitter\n    MaxElapsedTime:      0,      // never give up automatically\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Reconnect loop logic:"})}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["Transition to ",(0,c.jsx)(n.code,{children:"StateReconnecting"}),", publish event."]}),"\n",(0,c.jsxs)(n.li,{children:["Create ",(0,c.jsx)(n.code,{children:"backoff.ExponentialBackOffWithContext"})," (respects context cancellation)."]}),"\n",(0,c.jsxs)(n.li,{children:["On each attempt:\na. Bail if ",(0,c.jsx)(n.code,{children:"manualDisconnect"})," \u2192 ",(0,c.jsx)(n.code,{children:"backoff.Permanent(err)"}),".\nb. Bail if circuit breaker is OPEN \u2192 ",(0,c.jsx)(n.code,{children:"backoff.Permanent(err)"}),".\nc. Call ",(0,c.jsx)(n.code,{children:"clientFactory.CreateClient()"})," + ",(0,c.jsx)(n.code,{children:"client.Connect()"})," inside ",(0,c.jsx)(n.code,{children:"cb.ExecuteWithContext()"}),".\nd. Record ",(0,c.jsx)(n.code,{children:"lastReconnectAttempt"}),", increment ",(0,c.jsx)(n.code,{children:"ReconnectAttempts"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["On permanent failure:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["If manual disconnect: \u2192 ",(0,c.jsx)(n.code,{children:"StateDisconnected"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["Otherwise: \u2192 ",(0,c.jsx)(n.code,{children:"StateError"}),"."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["On success:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Set client on connection."}),"\n",(0,c.jsxs)(n.li,{children:["Transition to ",(0,c.jsx)(n.code,{children:"StateConnected"}),"."]}),"\n",(0,c.jsx)(n.li,{children:"Publish event."}),"\n",(0,c.jsxs)(n.li,{children:["Call ",(0,c.jsx)(n.code,{children:"startHealthMonitoring()"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["The backoff goroutine holds a ",(0,c.jsx)(n.code,{children:"context.CancelFunc"})," stored on ",(0,c.jsx)(n.code,{children:"Connection.reconnectCancel"})," so it can be cancelled by ",(0,c.jsx)(n.code,{children:"Disconnect()"})," or ",(0,c.jsx)(n.code,{children:"Close()"}),"."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"health-monitoring-healthgo-manager_healthgo",children:["Health Monitoring (",(0,c.jsx)(n.code,{children:"health.go"}),", ",(0,c.jsx)(n.code,{children:"manager_health.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Periodic health checks"})," (",(0,c.jsx)(n.code,{children:"startHealthMonitoring"}),"):"]}),"\n",(0,c.jsxs)(n.p,{children:["After a successful connection (or reconnection), a goroutine runs ",(0,c.jsx)(n.code,{children:"Ping()"})," on the established client every ",(0,c.jsx)(n.code,{children:"HealthConfig.Interval"})," (default 30 s). Three consecutive failures (configurable via ",(0,c.jsx)(n.code,{children:"HealthConfig.FailureThreshold"}),") trigger automatic reconnection."]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"HealthMonitor"})})," \u2014 handles background probing during the OPEN circuit-breaker window:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type HealthMonitor struct { /* manager, eventBus, interval=30s, timeout=5s */ }\n\n// For circuit-OPEN routers: probe without going through the breaker\nhm.StartBackgroundMonitoring(routerID)\nhm.StopBackgroundMonitoring(routerID)\nhm.StopAll()\n\n// On-demand health check (goes through established client)\nresult, err := hm.CheckHealth(ctx, routerID)\n// \u2192 HealthResult{RouterID, Healthy, CheckedAt, ResponseTimeMs, Error}\n\n// Is the connection currently healthy?\nhm.IsHealthy(routerID) bool\n\n// Detailed stats\nstats, err := hm.GetHealthStats(routerID)\n// \u2192 HealthStats{RouterID, ConsecutivePassed, ConsecutiveFailed, LastCheck, IsHealthy}\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Background health check events are published on the event bus as ",(0,c.jsx)(n.code,{children:"MetricUpdatedEvent"})," with metric name ",(0,c.jsx)(n.code,{children:'"health_check"'}),"."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h2,{id:"package-reference-internalcapability",children:["Package Reference: ",(0,c.jsx)(n.code,{children:"internal/capability"})]}),"\n",(0,c.jsx)(n.h3,{id:"overview-1",children:"Overview"}),"\n",(0,c.jsx)(n.p,{children:"Capability detection interrogates a connected router to build a complete profile of what it supports: hardware specs, RouterOS version, installed packages, and container configuration. Results are cached in an in-memory L1 cache with a 24-hour TTL and stale-while-revalidate at the 12-hour mark."}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"core-types-typesgo",children:["Core Types (",(0,c.jsx)(n.code,{children:"types.go"}),")"]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Capability constants:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'const (\n    CapabilityContainer  Capability = "CONTAINER"\n    CapabilityVIF        Capability = "VIF"\n    CapabilityWireless   Capability = "WIRELESS"\n    CapabilityRouting    Capability = "ROUTING"\n    CapabilityFirewall   Capability = "FIREWALL"\n    CapabilityMPLS       Capability = "MPLS"\n    CapabilityIPv6       Capability = "IPV6"\n    CapabilityWireGuard  Capability = "WIREGUARD"\n    CapabilityRESTAPI    Capability = "REST_API"\n    CapabilityBinaryAPI  Capability = "BINARY_API"\n    CapabilityACME       Capability = "ACME"\n    CapabilityWiFiWave2  Capability = "WIFI_WAVE2"\n    // \u2026 and more\n)\n'})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Support levels:"})}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Level"}),(0,c.jsx)(n.th,{children:"Value"}),(0,c.jsx)(n.th,{children:"Meaning"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"LevelNone"})}),(0,c.jsx)(n.td,{children:"0"}),(0,c.jsx)(n.td,{children:"Not supported \u2014 hide in UI"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"LevelBasic"})}),(0,c.jsx)(n.td,{children:"1"}),(0,c.jsx)(n.td,{children:"Limited support \u2014 show with warnings"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"LevelAdvanced"})}),(0,c.jsx)(n.td,{children:"2"}),(0,c.jsx)(n.td,{children:"Full RouterOS native support"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"LevelFull"})}),(0,c.jsx)(n.td,{children:"3"}),(0,c.jsx)(n.td,{children:"Complete including container-based features"})]})]})]}),"\n",(0,c.jsxs)(n.p,{children:["The ",(0,c.jsx)(n.code,{children:"@capability"})," directive uses level \u2265 1 (",(0,c.jsx)(n.code,{children:"BASIC"}),") as its threshold."]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsxs)(n.strong,{children:[(0,c.jsx)(n.code,{children:"Capabilities"})," struct"]})," \u2014 the complete capability profile:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Capabilities struct {\n    Hardware     HardwareInfo    // Architecture, Model, TotalMemory, CPUCount, etc.\n    Software     SoftwareInfo    // Version (RouterOSVersion), InstalledPackages, LicenseLevel\n    Container    ContainerInfo   // PackageInstalled, Enabled, StorageAvailable, MaxContainers\n    Entries      map[Capability]Entry  // capability \u2192 {Level, Description, Guidance}\n    DetectedAt   time.Time\n    ExpiresAt    time.Time       // DetectedAt + 24h\n    IsRefreshing bool\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Key methods on ",(0,c.jsx)(n.code,{children:"Capabilities"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"caps.GetLevel(cap) Level\ncaps.HasCapability(cap, minLevel) bool\ncaps.IsExpired() bool\ncaps.IsStale() bool          // > 12h since detection \u2192 trigger background refresh\ncaps.SetEntry(cap, level, description, guidance)\ncaps.CheckVIFRequirements() VIFRequirements  // detailed VIF readiness report\ncaps.VIFGuidance() []VIFGuidanceStep         // step-by-step remediation\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"RouterOSVersion"})})," \u2014 parsed semantic version with feature gates:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"v.SupportsREST() bool        // 7.1+\nv.SupportsContainers() bool  // 7.4+\nv.SupportsVIF() bool         // 7.13+\nv.SupportsWireGuard() bool   // 7.0+\n"})}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"detector-detectorgo",children:["Detector (",(0,c.jsx)(n.code,{children:"detector.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:["The detector queries the router through a ",(0,c.jsx)(n.code,{children:"RouterPort"})," interface (satisfied by any router adapter):"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type RouterPort interface {\n    QueryState(ctx context.Context, query StateQuery) (*StateResult, error)\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Detect(ctx, port)"})," runs five steps in sequence:"]}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Step"}),(0,c.jsx)(n.th,{children:"RouterOS Path"}),(0,c.jsx)(n.th,{children:"Purpose"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"1"}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"/system/resource"})}),(0,c.jsx)(n.td,{children:"Version, architecture, CPU count, memory, storage, board"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"2"}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"/system/package"})}),(0,c.jsxs)(n.td,{children:["Installed package list; sets ",(0,c.jsx)(n.code,{children:"HasWirelessChip"}),", ",(0,c.jsx)(n.code,{children:"HasLTEModule"}),", ",(0,c.jsx)(n.code,{children:"PackageInstalled"})," (container)"]})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"3"}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"/system/routerboard"})}),(0,c.jsx)(n.td,{children:"Hardware model (non-fatal if missing)"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"4"}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"/container/config"})}),(0,c.jsxs)(n.td,{children:["Container enabled, registry configured; computes ",(0,c.jsx)(n.code,{children:"MaxContainers"})]})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:"5"}),(0,c.jsx)(n.td,{children:"(in-memory)"}),(0,c.jsxs)(n.td,{children:[(0,c.jsx)(n.code,{children:"computeCapabilityLevels()"})," \u2014 derives ",(0,c.jsx)(n.code,{children:"Entries"})," map from gathered data"]})]})]})]}),"\n",(0,c.jsx)(n.p,{children:"The routerboard step is non-fatal: CHR and cloud instances may not expose this path."}),"\n",(0,c.jsxs)(n.p,{children:["Container ",(0,c.jsx)(n.code,{children:"MaxContainers"})," is estimated as: ",(0,c.jsx)(n.code,{children:"min(totalMemory / 50MB, 10)"}),"."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"capability-cache-cachego",children:["Capability Cache (",(0,c.jsx)(n.code,{children:"cache.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Cache"})," interface backed by ",(0,c.jsx)(n.code,{children:"memoryCache"})," (in-memory, no persistence):"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Cache interface {\n    Get(routerID string) (*Capabilities, bool)  // nil, false if expired\n    Set(routerID string, caps *Capabilities)    // stores with ExpiresAt from caps\n    Invalidate(routerID string)\n    InvalidateAll()\n    MarkRefreshing(routerID string, refreshing bool)\n    IsRefreshing(routerID string) bool\n}\n\nfunc NewMemoryCache() Cache\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Get"})," returns a copy of capabilities with ",(0,c.jsx)(n.code,{children:"IsRefreshing = true"})," injected if a background refresh is in progress \u2014 so callers always get a valid snapshot, never a stale pointer."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"capability-service-cachego",children:["Capability Service (",(0,c.jsx)(n.code,{children:"cache.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"Service"})," wraps detector + cache with stale-while-revalidate semantics:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"type Service struct {\n    detector Detector\n    cache    Cache\n}\n\nfunc NewService(detector, cache) *Service\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsxs)(n.strong,{children:[(0,c.jsx)(n.code,{children:"GetCapabilities(ctx, routerID, portGetter)"}),":"]})}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:"Cache hit \u2192 return immediately."}),"\n",(0,c.jsxs)(n.li,{children:["If cached but stale (> 12h) and not already refreshing \u2192 spawn ",(0,c.jsx)(n.code,{children:"backgroundRefresh()"})," goroutine, still return cached data."]}),"\n",(0,c.jsxs)(n.li,{children:["Cache miss \u2192 ",(0,c.jsx)(n.code,{children:"detectAndCache()"})," (blocking)."]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"RefreshCapabilities(ctx, routerID, portGetter)"})})," \u2014 force re-detect, bypass cache."]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"Invalidate(routerID)"})})," \u2014 used when the router is disconnected or credentials change."]}),"\n",(0,c.jsx)(n.p,{children:"Background refresh is silent on failure \u2014 it never degrades currently-serving cached data."}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsxs)(n.h3,{id:"version-compatibility-integration-version_integrationgo",children:["Version Compatibility Integration (",(0,c.jsx)(n.code,{children:"version_integration.go"}),")"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"VersionCapabilityIntegration"})," bridges the hardware-detected ",(0,c.jsx)(n.code,{children:"Capabilities"})," with the version-based ",(0,c.jsx)(n.code,{children:"router/compatibility.Service"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:'integration := capability.NewVersionCapabilityIntegration()\n\n// Enrich capabilities entries based on version feature gates\nintegration.EnhanceCapabilities(caps, isCHR)\n\n// Query specific feature support (version + package check)\ninfo := integration.GetFeatureSupport(caps, "rest_api", isCHR)\n// \u2192 FeatureSupportInfo{Supported, Reason, UpgradeURL, RequiredPkg}\n\n// Batch queries\nsupported := integration.GetSupportedFeatures(caps, isCHR)\nunsupported := integration.GetUnsupportedFeatures(caps, isCHR)\n'})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"EnhanceCapabilities"})," sets capability entries for: ",(0,c.jsx)(n.code,{children:"REST_API"}),", ",(0,c.jsx)(n.code,{children:"BINARY_API"}),", ",(0,c.jsx)(n.code,{children:"ZEROTIER"}),", ",(0,c.jsx)(n.code,{children:"ACME"}),", ",(0,c.jsx)(n.code,{children:"WIFI_WAVE2"})," \u2014 combining version gate checks with installed-package checks."]}),"\n",(0,c.jsx)(n.p,{children:"Version conversion helpers:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"capability.ConvertToCompatibilityVersion(RouterOSVersion) compatibility.Version\ncapability.ConvertFromCompatibilityVersion(compatibility.Version) RouterOSVersion\n"})}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.h2,{id:"interaction-with-router-adapters",children:"Interaction with Router Adapters"}),"\n",(0,c.jsxs)(n.p,{children:["The ",(0,c.jsx)(n.code,{children:"connection.Manager"})," depends on a ",(0,c.jsx)(n.code,{children:"ClientFactory"})," that is provided at construction. The factory is responsible for selecting and constructing the correct protocol adapter (REST, API, SSH, Telnet). This is wired during bootstrap:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-go",children:"// See: application-bootstrap.md \xa7Boot Sequence\nmgr := connection.NewManager(eventBus, routerClientFactory, logger, cfg)\n"})}),"\n",(0,c.jsxs)(n.p,{children:["When ",(0,c.jsx)(n.code,{children:"Manager.Connect()"})," is called, it passes the connection ",(0,c.jsx)(n.code,{children:"Config"})," (host, port, credentials, preferred protocol) to ",(0,c.jsx)(n.code,{children:"ClientFactory.CreateClient()"}),". The factory implements fallback chain logic \u2014 it tries the preferred protocol first, then falls back through REST \u2192 API \u2192 SSH \u2192 Telnet until one succeeds. [See: router-communication.md \xa7Fallback Chain]"]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.h2,{id:"edge-cases--operational-notes",children:"Edge Cases & Operational Notes"}),"\n",(0,c.jsx)(n.h3,{id:"manual-vs-automatic-disconnect",children:"Manual vs. Automatic Disconnect"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"manualDisconnect = true"})," (set by ",(0,c.jsx)(n.code,{children:"Disconnect(_, DisconnectReasonManual)"}),") suppresses:"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Automatic reconnect trigger after ",(0,c.jsx)(n.code,{children:"handleConnectionError"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["The reconnect loop's retry attempts (returns ",(0,c.jsx)(n.code,{children:"backoff.Permanent"}),")."]}),"\n",(0,c.jsx)(n.li,{children:"The background health monitor's ability to re-establish the connection."}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["Calling ",(0,c.jsx)(n.code,{children:"Reconnect()"})," clears this flag before attempting."]}),"\n",(0,c.jsx)(n.h3,{id:"circuit-breaker-and-reconnect-interaction",children:"Circuit Breaker and Reconnect Interaction"}),"\n",(0,c.jsx)(n.p,{children:"When the circuit breaker is OPEN:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"reconnectLoop"})," returns ",(0,c.jsx)(n.code,{children:"backoff.Permanent"})," immediately (avoids wasteful retries)."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"HealthMonitor.StartBackgroundMonitoring()"})," begins external probing at 30-second intervals without going through the breaker."]}),"\n",(0,c.jsxs)(n.li,{children:["If a probe succeeds, the event bus fires ",(0,c.jsx)(n.code,{children:"health_check"})," passed \u2192 upstream logic can trigger a manual reconnect to close the breaker via the HALF_OPEN probe."]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"pool-limits",children:"Pool Limits"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"NewPoolWithLimit(max)"})," creates a pool that returns ",(0,c.jsx)(n.code,{children:"nil"})," from ",(0,c.jsx)(n.code,{children:"GetOrCreate"})," when full. The Manager logs a ",(0,c.jsx)(n.code,{children:"Warn"})," and ",(0,c.jsx)(n.code,{children:"Connect"})," returns an error. Default production configuration uses an unlimited pool (",(0,c.jsx)(n.code,{children:"NewPool()"}),")."]}),"\n",(0,c.jsx)(n.h3,{id:"capability-cache-invalidation",children:"Capability Cache Invalidation"}),"\n",(0,c.jsx)(n.p,{children:"Cache entries are automatically invalidated when:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Service.Invalidate(routerID)"})," is called explicitly (e.g., router removal)."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Service.RefreshCapabilities()"})," is called (explicit re-detect)."]}),"\n",(0,c.jsxs)(n.li,{children:["The 24-hour TTL expires (on next ",(0,c.jsx)(n.code,{children:"Get"})," call)."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"There is no proactive eviction \u2014 stale entries remain until queried."}),"\n",(0,c.jsx)(n.h3,{id:"vif-requirements",children:"VIF Requirements"}),"\n",(0,c.jsxs)(n.p,{children:["The ",(0,c.jsx)(n.code,{children:"CheckVIFRequirements()"})," method provides a structured checklist used by the UI to guide users through enabling VIF:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"1. RouterOS 7.13+ \u2713 / \u2717\n2. Container package installed \u2713 / \u2717\n3. Container feature enabled \u2713 / \u2717\n4. \u2265 100 MB free storage \u2713 / \u2717\n5. arm64/x86_64 architecture (network namespace) \u2713 / \u2717\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"VIFGuidance()"})," returns ordered ",(0,c.jsx)(n.code,{children:"VIFGuidanceStep"})," items with RouterOS commands for the resolver to surface in the API."]}),"\n",(0,c.jsx)(n.hr,{}),"\n",(0,c.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"[See: application-bootstrap.md \xa7Boot Sequence] \u2014 Manager and capability service construction"}),"\n",(0,c.jsx)(n.li,{children:"[See: router-communication.md \xa7Protocol Adapters] \u2014 ClientFactory and RouterClient implementations"}),"\n",(0,c.jsx)(n.li,{children:"[See: router-communication.md \xa7Fallback Chain] \u2014 Protocol selection logic"}),"\n",(0,c.jsxs)(n.li,{children:["[See: event-system.md \xa7Events] \u2014 ",(0,c.jsx)(n.code,{children:"StatusChangedEvent"}),", ",(0,c.jsx)(n.code,{children:"MetricUpdatedEvent"})," published by Manager and HealthMonitor"]}),"\n",(0,c.jsxs)(n.li,{children:["[See: graphql-api.md \xa7Directives] \u2014 ",(0,c.jsx)(n.code,{children:"@capability"})," directive consuming ",(0,c.jsx)(n.code,{children:"Capabilities"})," from context"]}),"\n",(0,c.jsxs)(n.li,{children:["[See: error-handling.md \xa7Error Types] \u2014 ",(0,c.jsx)(n.code,{children:"TransitionError"}),", ",(0,c.jsx)(n.code,{children:"RouterError"})," used in this package"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var r=t(14041);const c={},i=r.createContext(c);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);