"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[16304],{47919:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"testing-and-codegen","title":"Testing and Code Generation","description":"This document covers how to test Apollo Client hooks in NasNetConnect, how the graphql-codegen pipeline transforms GraphQL schema and operations into TypeScript types and React hooks, how possibleTypes enables polymorphic type resolution, how Zod schemas integrate with react-hook-form, and the step-by-step process for adding a brand-new domain.","source":"@site/../../libs/api-client/docs/testing-and-codegen.md","sourceDirName":".","slug":"/testing-and-codegen","permalink":"/docs/api-client/testing-and-codegen","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/api-client/docs/testing-and-codegen.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Service Lifecycle","permalink":"/docs/api-client/service-lifecycle"},"next":{"title":"WebSocket Subscriptions","permalink":"/docs/api-client/websocket-subscriptions"}}');var r=t(31085),i=t(71184);const o={},a="Testing and Code Generation",c={},d=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"1. Testing Stack Overview",id:"1-testing-stack-overview",level:2},{value:"2. MockApolloProvider \u2014 Storybook and Loading-State Tests",id:"2-mockapolloprovider--storybook-and-loading-state-tests",level:2},{value:"When to Use MockApolloProvider",id:"when-to-use-mockapolloprovider",level:3},{value:"When NOT to Use MockApolloProvider",id:"when-not-to-use-mockapolloprovider",level:3},{value:"3. MockedProvider \u2014 Data-Driven Unit Tests",id:"3-mockedprovider--data-driven-unit-tests",level:2},{value:"Basic Query Test",id:"basic-query-test",level:3},{value:"Error Responses",id:"error-responses",level:3},{value:"GraphQL Errors (partial data)",id:"graphql-errors-partial-data",level:3},{value:"addTypename",id:"addtypename",level:3},{value:"Providing a Custom Cache",id:"providing-a-custom-cache",level:3},{value:"renderHook for Hook-Only Tests",id:"renderhook-for-hook-only-tests",level:3},{value:"4. Subscription Test Utilities",id:"4-subscription-test-utilities",level:2},{value:"createMockSubscription",id:"createmocksubscription",level:3},{value:"createMockSubscriptionError",id:"createmocksubscriptionerror",level:3},{value:"createMockInfiniteSubscription",id:"createmockinfinitesubscription",level:3},{value:"collectSubscriptionValues",id:"collectsubscriptionvalues",level:3},{value:"Using Subscription Mocks with MockedProvider",id:"using-subscription-mocks-with-mockedprovider",level:3},{value:"5. Testing Mutations and Cache Updates",id:"5-testing-mutations-and-cache-updates",level:2},{value:"Cache Update After Mutation",id:"cache-update-after-mutation",level:3},{value:"Optimistic Responses",id:"optimistic-responses",level:3},{value:"6. Codegen Pipeline",id:"6-codegen-pipeline",level:2},{value:"Inputs",id:"inputs",level:3},{value:"Outputs",id:"outputs",level:3},{value:"Run Commands",id:"run-commands",level:3},{value:"types.ts Configuration",id:"typests-configuration",level:3},{value:"operations.ts Configuration",id:"operationsts-configuration",level:3},{value:"Post-Generation Hook",id:"post-generation-hook",level:3},{value:"7. possibleTypes \u2014 Polymorphism in the Cache",id:"7-possibletypes--polymorphism-in-the-cache",level:2},{value:"The Generated Map",id:"the-generated-map",level:3},{value:"How It Is Used",id:"how-it-is-used",level:3},{value:"When to Regenerate",id:"when-to-regenerate",level:3},{value:"7.1. Generated Module Barrel Exports",id:"71-generated-module-barrel-exports",level:2},{value:"What Gets Exported",id:"what-gets-exported",level:3},{value:"Import Patterns",id:"import-patterns",level:3},{value:"Zod Schemas Status and Gap",id:"zod-schemas-status-and-gap",level:3},{value:"8. Zod Schemas and react-hook-form",id:"8-zod-schemas-and-react-hook-form",level:2},{value:"Re-Exported Network Validators",id:"re-exported-network-validators",level:3},{value:"Schema Utility Helpers",id:"schema-utility-helpers",level:3},{value:"Example Schemas in the Generated Module",id:"example-schemas-in-the-generated-module",level:3},{value:"dhcpServerConfigSchema",id:"dhcpserverconfigschema",level:4},{value:"firewallRuleInputSchema",id:"firewallruleinputschema",level:4},{value:"wireguardPeerSchema",id:"wireguardpeerschema",level:4},{value:"Integration with react-hook-form",id:"integration-with-react-hook-form",level:3},{value:"Composing Custom Schemas",id:"composing-custom-schemas",level:3},{value:"9. Adding a New Domain \u2014 Step-by-Step",id:"9-adding-a-new-domain--step-by-step",level:2},{value:"Step 1: Define the GraphQL Schema",id:"step-1-define-the-graphql-schema",level:3},{value:"Step 2: Run Codegen",id:"step-2-run-codegen",level:3},{value:"Step 3: Create the Domain Directory",id:"step-3-create-the-domain-directory",level:3},{value:"Step 4: Write example.graphql.ts",id:"step-4-write-examplegraphqlts",level:3},{value:"Step 5: Write queryKeys.ts",id:"step-5-write-querykeysts",level:3},{value:"Step 6: Write useExampleItems.ts",id:"step-6-write-useexampleitemsts",level:3},{value:"Step 7: Write useExampleMutations.ts",id:"step-7-write-useexamplemutationsts",level:3},{value:"Step 8: Write useExampleSubscriptions.ts",id:"step-8-write-useexamplesubscriptionsts",level:3},{value:"Step 9: Write index.ts",id:"step-9-write-indexts",level:3},{value:"Step 10: Register in the Queries Barrel",id:"step-10-register-in-the-queries-barrel",level:3},{value:"Step 11: Add a Zod Schema (if needed)",id:"step-11-add-a-zod-schema-if-needed",level:3},{value:"Step 12: Write Tests",id:"step-12-write-tests",level:3},{value:"Step 13: Update possibleTypes (if needed)",id:"step-13-update-possibletypes-if-needed",level:3},{value:"Step 14: Update Backend Resolvers",id:"step-14-update-backend-resolvers",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"testing-and-code-generation",children:"Testing and Code Generation"})}),"\n",(0,r.jsxs)(n.p,{children:["This document covers how to test Apollo Client hooks in NasNetConnect, how the ",(0,r.jsx)(n.code,{children:"graphql-codegen"})," pipeline transforms GraphQL schema and operations into TypeScript types and React hooks, how ",(0,r.jsx)(n.code,{children:"possibleTypes"})," enables polymorphic type resolution, how Zod schemas integrate with ",(0,r.jsx)(n.code,{children:"react-hook-form"}),", and the step-by-step process for adding a brand-new domain."]}),"\n",(0,r.jsxs)(n.p,{children:["Related docs: ",(0,r.jsx)(n.a,{href:"/docs/api-client/apollo-client",children:"./apollo-client.md"})," (Apollo setup), ",(0,r.jsx)(n.a,{href:"/docs/api-client/domain-query-hooks",children:"./domain-query-hooks.md"})," (domain hooks), ",(0,r.jsx)(n.a,{href:"/docs/api-client/universal-state-resource-model",children:"./universal-state-resource-model.md"})," (resource types)."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#1-testing-stack-overview",children:"Testing Stack Overview"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#2-mockapolloprovider--storybook-and-loading-state-tests",children:"MockApolloProvider \u2014 Storybook and Loading-State Tests"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#3-mockedprovider--data-driven-unit-tests",children:"MockedProvider \u2014 Data-Driven Unit Tests"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#4-subscription-test-utilities",children:"Subscription Test Utilities"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#5-testing-mutations-and-cache-updates",children:"Testing Mutations and Cache Updates"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#6-codegen-pipeline",children:"Codegen Pipeline"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#7-possibletypes--polymorphism-in-the-cache",children:"possibleTypes \u2014 Polymorphism in the Cache"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#8-zod-schemas-and-react-hook-form",children:"Zod Schemas and react-hook-form"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#9-adding-a-new-domain--step-by-step",children:"Adding a New Domain \u2014 Step-by-Step"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-testing-stack-overview",children:"1. Testing Stack Overview"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Layer"}),(0,r.jsx)(n.th,{children:"Tool"}),(0,r.jsx)(n.th,{children:"Where"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Test runner"}),(0,r.jsx)(n.td,{children:"Vitest"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"vitest.config.ts"})," at repo root"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Component rendering"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"@testing-library/react"})}),(0,r.jsx)(n.td,{children:"All feature tests"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Apollo mocking"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"@apollo/client/testing"})," \u2192 ",(0,r.jsx)(n.code,{children:"MockedProvider"})]}),(0,r.jsx)(n.td,{children:"Unit tests with specific data"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Apollo loading-state mocking"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"MockApolloProvider"})," (custom)"]}),(0,r.jsx)(n.td,{children:"Storybook + skeleton tests"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Subscription mocking"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"createMockSubscription"})," (custom utils)"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"core/src/apollo/__tests__/subscription-test-utils.ts"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Accessibility"}),(0,r.jsx)(n.td,{children:"axe-core + Pa11y (CI)"}),(0,r.jsx)(n.td,{children:"Blocking gate in CI"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"E2E"}),(0,r.jsx)(n.td,{children:"Playwright"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"apps/connect-e2e/"})})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["All tests are co-located with source files (",(0,r.jsx)(n.code,{children:"*.test.ts"}),", ",(0,r.jsx)(n.code,{children:"*.test.tsx"}),") or in ",(0,r.jsx)(n.code,{children:"__tests__/"})," subdirectories."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-mockapolloprovider--storybook-and-loading-state-tests",children:"2. MockApolloProvider \u2014 Storybook and Loading-State Tests"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-mock-provider.tsx"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"MockApolloProvider"})," is a minimal Apollo context that keeps all queries in a permanent loading state. Its purpose is to satisfy Apollo's React context requirement in Storybook stories and in tests that only care about rendering the skeleton/loading UI."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"// The provider itself:\nexport function MockApolloProvider({ children }: MockApolloProviderProps) {\n  return (\n    <ApolloProvider client={mockApolloClient}>\n      {children}\n    </ApolloProvider>\n  );\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Internally it uses a ",(0,r.jsx)(n.code,{children:"noOpLink"})," \u2014 an ",(0,r.jsx)(n.code,{children:"ApolloLink"})," that returns an ",(0,r.jsx)(n.code,{children:"Observable"})," that never completes:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const noOpLink = new ApolloLink(\n  () => new Observable(() => {\n    // Never completes \u2014 queries stay in loading state\n  }),\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"mockApolloClient"})," uses ",(0,r.jsx)(n.code,{children:"fetchPolicy: 'no-cache'"})," to prevent stale data from a previous story bleeding into the next."]}),"\n",(0,r.jsx)(n.h3,{id:"when-to-use-mockapolloprovider",children:"When to Use MockApolloProvider"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Storybook stories for components with Apollo hooks where you only want to show the loading skeleton"}),"\n",(0,r.jsx)(n.li,{children:"Tests that only assert on the initial render / loading state"}),"\n",(0,r.jsxs)(n.li,{children:["Components wrapped in ",(0,r.jsx)(n.code,{children:"ApolloProvider"}),' deep in the tree that you just want to "satisfy"']}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"// Storybook story (example pattern)\nimport { MockApolloProvider } from '@nasnet/api-client/core';\n\nexport const Default: Story = {\n  decorators: [\n    (Story) => (\n      <MockApolloProvider>\n        <Story />\n      </MockApolloProvider>\n    ),\n  ],\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"when-not-to-use-mockapolloprovider",children:"When NOT to Use MockApolloProvider"}),"\n",(0,r.jsx)(n.p,{children:"Do not use this provider when you need:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Query responses with specific data"}),"\n",(0,r.jsx)(n.li,{children:"Mutation behavior"}),"\n",(0,r.jsx)(n.li,{children:"Subscription events"}),"\n",(0,r.jsx)(n.li,{children:"Cache interaction"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"MockedProvider"})," from ",(0,r.jsx)(n.code,{children:"@apollo/client/testing"})," for those cases."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-mockedprovider--data-driven-unit-tests",children:"3. MockedProvider \u2014 Data-Driven Unit Tests"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"libs/api-client/core/src/apollo/__tests__/apollo.test.tsx"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"MockedProvider"})," from ",(0,r.jsx)(n.code,{children:"@apollo/client/testing"})," accepts an array of ",(0,r.jsx)(n.code,{children:"MockedResponse"})," objects. Each mock intercepts a specific operation + variables combination and returns a predefined result."]}),"\n",(0,r.jsx)(n.h3,{id:"basic-query-test",children:"Basic Query Test"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import { MockedProvider, MockedResponse } from '@apollo/client/testing';\nimport { render, screen, waitFor } from '@testing-library/react';\nimport { useQuery, gql } from '@apollo/client';\n\nconst GET_ROUTER = gql`\n  query GetRouter($id: ID!) {\n    router(id: $id) { id name host status }\n  }\n`;\n\nconst mocks: MockedResponse[] = [\n  {\n    request: {\n      query: GET_ROUTER,\n      variables: { id: 'router-1' },\n    },\n    result: {\n      data: {\n        router: { id: 'router-1', name: 'Main Router', host: '192.168.88.1', status: 'CONNECTED' },\n      },\n    },\n  },\n];\n\nfunction TestComponent() {\n  const { data, loading, error } = useQuery(GET_ROUTER, {\n    variables: { id: 'router-1' },\n  });\n\n  if (loading) return <div>Loading...</div>;\n  if (error)   return <div>Error: {error.message}</div>;\n\n  return <div data-testid=\"name\">{data?.router?.name}</div>;\n}\n\nit('should show router name', async () => {\n  render(\n    <MockedProvider mocks={mocks} addTypename={false}>\n      <TestComponent />\n    </MockedProvider>\n  );\n\n  expect(screen.getByText('Loading...')).toBeInTheDocument();\n\n  await waitFor(() => {\n    expect(screen.getByTestId('name')).toHaveTextContent('Main Router');\n  });\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"error-responses",children:"Error Responses"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const mocks: MockedResponse[] = [\n  {\n    request: { query: GET_ROUTER, variables: { id: 'bad-id' } },\n    error: new Error('Router not found'),\n  },\n];\n"})}),"\n",(0,r.jsx)(n.h3,{id:"graphql-errors-partial-data",children:"GraphQL Errors (partial data)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"{\n  request: { query: GET_ROUTER, variables: { id: 'router-1' } },\n  result: {\n    errors: [{ message: 'Forbidden', extensions: { code: 'FORBIDDEN' } }],\n    data: { router: null },\n  },\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"addtypename",children:"addTypename"}),"\n",(0,r.jsxs)(n.p,{children:["Set ",(0,r.jsx)(n.code,{children:"addTypename={false}"})," in tests when you are not testing cache behaviour and don't want to include ",(0,r.jsx)(n.code,{children:"__typename"})," in every mock data object. Set it to ",(0,r.jsx)(n.code,{children:"true"})," (the default) when testing normalized cache interactions."]}),"\n",(0,r.jsx)(n.h3,{id:"providing-a-custom-cache",children:"Providing a Custom Cache"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { InMemoryCache } from '@apollo/client';\n\nconst cache = new InMemoryCache();\n\n// Pre-seed the cache\ncache.writeQuery({\n  query: GET_ROUTER,\n  variables: { id: 'router-1' },\n  data: { router: { id: 'router-1', name: 'Cached Router', status: 'DISCONNECTED' } },\n});\n\nrender(\n  <MockedProvider mocks={mocks} cache={cache} addTypename={false}>\n    <TestComponent />\n  </MockedProvider>\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This is the pattern used in ",(0,r.jsx)(n.code,{children:"apollo.test.tsx:277"})," to test that a mutation correctly updates the cache in place."]}),"\n",(0,r.jsx)(n.h3,{id:"renderhook-for-hook-only-tests",children:"renderHook for Hook-Only Tests"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { renderHook, waitFor } from '@testing-library/react';\n\nconst wrapper = ({ children }: { children: React.ReactNode }) => (\n  <MockedProvider mocks={mocks} addTypename={false}>\n    {children}\n  </MockedProvider>\n);\n\nconst { result } = renderHook(() => useServiceInstances({ routerId: 'router-1' }), {\n  wrapper,\n});\n\nawait waitFor(() => {\n  expect(result.current.data).toBeDefined();\n});\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-subscription-test-utilities",children:"4. Subscription Test Utilities"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"libs/api-client/core/src/apollo/__tests__/subscription-test-utils.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["The subscription test utilities provide helpers for creating mock ",(0,r.jsx)(n.code,{children:"Observable"}),"s that simulate WebSocket subscription streams."]}),"\n",(0,r.jsx)(n.h3,{id:"createmocksubscription",children:"createMockSubscription"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { createMockSubscription } from '@nasnet/api-client/core/apollo/__tests__/subscription-test-utils';\n\nconst mockSub = createMockSubscription([\n  { data: { routerStatus: { id: '1', status: 'CONNECTING' } }, delay: 0 },\n  { data: { routerStatus: { id: '1', status: 'CONNECTED' } },  delay: 100 },\n  { data: { routerStatus: { id: '1', status: 'STABLE' } },     delay: 200 },\n]);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The observable emits each item after its ",(0,r.jsx)(n.code,{children:"delay"})," milliseconds, then completes. Returns ",(0,r.jsx)(n.code,{children:"Observable<{ data: T }>"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"createmocksubscriptionerror",children:"createMockSubscriptionError"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const errorSub = createMockSubscriptionError(\n  new Error('Connection lost'),\n  delay: 50   // emit error after 50ms\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"createmockinfinitesubscription",children:"createMockInfiniteSubscription"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const infiniteSub = createMockInfiniteSubscription([\n  { data: { heartbeat: true }, delay: 1000 },\n]);\n\n// The observable emits the provided values, then stays open forever (never completes)\n// Use for testing unsubscription/cleanup\nconst sub = infiniteSub.subscribe({ next: (v) => console.log(v) });\nsub.unsubscribe(); // test cleanup\n"})}),"\n",(0,r.jsx)(n.h3,{id:"collectsubscriptionvalues",children:"collectSubscriptionValues"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const values = await collectSubscriptionValues(mockSub, 3, 1000);\n// Collects exactly 3 emissions, rejects after 1000ms timeout\n\nexpect(values).toHaveLength(3);\nexpect(values[0].data.status).toBe('CONNECTING');\n"})}),"\n",(0,r.jsx)(n.h3,{id:"using-subscription-mocks-with-mockedprovider",children:"Using Subscription Mocks with MockedProvider"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import { MockedProvider } from '@apollo/client/testing';\n\nconst subMock = {\n  request: {\n    query: SUBSCRIBE_INSTANCE_STATUS_CHANGED,\n    variables: { routerID: 'router-1' },\n  },\n  result: {\n    data: {\n      instanceStatusChanged: {\n        routerID: 'router-1',\n        instanceID: 'inst-1',\n        oldStatus: 'STOPPED',\n        newStatus: 'RUNNING',\n        timestamp: '2025-01-01T00:00:00Z',\n      },\n    },\n  },\n};\n\nrender(\n  <MockedProvider mocks={[subMock]} addTypename={false}>\n    <StatusMonitor routerId=\"router-1\" />\n  </MockedProvider>\n);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-testing-mutations-and-cache-updates",children:"5. Testing Mutations and Cache Updates"}),"\n",(0,r.jsx)(n.h3,{id:"cache-update-after-mutation",children:"Cache Update After Mutation"}),"\n",(0,r.jsxs)(n.p,{children:["From ",(0,r.jsx)(n.code,{children:"apollo.test.tsx:277"})," \u2014 the pattern is to:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Pre-seed the cache with known data"}),"\n",(0,r.jsx)(n.li,{children:"Execute the mutation"}),"\n",(0,r.jsxs)(n.li,{children:["Assert the cache was updated (via ",(0,r.jsx)(n.code,{children:"cache.readQuery"})," or by observing component re-render)"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"const cache = new InMemoryCache();\n\ncache.writeQuery({\n  query: GET_ROUTER,\n  variables: { id: 'router-1' },\n  data: { router: { id: 'router-1', name: 'Main Router', status: 'DISCONNECTED' } },\n});\n\nfunction TestComponent() {\n  const { data } = useQuery(GET_ROUTER, { variables: { id: 'router-1' } });\n  const [connect] = useMutation(CONNECT_ROUTER, {\n    update(cache, { data }) {\n      if (data?.connectRouter?.router) {\n        cache.modify({\n          id: cache.identify({ __typename: 'Router', id: 'router-1' }),\n          fields: { status: () => data.connectRouter.router.status },\n        });\n      }\n    },\n  });\n\n  return (\n    <div>\n      <span data-testid=\"status\">{data?.router?.status}</span>\n      <button onClick={() => connect({ variables: { id: 'router-1' } })}>Connect</button>\n    </div>\n  );\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"optimistic-responses",children:"Optimistic Responses"}),"\n",(0,r.jsx)(n.p,{children:"To test optimistic UI updates:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"const mocks = [\n  {\n    request: { query: CONNECT_ROUTER, variables: { id: 'router-1' } },\n    result: { data: { connectRouter: { success: true, router: { id: 'router-1', status: 'CONNECTED' } } } },\n    // Add a delay to observe optimistic state before server response\n    delay: 200,\n  },\n];\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The optimistic response from ",(0,r.jsx)(n.code,{children:"useInstallService"})," (",(0,r.jsx)(n.code,{children:"queries/src/services/useInstallService.ts:99"}),") uses ",(0,r.jsx)(n.code,{children:"'temp-${Date.now()}'"})," as the temporary ID \u2014 bear this in mind when asserting on IDs in optimistic state."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"6-codegen-pipeline",children:"6. Codegen Pipeline"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"codegen.ts"})," at repo root"]}),"\n",(0,r.jsxs)(n.p,{children:["The codegen system is ",(0,r.jsx)(n.code,{children:"@graphql-codegen/cli"}),". It reads the GraphQL schema and all operation documents, then writes TypeScript files to ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"inputs",children:"Inputs"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Source"}),(0,r.jsx)(n.th,{children:"Pattern"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Schema"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"./schema/**/*.graphql"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Operations (queries, mutations, subscriptions)"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"apps/connect/src/**/*.graphql"}),", ",(0,r.jsx)(n.code,{children:"apps/connect/src/**/*.tsx"}),", ",(0,r.jsx)(n.code,{children:"libs/**/*.graphql"}),", ",(0,r.jsx)(n.code,{children:"libs/**/*.tsx"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Excluded"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"libs/api-client/generated/**/*"}),", ",(0,r.jsx)(n.code,{children:"libs/core-ui-qwik/**/*"}),", ",(0,r.jsx)(n.code,{children:"libs/star-setup/**/*"}),", ",(0,r.jsx)(n.code,{children:"libs/**/*.stories.tsx"})]})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"outputs",children:"Outputs"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"File"}),(0,r.jsx)(n.th,{children:"Plugin"}),(0,r.jsx)(n.th,{children:"Contents"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"generated/types.ts"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"typescript"})}),(0,r.jsxs)(n.td,{children:["All GraphQL scalar, enum, input, and object types as TypeScript ",(0,r.jsx)(n.code,{children:"type"})," aliases"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"generated/operations.ts"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"typescript-operations"})," + ",(0,r.jsx)(n.code,{children:"typescript-react-apollo"})]}),(0,r.jsxs)(n.td,{children:["Per-operation types + React Apollo hooks (",(0,r.jsx)(n.code,{children:"useGetRouter"}),", ",(0,r.jsx)(n.code,{children:"useConnectRouterMutation"}),", etc.)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"generated/schema.graphql"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"schema-ast"})}),(0,r.jsx)(n.td,{children:"Full SDL dump with directives (for introspection/IDE)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"generated/fragment-matcher.ts"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fragment-matcher"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"possibleTypes"})," map for Apollo Client cache"]})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"run-commands",children:"Run Commands"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm run codegen        # Full codegen (TypeScript + Go)\nnpm run codegen:ts     # TypeScript types, hooks, fragment-matcher\nnpm run codegen:check  # Dry-run \u2014 verify generated code is in sync\n"})}),"\n",(0,r.jsx)(n.h3,{id:"typests-configuration",children:"types.ts Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// codegen.ts:43\nconfig: {\n  declarationKind: 'type',    // 'type' not 'interface' for better tree-shaking\n  immutableTypes: true,        // readonly on all fields\n  enumsAsConst: true,\n  skipTypename: true,          // no __typename in generated types\n  maybeValue: 'T | null | undefined',\n  scalars: {\n    DateTime: 'string',\n    JSON:     'Record<string, unknown>',\n    IPv4:     'string',\n    IPv6:     'string',\n    MAC:      'string',\n    CIDR:     'string',\n    Port:     'number',\n    PortRange:'string',\n    Duration: 'string',\n    Bandwidth:'string',\n    Size:     'string',\n  },\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"operationsts-configuration",children:"operations.ts Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// codegen.ts:73\nconfig: {\n  withHooks:            true,      // Generate useXxxQuery, useXxxMutation, useXxxSubscription\n  withHOC:              false,     // No higher-order components\n  withComponent:        false,     // No render prop components\n  apolloClientVersion:  3,\n  documentMode:         'documentNode',\n  skipTypename:         true,\n  dedupeFragments:      true,\n  avoidOptionals: {\n    field:        true,\n    inputValue:   false,\n    object:       true,\n    defaultValue: true,\n  },\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"post-generation-hook",children:"Post-Generation Hook"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"hooks: {\n  afterAllFileWrite: ['prettier --write'],\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Prettier runs automatically after codegen to maintain consistent formatting."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"7-possibletypes--polymorphism-in-the-cache",children:"7. possibleTypes \u2014 Polymorphism in the Cache"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/fragment-matcher.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"fragment-matcher"})," plugin generates a ",(0,r.jsx)(n.code,{children:"possibleTypes"})," map by introspecting the schema for all ",(0,r.jsx)(n.code,{children:"union"})," and ",(0,r.jsx)(n.code,{children:"interface"})," types. Apollo Client uses this map during cache normalization to correctly resolve polymorphic references. This is essential for implementing polymorphic types like ",(0,r.jsx)(n.code,{children:"Resource"}),", ",(0,r.jsx)(n.code,{children:"Node"}),", ",(0,r.jsx)(n.code,{children:"Connection"}),", and ",(0,r.jsx)(n.code,{children:"Edge"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"the-generated-map",children:"The Generated Map"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Source file:"})," ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/fragment-matcher.ts:8"})]}),"\n",(0,r.jsx)(n.p,{children:"The complete map structure from the current schema:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:'export interface PossibleTypesResultData {\n  possibleTypes: {\n    [key: string]: string[]\n  }\n}\n\nconst result: PossibleTypesResultData = {\n  "possibleTypes": {\n    // Relay Connection types (7 members)\n    "Connection": [\n      "AddressListEntryConnection",\n      "AlertConnection",\n      "InterfaceConnection",\n      "PortKnockAttemptConnection",\n      "ResourceConnection",\n      "RouterConnection",\n      "WANConnectionEventConnection"\n    ],\n\n    // Relay Edge types (7 members)\n    "Edge": [\n      "AddressListEntryEdge",\n      "AlertEdge",\n      "InterfaceEdge",\n      "PortKnockAttemptEdge",\n      "ResourceEdge",\n      "RouterEdge",\n      "WANConnectionEventEdge"\n    ],\n\n    // Node interface (44 implementing types)\n    "Node": [\n      "AddressListEntry",\n      "Alert",\n      "AlertEscalation",\n      "AlertRule",\n      "AlertRuleTemplate",\n      "AlertTemplate",\n      "Bridge",\n      "BridgePort",\n      "BridgeResource",\n      "ChainHop",\n      "DHCPServerResource",\n      "DhcpClient",\n      "DiagnosticResult",\n      "FeatureResource",\n      "FirewallRule",\n      "FirewallRuleResource",\n      "Interface",\n      "IpAddress",\n      "LANNetwork",\n      "LteModem",\n      "NatRule",\n      "NotificationLog",\n      "PortAllocation",\n      "PortForward",\n      "PortKnockAttempt",\n      "PortKnockSequence",\n      "PortMirror",\n      "PppoeClient",\n      "Route",\n      "RouteResource",\n      "Router",\n      "RoutingChain",\n      "RoutingSchedule",\n      "ServiceInstance",\n      "ServiceTemplate",\n      "StaticIPConfig",\n      "Tunnel",\n      "User",\n      "VLANAllocation",\n      "Vlan",\n      "WANInterface",\n      "WANLink",\n      "Webhook",\n      "WireGuardClient"\n    ],\n\n    // Resource interface (8 implementing types)\n    "Resource": [\n      "BridgeResource",\n      "DHCPServerResource",\n      "FeatureResource",\n      "FirewallRuleResource",\n      "LANNetwork",\n      "RouteResource",\n      "WANLink",\n      "WireGuardClient"\n    ],\n\n    // StorageMountEvent union (2 members)\n    "StorageMountEvent": [\n      "StorageMountedEvent",\n      "StorageUnmountedEvent"\n    ]\n  }\n};\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Summary:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"7 Connection types (Relay pagination)"}),"\n",(0,r.jsx)(n.li,{children:"7 Edge types (Relay pagination)"}),"\n",(0,r.jsx)(n.li,{children:"44 Node concrete types (Universal State resources and domain objects)"}),"\n",(0,r.jsx)(n.li,{children:"8 Resource concrete types (subset of Node implementing the Resource interface)"}),"\n",(0,r.jsx)(n.li,{children:"2 StorageMountEvent concrete types (event union)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"how-it-is-used",children:"How It Is Used"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-client.ts:83"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { possibleTypesResult } from '@nasnet/api-client/generated';\n\nconst cache = new InMemoryCache({\n  possibleTypes: possibleTypesResult.possibleTypes,\n  // ...typePolicies\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Apollo Client uses ",(0,r.jsx)(n.code,{children:"possibleTypes"})," during:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Query normalization"})," \u2014 When normalizing query results, Apollo splits polymorphic objects into their concrete types using ",(0,r.jsx)(n.code,{children:"__typename"})," + the possibleTypes map"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Fragment matching"})," \u2014 When reading fragments from cache (e.g., ",(0,r.jsx)(n.code,{children:"... on FeatureResource { ... }"}),"), Apollo checks if the concrete type is in the union/interface's possible types"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache reference resolution"})," \u2014 When following references between cached objects"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Without ",(0,r.jsx)(n.code,{children:"possibleTypes"}),", Apollo cannot correctly match fragments on interface/union types. Queries would fail silently or return incomplete data."]}),"\n",(0,r.jsx)(n.h3,{id:"when-to-regenerate",children:"When to Regenerate"}),"\n",(0,r.jsxs)(n.p,{children:["Run ",(0,r.jsx)(n.code,{children:"npm run codegen:ts"})," after:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Adding a new GraphQL ",(0,r.jsx)(n.code,{children:"interface"})," or ",(0,r.jsx)(n.code,{children:"union"})," type to the schema"]}),"\n",(0,r.jsxs)(n.li,{children:["Adding a new concrete type that implements an existing interface (e.g., new domain resource type implementing ",(0,r.jsx)(n.code,{children:"Node"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Adding or removing members of a ",(0,r.jsx)(n.code,{children:"union"})]}),"\n",(0,r.jsx)(n.li,{children:"Renaming any union/interface members"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Example scenario:"})," You add a new ",(0,r.jsx)(n.code,{children:"DnsRecordResource"})," type that implements ",(0,r.jsx)(n.code,{children:"Node"})," and ",(0,r.jsx)(n.code,{children:"Resource"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-graphql",children:"type DnsRecordResource implements Node & Resource {\n  uuid: ID!\n  # ... fields\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"After schema changes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'npm run codegen:ts\n# Regenerates fragment-matcher.ts with "DnsRecordResource" added to possibleTypes.Node and possibleTypes.Resource\n'})}),"\n",(0,r.jsx)(n.p,{children:"Failing to regenerate means the cache silently drops fragment data for new types \u2014 components will render but without the polymorphic fields they request."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"71-generated-module-barrel-exports",children:"7.1. Generated Module Barrel Exports"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/index.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/"})," module re-exports all generated files via a central barrel export for convenience:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// generated/index.ts:1\n/**\n * GraphQL Generated Code\n *\n * This module exports all generated types, operations, and validation schemas.\n * Do not edit these files manually - run `npm run codegen` to regenerate.\n */\n\n// Re-export all generated types from types.ts\nexport * from './types';\n\n// Re-export all operations and hooks from operations.ts\nexport * from './operations';\n\n// Re-export fragment matcher for Apollo Client cache (possibleTypes)\nexport { default as possibleTypesResult } from './fragment-matcher';\nexport type { PossibleTypesResultData } from './fragment-matcher';\n\n// Zod validation schemas\n// Note: Until full codegen with @graphql-codegen/typescript-validation-schema is integrated,\n// schemas are manually defined using network validators from @nasnet/core/forms\nexport * from './schemas';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"what-gets-exported",children:"What Gets Exported"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Export"}),(0,r.jsx)(n.th,{children:"Source File"}),(0,r.jsx)(n.th,{children:"Contents"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"All GraphQL types"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"types.ts"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"type User"}),", ",(0,r.jsx)(n.code,{children:"type Router"}),", ",(0,r.jsx)(n.code,{children:"type Resource"}),", etc. (500+ types)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"All GraphQL hooks"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"operations.ts"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"useGetRouter"}),", ",(0,r.jsx)(n.code,{children:"useCreateRouter"}),", ",(0,r.jsx)(n.code,{children:"useRouterSubscription"}),", etc."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"GraphQL operations"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"operations.ts"})}),(0,r.jsxs)(n.td,{children:["Exported ",(0,r.jsx)(n.code,{children:"gql"})," document constants (if documentMode is set)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"possibleTypesResult"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"fragment-matcher.ts"})}),(0,r.jsx)(n.td,{children:"The polymorphism map for Apollo cache"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Zod schemas"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"schemas/"})}),(0,r.jsx)(n.td,{children:"Manual validation schemas (network utils, DHCP schemas, etc.)"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"import-patterns",children:"Import Patterns"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// Import types\nimport type { Resource, Router, ValidationResult } from '@nasnet/api-client/generated';\n\n// Import hooks\nimport { useGetRouter, useCreateRouter } from '@nasnet/api-client/generated';\n\n// Import fragment matcher\nimport { possibleTypesResult } from '@nasnet/api-client/generated';\n\n// Import Zod schemas\nimport { ipv4, cidr, dhcpServerConfigSchema } from '@nasnet/api-client/generated/schemas';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"zod-schemas-status-and-gap",children:"Zod Schemas Status and Gap"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Current State:"})," Zod schemas are manually defined in ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/schemas/"})," using validators from ",(0,r.jsx)(n.code,{children:"@nasnet/core/forms/src/network-validators.ts"})," and custom domain schemas."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Future Enhancement (TODO):"})," The project is marked for integration of ",(0,r.jsx)(n.code,{children:"@graphql-codegen/typescript-validation-schema"})," plugin, which would automatically generate Zod schemas from GraphQL input types. This would eliminate the manual schema maintenance burden."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Until then:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Network validators are provided: ",(0,r.jsx)(n.code,{children:"ipv4"}),", ",(0,r.jsx)(n.code,{children:"ipv6"}),", ",(0,r.jsx)(n.code,{children:"mac"}),", ",(0,r.jsx)(n.code,{children:"cidr"}),", ",(0,r.jsx)(n.code,{children:"port"}),", ",(0,r.jsx)(n.code,{children:"portRange"}),", ",(0,r.jsx)(n.code,{children:"vlanId"}),", ",(0,r.jsx)(n.code,{children:"hostname"}),", ",(0,r.jsx)(n.code,{children:"duration"}),", ",(0,r.jsx)(n.code,{children:"bandwidth"}),", etc."]}),"\n",(0,r.jsxs)(n.li,{children:["Domain-specific schemas (e.g., ",(0,r.jsx)(n.code,{children:"dhcpServerConfigSchema"}),", ",(0,r.jsx)(n.code,{children:"firewallRuleInputSchema"}),") are hand-written in ",(0,r.jsx)(n.code,{children:"schemas/index.ts"})]}),"\n",(0,r.jsx)(n.li,{children:"When adding new GraphQL input types, developers must manually create corresponding Zod schemas for forms"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"8-zod-schemas-and-react-hook-form",children:"8. Zod Schemas and react-hook-form"}),"\n",(0,r.jsxs)(n.p,{children:["Source: ",(0,r.jsx)(n.code,{children:"libs/api-client/generated/schemas/index.d.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"generated/schemas/"})," module re-exports Zod validation utilities and provides example domain schemas. These are the building blocks for form validation across the application."]}),"\n",(0,r.jsx)(n.h3,{id:"re-exported-network-validators",children:"Re-Exported Network Validators"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  ipv4, ipv6, ipAddress, mac, cidr, cidr6,\n  port, portString, portRange, vlanId, vlanIdString,\n  wgKey, hostname, domain, interfaceName, comment, duration, bandwidth,\n} from '@nasnet/api-client/generated/schemas';\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Each of these is a Zod ",(0,r.jsx)(n.code,{children:"ZodEffects<ZodString>"})," that validates and normalizes the input."]}),"\n",(0,r.jsx)(n.h3,{id:"schema-utility-helpers",children:"Schema Utility Helpers"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import {\n  makePartial, mergeSchemas, pickFields, omitFields,\n  optionalString, requiredString, numberFromString, booleanFromString,\n  conditionalSchema,\n  type InferSchema, type InferInput,\n} from '@nasnet/api-client/generated/schemas';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-schemas-in-the-generated-module",children:"Example Schemas in the Generated Module"}),"\n",(0,r.jsx)(n.h4,{id:"dhcpserverconfigschema",children:"dhcpServerConfigSchema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { dhcpServerConfigSchema, type DHCPServerConfig } from '@nasnet/api-client/generated/schemas';\n\nconst schema = z.object({\n  name:        z.string().min(1).max(64),\n  interface:   z.string().min(1),\n  addressPool: cidr,                           // e.g. '192.168.100.0/24'\n  gateway:     ipv4,                           // e.g. '192.168.100.1'\n  leaseTime:   z.string().regex(/^\\d+[smhd]$/), // '1d', '12h', '30m'\n  dnsServers:  z.array(ipv4).optional(),\n  disabled:    z.boolean().default(false),\n});\n"})}),"\n",(0,r.jsx)(n.h4,{id:"firewallruleinputschema",children:"firewallRuleInputSchema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { firewallRuleInputSchema, type FirewallRuleInput } from '@nasnet/api-client/generated/schemas';\n\nconst schema = z.object({\n  chain:      z.enum(['input', 'forward', 'output']),\n  action:     z.enum(['accept', 'drop', 'reject', 'jump', 'log']),\n  srcAddress: cidr.optional(),\n  dstAddress: cidr.optional(),\n  srcPort:    z.number().optional(),\n  dstPort:    z.number().optional(),\n  protocol:   z.enum(['tcp', 'udp', 'icmp', 'all']).optional(),\n  comment:    z.string().optional(),\n  disabled:   z.boolean().default(false),\n});\n"})}),"\n",(0,r.jsx)(n.h4,{id:"wireguardpeerschema",children:"wireguardPeerSchema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { wireguardPeerSchema, type WireguardPeer } from '@nasnet/api-client/generated/schemas';\n\nconst schema = z.object({\n  publicKey:            wgKey,                     // 44-char base64 WG key\n  allowedAddress:       z.array(cidr),\n  endpointAddress:      ipv4.optional(),\n  endpointPort:         z.number().optional(),\n  persistentKeepalive:  z.number().optional(),\n  comment:              z.string().optional(),\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"integration-with-react-hook-form",children:"Integration with react-hook-form"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"import { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { dhcpServerConfigSchema, type DHCPServerConfig } from '@nasnet/api-client/generated/schemas';\n\nfunction DHCPServerForm() {\n  const form = useForm<DHCPServerConfig>({\n    resolver: zodResolver(dhcpServerConfigSchema),\n    defaultValues: {\n      name:      '',\n      interface: 'bridge1',\n      addressPool: '192.168.100.0/24',\n      gateway:    '192.168.100.1',\n      leaseTime:  '1d',\n      disabled:   false,\n    },\n  });\n\n  const onSubmit = async (data: DHCPServerConfig) => {\n    await createDHCPServer({ variables: { input: data } });\n  };\n\n  return (\n    <form onSubmit={form.handleSubmit(onSubmit)}>\n      <input {...form.register('name')} />\n      {form.formState.errors.name && (\n        <span>{form.formState.errors.name.message}</span>\n      )}\n      {/* ... other fields */}\n    </form>\n  );\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"composing-custom-schemas",children:"Composing Custom Schemas"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"mergeSchemas"})," and ",(0,r.jsx)(n.code,{children:"conditionalSchema"})," to handle complex forms:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { mergeSchemas, conditionalSchema, cidr, ipv4 } from '@nasnet/api-client/generated/schemas';\nimport { z } from 'zod';\n\nconst baseSchema = z.object({ name: z.string().min(1) });\nconst staticSchema = z.object({ ipAddress: ipv4, gateway: ipv4, cidr: cidr });\nconst dhcpSchema   = z.object({ dhcpClient: z.boolean() });\n\nconst wanSchema = conditionalSchema(\n  baseSchema,\n  (base) => base.type === 'static' ? mergeSchemas(base, staticSchema) : mergeSchemas(base, dhcpSchema)\n);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"9-adding-a-new-domain--step-by-step",children:"9. Adding a New Domain \u2014 Step-by-Step"}),"\n",(0,r.jsxs)(n.p,{children:["Follow these steps to add a new domain called ",(0,r.jsx)(n.code,{children:"example"})," with a query, a mutation, and a subscription."]}),"\n",(0,r.jsx)(n.h3,{id:"step-1-define-the-graphql-schema",children:"Step 1: Define the GraphQL Schema"}),"\n",(0,r.jsxs)(n.p,{children:["Add to the ",(0,r.jsx)(n.code,{children:"schema/"})," directory (e.g., ",(0,r.jsx)(n.code,{children:"schema/example/example.graphql"}),"):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-graphql",children:"type ExampleItem implements Node {\n  id: ID!\n  routerId: ID!\n  name: String!\n  value: String!\n  createdAt: DateTime!\n}\n\ntype ExamplePayload {\n  item: ExampleItem\n  errors: [UserError!]\n}\n\nextend type Query {\n  exampleItems(routerId: ID!): [ExampleItem!]!\n  exampleItem(id: ID!): ExampleItem\n}\n\nextend type Mutation {\n  createExampleItem(routerId: ID!, name: String!, value: String!): ExamplePayload!\n}\n\nextend type Subscription {\n  exampleItemChanged(routerId: ID!): ExampleItem!\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-2-run-codegen",children:"Step 2: Run Codegen"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm run codegen:ts\n"})}),"\n",(0,r.jsx)(n.p,{children:"This generates:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generated/types.ts"})," \u2014 adds ",(0,r.jsx)(n.code,{children:"ExampleItem"}),", ",(0,r.jsx)(n.code,{children:"ExamplePayload"})," types"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generated/operations.ts"})," \u2014 adds ",(0,r.jsx)(n.code,{children:"useExampleItemsQuery"}),", ",(0,r.jsx)(n.code,{children:"useCreateExampleItemMutation"}),", ",(0,r.jsx)(n.code,{children:"useExampleItemChangedSubscription"})," hooks"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generated/fragment-matcher.ts"})," \u2014 updates ",(0,r.jsx)(n.code,{children:"possibleTypes.Node"})," to include ",(0,r.jsx)(n.code,{children:"ExampleItem"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"step-3-create-the-domain-directory",children:"Step 3: Create the Domain Directory"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"libs/api-client/queries/src/example/\n\u251c\u2500\u2500 example.graphql.ts       (GraphQL operation documents)\n\u251c\u2500\u2500 useExampleItems.ts        (query hook)\n\u251c\u2500\u2500 useExampleMutations.ts    (mutation hooks)\n\u251c\u2500\u2500 useExampleSubscriptions.ts (subscription hook)\n\u251c\u2500\u2500 queryKeys.ts              (query key factory)\n\u2514\u2500\u2500 index.ts                  (barrel export)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-4-write-examplegraphqlts",children:"Step 4: Write example.graphql.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/api-client/queries/src/example/example.graphql.ts\nimport { gql } from '@apollo/client';\n\nexport const GET_EXAMPLE_ITEMS = gql`\n  query GetExampleItems($routerId: ID!) {\n    exampleItems(routerId: $routerId) {\n      id routerId name value createdAt\n    }\n  }\n`;\n\nexport const CREATE_EXAMPLE_ITEM = gql`\n  mutation CreateExampleItem($routerId: ID!, $name: String!, $value: String!) {\n    createExampleItem(routerId: $routerId, name: $name, value: $value) {\n      item { id routerId name value createdAt }\n      errors { message field code }\n    }\n  }\n`;\n\nexport const SUBSCRIBE_EXAMPLE_ITEM_CHANGED = gql`\n  subscription ExampleItemChanged($routerId: ID!) {\n    exampleItemChanged(routerId: $routerId) {\n      id routerId name value createdAt\n    }\n  }\n`;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-5-write-querykeysts",children:"Step 5: Write queryKeys.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/api-client/queries/src/example/queryKeys.ts\nexport const exampleKeys = {\n  all:   ['example'] as const,\n  list:  (routerId: string) => [...exampleKeys.all, 'list', routerId] as const,\n  detail:(routerId: string, id: string) => [...exampleKeys.list(routerId), id] as const,\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-6-write-useexampleitemsts",children:"Step 6: Write useExampleItems.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/api-client/queries/src/example/useExampleItems.ts\nimport { useQuery } from '@apollo/client';\nimport { GET_EXAMPLE_ITEMS } from './example.graphql';\n\nexport function useExampleItems(routerId: string) {\n  return useQuery(GET_EXAMPLE_ITEMS, {\n    variables: { routerId },\n    skip: !routerId,\n  });\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-7-write-useexamplemutationsts",children:"Step 7: Write useExampleMutations.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/api-client/queries/src/example/useExampleMutations.ts\nimport { useMutation } from '@apollo/client';\nimport { CREATE_EXAMPLE_ITEM, GET_EXAMPLE_ITEMS } from './example.graphql';\n\nexport function useCreateExampleItem() {\n  return useMutation(CREATE_EXAMPLE_ITEM, {\n    refetchQueries: (result) => [\n      {\n        query: GET_EXAMPLE_ITEMS,\n        variables: { routerId: result.data?.createExampleItem.item?.routerId },\n      },\n    ],\n  });\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-8-write-useexamplesubscriptionsts",children:"Step 8: Write useExampleSubscriptions.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/api-client/queries/src/example/useExampleSubscriptions.ts\nimport { useSubscription } from '@apollo/client';\nimport { SUBSCRIBE_EXAMPLE_ITEM_CHANGED } from './example.graphql';\n\nexport function useExampleItemChanged(routerId: string, enabled = true) {\n  const { data, loading, error } = useSubscription(SUBSCRIBE_EXAMPLE_ITEM_CHANGED, {\n    variables: { routerId },\n    skip: !enabled || !routerId,\n  });\n\n  return {\n    changedItem: data?.exampleItemChanged,\n    loading,\n    error,\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-9-write-indexts",children:"Step 9: Write index.ts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/api-client/queries/src/example/index.ts\nexport { exampleKeys } from './queryKeys';\nexport * from './example.graphql';\nexport { useExampleItems } from './useExampleItems';\nexport { useCreateExampleItem } from './useExampleMutations';\nexport { useExampleItemChanged } from './useExampleSubscriptions';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-10-register-in-the-queries-barrel",children:"Step 10: Register in the Queries Barrel"}),"\n",(0,r.jsxs)(n.p,{children:["Add to ",(0,r.jsx)(n.code,{children:"libs/api-client/queries/src/index.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"export * from './example';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-11-add-a-zod-schema-if-needed",children:"Step 11: Add a Zod Schema (if needed)"}),"\n",(0,r.jsx)(n.p,{children:"If the domain has a form, add a schema either:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Option A"})," \u2014 in ",(0,r.jsx)(n.code,{children:"generated/schemas/index.ts"})," (if it's general enough to share):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { z } from 'zod';\nexport const exampleItemSchema = z.object({\n  name:  z.string().min(1).max(64),\n  value: z.string().min(1),\n});\nexport type ExampleItemInput = z.infer<typeof exampleItemSchema>;\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Option B"})," \u2014 in the feature component (if it's domain-specific):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// libs/features/example/src/schemas/exampleItem.schema.ts\nimport { z } from 'zod';\nexport const exampleItemSchema = z.object({ ... });\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-12-write-tests",children:"Step 12: Write Tests"}),"\n",(0,r.jsxs)(n.p,{children:["Create ",(0,r.jsx)(n.code,{children:"useExampleItems.test.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { renderHook, waitFor } from '@testing-library/react';\nimport { MockedProvider } from '@apollo/client/testing';\nimport { useExampleItems } from './useExampleItems';\nimport { GET_EXAMPLE_ITEMS } from './example.graphql';\n\nconst mocks = [\n  {\n    request: { query: GET_EXAMPLE_ITEMS, variables: { routerId: 'router-1' } },\n    result: {\n      data: {\n        exampleItems: [\n          { id: '1', routerId: 'router-1', name: 'Item A', value: 'val-a', createdAt: '2025-01-01T00:00:00Z' },\n        ],\n      },\n    },\n  },\n];\n\nconst wrapper = ({ children }: { children: React.ReactNode }) => (\n  <MockedProvider mocks={mocks} addTypename={false}>{children}</MockedProvider>\n);\n\nit('returns example items', async () => {\n  const { result } = renderHook(() => useExampleItems('router-1'), { wrapper });\n\n  expect(result.current.loading).toBe(true);\n\n  await waitFor(() => {\n    expect(result.current.loading).toBe(false);\n    expect(result.current.data?.exampleItems).toHaveLength(1);\n    expect(result.current.data?.exampleItems[0].name).toBe('Item A');\n  });\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-13-update-possibletypes-if-needed",children:"Step 13: Update possibleTypes (if needed)"}),"\n",(0,r.jsxs)(n.p,{children:["If the new type implements ",(0,r.jsx)(n.code,{children:"Node"})," or is part of a union:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm run codegen:ts\n# fragment-matcher.ts is updated automatically\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Commit the updated ",(0,r.jsx)(n.code,{children:"generated/fragment-matcher.ts"})," file so the cache resolution is correct for all team members."]}),"\n",(0,r.jsx)(n.h3,{id:"step-14-update-backend-resolvers",children:"Step 14: Update Backend Resolvers"}),"\n",(0,r.jsxs)(n.p,{children:["Add the corresponding Go resolver(s) in ",(0,r.jsx)(n.code,{children:"apps/backend/graph/resolver/"}),". Run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm run codegen:gqlgen   # regenerate resolver stubs\n"})}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.code,{children:"Docs/architecture/backend-architecture.md"})," for the resolver implementation pattern."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var s=t(14041);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);