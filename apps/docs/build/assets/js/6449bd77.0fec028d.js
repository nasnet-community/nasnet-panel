"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[46740],{58087:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"router-communication","title":"Router Communication","description":"Multi-protocol adapter system with automatic fallback, circuit breaking, and batch execution for MikroTik RouterOS devices.","source":"@site/../backend/docs/router-communication.md","sourceDirName":".","slug":"/router-communication","permalink":"/docs/backend/router-communication","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/router-communication.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Provisioning Engine","permalink":"/docs/backend/provisioning-engine"},"next":{"title":"Router Services","permalink":"/docs/backend/router-services"}}');var o=r(31085),i=r(71184);const c={},s="Router Communication",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/router</code> (Core Port Definition)",id:"internalrouter-core-port-definition",level:3},{value:"<code>internal/router/adapters</code> (Protocol Implementations)",id:"internalrouteradapters-protocol-implementations",level:3},{value:"<code>rest_adapter.go</code> \u2014 RESTAdapter (RouterOS 7.1+)",id:"rest_adaptergo--restadapter-routeros-71",level:4},{value:"<code>api_adapter.go</code> \u2014 APIAdapter (Binary API)",id:"api_adaptergo--apiadapter-binary-api",level:4},{value:"<code>ssh_adapter.go</code> \u2014 SSHAdapter",id:"ssh_adaptergo--sshadapter",level:4},{value:"<code>telnet_adapter.go</code> \u2014 TelnetAdapter (Legacy)",id:"telnet_adaptergo--telnetadapter-legacy",level:4},{value:"<code>internal/router/fallback_chain.go</code>",id:"internalrouterfallback_chaingo",level:3},{value:"<code>internal/router/batch</code>",id:"internalrouterbatch",level:3},{value:"<code>executor.go</code> \u2014 Job lifecycle",id:"executorgo--job-lifecycle",level:4},{value:"<code>executor_run.go</code> \u2014 Protocol-specific execution",id:"executor_rungo--protocol-specific-execution",level:4},{value:"<code>executor_rollback.go</code> \u2014 Rollback",id:"executor_rollbackgo--rollback",level:4},{value:"<code>internal/router/compatibility</code>",id:"internalroutercompatibility",level:3},{value:"<code>internal/router/scanner</code>",id:"internalrouterscanner",level:3},{value:"<code>internal/router/ssh/parser</code>",id:"internalroutersshparser",level:3},{value:"<code>internal/router/connection_tester.go</code>",id:"internalrouterconnection_testergo",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Connection establishment",id:"connection-establishment",level:3},{value:"Command execution",id:"command-execution",level:3},{value:"Batch job lifecycle",id:"batch-job-lifecycle",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"router-communication",children:"Router Communication"})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:"Multi-protocol adapter system with automatic fallback, circuit breaking, and batch execution for MikroTik RouterOS devices."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Packages:"})," ",(0,o.jsx)(n.code,{children:"internal/router/"}),", ",(0,o.jsx)(n.code,{children:"internal/router/adapters/"}),", ",(0,o.jsx)(n.code,{children:"internal/router/batch/"}),", ",(0,o.jsx)(n.code,{children:"internal/router/compatibility/"}),", ",(0,o.jsx)(n.code,{children:"internal/router/scanner/"}),", ",(0,o.jsx)(n.code,{children:"internal/router/ssh/parser/"}),"\n",(0,o.jsx)(n.strong,{children:"Key Files:"})," ",(0,o.jsx)(n.code,{children:"port.go"}),", ",(0,o.jsx)(n.code,{children:"fallback_chain.go"}),", ",(0,o.jsx)(n.code,{children:"connection_tester.go"}),", ",(0,o.jsx)(n.code,{children:"validation.go"}),", ",(0,o.jsx)(n.code,{children:"adapters/rest_adapter.go"}),", ",(0,o.jsx)(n.code,{children:"adapters/api_adapter.go"}),", ",(0,o.jsx)(n.code,{children:"adapters/ssh_adapter.go"}),", ",(0,o.jsx)(n.code,{children:"adapters/telnet_adapter.go"}),", ",(0,o.jsx)(n.code,{children:"batch/executor.go"}),"\n",(0,o.jsx)(n.strong,{children:"Prerequisites:"})," [See: getting-started.md], [See: application-bootstrap.md \xa7Router Services]"]}),"\n",(0,o.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsxs)(n.p,{children:["The router communication layer implements a ",(0,o.jsx)(n.strong,{children:"hexagonal architecture port"})," (",(0,o.jsx)(n.code,{children:"RouterPort"}),") that abstracts over four distinct RouterOS protocols. The system automatically falls back through protocols from fastest (REST API) to last-resort (Telnet), protecting each attempt with a per-protocol circuit breaker."]}),"\n",(0,o.jsx)(n.p,{children:"Key capabilities:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Protocol auto-negotiation with circuit-breaker protection"}),"\n",(0,o.jsx)(n.li,{children:"Batch command execution with transactional rollback"}),"\n",(0,o.jsx)(n.li,{children:"SSH/Telnet response parsing into structured data"}),"\n",(0,o.jsx)(n.li,{children:"RouterOS version compatibility matrix"}),"\n",(0,o.jsx)(n.li,{children:"Network scanning for router discovery"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsx)(n.mermaid,{value:'graph TD\n    A["GraphQL Resolvers"]\n    B["FallbackChain<br/>(router.RouterPort)"]\n    C["REST<br/>7.1+ JSON"]\n    D["API<br/>Port 8728"]\n    E["SSH<br/>Port :22"]\n    F["Telnet<br/>Port :23"]\n    G["Circuit Breakers"]\n    H["BatchExecutor<br/>(API/SSH/Telnet)"]\n    I["Rollback Stack"]\n\n    A --\x3e|router.RouterPort| B\n    B --\x3e C\n    B --\x3e D\n    B --\x3e E\n    B --\x3e F\n    C --\x3e G\n    D --\x3e G\n    E --\x3e G\n    F --\x3e G\n    G --\x3e H\n    H --\x3e I\n\n    style B fill:#4a90e2\n    style C fill:#7ed321\n    style D fill:#7ed321\n    style E fill:#7ed321\n    style F fill:#7ed321\n    style H fill:#f5a623\n    style I fill:#f5a623'}),"\n",(0,o.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,o.jsxs)(n.h3,{id:"internalrouter-core-port-definition",children:[(0,o.jsx)(n.code,{children:"internal/router"})," (Core Port Definition)"]}),"\n",(0,o.jsx)(n.p,{children:"The central package defines the protocol interface and shared types."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Key Types:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"// RouterPort is the hexagonal port interface all adapters implement.\ntype RouterPort interface {\n    Connect(ctx context.Context) error\n    Disconnect() error\n    IsConnected() bool\n    Health(ctx context.Context) HealthStatus\n    Capabilities() PlatformCapabilities\n    Info() (*RouterInfo, error)\n    ExecuteCommand(ctx context.Context, cmd Command) (*CommandResult, error)\n    QueryState(ctx context.Context, query StateQuery) (*StateResult, error)\n    Protocol() Protocol\n}\n\n// AdapterConfig holds connection parameters common to all adapters.\ntype AdapterConfig struct {\n    Host     string\n    Port     int\n    Username string\n    Password string\n    Timeout  int  // seconds, default 10\n    UseTLS   bool\n    RouterID string\n}\n\n// Protocol fallback order (defined in fallback_chain.go):\nvar DefaultFallbackOrder = []Protocol{\n    ProtocolREST,    // RouterOS 7.1+ JSON REST API\n    ProtocolAPI,     // Binary API port 8728\n    ProtocolAPISSL,  // TLS Binary API port 8729\n    ProtocolSSH,     // Universal SSH fallback\n    ProtocolTelnet,  // Legacy INSECURE last resort\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Key Files:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"port.go"})," \u2014 ",(0,o.jsx)(n.code,{children:"RouterPort"})," interface, ",(0,o.jsx)(n.code,{children:"AdapterConfig"}),", ",(0,o.jsx)(n.code,{children:"BatchRequest"}),", ",(0,o.jsx)(n.code,{children:"BatchStatus"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"fallback_chain.go"})," \u2014 ",(0,o.jsx)(n.code,{children:"FallbackChain"})," with circuit breakers"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"connection_tester.go"})," \u2014 ",(0,o.jsx)(n.code,{children:"ConnectionTester"}),", ",(0,o.jsx)(n.code,{children:"TestConnectionService"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"validation.go"})," \u2014 ",(0,o.jsx)(n.code,{children:"AddRouterInputValidator"}),", ",(0,o.jsx)(n.code,{children:"ValidationError"})]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsxs)(n.h3,{id:"internalrouteradapters-protocol-implementations",children:[(0,o.jsx)(n.code,{children:"internal/router/adapters"})," (Protocol Implementations)"]}),"\n",(0,o.jsxs)(n.p,{children:["Four concrete adapters each implement ",(0,o.jsx)(n.code,{children:"RouterPort"}),"."]}),"\n",(0,o.jsxs)(n.h4,{id:"rest_adaptergo--restadapter-routeros-71",children:[(0,o.jsx)(n.code,{children:"rest_adapter.go"})," \u2014 RESTAdapter (RouterOS 7.1+)"]}),"\n",(0,o.jsxs)(n.p,{children:["Uses the RouterOS HTTP REST API (",(0,o.jsx)(n.code,{children:"/rest/..."})," endpoint). Fastest protocol, JSON-based."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'type RESTAdapter struct {\n    config    router.AdapterConfig\n    client    *http.Client\n    baseURL   string  // e.g. "http://192.168.88.1:80/rest"\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Connect:"})," GETs ",(0,o.jsx)(n.code,{children:"/system/resource"})," to verify connectivity and detect RouterOS version. Refuses connection if version < 7.1."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"ExecuteCommand:"})," Maps actions to HTTP methods:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"print"}),"/",(0,o.jsx)(n.code,{children:"get"})," \u2192 ",(0,o.jsx)(n.code,{children:"GET /{path}/{id?}"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"add"})," \u2192 ",(0,o.jsx)(n.code,{children:"PUT /{path}"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"set"})," \u2192 ",(0,o.jsx)(n.code,{children:"PATCH /{path}/{id}"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"remove"}),"/",(0,o.jsx)(n.code,{children:"delete"})," \u2192 ",(0,o.jsx)(n.code,{children:"DELETE /{path}/{id}"})]}),"\n",(0,o.jsxs)(n.li,{children:["other \u2192 ",(0,o.jsx)(n.code,{children:"POST /{path}/{action}"})]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Authentication:"})," HTTP Basic Auth on every request"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"TLS:"})," Accepts self-signed certificates (required for RouterOS)"]}),"\n"]}),"\n",(0,o.jsxs)(n.h4,{id:"api_adaptergo--apiadapter-binary-api",children:[(0,o.jsx)(n.code,{children:"api_adapter.go"})," \u2014 APIAdapter (Binary API)"]}),"\n",(0,o.jsxs)(n.p,{children:["Uses the ",(0,o.jsx)(n.code,{children:"github.com/go-routeros/routeros/v3"})," client over port 8728 (plain) or 8729 (TLS)."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type APIAdapter struct {\n    config  router.AdapterConfig\n    client  *routeros.Client\n    useTLS  bool\n}\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Connect:"})," TCP dial \u2192 ",(0,o.jsx)(n.code,{children:"routeros.NewClient"})," \u2192 ",(0,o.jsx)(n.code,{children:"client.Login(username, password)"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"ExecuteCommand:"})," Translates ",(0,o.jsx)(n.code,{children:"Command"})," to RouterOS API words:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Path: ",(0,o.jsx)(n.code,{children:"/interface/bridge/print"})]}),"\n",(0,o.jsxs)(n.li,{children:["Args: ",(0,o.jsx)(n.code,{children:"=name=br0"}),", ",(0,o.jsx)(n.code,{children:"?disabled=false"})," (query filter), ",(0,o.jsx)(n.code,{children:"=.id=*1"})]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Error translation:"})," Maps API-level errors (session expired, no such command, timeout) to typed ",(0,o.jsx)(n.code,{children:"AdapterError"})]}),"\n"]}),"\n",(0,o.jsxs)(n.h4,{id:"ssh_adaptergo--sshadapter",children:[(0,o.jsx)(n.code,{children:"ssh_adapter.go"})," \u2014 SSHAdapter"]}),"\n",(0,o.jsxs)(n.p,{children:["Uses ",(0,o.jsx)(n.code,{children:"golang.org/x/crypto/ssh"}),". Supports password + keyboard-interactive auth."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type SSHAdapter struct {\n    config    router.AdapterConfig\n    client    *ssh.Client\n    sshConfig *ssh.ClientConfig\n}\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Connect:"})," SSH dial with password auth and keyboard-interactive fallback (needed for RouterOS)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"ExecuteCommand:"})," Opens a new ",(0,o.jsx)(n.code,{children:"ssh.Session"})," per command. Runs CLI command with SIGKILL on context cancel."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Output Parsing:"})," ",(0,o.jsx)(n.code,{children:"parseSSHOutput()"})," auto-detects format (table vs key-value)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"CLI command format:"})," ",(0,o.jsx)(n.code,{children:"/interface/bridge print"})," or ",(0,o.jsx)(n.code,{children:"/ip/address add address=10.0.0.1/24"})]}),"\n"]}),"\n",(0,o.jsxs)(n.h4,{id:"telnet_adaptergo--telnetadapter-legacy",children:[(0,o.jsx)(n.code,{children:"telnet_adapter.go"})," \u2014 TelnetAdapter (Legacy)"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Security Warning:"})," Transmits credentials in plaintext. Last resort for RouterOS 3.x-5.x devices."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type TelnetAdapter struct {\n    config  router.AdapterConfig\n    conn    net.Conn\n    reader  *bufio.Reader\n}\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Connect:"})," TCP \u2192 Telnet IAC negotiation \u2192 login sequence (reads until ",(0,o.jsx)(n.code,{children:"Login:"}),", sends username, reads until ",(0,o.jsx)(n.code,{children:"Password:"}),", sends password, reads until prompt ",(0,o.jsx)(n.code,{children:">"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"RFC 854 Negotiation:"})," ",(0,o.jsx)(n.code,{children:"handleTelnetCommand()"})," responds WONT to all DO requests, DONT to all WILL requests"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Output reading:"})," Reads until RouterOS prompt ",(0,o.jsx)(n.code,{children:"]>"})," or ",(0,o.jsx)(n.code,{children:">"}),", strips echoed command"]}),"\n",(0,o.jsxs)(n.li,{children:["Shares ",(0,o.jsx)(n.code,{children:"parseSSHOutput()"})," with SSH adapter (same CLI format)"]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"internalrouterfallback_chaingo",children:(0,o.jsx)(n.code,{children:"internal/router/fallback_chain.go"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"FallbackChain"})," orchestrates protocol selection with per-protocol circuit breakers."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type FallbackChain struct {\n    config        AdapterConfig\n    fallbackOrder []Protocol\n    breakers      map[Protocol]*gobreaker.CircuitBreaker\n    factory       AdapterFactory  // creates adapters on demand\n    currentPort   RouterPort\n    currentProto  Protocol\n    mu            sync.RWMutex\n}\n\n// CircuitBreakerSettings:\n// - MaxFailures: 3 consecutive failures open the circuit\n// - Timeout: 5 minutes before trying half-open\n// - MaxRequests: 1 request in half-open state\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"Connect()"})," iterates ",(0,o.jsx)(n.code,{children:"fallbackOrder"}),", skipping any protocol with an open circuit breaker"]}),"\n",(0,o.jsxs)(n.li,{children:["Each attempt runs through ",(0,o.jsx)(n.code,{children:"cb.Execute()"})," \u2014 failure increments the breaker counter"]}),"\n",(0,o.jsxs)(n.li,{children:["On success, ",(0,o.jsx)(n.code,{children:"currentPort"})," and ",(0,o.jsx)(n.code,{children:"currentProto"})," are updated"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"ExecuteCommand()"})," / ",(0,o.jsx)(n.code,{children:"QueryState()"})," execute through the current protocol's circuit breaker"]}),"\n",(0,o.jsxs)(n.li,{children:["If the breaker opens mid-operation, ",(0,o.jsx)(n.code,{children:"attemptReconnect()"})," is triggered in a background goroutine"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"StartHealthCheck()"})," pings ",(0,o.jsx)(n.code,{children:"/system/identity"})," every 30 seconds; triggers reconnect if disconnected"]}),"\n",(0,o.jsxs)(n.li,{children:["Status changes (",(0,o.jsx)(n.code,{children:"RouterStatusReconnecting"}),", ",(0,o.jsx)(n.code,{children:"RouterStatusConnected"}),", etc.) are published via ",(0,o.jsx)(n.code,{children:"EventPublisher"})," within 100ms"]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"internalrouterbatch",children:(0,o.jsx)(n.code,{children:"internal/router/batch"})}),"\n",(0,o.jsx)(n.p,{children:"Batch execution with three protocols and optional rollback."}),"\n",(0,o.jsxs)(n.h4,{id:"executorgo--job-lifecycle",children:[(0,o.jsx)(n.code,{children:"executor.go"})," \u2014 Job lifecycle"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type Job struct {\n    ID              string\n    Status          JobStatus   // pending | running | completed | failed | canceled | rolled_back\n    Progress        JobProgress // Total/Current/Percent/Succeeded/Failed/Skipped\n    commands        []*parser.CLICommand\n    rollbackStack   []*parser.RollbackCommand\n}\n\n// Job.Execute() transitions pending \u2192 running and starts executeCommands() in goroutine\n// Job.Cancel() calls the stored context.CancelFunc\n// Job.Rollback(client) executes rollbackStack in reverse order\n"})}),"\n",(0,o.jsxs)(n.h4,{id:"executor_rungo--protocol-specific-execution",children:[(0,o.jsx)(n.code,{children:"executor_run.go"})," \u2014 Protocol-specific execution"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"// Route by protocol:\nfunc (job *Job) executeCommands(ctx context.Context) {\n    switch job.Protocol {\n    case ProtocolSSH:    job.executeViaSSH(ctx)\n    case ProtocolTelnet: job.executeViaTelnet(ctx)\n    case ProtocolAPI:    job.executeViaAPI(ctx)\n    }\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsxs)(n.strong,{children:["API execution path (",(0,o.jsx)(n.code,{children:"executeViaAPI"}),"):"]})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Opens ",(0,o.jsx)(n.code,{children:"mikrotik.ROSClient"})," connection"]}),"\n",(0,o.jsxs)(n.li,{children:["For each command: checks for ",(0,o.jsx)(n.code,{children:"FindQuery"})," (resolve target ID via ",(0,o.jsx)(n.code,{children:"/path/print ?field=value"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Executes the API command via ",(0,o.jsx)(n.code,{children:"client.RunWithContext()"})]}),"\n",(0,o.jsxs)(n.li,{children:["If ",(0,o.jsx)(n.code,{children:"RollbackEnabled"}),": fetches ",(0,o.jsx)(n.code,{children:"originalValues"})," before set/remove, generates ",(0,o.jsx)(n.code,{children:"RollbackCommand"}),", pushes to ",(0,o.jsx)(n.code,{children:"rollbackStack"})]}),"\n",(0,o.jsxs)(n.li,{children:["On any failure: calls ",(0,o.jsx)(n.code,{children:"performRollback()"})," if rollback is enabled, then stops"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"DryRun mode:"})," Logs commands without connecting, marks all as succeeded."]}),"\n",(0,o.jsxs)(n.h4,{id:"executor_rollbackgo--rollback",children:[(0,o.jsx)(n.code,{children:"executor_rollback.go"})," \u2014 Rollback"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"func (job *Job) performRollback(client *mikrotik.ROSClient) {\n    // Executes rollbackStack in reverse order (LIFO)\n    for i := len(rollbackStack) - 1; i >= 0; i-- {\n        client.Run(rb.UndoCommand.Command, rb.UndoCommand.Args...)\n    }\n    job.setStatus(JobStatusRolledBack)\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Rollback commands are generated by ",(0,o.jsx)(n.code,{children:"parser.GenerateRollback()"})," which derives the inverse operation (e.g., ",(0,o.jsx)(n.code,{children:"add"})," \u2192 generates ",(0,o.jsx)(n.code,{children:"remove *id"}),"; ",(0,o.jsx)(n.code,{children:"set"})," \u2192 generates ",(0,o.jsx)(n.code,{children:"set"})," with original values; ",(0,o.jsx)(n.code,{children:"remove"})," \u2192 generates ",(0,o.jsx)(n.code,{children:"add"})," with original values)."]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"internalroutercompatibility",children:(0,o.jsx)(n.code,{children:"internal/router/compatibility"})}),"\n",(0,o.jsx)(n.p,{children:"Version compatibility matrix for RouterOS features."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type Service interface {\n    IsFeatureSupported(featureID string, version Version, isCHR bool) bool\n    GetSupportedFeatures(version Version, isCHR bool) []FeatureCompatibility\n    GetFieldMapping(resource, field string, version Version) string\n    GetPathMapping(resource string, version Version) string\n    GetUpgradeRecommendation(featureID string, ...) *UpgradeRecommendation\n}\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Matrix is embedded as ",(0,o.jsx)(n.code,{children:"matrix.yaml"})," via ",(0,o.jsx)(n.code,{children:"//go:embed matrix.yaml"})]}),"\n",(0,o.jsxs)(n.li,{children:["Lazy-loaded on first access, cached in memory with ",(0,o.jsx)(n.code,{children:"sync.RWMutex"})]}),"\n",(0,o.jsxs)(n.li,{children:["Supports version-specific field names (e.g., ",(0,o.jsx)(n.code,{children:"tx-rate"})," in v6 \u2192 ",(0,o.jsx)(n.code,{children:"rate"})," in v7)"]}),"\n",(0,o.jsx)(n.li,{children:"Supports CHR-specific version ranges"}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"DefaultService"})," is a package-level singleton; package functions delegate to it"]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"internalrouterscanner",children:(0,o.jsx)(n.code,{children:"internal/router/scanner"})}),"\n",(0,o.jsx)(n.p,{children:"Network scanning to discover RouterOS devices."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"// ScanIP scans a single IP for RouterOS presence.\nfunc ScanIP(ctx context.Context, ip string, ports []int, timeout time.Duration) *Device\n\n// Default target ports: 80, 443, 8728, 8729, 8291 (Winbox)\nfunc DefaultConfig() Config {\n    return Config{\n        MaxWorkers:  20,\n        Timeout:     2 * time.Second,\n        TargetPorts: []int{80, 443, 8728, 8729, 8291},\n    }\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Detection heuristic:"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Open ports 8728/8729/8291 \u2192 immediately identified as MikroTik"}),"\n",(0,o.jsxs)(n.li,{children:["Open port 80/443 \u2192 calls ",(0,o.jsx)(n.code,{children:"CheckRouterOSAPI()"})," (HTTP probe for RouterOS JSON response)"]}),"\n",(0,o.jsxs)(n.li,{children:["No MikroTik indicators \u2192 returns ",(0,o.jsx)(n.code,{children:"nil"})]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'// ParseIPRange supports CIDR and dash range notation:\nParseIPRange("192.168.88.0/24")  // \u2192 254 IPs\nParseIPRange("10.0.0.1-10.0.0.10")  // \u2192 10 IPs\nParseIPRange("192.168.88.1")     // \u2192 1 IP\n'})}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"internalroutersshparser",children:(0,o.jsx)(n.code,{children:"internal/router/ssh/parser"})}),"\n",(0,o.jsx)(n.p,{children:"Multi-strategy SSH/CLI output parser."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type ParserStrategy interface {\n    Name() string\n    Priority() int\n    CanParse(raw string, hints ParseHints) bool\n    Parse(ctx context.Context, raw string, hints ParseHints) (*ParseResult, error)\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Four strategies (selected by priority and ",(0,o.jsx)(n.code,{children:"CanParse"})," probe):"]}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Strategy"}),(0,o.jsx)(n.th,{children:"Priority"}),(0,o.jsx)(n.th,{children:"Detection"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"terseParser"})}),(0,o.jsx)(n.td,{children:"1"}),(0,o.jsxs)(n.td,{children:["Lines match ",(0,o.jsx)(n.code,{children:".id=*N name=val ..."})," pattern"]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"tableParser"})}),(0,o.jsx)(n.td,{children:"2"}),(0,o.jsxs)(n.td,{children:[(0,o.jsx)(n.code,{children:"Flags:"})," line or column header with ",(0,o.jsx)(n.code,{children:"#"})]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"keyvalueParser"})}),(0,o.jsx)(n.td,{children:"3"}),(0,o.jsxs)(n.td,{children:["Lines with ",(0,o.jsx)(n.code,{children:"key: value"})," separated by ",(0,o.jsx)(n.code,{children:": "})]})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"detailParser"})}),(0,o.jsx)(n.td,{children:"4"}),(0,o.jsx)(n.td,{children:"Block-structured output, items separated by blank lines"})]})]})]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsxs)(n.strong,{children:["Table parser internals (",(0,o.jsx)(n.code,{children:"table_parser.go"}),"):"]})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Locates header line (line starting with ",(0,o.jsx)(n.code,{children:"#"})," or two+ UPPERCASE words)"]}),"\n",(0,o.jsxs)(n.li,{children:["Extracts ",(0,o.jsx)(n.code,{children:"ColumnInfo{Name, Start, End}"})," from fixed-width positions"]}),"\n",(0,o.jsx)(n.li,{children:"For each data row: extracts row number, flag characters (X=disabled, R=running, D=dynamic, etc.), then slices column values by position"}),"\n",(0,o.jsx)(n.li,{children:"Falls back to whitespace splitting if fixed-width extraction yields < 2 fields"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Normalizer:"})," Applies field name normalization (e.g., ",(0,o.jsx)(n.code,{children:"LISTEN-PORT"})," \u2192 ",(0,o.jsx)(n.code,{children:"listen-port"}),") and type coercion across all strategies."]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h3,{id:"internalrouterconnection_testergo",children:(0,o.jsx)(n.code,{children:"internal/router/connection_tester.go"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"TestConnectionService"})," provides a high-level connection test without creating persistent connections."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"func (s *TestConnectionService) Test(ctx context.Context, opts ConnectionOptions) *ConnectionTestResult {\n    // 1. DNS resolve hostname \u2192 ResolvedIP\n    // 2. Determine protocol chain (single if ProtocolPreference set, else full fallback)\n    // 3. For each protocol: create adapter, Connect(), get Info() + Capabilities()\n    // 4. On auth error (ErrCodeAuthFailed): stop immediately, don't try other protocols\n    // 5. Return ConnectionTestResult with ProtocolUsed, ResponseTimeMs, RouterInfo\n}\n"})}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,o.jsx)(n.h3,{id:"connection-establishment",children:"Connection establishment"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"GraphQL resolver calls router.Connect(ctx)\n  \u2192 FallbackChain.Connect()\n    \u2192 for each Protocol in [REST, API, API_SSL, SSH, Telnet]:\n        if circuitBreaker.State == Open: skip\n        cb.Execute(tryConnect):\n          factory(config, proto) \u2192 creates adapter\n          adapter.Connect(ctx)\n          \u2192 success: currentPort = adapter; publish RouterStatusConnected\n          \u2192 failure: cb records failure; try next protocol\n    \u2192 all failed: publish RouterStatusError; return error\n"})}),"\n",(0,o.jsx)(n.h3,{id:"command-execution",children:"Command execution"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"resolver calls port.ExecuteCommand(ctx, cmd)\n  \u2192 FallbackChain.ExecuteCommand()\n    \u2192 cb.Execute(adapter.ExecuteCommand)\n      REST: HTTP GET/PUT/PATCH/DELETE \u2192 parseResponse()\n      API:  routeros.Client.RunContext() \u2192 reply.Re[].Map\n      SSH:  ssh.Session.Run() \u2192 parseSSHOutput()\n      Telnet: TCP write + read until prompt \u2192 parseSSHOutput()\n    \u2192 if cb opens: go attemptReconnect()\n"})}),"\n",(0,o.jsx)(n.h3,{id:"batch-job-lifecycle",children:"Batch job lifecycle"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"POST /api/batch \u2192 Handler.Submit()\n  \u2192 creates Job{commands, rollbackEnabled}\n  \u2192 job.Execute() [goroutine]\n    \u2192 executeViaAPI/SSH/Telnet(ctx)\n      \u2192 for each command:\n          if rollbackEnabled: fetchOriginalValues()\n          executeAPICommand() / client.RunCommand()\n          if success && rollbackEnabled: push to rollbackStack\n          if failure && rollbackEnabled: performRollback(); return\n  \u2192 GET /api/batch/{id} \u2192 job.GetStatus()\n  \u2192 DELETE /api/batch/{id} \u2192 job.Cancel()\n"})}),"\n",(0,o.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Parameter"}),(0,o.jsx)(n.th,{children:"Default"}),(0,o.jsx)(n.th,{children:"Description"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"DefaultTimeout"})}),(0,o.jsx)(n.td,{children:"10s"}),(0,o.jsx)(n.td,{children:"Connection and command timeout"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"DefaultIdleTimeout"})}),(0,o.jsx)(n.td,{children:"5m"}),(0,o.jsx)(n.td,{children:"Health check interval"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["Circuit breaker ",(0,o.jsx)(n.code,{children:"MaxFailures"})]}),(0,o.jsx)(n.td,{children:"3"}),(0,o.jsx)(n.td,{children:"Consecutive failures before open"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["Circuit breaker ",(0,o.jsx)(n.code,{children:"Timeout"})]}),(0,o.jsx)(n.td,{children:"5m"}),(0,o.jsx)(n.td,{children:"Open state duration"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["Scanner ",(0,o.jsx)(n.code,{children:"MaxWorkers"})]}),(0,o.jsx)(n.td,{children:"20"}),(0,o.jsx)(n.td,{children:"Concurrent scan goroutines"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsxs)(n.td,{children:["Scanner ",(0,o.jsx)(n.code,{children:"Timeout"})]}),(0,o.jsx)(n.td,{children:"2s"}),(0,o.jsx)(n.td,{children:"Per-port TCP timeout"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"Batch job max command truncation"}),(0,o.jsx)(n.td,{children:"200 chars"}),(0,o.jsx)(n.td,{children:"For display/logging"})]})]})]}),"\n",(0,o.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'type AdapterError struct {\n    Protocol  Protocol\n    Operation string  // "dial", "login", "command"\n    Message   string\n    Cause     error\n    Retryable bool\n}\n\ntype ConnectionError struct {\n    Code    ErrorCode  // ErrCodeAuthFailed, ErrCodeConnectionRefused, etc.\n    ...\n}\n\n// ClassifyError maps raw errors to ConnectionError codes\n// ErrCodeAuthFailed prevents further protocol attempts in TestConnection\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Validation errors use ",(0,o.jsx)(n.code,{children:"ValidationError{Field, Code, Message, Suggestion, ProvidedValue}"})," returned as ",(0,o.jsx)(n.code,{children:"ValidationErrors"})," slice, enabling field-level GraphQL error presentation."]}),"\n",(0,o.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"connection_tester.go"})," provides ",(0,o.jsx)(n.code,{children:"TestConnectionService"})," for testing without persistent connections"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"scanner/"})," functions are pure and easily unit-tested with mock TCP servers"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"adapters/"})," adapters verify ",(0,o.jsx)(n.code,{children:"RouterPort"})," implementation with compile-time assertions:","\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"var _ router.RouterPort = (*RESTAdapter)(nil)\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"compatibility/"})," service is tested against version range logic in ",(0,o.jsx)(n.code,{children:"matrix.yaml"})]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"[See: application-bootstrap.md \xa7Router Services] \u2014 how adapters are wired at startup"}),"\n",(0,o.jsxs)(n.li,{children:["[See: event-system.md] \u2014 ",(0,o.jsx)(n.code,{children:"RouterStatusChangedEvent"})," published by ",(0,o.jsx)(n.code,{children:"FallbackChain"})]}),"\n",(0,o.jsxs)(n.li,{children:["[See: data-layer.md] \u2014 ",(0,o.jsx)(n.code,{children:"RouterRepository"})," manages router records in ",(0,o.jsx)(n.code,{children:"system.db"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"internal/connection/"})," \u2014 higher-level connection pool and reconnect manager built on top of this layer"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>s});var t=r(14041);const o={},i=t.createContext(o);function c(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);