"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[29074],{410:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>a,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"apollo-client","title":"Apollo Client","description":"This document covers the complete Apollo Client infrastructure in libs/api-client/core/src/apollo/. The Apollo layer handles all GraphQL communication: queries, mutations, and real-time subscriptions via WebSocket. It provides an intelligent link chain, a carefully tuned normalized cache, offline-first cache persistence, and React provider integration for both production and test environments.","source":"@site/../../libs/api-client/docs/apollo-client.md","sourceDirName":".","slug":"/apollo-client","permalink":"/docs/api-client/apollo-client","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/api-client/docs/apollo-client.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Apollo Client"},"sidebar":"sidebar","previous":{"title":"API Client \u2014 Overview","permalink":"/docs/api-client/intro"},"next":{"title":"Axios HTTP Client","permalink":"/docs/api-client/axios-http-client"}}');var i=r(31085),t=r(71184);const c={sidebar_position:2,title:"Apollo Client"},l="Apollo Client",d={},o=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Architecture Overview",id:"architecture-overview",level:2},{value:"Link Chain",id:"link-chain",level:2},{value:"Error Link",id:"error-link",level:3},{value:"Retry Link",id:"retry-link",level:3},{value:"Auth Link",id:"auth-link",level:3},{value:"HTTP Link",id:"http-link",level:3},{value:"WebSocket Link and Client",id:"websocket-link-and-client",level:3},{value:"Split Link (Routing)",id:"split-link-routing",level:3},{value:"Normalized Cache",id:"normalized-cache",level:2},{value:"possibleTypes and Union Resolution",id:"possibletypes-and-union-resolution",level:3},{value:"Type Policies",id:"type-policies",level:3},{value:"Universal State v2 Resource Policies",id:"universal-state-v2-resource-policies",level:3},{value:"Default Options",id:"default-options",level:2},{value:"Cache Persistence",id:"cache-persistence",level:2},{value:"Offline Detection",id:"offline-detection",level:2},{value:"Offline Mutation Queue",id:"offline-mutation-queue",level:2},{value:"React Providers",id:"react-providers",level:2},{value:"ApolloProvider (Production)",id:"apolloprovider-production",level:3},{value:"MockApolloProvider (Test / Storybook)",id:"mockapolloprovider-test--storybook",level:3},{value:"Enhanced Hooks",id:"enhanced-hooks",level:2},{value:"useQueryWithLoading",id:"usequerywithloading",level:3},{value:"useMutationWithLoading",id:"usemutationwithloading",level:3},{value:"useGraphQLError",id:"usegraphqlerror",level:3},{value:"Exports Reference",id:"exports-reference",level:2},{value:"Cache Type Policies Reference",id:"cache-type-policies-reference",level:2},{value:"Query Field Policies",id:"query-field-policies",level:3},{value:"Router Type Policy",id:"router-type-policy",level:3},{value:"Universal State v2 Resource Type Policies",id:"universal-state-v2-resource-type-policies",level:3},{value:"Merge Strategy Details",id:"merge-strategy-details",level:3},{value:"Resource.runtime (merge: true)",id:"resourceruntime-merge-true",level:4},{value:"Resource.telemetry (custom merge)",id:"resourcetelemetry-custom-merge",level:4},{value:"Validation and Deployment (merge: false)",id:"validation-and-deployment-merge-false",level:4},{value:"Default Query Options",id:"default-query-options",level:3},{value:"Cross-References",id:"cross-references",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"apollo-client",children:"Apollo Client"})}),"\n",(0,i.jsxs)(n.p,{children:["This document covers the complete Apollo Client infrastructure in ",(0,i.jsx)(n.code,{children:"libs/api-client/core/src/apollo/"}),". The Apollo layer handles all GraphQL communication: queries, mutations, and real-time subscriptions via WebSocket. It provides an intelligent link chain, a carefully tuned normalized cache, offline-first cache persistence, and React provider integration for both production and test environments."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#architecture-overview",children:"Architecture Overview"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#link-chain",children:"Link Chain"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#error-link",children:"Error Link"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#retry-link",children:"Retry Link"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#auth-link",children:"Auth Link"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#http-link",children:"HTTP Link"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#websocket-link-and-client",children:"WebSocket Link and Client"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#split-link-routing",children:"Split Link (Routing)"})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#normalized-cache",children:"Normalized Cache"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#possibletypes-and-union-resolution",children:"possibleTypes and Union Resolution"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#type-policies",children:"Type Policies"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#universal-state-v2-resource-policies",children:"Universal State v2 Resource Policies"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#default-options",children:"Default Options"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#cache-persistence",children:"Cache Persistence"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#offline-detection",children:"Offline Detection"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#offline-mutation-queue",children:"Offline Mutation Queue"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#react-providers",children:"React Providers"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#enhanced-hooks",children:"Enhanced Hooks"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#exports-reference",children:"Exports Reference"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#cross-references",children:"Cross-References"})}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,i.jsxs)(n.p,{children:["The Apollo Client instance is assembled in ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts"}),". The full request pipeline is:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"React Component\n      |\n      v\n useQuery / useMutation / useSubscription\n      |\n      v\n ApolloClient instance  (apollo-client.ts)\n      |\n      v\n+---------------------+\n|     Link Chain      |\n|                     |\n|  errorLink          |  (apollo-error-link.ts)    - catches ALL errors\n|      |              |\n|  retryLink          |  (apollo-retry-link.ts)    - retries network errors\n|      |              |\n|  splitLink          |                            - routes by operation type\n|   /        \\        |\n| wsLink    authLink  |  (apollo-ws-client.ts)\n|           + httpLink|  (apollo-auth-link.ts)\n+---------------------+\n      |                        |\n      v                        v\n  WebSocket                 HTTP POST\n  /graphql (ws/wss)         /graphql\n      |                        |\n      +---------- Backend -----+\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Key design decisions:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"errorLink"})," is the outermost link so it intercepts errors from every downstream link."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"retryLink"})," sits before ",(0,i.jsx)(n.code,{children:"splitLink"})," to apply backoff retry to HTTP-only operations (subscriptions have their own reconnect logic in the WebSocket client)."]}),"\n",(0,i.jsxs)(n.li,{children:["The HTTP path composes ",(0,i.jsx)(n.code,{children:"authLink.concat(httpLink)"})," to inject headers before every HTTP request."]}),"\n",(0,i.jsxs)(n.li,{children:["Subscriptions bypass the auth and retry links; auth is supplied as WebSocket ",(0,i.jsx)(n.code,{children:"connectionParams"})," instead."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"link-chain",children:"Link Chain"}),"\n",(0,i.jsx)(n.h3,{id:"error-link",children:"Error Link"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-error-link.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["The error link is created with Apollo's ",(0,i.jsx)(n.code,{children:"onError"})," helper and positioned first in the chain (",(0,i.jsx)(n.code,{children:"from([errorLink, retryLink, splitLink])"}),"), so it receives errors from all downstream links."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Exports:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const errorLink: ApolloLink\nexport function createErrorLink(options: {\n  onAuthError?: (message: string) => void;\n  onNetworkError?: (error: Error) => void;\n}): ApolloLink\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"GraphQL error handling by code:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Code"}),(0,i.jsx)(n.th,{children:"Action"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNAUTHENTICATED"})}),(0,i.jsxs)(n.td,{children:["Clears ",(0,i.jsx)(n.code,{children:"useAuthStore"}),", dispatches ",(0,i.jsx)(n.code,{children:"auth:expired"})," window event, shows toast"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"FORBIDDEN"})}),(0,i.jsx)(n.td,{children:'Shows "Access denied" error toast'})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NOT_FOUND"})}),(0,i.jsx)(n.td,{children:'Shows "Not found" warning toast'})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"A5xx"})," (auth category)"]}),(0,i.jsx)(n.td,{children:"Same as UNAUTHENTICATED"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"V4xx"})," (validation category)"]}),(0,i.jsx)(n.td,{children:"Skipped \u2014 handled by React Hook Form"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Others"}),(0,i.jsxs)(n.td,{children:["Mapped via ",(0,i.jsx)(n.code,{children:"getErrorInfo()"})," from ",(0,i.jsx)(n.code,{children:"utils/error-messages.ts"})]})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Network error handling by HTTP status:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Status"}),(0,i.jsx)(n.th,{children:"Action"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"401"}),(0,i.jsxs)(n.td,{children:["Calls ",(0,i.jsx)(n.code,{children:"handleAuthError()"})," \u2014 clears auth, fires ",(0,i.jsx)(n.code,{children:"auth:expired"})," event"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"403"}),(0,i.jsx)(n.td,{children:'Shows "Access denied" error toast'})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Other"}),(0,i.jsxs)(n.td,{children:['Shows generic "Unable to reach the server" error toast, fires ',(0,i.jsx)(n.code,{children:"network:error"})," event"]})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"createErrorLink"})})," is available when you need custom auth or network error handlers \u2014 useful for isolated module testing or embedded contexts."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// Custom error handler example\nconst customErrorLink = createErrorLink({\n  onAuthError: (message) => {\n    redirectToLogin();\n  },\n  onNetworkError: (error) => {\n    trackNetworkError(error);\n  },\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./error-handling.md"})," for the full error handling architecture including error boundaries and component-level hooks."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"retry-link",children:"Retry Link"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-retry-link.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const retryLink: RetryLink\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Configured with Apollo's ",(0,i.jsx)(n.code,{children:"RetryLink"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const retryLink = new RetryLink({\n  delay: {\n    initial: 300,    // 300ms initial delay\n    max: 3000,       // 3s maximum delay\n    jitter: true,    // randomized delay to avoid thundering herd\n  },\n  attempts: {\n    max: 3,\n    retryIf: (error) => {\n      const isNetworkError = !!error && !error.result;\n      const isClientError = typeof error?.statusCode === 'number'\n        && error.statusCode >= 400 && error.statusCode < 500;\n      return isNetworkError && !isClientError;\n    },\n  },\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Retry policy:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Only retries true network errors (no response received)."}),"\n",(0,i.jsx)(n.li,{children:"Never retries 4xx client errors \u2014 those are permanent failures."}),"\n",(0,i.jsx)(n.li,{children:"Up to 3 attempts with exponential jitter (300ms, up to 3s)."}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"auth-link",children:"Auth Link"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-auth-link.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const authLink: ApolloLink\nexport function createAuthLink(getToken: () => string | null): ApolloLink\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Built with Apollo's ",(0,i.jsx)(n.code,{children:"setContext"})," link. On every HTTP request it reads the current application state and injects two headers:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Header"}),(0,i.jsx)(n.th,{children:"Source"}),(0,i.jsx)(n.th,{children:"Value"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"X-Router-Id"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"useConnectionStore.getState().currentRouterId"})}),(0,i.jsx)(n.td,{children:"Current router ULID"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Authorization"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"getAuthToken()"})," (JWT first) or sessionStorage"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Bearer <jwt>"})," or ",(0,i.jsx)(n.code,{children:"Basic <base64>"})]})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Auth header priority:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["JWT token from ",(0,i.jsx)(n.code,{children:"useAuthStore"})," via ",(0,i.jsx)(n.code,{children:"getAuthToken()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Basic auth from per-router credentials stored in ",(0,i.jsx)(n.code,{children:"sessionStorage"})," at key ",(0,i.jsx)(n.code,{children:"router-credentials-<routerId>"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// Example: how the auth link reads state at request time\nexport const authLink = setContext((_, { headers }) => {\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorizationHeader(currentRouterId);\n\n  return {\n    headers: {\n      ...headers,\n      'X-Router-Id': currentRouterId || '',\n      ...(authorization && { Authorization: authorization }),\n    },\n  };\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"createAuthLink"})," factory lets you provide a custom token getter, useful in isolated testing or multi-tenant scenarios."]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./authentication.md"})," for the complete authentication architecture."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"http-link",children:"HTTP Link"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts"})," (inline)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const httpLink = new HttpLink({\n  uri: '/graphql',\n  credentials: 'include', // sends session cookies\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Points to ",(0,i.jsx)(n.code,{children:"/graphql"})," on the same origin. ",(0,i.jsx)(n.code,{children:"credentials: 'include'"})," ensures cookies (used for session fallback) are sent with every request."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"websocket-link-and-client",children:"WebSocket Link and Client"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-ws-client.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface WsClientOptions {\n  url?: string;         // auto-detected from window.location\n  maxRetries?: number;  // default: 10\n  showNotifications?: boolean; // default: true\n}\n\nexport function createWsClient(options?: WsClientOptions): Client\nexport const wsClient: Client  // singleton using default options\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The WebSocket client is built on the ",(0,i.jsx)(n.code,{children:"graphql-ws"})," library. The URL is derived from ",(0,i.jsx)(n.code,{children:"window.location"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function getWebSocketUrl(): string {\n  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n  return `${protocol}//${window.location.host}/graphql`;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Authentication for subscriptions"})," is supplied as ",(0,i.jsx)(n.code,{children:"connectionParams"})," (re-evaluated on every reconnect):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"connectionParams: () => {\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorization(currentRouterId); // JWT or Basic\n  return { routerId: currentRouterId, authorization };\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Reconnect strategy:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Attempt"}),(0,i.jsx)(n.th,{children:"Approx. delay"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"1"}),(0,i.jsx)(n.td,{children:"~1s"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"2"}),(0,i.jsx)(n.td,{children:"~2s"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"3"}),(0,i.jsx)(n.td,{children:"~4s"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"4"}),(0,i.jsx)(n.td,{children:"~8s"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"5+"}),(0,i.jsx)(n.td,{children:"up to 30s (capped)"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["Delays use ",(0,i.jsx)(n.code,{children:"calculateBackoff"})," from ",(0,i.jsx)(n.code,{children:"@nasnet/state/stores"}),". Reconnection stops when:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Close code ",(0,i.jsx)(n.code,{children:"4401"})," (custom auth failure) is received."]}),"\n",(0,i.jsxs)(n.li,{children:["Close code ",(0,i.jsx)(n.code,{children:"4403"})," (forbidden) is received."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"useConnectionStore.getState().hasExceededMaxAttempts()"})," returns ",(0,i.jsx)(n.code,{children:"true"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Connection lifecycle events"})," update ",(0,i.jsx)(n.code,{children:"useConnectionStore"})," and dispatch window events:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Event"}),(0,i.jsx)(n.th,{children:"Store action"}),(0,i.jsx)(n.th,{children:"Window event"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"connecting"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"setWsStatus('connecting')"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ws:connecting"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"connected"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setWsStatus('connected')"}),", ",(0,i.jsx)(n.code,{children:"resetReconnection()"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ws:connected"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"closed"})," (unclean)"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setWsStatus('error')"}),", ",(0,i.jsx)(n.code,{children:"incrementReconnectAttempts()"})]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ws:closed"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"error"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"setWsStatus('error', message)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ws:error"})})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./websocket-subscriptions.md"})," for subscription usage patterns."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"split-link-routing",children:"Split Link (Routing)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const splitLink = split(\n  ({ query }) => {\n    const definition = getMainDefinition(query);\n    return (\n      definition.kind === 'OperationDefinition' &&\n      definition.operation === 'subscription'\n    );\n  },\n  wsLink,                    // subscriptions \u2192 WebSocket\n  authLink.concat(httpLink)  // queries + mutations \u2192 HTTP with auth headers\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Subscription operations are routed to ",(0,i.jsx)(n.code,{children:"wsLink"}),". Queries and mutations are routed through ",(0,i.jsx)(n.code,{children:"authLink.concat(httpLink)"}),", which injects ",(0,i.jsx)(n.code,{children:"X-Router-Id"})," and ",(0,i.jsx)(n.code,{children:"Authorization"})," headers before the HTTP request."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"normalized-cache",children:"Normalized Cache"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"InMemoryCache"})," is the central data store. Every entity is normalized by a key field so that updates from mutations and subscriptions automatically refresh all query results that include that entity."]}),"\n",(0,i.jsx)(n.h3,{id:"possibletypes-and-union-resolution",children:"possibleTypes and Union Resolution"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const cache = new InMemoryCache({\n  possibleTypes: possibleTypesResult.possibleTypes,\n  // ...\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"possibleTypesResult"})," is imported from ",(0,i.jsx)(n.code,{children:"@nasnet/api-client/generated"})," (output of GraphQL codegen). It tells Apollo about abstract types (interfaces and unions), enabling correct cache normalization for polymorphic fields like ",(0,i.jsx)(n.code,{children:"Node"}),", ",(0,i.jsx)(n.code,{children:"Connection"}),", and ",(0,i.jsx)(n.code,{children:"Edge"}),". Whenever the schema changes and codegen is re-run, this is updated automatically."]}),"\n",(0,i.jsx)(n.h3,{id:"type-policies",children:"Type Policies"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"Query"})," field policies:"]})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Field"}),(0,i.jsx)(n.th,{children:(0,i.jsx)(n.code,{children:"keyArgs"})}),(0,i.jsx)(n.th,{children:"Merge strategy"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"routers"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"['filter']"})}),(0,i.jsx)(n.td,{children:"Replace (incoming wins)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"resources"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"['routerId', 'category', 'type', 'state']"})}),(0,i.jsx)(n.td,{children:"Replace (incoming wins)"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["These ",(0,i.jsx)(n.code,{children:"keyArgs"})," ensure that different filter combinations produce separate cache entries rather than overwriting each other."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"Router"})," policy:"]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"keyFields: ['id']"})," \u2014 normalized by router ID."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"status"})," field uses ",(0,i.jsx)(n.code,{children:"merge: true"})," \u2014 partial runtime updates merge into the existing object rather than replacing it entirely."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"universal-state-v2-resource-policies",children:"Universal State v2 Resource Policies"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts:118"})]}),"\n",(0,i.jsxs)(n.p,{children:["All resource types from the Universal State v2 model (see ",(0,i.jsx)(n.code,{children:"./universal-state-resource-model.md"}),") are normalized by ",(0,i.jsx)(n.code,{children:"uuid"})," (ULID). The cache uses distinct merge strategies per layer:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Resource layers and merge behavior:\n  Layer 2: validation    \u2192 merge: false  (full replace on each validation run)\n  Layer 3: deployment    \u2192 merge: false  (full replace on apply)\n  Layer 4: runtime       \u2192 merge: true   (partial updates preserve live metrics)\n  Layer 5: telemetry     \u2192 custom merge  (append bandwidth history, keep last 24h)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Telemetry merge function"})," (at ",(0,i.jsx)(n.code,{children:"apollo-client.ts:142"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"telemetry: {\n  merge(existing, incoming) {\n    return {\n      ...existing,\n      ...incoming,\n      bandwidthHistory: [\n        ...(existing.bandwidthHistory ?? []),\n        ...(incoming.bandwidthHistory ?? []),\n      ].slice(-288), // 288 \xd7 5min = 24 hours\n      hourlyStats: incoming.hourlyStats ?? existing.hourlyStats,\n      dailyStats: incoming.dailyStats ?? existing.dailyStats,\n    };\n  },\n},\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Concrete resource types with ",(0,i.jsx)(n.code,{children:"runtime"})," merge:"]})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:(0,i.jsx)(n.code,{children:"keyFields"})}),(0,i.jsx)(n.th,{children:"Has runtime merge"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Resource"})," (base)"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"WireGuardClient"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"LANNetwork"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"WANLink"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"FeatureResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"FirewallRuleResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"No (stateless)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DHCPServerResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"BridgeResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RouteResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Other type policies:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Behavior"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ValidationResult"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"merge: false"})," \u2014 always replace"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DeploymentState"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"merge: false"})," \u2014 always replace"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RuntimeState"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"merge: true"})," \u2014 accumulate live data"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ResourceMetadata"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"merge: true"})," \u2014 preserve local UI state"]})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"default-options",children:"Default Options"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts:263"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"defaultOptions: {\n  watchQuery: {\n    fetchPolicy: 'cache-and-network',  // immediate cache + background refresh\n    nextFetchPolicy: 'cache-first',    // subsequent renders use cache\n    errorPolicy: 'all',                // return partial data on error\n  },\n  query: {\n    fetchPolicy: 'cache-first',\n    errorPolicy: 'all',\n  },\n  mutate: {\n    errorPolicy: 'all',                // partial data on mutation error\n  },\n},\nconnectToDevTools: import.meta.env.DEV,\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"cache-and-network"})," + ",(0,i.jsx)(n.code,{children:"cache-first"})," combination means:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The first render gets data immediately from cache (no loading flash for previously visited views)."}),"\n",(0,i.jsx)(n.li,{children:"The network request refreshes data in the background."}),"\n",(0,i.jsx)(n.li,{children:"Subsequent renders on the same query use cache without another network round-trip."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Exported symbols from apollo-client.ts:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const apolloClient: ApolloClient<NormalizedCacheObject>\nexport { cache as apolloCache }\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"apolloCache"})," is exported so it can be used directly for cache persistence initialization and imperative cache writes."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"cache-persistence",children:"Cache Persistence"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-cache-persist.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface CachePersistConfig {\n  maxSize?: number;   // bytes, default: 5MB\n  debounce?: number;  // ms before writing to storage, default: 1000ms\n  key?: string;       // storage key prefix, default: 'nasnet-apollo-cache'\n  debug?: boolean;    // default: import.meta.env.DEV\n}\n\nexport async function initializeCachePersistence(\n  cache: InMemoryCache,\n  config?: CachePersistConfig\n): Promise<void>\n\nexport async function clearPersistedCache(key?: string): Promise<void>\n\nexport async function getPersistedCacheSize(key?: string): Promise<number>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Cache persistence uses ",(0,i.jsx)(n.code,{children:"apollo3-cache-persist"})," with ",(0,i.jsx)(n.code,{children:"localforage"})," as the storage backend. ",(0,i.jsx)(n.code,{children:"localforage"})," prefers IndexedDB and falls back to localStorage automatically."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Storage configuration:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Driver preference: ",(0,i.jsx)(n.code,{children:"[INDEXEDDB, LOCALSTORAGE]"})]}),"\n",(0,i.jsxs)(n.li,{children:["Database name: ",(0,i.jsx)(n.code,{children:"nasnet-apollo-cache"})]}),"\n",(0,i.jsxs)(n.li,{children:["Store name: ",(0,i.jsx)(n.code,{children:"apollo_cache"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"LocalForageWrapper"})," class (internal) adapts the localforage API to the interface expected by ",(0,i.jsx)(n.code,{children:"apollo3-cache-persist"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Initialization flow in ",(0,i.jsx)(n.code,{children:"ApolloProvider"}),":"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"ApolloProvider mounts\n      |\n      v\ninitializeCachePersistence(apolloCache, { maxSize: 5MB, debounce: 1000ms })\n      |\n      v (async)\nCache restored from IndexedDB\n      |\n      v\nsetIsCacheRestored(true)  \u2192  render children\n"})}),"\n",(0,i.jsx)(n.p,{children:"Children are not rendered until the cache is hydrated. This ensures that any query executed immediately on mount sees offline data before the first network response arrives."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Clearing the cache on logout:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { clearPersistedCache, apolloClient } from '@nasnet/api-client/core';\n\nasync function logout() {\n  await clearPersistedCache();   // wipes IndexedDB entries\n  apolloClient.clearStore();     // wipes in-memory cache\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./offline-first.md"})," for the complete offline-first architecture."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"offline-detection",children:"Offline Detection"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/offline-detector.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface OfflineDetectorConfig {\n  healthEndpoint?: string;         // default: '/api/health'\n  healthCheckInterval?: number;    // ms, default: 30000 (30s)\n  healthCheckTimeout?: number;     // ms, default: 5000 (5s)\n}\n\nexport function setupOfflineDetector(config?: OfflineDetectorConfig): () => void\nexport function useOfflineDetector(config?: OfflineDetectorConfig): void\nexport function isOffline(): boolean\nexport function isDegraded(): boolean\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The detector aggregates signals from four sources into ",(0,i.jsx)(n.code,{children:"useNetworkStore"}),":"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Signal source"}),(0,i.jsx)(n.th,{children:"Store updates"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"window"})," ",(0,i.jsx)(n.code,{children:"online"})," event"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setOnline(true)"}),", triggers health check"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"window"})," ",(0,i.jsx)(n.code,{children:"offline"})," event"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setOnline(false)"}),", ",(0,i.jsx)(n.code,{children:"setRouterReachable(false)"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"network:error"})," custom event (from errorLink)"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setRouterReachable(false)"}),", ",(0,i.jsx)(n.code,{children:"incrementReconnectAttempts()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"ws:connected"})," custom event (from wsClient)"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setRouterConnected(true)"}),", ",(0,i.jsx)(n.code,{children:"setRouterReachable(true)"}),", ",(0,i.jsx)(n.code,{children:"resetReconnectAttempts()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"ws:closed"})," / ",(0,i.jsx)(n.code,{children:"ws:error"})," custom events"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setRouterConnected(false)"}),", ",(0,i.jsx)(n.code,{children:"incrementReconnectAttempts()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Periodic ",(0,i.jsx)(n.code,{children:"GET /api/health"})]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"setRouterReachable(true/false)"})," based on response"]})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"State semantics:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"isOffline()"})," returns ",(0,i.jsx)(n.code,{children:"true"})," when ",(0,i.jsx)(n.code,{children:"!isOnline || !isRouterReachable"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"isDegraded()"})," returns ",(0,i.jsx)(n.code,{children:"true"}),' when the browser is online but either the router is unreachable or the WebSocket connection is down. Degraded mode shows stale data with a "reconnecting" indicator.']}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Usage in components:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"// React hook (preferred \u2014 auto-cleanup on unmount)\nfunction App() {\n  useOfflineDetector({ healthCheckInterval: 15000 });\n  return <Router />;\n}\n\n// Imperative setup (outside React)\nconst cleanup = setupOfflineDetector();\n// later:\ncleanup();\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"offline-mutation-queue",children:"Offline Mutation Queue"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/offline-queue.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface QueuedMutation {\n  id: string;\n  mutation: DocumentNode;\n  variables: Record<string, unknown>;\n  timestamp: Date;\n  retryCount: number;\n  operationName: string;\n  optimisticResponse?: unknown;\n}\n\nexport interface OfflineQueueConfig {\n  maxQueueSize?: number;  // default: 50\n  maxRetries?: number;    // default: 3\n  retryDelay?: number;    // ms, default: 1000\n  storageKey?: string;    // default: 'nasnet-offline-queue'\n}\n\nexport class OfflineMutationQueue {\n  constructor(config?: OfflineQueueConfig)\n  async enqueue(mutation, variables, optimisticResponse?): Promise<string>\n  async remove(id: string): Promise<void>\n  async replayAll(client: ApolloClient<NormalizedCacheObject>): Promise<number>\n  async clear(): Promise<void>\n  size(): number\n  isEmpty(): boolean\n  getQueue(): ReadonlyArray<QueuedMutation>\n}\n\nexport const offlineQueue: OfflineMutationQueue  // singleton instance\n\nexport function setupAutoReplay(\n  client: ApolloClient<NormalizedCacheObject>\n): () => void\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"When the app detects it is offline and a mutation needs to be executed, the mutation is enqueued instead of fired."}),"\n",(0,i.jsx)(n.li,{children:"The queue is persisted to IndexedDB (via localforage) so it survives page reloads."}),"\n",(0,i.jsxs)(n.li,{children:["On reconnection, ",(0,i.jsx)(n.code,{children:"setupAutoReplay"})," listens for ",(0,i.jsx)(n.code,{children:"isRouterReachable"})," becoming ",(0,i.jsx)(n.code,{children:"true"})," in ",(0,i.jsx)(n.code,{children:"useNetworkStore"})," and calls ",(0,i.jsx)(n.code,{children:"offlineQueue.replayAll(apolloClient)"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Mutations are replayed in FIFO order (oldest first)."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Last-write-wins deduplication:"})," if the same ",(0,i.jsx)(n.code,{children:"operationName"})," + ",(0,i.jsx)(n.code,{children:"variables"})," is enqueued twice, the first entry is removed and the new one appended."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Usage pattern:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { isOffline, offlineQueue, apolloClient, setupAutoReplay } from '@nasnet/api-client/core';\n\n// Enqueue when offline\nif (isOffline()) {\n  await offlineQueue.enqueue(UPDATE_ROUTER_NAME, { id, name });\n} else {\n  await apolloClient.mutate({ mutation: UPDATE_ROUTER_NAME, variables: { id, name } });\n}\n\n// Setup auto-replay (call once at app initialization)\nconst cleanup = setupAutoReplay(apolloClient);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./offline-first.md"})," for integration with the full offline-first strategy."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"react-providers",children:"React Providers"}),"\n",(0,i.jsx)(n.h3,{id:"apolloprovider-production",children:"ApolloProvider (Production)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-provider.tsx"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"interface ApolloProviderProps {\n  children: ReactNode;\n}\n\nexport function ApolloProvider({ children }: ApolloProviderProps): JSX.Element | null\n"})}),"\n",(0,i.jsx)(n.p,{children:"The production provider wraps children in the Apollo context and handles:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cache hydration"})," \u2014 calls ",(0,i.jsx)(n.code,{children:"initializeCachePersistence(apolloCache, { maxSize: 5MB, debounce: 1000ms })"})," on mount and defers render until cache is restored."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Apollo context"})," \u2014 wraps children in ",(0,i.jsx)(n.code,{children:"<BaseApolloProvider client={apolloClient}>"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"DevTools"})," \u2014 lazily loads ",(0,i.jsx)(n.code,{children:"@apollo/client/dev"}),"'s ",(0,i.jsx)(n.code,{children:"ApolloDevTools"})," in development only (zero production bundle impact)."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Provider tree position"})," (from project architecture):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"ErrorBoundary\n  \u2514\u2500\u2500 ApolloProvider          \u2190 this component\n        \u2514\u2500\u2500 QueryClientProvider\n              \u2514\u2500\u2500 I18nextProvider\n                    \u2514\u2500\u2500 ThemeProvider\n                          \u2514\u2500\u2500 ToastProvider\n                                \u2514\u2500\u2500 App\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Import:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { ApolloProvider } from '@nasnet/api-client/core';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"mockapolloprovider-test--storybook",children:"MockApolloProvider (Test / Storybook)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-mock-provider.tsx"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"interface MockApolloProviderProps {\n  children: ReactNode;\n}\n\nexport function MockApolloProvider({ children }: MockApolloProviderProps): JSX.Element\n"})}),"\n",(0,i.jsxs)(n.p,{children:["A lightweight Apollo context for Storybook stories and unit tests. Uses a ",(0,i.jsx)(n.code,{children:"noOpLink"})," that never resolves, keeping all queries in ",(0,i.jsx)(n.code,{children:"loading"})," state. No cache persistence, no WebSocket, no HTTP."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"// In Storybook decorators or test render helpers\nimport { MockApolloProvider } from '@nasnet/api-client/core';\n\nexport const decorators = [\n  (Story) => (\n    <MockApolloProvider>\n      <Story />\n    </MockApolloProvider>\n  ),\n];\n"})}),"\n",(0,i.jsxs)(n.p,{children:["When you need specific mock data (rather than loading states), use ",(0,i.jsx)(n.code,{children:"MockedProvider"})," from ",(0,i.jsx)(n.code,{children:"@apollo/client/testing"})," directly."]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./testing-and-codegen.md"})," for full testing strategies."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"enhanced-hooks",children:"Enhanced Hooks"}),"\n",(0,i.jsxs)(n.p,{children:["These hooks are in ",(0,i.jsx)(n.code,{children:"core/src/hooks/"})," and re-exported from ",(0,i.jsx)(n.code,{children:"@nasnet/api-client/core"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"usequerywithloading",children:"useQueryWithLoading"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/hooks/useQueryWithLoading.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["Wraps ",(0,i.jsx)(n.code,{children:"useQuery"})," with differentiated loading state:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface QueryWithLoadingState<TData> {\n  isInitialLoading: boolean;  // loading AND no data exists\n  isRevalidating: boolean;    // loading AND data already exists\n  isStale: boolean;           // explicit refetch in progress\n  isLoading: boolean;         // any loading\n  lastUpdated: Date | null;\n}\n\nexport function useQueryWithLoading<TData, TVariables>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: QueryHookOptions<TData, TVariables>\n): UseQueryWithLoadingResult<TData, TVariables>\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"function ResourceList() {\n  const { data, isInitialLoading, isRevalidating } = useQueryWithLoading(GET_RESOURCES);\n\n  if (isInitialLoading) {\n    return <ResourceListSkeleton />;  // first load: show skeleton\n  }\n\n  return (\n    <>\n      {isRevalidating && <RefreshSpinner />}  // background refresh indicator\n      <ResourceTable data={data?.resources} />\n    </>\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"usemutationwithloading",children:"useMutationWithLoading"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/hooks/useMutationWithLoading.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["Wraps ",(0,i.jsx)(n.code,{children:"useMutation"})," with ",(0,i.jsx)(n.code,{children:"isLoading"}),", ",(0,i.jsx)(n.code,{children:"isSuccess"}),", ",(0,i.jsx)(n.code,{children:"isError"})," states and a simplified ",(0,i.jsx)(n.code,{children:"mutate"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function useMutationWithLoading<TData, TVariables>(\n  mutation: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: MutationHookOptions<TData, TVariables>\n): UseMutationWithLoadingResult<TData, TVariables>\n\n// Helper for optimistic mutations\nexport function createOptimisticOptions<TData, TVariables>(config: {\n  optimisticResponse: OptimisticResponse<TData>;\n  cacheUpdate?: (cache, data: TData) => void;\n}): Partial<MutationHookOptions<TData, TVariables>>\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"function SaveButton() {\n  const { mutate, isLoading, isSuccess, error } = useMutationWithLoading(SAVE_CONFIG, {\n    onCompleted: () => toast.success('Saved!'),\n  });\n\n  return (\n    <Button onClick={() => mutate({ config })} disabled={isLoading}>\n      {isLoading ? 'Saving...' : 'Save'}\n    </Button>\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"usegraphqlerror",children:"useGraphQLError"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/hooks/useGraphQLError.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function useGraphQLError(\n  apolloError: ApolloError | Error | undefined,\n  options?: UseGraphQLErrorOptions\n): UseGraphQLErrorReturn\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Converts raw Apollo errors into user-friendly ",(0,i.jsx)(n.code,{children:"ProcessedError"})," objects with severity, recoverability classification, and suggested actions. Optionally auto-shows toast notifications."]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.code,{children:"./error-handling.md"})," for full details."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"exports-reference",children:"Exports Reference"}),"\n",(0,i.jsxs)(n.p,{children:["All symbols are re-exported from ",(0,i.jsx)(n.code,{children:"@nasnet/api-client/core"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["From ",(0,i.jsx)(n.code,{children:"core/src/apollo/index.ts"}),":"]})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Export"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"apolloClient"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ApolloClient<NormalizedCacheObject>"})}),(0,i.jsx)(n.td,{children:"Singleton Apollo Client instance"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"apolloCache"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"InMemoryCache"})}),(0,i.jsx)(n.td,{children:"Singleton cache (for persistence and direct writes)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"authLink"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ApolloLink"})}),(0,i.jsx)(n.td,{children:"Auth context link (JWT + Basic auth)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"errorLink"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ApolloLink"})}),(0,i.jsx)(n.td,{children:"Centralized error handling link"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"retryLink"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RetryLink"})}),(0,i.jsx)(n.td,{children:"Exponential backoff retry link"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"wsClient"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Client"})," (graphql-ws)"]}),(0,i.jsx)(n.td,{children:"WebSocket client for subscriptions"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ApolloProvider"})}),(0,i.jsx)(n.td,{children:"React component"}),(0,i.jsx)(n.td,{children:"Production provider with cache persistence"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockApolloProvider"})}),(0,i.jsx)(n.td,{children:"React component"}),(0,i.jsx)(n.td,{children:"Stub provider for tests/Storybook"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"initializeCachePersistence"})}),(0,i.jsx)(n.td,{children:"async function"}),(0,i.jsx)(n.td,{children:"Initialize IndexedDB cache persistence"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"clearPersistedCache"})}),(0,i.jsx)(n.td,{children:"async function"}),(0,i.jsx)(n.td,{children:"Clear persisted cache (e.g., on logout)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"getPersistedCacheSize"})}),(0,i.jsx)(n.td,{children:"async function"}),(0,i.jsx)(n.td,{children:"Get cache size in bytes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"setupOfflineDetector"})}),(0,i.jsx)(n.td,{children:"function"}),(0,i.jsx)(n.td,{children:"Imperative offline detection setup"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"useOfflineDetector"})}),(0,i.jsx)(n.td,{children:"React hook"}),(0,i.jsx)(n.td,{children:"React offline detection hook (auto-cleanup)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"isOffline"})}),(0,i.jsx)(n.td,{children:"function"}),(0,i.jsx)(n.td,{children:"Check if currently offline"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"isDegraded"})}),(0,i.jsx)(n.td,{children:"function"}),(0,i.jsx)(n.td,{children:"Check if in degraded connectivity mode"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OfflineMutationQueue"})}),(0,i.jsx)(n.td,{children:"class"}),(0,i.jsx)(n.td,{children:"Queue for mutations when offline"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"offlineQueue"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OfflineMutationQueue"})}),(0,i.jsx)(n.td,{children:"Singleton offline queue"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"setupAutoReplay"})}),(0,i.jsx)(n.td,{children:"function"}),(0,i.jsx)(n.td,{children:"Auto-replay queue on reconnection"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Type exports:"})," ",(0,i.jsx)(n.code,{children:"CachePersistConfig"}),", ",(0,i.jsx)(n.code,{children:"OfflineDetectorConfig"}),", ",(0,i.jsx)(n.code,{children:"QueuedMutation"}),", ",(0,i.jsx)(n.code,{children:"OfflineQueueConfig"}),", ",(0,i.jsx)(n.code,{children:"WsClientOptions"})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"cache-type-policies-reference",children:"Cache Type Policies Reference"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts:82\u2013240"})]}),"\n",(0,i.jsx)(n.h3,{id:"query-field-policies",children:"Query Field Policies"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"Query"})," root type defines key arguments for connection queries to ensure that different filter combinations produce separate cache entries:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Field"}),(0,i.jsx)(n.th,{children:(0,i.jsx)(n.code,{children:"keyArgs"})}),(0,i.jsx)(n.th,{children:"Merge Strategy"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"routers"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"['filter']"})}),(0,i.jsx)(n.td,{children:"Replace (incoming wins)"}),(0,i.jsx)(n.td,{children:"Cache routers list with optional filter parameter"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"resources"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"['routerId', 'category', 'type', 'state']"})}),(0,i.jsx)(n.td,{children:"Replace (incoming wins)"}),(0,i.jsx)(n.td,{children:"Cache resources with multi-dimensional filtering"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["Without these ",(0,i.jsx)(n.code,{children:"keyArgs"}),", a second query with different filter values would overwrite the first cached result in the same field, making pagination and filtered views impossible."]}),"\n",(0,i.jsx)(n.h3,{id:"router-type-policy",children:"Router Type Policy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// apollo-client.ts:104\u2013113\nRouter: {\n  keyFields: ['id'],\n  fields: {\n    status: {\n      merge: true,\n    },\n  },\n}\n"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Setting"}),(0,i.jsx)(n.th,{children:"Value"}),(0,i.jsx)(n.th,{children:"Rationale"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"keyFields"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"['id']"})}),(0,i.jsx)(n.td,{children:"Normalize by router ID \u2014 each router is a distinct cache entry"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"status.merge"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"true"})}),(0,i.jsx)(n.td,{children:"Runtime status updates merge into the existing router object rather than replacing it entirely"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"universal-state-v2-resource-type-policies",children:"Universal State v2 Resource Type Policies"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Complete table"})," of all resource type policies (apollo-client.ts:115\u2013239):"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:(0,i.jsx)(n.code,{children:"keyFields"})}),(0,i.jsxs)(n.th,{children:[(0,i.jsx)(n.code,{children:"runtime"})," merge"]}),(0,i.jsxs)(n.th,{children:[(0,i.jsx)(n.code,{children:"telemetry"})," merge"]}),(0,i.jsxs)(n.th,{children:[(0,i.jsx)(n.code,{children:"validation"})," merge"]}),(0,i.jsxs)(n.th,{children:[(0,i.jsx)(n.code,{children:"deployment"})," merge"]}),(0,i.jsx)(n.th,{children:"Notes"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.strong,{children:"Resource"})," (base)"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes (cap 288)"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:"Base resource policy inherited by all resource types"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"WireGuardClient"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"VPN client runtime metrics"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"LANNetwork"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"LAN interface runtime metrics"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"WANLink"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"WAN link runtime metrics"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"FeatureResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Marketplace feature runtime state"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"FirewallRuleResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Stateless firewall config"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"DHCPServerResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Stateless DHCP config"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"BridgeResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Stateless bridge config"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"RouteResource"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Stateless route config"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"ValidationResult"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"No (replace)"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Full replacement on validation cycle"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"DeploymentState"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"No (replace)"}),(0,i.jsx)(n.td,{children:"Full replacement on deployment"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"RuntimeState"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Merge for real-time accumulation"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"ResourceMetadata"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"Merge to preserve local UI state"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"merge-strategy-details",children:"Merge Strategy Details"}),"\n",(0,i.jsx)(n.h4,{id:"resourceruntime-merge-true",children:"Resource.runtime (merge: true)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// apollo-client.ts:129\u2013134\nruntime: {\n  merge(existing, incoming) {\n    return { ...existing, ...incoming };\n  },\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Purpose:"})," Preserve live runtime metrics across updates. When a resource's status, CPU usage, or bandwidth updates, the new fields merge in rather than wiping out the entire runtime layer. This prevents loss of time-series data during incremental updates."]}),"\n",(0,i.jsx)(n.h4,{id:"resourcetelemetry-custom-merge",children:"Resource.telemetry (custom merge)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// apollo-client.ts:136\u2013154\ntelemetry: {\n  merge(existing, incoming) {\n    if (!existing) return incoming;\n    if (!incoming) return existing;\n    return {\n      ...existing,\n      ...incoming,\n      // Append bandwidth history (last 24h)\n      bandwidthHistory: [\n        ...(existing.bandwidthHistory ?? []),\n        ...(incoming.bandwidthHistory ?? []),\n      ].slice(-288), // 288 \xd7 5min intervals = 24 hours\n      hourlyStats: incoming.hourlyStats ?? existing.hourlyStats,\n      dailyStats: incoming.dailyStats ?? existing.dailyStats,\n    };\n  },\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Purpose:"})," Append historical bandwidth samples while capping to 24 hours (288 entries at 5-minute sampling). Keep the latest hourly/daily aggregate stats from the most recent update."]}),"\n",(0,i.jsx)(n.h4,{id:"validation-and-deployment-merge-false",children:"Validation and Deployment (merge: false)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// apollo-client.ts:155\u2013162\nvalidation: {\n  merge: false,  // Full replacement on validation run\n},\ndeployment: {\n  merge: false,  // Full replacement on apply\n},\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Rationale:"})," Validation and deployment states are snapshots of a specific cycle \u2014 a new validation should completely replace the previous one, not merge incrementally."]}),"\n",(0,i.jsx)(n.h3,{id:"default-query-options",children:"Default Query Options"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts:263\u2013285"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"defaultOptions: {\n  watchQuery: {\n    fetchPolicy: 'cache-and-network',  // Return cached \u2192 refetch in background\n    nextFetchPolicy: 'cache-first',    // Subsequent renders: cache only\n    errorPolicy: 'all',                // Return partial data on error\n  },\n  query: {\n    fetchPolicy: 'cache-first',        // Use cache, avoid network if present\n    errorPolicy: 'all',\n  },\n  mutate: {\n    errorPolicy: 'all',                // Partial data on mutation error\n  },\n},\n"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Setting"}),(0,i.jsx)(n.th,{children:"Value"}),(0,i.jsx)(n.th,{children:"When Used"}),(0,i.jsx)(n.th,{children:"Effect"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"watchQuery.fetchPolicy"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cache-and-network"})}),(0,i.jsxs)(n.td,{children:["First hook render or manual ",(0,i.jsx)(n.code,{children:"refetch()"})]}),(0,i.jsx)(n.td,{children:"Return cached data immediately, then refresh from network in background"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"watchQuery.nextFetchPolicy"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cache-first"})}),(0,i.jsx)(n.td,{children:"Subsequent renders of same query"}),(0,i.jsx)(n.td,{children:"Skip network request if cache exists"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"query.fetchPolicy"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cache-first"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"useQuery(..., { fetchPolicy: 'query' })"})}),(0,i.jsx)(n.td,{children:"Use cache if available, otherwise fetch"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mutate.errorPolicy"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"all"})}),(0,i.jsx)(n.td,{children:"All mutations"}),(0,i.jsx)(n.td,{children:"Return any successfully resolved fields even if some errored"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Benefit:"})," The ",(0,i.jsx)(n.code,{children:"cache-and-network"})," + ",(0,i.jsx)(n.code,{children:"cache-first"})," pattern eliminates loading spinners for previously visited views (data from cache) while keeping data fresh (background network refresh). Subsequent renders of the same query avoid redundant network round-trips."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Topic"}),(0,i.jsx)(n.th,{children:"Document"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Authentication tokens, login flows"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./authentication.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Error handling architecture, error boundaries"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./error-handling.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Offline-first patterns, cache strategies"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./offline-first.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"WebSocket subscription usage patterns"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./websocket-subscriptions.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Universal State v2 resource model"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./universal-state-resource-model.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Change set pattern (Apply-Confirm-Merge)"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./change-set-pattern.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Domain query hooks (per-feature wrappers)"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./domain-query-hooks.md"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Testing Apollo with mocks and Storybook"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"./testing-and-codegen.md"})})]})]})]})]})}function a(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>l});var s=r(14041);const i={},t=s.createContext(i);function c(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);