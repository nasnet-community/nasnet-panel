"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[49192],{71184:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>l});var r=i(14041);const s={},t=r.createContext(s);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:n},e.children)}},86324:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"forms-validation/validation-pipeline","title":"Validation Pipeline","description":"The validation pipeline (libs/core/forms/src/validation-pipeline/) orchestrates multi-stage validation that combines local Zod schema checks with backend network-aware checks. The number of stages that run depends on how risky the operation is.","source":"@site/../connect/docs/forms-validation/validation-pipeline.md","sourceDirName":"forms-validation","slug":"/forms-validation/validation-pipeline","permalink":"/docs/frontend/forms-validation/validation-pipeline","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../connect/docs/forms-validation/validation-pipeline.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Forms and Validation Overview","permalink":"/docs/frontend/forms-validation/overview"},"next":{"title":"Wizard Forms","permalink":"/docs/frontend/forms-validation/wizard-forms"}}');var s=i(31085),t=i(71184);const a={},l="Validation Pipeline",o={},d=[{value:"The 7 Stages",id:"the-7-stages",level:2},{value:"Risk Levels",id:"risk-levels",level:2},{value:"Stage Status Values",id:"stage-status-values",level:2},{value:"ValidationPipeline Class",id:"validationpipeline-class",level:2},{value:"ValidationPipelineConfig",id:"validationpipelineconfig",level:2},{value:"ValidationPipelineResult",id:"validationpipelineresult",level:2},{value:"ValidationError Shape",id:"validationerror-shape",level:2},{value:"Mapping Errors to React Hook Form",id:"mapping-errors-to-react-hook-form",level:2},{value:"useValidationPipeline Hook",id:"usevalidationpipeline-hook",level:2},{value:"Aborting a Running Pipeline",id:"aborting-a-running-pipeline",level:2},{value:"Backend Request Format",id:"backend-request-format",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"validation-pipeline",children:"Validation Pipeline"})}),"\n",(0,s.jsxs)(n.p,{children:["The validation pipeline (",(0,s.jsx)(n.code,{children:"libs/core/forms/src/validation-pipeline/"}),") orchestrates multi-stage validation that combines local Zod schema checks with backend network-aware checks. The number of stages that run depends on how risky the operation is."]}),"\n",(0,s.jsx)(n.h2,{id:"the-7-stages",children:"The 7 Stages"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Stage 1: schema        \u2190 local Zod validation (always runs)\nStage 2: syntax        \u2190 format checks beyond Zod (server-side)\nStage 3: cross-resource \u2190 dependency and conflict detection\nStage 4: dependencies  \u2190 checks that referenced resources exist\nStage 5: network       \u2190 IP collision, routing loop detection\nStage 6: platform      \u2190 RouterOS version compatibility checks\nStage 7: dry-run       \u2190 attempt the operation without committing\n"})}),"\n",(0,s.jsx)(n.h2,{id:"risk-levels",children:"Risk Levels"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"riskLevel"})," setting selects which stages to run. This prevents unnecessarily slow validation for trivial changes."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Risk level"}),(0,s.jsx)(n.th,{children:"Stages run"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"low"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"schema"}),", ",(0,s.jsx)(n.code,{children:"syntax"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"medium"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"schema"}),", ",(0,s.jsx)(n.code,{children:"syntax"}),", ",(0,s.jsx)(n.code,{children:"cross-resource"}),", ",(0,s.jsx)(n.code,{children:"dependencies"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"high"})}),(0,s.jsx)(n.td,{children:"All 7 stages"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Guidelines for choosing risk level:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"low"})," \u2014 read-only forms, cosmetic changes (renaming, adding a tag)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"medium"})," \u2014 configuration changes with potential cross-resource effects (DHCP pool change, DNS server update)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"high"})," \u2014 network topology changes, new VPN tunnels, firewall rule modifications, anything that could interrupt connectivity"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"stage-status-values",children:"Stage Status Values"}),"\n",(0,s.jsx)(n.p,{children:"Each stage reports one of:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Status"}),(0,s.jsx)(n.th,{children:"Meaning"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pending"})}),(0,s.jsx)(n.td,{children:"Queued but not yet started"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"running"})}),(0,s.jsx)(n.td,{children:"Currently executing"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"passed"})}),(0,s.jsx)(n.td,{children:"Completed with no errors"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"failed"})}),(0,s.jsx)(n.td,{children:"One or more errors found"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"skipped"})}),(0,s.jsx)(n.td,{children:"Not in scope for the current risk level, or pipeline aborted"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"validationpipeline-class",children:"ValidationPipeline Class"}),"\n",(0,s.jsxs)(n.p,{children:["File: ",(0,s.jsx)(n.code,{children:"libs/core/forms/src/validation-pipeline/ValidationPipeline.ts"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { createValidationPipeline } from '@nasnet/core/forms';\n\n// Create a pipeline\nconst pipeline = createValidationPipeline(\n  async (request) => {\n    // Call the backend validate mutation\n    const result = await validateMutation({ variables: { ...request } });\n    return result.data.validate;\n  },\n  { riskLevel: 'high', stopOnError: false, includeDryRun: true },\n  {\n    onStageStart: (stage) => console.log(`Starting: ${stage}`),\n    onStageComplete: (result) => updateUI(result),\n    onProgress: (current, total) => setProgress(current / total),\n  }\n);\n\n// Run validation\nconst result = await pipeline.validate(\n  'wireguard-peer',    // resourceType\n  formData,            // form values\n  existingPeerId,      // resourceId (undefined for create)\n  routerId             // router context\n);\n\nif (!result.isValid) {\n  // Map errors to form fields\n  Object.entries(result.fieldErrors).forEach(([field, errors]) => {\n    form.setError(field, { type: errors[0].code, message: errors[0].message });\n  });\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"validationpipelineconfig",children:"ValidationPipelineConfig"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ValidationPipelineConfig {\n  riskLevel: 'low' | 'medium' | 'high';\n  stopOnError?: boolean;      // default: false (run all stages)\n  skipStages?: ValidationStageName[];\n  stageTimeout?: number;      // ms per stage\n  includeDryRun?: boolean;    // default: false (dry-run stage only when true)\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"validationpipelineresult",children:"ValidationPipelineResult"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ValidationPipelineResult {\n  isValid: boolean;\n  stages: ValidationStageResult[];     // one per stage\n  errors: ValidationError[];           // all errors across all stages\n  warnings: ValidationError[];\n  totalDurationMs: number;\n  fieldErrors: Record<string, ValidationError[]>;  // keyed by form field path\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"validationerror-shape",children:"ValidationError Shape"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ValidationError {\n  code: string;           // e.g., 'IP_COLLISION', 'E001'\n  message: string;        // human-readable\n  fieldPath?: string;     // e.g., 'address', 'peers.0.publicKey'\n  severity: 'error' | 'warning';\n  stage: ValidationStageName;\n  suggestions?: string[];\n  relatedResources?: string[];\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"mapping-errors-to-react-hook-form",children:"Mapping Errors to React Hook Form"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"mapToFormErrors"})," to convert pipeline field errors to React Hook Form's ",(0,s.jsx)(n.code,{children:"setError"})," format:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { mapToFormErrors } from '@nasnet/core/forms';\n\nconst result = await pipeline.validate('wireguard-peer', formData);\nif (!result.isValid) {\n  const formErrors = mapToFormErrors(result.fieldErrors);\n  // { publicKey: { type: 'INVALID_KEY', message: 'Key must be 44 chars' } }\n  Object.entries(formErrors).forEach(([field, error]) => {\n    form.setError(field as FieldPath<FormData>, error);\n  });\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"usevalidationpipeline-hook",children:"useValidationPipeline Hook"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"useValidationPipeline"})," hook (",(0,s.jsx)(n.code,{children:"libs/core/forms/src/useValidationPipeline.ts"}),") provides a React-integrated version:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { useValidationPipeline } from '@nasnet/core/forms';\n\nfunction MyForm() {\n  const pipeline = useValidationPipeline({\n    schema: mySchema,\n    strategy: 'medium',\n    resourceUuid: existingResourceId,\n    enabled: true,\n  });\n\n  // pipeline.validate(data) \u2014 trigger validation\n  // pipeline.stages       \u2014 array of stage results for progress UI\n  // pipeline.isValid      \u2014 overall validity\n  // pipeline.errors       \u2014 all errors\n  // pipeline.conflicts    \u2014 cross-resource conflicts\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"aborting-a-running-pipeline",children:"Aborting a Running Pipeline"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const pipeline = createValidationPipeline(validateFn, config);\n\n// Start validation\nconst validationPromise = pipeline.validate('interface', data);\n\n// Abort if user navigates away\npipeline.abort();\n\n// The result will show remaining stages as 'skipped'\nconst result = await validationPromise;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"backend-request-format",children:"Backend Request Format"}),"\n",(0,s.jsx)(n.p,{children:"The pipeline sends a single request to the backend for all non-schema stages:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ValidationRequest {\n  resourceType: string;\n  resourceId?: string;\n  data: Record<string, unknown>;\n  stages: ValidationStageName[];\n  routerId?: string;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The backend processes all requested stages and returns results in a single ",(0,s.jsx)(n.code,{children:"ValidationResponse"}),". This avoids multiple round-trips for high-risk validations."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);