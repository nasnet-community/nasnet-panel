"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[40040],{62554:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"alert-system","title":"Alert System","description":"Overview","source":"@site/../backend/docs/alert-system.md","sourceDirName":".","slug":"/alert-system","permalink":"/docs/backend/alert-system","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/alert-system.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Introduction","permalink":"/docs/backend/intro"},"next":{"title":"Application Bootstrap","permalink":"/docs/backend/application-bootstrap"}}');var s=r(31085),t=r(71184);const d={},c="Alert System",l={},a=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/alerts</code> \u2014 Engine and Evaluation",id:"internalalerts--engine-and-evaluation",level:3},{value:"Key Types",id:"key-types",level:4},{value:"Key Functions",id:"key-functions",level:4},{value:"Condition Evaluation",id:"condition-evaluation",level:4},{value:"<code>internal/alerts/throttle</code> \u2014 Rate Limiting and Quiet Hours Queuing",id:"internalalertsthrottle--rate-limiting-and-quiet-hours-queuing",level:3},{value:"<code>alert_queue.go</code>",id:"alert_queuego",level:4},{value:"<code>quiet_hours_queue.go</code>",id:"quiet_hours_queuego",level:4},{value:"<code>internal/notifications</code> \u2014 Dispatcher and Channel Interface",id:"internalnotifications--dispatcher-and-channel-interface",level:3},{value:"<code>dispatcher.go</code>",id:"dispatchergo",level:4},{value:"<code>dispatcher_routing.go</code>",id:"dispatcher_routinggo",level:4},{value:"<code>internal/notifications/channels/push</code> \u2014 Push Channels",id:"internalnotificationschannelspush--push-channels",level:3},{value:"<code>ntfy.go</code> \u2014 Ntfy Channel",id:"ntfygo--ntfy-channel",level:4},{value:"<code>telegram.go</code> \u2014 Telegram Channel",id:"telegramgo--telegram-channel",level:4},{value:"<code>pushover.go</code> \u2014 Pushover Channel",id:"pushovergo--pushover-channel",level:4},{value:"<code>inapp.go</code> \u2014 In-App Channel",id:"inappgo--in-app-channel",level:4},{value:"<code>internal/notifications/channels/http</code> \u2014 HTTP Channels",id:"internalnotificationschannelshttp--http-channels",level:3},{value:"<code>email.go</code> \u2014 Email Channel (SMTP)",id:"emailgo--email-channel-smtp",level:4},{value:"<code>webhook.go</code> \u2014 Webhook Channel",id:"webhookgo--webhook-channel",level:4},{value:"<code>internal/alerts/bridge</code> \u2014 Service Alert Bridge",id:"internalalertsbridge--service-alert-bridge",level:3},{value:"<code>internal/services/svcalert</code> \u2014 Digest History Service",id:"internalservicessvcalert--digest-history-service",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Event \u2192 Notification (Normal Path)",id:"event--notification-normal-path",level:3},{value:"Quiet Hours Path",id:"quiet-hours-path",level:3},{value:"Service Event Path (Bridge)",id:"service-event-path-bridge",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Alert Rule Fields (<code>ent.AlertRule</code>)",id:"alert-rule-fields-entalertrule",level:3},{value:"Storm Detector Configuration",id:"storm-detector-configuration",level:3},{value:"Notification Channel Configuration Examples",id:"notification-channel-configuration-examples",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"alert-system",children:"Alert System"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The alert system evaluates domain events against user-defined rules and delivers notifications through multiple channels. It is built around a stateless evaluation loop: every event published on the event bus is matched against cached alert rules, filtered through suppression layers, and routed to notification channels with retry logic and dead-letter queuing."}),"\n",(0,s.jsx)(n.p,{children:"Key design principles:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rule evaluation is in-memory"})," \u2014 rules are cached on startup and refreshed on rule change events, avoiding database reads per event."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Three suppression layers"})," \u2014 storm detection (global rate limit), per-rule throttle windows, and quiet hours (time-of-day blocking) work independently and compose."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Channels are pluggable"})," \u2014 the ",(0,s.jsx)(n.code,{children:"notifications.Channel"})," interface is the only contract; adding a channel requires implementing ",(0,s.jsx)(n.code,{children:"Name()"}),", ",(0,s.jsx)(n.code,{children:"Send()"}),", and ",(0,s.jsx)(n.code,{children:"Test()"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Digest vs. immediate delivery"})," \u2014 channels opt-in to digest mode; quiet hours silently queue notifications and flush them as grouped digests when quiet hours end."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Best-effort retry"})," \u2014 failed deliveries retry three times with exponential backoff; exhausted deliveries go to a dead-letter queue rather than being silently dropped."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Service alert bridge"})," \u2014 a separate bridge component listens to service lifecycle events and synthesises alert notifications using the same pipeline, with per-instance rate limiting and auto-provisioned default rules."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["Event Bus"]\n    A --\x3e B["Engine.HandleEvent"]\n\n    B --\x3e B1["Storm Detector<br/>global rate limit"]\n    B1 --\x3e B1A["suppressed<br/>\u2192 trackSuppression + return"]\n\n    B --\x3e B2["Rule Cache Lookup<br/>getMatchingRules"]\n    B2 --\x3e B2A["no rules \u2192 return"]\n\n    B --\x3e B3["evaluateRule<br/>per matching rule"]\n\n    B3 --\x3e B3A["Condition evaluation<br/>JSON field checks"]\n    B3 --\x3e B3B["Throttle Manager<br/>per-rule cooldown"]\n    B3B --\x3e B3B1["throttled<br/>\u2192 trackSuppression + return"]\n\n    B3 --\x3e B3C["Quiet Hours Filter"]\n    B3C --\x3e B3C1["in quiet hours<br/>\u2192 queueForDigest + return"]\n\n    B3 --\x3e B3D["createAlert"]\n    B3D --\x3e B3D1["DB persist<br/>ent AlertLog"]\n    B3D --\x3e B3D2["Escalation Engine<br/>track open alerts"]\n    B3D --\x3e B3D3["Dispatcher.Dispatch"]\n\n    B3D3 --\x3e B3D3A["Immediate channels<br/>\u2192 deliverWithRetries"]\n    B3D3A --\x3e B3D3A1["retry 3\xd7<br/>1s/2s/4s backoff"]\n    B3D3A1 --\x3e B3D3A2["exhausted<br/>\u2192 Dead Letter Queue"]\n\n    B3D3 --\x3e B3D3B["Digest channels<br/>\u2192 QuietHoursQueueManager.Enqueue"]\n    B3D3B --\x3e B3D3B1["1-min worker<br/>\u2192 deliver when quiet hours end"]\n\n    C["Service Alert Bridge<br/>parallel path"]\n    C --\x3e C1["Subscribes: service.started<br/>.stopped / .failed / .updated<br/>.crashed / .error<br/>service.traffic.quota_exceeded<br/>.killswitch_activated<br/>service.update.available<br/>.installed"]\n    C1 --\x3e C2["Per-instance rate limiting<br/>100 events / 5 min window"]\n    C2 --\x3e C3["Quiet hours queuing<br/>with 24h TTL"]\n    C3 --\x3e C4["Manifest enrichment<br/>service name, category"]\n    C4 --\x3e C5["Dispatcher.Dispatch<br/>same pipeline as engine"]'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,s.jsxs)(n.h3,{id:"internalalerts--engine-and-evaluation",children:[(0,s.jsx)(n.code,{children:"internal/alerts"})," \u2014 Engine and Evaluation"]}),"\n",(0,s.jsx)(n.h4,{id:"key-types",children:"Key Types"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"Engine"})})," (",(0,s.jsx)(n.code,{children:"engine.go"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Engine struct {\n    db               *ent.Client\n    eventBus         events.EventBus\n    throttleManager  *ThrottleManager\n    quietHours       *QuietHoursFilter\n    stormDetector    *StormDetector\n    escalationEngine *EscalationEngine\n    digestService    *DigestService\n    alertQueue       *AlertQueue\n    digestTicker     *time.Ticker\n    log              *zap.SugaredLogger\n\n    rulesCache   map[string]*ent.AlertRule  // keyed by rule.ID\n    rulesCacheMu sync.RWMutex\n\n    suppressionCounts  map[string]int    // rule ID \u2192 suppressed count\n    suppressionReasons map[string]string // rule ID \u2192 last reason\n    suppressionMu      sync.Mutex\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"EngineConfig"})})," (",(0,s.jsx)(n.code,{children:"engine.go"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type EngineConfig struct {\n    DB               *ent.Client\n    EventBus         events.EventBus\n    Dispatcher       *notifications.Dispatcher\n    EscalationEngine *EscalationEngine\n    DigestService    *DigestService\n    Logger           *zap.SugaredLogger\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"key-functions",children:"Key Functions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NewEngine(cfg EngineConfig) *Engine"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsx)(n.td,{children:"Creates engine; builds escalation engine from dispatcher if not injected"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.Start(ctx) error"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsx)(n.td,{children:"Loads rule cache, subscribes to all events and rule-change events, starts throttle summary worker (5 min) and digest delivery worker (1 min)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.HandleEvent(ctx, Event) error"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsxs)(n.td,{children:["Entry point: storm check \u2192 rule lookup \u2192 per-rule ",(0,s.jsx)(n.code,{children:"evaluateRule"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.Stop(ctx) error"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsx)(n.td,{children:"Stops digest ticker, throttle manager, escalation engine"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.getMatchingRules(eventType) []*ent.AlertRule"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsxs)(n.td,{children:["Read-locked scan of rules cache filtering by ",(0,s.jsx)(n.code,{children:"rule.EventType"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.refreshRulesCache(ctx) error"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsxs)(n.td,{children:["Queries ",(0,s.jsx)(n.code,{children:"alertrule.Enabled(true)"}),", replaces cache atomically"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.handleRuleChange(ctx, Event) error"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsxs)(n.td,{children:["Subscribed to ",(0,s.jsx)(n.code,{children:"alert.rule.{created,updated,deleted}"}),"; calls ",(0,s.jsx)(n.code,{children:"refreshRulesCache"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.trackSuppression(ruleID, reason)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsx)(n.td,{children:"Increments suppression counter under mutex"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Engine.getAndResetSuppression(ruleID) (count, reason)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine.go"})}),(0,s.jsx)(n.td,{children:"Atomically reads and clears suppression state"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"evaluateRule(ctx, rule, eventType, eventData, startTime)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsxs)(n.td,{children:["Condition parsing \u2192 throttle \u2192 quiet hours \u2192 ",(0,s.jsx)(n.code,{children:"createAlert"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"createAlert(ctx, rule, eventType, eventData)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsxs)(n.td,{children:["Persists ",(0,s.jsx)(n.code,{children:"AlertLog"}),", tracks with escalation engine, publishes ",(0,s.jsx)(n.code,{children:"alert.created"})," event, dispatches notification"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"handleQuietHoursCheck(ctx, rule, notification) bool"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsx)(n.td,{children:"Returns true (alert suppressed) if inside a quiet hours window"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"queueForDigest(deviceID, alert)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsxs)(n.td,{children:["Enqueues into ",(0,s.jsx)(n.code,{children:"AlertQueue"})," for batch delivery"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"publishAlertEvent(ctx, alert)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsxs)(n.td,{children:["Publishes ",(0,s.jsx)(n.code,{children:"alert.created"})," typed event on event bus"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"runDigestDelivery(ctx)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsxs)(n.td,{children:["Background goroutine: ticks every 1 minute, calls ",(0,s.jsx)(n.code,{children:"deliverQueuedAlerts"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"deliverQueuedAlerts(ctx)"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsxs)(n.td,{children:["Drains ",(0,s.jsx)(n.code,{children:"AlertQueue.DequeueAll()"}),", formats digest, dispatches via Dispatcher"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FormatDigest(alerts []QueuedAlert) string"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"engine_evaluate.go"})}),(0,s.jsx)(n.td,{children:"Groups by severity (CRITICAL \u2192 ERROR \u2192 WARNING \u2192 INFO), counts by event type, includes timestamp range"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"condition-evaluation",children:"Condition Evaluation"}),"\n",(0,s.jsx)(n.p,{children:"Rules carry a JSON condition blob that is evaluated against the event payload:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// Simplified from evaluateRule\ntype Condition struct {\n    Field    string      `json:"field"`\n    Operator string      `json:"operator"` // "eq", "ne", "gt", "lt", "contains", "exists"\n    Value    interface{} `json:"value"`\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Evaluation iterates all conditions with AND semantics. A rule fires when all conditions are satisfied or when the rule has no conditions (unconditional match)."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalalertsthrottle--rate-limiting-and-quiet-hours-queuing",children:[(0,s.jsx)(n.code,{children:"internal/alerts/throttle"})," \u2014 Rate Limiting and Quiet Hours Queuing"]}),"\n",(0,s.jsx)(n.h4,{id:"alert_queuego",children:(0,s.jsx)(n.code,{children:"alert_queue.go"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"AlertQueue"})})," \u2014 thread-safe per-device alert grouping for digest delivery."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type QueuedAlert struct {\n    DeviceID  string\n    RuleID    string\n    EventType string\n    Severity  string\n    Message   string\n    QueuedAt  time.Time\n}\n\ntype AlertQueue struct {\n    mu     sync.Mutex\n    alerts map[string][]QueuedAlert // keyed by deviceID\n}\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NewAlertQueue() *AlertQueue"})}),(0,s.jsx)(n.td,{children:"Creates empty queue"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Enqueue(alert QueuedAlert)"})}),(0,s.jsx)(n.td,{children:"Appends to device bucket under mutex"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DequeueAll() map[string][]QueuedAlert"})}),(0,s.jsx)(n.td,{children:"Atomically drains and returns all queued alerts, resets internal map"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Count() int"})}),(0,s.jsx)(n.td,{children:"Total alerts across all devices"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Clear()"})}),(0,s.jsx)(n.td,{children:"Drops all queued alerts"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GetByDevice(deviceID) []QueuedAlert"})}),(0,s.jsx)(n.td,{children:"Read copy for a single device"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FormatDigest(deviceID) string"})}),(0,s.jsx)(n.td,{children:"Formats per-device digest as human-readable summary"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"quiet_hours_queuego",children:(0,s.jsx)(n.code,{children:"quiet_hours_queue.go"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"QuietHoursQueueManager"})})," \u2014 per-channel queues with TTL and background delivery."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type QueuedNotification struct {\n    Notification notifications.Notification\n    QueuedAt     time.Time\n}\n\ntype channelQueue struct {\n    mu            sync.Mutex\n    notifications []QueuedNotification\n    maxSize       int           // 100\n    ttl           time.Duration // 24 hours\n}\n\ntype DeliveryCallback func(channelName string, notifications []QueuedNotification) error\n\ntype QuietHoursQueueManager struct {\n    queues   map[string]*channelQueue  // keyed by channel name\n    callback DeliveryCallback\n    ticker   *time.Ticker             // 1-minute interval\n    // ...\n}\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NewQuietHoursQueueManager(channels []string, callback DeliveryCallback) *QuietHoursQueueManager"})}),(0,s.jsx)(n.td,{children:"Creates per-channel queues, starts 1-minute background worker"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ShouldQueue(channelName string, quietHoursActive bool) bool"})}),(0,s.jsx)(n.td,{children:"Returns true when quiet hours are active and channel exists"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Enqueue(channelName string, notification Notification) error"})}),(0,s.jsx)(n.td,{children:"Appends to channel queue; returns error if full (max 100)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"processQueues(ctx)"})}),(0,s.jsx)(n.td,{children:"Background tick handler: purges expired notifications (TTL 24h), delivers queued notifications to channels whose quiet hours have ended"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FlushAll(ctx) error"})}),(0,s.jsx)(n.td,{children:"Forces delivery of all queued notifications regardless of quiet hours state; used on shutdown"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["The manager does ",(0,s.jsx)(n.strong,{children:"not"})," evaluate quiet hours itself \u2014 the caller (",(0,s.jsx)(n.code,{children:"handleQuietHoursCheck"}),") determines whether quiet hours are active. The manager's background worker re-evaluates on each tick by calling ",(0,s.jsx)(n.code,{children:"ShouldQueue"})," and delivering when it returns false."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalnotifications--dispatcher-and-channel-interface",children:[(0,s.jsx)(n.code,{children:"internal/notifications"})," \u2014 Dispatcher and Channel Interface"]}),"\n",(0,s.jsx)(n.h4,{id:"dispatchergo",children:(0,s.jsx)(n.code,{children:"dispatcher.go"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"Dispatcher"})})," \u2014 routes notifications to channels with retry and dead-letter queuing."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Dispatcher struct {\n    channels       map[string]Channel\n    digestService  *DigestService\n    templateService TemplateService\n    maxRetries     int           // 3\n    initialBackoff time.Duration // 1 second\n    deadLetterQueue []FailedDelivery\n    dlqMu          sync.Mutex\n}\n\ntype FailedDelivery struct {\n    ChannelName  string\n    Notification Notification\n    LastError    error\n    AttemptedAt  time.Time\n    Attempts     int\n}\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NewDispatcher(channels []Channel, digestService *DigestService, templateService TemplateService) *Dispatcher"})}),(0,s.jsx)(n.td,{children:"Registers channels by name"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Dispatch(ctx, notification Notification) error"})}),(0,s.jsxs)(n.td,{children:["Splits channels into immediate vs. digest; queues digests with ",(0,s.jsx)(n.code,{children:"QuietHoursQueueManager"}),", sends immediate via ",(0,s.jsx)(n.code,{children:"dispatchToChannel"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"TestChannel(ctx, channelName string, config map[string]interface{}) error"})}),(0,s.jsxs)(n.td,{children:["Calls ",(0,s.jsx)(n.code,{children:"channel.Test(ctx, config)"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GetChannel(name string) (Channel, bool)"})}),(0,s.jsx)(n.td,{children:"Returns channel by name"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GetDeadLetterQueue() []FailedDelivery"})}),(0,s.jsx)(n.td,{children:"Returns snapshot of failed deliveries"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.code,{children:"Channel"})," interface:"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Channel interface {\n    Name() string\n    Send(ctx context.Context, notification Notification) error\n    Test(ctx context.Context, config map[string]interface{}) error\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.code,{children:"Notification"})," struct:"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type Notification struct {\n    Title    string\n    Message  string\n    Severity string                 // "CRITICAL", "WARNING", "INFO"\n    Data     map[string]interface{} // arbitrary metadata for channel formatting\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"dispatcher_routinggo",children:(0,s.jsx)(n.code,{children:"dispatcher_routing.go"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"dispatchToChannel(ctx, channel Channel, notification Notification) error"})}),(0,s.jsxs)(n.td,{children:["Renders template then calls ",(0,s.jsx)(n.code,{children:"deliverWithRetries"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"renderAlertTemplate(notification Notification) (Notification, error)"})}),(0,s.jsxs)(n.td,{children:["Applies template service if ",(0,s.jsx)(n.code,{children:'notification.Data["template_id"]'})," is set"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"resolveAlert(ctx, alertID string) (*ent.AlertLog, error)"})}),(0,s.jsx)(n.td,{children:"Looks up alert from DB for enrichment"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"deliverWithRetries(ctx, channel Channel, notification Notification) error"})}),(0,s.jsxs)(n.td,{children:["Retry loop: attempts up to ",(0,s.jsx)(n.code,{children:"maxRetries+1"})," times; backoff doubles each attempt starting from ",(0,s.jsx)(n.code,{children:"initialBackoff"})," (1s \u2192 2s \u2192 4s); on exhaustion appends to dead-letter queue"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"isRetryable(err error) bool"})}),(0,s.jsx)(n.td,{children:'Returns true for network errors, timeouts, and errors containing "temporary:"; returns false for invalid-config errors and "unauthorized"'})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"HandleAlertCreated(ctx, Event) error"})}),(0,s.jsxs)(n.td,{children:["Event bus subscriber for ",(0,s.jsx)(n.code,{children:"alert.created"}),"; extracts alert ID, resolves alert, dispatches notification"]})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Retry and backoff:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Attempt 1  (immediate)\nAttempt 2  (after 1s)\nAttempt 3  (after 2s)\nAttempt 4  (after 4s)\n\u2192 Dead Letter Queue\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalnotificationschannelspush--push-channels",children:[(0,s.jsx)(n.code,{children:"internal/notifications/channels/push"})," \u2014 Push Channels"]}),"\n",(0,s.jsxs)(n.h4,{id:"ntfygo--ntfy-channel",children:[(0,s.jsx)(n.code,{children:"ntfy.go"})," \u2014 Ntfy Channel"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"NtfyChannel"})})," delivers notifications to a self-hosted or public ntfy server."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type NtfyConfig struct {\n    ServerURL string `json:"server_url"` // Must be HTTPS\n    Topic     string `json:"topic"`\n    Token     string `json:"token"`      // Optional bearer token\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Security properties:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Rejects non-HTTPS URLs at config parse time."}),"\n",(0,s.jsxs)(n.li,{children:["Resolves server hostname and blocks private IP ranges (SSRF protection via ",(0,s.jsx)(n.code,{children:"isPrivateIP"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Priority mapping:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Severity"}),(0,s.jsx)(n.th,{children:"ntfy Priority"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CRITICAL"})}),(0,s.jsx)(n.td,{children:"5 (urgent)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WARNING"})}),(0,s.jsx)(n.td,{children:"4 (high)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"default"}),(0,s.jsx)(n.td,{children:"3 (default)"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Tags: ",(0,s.jsx)(n.code,{children:"CRITICAL"})," \u2192 ",(0,s.jsx)(n.code,{children:'["rotating_light"]'}),", ",(0,s.jsx)(n.code,{children:"WARNING"})," \u2192 ",(0,s.jsx)(n.code,{children:'["warning"]'}),", ",(0,s.jsx)(n.code,{children:"INFO"})," \u2192 ",(0,s.jsx)(n.code,{children:'["information_source"]'}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Key functions: ",(0,s.jsx)(n.code,{children:"NewNtfyChannel"}),", ",(0,s.jsx)(n.code,{children:"Send"}),", ",(0,s.jsx)(n.code,{children:"Test"}),", ",(0,s.jsx)(n.code,{children:"ParseNtfyConfig"}),", ",(0,s.jsx)(n.code,{children:"isPrivateIP"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"telegramgo--telegram-channel",children:[(0,s.jsx)(n.code,{children:"telegram.go"})," \u2014 Telegram Channel"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"TelegramChannel"})})," delivers to one or more Telegram chats via the Bot API."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type TelegramConfig struct {\n    BotToken string   `json:"bot_token"`\n    ChatID   string   `json:"chat_id"`   // Deprecated: use ChatIDs\n    ChatIDs  []string `json:"chat_ids"`  // Supports multiple targets\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Delivery uses ",(0,s.jsx)(n.code,{children:"errgroup"})," for parallel sends to all chat IDs. Partial success (some chats succeeded, some failed) returns a combined error while still recording the success count."]}),"\n",(0,s.jsx)(n.p,{children:"Message format:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"MarkdownV2"})," parse mode with full character escaping (",(0,s.jsx)(n.code,{children:"markdownV2Replacer"})," covers all 19 special characters)."]}),"\n",(0,s.jsx)(n.li,{children:"Severity emoji prefix: CRITICAL = \ud83d\udd34, WARNING = \ud83d\udfe0, INFO = \ud83d\udfe2, default = \ud83d\udd14."}),"\n",(0,s.jsxs)(n.li,{children:["Optional router name, event type, and triggered-at fields from ",(0,s.jsx)(n.code,{children:"notification.Data"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:['Inline keyboard "View in NasNet" button constructed from ',(0,s.jsx)(n.code,{children:"base_url"})," + ",(0,s.jsx)(n.code,{children:"alert_id"})," in ",(0,s.jsx)(n.code,{children:"notification.Data"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Rate limiting: returns a ",(0,s.jsx)(n.code,{children:"temporary:"})," prefixed error on HTTP 429 with ",(0,s.jsx)(n.code,{children:"retry_after"})," seconds from Telegram's response; this makes the error retryable by ",(0,s.jsx)(n.code,{children:"isRetryable"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Key functions: ",(0,s.jsx)(n.code,{children:"NewTelegramChannel"}),", ",(0,s.jsx)(n.code,{children:"Send"}),", ",(0,s.jsx)(n.code,{children:"sendMessageToChat"}),", ",(0,s.jsx)(n.code,{children:"Test"}),", ",(0,s.jsx)(n.code,{children:"formatMessage"}),", ",(0,s.jsx)(n.code,{children:"escapeMarkdownV2"}),", ",(0,s.jsx)(n.code,{children:"buildInlineKeyboard"}),", ",(0,s.jsx)(n.code,{children:"ParseTelegramConfig"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"pushovergo--pushover-channel",children:[(0,s.jsx)(n.code,{children:"pushover.go"})," \u2014 Pushover Channel"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"PushoverChannel"})})," delivers to Pushover users or groups."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type PushoverConfig struct {\n    UserKey  string `json:"user_key"`\n    APIToken string `json:"api_token"`\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Priority mapping:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Severity"}),(0,s.jsx)(n.th,{children:"Pushover Priority"}),(0,s.jsx)(n.th,{children:"Behaviour"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CRITICAL"})}),(0,s.jsx)(n.td,{children:"2 (emergency)"}),(0,s.jsx)(n.td,{children:"Requires acknowledgement; sends receipt token"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WARNING"})}),(0,s.jsx)(n.td,{children:"1 (high)"}),(0,s.jsx)(n.td,{children:"Bypasses quiet hours on device"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"default"}),(0,s.jsx)(n.td,{children:"0 (normal)"}),(0,s.jsx)(n.td,{children:"Standard delivery"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Emergency priority (CRITICAL) returns a receipt token stored in the response. This receipt can be cancelled via ",(0,s.jsx)(n.code,{children:"CancelReceipt(ctx, receiptToken string) error"})," if the alert is acknowledged."]}),"\n",(0,s.jsxs)(n.p,{children:["Usage tracking: Pushover API returns ",(0,s.jsx)(n.code,{children:"X-Limit-App-Limit"}),", ",(0,s.jsx)(n.code,{children:"X-Limit-App-Remaining"}),", ",(0,s.jsx)(n.code,{children:"X-Limit-App-Reset"})," headers; these are extracted and available for monitoring."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ValidateCredentials(ctx) error"})," sends a validation request without sending a message."]}),"\n",(0,s.jsxs)(n.p,{children:["Key functions: ",(0,s.jsx)(n.code,{children:"NewPushoverChannel"}),", ",(0,s.jsx)(n.code,{children:"Send"}),", ",(0,s.jsx)(n.code,{children:"Test"}),", ",(0,s.jsx)(n.code,{children:"CancelReceipt"}),", ",(0,s.jsx)(n.code,{children:"ValidateCredentials"}),", ",(0,s.jsx)(n.code,{children:"ParsePushoverConfig"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"inappgo--in-app-channel",children:[(0,s.jsx)(n.code,{children:"inapp.go"})," \u2014 In-App Channel"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"InAppChannel"})})," delivers notifications through the event bus to GraphQL subscriptions."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type InAppChannel struct {\n    eventBus events.EventBus\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"Send"})," creates an ",(0,s.jsx)(n.code,{children:"AlertNotificationEvent"})," via ",(0,s.jsx)(n.code,{children:"notifications.NewAlertNotificationEvent"})," and publishes it to the event bus. GraphQL subscription resolvers listen for this event type and push it to connected WebSocket clients."]}),"\n",(0,s.jsx)(n.p,{children:"This channel has no configuration fields and always succeeds unless the event bus is nil."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalnotificationschannelshttp--http-channels",children:[(0,s.jsx)(n.code,{children:"internal/notifications/channels/http"})," \u2014 HTTP Channels"]}),"\n",(0,s.jsxs)(n.h4,{id:"emailgo--email-channel-smtp",children:[(0,s.jsx)(n.code,{children:"email.go"})," \u2014 Email Channel (SMTP)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"EmailChannel"})})," delivers formatted HTML + plaintext multipart emails via SMTP."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type EmailConfig struct {\n    SMTPHost    string   `json:"smtp_host"`\n    SMTPPort    int      `json:"smtp_port"`\n    Username    string   `json:"username"`\n    Password    string   `json:"password"`\n    FromAddress string   `json:"from_address"`\n    FromName    string   `json:"from_name"`\n    UseTLS      bool     `json:"use_tls"`     // SMTPS (port 465)\n    SkipVerify  bool     `json:"skip_verify"` // Skip TLS certificate verification\n    ToAddresses []string `json:"to_addresses"`\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Message construction:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildTemplateData"})," extracts device name, device IP, event type, rule name, severity, suggested actions, and alert ID from ",(0,s.jsx)(n.code,{children:"notification.Data"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"buildMultipartMessage"})," constructs a ",(0,s.jsx)(n.code,{children:"multipart/alternative"})," MIME message with ",(0,s.jsx)(n.code,{children:"text/plain"})," and ",(0,s.jsx)(n.code,{children:"text/html"})," parts rendered from Go templates in the embedded ",(0,s.jsx)(n.code,{children:"alerts"})," package (",(0,s.jsx)(n.code,{children:"email/default-body.txt"})," and ",(0,s.jsx)(n.code,{children:"email/default-body.html"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Custom headers: ",(0,s.jsx)(n.code,{children:"X-NasNet-Alert-ID"}),", ",(0,s.jsx)(n.code,{children:"X-NasNet-Severity"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Subject format: ",(0,s.jsx)(n.code,{children:"[NasNet Alert - <SEVERITY>] <Title>"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"TLS options:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UseTLS=false"}),": uses ",(0,s.jsx)(n.code,{children:"smtp.SendMail"})," (STARTTLS if available)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UseTLS=true"}),": establishes a TLS connection via ",(0,s.jsx)(n.code,{children:"tls.Dialer"})," before SMTP handshake (SMTPS/port 465)."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Key functions: ",(0,s.jsx)(n.code,{children:"NewEmailChannel"}),", ",(0,s.jsx)(n.code,{children:"Send"}),", ",(0,s.jsx)(n.code,{children:"buildTemplateData"}),", ",(0,s.jsx)(n.code,{children:"buildMultipartMessage"}),", ",(0,s.jsx)(n.code,{children:"renderTemplate"}),", ",(0,s.jsx)(n.code,{children:"sendSMTP"}),", ",(0,s.jsx)(n.code,{children:"sendWithTLS"}),", ",(0,s.jsx)(n.code,{children:"Test"}),", ",(0,s.jsx)(n.code,{children:"ParseEmailConfig"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"webhookgo--webhook-channel",children:[(0,s.jsx)(n.code,{children:"webhook.go"})," \u2014 Webhook Channel"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"WebhookChannel"})})," delivers JSON payloads to an HTTPS endpoint with HMAC-SHA256 request signing."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type WebhookConfig struct {\n    URL       string `json:"url"`        // Must be HTTPS\n    Secret    string `json:"secret"`     // HMAC-SHA256 signing secret\n    Method    string `json:"method"`     // Default: POST\n    Headers   map[string]string `json:"headers"` // Custom headers\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Security properties:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Rejects non-HTTPS URLs."}),"\n",(0,s.jsxs)(n.li,{children:["Resolves URL hostname and blocks private IP ranges (same ",(0,s.jsx)(n.code,{children:"isPrivateIP"})," helper as ntfy)."]}),"\n",(0,s.jsxs)(n.li,{children:["Signs request body with HMAC-SHA256: ",(0,s.jsx)(n.code,{children:"X-NasNet-Signature: sha256=<hex>"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Slack-aware payload: if ",(0,s.jsx)(n.code,{children:'notification.Data["slack_compatible"]'})," is true, ",(0,s.jsx)(n.code,{children:"SendDigest"})," constructs a Slack Block Kit payload instead of the default JSON structure."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ValidateWebhookURL(url string) error"})," performs hostname resolution and SSRF check without sending a request."]}),"\n",(0,s.jsxs)(n.p,{children:["Key functions: ",(0,s.jsx)(n.code,{children:"NewWebhookChannel"}),", ",(0,s.jsx)(n.code,{children:"Send"}),", ",(0,s.jsx)(n.code,{children:"SendDigest"}),", ",(0,s.jsx)(n.code,{children:"ValidateWebhookURL"}),", ",(0,s.jsx)(n.code,{children:"Test"}),", ",(0,s.jsx)(n.code,{children:"ParseWebhookConfig"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalalertsbridge--service-alert-bridge",children:[(0,s.jsx)(n.code,{children:"internal/alerts/bridge"})," \u2014 Service Alert Bridge"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"Bridge"})})," (",(0,s.jsx)(n.code,{children:"bridge.go"}),") connects the service orchestrator event stream to the alert notification pipeline."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Bridge struct {\n    dispatcher     *notifications.Dispatcher\n    eventBus       events.EventBus\n    db             *ent.Client\n    manifestCache  map[string]ManifestInfo  // service name \u2192 display info\n    rateLimiter    map[string]*instanceBucket // instanceID \u2192 rate limit state\n    rateLimiterMu  sync.Mutex\n    quietHoursQueue *QuietHoursQueueManager\n    log            *zap.SugaredLogger\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Subscribed event types:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Event Type"}),(0,s.jsx)(n.th,{children:"Severity"}),(0,s.jsx)(n.th,{children:"Default Behaviour"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.started"})}),(0,s.jsx)(n.td,{children:"INFO"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.stopped"})}),(0,s.jsx)(n.td,{children:"INFO"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.failed"})}),(0,s.jsx)(n.td,{children:"CRITICAL"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.updated"})}),(0,s.jsx)(n.td,{children:"INFO"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.crashed"})}),(0,s.jsx)(n.td,{children:"CRITICAL"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.error"})}),(0,s.jsx)(n.td,{children:"WARNING"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.traffic.quota_exceeded"})}),(0,s.jsx)(n.td,{children:"WARNING"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.killswitch_activated"})}),(0,s.jsx)(n.td,{children:"CRITICAL"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.update.available"})}),(0,s.jsx)(n.td,{children:"INFO"}),(0,s.jsx)(n.td,{children:"Notify"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service.update.installed"})}),(0,s.jsx)(n.td,{children:"INFO"}),(0,s.jsx)(n.td,{children:"Notify"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rate limiting:"})," Each service instance gets a bucket of 100 events per 5-minute sliding window. Events exceeding the rate are silently dropped with a log warning. This prevents a crash-looping service from flooding notification channels."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Event processing pipeline:"})}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["service.* event"]\n    A --\x3e B["Extract instanceID, serviceType<br/>from event payload"]\n    B --\x3e C["Rate limit check<br/>per instanceID, 100/5min"]\n    C --\x3e C1["exceeded \u2192 drop + warn"]\n    C --\x3e C2["enrichEvent<br/>add service display name<br/>category from manifest cache"]\n    C2 --\x3e D["Quiet hours check"]\n    D --\x3e D1["in quiet hours<br/>\u2192 queueNotification<br/>24h TTL + return"]\n    D --\x3e D2["Dispatcher.Dispatch"]'}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"createDefaultRulesIfNeeded(ctx, serviceType string) error"})})," \u2014 called on ",(0,s.jsx)(n.code,{children:"service.started"}),". Checks if any alert rules exist for the service. If none, creates 8 default rules:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Service started (INFO)"}),"\n",(0,s.jsx)(n.li,{children:"Service stopped (INFO)"}),"\n",(0,s.jsx)(n.li,{children:"Service failed (CRITICAL)"}),"\n",(0,s.jsx)(n.li,{children:"Service crashed (CRITICAL)"}),"\n",(0,s.jsx)(n.li,{children:"Traffic quota exceeded (WARNING)"}),"\n",(0,s.jsx)(n.li,{children:"Kill switch activated (CRITICAL)"}),"\n",(0,s.jsx)(n.li,{children:"Update available (INFO)"}),"\n",(0,s.jsx)(n.li,{children:"Update installed (INFO)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Default rules are created with throttle windows to avoid notification storms during repeated restarts."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalservicessvcalert--digest-history-service",children:[(0,s.jsx)(n.code,{children:"internal/services/svcalert"})," \u2014 Digest History Service"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"svcalert.Service"})})," (",(0,s.jsx)(n.code,{children:"service_digest.go"}),") provides digest management APIs exposed through GraphQL resolvers."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GetDigestQueueCount(ctx) (int, error)"})}),(0,s.jsxs)(n.td,{children:["Returns count of alerts currently queued in ",(0,s.jsx)(n.code,{children:"AlertQueue"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GetDigestHistory(ctx, limit int) ([]DigestRecord, error)"})}),(0,s.jsxs)(n.td,{children:["Queries DB for past digest deliveries; groups by ",(0,s.jsx)(n.code,{children:"digestID"}),'; formats period as "X minutes", "X hours", or "X days"']})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"TriggerDigestNow(ctx) error"})}),(0,s.jsx)(n.td,{children:"Forces immediate delivery of all queued alerts, bypassing the 1-minute ticker"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"DigestRecord"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type DigestRecord struct {\n    DigestID    string\n    AlertCount  int\n    Period      string    // "15 minutes", "2 hours", "3 days"\n    DeliveredAt time.Time\n    Channels    []string\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,s.jsx)(n.h3,{id:"event--notification-normal-path",children:"Event \u2192 Notification (Normal Path)"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["1. Domain event published to EventBus<br/>e.g., events.NewServiceEvent<br/>service.failed, serviceInstance"]\n    A --\x3e B["2. Engine.HandleEvent receives event<br/>a. StormDetector.RecordAlert<br/>\u2192 false if global rate exceeded<br/>default: 100 events/min; 60s cooldown<br/>b. getMatchingRules eventType<br/>\u2192 reads from in-memory cache"]\n\n    B --\x3e C["3. evaluateRule per matching rule<br/>a. Parse rule.Conditions JSON array<br/>b. Evaluate each condition<br/>against event payload fields<br/>c. ThrottleManager.Allow ruleID<br/>\u2192 checks per-rule cooldown window<br/>d. QuietHoursFilter.IsActive<br/>rule.QuietHours<br/>\u2192 check time window<br/>\u2192 active: queueForDigest<br/>deviceID, alert and return<br/>e. createAlert<br/>ctx, rule, eventType, eventData"]\n\n    C --\x3e D["4. createAlert<br/>a. Persist ent.AlertLog to database<br/>b. EscalationEngine.TrackAlert<br/>alertID, rule.EscalationPolicy<br/>c. publishAlertEvent<br/>alert.created on EventBus<br/>d. Dispatcher.Dispatch<br/>ctx, notification"]\n\n    D --\x3e E["5. Dispatcher.Dispatch<br/>a. Split channels: immediate vs. digest<br/>b. For digest channels:<br/>QuietHoursQueueManager.Enqueue<br/>c. For immediate channels:<br/>dispatchToChannel<br/>\u2192 deliverWithRetries<br/>\u2192 success: done<br/>\u2192 failure after 3 retries:<br/>dead-letter queue"]'}),"\n",(0,s.jsx)(n.h3,{id:"quiet-hours-path",children:"Quiet Hours Path"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["1. evaluateRule detects<br/>quiet hours active for rule"]\n    A --\x3e B["2. Alert stored in DB<br/>createAlert still called<br/>for persistence"]\n    B --\x3e C["3. Alert appended to AlertQueue<br/>grouped by deviceID"]\n    C --\x3e D["4. 1-minute ticker fires<br/>runDigestDelivery"]\n    D --\x3e E["5. deliverQueuedAlerts<br/>drains AlertQueue.DequeueAll"]\n    E --\x3e F["6. FormatDigest produces<br/>grouped message<br/>severity buckets"]\n    F --\x3e G["7. Dispatcher.Dispatch<br/>with digest notification"]'}),"\n",(0,s.jsx)(n.h3,{id:"service-event-path-bridge",children:"Service Event Path (Bridge)"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["1. Service orchestrator publishes<br/>service.failed or other service.* event"]\n    A --\x3e B["2. Bridge.handleServiceEvent<br/>receives event"]\n    B --\x3e C["3. Rate limit check per instanceID"]\n    C --\x3e D["4. enrichEvent adds manifest<br/>display name and category"]\n    D --\x3e E["5. Quiet hours check<br/>\u2192 queue or dispatch immediately"]\n    E --\x3e F["6. Dispatcher.Dispatch<br/>\u2192 same retry/DLQ pipeline<br/>as engine path"]'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.h3,{id:"alert-rule-fields-entalertrule",children:["Alert Rule Fields (",(0,s.jsx)(n.code,{children:"ent.AlertRule"}),")"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Field"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ID"})}),(0,s.jsx)(n.td,{children:"string (ULID)"}),(0,s.jsx)(n.td,{children:"Unique rule identifier"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Name"})}),(0,s.jsx)(n.td,{children:"string"}),(0,s.jsx)(n.td,{children:"Human-readable rule name"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Description"})}),(0,s.jsx)(n.td,{children:"string"}),(0,s.jsx)(n.td,{children:"Used as notification message if set"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"EventType"})}),(0,s.jsx)(n.td,{children:"string"}),(0,s.jsxs)(n.td,{children:["Exact event type string to match (e.g. ",(0,s.jsx)(n.code,{children:'"service.failed"'}),")"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Conditions"})}),(0,s.jsx)(n.td,{children:"JSON"}),(0,s.jsxs)(n.td,{children:["Array of ",(0,s.jsx)(n.code,{children:"{field, operator, value}"})," condition objects"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Enabled"})}),(0,s.jsx)(n.td,{children:"bool"}),(0,s.jsx)(n.td,{children:"Only enabled rules are loaded into cache"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Severity"})}),(0,s.jsx)(n.td,{children:"string"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:'"CRITICAL"'}),", ",(0,s.jsx)(n.code,{children:'"WARNING"'}),", ",(0,s.jsx)(n.code,{children:'"INFO"'})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ThrottleWindow"})}),(0,s.jsx)(n.td,{children:"duration"}),(0,s.jsx)(n.td,{children:"Minimum time between firings of this rule"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"QuietHours"})}),(0,s.jsx)(n.td,{children:"JSON"}),(0,s.jsx)(n.td,{children:"Time-of-day window(s) when notifications are suppressed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"EscalationPolicy"})}),(0,s.jsx)(n.td,{children:"JSON"}),(0,s.jsx)(n.td,{children:"Escalation chain configuration"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ChannelIDs"})}),(0,s.jsx)(n.td,{children:"[]string"}),(0,s.jsx)(n.td,{children:"Which notification channels receive this alert"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"storm-detector-configuration",children:"Storm Detector Configuration"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"DefaultStormConfig()"})," returns:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ThresholdRate"})}),(0,s.jsx)(n.td,{children:"100 events/min"}),(0,s.jsx)(n.td,{children:"Global rate above which all alerts are suppressed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CooldownPeriod"})}),(0,s.jsx)(n.td,{children:"60 seconds"}),(0,s.jsx)(n.td,{children:"How long suppression continues after storm clears"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WindowSize"})}),(0,s.jsx)(n.td,{children:"60 seconds"}),(0,s.jsx)(n.td,{children:"Sliding window for rate calculation"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Configurable via ",(0,s.jsx)(n.code,{children:"NewStormDetector(config StormConfig, clock Clock)"}),". The ",(0,s.jsx)(n.code,{children:"Clock"})," interface allows injection of a test clock."]}),"\n",(0,s.jsx)(n.h3,{id:"notification-channel-configuration-examples",children:"Notification Channel Configuration Examples"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Email (SMTP)"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "smtp_host": "smtp.example.com",\n  "smtp_port": 587,\n  "username": "alerts@example.com",\n  "password": "...",\n  "from_address": "alerts@example.com",\n  "from_name": "NasNet Alerts",\n  "use_tls": false,\n  "to_addresses": ["admin@example.com"]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Telegram"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "bot_token": "123456:ABC-DEF",\n  "chat_ids": ["-1001234567890", "987654321"]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"ntfy"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "server_url": "https://ntfy.example.com",\n  "topic": "nasnet-alerts",\n  "token": "tk_optional_bearer_token"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Webhook"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "url": "https://hooks.example.com/nasnet",\n  "secret": "hmac-signing-secret",\n  "method": "POST",\n  "headers": {"X-Source": "nasnet"}\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pushover"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "user_key": "uXXXXX",\n  "api_token": "aXXXXX"\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Scenario"}),(0,s.jsx)(n.th,{children:"Behaviour"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Storm detector threshold exceeded"}),(0,s.jsx)(n.td,{children:"All matching rules suppressed; suppression count tracked; logged at WARN"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ThrottleManager blocks rule"}),(0,s.jsx)(n.td,{children:"Rule suppressed; suppression count tracked per rule ID"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Quiet hours active"}),(0,s.jsx)(n.td,{children:"Alert persisted to DB; queued in AlertQueue; delivered as digest when quiet hours end"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:["Channel ",(0,s.jsx)(n.code,{children:"Send"})," returns error"]}),(0,s.jsx)(n.td,{children:"Retry up to 3 times with exponential backoff (1s, 2s, 4s)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:["Error matches ",(0,s.jsx)(n.code,{children:"isRetryable=false"})]}),(0,s.jsx)(n.td,{children:"No retry; goes directly to dead-letter queue"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"All retries exhausted"}),(0,s.jsxs)(n.td,{children:["Appended to ",(0,s.jsx)(n.code,{children:"Dispatcher.deadLetterQueue"})," with attempt count and last error"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Event payload unmarshal failure"}),(0,s.jsxs)(n.td,{children:["Logged at WARN; ",(0,s.jsx)(n.code,{children:"eventData"})," set to empty map; evaluation continues"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Rule cache miss (rule deleted after cache load)"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"getRuleByID"})," falls back to DB query"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"createDefaultRulesIfNeeded"})," DB error"]}),(0,s.jsx)(n.td,{children:"Logged at WARN; bridge continues processing; no rules created"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Quiet hours queue full (>100 notifications per channel)"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Enqueue"})," returns error; notification silently dropped at bridge; logged"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Notification TTL exceeded (>24h in quiet hours queue)"}),(0,s.jsx)(n.td,{children:"Purged by background worker; never delivered"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Escalation engine nil"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"createAlert"})," skips escalation tracking; notification still dispatched"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"In-app event bus nil"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"InAppChannel.Send"})," returns error immediately (not retried as configuration error)"]})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsx)(n.p,{children:"The alert system has several testable seams:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Engine with mock event bus:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"bus := events.NewTestBus()\nengine := alerts.NewEngine(alerts.EngineConfig{\n    DB:       testDB,\n    EventBus: bus,\n    Logger:   zaptest.NewLogger(t).Sugar(),\n})\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Deterministic storm detection:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"clock := &MockClock{now: time.Now()}\ndetector := alerts.NewStormDetector(alerts.StormConfig{\n    ThresholdRate:  10,\n    CooldownPeriod: 5 * time.Second,\n    WindowSize:     10 * time.Second,\n}, clock)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Channel delivery verification:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type mockChannel struct {\n    received []notifications.Notification\n}\nfunc (m *mockChannel) Send(ctx context.Context, n notifications.Notification) error {\n    m.received = append(m.received, n)\n    return nil\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Quiet hours queue flushing:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"manager.FlushAll(ctx) // delivers all queued notifications immediately\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Dead-letter queue inspection:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'failed := dispatcher.GetDeadLetterQueue()\nassert.Len(t, failed, 1)\nassert.Equal(t, "email", failed[0].ChannelName)\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Service bridge default rules:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// Trigger service.started event and verify 8 rules were created\nbus.Publish(ctx, events.NewServiceEvent("service.started", instance))\nrules := db.AlertRule.Query().Where(alertrule.ServiceType(instance.ServiceType)).AllX(ctx)\nassert.Len(t, rules, 8)\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Topic"}),(0,s.jsx)(n.th,{children:"Document"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Event bus and event types"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"event-system.md"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"GraphQL alert subscriptions"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"graphql-api.md"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Service orchestrator (emits service.* events)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"service-orchestrator.md"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Provisioning engine"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"provisioning-engine.md"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Database schema (AlertRule, AlertLog)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"data-layer.md"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Bootstrap wiring (alert engine startup)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"application-bootstrap.md"})})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>c});var i=r(14041);const s={},t=i.createContext(s);function d(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);