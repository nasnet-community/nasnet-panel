"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[89506],{50965:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"security","title":"Security","description":"Multi-layer security model: JWT RS256 authentication, bcrypt+NIST password policy, AES-256-GCM credential encryption, GraphQL directive-based authorization, and sensitive field redaction throughout.","source":"@site/../backend/docs/security.md","sourceDirName":".","slug":"/security","permalink":"/docs/backend/security","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/security.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Router Services","permalink":"/docs/backend/router-services"},"next":{"title":"Service Orchestrator","permalink":"/docs/backend/service-orchestrator"}}');var t=r(31085),i=r(71184);const o={},c="Security",d={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"internal/auth",id:"internalauth",level:3},{value:"jwt.go - JWT Token Management",id:"jwtgo---jwt-token-management",level:4},{value:"password.go - Password Hashing and Policy",id:"passwordgo---password-hashing-and-policy",level:4},{value:"service.go - Auth Service Orchestration",id:"servicego---auth-service-orchestration",level:4},{value:"repository.go - Auth Repository",id:"repositorygo---auth-repository",level:4},{value:"internal/credentials",id:"internalcredentials",level:3},{value:"service.go - Credential Management",id:"servicego---credential-management",level:4},{value:"hooks.go - ent Mutation Hooks",id:"hooksgo---ent-mutation-hooks",level:4},{value:"internal/middleware",id:"internalmiddleware",level:3},{value:"auth.go - Auth Middleware Chain",id:"authgo---auth-middleware-chain",level:4},{value:"request_id.go - Request Correlation",id:"request_idgo---request-correlation",level:4},{value:"internal/graphql/directives",id:"internalgraphqldirectives",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Login Flow",id:"login-flow",level:3},{value:"Authenticated Request Flow",id:"authenticated-request-flow",level:3},{value:"Credential Encryption Flow",id:"credential-encryption-flow",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Security Invariants",id:"security-invariants",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"security",children:"Security"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Multi-layer security model: JWT RS256 authentication, bcrypt+NIST password policy, AES-256-GCM credential encryption, GraphQL directive-based authorization, and sensitive field redaction throughout."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Packages:"})," ",(0,t.jsx)(n.code,{children:"internal/auth/"}),", ",(0,t.jsx)(n.code,{children:"internal/credentials/"}),", ",(0,t.jsx)(n.code,{children:"internal/middleware/"}),", ",(0,t.jsx)(n.code,{children:"internal/graphql/directives/"}),"\n",(0,t.jsx)(n.strong,{children:"Key Files:"})," ",(0,t.jsx)(n.code,{children:"auth/jwt.go"}),", ",(0,t.jsx)(n.code,{children:"auth/password.go"}),", ",(0,t.jsx)(n.code,{children:"auth/service.go"}),", ",(0,t.jsx)(n.code,{children:"credentials/service.go"}),", ",(0,t.jsx)(n.code,{children:"credentials/hooks.go"}),", ",(0,t.jsx)(n.code,{children:"middleware/auth.go"}),", ",(0,t.jsx)(n.code,{children:"internal/graphql/directives/directives.go"}),"\n",(0,t.jsx)(n.strong,{children:"Prerequisites:"})," [See: 02-application-bootstrap.md \xa7Auth Bootstrap], [See: 03-graphql-api.md \xa7Directives]"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"NasNet uses a defense-in-depth security model with four distinct layers:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Layer 1: HTTP Middleware (auth.go)\n         Extracts and validates JWT \u2192 populates context\n              |\nLayer 2: GraphQL Directives (directives.go)\n         @auth, @validate, @capability, @sensitive\n              |\nLayer 3: Service Layer (auth/service.go)\n         Login, session management, password policy, audit logging\n              |\nLayer 4: Storage Layer (credentials/service.go + hooks.go)\n         AES-256-GCM encryption at rest for router credentials\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Client \u2192 Echo HTTP Server\n             |\n        [RequestIDMiddleware]   \u2190 Adds ULID request ID to context\n             |\n        [ProductionModeMiddleware] \u2190 Sets production mode flag\n             |\n        [AuthMiddleware]       \u2190 Extracts JWT from Bearer / Cookie / API Key\n             |                     Validates token + session\n             |                     Populates context: AuthUser, Claims, SessionInfo\n             v\n        GraphQL Handler\n             |\n        [@auth directive]      \u2190 Blocks unauthenticated or unauthorized fields\n        [@validate directive]  \u2190 Validates field values\n        [@capability directive]\u2190 Checks router capabilities\n        [@sensitive directive] \u2190 Marks fields for redaction\n             |\n             v\n        Resolver Methods\n             |\n        Auth Service           \u2190 Login, logout, session validation\n        Credential Service     \u2190 Encrypt/decrypt router credentials\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,t.jsx)(n.h3,{id:"internalauth",children:"internal/auth"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Package:"})," ",(0,t.jsx)(n.code,{children:"internal/auth/"})]}),"\n",(0,t.jsx)(n.h4,{id:"jwtgo---jwt-token-management",children:"jwt.go - JWT Token Management"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Algorithm:"})," RS256 (RSA + SHA256) - asymmetric key signing. Private key signs tokens; public key validates them. The private key is never exposed to clients."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Types:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// Roles (hierarchical)\ntype Role string\nconst (\n    RoleAdmin    Role = "admin"    // All permissions\n    RoleOperator Role = "operator" // All except admin-only operations\n    RoleViewer   Role = "viewer"   // Read-only\n)\n\nfunc (r Role) HasPermission(required Role) bool\nfunc (r Role) IsValid() bool\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Claims:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type Claims struct {\n    jwt.RegisteredClaims              // id, iss, sub, iat, exp, nbf\n    UserID    string `json:"uid"`     // User ULID\n    Username  string `json:"username"`\n    Role      string `json:"role"`    // "admin" | "operator" | "viewer"\n    SessionID string `json:"sid"`     // Session ULID (for server-side revocation)\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"JWTConfig:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type JWTConfig struct {\n    PrivateKey       *rsa.PrivateKey\n    PublicKey        *rsa.PublicKey\n    TokenDuration    time.Duration  // Default: 1 hour\n    SessionDuration  time.Duration  // Default: 7 days (maximum session age)\n    SlideThreshold   time.Duration  // Default: 30 minutes (refresh window)\n    Issuer           string         // Default: "nasnetconnect"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"JWTService:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type JWTService struct { config JWTConfig }\n\nfunc NewJWTService(config JWTConfig) (*JWTService, error)\nfunc NewJWTServiceFromEnv() (*JWTService, error)\n\nfunc (s *JWTService) GenerateToken(input TokenInput) (string, time.Time, error)\nfunc (s *JWTService) ValidateToken(tokenString string) (*Claims, error)\nfunc (s *JWTService) ShouldRefresh(claims *Claims) bool\nfunc (s *JWTService) RefreshToken(claims *Claims, sessionCreatedAt time.Time) (string, time.Time, error)\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Sliding Sessions:"})," If fewer than ",(0,t.jsx)(n.code,{children:"SlideThreshold"})," remain until token expiry, the middleware automatically issues a new token. If the new token would exceed ",(0,t.jsx)(n.code,{children:"SessionDuration"}),", it is capped at the session maximum. After ",(0,t.jsx)(n.code,{children:"SessionDuration"})," total, the user must log in again."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Loading from Environment:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'JWT_PRIVATE_KEY      or  JWT_PRIVATE_KEY_PATH\nJWT_PUBLIC_KEY       or  JWT_PUBLIC_KEY_PATH\nJWT_TOKEN_DURATION   (optional, e.g., "1h")\nJWT_SESSION_DURATION (optional, e.g., "168h")\nJWT_SLIDE_THRESHOLD  (optional, e.g., "30m")\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Both PKCS#8 and PKCS#1 formats are accepted. Escaped newlines (",(0,t.jsx)(n.code,{children:"\\n"}),") in env var values are handled automatically."]}),"\n",(0,t.jsx)(n.p,{children:"For development only:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func GenerateKeyPair() (*rsa.PrivateKey, *rsa.PublicKey, error) // 2048-bit RSA\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Error Codes:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'ErrCodeInvalidCredentials = "AUTH.INVALID_CREDENTIALS"\nErrCodeSessionExpired     = "AUTH.SESSION_EXPIRED"\nErrCodeTokenInvalid       = "AUTH.TOKEN_INVALID"\nErrCodeTokenExpired       = "AUTH.TOKEN_EXPIRED"\nErrCodeInsufficientRole   = "AUTH.INSUFFICIENT_ROLE"\nErrCodeRateLimited        = "AUTH.RATE_LIMITED"\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h4,{id:"passwordgo---password-hashing-and-policy",children:"password.go - Password Hashing and Policy"}),"\n",(0,t.jsxs)(n.p,{children:["Implements ",(0,t.jsx)(n.a,{href:"https://pages.nist.gov/800-63-3/sp800-63b.html",children:"NIST SP 800-63B"})," password guidelines:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Minimum 8 characters, maximum 128 characters"}),"\n",(0,t.jsx)(n.li,{children:"No mandatory complexity rules (no forced uppercase/symbols)"}),"\n",(0,t.jsx)(n.li,{children:"Check against common/breached password list"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type PasswordPolicy struct {\n    MinLength       int  // Default: 8\n    MaxLength       int  // Default: 128\n    CheckCommonList bool // Default: true\n}\n\ntype PasswordService struct {\n    policy          PasswordPolicy\n    bcryptCost      int             // Default: 10 (~100ms per hash)\n    commonPasswords map[string]struct{}\n}\n\nfunc NewPasswordService(policy PasswordPolicy) *PasswordService\nfunc NewDefaultPasswordService() *PasswordService\n\nfunc (ps *PasswordService) ValidatePassword(password string) error\nfunc (ps *PasswordService) HashPassword(password string) (string, error)\nfunc (ps *PasswordService) VerifyPassword(hash, password string) bool\nfunc (ps *PasswordService) ChangePassword(currentHash, currentPassword, newPassword string) (string, error)\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"bcrypt:"})," Cost factor 10, equivalent to ~100ms per hash. Includes automatic salt. ",(0,t.jsx)(n.code,{children:"VerifyPassword"})," uses ",(0,t.jsx)(n.code,{children:"bcrypt.CompareHashAndPassword"})," which is timing-safe by design."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Common password list:"})," Loaded from embedded ",(0,t.jsx)(n.code,{children:"common_passwords.txt"}),". Falls back to a built-in list of ~40 passwords including domain-specific entries (",(0,t.jsx)(n.code,{children:"nasnet"}),", ",(0,t.jsx)(n.code,{children:"mikrotik"}),", ",(0,t.jsx)(n.code,{children:"router"}),"). Comparison is case-insensitive."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Password error codes:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'ErrCodePasswordTooShort = "AUTH.PASSWORD_TOO_SHORT"\nErrCodePasswordTooLong  = "AUTH.PASSWORD_TOO_LONG"\nErrCodePasswordCommon   = "AUTH.PASSWORD_COMMON"\nErrCodePasswordMismatch = "AUTH.PASSWORD_MISMATCH"\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h4,{id:"servicego---auth-service-orchestration",children:"service.go - Auth Service Orchestration"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Service"})," coordinates login, session management, password changes, and audit logging."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type Service struct {\n    jwt      *JWTService\n    password *PasswordService\n    users    UserRepository\n    sessions SessionRepository\n    audit    AuditLogger\n    logger   *zap.Logger\n}\n\nfunc NewService(config Config) (*Service, error)\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"UserRepository interface:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type UserRepository interface {\n    GetByID(ctx context.Context, id string) (*User, error)\n    GetByUsername(ctx context.Context, username string) (*User, error)\n    Create(ctx context.Context, user *User) error\n    Update(ctx context.Context, user *User) error\n    UpdateLastLogin(ctx context.Context, userID string, loginTime time.Time) error\n    UpdatePassword(ctx context.Context, userID string, passwordHash string) error\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"SessionRepository interface:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type SessionRepository interface {\n    GetByID(ctx context.Context, id string) (*Session, error)\n    GetByTokenID(ctx context.Context, tokenID string) (*Session, error)\n    Create(ctx context.Context, session *Session) error\n    UpdateLastActivity(ctx context.Context, sessionID string, activityTime time.Time) error\n    Revoke(ctx context.Context, sessionID string, reason string) error\n    RevokeAllForUser(ctx context.Context, userID string, reason string) error\n    RevokeAllForUserExcept(ctx context.Context, userID string, exceptSessionID string, reason string) error\n    GetActiveForUser(ctx context.Context, userID string) ([]*Session, error)\n    CleanExpired(ctx context.Context) (int, error)\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"AuditLogger interface:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type AuditLogger interface {\n    Log(ctx context.Context, event AuditEvent) error\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Service Methods:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Login authenticates user, creates session, returns JWT\nfunc (s *Service) Login(ctx context.Context, input LoginInput) (*LoginResult, error)\n\n// Logout revokes a session\nfunc (s *Service) Logout(ctx context.Context, sessionID, ip, userAgent string) error\n\n// ValidateSession checks session is active (not revoked/expired)\nfunc (s *Service) ValidateSession(ctx context.Context, sessionID string) (*Session, error)\n\n// ChangePassword validates current password, hashes new password, revokes other sessions\nfunc (s *Service) ChangePassword(ctx context.Context, input ChangePasswordInput) error\n\n// RevokeAllSessions admin operation to revoke all sessions for a user\nfunc (s *Service) RevokeAllSessions(ctx context.Context, targetUserID, adminID, ip, userAgent string) error\n\n// GetUserSessions returns all active sessions for a user\nfunc (s *Service) GetUserSessions(ctx context.Context, userID string) ([]*Session, error)\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Login Security Properties:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:'User existence is never revealed (same error for "user not found" and "wrong password")'}),"\n",(0,t.jsx)(n.li,{children:"Inactive accounts are rejected with the same generic error"}),"\n",(0,t.jsx)(n.li,{children:"Audit events are logged for all attempts (success and failure) with specific reason codes"}),"\n",(0,t.jsxs)(n.li,{children:["Failed audit: ",(0,t.jsx)(n.code,{children:'reason: "user_not_found" | "user_inactive" | "invalid_password"'})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Password Change:"})," When a user changes their password, all other active sessions are revoked automatically (",(0,t.jsx)(n.code,{children:"RevokeAllForUserExcept"}),"). This prevents session hijacking after credential compromise."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Sensitive field redaction:"})," The ",(0,t.jsx)(n.code,{children:"logAuditEvent"})," method always calls ",(0,t.jsx)(n.code,{children:"redactSensitiveFields()"})," before logging. Keys like ",(0,t.jsx)(n.code,{children:"password"}),", ",(0,t.jsx)(n.code,{children:"token"}),", ",(0,t.jsx)(n.code,{children:"secret"}),", ",(0,t.jsx)(n.code,{children:"api_key"}),", ",(0,t.jsx)(n.code,{children:"bearer"}),", ",(0,t.jsx)(n.code,{children:"key"})," are replaced with ",(0,t.jsx)(n.code,{children:'"[REDACTED]"'}),"."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h4,{id:"repositorygo---auth-repository",children:"repository.go - Auth Repository"}),"\n",(0,t.jsxs)(n.p,{children:["Provides ",(0,t.jsx)(n.code,{children:"EntUserRepository"})," and ",(0,t.jsx)(n.code,{children:"EntSessionRepository"})," backed by the ent ORM. See [See: 11-data-layer.md \xa7Auth Tables]."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalcredentials",children:"internal/credentials"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Package:"})," ",(0,t.jsx)(n.code,{children:"internal/credentials/"})]}),"\n",(0,t.jsx)(n.p,{children:"Router credentials (username + password for MikroTik API access) are stored AES-256-GCM encrypted. The plaintext password is never stored and never logged."}),"\n",(0,t.jsx)(n.h4,{id:"servicego---credential-management",children:"service.go - Credential Management"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// Credentials contains decrypted values - handle with extreme care\ntype Credentials struct {\n    Username    string\n    Password    string  // NEVER log or serialize\n    KeyVersion  int\n    LastUpdated time.Time\n}\n\n// CredentialInfo is safe for API responses - no plaintext password\ntype CredentialInfo struct {\n    RouterID         string    `json:"routerId"`\n    Username         string    `json:"username"`\n    HasPassword      bool      `json:"hasPassword"`\n    EncryptionStatus string    `json:"encryptionStatus"` // "AES-256-GCM"\n    KeyVersion       int       `json:"keyVersion"`\n    LastUpdated      time.Time `json:"lastUpdated"`\n    CreatedAt        time.Time `json:"createdAt"`\n}\n\ntype Service struct {\n    encService *encryption.Service\n}\n\nfunc NewService(encService *encryption.Service) (*Service, error)\nfunc NewServiceFromEnv() (*Service, error)  // reads DB_ENCRYPTION_KEY env var\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key Methods:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Create encrypts and stores new credentials for a router\nfunc (s *Service) Create(ctx context.Context, client *ent.Client, routerID string, input UpdateInput) (*ent.RouterSecret, error)\n\n// Update re-encrypts and updates existing credentials\nfunc (s *Service) Update(ctx context.Context, client *ent.Client, routerID string, input UpdateInput) (*ent.RouterSecret, error)\n\n// Get decrypts and returns credentials (use immediately, do not cache)\nfunc (s *Service) Get(ctx context.Context, client *ent.Client, routerID string) (*Credentials, error)\n\n// GetInfo returns metadata only - safe for API responses and logs\nfunc (s *Service) GetInfo(ctx context.Context, client *ent.Client, routerID string) (*CredentialInfo, error)\n\n// Delete removes credentials for a router\nfunc (s *Service) Delete(ctx context.Context, client *ent.Client, routerID string) error\n\n// Exists checks if credentials exist without decrypting\nfunc (s *Service) Exists(ctx context.Context, client *ent.Client, routerID string) (bool, error)\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Safe Handling Helpers:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'// Returns map with password replaced by "[REDACTED]" - for logging\nfunc SanitizeForLog(creds *Credentials) map[string]interface{}\n\n// Overwrites password field in memory with empty string\nfunc ZeroCredentials(creds *Credentials)\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Usage pattern:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"creds, err := credSvc.Get(ctx, db, routerID)\nif err != nil { return err }\ndefer credentials.ZeroCredentials(creds) // Always clear when done\n\n// Use creds.Username and creds.Password immediately\nconn, err := connectToRouter(creds.Username, creds.Password)\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h4,{id:"hooksgo---ent-mutation-hooks",children:"hooks.go - ent Mutation Hooks"}),"\n",(0,t.jsxs)(n.p,{children:["Automatically encrypts credentials on every ",(0,t.jsx)(n.code,{children:"RouterSecret"})," mutation (Create, Update):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func RegisterHooks(client *ent.Client, encService *encryption.Service) error\n"})}),"\n",(0,t.jsx)(n.p,{children:"Called once during bootstrap. The hook:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Intercepts ",(0,t.jsx)(n.code,{children:"EncryptedUsername"})," and ",(0,t.jsx)(n.code,{children:"EncryptedPassword"})," fields on ",(0,t.jsx)(n.code,{children:"RouterSecretMutation"})]}),"\n",(0,t.jsxs)(n.li,{children:["Checks ",(0,t.jsx)(n.code,{children:"isEncrypted()"})," (heuristic: base64 check, length \u2265 40) to prevent double-encryption"]}),"\n",(0,t.jsxs)(n.li,{children:["Calls ",(0,t.jsx)(n.code,{children:"encService.Encrypt()"})," and sets the encrypted value back on the mutation"]}),"\n",(0,t.jsxs)(n.li,{children:["Sets ",(0,t.jsx)(n.code,{children:"KeyVersion"})," for future key rotation support"]}),"\n",(0,t.jsxs)(n.li,{children:["Calls ",(0,t.jsx)(n.code,{children:"next.Mutate()"})," to continue the chain"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Environment:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"DB_ENCRYPTION_KEY  - AES-256-GCM encryption key (32 bytes, base64 encoded)\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalmiddleware",children:"internal/middleware"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Package:"})," ",(0,t.jsx)(n.code,{children:"internal/middleware/"})]}),"\n",(0,t.jsx)(n.h4,{id:"authgo---auth-middleware-chain",children:"auth.go - Auth Middleware Chain"}),"\n",(0,t.jsx)(n.p,{children:"The auth middleware supports three authentication methods tried in order:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"1. JWT Bearer Token  (Authorization: Bearer <token>)\n2. Session Cookie    (HttpOnly cookie: access_token=<token>)\n3. API Key           (X-API-Key: <key>)\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type AuthMiddlewareConfig struct {\n    JWTService       *auth.JWTService\n    SessionValidator func(ctx context.Context, sessionID string) (*SessionInfo, error)\n    APIKeyValidator  func(ctx context.Context, apiKey string) (*AuthUser, error)\n    OnTokenRefresh   func(ctx context.Context, claims *auth.Claims, newToken string, expiresAt time.Time)\n    Skipper          func(c echo.Context) bool\n    CookieSecure     bool            // Default: true\n    CookieSameSite   http.SameSite   // Default: SameSiteStrictMode\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Skipped routes"})," (no auth required): ",(0,t.jsx)(n.code,{children:"/health"}),", ",(0,t.jsx)(n.code,{children:"/ready"}),", ",(0,t.jsx)(n.code,{children:"/playground"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Context keys"})," set after successful authentication:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'const (\n    UserContextKey       contextKey = "auth_user"    // *AuthUser\n    ClaimsContextKey     contextKey = "auth_claims"  // *auth.Claims\n    AuthMethodContextKey contextKey = "auth_method"  // AuthMethod\n    SessionContextKey    contextKey = "auth_session" // *SessionInfo\n)\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Context extraction helpers:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func UserFromContext(ctx context.Context) *AuthUser\nfunc ClaimsFromContext(ctx context.Context) *auth.Claims\nfunc AuthMethodFromContext(ctx context.Context) AuthMethod\nfunc SessionFromContext(ctx context.Context) *SessionInfo\nfunc IsAuthenticated(ctx context.Context) bool\nfunc HasRole(ctx context.Context, required auth.Role) bool\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Role enforcement middleware:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func AuthRequiredMiddleware() echo.MiddlewareFunc\nfunc RoleRequiredMiddleware(requiredRole auth.Role) echo.MiddlewareFunc\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cookie security:"})," All auth cookies are set with:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"HttpOnly: true"})," - prevents JavaScript access (XSS protection)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Secure: true"})," (production) - HTTPS only"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"SameSite: Strict"})," - CSRF protection"]}),"\n",(0,t.jsxs)(n.li,{children:["Cookie names: ",(0,t.jsx)(n.code,{children:"access_token"}),", ",(0,t.jsx)(n.code,{children:"refresh_token"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Sliding session refresh:"})," After successful JWT validation, if ",(0,t.jsx)(n.code,{children:"JWTService.ShouldRefresh()"})," returns true, a new token is issued and set as the cookie automatically. The ",(0,t.jsx)(n.code,{children:"OnTokenRefresh"})," callback is invoked if configured."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h4,{id:"request_idgo---request-correlation",children:"request_id.go - Request Correlation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'const RequestIDHeader = "X-Request-ID"\n\nfunc GenerateRequestID() string  // ULID-based, time-sortable\nfunc RequestIDMiddleware(next http.Handler) http.Handler\nfunc RequestIDFromContext(ctx context.Context) string\nfunc WithRequestID(ctx context.Context, requestID string) context.Context\n'})}),"\n",(0,t.jsx)(n.p,{children:"The middleware:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Checks for an existing ",(0,t.jsx)(n.code,{children:"X-Request-ID"})," header (from upstream proxies/clients)"]}),"\n",(0,t.jsx)(n.li,{children:"Generates a new ULID-based ID if not present"}),"\n",(0,t.jsxs)(n.li,{children:["Sets ",(0,t.jsx)(n.code,{children:"X-Request-ID"})," in the response header"]}),"\n",(0,t.jsx)(n.li,{children:"Adds the ID to the request context"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Request IDs appear in:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["All GraphQL error ",(0,t.jsx)(n.code,{children:"extensions.requestId"})]}),"\n",(0,t.jsx)(n.li,{children:"All audit log entries"}),"\n",(0,t.jsx)(n.li,{children:"All structured log output"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"ProductionModeMiddleware:"})," Sets a production mode flag in context, used by error presenters to suppress verbose error details:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func ProductionModeMiddleware(production bool) func(http.Handler) http.Handler\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"internalgraphqldirectives",children:"internal/graphql/directives"}),"\n",(0,t.jsx)(n.p,{children:"Directive-based security at the GraphQL field level. See [See: 03-graphql-api.md \xa7Directives] for full details."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Security-relevant directives:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Directive"}),(0,t.jsx)(n.th,{children:"Security function"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:'@auth(requires: "role")'})}),(0,t.jsx)(n.td,{children:"Blocks unauthenticated requests; enforces RBAC"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"@sensitive"})}),(0,t.jsx)(n.td,{children:"Marks fields for log redaction; errors redact values"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"@capability"})}),(0,t.jsx)(n.td,{children:"Blocks operations the router hardware cannot support"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"@validate"})}),(0,t.jsx)(n.td,{children:"Prevents injection via invalid format inputs"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Error codes returned by directives:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Code"}),(0,t.jsx)(n.th,{children:"Directive"}),(0,t.jsx)(n.th,{children:"Meaning"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"V400"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"@validate"})}),(0,t.jsx)(n.td,{children:"Field value failed validation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"A401"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"@auth"})}),(0,t.jsx)(n.td,{children:"Not authenticated or insufficient role"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"C403"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"@capability"})}),(0,t.jsx)(n.td,{children:"Router lacks required capability"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["All errors include ",(0,t.jsx)(n.code,{children:"requestId"})," from context for correlation with server logs."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,t.jsx)(n.h3,{id:"login-flow",children:"Login Flow"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'Client POST /login { username, password }\n    |\n    v\nAuthMiddleware skips (login endpoint is public)\n    |\n    v\nLogin resolver \u2192 auth.Service.Login()\n    |\n    +-- users.GetByUsername()\n    |        If not found: logAuditEvent(reason: "user_not_found")\n    |        Returns: ErrInvalidCredentials (same error, user existence not revealed)\n    |\n    +-- Check user.Active\n    |        If false: logAuditEvent(reason: "user_inactive")\n    |        Returns: ErrInvalidCredentials\n    |\n    +-- password.VerifyPassword(hash, input.Password)\n    |        If wrong: logAuditEvent(reason: "invalid_password")\n    |        Returns: ErrInvalidCredentials\n    |\n    +-- sessions.Create(session)     \u2190 new session with ULID\n    |\n    +-- jwt.GenerateToken(TokenInput) \u2190 RS256 signed JWT\n    |\n    +-- users.UpdateLastLogin()      \u2190 best-effort\n    |\n    +-- logAuditEvent("auth.login.success")\n    |\n    v\nLoginResult { Token, User, Session, ExpiresAt }\n    |\n    v\nMiddleware sets HttpOnly SameSite=Strict Secure cookie: access_token=<jwt>\n'})}),"\n",(0,t.jsx)(n.h3,{id:"authenticated-request-flow",children:"Authenticated Request Flow"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'Client sends request with Authorization: Bearer <jwt>\n    |\n    v\nRequestIDMiddleware adds ULID to context\n    |\n    v\nAuthMiddleware:\n    extractBearerToken() \u2192 jwt string\n    jwtService.ValidateToken(token) \u2192 *Claims\n    sessionValidator(claims.SessionID) \u2192 *SessionInfo (checks not revoked)\n    Populates context: AuthUser, Claims, SessionInfo\n    If ShouldRefresh() \u2192 issues new token + sets cookie\n    |\n    v\nGraphQL handler invoked\n    |\n    v\nFor each field with @auth directive:\n    GetAuthInfo(ctx) \u2192 AuthInfo\n    Check Authenticated = true\n    If requires != nil: check role in authInfo.Roles\n    If fails: return gqlerror with code "A401"\n    |\n    v\nResolver method called, accesses r.authService etc.\n'})}),"\n",(0,t.jsx)(n.h3,{id:"credential-encryption-flow",children:"Credential Encryption Flow"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"User submits router credentials { username, password }\n    |\n    v\ncredentials.Service.Create(ctx, db, routerID, {username, password})\n    |\n    v\nencService.Encrypt(username) \u2192 AES-256-GCM ciphertext (base64)\nencService.Encrypt(password) \u2192 AES-256-GCM ciphertext (base64)\n    |\n    v\ndb.RouterSecret.Create().\n    SetEncryptedUsername(encUsername).\n    SetEncryptedPassword(encPassword).\n    SetKeyVersion(version).\n    Save(ctx)\n\n[ent hook runs on every mutation - double-encryption prevented by isEncrypted() check]\n    |\n    v\nStored in DB: only encrypted bytes, never plaintext\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Environment Variable"}),(0,t.jsx)(n.th,{children:"Purpose"}),(0,t.jsx)(n.th,{children:"Required"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"JWT_PRIVATE_KEY"})," or ",(0,t.jsx)(n.code,{children:"JWT_PRIVATE_KEY_PATH"})]}),(0,t.jsx)(n.td,{children:"RSA private key for token signing"}),(0,t.jsx)(n.td,{children:"Yes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"JWT_PUBLIC_KEY"})," or ",(0,t.jsx)(n.code,{children:"JWT_PUBLIC_KEY_PATH"})]}),(0,t.jsx)(n.td,{children:"RSA public key for token validation"}),(0,t.jsx)(n.td,{children:"Yes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"JWT_TOKEN_DURATION"})}),(0,t.jsxs)(n.td,{children:["Token lifetime (default: ",(0,t.jsx)(n.code,{children:"1h"}),")"]}),(0,t.jsx)(n.td,{children:"No"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"JWT_SESSION_DURATION"})}),(0,t.jsxs)(n.td,{children:["Max session age (default: ",(0,t.jsx)(n.code,{children:"168h"}),")"]}),(0,t.jsx)(n.td,{children:"No"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"JWT_SLIDE_THRESHOLD"})}),(0,t.jsxs)(n.td,{children:["Refresh window (default: ",(0,t.jsx)(n.code,{children:"30m"}),")"]}),(0,t.jsx)(n.td,{children:"No"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DB_ENCRYPTION_KEY"})}),(0,t.jsx)(n.td,{children:"AES-256-GCM key for credential encryption (32 bytes, base64)"}),(0,t.jsx)(n.td,{children:"Yes"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,t.jsx)(n.p,{children:"All auth errors use structured error codes to allow client-side handling without message parsing:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error var"}),(0,t.jsx)(n.th,{children:"Code"}),(0,t.jsx)(n.th,{children:"HTTP Status"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ErrInvalidCredentials"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AUTH.INVALID_CREDENTIALS"})}),(0,t.jsx)(n.td,{children:"401"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ErrSessionExpired"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AUTH.SESSION_EXPIRED"})}),(0,t.jsx)(n.td,{children:"401"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ErrTokenInvalid"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AUTH.TOKEN_INVALID"})}),(0,t.jsx)(n.td,{children:"401"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ErrTokenExpired"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AUTH.TOKEN_EXPIRED"})}),(0,t.jsx)(n.td,{children:"401"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ErrInsufficientRole"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"AUTH.INSUFFICIENT_ROLE"})}),(0,t.jsx)(n.td,{children:"403"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["GraphQL directive errors include a ",(0,t.jsx)(n.code,{children:"docsUrl"})," field pointing to the API error documentation."]}),"\n",(0,t.jsxs)(n.p,{children:["In production mode (set by ",(0,t.jsx)(n.code,{children:"ProductionModeMiddleware"}),"), error details are suppressed and long string values in validation errors are truncated to 50 characters."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Auth service tests:"})," ",(0,t.jsx)(n.code,{children:"internal/auth/"})," - test login, logout, session validation, password change, role hierarchy."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Directive tests:"})," ",(0,t.jsx)(n.code,{children:"internal/graphql/directives/directives_test.go"})," - validate each directive with enabled and disabled config."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Middleware tests:"})," ",(0,t.jsx)(n.code,{children:"internal/middleware/request_id_test.go"})," - ULID generation, header propagation."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Pattern for auth testing:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'func TestLoginSuccess(t *testing.T) {\n    jwtSvc, _ := auth.NewJWTService(auth.JWTConfig{\n        PrivateKey: testPrivateKey,\n        PublicKey:  testPublicKey,\n    })\n    svc, _ := auth.NewService(auth.Config{\n        JWTService:        jwtSvc,\n        PasswordService:   auth.NewDefaultPasswordService(),\n        UserRepository:    &mockUserRepo{},\n        SessionRepository: &mockSessionRepo{},\n    })\n    result, err := svc.Login(ctx, auth.LoginInput{\n        Username: "admin",\n        Password: "correctpassword",\n        IP: "127.0.0.1",\n    })\n    require.NoError(t, err)\n    require.NotEmpty(t, result.Token)\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Credential encryption tests:"})," Create credentials, retrieve them, verify decrypted values match."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"security-invariants",children:"Security Invariants"}),"\n",(0,t.jsx)(n.p,{children:"These invariants must never be violated:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Passwords are never stored plaintext"})," - always bcrypt hashed before storage"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Router credentials are never stored plaintext"})," - always AES-256-GCM encrypted"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"JWT tokens use RS256"})," - asymmetric, private key never leaves the server"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Session IDs are in JWT claims"})," - enables server-side revocation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Login failures don't reveal user existence"})," - same error for all failure modes"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Sensitive field values are never logged"})," - ",(0,t.jsx)(n.code,{children:"redactSensitiveFields()"})," on all audit events"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Password change revokes all other sessions"})," - prevents post-compromise access"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Request IDs are in all errors"})," - for correlation without exposing internal details"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Credentials in memory are cleared after use"})," - ",(0,t.jsx)(n.code,{children:"ZeroCredentials()"})," called with ",(0,t.jsx)(n.code,{children:"defer"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"CredentialInfo"})," (not ",(0,t.jsx)(n.code,{children:"Credentials"}),") is used in API responses"]})," - password never serialized"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Event publishing for auth actions: [See: 05-event-system.md \xa7Publisher] (",(0,t.jsx)(n.code,{children:"PublishAuthLogin"}),", ",(0,t.jsx)(n.code,{children:"PublishAuthPasswordChanged"}),", ",(0,t.jsx)(n.code,{children:"PublishCredentialChanged"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"How auth service is wired at startup: [See: 02-application-bootstrap.md \xa7Auth Bootstrap]"}),"\n",(0,t.jsx)(n.li,{children:"GraphQL @auth directive details: [See: 03-graphql-api.md \xa7Directives]"}),"\n",(0,t.jsx)(n.li,{children:"ent schema for users/sessions: [See: 11-data-layer.md \xa7Auth Entities]"}),"\n",(0,t.jsxs)(n.li,{children:["Encryption service (AES-256-GCM): ",(0,t.jsx)(n.code,{children:"internal/encryption/service.go"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var s=r(14041);const t={},i=s.createContext(t);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);