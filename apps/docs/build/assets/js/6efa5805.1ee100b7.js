"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[1509],{6920:(e,n,d)=>{d.r(n),d.d(n,{assets:()=>t,contentTitle:()=>l,default:()=>a,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"build-and-deploy","title":"Build and Deploy","description":"Documents the multi-stage Docker build pipeline, binary compression, embedded frontend serving,","source":"@site/../backend/docs/build-and-deploy.md","sourceDirName":".","slug":"/build-and-deploy","permalink":"/docs/backend/build-and-deploy","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/build-and-deploy.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Application Bootstrap","permalink":"/docs/backend/application-bootstrap"},"next":{"title":"Config Generation","permalink":"/docs/backend/config-generation"}}');var r=d(31085),i=d(71184);const c={},l="Build and Deploy",t={},o=[{value:"Overview",id:"overview",level:2},{value:"Architecture / Diagram",id:"architecture--diagram",level:2},{value:"Stage 1: Frontend Build",id:"stage-1-frontend-build",level:2},{value:"Stage 2: hev-socks5-tunnel Download",id:"stage-2-hev-socks5-tunnel-download",level:2},{value:"Stage 3: Go Backend Build",id:"stage-3-go-backend-build",level:2},{value:"Stage 4: Production Runtime",id:"stage-4-production-runtime",level:2},{value:"Stage 5: Debug Runtime",id:"stage-5-debug-runtime",level:2},{value:"Multi-Arch Support",id:"multi-arch-support",level:2},{value:"Runtime Tuning",id:"runtime-tuning",level:2},{value:"Build Tags",id:"build-tags",level:2},{value:"Embedded Frontend Serving",id:"embedded-frontend-serving",level:2},{value:"Health Check CLI Flag",id:"health-check-cli-flag",level:2},{value:"Nx Build Targets",id:"nx-build-targets",level:2},{value:"Image Size Budget",id:"image-size-budget",level:2},{value:"Cross-References",id:"cross-references",level:2}];function h(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"build-and-deploy",children:"Build and Deploy"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Documents the multi-stage Docker build pipeline, binary compression, embedded frontend serving,\nruntime tuning, and health-check mechanism that produce the ",(0,r.jsx)(n.code,{children:"<10MB"})," NasNetConnect container image."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Packages:"})," ",(0,r.jsx)(n.code,{children:"cmd/nnc/"}),", ",(0,r.jsx)(n.code,{children:"internal/server/"}),", ",(0,r.jsx)(n.code,{children:"internal/bootstrap/"}),", ",(0,r.jsx)(n.code,{children:"internal/common/health/"})," ",(0,r.jsx)(n.strong,{children:"Key\nFiles:"})," ",(0,r.jsx)(n.code,{children:"Dockerfile"}),", ",(0,r.jsx)(n.code,{children:"cmd/nnc/main_prod.go"}),", ",(0,r.jsx)(n.code,{children:"internal/server/server.go"}),",\n",(0,r.jsx)(n.code,{children:"internal/server/static.go"}),", ",(0,r.jsx)(n.code,{children:"internal/bootstrap/config.go"}),", ",(0,r.jsx)(n.code,{children:"project.json"})," ",(0,r.jsx)(n.strong,{children:"Prerequisites:"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"[See: getting-started.md] \u2014 development environment setup"}),"\n",(0,r.jsx)(n.li,{children:"[See: application-bootstrap.md \xa7Runtime Configuration] \u2014 service initialization sequence"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["NasNetConnect ships as a ",(0,r.jsx)(n.strong,{children:"single Docker container that runs on the MikroTik router itself"}),". The\ntarget constraints are strict: image ",(0,r.jsx)(n.code,{children:"<10MB"})," compressed, runtime RAM ",(0,r.jsx)(n.code,{children:"<50MB"}),", cold start ",(0,r.jsx)(n.code,{children:"<5s"}),".\nAchieving these requires a coordinated 5-stage build pipeline that compiles the frontend,\ncross-compiles the Go binary for ARM/amd64, applies UPX compression, gzip-precompresses JS/CSS\nassets, and bundles everything into a minimal Alpine runtime image."]}),"\n",(0,r.jsxs)(n.p,{children:["The resulting ",(0,r.jsx)(n.code,{children:"/app"})," binary is a fully self-contained HTTP server that embeds the React frontend via\nGo's ",(0,r.jsx)(n.code,{children:"//go:embed"})," directive. No external web server, no Node.js runtime, no separate static file\nserver \u2014 one binary, one process."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"architecture--diagram",children:"Architecture / Diagram"}),"\n",(0,r.jsx)(n.mermaid,{value:'flowchart TD\n    A["Stage 1: frontend<br/>node:20-alpine, BUILDPLATFORM<br/>npm ci<br/>design tokens<br/>npx nx build connect"] --\x3e|COPY --from=frontend| B["Stage 2: hevdownloader<br/>alpine:3.21, BUILDPLATFORM<br/>curl hev-socks5-tunnel<br/>upx --best --lzma"]\n\n    B --\x3e|COPY --from=hevdownloader| C["Stage 3: gobuilder<br/>golang:1.26-alpine, BUILDPLATFORM<br/>go mod download<br/>COPY frontend dist/<br/>gzip -9 *.js *.css<br/>CGO_ENABLED=0 go build<br/>upx --best --lzma app"]\n\n    C --\x3e|COPY --from=gobuilder| D["Stage 4: production<br/>alpine:3.21, TARGETPLATFORM<br/>apk add iptables<br/>/app UPX-compressed<br/>/hev-socks5-tunnel<br/>ENV PORT=80 GOMAXPROCS=1"]\n\n    C --\x3e|COPY --from=gobuilder| E["Stage 5: debug<br/>alpine:3.21<br/>+ curl for debugging<br/>separate target"]\n\n    style A fill:#e1f5ff\n    style B fill:#f3e5f5\n    style C fill:#e8f5e9\n    style D fill:#fff3e0\n    style E fill:#fce4ec'}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"stage-1-frontend-build",children:"Stage 1: Frontend Build"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Base image:"})," ",(0,r.jsx)(n.code,{children:"node:20-alpine"})," with ",(0,r.jsx)(n.code,{children:"--platform=$BUILDPLATFORM"})," (always native for speed)."]}),"\n",(0,r.jsxs)(n.p,{children:["The entire Nx monorepo workspace is copied in, including ",(0,r.jsx)(n.code,{children:"apps/"}),", ",(0,r.jsx)(n.code,{children:"libs/"}),", and ",(0,r.jsx)(n.code,{children:"shared/"}),". Build\nsteps:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"npm ci --no-audit --no-fund --legacy-peer-deps"})," \u2014 reproducible install from lockfile"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"node libs/ui/tokens/build.js"})," \u2014 generates Tailwind CSS design tokens before Vite sees them"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"npx nx build connect"})," \u2014 Vite production build, outputs to ",(0,r.jsx)(n.code,{children:"dist/apps/connect/"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The compiled output (",(0,r.jsx)(n.code,{children:"dist/apps/connect/"}),") is passed forward to Stage 3 via ",(0,r.jsx)(n.code,{children:"COPY --from=frontend"}),"."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"stage-2-hev-socks5-tunnel-download",children:"Stage 2: hev-socks5-tunnel Download"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Base image:"})," ",(0,r.jsx)(n.code,{children:"alpine:3.21"})," with ",(0,r.jsx)(n.code,{children:"--platform=$BUILDPLATFORM"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Downloads the ",(0,r.jsx)(n.code,{children:"hev-socks5-tunnel"})," binary from GitHub releases. This binary provides the SOCKS-to-TUN\ngateway used by the NAS-8.14 VIF gateway feature (connects service SOCKS5 proxies to the router's\nTUN interface)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Multi-arch resolution:"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:(0,r.jsx)(n.code,{children:"$TARGETARCH"})}),(0,r.jsx)(n.th,{children:(0,r.jsx)(n.code,{children:"$TARGETVARIANT"})}),(0,r.jsx)(n.th,{children:"Downloaded binary suffix"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"amd64"})}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"x86_64"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"arm64"})}),(0,r.jsx)(n.td,{children:"\u2014"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"arm64"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"arm"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"v7"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"arm32hf"})})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["After download, UPX compression is applied (",(0,r.jsx)(n.code,{children:"upx --best --lzma"}),") saving ~2\u20133MB. The ",(0,r.jsx)(n.code,{children:"|| true"})," suffix\nprevents build failure on UPX errors (some ARM targets may be incompatible)."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"stage-3-go-backend-build",children:"Stage 3: Go Backend Build"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Base image:"})," ",(0,r.jsx)(n.code,{children:"golang:1.26-alpine"})," with ",(0,r.jsx)(n.code,{children:"--platform=$BUILDPLATFORM"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Dependency caching:"})," ",(0,r.jsx)(n.code,{children:"go.mod"})," / ",(0,r.jsx)(n.code,{children:"go.sum"})," are copied first, and ",(0,r.jsx)(n.code,{children:"go mod download"})," runs before the\nsource copy. Docker layer caching means dependencies are only re-downloaded when ",(0,r.jsx)(n.code,{children:"go.mod"})," changes."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Embedding the frontend:"})," The Vite output is copied into ",(0,r.jsx)(n.code,{children:"cmd/nnc/dist/"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"COPY --from=frontend /workspace/dist/apps/connect ./cmd/nnc/dist\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"//go:embed dist/**"})," directive in ",(0,r.jsx)(n.code,{children:"main_prod.go"})," bundles this directory into the binary at\ncompile time."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Asset pre-compression:"})," Before compilation, JS and CSS files are gzip-compressed at maximum\nlevel:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'find cmd/nnc/dist -type f \\( -name "*.js" -o -name "*.css" \\) -exec gzip -9 {} \\;\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"gzip"})," replaces originals (",(0,r.jsx)(n.code,{children:".js"})," \u2192 ",(0,r.jsx)(n.code,{children:".js.gz"}),"). The static file handler detects\n",(0,r.jsx)(n.code,{children:"Accept-Encoding: gzip"})," and serves the pre-compressed variant with ",(0,r.jsx)(n.code,{children:"Content-Encoding: gzip"}),". This\nyields 70\u201380% asset size reduction ",(0,r.jsx)(n.strong,{children:"inside"})," the binary."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Binary compilation:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"CGO_ENABLED=0 GOOS=$TARGETOS GOARCH=$TARGETARCH \\\n  go build -a \\\n  -ldflags=\"-w -s -extldflags '-static'\" \\\n  -tags=netgo \\\n  -trimpath \\\n  -o app ./cmd/nnc/\n"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Flag"}),(0,r.jsx)(n.th,{children:"Effect"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CGO_ENABLED=0"})}),(0,r.jsx)(n.td,{children:"No C dependencies, fully static binary"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'-ldflags="-w -s"'})}),(0,r.jsx)(n.td,{children:"Strip DWARF debug info and symbol table"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-extldflags '-static'"})}),(0,r.jsx)(n.td,{children:"Force static linking (no libc dependency)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-tags=netgo"})}),(0,r.jsx)(n.td,{children:"Use Go's pure-Go DNS resolver, no cgo"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-trimpath"})}),(0,r.jsx)(n.td,{children:"Remove absolute source paths from binary"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-a"})}),(0,r.jsx)(n.td,{children:"Force rebuild of all packages"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["For ",(0,r.jsx)(n.code,{children:"arm/v7"}),": ",(0,r.jsx)(n.code,{children:"GOARM"})," is set to the variant number: ",(0,r.jsx)(n.code,{children:"export GOARM=${TARGETVARIANT#v}"})," strips the ",(0,r.jsx)(n.code,{children:"v"}),"\nprefix."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"UPX compression:"})," After compilation, the binary is compressed:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"upx --best --lzma app || true\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"--best --lzma"})," achieves maximum compression (typically 3\u20135x reduction on Go binaries). The\n",(0,r.jsx)(n.code,{children:"|| true"})," prevents failure if UPX is unavailable for the target architecture."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"stage-4-production-runtime",children:"Stage 4: Production Runtime"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Base image:"})," ",(0,r.jsx)(n.code,{children:"alpine:3.21"})," (final ",(0,r.jsx)(n.code,{children:"$TARGETPLATFORM"}),")."]}),"\n",(0,r.jsx)(n.p,{children:"Runtime dependencies:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"iptables"})," \u2014 for NAT/firewall rules managed by the provisioning subsystem"]}),"\n",(0,r.jsxs)(n.li,{children:["BusyBox tools (",(0,r.jsx)(n.code,{children:"udhcpd"}),", ",(0,r.jsx)(n.code,{children:"udhcpc"}),", ",(0,r.jsx)(n.code,{children:"ip"}),") \u2014 already included in Alpine's BusyBox"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Only three files are copied from build stages:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/etc/ssl/certs/ca-certificates.crt"})," \u2014 from ",(0,r.jsx)(n.code,{children:"gobuilder"})," (needed for HTTPS to MikroTik REST API\nand registry downloads)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/workspace/apps/backend/app"})," \u2192 ",(0,r.jsx)(n.code,{children:"/app"})," \u2014 the UPX-compressed Go binary"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/tmp/hev-socks5-tunnel"})," \u2192 ",(0,r.jsx)(n.code,{children:"/hev-socks5-tunnel"})," \u2014 the tunnel gateway binary"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Environment variables:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"PORT=80           # HTTP listen port (overridable)\nGOMAXPROCS=1      # Single-threaded scheduler (router has 1 core)\nGO_ENV=production # Controls debug mode, logging format\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Docker HEALTHCHECK:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dockerfile",children:'HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \\\n  CMD ["/app", "-healthcheck"]\n'})}),"\n",(0,r.jsxs)(n.p,{children:["This calls the binary with the ",(0,r.jsx)(n.code,{children:"-healthcheck"})," flag, which performs an HTTP GET to\n",(0,r.jsx)(n.code,{children:"http://localhost:$PORT/health"})," and exits 0 on success or 1 on failure. [See: \xa7Health Check\nCLI Flag] below."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"stage-5-debug-runtime",children:"Stage 5: Debug Runtime"}),"\n",(0,r.jsxs)(n.p,{children:["Identical to Stage 4 but adds ",(0,r.jsx)(n.code,{children:"curl"})," for debugging. Built with ",(0,r.jsx)(n.code,{children:"--target=debug"})," in buildx:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"docker buildx build --target=debug ...\n"})}),"\n",(0,r.jsx)(n.p,{children:"Not used in production deployments."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"multi-arch-support",children:"Multi-Arch Support"}),"\n",(0,r.jsxs)(n.p,{children:["The build is parameterized with Docker BuildKit's ",(0,r.jsx)(n.code,{children:"--platform"})," argument:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"docker buildx build \\\n  --platform linux/amd64,linux/arm64,linux/arm/v7 \\\n  -f apps/backend/Dockerfile \\\n  --tag ghcr.io/$GHCR_REPOSITORY:latest \\\n  --push .\n"})}),"\n",(0,r.jsx)(n.p,{children:"Supported platforms:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Platform"}),(0,r.jsx)(n.th,{children:"MikroTik hardware"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"linux/amd64"})}),(0,r.jsx)(n.td,{children:"CHR (Cloud Hosted Router), x86"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"linux/arm64"})}),(0,r.jsx)(n.td,{children:"RB5009, CCR2004"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"linux/arm/v7"})}),(0,r.jsx)(n.td,{children:"hAP, RB4011, most home routers"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"$BUILDPLATFORM"})," annotation on stages 1\u20133 means compilation always runs on the host machine's\nnative architecture (fast), while the output binary targets ",(0,r.jsx)(n.code,{children:"$TARGETPLATFORM"}),"."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"runtime-tuning",children:"Runtime Tuning"}),"\n",(0,r.jsxs)(n.p,{children:["Production runtime settings are applied in ",(0,r.jsx)(n.code,{children:"internal/bootstrap/config.go"})," via\n",(0,r.jsx)(n.code,{children:"ApplyRuntimeConfig()"}),", called at program start in ",(0,r.jsx)(n.code,{children:"main_prod.go"}),"'s ",(0,r.jsx)(n.code,{children:"init()"}),":"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Setting"}),(0,r.jsx)(n.th,{children:"Production Value"}),(0,r.jsx)(n.th,{children:"Dev Value"}),(0,r.jsx)(n.th,{children:"Rationale"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"GOMAXPROCS"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"1"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"4"})}),(0,r.jsx)(n.td,{children:"RouterOS containers have 1 CPU core"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"GCPercent"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"10"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"100"})," (Go default)"]}),(0,r.jsx)(n.td,{children:"Aggressive GC to stay under RAM limit"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"MemoryLimitMB"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"32 MB"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"128 MB"})}),(0,r.jsxs)(n.td,{children:["Hard soft-limit via ",(0,r.jsx)(n.code,{children:"debug.SetMemoryLimit()"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ScannerWorkers"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"2"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"4"})}),(0,r.jsx)(n.td,{children:"Concurrent subnet scanning goroutines"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EventBusBufferSize"})}),(0,r.jsx)(n.td,{children:"Configured"}),(0,r.jsx)(n.td,{children:"Higher"}),(0,r.jsx)(n.td,{children:"Async event delivery buffer"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"GCPercent=10"})," means the Go GC triggers when heap grows 10% beyond the live set \u2014 much more frequent\nthan default (100%) but keeps peak memory predictable. ",(0,r.jsx)(n.code,{children:"SetMemoryLimit(32MB)"})," is a soft limit that\nincreases GC pressure further when approaching the threshold."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"build-tags",children:"Build Tags"}),"\n",(0,r.jsx)(n.p,{children:"NasNetConnect uses Go build tags to select production vs. development entry points:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Tag"}),(0,r.jsx)(n.th,{children:"Entry point"}),(0,r.jsx)(n.th,{children:"Frontend"}),(0,r.jsx)(n.th,{children:"CORS"}),(0,r.jsx)(n.th,{children:"Behavior"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"!dev"})," (default, prod)"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"main_prod.go"})}),(0,r.jsxs)(n.td,{children:["Embedded via ",(0,r.jsx)(n.code,{children:"//go:embed dist/**"})]}),(0,r.jsx)(n.td,{children:"Off"}),(0,r.jsx)(n.td,{children:"Serves frontend from binary"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"dev"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"main_dev.go"})}),(0,r.jsx)(n.td,{children:"Served by Vite dev server"}),(0,r.jsx)(n.td,{children:"On"}),(0,r.jsxs)(n.td,{children:["Proxies to ",(0,r.jsx)(n.code,{children:"localhost:5173"})]})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"Local Nx build uses explicit tag:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'# From project.json "build" target:\ngo build -tags=prod -ldflags="-s -w" -o ../../dist/apps/backend/backend ./cmd/nnc/\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Tests always run with ",(0,r.jsx)(n.code,{children:"-tags=dev"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'# From project.json "test" target:\ngo test -tags=dev ./...\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"embedded-frontend-serving",children:"Embedded Frontend Serving"}),"\n",(0,r.jsxs)(n.p,{children:["The static file handler in ",(0,r.jsx)(n.code,{children:"internal/server/static.go"})," implements SPA routing with pre-compressed\nasset support:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Request for /some/path\n    \u2502\n    \u251c\u2500 Skip: /api/*, /graphql, /health\n    \u2502\n    \u251c\u2500 Accept-Encoding: gzip AND .js or .css?\n    \u2502   \u2514\u2500 Try fsys.Open(path + ".gz")\n    \u2502       \u251c\u2500 Found \u2192 serve with Content-Encoding: gzip, Vary: Accept-Encoding\n    \u2502       \u2514\u2500 Not found \u2192 fall through\n    \u2502\n    \u251c\u2500 Try fsys.Open(path) directly\n    \u2502   \u251c\u2500 Found \u2192 serve with content-type + cache headers\n    \u2502   \u2514\u2500 Not found \u2192 fall through\n    \u2502\n    \u2514\u2500 SPA fallback \u2192 serve index.html (for React Router routes)\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Cache headers:"})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Path"}),(0,r.jsx)(n.th,{children:"Cache-Control"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"assets/*"})," (hashed filenames)"]}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"public, max-age=31536000, immutable"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"index.html"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"no-cache, no-store, must-revalidate"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Other"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"public, max-age=3600"})})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Directory traversal attacks are prevented by ",(0,r.jsx)(n.code,{children:"path.Clean()"})," normalization and ",(0,r.jsx)(n.code,{children:".."})," detection before\nany file is opened."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"health-check-cli-flag",children:"Health Check CLI Flag"}),"\n",(0,r.jsxs)(n.p,{children:["The Docker ",(0,r.jsx)(n.code,{children:"HEALTHCHECK"})," runs ",(0,r.jsx)(n.code,{children:"/app -healthcheck"}),". This flag is handled in ",(0,r.jsx)(n.code,{children:"main_prod.go"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'func performHealthCheck() {\n    port := os.Getenv("PORT")  // defaults to "80"\n    server.PerformHealthCheck(port, logger)\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"server.PerformHealthCheck()"})," (",(0,r.jsx)(n.code,{children:"internal/server/server.go"}),") performs:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"http.NewRequestWithContext"})," to ",(0,r.jsx)(n.code,{children:"http://localhost:{PORT}/health"})]}),"\n",(0,r.jsx)(n.li,{children:"10-second timeout"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"exit(0)"})," on HTTP 200, ",(0,r.jsx)(n.code,{children:"exit(1)"})," on error or non-200"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"/health"})," endpoint is registered separately from the GraphQL handler and skipped by the auth\nmiddleware (",(0,r.jsx)(n.code,{children:"DefaultSkipper"}),"). It always returns 200 when the server is running."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"internal/common/health/probes.go"})," provides reusable probe types (",(0,r.jsx)(n.code,{children:"TCPProbe"}),", ",(0,r.jsx)(n.code,{children:"HTTPProbe"}),",\n",(0,r.jsx)(n.code,{children:"ProcessProbe"}),", ",(0,r.jsx)(n.code,{children:"CompositeProbe"}),") used by service health checking at the orchestrator level \u2014\nseparate from the server-level health endpoint."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"nx-build-targets",children:"Nx Build Targets"}),"\n",(0,r.jsxs)(n.p,{children:["Key targets from ",(0,r.jsx)(n.code,{children:"project.json"}),":"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Target"}),(0,r.jsx)(n.th,{children:"Command"}),(0,r.jsx)(n.th,{children:"Notes"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"build"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"node tools/copy-frontend.mjs && go build -tags=prod ..."})}),(0,r.jsxs)(n.td,{children:["Depends on ",(0,r.jsx)(n.code,{children:"connect:build"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"serve"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"air"})," (hot reload)"]}),(0,r.jsx)(n.td,{children:"Development only"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"test"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"go test -tags=dev ./..."})}),(0,r.jsx)(n.td,{children:"Dev build tag for all tests"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"lint"})}),(0,r.jsxs)(n.td,{children:["custom ",(0,r.jsx)(n.code,{children:"gcl"})," binary"]}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:".golangci.yml"})," config"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"typecheck"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"go vet ./..."})}),(0,r.jsx)(n.td,{children:"Static analysis"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"docker:build"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"docker buildx build --platform=..."})}),(0,r.jsx)(n.td,{children:"Multi-arch, pushes to GHCR"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"docker:build-local"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"node tools/docker/cli.mjs build-local"})}),(0,r.jsx)(n.td,{children:"Single amd64 image for dev"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"docker:export-tar"})}),(0,r.jsxs)(n.td,{children:["Export ",(0,r.jsx)(n.code,{children:".tar.gz"})," for RouterOS import"]}),(0,r.jsx)(n.td,{children:"For air-gapped deployments"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"image-size-budget",children:"Image Size Budget"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"<10MB"})," target is achieved by layering these techniques:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Technique"}),(0,r.jsx)(n.th,{children:"Savings"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Alpine base image"}),(0,r.jsx)(n.td,{children:"~5MB vs. ubuntu/debian"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"CGO_ENABLED=0 + static binary"}),(0,r.jsx)(n.td,{children:"Eliminates glibc"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"UPX compression on Go binary"}),(0,r.jsx)(n.td,{children:"3\u20135x reduction (typically 8MB \u2192 2\u20133MB)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"UPX compression on hev-socks5-tunnel"}),(0,r.jsx)(n.td,{children:"~2\u20133MB savings"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"-w -s"})," ldflags"]}),(0,r.jsx)(n.td,{children:"Strips debug/symbol tables"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"-trimpath"})}),(0,r.jsx)(n.td,{children:"Removes source paths"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Gzip-precompressed JS/CSS in binary"}),(0,r.jsx)(n.td,{children:"70\u201380% asset reduction"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Multi-stage build"}),(0,r.jsx)(n.td,{children:"No Node.js / build tools in final image"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["[See: getting-started.md] \u2014 local development setup, ",(0,r.jsx)(n.code,{children:"npm run dev:all"})]}),"\n",(0,r.jsx)(n.li,{children:"[See: application-bootstrap.md] \u2014 service initialization order after binary starts"}),"\n",(0,r.jsxs)(n.li,{children:["[See: graphql-api.md \xa7Health] \u2014 ",(0,r.jsx)(n.code,{children:"/health"})," endpoint registration"]}),"\n",(0,r.jsx)(n.li,{children:"[See: service-orchestrator.md] \u2014 orchestrator boot sequence triggered after server starts"}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},71184:(e,n,d)=>{d.d(n,{R:()=>c,x:()=>l});var s=d(14041);const r={},i=s.createContext(r);function c(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);