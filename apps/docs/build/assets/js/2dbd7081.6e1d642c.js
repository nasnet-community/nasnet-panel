"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[74215],{43934:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"stores/drift-detection","title":"Drift Detection Store & Utilities","description":"This document covers configuration drift detection between desired state (configuration layer) and actual state (deployment layer) in the Universal State v2 8-layer resource model.","source":"@site/../../libs/state/docs/stores/drift-detection.md","sourceDirName":"stores","slug":"/stores/drift-detection","permalink":"/docs/state/stores/drift-detection","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/stores/drift-detection.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Domain UI Stores","permalink":"/docs/state/stores/domain-ui-stores"},"next":{"title":"History & Undo/Redo Store","permalink":"/docs/state/stores/history-undo-redo"}}');var r=t(31085),s=t(71184);const o={},l="Drift Detection Store & Utilities",a={},c=[{value:"Overview",id:"overview",level:2},{value:"Drift Status and Types",id:"drift-status-and-types",level:2},{value:"DriftStatus Enum",id:"driftstatus-enum",level:3},{value:"DriftResult Interface",id:"driftresult-interface",level:3},{value:"DriftedField Interface",id:"driftedfield-interface",level:3},{value:"Resource Priority Map",id:"resource-priority-map",level:2},{value:"Drift Utilities",id:"drift-utilities",level:2},{value:"FNV-1a Hashing",id:"fnv-1a-hashing",level:3},{value:"Normalization",id:"normalization",level:3},{value:"Runtime-Only Fields",id:"runtime-only-fields",level:3},{value:"Field-Level Diff",id:"field-level-diff",level:3},{value:"Quick vs Deep Comparison",id:"quick-vs-deep-comparison",level:3},{value:"React Hook: useDriftDetection",id:"react-hook-usedriftdetection",level:2},{value:"Usage Example",id:"usage-example",level:3},{value:"Utility Hooks",id:"utility-hooks",level:3},{value:"Reconciliation Scheduler",id:"reconciliation-scheduler",level:2},{value:"Initialization",id:"initialization",level:3},{value:"Polling Schedule Diagram",id:"polling-schedule-diagram",level:3},{value:"Status Queries",id:"status-queries",level:3},{value:"Apply-Confirm-Merge Integration",id:"apply-confirm-merge-integration",level:2},{value:"useApplyConfirmDrift Hook",id:"useapplyconfirmdrift-hook",level:3},{value:"Example: Applying Configuration",id:"example-applying-configuration",level:3},{value:"Drift Resolution Hook",id:"drift-resolution-hook",level:3},{value:"Drift Detection Lifecycle Flow",id:"drift-detection-lifecycle-flow",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"drift-detection-store--utilities",children:"Drift Detection Store & Utilities"})}),"\n",(0,r.jsx)(n.p,{children:"This document covers configuration drift detection between desired state (configuration layer) and actual state (deployment layer) in the Universal State v2 8-layer resource model."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Source:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"libs/state/stores/src/drift-detection/types.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"libs/state/stores/src/drift-detection/driftUtils.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"libs/state/stores/src/drift-detection/useDriftDetection.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"libs/state/stores/src/drift-detection/reconciliationScheduler.ts"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"libs/state/stores/src/drift-detection/useApplyConfirmDrift.ts"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"Drift detection provides:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Configuration vs Deployment Comparison"}),": Hash-based quick check + field-level diff"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Priority-Based Polling"}),": HIGH (5min), NORMAL (15min), LOW (60min)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Offline Support"}),": Pauses when disconnected, resumes on reconnect"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Field-Level Diagnostics"}),": Identifies exactly which fields differ"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resolution Strategies"}),": Re-apply or accept router state"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Apply-Confirm-Merge Integration"}),": Updates deployment layer after successful apply"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"drift-status-and-types",children:"Drift Status and Types"}),"\n",(0,r.jsx)(n.h3,{id:"driftstatus-enum",children:"DriftStatus Enum"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const DriftStatus = {\n  SYNCED: 'SYNCED',         // Green: Config matches deployment\n  DRIFTED: 'DRIFTED',       // Amber: Config differs from deployment\n  ERROR: 'ERROR',           // Red: Unable to determine drift\n  CHECKING: 'CHECKING',     // In progress\n  PENDING: 'PENDING',       // Deployment layer not available (not yet applied)\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"driftresult-interface",children:"DriftResult Interface"}),"\n",(0,r.jsx)(n.p,{children:"Result of a drift detection:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface DriftResult {\n  // Whether drift was detected\n  hasDrift: boolean;\n\n  // Current status\n  status: DriftStatus;\n\n  // Fields that differ (populated for DRIFTED status)\n  driftedFields: DriftedField[];\n\n  // FNV-1a hash of normalized config (for quick comparison)\n  configurationHash: string;\n\n  // FNV-1a hash of normalized deployment\n  deploymentHash: string;\n\n  // When this check was performed\n  lastChecked: Date;\n\n  // Error message if status is ERROR\n  errorMessage?: string;\n\n  // Whether deployment is stale (older than threshold, default 30min)\n  isStale?: boolean;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"driftedfield-interface",children:"DriftedField Interface"}),"\n",(0,r.jsx)(n.p,{children:"Individual field that has drifted:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface DriftedField {\n  // JSON path: 'address.ip', 'peers[0].endpoint', 'settings.auth.password'\n  path: string;\n\n  // User's desired value (from configuration layer)\n  configValue: unknown;\n\n  // Router's actual value (from deployment layer)\n  deployValue: unknown;\n\n  // Category for grouping in UI\n  category?: 'network' | 'security' | 'general';\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"resource-priority-map",children:"Resource Priority Map"}),"\n",(0,r.jsx)(n.p,{children:"Reconciliation polling frequency based on resource importance:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const ResourcePriority = {\n  HIGH: 5 * 60 * 1000,      // 5 minutes - Critical\n  NORMAL: 15 * 60 * 1000,   // 15 minutes - Important\n  LOW: 60 * 60 * 1000,      // 60 minutes - Background\n};\n\n// Priority assignment\nconst RESOURCE_PRIORITY_MAP: Record<string, ResourcePriority> = {\n  // HIGH: Critical connectivity (WAN, VPN, auth)\n  wan: HIGH,\n  vpn: HIGH,\n  'vpn.wireguard': HIGH,\n  auth: HIGH,\n\n  // NORMAL: Core infrastructure (LAN, DHCP, firewall)\n  lan: NORMAL,\n  dhcp: NORMAL,\n  firewall: NORMAL,\n  nat: NORMAL,\n  routing: NORMAL,\n  interface: NORMAL,\n\n  // LOW: Background services (logging, scripts)\n  logging: LOW,\n  scripts: LOW,\n  backup: LOW,\n};\n\n// Get priority for any resource type\nfunction getResourcePriority(resourceType: string): ResourcePriority {\n  // Exact match \u2192 prefix match \u2192 default NORMAL\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"drift-utilities",children:"Drift Utilities"}),"\n",(0,r.jsx)(n.h3,{id:"fnv-1a-hashing",children:"FNV-1a Hashing"}),"\n",(0,r.jsx)(n.p,{children:"Fast, deterministic 32-bit hash for configuration comparison:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'function fnv1a32(str: string): number {\n  let hash = 2166136261;  // FNV offset basis\n  for (let i = 0; i < str.length; i++) {\n    hash ^= str.charCodeAt(i);\n    hash = Math.imul(hash, 16777619);  // FNV prime\n  }\n  return hash >>> 0;  // Unsigned 32-bit\n}\n\n// Usage\nconst hash = computeConfigHash(config);  // Returns hex string: "a1b2c3d4"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Why FNV-1a?"})," Fast, deterministic, non-cryptographic, suitable for cache keys and quick comparison."]}),"\n",(0,r.jsx)(n.h3,{id:"normalization",children:"Normalization"}),"\n",(0,r.jsx)(n.p,{children:"Prepare data for comparison by:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Sorting object keys alphabetically"}),"\n",(0,r.jsx)(n.li,{children:"Removing undefined values"}),"\n",(0,r.jsx)(n.li,{children:"Converting dates to ISO strings"}),"\n",(0,r.jsx)(n.li,{children:"Handling nested objects/arrays recursively"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'function normalizeForComparison(value: unknown): unknown {\n  // Dates: new Date(\'2024-01-01\') \u2192 \'2024-01-01T00:00:00.000Z\'\n  // Objects: keys sorted alphabetically\n  // Arrays: recursively normalized\n  // Primitives: unchanged\n  // null/undefined: null\n}\n\n// Example\nconst normalized = normalizeForComparison({\n  ip: \'192.168.1.1\',\n  timestamp: new Date(\'2024-01-01\'),\n  flags: [\'dhcp\', \'active\'],\n  nested: { z: 1, a: 2 },\n});\n\n// Result:\n{\n  "flags": ["dhcp", "active"],\n  "ip": "192.168.1.1",\n  "nested": { "a": 2, "z": 1 },\n  "timestamp": "2024-01-01T00:00:00.000Z"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"runtime-only-fields",children:"Runtime-Only Fields"}),"\n",(0,r.jsx)(n.p,{children:"Fields that change frequently without user action and should be excluded from drift:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const RUNTIME_ONLY_FIELDS = [\n  // Traffic counters\n  'bytesIn', 'bytesOut', 'packetsIn', 'packetsOut', 'txRate', 'rxRate',\n\n  // Connection state\n  'lastHandshake', 'lastSeen', 'connectedSince', 'lastConnected',\n\n  // Metrics\n  'uptime', 'currentPeers', 'activeConnections', 'cpuLoad', 'memoryUsage',\n\n  // Auto-updated timestamps\n  'lastUpdated', 'lastModified', 'lastAccessed',\n\n  // Fluctuating status\n  'health', 'status', 'isRunning', 'errorCount',\n];\n\n// These are automatically excluded from comparison\n"})}),"\n",(0,r.jsx)(n.h3,{id:"field-level-diff",children:"Field-Level Diff"}),"\n",(0,r.jsx)(n.p,{children:"Find and categorize drifted fields:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function findDriftedFields(\n  config: unknown,\n  deploy: unknown,\n  options?: DriftDetectionOptions,\n  prefix = ''\n): DriftedField[] {\n  // Compares config vs deployment recursively\n  // Returns array of fields that differ\n  // Categorizes as 'network', 'security', or 'general'\n}\n\n// Example result\n[\n  {\n    path: 'address.ip',\n    configValue: '192.168.1.1',\n    deployValue: '192.168.1.2',\n    category: 'network',\n  },\n  {\n    path: 'firewall.enabled',\n    configValue: true,\n    deployValue: false,\n    category: 'security',\n  },\n]\n"})}),"\n",(0,r.jsx)(n.h3,{id:"quick-vs-deep-comparison",children:"Quick vs Deep Comparison"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Quick check (hash-based, O(n) serialization)\nhasQuickDrift(config, deploy);  // boolean, fast\n\n// Deep check (field-level, O(n\xb2) with nested)\nfindDriftedFields(config, deploy);  // DriftedField[], slower\n"})}),"\n",(0,r.jsx)(n.p,{children:"Use quick checks in list views; deep checks for detail panels."}),"\n",(0,r.jsx)(n.h2,{id:"react-hook-usedriftdetection",children:"React Hook: useDriftDetection"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export interface UseDriftDetectionResult {\n  result: DriftResult;        // Full detection result\n  hasDrift: boolean;          // Convenience boolean\n  status: DriftStatus;        // Current status\n  driftCount: number;         // Number of drifted fields\n  recompute: () => DriftResult;  // Manual recomputation\n}\n\nfunction useDriftDetection(\n  input: DriftDetectionInput,\n  options?: DriftDetectionOptions\n): UseDriftDetectionResult\n"})}),"\n",(0,r.jsx)(n.h3,{id:"usage-example",children:"Usage Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:'function ResourceDetailPanel({ resource }) {\n  const { hasDrift, status, driftCount, result } = useDriftDetection({\n    configuration: resource.configuration,\n    deployment: resource.deployment,\n    resourceType: resource.type,\n  });\n\n  return (\n    <div>\n      {status === DriftStatus.DRIFTED && (\n        <Alert variant="warning">\n          <AlertIcon />\n          <div>\n            <h4>Configuration Drift</h4>\n            <p>{driftCount} field(s) differ from router state</p>\n            <DriftFieldsList fields={result.driftedFields} />\n          </div>\n        </Alert>\n      )}\n      {status === DriftStatus.PENDING && (\n        <Alert variant="info">\n          <AlertIcon />\n          Configuration not yet applied to router\n        </Alert>\n      )}\n    </div>\n  );\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"utility-hooks",children:"Utility Hooks"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"useQuickDriftCheck()"}),": Hash-based only (no field-level diff)"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const { hasDrift, status } = useQuickDriftCheck(\n  resource.configuration,\n  resource.deployment\n);\n// Fast, suitable for list views\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"useBatchDriftStatus()"}),": Check multiple resources at once"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const driftStatusMap = useBatchDriftStatus(resources);\n// Returns Map<uuid, DriftStatus> for all resources\n"})}),"\n",(0,r.jsx)(n.h2,{id:"reconciliation-scheduler",children:"Reconciliation Scheduler"}),"\n",(0,r.jsx)(n.p,{children:"Priority-based polling scheduler for drift detection across many resources."}),"\n",(0,r.jsx)(n.h3,{id:"initialization",children:"Initialization"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { ReconciliationScheduler } from '@nasnet/state/stores';\n\nconst scheduler = new ReconciliationScheduler({\n  onDriftDetected: (uuid, result) => {\n    console.log(`Drift detected for ${uuid}:`, result.driftedFields);\n    showDriftNotification(uuid);\n  },\n  onDriftResolved: (uuid, result) => {\n    console.log(`Drift resolved for ${uuid}`);\n    hideDriftNotification(uuid);\n  },\n  onError: (uuid, error) => {\n    console.error(`Drift check failed for ${uuid}:`, error.message);\n  },\n  resourceFetcher: async (uuids) => {\n    // Fetch fresh resource data from API\n    const result = await apolloClient.query({\n      query: GET_RESOURCES,\n      variables: { uuids },\n    });\n    return result.data.resources;\n  },\n  isOnline: () => connectionStore.getState().wsStatus === 'connected',\n  batchSize: 10,             // Check 10 at a time\n  minBatchInterval: 1000,    // Wait at least 1s between batches\n});\n\n// Start polling\nscheduler.start();\n\n// Register resources\nscheduler.registerMany(resources);\n\n// Trigger immediate check after external change\nscheduler.scheduleImmediateCheck(resourceUuid);\n\n// Stop when done\nscheduler.stop();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"polling-schedule-diagram",children:"Polling Schedule Diagram"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500 Time \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                    \u2502\n\u251c\u2500 HIGH priority (5 min) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500   \u2502\n\u2502  |      |      |      |      |      |             \u2502\n\u2502  v      v      v      v      v      v             \u2502\n\u2502  \u2713 WAN                                            \u2502\n\u2502  \u2713 VPN                                            \u2502\n\u2502                                                    \u2502\n\u251c\u2500 NORMAL priority (15 min) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502  |             |             |             |       \u2502\n\u2502  v             v             v             v       \u2502\n\u2502  \u2713 DHCP                                            \u2502\n\u2502  \u2713 Firewall                                        \u2502\n\u2502  \u2713 Interface                                       \u2502\n\u2502                                                    \u2502\n\u251c\u2500 LOW priority (60 min) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n\u2502  |                                     |           \u2502\n\u2502  v                                     v           \u2502\n\u2502  \u2713 Logging                                         \u2502\n\u2502                                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nPauses when offline, resumes on reconnect\n"})}),"\n",(0,r.jsx)(n.h3,{id:"status-queries",children:"Status Queries"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Get all drift statuses\nconst statusMap = scheduler.getAllDriftStatus();\n// Returns Map<uuid, DriftResult | undefined>\n\n// Get currently drifted resources\nconst driftedUuids = scheduler.getDriftedResources();\n// Returns string[] of UUIDs with DRIFTED status\n\n// Get counts by status\nconst counts = scheduler.getDriftCounts();\n// Returns { SYNCED: 5, DRIFTED: 2, PENDING: 1, ERROR: 0, CHECKING: 0 }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"apply-confirm-merge-integration",children:"Apply-Confirm-Merge Integration"}),"\n",(0,r.jsx)(n.p,{children:"Hook that integrates drift detection with the Apply-Confirm-Merge pattern:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[Apply] \u2192 Send config to router\n    \u2193\n[Confirm] \u2192 Query router for actual state\n    \u2193\n[Update] \u2192 Store in deployment layer\n    \u2193\n[Publish] \u2192 Event bus for UI updates\n"})}),"\n",(0,r.jsx)(n.h3,{id:"useapplyconfirmdrift-hook",children:"useApplyConfirmDrift Hook"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function useApplyConfirmDrift<T>(\n  options: UseApplyConfirmDriftOptions<T>\n): UseApplyConfirmDriftReturn<T>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-applying-configuration",children:"Example: Applying Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"function ResourceEditor({ resource }) {\n  const { applyWithConfirm, isApplying, lastResult } = useApplyConfirmDrift({\n    applyFn: async (uuid, configuration) => {\n      // Step 1: Apply to router\n      const result = await apolloClient.mutate({\n        mutation: APPLY_RESOURCE,\n        variables: { uuid, configuration },\n      });\n      return result.data.applyResource;\n    },\n    confirmFn: async (uuid) => {\n      // Step 2: Query router for actual state (if separate)\n      const result = await apolloClient.query({\n        query: GET_RESOURCE_DEPLOYMENT,\n        variables: { uuid },\n      });\n      return result.data.resourceDeployment;\n    },\n    onDriftChange: (uuid, result) => {\n      if (result.status === DriftStatus.DRIFTED) {\n        toast.warning('\u26a0\ufe0f Configuration drift detected after apply');\n      }\n    },\n    onApplySuccess: (uuid, result) => {\n      toast.success('\u2713 Configuration applied successfully');\n    },\n  });\n\n  const handleSave = async (newConfig) => {\n    const updatedResource = {\n      ...resource,\n      configuration: newConfig\n    };\n    const result = await applyWithConfirm(updatedResource);\n\n    if (!result.success) {\n      toast.error(`\u2717 Apply failed: ${result.error}`);\n    }\n  };\n\n  return (\n    <form onSubmit={handleSave}>\n      <ResourceForm resource={resource} onChange={handleSave} />\n      <Button disabled={isApplying}>\n        {isApplying ? 'Applying...' : 'Apply Configuration'}\n      </Button>\n    </form>\n  );\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"drift-resolution-hook",children:"Drift Resolution Hook"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"function useDriftResolution<T>(\n  options: UseDriftResolutionOptions<T>\n): UseDriftResolutionReturn<T>\n"})}),"\n",(0,r.jsx)(n.p,{children:"Two strategies for resolving drift:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"function DriftResolutionPanel({ resource, driftResult }) {\n  const { reapply, accept, isResolving, error } = useDriftResolution({\n    // Option 1: Re-apply configuration (overwrite router state)\n    reapplyFn: async (uuid, config) => {\n      await apolloClient.mutate({\n        mutation: APPLY_RESOURCE,\n        variables: { uuid, configuration: config },\n      });\n    },\n\n    // Option 2: Accept router's state (update configuration layer)\n    acceptFn: async (uuid, deployment) => {\n      await apolloClient.mutate({\n        mutation: UPDATE_CONFIGURATION,\n        variables: {\n          uuid,\n          configuration: deployment.generatedFields\n        },\n      });\n    },\n\n    onResolved: (uuid, action) => {\n      toast.success(`Drift resolved: ${action === 'REAPPLY' ? 'Re-applied configuration' : 'Accepted router state'}`);\n    },\n  });\n\n  return (\n    <div>\n      <h4>Resolve Drift</h4>\n      <p>{driftResult.driftedFields.length} field(s) differ</p>\n\n      <Button\n        onClick={() => reapply(resource)}\n        disabled={isResolving}\n      >\n        Re-apply My Configuration\n      </Button>\n\n      <Button\n        onClick={() => accept(resource)}\n        disabled={isResolving}\n      >\n        Accept Router State\n      </Button>\n\n      {error && <Alert variant=\"destructive\">{error}</Alert>}\n    </div>\n  );\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"drift-detection-lifecycle-flow",children:"Drift Detection Lifecycle Flow"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Resource is applied to router\n              \u2502\n              \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Deployment Layer    \u2502\n    \u2502 .appliedAt = now    \u2502\n    \u2502 .generatedFields    \u2502\n    \u2502   = actual state    \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                 \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                  \u2502\n     5s \u2502              65s \u2502 (NORMAL priority)\n        \u2502                  \u2502\n        \u25bc                  \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 First check    \u2502  \u2502 Periodic check \u2502\n\u2502 (quick hash)   \u2502  \u2502 (field-level)  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502                    \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                   \u2502\n    No drift            Drift detected\n         \u2502                   \u2502\n         \u25bc                   \u25bc\n    SYNCED          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502  DRIFTED        \u2502\n                    \u2502  - show alert    \u2502\n                    \u2502  - offer actions \u2502\n                    \u2502    * Re-apply    \u2502\n                    \u2502    * Accept      \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                      \u2502             \u2502\n                   Re-apply      Accept\n                      \u2502             \u2502\n                      \u25bc             \u25bc\n                Apply again   Update config\n                      \u2502             \u2502\n                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n                        Re-check drift\n                             \u2502\n                       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                       \u2502             \u2502\n                    Synced      Still drifted\n                       \u2502             \u2502\n                       \u25bc             \u25bc\n                     SYNCED      Manual review\n"})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Scheduling for Many Resources"}),": Don't call useDriftDetection in lists; use scheduler + batch queries"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Respect Offline Status"}),": Check ",(0,r.jsx)(n.code,{children:"isOnline()"})," before scheduling checks"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Exclude Runtime Fields"}),": Use runtime-only field list to avoid false positives"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Batch Fetches"}),": Scheduler batches 10 at a time; adjust based on API capacity"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle Stale Deployments"}),": Mark as stale after 30 minutes without update"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Combine with Undo/Redo"}),": Changes via undo won't update deployment layer; use Apply-Confirm"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Offline Scenarios"}),": Verify scheduler pauses and resumes correctly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor Error Rates"}),": High error counts indicate connection or backend issues"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Display Field Differences"}),': Show specific drifted fields, not just "config differs"']}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Apply-Confirm-Merge Pattern"}),": ",(0,r.jsx)(n.code,{children:"../../architecture/data-architecture.md#state-flow-apply--confirm--merge"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"8-Layer Resource Model"}),": ",(0,r.jsx)(n.code,{children:"../../architecture/data-architecture.md#8-layer-resource-model"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Change Set Integration"}),": ",(0,r.jsx)(n.code,{children:"change-set.md"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"History & Undo/Redo"}),": ",(0,r.jsx)(n.code,{children:"history-undo-redo.md"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var i=t(14041);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);