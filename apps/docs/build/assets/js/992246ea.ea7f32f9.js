"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[67809],{51337:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"data-fetching/overview","title":"Data Fetching Overview","description":"This document describes how data flows from the React frontend to the MikroTik router and back.","source":"@site/../connect/docs/data-fetching/overview.md","sourceDirName":"data-fetching","slug":"/data-fetching/overview","permalink":"/docs/frontend/data-fetching/overview","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../connect/docs/data-fetching/overview.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Offline Support","permalink":"/docs/frontend/data-fetching/offline-support"},"next":{"title":"REST Client","permalink":"/docs/frontend/data-fetching/rest-client"}}');var i=r(31085),s=r(71184);const l={},c="Data Fetching Overview",o={},d=[{value:"The Full Data Flow",id:"the-full-data-flow",level:2},{value:"Two Transport Layers",id:"two-transport-layers",level:2},{value:"GraphQL over Apollo Client (primary)",id:"graphql-over-apollo-client-primary",level:3},{value:"REST via Router Proxy (secondary)",id:"rest-via-router-proxy-secondary",level:3},{value:"Apollo Client Link Chain",id:"apollo-client-link-chain",level:2},{value:"Request Lifecycle",id:"request-lifecycle",level:2},{value:"Query lifecycle",id:"query-lifecycle",level:3},{value:"Mutation lifecycle",id:"mutation-lifecycle",level:3},{value:"Subscription lifecycle",id:"subscription-lifecycle",level:3},{value:"Cache Configuration",id:"cache-configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"REST Client Error Handling",id:"rest-client-error-handling",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"data-fetching-overview",children:"Data Fetching Overview"})}),"\n",(0,i.jsx)(n.p,{children:"This document describes how data flows from the React frontend to the MikroTik router and back."}),"\n",(0,i.jsx)(n.h2,{id:"the-full-data-flow",children:"The Full Data Flow"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart TD\n    A[React Component] --\x3e B["Apollo Hook\\n(useQuery / useMutation / useSubscription)"]\n    B --\x3e C["Apollo Link Chain\\n(error \u2192 retry \u2192 split)"]\n    C --\x3e D["HTTP or WebSocket"]\n    D --\x3e E["Go Backend\\n(/graphql endpoint)"]\n    E --\x3e F["RouterOS REST API / SSH / Telnet"]\n    F --\x3e G[MikroTik Router]'}),"\n",(0,i.jsx)(n.p,{children:"The Go backend acts as the intermediary. The frontend never talks directly to the router. This\ndesign solves CORS restrictions and centralises authentication."}),"\n",(0,i.jsx)(n.h2,{id:"two-transport-layers",children:"Two Transport Layers"}),"\n",(0,i.jsx)(n.h3,{id:"graphql-over-apollo-client-primary",children:"GraphQL over Apollo Client (primary)"}),"\n",(0,i.jsx)(n.p,{children:"All domain data \u2014 router configuration, VPN tunnels, firewall rules, service instances \u2014 is fetched\nvia GraphQL. Apollo Client manages the normalised in-memory cache, subscription upgrade to\nWebSocket, and automatic retries."}),"\n",(0,i.jsx)(n.p,{children:"Use GraphQL hooks for:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Any data that belongs to the Universal State v2 resource model"}),"\n",(0,i.jsx)(n.li,{children:"Real-time subscriptions (service status, alert events)"}),"\n",(0,i.jsx)(n.li,{children:"Mutations that need optimistic updates"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"rest-via-router-proxy-secondary",children:"REST via Router Proxy (secondary)"}),"\n",(0,i.jsxs)(n.p,{children:["A thin REST proxy exists in ",(0,i.jsx)(n.code,{children:"libs/api-client/core/src/router-proxy.ts"}),". It sends RouterOS REST API\ncalls to the Go backend at ",(0,i.jsx)(n.code,{children:"/api/router/proxy"}),". The backend forwards them to the device and returns\nthe response."]}),"\n",(0,i.jsx)(n.p,{children:"Use the REST proxy for:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Low-level RouterOS operations not yet modelled in GraphQL"}),"\n",(0,i.jsx)(n.li,{children:"Development or one-off diagnostic queries"}),"\n",(0,i.jsx)(n.li,{children:"Integrating TanStack Query for data not in the Apollo cache"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// REST proxy example\nimport { makeRouterOSRequest } from '@nasnet/api-client/core';\n\nconst result = await makeRouterOSRequest<InterfaceList>('192.168.88.1', 'interface');\n\nif (result.success) {\n  console.log(result.data);\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"apollo-client-link-chain",children:"Apollo Client Link Chain"}),"\n",(0,i.jsxs)(n.p,{children:["Requests travel through a composed link chain defined in\n",(0,i.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-client.ts"}),":"]}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart TD\n    Req[Request] --\x3e EL["errorLink\\n(catch & log errors, emit network:error)"]\n    EL --\x3e RL["retryLink\\n(up to 3 attempts, exponential backoff)"]\n    RL --\x3e SL{splitLink}\n    SL --\x3e|subscription| WS["wsLink\\n(graphql-ws WebSocket)"]\n    SL --\x3e|query / mutation| AL["authLink \u2192 httpLink \u2192 /graphql"]'}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"authLink"})," injects two headers on every request:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"X-Router-Id"}),": the currently selected router's identifier, read from ",(0,i.jsx)(n.code,{children:"useConnectionStore"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Authorization"}),": ",(0,i.jsx)(n.code,{children:"Bearer <jwt>"})," (preferred) or ",(0,i.jsx)(n.code,{children:"Basic <base64>"})," fallback from per-router\ncredentials"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"request-lifecycle",children:"Request Lifecycle"}),"\n",(0,i.jsx)(n.h3,{id:"query-lifecycle",children:"Query lifecycle"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Component calls ",(0,i.jsx)(n.code,{children:"useQuery(GET_WHATEVER, { variables })"})]}),"\n",(0,i.jsxs)(n.li,{children:["Apollo checks the cache. If a valid entry exists, it returns immediately (",(0,i.jsx)(n.code,{children:"cache-first"})," policy)"]}),"\n",(0,i.jsxs)(n.li,{children:["For ",(0,i.jsx)(n.code,{children:"watchQuery"})," the default is ",(0,i.jsx)(n.code,{children:"cache-and-network"}),": returns cached data immediately, then issues\na network request to refresh"]}),"\n",(0,i.jsx)(n.li,{children:"The network request traverses the link chain and hits the Go backend"}),"\n",(0,i.jsx)(n.li,{children:"The backend resolves the GraphQL operation, calls MikroTik, and streams the response back"}),"\n",(0,i.jsxs)(n.li,{children:["Apollo normalises the response into the ",(0,i.jsx)(n.code,{children:"InMemoryCache"})," using ",(0,i.jsx)(n.code,{children:"uuid"})," as the cache key for\nresources"]}),"\n",(0,i.jsx)(n.li,{children:"The component re-renders with fresh data"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"mutation-lifecycle",children:"Mutation lifecycle"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Component calls ",(0,i.jsx)(n.code,{children:"mutate({ variables })"})]}),"\n",(0,i.jsxs)(n.li,{children:["An optional optimistic response is written to the cache immediately (e.g. ",(0,i.jsx)(n.code,{children:"useUpdateResource"}),"\napplies one)"]}),"\n",(0,i.jsx)(n.li,{children:"The mutation traverses the link chain"}),"\n",(0,i.jsx)(n.li,{children:"On success the server response replaces the optimistic write"}),"\n",(0,i.jsx)(n.li,{children:"On error the optimistic write is rolled back automatically"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"subscription-lifecycle",children:"Subscription lifecycle"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Component calls ",(0,i.jsx)(n.code,{children:"useSubscription(ON_WHATEVER, { variables })"})]}),"\n",(0,i.jsxs)(n.li,{children:["Apollo establishes (or reuses) a WebSocket via ",(0,i.jsx)(n.code,{children:"graphql-ws"})]}),"\n",(0,i.jsx)(n.li,{children:"The WebSocket URL is derived from the current page origin (ws:// or wss://)"}),"\n",(0,i.jsx)(n.li,{children:"Events from the Go backend push updates directly to the subscription handler"}),"\n",(0,i.jsx)(n.li,{children:"Apollo merges subscription data into the cache using configured type policies"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"cache-configuration",children:"Cache Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Key type policies (defined in ",(0,i.jsx)(n.code,{children:"apollo-client.ts"}),"):"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Key field"}),(0,i.jsx)(n.th,{children:"Merge strategy"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Router"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"id"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"status"})," field merges (not replaces)"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Resource"})," and all subtypes"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"uuid"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"runtime"})," and ",(0,i.jsx)(n.code,{children:"telemetry"})," merge; ",(0,i.jsx)(n.code,{children:"deployment"})," and ",(0,i.jsx)(n.code,{children:"validation"})," replace"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RuntimeState"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"merge: true"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ValidationResult"})}),(0,i.jsx)(n.td,{children:"\u2014"}),(0,i.jsx)(n.td,{children:"merge: false (always replace)"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["Bandwidth history is capped at 288 entries (24 hours at 5-minute intervals) via the ",(0,i.jsx)(n.code,{children:"telemetry"}),"\nfield merge function."]}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"errorLink"})," (",(0,i.jsx)(n.code,{children:"apollo-error-link.ts"}),") catches both GraphQL-level errors (e.g., resolver failures)\nand network-level errors. On network errors it dispatches a ",(0,i.jsx)(n.code,{children:"network:error"})," custom DOM event that\nthe offline detector listens to."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"retryLink"})," retries network failures up to 3 times with jitter. It does ",(0,i.jsx)(n.strong,{children:"not"})," retry 4xx client\nerrors, which are not transient."]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"/docs/frontend/state-management/apollo-client",children:(0,i.jsx)(n.code,{children:"../state-management/apollo-client.md"})})," for the\nfull Apollo Client configuration reference."]}),"\n",(0,i.jsx)(n.h2,{id:"rest-client-error-handling",children:"REST Client Error Handling"}),"\n",(0,i.jsxs)(n.p,{children:["The Axios-based REST interceptors (",(0,i.jsx)(n.code,{children:"libs/api-client/core/src/interceptors/"}),") translate HTTP status\ncodes into user-friendly messages:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Status"}),(0,i.jsx)(n.th,{children:"Message"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"401"}),(0,i.jsx)(n.td,{children:"Authentication failed. Check your credentials."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"403"}),(0,i.jsx)(n.td,{children:"Permission denied. You do not have access."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"404"}),(0,i.jsx)(n.td,{children:"Resource not found."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"409"}),(0,i.jsx)(n.td,{children:"Conflict. The resource may have changed."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"5xx"}),(0,i.jsx)(n.td,{children:"Server error. Please try again."})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"Network errors (no response) are detected separately and show connectivity-specific messages."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>c});var t=r(14041);const i={},s=t.createContext(i);function l(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);