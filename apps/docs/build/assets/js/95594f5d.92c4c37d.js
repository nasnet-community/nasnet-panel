"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[81422],{41740:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"service-orchestrator","title":"Service Orchestrator","description":"Lifecycle management for downloadable feature services: boot sequencing, process supervision, isolation verification, health monitoring, and resource control.","source":"@site/../backend/docs/service-orchestrator.md","sourceDirName":".","slug":"/service-orchestrator","permalink":"/docs/backend/service-orchestrator","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/service-orchestrator.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Security","permalink":"/docs/backend/security"},"next":{"title":"Translator Layer","permalink":"/docs/backend/translator-layer"}}');var t=n(31085),i=n(71184);const c={},o="Service Orchestrator",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>orchestrator/boot</code>",id:"orchestratorboot",level:3},{value:"<code>orchestrator/lifecycle</code>",id:"orchestratorlifecycle",level:3},{value:"<code>orchestrator/supervisor</code>",id:"orchestratorsupervisor",level:3},{value:"<code>orchestrator/resources</code>",id:"orchestratorresources",level:3},{value:"<code>orchestrator/isolation</code>",id:"orchestratorisolation",level:3},{value:"<code>orchestrator/health</code>",id:"orchestratorhealth",level:3},{value:"<code>orchestrator/scheduling</code>",id:"orchestratorscheduling",level:3},{value:"<code>orchestrator/vif_interfaces.go</code>",id:"orchestratorvif_interfacesgo",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Start Flow",id:"start-flow",level:3},{value:"Stop Flow",id:"stop-flow",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"service-orchestrator",children:"Service Orchestrator"})}),"\n",(0,t.jsxs)(r.blockquote,{children:["\n",(0,t.jsx)(r.p,{children:"Lifecycle management for downloadable feature services: boot sequencing, process supervision, isolation verification, health monitoring, and resource control."}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Packages:"})," ",(0,t.jsx)(r.code,{children:"internal/orchestrator/boot/"}),", ",(0,t.jsx)(r.code,{children:"internal/orchestrator/lifecycle/"}),", ",(0,t.jsx)(r.code,{children:"internal/orchestrator/supervisor/"}),", ",(0,t.jsx)(r.code,{children:"internal/orchestrator/resources/"}),", ",(0,t.jsx)(r.code,{children:"internal/orchestrator/scheduling/"}),", ",(0,t.jsx)(r.code,{children:"internal/orchestrator/health/"}),", ",(0,t.jsx)(r.code,{children:"internal/orchestrator/isolation/"})]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Key Files:"})," ",(0,t.jsx)(r.code,{children:"boot/boot_sequence.go"}),", ",(0,t.jsx)(r.code,{children:"lifecycle/lifecycle_manager.go"}),", ",(0,t.jsx)(r.code,{children:"lifecycle/lifecycle_starter.go"}),", ",(0,t.jsx)(r.code,{children:"lifecycle/lifecycle_stopper.go"}),", ",(0,t.jsx)(r.code,{children:"supervisor/registry.go"}),", ",(0,t.jsx)(r.code,{children:"supervisor/process.go"}),", ",(0,t.jsx)(r.code,{children:"resources/log_capture.go"})]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Prerequisites:"})," [See: 05-event-system.md], [See: 10-feature-marketplace.md \xa7Feature Registry]"]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(r.p,{children:"The Service Orchestrator manages the full lifecycle of downloadable feature services (Tor, sing-box, Xray, etc.). It coordinates:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Boot sequencing"})," \u2014 topologically ordered startup on system boot"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Instance lifecycle"})," \u2014 start/stop/restart with state machine transitions"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Process supervision"})," \u2014 OS-level process management with exponential backoff restart"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Pre-start checks"})," \u2014 isolation verification and resource pre-flight"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Health monitoring"})," \u2014 probe-based health checks with auto-restart"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Log capture"})," \u2014 file-based log rotation with real-time pub/sub"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Schedule evaluation"})," \u2014 cron-driven device routing activation/deactivation"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Kill switch"})," \u2014 traffic isolation when services go unhealthy"]}),"\n"]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(r.mermaid,{value:'graph TD\n    A["System Boot"]\n    A --\x3e B["BootSequenceManager"]\n    B --\x3e B1["1. Query auto_start instances"]\n    B --\x3e B2["2. ComputeStartupOrder<br/>topological layers"]\n    B --\x3e B3["3. Execute layers<br/>concurrently errgroup"]\n    B3 --\x3e C["InstanceManager.StartInstance()"]\n\n    C --\x3e C1["DependencyManager<br/>GetDependencies"]\n    C1 --\x3e C1A["auto-start dependencies<br/>recursive max depth 10"]\n    C1A --\x3e C1B["waitForInstanceHealth"]\n\n    C --\x3e C2["IsolationVerifier<br/>VerifyPreStart<br/>4-layer check"]\n    C --\x3e C3["ResourceManager<br/>CheckResourceAvailability"]\n    C --\x3e C4["supervisor.ProcessSupervisor<br/>Add + Start"]\n    C4 --\x3e C4A["ManagedProcess.run<br/>goroutine"]\n    C4A --\x3e C4B["exponential backoff<br/>restart loop"]\n    C4A --\x3e C4C["log capture<br/>file + pub/sub"]\n\n    C --\x3e C5["ResourceLimiter<br/>ApplyLimits<br/>cgroups v2"]\n    C --\x3e C6["BridgeOrchestrator<br/>SetupBridge<br/>VIF if needed"]\n\n    D["HealthChecker"]\n    D --\x3e D1["probe instances<br/>periodically"]\n    D --\x3e D2["restartChan<br/>handleRestartRequests"]\n\n    E["KillSwitchListener"]\n    E --\x3e E1["EventTypeHealthChanged"]\n    E1 --\x3e E2["firewall block/unblock"]\n\n    F["ScheduleEvaluator"]\n    F --\x3e F1["cron tick<br/>activate/deactivate<br/>DeviceRouting"]'}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorboot",children:(0,t.jsx)(r.code,{children:"orchestrator/boot"})}),"\n",(0,t.jsxs)(r.p,{children:["Orchestrates system-wide startup of all ",(0,t.jsx)(r.code,{children:"auto_start=true"})," service instances in dependency order."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Key Types"})}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Type"}),(0,t.jsx)(r.th,{children:"Description"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"BootSequenceManager"})}),(0,t.jsx)(r.td,{children:"Main coordinator for system boot"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"BootSequenceManagerConfig"})}),(0,t.jsx)(r.td,{children:"Configuration struct"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"InstanceStarter"})}),(0,t.jsxs)(r.td,{children:["Interface \u2014 ",(0,t.jsx)(r.code,{children:"StartInstance(ctx, instanceID) error"})]})]})]})]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Key Functions"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func NewBootSequenceManager(cfg BootSequenceManagerConfig) (*BootSequenceManager, error)\nfunc (bsm *BootSequenceManager) ExecuteBootSequence(ctx context.Context) error\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Execution Flow"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"collectAutoStartInstances"})," \u2014 queries ",(0,t.jsx)(r.code,{children:"ServiceInstance WHERE auto_start = true"})]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"computeStartupLayers"})," \u2014 delegates to ",(0,t.jsx)(r.code,{children:"DependencyManager.ComputeStartupOrder"})," (topological sort)"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"executeLayers"})," \u2014 layers are run sequentially; instances within a layer start concurrently via ",(0,t.jsx)(r.code,{children:"errgroup"})]}),"\n",(0,t.jsxs)(r.li,{children:["Per-instance timeout: ",(0,t.jsx)(r.strong,{children:"60 seconds"})]}),"\n",(0,t.jsxs)(r.li,{children:["Events published: ",(0,t.jsx)(r.code,{children:"BootSequenceStarted"}),", ",(0,t.jsx)(r.code,{children:"BootSequenceLayerComplete"}),", ",(0,t.jsx)(r.code,{children:"BootSequenceComplete"}),", ",(0,t.jsx)(r.code,{children:"BootSequenceFailed"})]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Partial Boot"})}),"\n",(0,t.jsx)(r.p,{children:"If any layer fails, the boot sequence halts and returns an error. Successfully started instances remain running. This is intentional \u2014 dependencies must be healthy before dependents start."}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorlifecycle",children:(0,t.jsx)(r.code,{children:"orchestrator/lifecycle"})}),"\n",(0,t.jsxs)(r.p,{children:["The ",(0,t.jsx)(r.code,{children:"InstanceManager"})," is the central orchestrator for runtime lifecycle operations. It implements ",(0,t.jsx)(r.code,{children:"InstanceStarter"})," and delegates to the supervisor."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Key Types"})}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Type"}),(0,t.jsx)(r.th,{children:"Description"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"InstanceManager"})}),(0,t.jsx)(r.td,{children:"Core lifecycle coordinator"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"InstanceManagerConfig"})}),(0,t.jsx)(r.td,{children:"Wires all dependencies"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"InstanceStatus"})}),(0,t.jsx)(r.td,{children:"State machine values"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"DependentsActiveError"})}),(0,t.jsx)(r.td,{children:"Returned when stopping with running dependents"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"GatewayPort"})}),(0,t.jsx)(r.td,{children:"Interface for SOCKS-to-TUN gateway"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"BridgeOrchestrator"})}),(0,t.jsx)(r.td,{children:"Interface for VIF bridge setup"})]})]})]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"InstanceManagerConfig Fields"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"type InstanceManagerConfig struct {\n    Registry           *features.FeatureRegistry\n    DownloadMgr        *features.DownloadManager\n    Supervisor         *supervisor.ProcessSupervisor\n    Gateway            GatewayPort          // optional: SOCKS-to-TUN gateway\n    Store              *ent.Client\n    EventBus           events.EventBus\n    PathResolver       storage.PathResolverPort\n    PortRegistry       *network.PortRegistry\n    VLANAllocator      *network.VLANAllocator\n    DependencyMgr      *dependencies.DependencyManager\n    BridgeOrchestrator BridgeOrchestrator   // optional: VIF bridge\n    IsolationVerifier  *isolation.IsolationVerifier\n    IsolationStrategy  isolationpkg.Strategy\n    ResourceLimiter    *resources.ResourceLimiter\n    ResourceManager    *resources.ResourceManager\n    ResourcePoller     *resources.ResourcePoller\n    GitHubClient       *registry.GitHubClient\n    Logger             *zap.Logger\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"State Machine"})}),"\n",(0,t.jsx)(r.mermaid,{value:'graph LR\n    A["Stopped"]\n    B["Starting"]\n    C["Running"]\n    D["Stopping"]\n    E["Failed"]\n\n    A --\x3e|Start| B\n    B --\x3e|Success| C\n    B --\x3e|Failure| E\n    C --\x3e|Stop| D\n    D --\x3e|Complete| A\n    E --\x3e|Retry| A'}),"\n",(0,t.jsxs)(r.p,{children:["Valid transitions are enforced by ",(0,t.jsx)(r.code,{children:"canTransition()"}),"."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsxs)(r.strong,{children:[(0,t.jsx)(r.code,{children:"lifecycle_starter.go"})," \u2014 StartInstance"]})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func (im *InstanceManager) StartInstance(ctx context.Context, instanceID string) error\n"})}),"\n",(0,t.jsx)(r.p,{children:"Recursive startup with dependency resolution (max depth 10):"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Resolve and auto-start dependencies"}),"\n",(0,t.jsxs)(r.li,{children:["Wait for each dependency to reach ",(0,t.jsx)(r.code,{children:"Running"})," status"]}),"\n",(0,t.jsxs)(r.li,{children:["Run pre-start isolation checks (",(0,t.jsx)(r.code,{children:"IsolationVerifier.VerifyPreStart"}),")"]}),"\n",(0,t.jsxs)(r.li,{children:["Run pre-flight resource check (",(0,t.jsx)(r.code,{children:"ResourceManager.CheckResourceAvailability"}),")"]}),"\n",(0,t.jsxs)(r.li,{children:["Build ",(0,t.jsx)(r.code,{children:"ProcessConfig"})," from manifest + instance config"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"Supervisor.Add(process)"})," + ",(0,t.jsx)(r.code,{children:"Supervisor.Start(ctx, id)"})]}),"\n",(0,t.jsxs)(r.li,{children:["Update DB status to ",(0,t.jsx)(r.code,{children:"Running"})]}),"\n",(0,t.jsx)(r.li,{children:"Apply resource limits (cgroups v2)"}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"BridgeOrchestrator.SetupBridge"})," (if VIF needed)"]}),"\n",(0,t.jsxs)(r.li,{children:["Start gateway if configured (",(0,t.jsx)(r.code,{children:"startGatewayIfNeeded"}),")"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsxs)(r.strong,{children:[(0,t.jsx)(r.code,{children:"lifecycle_stopper.go"})," \u2014 StopInstance"]})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func (im *InstanceManager) StopInstance(ctx context.Context, instanceID string) error\nfunc (im *InstanceManager) StopInstanceWithForce(ctx context.Context, instanceID string, force bool) error\n"})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Non-force stop checks for running dependents and returns ",(0,t.jsx)(r.code,{children:"DependentsActiveError"})," if any exist"]}),"\n",(0,t.jsx)(r.li,{children:"Stop order: gateway \u2192 resource monitoring \u2192 process \u2192 VIF bridge cleanup"}),"\n",(0,t.jsxs)(r.li,{children:["Emits ",(0,t.jsx)(r.code,{children:"StateChange"})," events throughout"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"lifecycle_installer.go"})})}),"\n",(0,t.jsx)(r.p,{children:"Handles binary installation: download, verification, extraction, binary placement."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"lifecycle_helpers.go"})})}),"\n",(0,t.jsxs)(r.p,{children:["Shared utilities: ",(0,t.jsx)(r.code,{children:"updateInstanceStatus"}),", ",(0,t.jsx)(r.code,{children:"emitStateChangeEvent"}),", ",(0,t.jsx)(r.code,{children:"canTransition"}),", ",(0,t.jsx)(r.code,{children:"buildProcessArgs"}),", ",(0,t.jsx)(r.code,{children:"buildProcessEnv"}),", ",(0,t.jsx)(r.code,{children:"applyResourceLimits"}),", ",(0,t.jsx)(r.code,{children:"setupBridgeIfNeeded"}),"."]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorsupervisor",children:(0,t.jsx)(r.code,{children:"orchestrator/supervisor"})}),"\n",(0,t.jsx)(r.p,{children:"OS-level process management with exponential backoff restart and port validation."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Key Types"})}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Type"}),(0,t.jsx)(r.th,{children:"Description"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ProcessSupervisor"})}),(0,t.jsx)(r.td,{children:"Registry and coordinator for all managed processes"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ProcessSupervisorConfig"})}),(0,t.jsxs)(r.td,{children:["Config including optional ",(0,t.jsx)(r.code,{children:"PortRegistry"})," and ",(0,t.jsx)(r.code,{children:"CgroupManager"})]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ManagedProcess"})}),(0,t.jsx)(r.td,{children:"Single process wrapper with lifecycle and backoff"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ProcessConfig"})}),(0,t.jsx)(r.td,{children:"Constructor config for a managed process"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ProcessState"})}),(0,t.jsxs)(r.td,{children:[(0,t.jsx)(r.code,{children:"starting"}),", ",(0,t.jsx)(r.code,{children:"running"}),", ",(0,t.jsx)(r.code,{children:"stopping"}),", ",(0,t.jsx)(r.code,{children:"stopped"}),", ",(0,t.jsx)(r.code,{children:"crashed"}),", ",(0,t.jsx)(r.code,{children:"backing_off"})]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"BackoffConfig"})}),(0,t.jsx)(r.td,{children:"Exponential backoff parameters"})]})]})]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"ProcessSupervisor API"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func NewProcessSupervisor(cfg ProcessSupervisorConfig) *ProcessSupervisor\nfunc (ps *ProcessSupervisor) Add(mp *ManagedProcess) error\nfunc (ps *ProcessSupervisor) Start(ctx context.Context, id string) error  // validates ports first\nfunc (ps *ProcessSupervisor) Stop(ctx context.Context, id string) error\nfunc (ps *ProcessSupervisor) StopAll(ctx context.Context) error           // concurrent\nfunc (ps *ProcessSupervisor) Get(id string) (*ManagedProcess, bool)\nfunc (ps *ProcessSupervisor) List() []*ManagedProcess\nfunc (ps *ProcessSupervisor) Remove(id string) error                      // must be stopped\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"ManagedProcess"})}),"\n",(0,t.jsxs)(r.p,{children:["Each process runs in its own goroutine (",(0,t.jsx)(r.code,{children:"mp.run(ctx)"}),") with:"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Automatic restart on crash (if ",(0,t.jsx)(r.code,{children:"AutoRestart=true"}),")"]}),"\n",(0,t.jsx)(r.li,{children:"Exponential backoff: initial=1s, max=30s, multiplier=2x"}),"\n",(0,t.jsxs)(r.li,{children:["Backoff reset after ",(0,t.jsx)(r.strong,{children:"30 seconds"})," of stable uptime"]}),"\n",(0,t.jsxs)(r.li,{children:["Optional cgroup v2 memory limits via ",(0,t.jsx)(r.code,{children:"CgroupManager"})]}),"\n",(0,t.jsxs)(r.li,{children:["Log capture to disk with pub/sub (see ",(0,t.jsx)(r.code,{children:"resources.LogCapture"}),")"]}),"\n",(0,t.jsxs)(r.li,{children:["Process isolation via ",(0,t.jsx)(r.code,{children:"isolation.Strategy"})," (platform-specific)"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"process_run.go"})})}),"\n",(0,t.jsxs)(r.p,{children:["Contains the ",(0,t.jsx)(r.code,{children:"run()"})," goroutine loop: fork \u2192 wait \u2192 check ",(0,t.jsx)(r.code,{children:"stopChan"})," \u2192 backoff \u2192 retry."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Port Validation"})}),"\n",(0,t.jsxs)(r.p,{children:["Before ",(0,t.jsx)(r.code,{children:"Start()"}),", if ",(0,t.jsx)(r.code,{children:"PortRegistry"})," is configured and ",(0,t.jsx)(r.code,{children:"RouterID"}),"+",(0,t.jsx)(r.code,{children:"Ports"})," are set, the supervisor validates that each TCP port is not already in use on that router."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Log Access"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func (mp *ManagedProcess) GetLogs(maxLines int) ([]resources.LogEntry, error)\nfunc (mp *ManagedProcess) SubscribeToLogs(subscriberID string, bufferSize int, filter resources.LogFilterFunc) (*resources.LogSubscriber, error)\nfunc (mp *ManagedProcess) UnsubscribeFromLogs(subscriberID string)\n"})}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorresources",children:(0,t.jsx)(r.code,{children:"orchestrator/resources"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsxs)(r.strong,{children:[(0,t.jsx)(r.code,{children:"log_capture.go"})," / ",(0,t.jsx)(r.code,{children:"log_capture_parser.go"})]})}),"\n",(0,t.jsx)(r.p,{children:"File-based log capture with real-time pub/sub."}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Constant"}),(0,t.jsx)(r.th,{children:"Value"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"MaxLogFileSize"})}),(0,t.jsx)(r.td,{children:"10 MB (triggers rotation)"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"DefaultSubscriberBufferSize"})}),(0,t.jsx)(r.td,{children:"100 entries"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"MaxTailLines"})}),(0,t.jsx)(r.td,{children:"1000 lines"})]})]})]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'type LogEntry struct {\n    Timestamp time.Time\n    Level     LogLevel    // debug, info, warn, error, unknown\n    Source    string      // e.g., "tor", "singbox"\n    Message   string\n    RawLine   string\n    Metadata  map[string]string\n}\n\ntype LogCaptureConfig struct {\n    InstanceID  string\n    ServiceName string\n    LogDir      string\n    Logger      *zap.Logger\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["Log parsing is service-aware (",(0,t.jsx)(r.code,{children:"log_capture_parser.go"}),") \u2014 it recognizes structured JSON logs (sing-box, Xray) as well as text-based formats (Tor)."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"poller_windows.go"})})}),"\n",(0,t.jsx)(r.p,{children:"Windows-specific resource polling stub (no-op cgroups on Windows builds)."}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorisolation",children:(0,t.jsx)(r.code,{children:"orchestrator/isolation"})}),"\n",(0,t.jsx)(r.p,{children:"Pre-start isolation verification \u2014 4-layer checks before any process starts."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Key Types"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'type IsolationVerifier struct { ... }\n\ntype IsolationVerifierConfig struct {\n    PortRegistry           PortRegistryPort\n    ConfigBindingValidator ConfigBindingValidatorPort // optional (Layer 1)\n    EventBus               events.EventBus\n    Logger                 *zap.Logger\n    AllowedBaseDir         string // default: "/data/services"\n}\n\n// Re-exported from internal/common/isolation:\ntype IsolationSeverity = isolation.Severity   // SeverityError, SeverityWarning\ntype IsolationViolation = isolation.Violation\ntype IsolationReport = isolation.Report\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Verification Layers"})}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Layer"}),(0,t.jsx)(r.th,{children:"Check"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Layer 1"}),(0,t.jsxs)(r.td,{children:["IP binding \u2014 validate ",(0,t.jsx)(r.code,{children:"BindIP"})," matches configured interface"]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Layer 2"}),(0,t.jsx)(r.td,{children:"Port allocation \u2014 verify all required ports are registered"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Layer 3"}),(0,t.jsxs)(r.td,{children:["File system \u2014 binary exists in ",(0,t.jsx)(r.code,{children:"AllowedBaseDir"})]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Layer 4"}),(0,t.jsx)(r.td,{children:"Network namespace \u2014 (platform-specific)"})]})]})]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"VerifyPreStart(ctx, instance)"})," returns an ",(0,t.jsx)(r.code,{children:"IsolationReport"}),". If any ",(0,t.jsx)(r.code,{children:"SeverityError"})," violation is found, the start is rejected."]}),"\n",(0,t.jsx)(r.p,{children:"[See: ADR 007 \u2014 IP Binding Isolation for design rationale]"}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorhealth",children:(0,t.jsx)(r.code,{children:"orchestrator/health"})}),"\n",(0,t.jsx)(r.p,{children:"Health monitoring with service-specific probes."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"diagnostics_proxy.go"})})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"type ProxySOCKS5Test struct { Host string; Port int }\nfunc (t *ProxySOCKS5Test) Run(ctx context.Context) DiagnosticResult\n"})}),"\n",(0,t.jsx)(r.p,{children:"Tests SOCKS5 connectivity by performing a TCP dial + SOCKS5 handshake."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"diagnostics_adguard.go"})})}),"\n",(0,t.jsx)(r.p,{children:"AdGuard Home-specific HTTP health check against the admin API."}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"HealthChecker"})})}),"\n",(0,t.jsx)(r.p,{children:"Runs health probes on a schedule. On failure:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Sends ",(0,t.jsx)(r.code,{children:"RestartRequest"})," to ",(0,t.jsx)(r.code,{children:"restartChan"})]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"InstanceManager.handleRestartRequests()"})," receives and calls ",(0,t.jsx)(r.code,{children:"StopInstance"})," + ",(0,t.jsx)(r.code,{children:"StartInstance"})]}),"\n",(0,t.jsxs)(r.li,{children:["Publishes ",(0,t.jsx)(r.code,{children:"EventTypeHealthChanged"})," to the event bus"]}),"\n"]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorscheduling",children:(0,t.jsx)(r.code,{children:"orchestrator/scheduling"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"schedule_evaluator_actions.go"})})}),"\n",(0,t.jsxs)(r.p,{children:["Evaluates ",(0,t.jsx)(r.code,{children:"RoutingSchedule"})," cron expressions and activates/deactivates ",(0,t.jsx)(r.code,{children:"DeviceRouting"})," records."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func (se *ScheduleEvaluator) activateRouting(ctx context.Context, routing *ent.DeviceRouting, schedule *ent.RoutingSchedule)\nfunc (se *ScheduleEvaluator) deactivateRouting(ctx context.Context, routing *ent.DeviceRouting, schedule *ent.RoutingSchedule)\n"})}),"\n",(0,t.jsx)(r.p,{children:"On activation:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Set ",(0,t.jsx)(r.code,{children:"DeviceRouting.active = true"})]}),"\n",(0,t.jsxs)(r.li,{children:["Update ",(0,t.jsx)(r.code,{children:"RoutingSchedule.last_activated"})," timestamp"]}),"\n",(0,t.jsxs)(r.li,{children:["Call ",(0,t.jsx)(r.code,{children:"KillSwitchCoordinator.ResumeRouting"})," \u2014 unblocks traffic through the service"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"On deactivation:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Set ",(0,t.jsx)(r.code,{children:"DeviceRouting.active = false"})]}),"\n",(0,t.jsxs)(r.li,{children:["Call ",(0,t.jsx)(r.code,{children:"KillSwitchCoordinator.PauseRouting"})," \u2014 blocks traffic (kill switch)"]}),"\n"]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h3,{id:"orchestratorvif_interfacesgo",children:(0,t.jsx)(r.code,{children:"orchestrator/vif_interfaces.go"})}),"\n",(0,t.jsxs)(r.p,{children:["Bridge between the lifecycle manager and the Virtual Interface Factory. Implements the ",(0,t.jsx)(r.code,{children:"BridgeOrchestrator"})," interface consumed by ",(0,t.jsx)(r.code,{children:"InstanceManager"}),"."]}),"\n",(0,t.jsx)(r.p,{children:"[See: 07-virtual-interface-factory.md for full VIF details]"}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,t.jsx)(r.h3,{id:"start-flow",children:"Start Flow"}),"\n",(0,t.jsx)(r.mermaid,{value:'graph TD\n    A["GraphQL mutation: startServiceInstance"]\n    A --\x3e B["InstanceManager.StartInstance instanceID"]\n    B --\x3e B1["dependency check<br/>DependencyManager<br/>start deps recursively"]\n    B --\x3e B2["isolation check<br/>IsolationVerifier.VerifyPreStart<br/>SeverityError \u2192 abort set Failed"]\n    B --\x3e B3["resource check<br/>ResourceManager.CheckResourceAvailability<br/>Insufficient \u2192 abort with suggestions"]\n    B --\x3e B4["status update: DB = Starting"]\n    B --\x3e B5["process create: supervisor.Add"]\n    B --\x3e B6["process start: supervisor.Start<br/>validates ports \u2192 forks"]\n    B --\x3e B7["status update: DB = Running"]\n    B --\x3e B8["resource limits<br/>ResourceLimiter.ApplyMemoryLimit<br/>cgroups v2"]\n    B --\x3e B9["VIF setup<br/>BridgeOrchestrator.SetupBridge<br/>if needed"]'}),"\n",(0,t.jsx)(r.h3,{id:"stop-flow",children:"Stop Flow"}),"\n",(0,t.jsx)(r.mermaid,{value:'graph TD\n    A["GraphQL mutation: stopServiceInstance"]\n    A --\x3e B["InstanceManager.StopInstanceWithForce<br/>instanceID force"]\n    B --\x3e B1["dependent check<br/>DependencyManager.GetDependents<br/>Running dependents + force=false<br/>\u2192 DependentsActiveError"]\n    B --\x3e B2["status update: DB = Stopping"]\n    B --\x3e B3["gateway stop<br/>Gateway.StopGateway"]\n    B --\x3e B4["monitoring stop<br/>ResourceLimiter.StopMonitoring pid"]\n    B --\x3e B5["process stop<br/>supervisor.Stop<br/>SIGKILL + wait"]\n    B --\x3e B6["process remove<br/>supervisor.Remove id"]\n    B --\x3e B7["VIF teardown<br/>BridgeOrchestrator.TeardownBridge"]\n    B --\x3e B8["status update: DB = Stopped"]'}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(r.p,{children:["Most options are wired during bootstrap in ",(0,t.jsx)(r.code,{children:"internal/bootstrap/orchestrator.go"}),"."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"ResourceLimiter"})," (cgroups v2, Linux only):"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Applies memory limit from ",(0,t.jsx)(r.code,{children:"ServiceInstance.MemoryLimit"})," (bytes)"]}),"\n",(0,t.jsx)(r.li,{children:"Falls back gracefully on platforms without cgroups"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"BridgeOrchestrator"})," (optional):"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["Only wired if ",(0,t.jsx)(r.code,{children:"VLANAllocator"})," is configured"]}),"\n",(0,t.jsx)(r.li,{children:"Skipped on routers not supporting VIF"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"IsolationStrategy"})," (platform-specific):"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Linux: namespace-based isolation"}),"\n",(0,t.jsx)(r.li,{children:"Windows: no-op (development builds)"}),"\n"]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Error"}),(0,t.jsx)(r.th,{children:"Handling"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"DependentsActiveError"})}),(0,t.jsxs)(r.td,{children:["Returned to caller; dependents must be stopped first or ",(0,t.jsx)(r.code,{children:"force=true"})]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsxs)(r.td,{children:["Isolation violation (",(0,t.jsx)(r.code,{children:"SeverityError"}),")"]}),(0,t.jsxs)(r.td,{children:["Instance set to ",(0,t.jsx)(r.code,{children:"Failed"}),"; caller gets error"]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Resource insufficient"}),(0,t.jsxs)(r.td,{children:["Instance set to ",(0,t.jsx)(r.code,{children:"Failed"}),"; error includes suggestions"]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Port conflict"}),(0,t.jsxs)(r.td,{children:[(0,t.jsx)(r.code,{children:"supervisor.Start"})," returns error; instance set to ",(0,t.jsx)(r.code,{children:"Failed"})]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Process crash"}),(0,t.jsx)(r.td,{children:"Supervisor auto-restarts with exponential backoff"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Health check failure"}),(0,t.jsxs)(r.td,{children:[(0,t.jsx)(r.code,{children:"HealthChecker"})," sends restart request; triggers stop+start cycle"]})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Layer failure in boot"}),(0,t.jsx)(r.td,{children:"Boot halts; partial successes remain running"})]})]})]}),"\n",(0,t.jsxs)(r.p,{children:["All status transitions emit ",(0,t.jsx)(r.code,{children:"StateChange"})," events via the event bus."]}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"testing",children:"Testing"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"boot/boot_sequence_test.go"})})}),"\n",(0,t.jsxs)(r.p,{children:["Tests ",(0,t.jsx)(r.code,{children:"ExecuteBootSequence"})," with mock ",(0,t.jsx)(r.code,{children:"InstanceStarter"}),". Covers:"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Empty instance list (no-op)"}),"\n",(0,t.jsx)(r.li,{children:"Single layer success"}),"\n",(0,t.jsx)(r.li,{children:"Multi-layer ordered startup"}),"\n",(0,t.jsx)(r.li,{children:"Layer failure halts sequence"}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"supervisor/supervisor_test.go"})})}),"\n",(0,t.jsxs)(r.p,{children:["Tests ",(0,t.jsx)(r.code,{children:"ProcessSupervisor"})," with real OS processes (echo/sleep commands). Covers:"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Add/Start/Stop/Remove lifecycle"}),"\n",(0,t.jsx)(r.li,{children:"Concurrent StopAll"}),"\n",(0,t.jsx)(r.li,{children:"State machine correctness"}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:(0,t.jsx)(r.code,{children:"isolation/isolation_permission_test.go"})})}),"\n",(0,t.jsx)(r.p,{children:"Tests permission checks for file-system layer of isolation verifier."}),"\n",(0,t.jsx)(r.hr,{}),"\n",(0,t.jsx)(r.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"[See: 05-event-system.md] \u2014 Event bus used throughout for state change events"}),"\n",(0,t.jsx)(r.li,{children:"[See: 07-virtual-interface-factory.md] \u2014 VIF bridge setup called from lifecycle_starter"}),"\n",(0,t.jsx)(r.li,{children:"[See: 10-feature-marketplace.md \xa7Feature Registry] \u2014 Manifest lookup for process configuration"}),"\n",(0,t.jsx)(r.li,{children:"[See: 11-data-layer.md \xa7ServiceInstance] \u2014 Ent schema for instance state"}),"\n",(0,t.jsx)(r.li,{children:"[See: ADR 007 \u2014 IP Binding Isolation] \u2014 Design rationale for isolation layers"}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},71184:(e,r,n)=>{n.d(r,{R:()=>c,x:()=>o});var s=n(14041);const t={},i=s.createContext(t);function c(e){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);