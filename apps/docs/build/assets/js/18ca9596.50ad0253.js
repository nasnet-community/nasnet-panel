"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[5443],{47617:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"network-services","title":"Network Services","description":"Stateless service layer for firewall rules, DNS lookups, network scanning, bridge management, and internet troubleshooting \u2014 all operating through the RouterPort abstraction.","source":"@site/../backend/docs/network-services.md","sourceDirName":".","slug":"/network-services","permalink":"/docs/backend/network-services","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/network-services.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"NasNet Backend \u2014 Master Index","permalink":"/docs/backend/"},"next":{"title":"Process Isolation","permalink":"/docs/backend/process-isolation"}}');var i=r(31085),t=r(71184);const o={},c="Network Services",d={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/firewall</code>",id:"internalfirewall",level:3},{value:"<code>address_list_service.go</code> \u2014 <code>AddressListService</code>",id:"address_list_servicego--addresslistservice",level:4},{value:"<code>nat/portforward.go</code> and <code>nat/service.go</code>",id:"natportforwardgo-and-natservicego",level:4},{value:"<code>portknock.go</code> \u2014 Port Knocking Service",id:"portknockgo--port-knocking-service",level:4},{value:"<code>internal/dns</code>",id:"internaldns",level:3},{value:"<code>service.go</code> \u2014 <code>Service</code>",id:"servicego--service",level:4},{value:"<code>internal/router/scanner</code>",id:"internalrouterscanner",level:3},{value:"<code>scanner.go</code>",id:"scannergo",level:4},{value:"<code>internal/services/bridge</code>",id:"internalservicesbridge",level:3},{value:"<code>service.go</code> \u2014 <code>Service</code>",id:"servicego--service-1",level:4},{value:"<code>UndoStore</code>",id:"undostore",level:4},{value:"<code>internal/troubleshoot</code>",id:"internaltroubleshoot",level:3},{value:"<code>service.go</code> \u2014 <code>Service</code>",id:"servicego--service-2",level:4},{value:"<code>session_store.go</code> \u2014 <code>SessionStore</code>",id:"session_storego--sessionstore",level:4},{value:"<code>diagnostics/</code> sub-package",id:"diagnostics-sub-package",level:4},{value:"<code>internal/services/netif</code>",id:"internalservicesnetif",level:3},{value:"<code>internal/services/networking/vlan</code>",id:"internalservicesnetworkingvlan",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Firewall Address List Query",id:"firewall-address-list-query",level:3},{value:"DNS Lookup (RouterOS native A record)",id:"dns-lookup-routeros-native-a-record",level:3},{value:"Troubleshoot Session Flow",id:"troubleshoot-session-flow",level:3},{value:"Network Scan Flow",id:"network-scan-flow",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"network-services",children:"Network Services"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["Stateless service layer for firewall rules, DNS lookups, network scanning, bridge management, and internet troubleshooting \u2014 all operating through the ",(0,i.jsx)(n.code,{children:"RouterPort"})," abstraction."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Packages:"})," ",(0,i.jsx)(n.code,{children:"internal/firewall/"}),", ",(0,i.jsx)(n.code,{children:"internal/dns/"}),", ",(0,i.jsx)(n.code,{children:"internal/router/scanner/"}),", ",(0,i.jsx)(n.code,{children:"internal/services/bridge/"}),", ",(0,i.jsx)(n.code,{children:"internal/troubleshoot/"}),", ",(0,i.jsx)(n.code,{children:"internal/services/netif/"}),", ",(0,i.jsx)(n.code,{children:"internal/services/networking/"}),"\n",(0,i.jsx)(n.strong,{children:"Key Files:"})," ",(0,i.jsx)(n.code,{children:"firewall/address_list_service.go"}),", ",(0,i.jsx)(n.code,{children:"dns/service.go"}),", ",(0,i.jsx)(n.code,{children:"router/scanner/scanner.go"}),", ",(0,i.jsx)(n.code,{children:"services/bridge/service.go"}),", ",(0,i.jsx)(n.code,{children:"troubleshoot/service.go"}),"\n",(0,i.jsx)(n.strong,{children:"Prerequisites:"})," [See: 04-router-communication.md \xa7RouterPort Interface], [See: 05-event-system.md \xa7Publishing Events]"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.p,{children:["Network Services is the collection of focused service packages that sit above the ",(0,i.jsx)(n.code,{children:"RouterPort"})," abstraction. They do not manage connection state \u2014 they receive a ",(0,i.jsx)(n.code,{children:"RouterPort"})," (or an embedded ",(0,i.jsx)(n.code,{children:"base.Service"}),") and issue structured commands, parse responses, and return domain types."]}),"\n",(0,i.jsx)(n.p,{children:"Key design principles across all network service packages:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Stateless services"})," \u2014 the ",(0,i.jsx)(n.code,{children:"RouterPort"})," is injected per-operation or once at construction; services hold no mutable connection state"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Parallel fetching"})," \u2014 goroutines with ",(0,i.jsx)(n.code,{children:"sync.WaitGroup"})," for independent sub-queries (e.g., referencing rule counts across multiple address lists)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Domain types, not ent types"})," \u2014 each package defines its own ",(0,i.jsx)(n.code,{children:"Data"}),", ",(0,i.jsx)(n.code,{children:"Input"}),", ",(0,i.jsx)(n.code,{children:"Result"})," types"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cursor/offset pagination"})," \u2014 where applicable, default page size of 50 entries"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Undo windows"})," \u2014 mutating services support a 10-second undo via ",(0,i.jsx)(n.code,{children:"UndoStore"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"                     GraphQL Resolvers\n                           \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                \u2502                \u2502\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502  firewall   \u2502  \u2502    dns      \u2502  \u2502   troubleshoot  \u2502\n   \u2502  (stateless)\u2502  \u2502  Service    \u2502  \u2502    Service      \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                \u2502                \u2502\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502  services/  \u2502  \u2502  scanner/   \u2502  \u2502  diagnostics/  \u2502\n   \u2502   bridge    \u2502  \u2502   ScanIP    \u2502  \u2502  (circuit,dns, \u2502\n   \u2502  (UndoStore)\u2502  \u2502             \u2502  \u2502   routelookup) \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                \u2502                \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n                      RouterPort\n                    (FallbackChain)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,i.jsx)(n.h3,{id:"internalfirewall",children:(0,i.jsx)(n.code,{children:"internal/firewall"})}),"\n",(0,i.jsx)(n.p,{children:"Provides firewall address list, NAT, port knocking, and filter rule operations for MikroTik routers."}),"\n",(0,i.jsxs)(n.h4,{id:"address_list_servicego--addresslistservice",children:[(0,i.jsx)(n.code,{children:"address_list_service.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"AddressListService"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// Stateless service \u2014 RouterPort is passed per operation, not stored\ntype AddressListService struct{}\n\nfunc NewAddressListService() *AddressListService\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"GetAddressLists(ctx, port RouterPort) ([]AddressListAggregate, error)"})})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Fetches all address list entries via ",(0,i.jsx)(n.code,{children:'ExecuteCommand({Path: "/ip/firewall/address-list", Action: "print"})'})]}),"\n",(0,i.jsxs)(n.li,{children:["Groups entries by list name into ",(0,i.jsx)(n.code,{children:"AddressListAggregate{Name, EntryCount, DynamicCount}"})]}),"\n",(0,i.jsxs)(n.li,{children:["Spawns a goroutine per list name to fetch ",(0,i.jsx)(n.code,{children:"ReferencingRulesCount"})," in parallel (",(0,i.jsx)(n.code,{children:"sync.WaitGroup"})," + ",(0,i.jsx)(n.code,{children:"sync.Mutex"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Default page size: 50 entries per page (cursor-based)"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type AddressListAggregate struct {\n    Name                 string\n    EntryCount           int\n    DynamicCount         int\n    ReferencingRulesCount int\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Other methods (following the same stateless pattern):"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Method"}),(0,i.jsx)(n.th,{children:"RouterOS Path"}),(0,i.jsx)(n.th,{children:"Action"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"GetEntries(ctx, port, listName, page)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/ip/firewall/address-list"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"print"})," with filter"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"AddEntry(ctx, port, input)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/ip/firewall/address-list"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"add"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RemoveEntry(ctx, port, id)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/ip/firewall/address-list"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"remove"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"GetFilterRules(ctx, port)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/ip/firewall/filter"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"print"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"GetNATRules(ctx, port)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/ip/firewall/nat"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"print"})})]})]})]}),"\n",(0,i.jsxs)(n.h4,{id:"natportforwardgo-and-natservicego",children:[(0,i.jsx)(n.code,{children:"nat/portforward.go"})," and ",(0,i.jsx)(n.code,{children:"nat/service.go"})]}),"\n",(0,i.jsx)(n.p,{children:"NAT port forwarding with structured input validation:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type PortForwardInput struct {\n    Protocol    string  // "tcp", "udp"\n    DstPort     int\n    ToAddresses string\n    ToPort      int\n    SrcAddress  string\n    Comment     string\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Validates port ranges and protocol before issuing ",(0,i.jsx)(n.code,{children:"/ip/firewall/nat add"})," commands."]}),"\n",(0,i.jsxs)(n.h4,{id:"portknockgo--port-knocking-service",children:[(0,i.jsx)(n.code,{children:"portknock.go"})," \u2014 Port Knocking Service"]}),"\n",(0,i.jsx)(n.p,{children:"Manages port knock sequences. Each sequence is a series of ports that must be contacted in order to open a firewall rule."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type KnockSequence struct {\n    Name    string\n    Ports   []KnockPort  // {Port, Protocol, Timeout}\n    Action  string       // firewall action to trigger\n    Comment string\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"internaldns",children:(0,i.jsx)(n.code,{children:"internal/dns"})}),"\n",(0,i.jsx)(n.p,{children:"Provides DNS lookup and benchmark operations through the router."}),"\n",(0,i.jsxs)(n.h4,{id:"servicego--service",children:[(0,i.jsx)(n.code,{children:"service.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"Service"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Service struct {\n    routerPort router.RouterPort\n}\n\nfunc NewService(rp router.RouterPort) *Service\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"PerformLookup(ctx, input *LookupInput) (*LookupResult, error)"})})}),"\n",(0,i.jsx)(n.p,{children:"Routing logic for DNS resolution:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type LookupInput struct {\n    Hostname   string\n    RecordType string   // "A", "AAAA", "MX", "TXT", "CNAME", "NS", "PTR"\n    Server     *string  // nil = use router\'s DNS\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Resolution strategy:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Condition"}),(0,i.jsx)(n.th,{children:"Method"}),(0,i.jsx)(n.th,{children:"Authoritative field"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"A"})," or ",(0,i.jsx)(n.code,{children:"AAAA"})," and no custom server"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"lookupViaRouterOS"})}),(0,i.jsx)(n.td,{children:"true if from router's static table"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Any other record type"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"lookupViaGoResolver"})}),(0,i.jsx)(n.td,{children:"always false (net package limitation)"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"lookupViaRouterOS"})," issues ",(0,i.jsx)(n.code,{children:"/ip dns cache print"})," or ",(0,i.jsx)(n.code,{children:"/ip dns static print"})," commands and parses the response. The ",(0,i.jsx)(n.code,{children:"authoritative"})," flag is set true when the answer comes from the router's own static DNS table."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"lookupViaGoResolver"})," uses Go's ",(0,i.jsx)(n.code,{children:"net.DefaultResolver"})," with a ",(0,i.jsx)(n.code,{children:"net.Resolver{PreferGo: true}"})," configured to use the specified server."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type LookupResult struct {\n    Hostname      string\n    RecordType    string\n    Status        string     // "NOERROR", "NXDOMAIN", "SERVFAIL", "TIMEOUT"\n    Records       []Record   // {Type, Value, TTL}\n    Server        string\n    QueryTime     int        // milliseconds\n    Authoritative bool\n    Error         *string\n    Timestamp     string     // RFC3339\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Benchmark support"})," (",(0,i.jsx)(n.code,{children:"dns_benchmark.go"}),"):"]}),"\n",(0,i.jsx)(n.p,{children:"Queries multiple DNS servers in parallel (up to 5 concurrent workers) and returns latency + result for each server:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type BenchmarkInput struct {\n    Hostname string\n    Servers  []string  // IP addresses or "router" for native lookup\n}\n\ntype BenchmarkResult struct {\n    Server    string\n    Latency   int     // milliseconds\n    Success   bool\n    Records   []Record\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"internalrouterscanner",children:(0,i.jsx)(n.code,{children:"internal/router/scanner"})}),"\n",(0,i.jsx)(n.p,{children:"Stateless network discovery \u2014 no service struct, just package-level functions."}),"\n",(0,i.jsx)(n.h4,{id:"scannergo",children:(0,i.jsx)(n.code,{children:"scanner.go"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type Device struct {\n    IP       string\n    Hostname string\n    Ports    []int\n    Type     string    // "mikrotik", "unknown"\n    Vendor   string    // "MikroTik", "unknown"\n    Services []string  // detected service names\n}\n\ntype Config struct {\n    MaxWorkers  int           // default: 20\n    Timeout     time.Duration // default: 2s\n    TargetPorts []int         // default: [80, 443, 8728, 8729, 8291]\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ScanIP(ctx, ip string, ports []int, timeout time.Duration) *Device"})})}),"\n",(0,i.jsx)(n.p,{children:"For a single IP address:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Spawns one goroutine per port (semaphore limit: 5 concurrent)"}),"\n",(0,i.jsxs)(n.li,{children:["Calls ",(0,i.jsx)(n.code,{children:"IsPortOpen(ctx, ip, port, timeout)"})," \u2014 TCP dial with deadline"]}),"\n",(0,i.jsx)(n.li,{children:"For port 80/443: HTTP GET to detect MikroTik via response headers/body"}),"\n",(0,i.jsx)(n.li,{children:"For port 8728/8729: Binary API handshake attempt to detect MikroTik"}),"\n",(0,i.jsxs)(n.li,{children:["Returns ",(0,i.jsx)(n.code,{children:"Device"})," with all open ports and detected vendor"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ParseIPRange(subnet string) ([]string, error)"})})}),"\n",(0,i.jsx)(n.p,{children:"Parses three formats:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["CIDR: ",(0,i.jsx)(n.code,{children:"192.168.88.0/24"})," \u2192 expands all host addresses"]}),"\n",(0,i.jsxs)(n.li,{children:["Dash range: ",(0,i.jsx)(n.code,{children:"192.168.1.1-192.168.1.50"})]}),"\n",(0,i.jsxs)(n.li,{children:["Single IP: ",(0,i.jsx)(n.code,{children:"192.168.88.1"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ScanSubnet(ctx, subnet string, cfg Config) ([]*Device, error)"})})," (in ",(0,i.jsx)(n.code,{children:"discovery.go"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Calls ",(0,i.jsx)(n.code,{children:"ParseIPRange"}),", then concurrently scans all IPs up to ",(0,i.jsx)(n.code,{children:"MaxWorkers"})," parallel goroutines."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Port-to-service mapping:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Port"}),(0,i.jsx)(n.th,{children:"Service"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"80"}),(0,i.jsx)(n.td,{children:"HTTP / MikroTik REST API"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"443"}),(0,i.jsx)(n.td,{children:"HTTPS"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"8728"}),(0,i.jsx)(n.td,{children:"MikroTik RouterOS API"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"8729"}),(0,i.jsx)(n.td,{children:"MikroTik RouterOS API (TLS)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"8291"}),(0,i.jsx)(n.td,{children:"MikroTik Winbox"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"internalservicesbridge",children:(0,i.jsx)(n.code,{children:"internal/services/bridge"})}),"\n",(0,i.jsx)(n.p,{children:"Bridge configuration service with 10-second undo support."}),"\n",(0,i.jsxs)(n.h4,{id:"servicego--service-1",children:[(0,i.jsx)(n.code,{children:"service.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"Service"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Service struct {\n    base.Service    // embeds Port() method and EnsureConnected()\n    eventBus  events.EventBus\n    undoStore *UndoStore   // 10-second undo window\n}\n\nfunc NewService(config base.ServiceConfig) *Service\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Every mutating operation follows the ",(0,i.jsx)(n.strong,{children:"read-snapshot \u2192 mutate \u2192 store-undo"})," pattern:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"CreateBridge(ctx, routerID, input *CreateBridgeInput) (*Data, string, error)"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// Builds args with base.NewCommandArgsBuilder()\n// Issues: /interface/bridge add name=... protocol=... priority=...\n// undoStore.Add("create", "bridge", nil)  \u2192 returns operationID\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"UpdateBridge(ctx, uuid, input *UpdateBridgeInput) (*Data, string, error)"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'previousState, _ := s.GetBridge(ctx, uuid)   // snapshot before change\n// Issues: /interface/bridge set .id=uuid protocol=... priority=...\nundoStore.Add("update", "bridge", previousState)  \u2192 operationID\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"DeleteBridge(ctx, uuid) (string, error)"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'previousState, _ := s.GetBridge(ctx, uuid)   // snapshot before delete\n// Issues: /interface/bridge remove .id=uuid\nundoStore.Add("delete", "bridge", previousState)  \u2192 operationID\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"UndoBridgeOperation(ctx, operationID) (*Data, error)"})})}),"\n",(0,i.jsxs)(n.p,{children:["Retrieves the stored ",(0,i.jsx)(n.code,{children:"UndoOperation"})," and reverses based on type:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Original op"}),(0,i.jsx)(n.th,{children:"Undo action"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"create"})}),(0,i.jsx)(n.td,{children:"not yet implemented"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"update"})}),(0,i.jsxs)(n.td,{children:["restore ",(0,i.jsx)(n.code,{children:"previousState"})," via ",(0,i.jsx)(n.code,{children:"UpdateBridge"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"delete"})}),(0,i.jsxs)(n.td,{children:["recreate via ",(0,i.jsx)(n.code,{children:"CreateBridge"})," with previous state"]})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["After successful undo: ",(0,i.jsx)(n.code,{children:"undoStore.Delete(operationID)"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"GetImpact(ctx, uuid) (*Impact, error)"})})}),"\n",(0,i.jsx)(n.p,{children:"Analyzes deletion impact without making changes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Impact struct {\n    PortsToRelease      []string\n    IPAddressesToRemove []string\n    DHCPServersAffected []string\n    RoutesAffected      []string\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"GetBridges"})})," additionally fetches ports, VLANs, and STP status for each bridge (3 extra commands per bridge):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"/interface/bridge/port print\n/interface/bridge/vlan print\n/interface/bridge/host print  (for STP)\n"})}),"\n",(0,i.jsx)(n.h4,{id:"undostore",children:(0,i.jsx)(n.code,{children:"UndoStore"})}),"\n",(0,i.jsx)(n.p,{children:"In-memory store with 10-second TTL. Operations are automatically expired."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type UndoOperation struct {\n    ID            string\n    Type          string    // "create", "update", "delete"\n    ResourceType  string    // "bridge", "port", "vlan"\n    PreviousState []byte    // JSON-encoded previous state\n    CreatedAt     time.Time\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"internaltroubleshoot",children:(0,i.jsx)(n.code,{children:"internal/troubleshoot"})}),"\n",(0,i.jsx)(n.p,{children:"Session-based internet connectivity diagnostics with fix suggestions and automated fix application."}),"\n",(0,i.jsxs)(n.h4,{id:"servicego--service-2",children:[(0,i.jsx)(n.code,{children:"service.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"Service"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Service struct {\n    sessionStore       *SessionStore\n    routerPort         router.RouterPort\n    circuitBreakerDiag *diagnostics.CircuitBreakerDiagnostics\n    dnsDiag            *diagnostics.DNSDiagnostics\n    routeLookupDiag    *diagnostics.RouteLookupDiagnostics\n    logger             *zap.Logger\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Session lifecycle:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'StartTroubleshoot(ctx, routerID)\n    \u2192 sessionStore.Create(routerID)            // generates random session ID\n    \u2192 DetectNetworkConfig(ctx, routerID)       // discovers WAN interface + gateway\n    \u2192 session.Status = SessionStatusRunning\n    \u2192 return session (with 5 pre-initialized steps)\n\nRunTroubleshootStep(ctx, sessionID, stepType)\n    \u2192 sessionStore.Get(sessionID)\n    \u2192 step.Status = StepStatusRunning\n    \u2192 executeDiagnosticCheck(ctx, stepType, wanInterface, gateway)\n    \u2192 step.Status = StepStatusPassed | StepStatusFailed\n    \u2192 if failed: step.Fix = GetFix(result.IssueCode)\n    \u2192 return step\n\nApplyTroubleshootFix(ctx, sessionID, issueCode)\n    \u2192 GetFix(issueCode)\n    \u2192 if fix.IsManualFix || fix.Command == "": return FixStatusAvailable\n    \u2192 session.Status = SessionStatusApplyingFix\n    \u2192 executeFixCommand(ctx, routerID, fix.Command)\n    \u2192 session.AppliedFixes = append(..., issueCode)\n    \u2192 return FixStatusApplied\n\nCancelTroubleshoot(ctx, sessionID)\n    \u2192 session.Status = SessionStatusCanceled\n    \u2192 session.CompletedAt = time.Now()\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Step types and their diagnostic backends:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"StepType"}),(0,i.jsx)(n.th,{children:"Diagnostic"}),(0,i.jsx)(n.th,{children:"What it checks"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"StepTypeWAN"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CircuitBreakerDiagnostics.CheckWAN"})}),(0,i.jsx)(n.td,{children:"WAN interface link status"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"StepTypeGateway"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CircuitBreakerDiagnostics.CheckGateway"})}),(0,i.jsx)(n.td,{children:"Gateway reachability (ping)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"StepTypeInternet"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CircuitBreakerDiagnostics.CheckInternet"})}),(0,i.jsx)(n.td,{children:"External internet reachability"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"StepTypeDNS"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DNSDiagnostics.CheckDNS"})}),(0,i.jsx)(n.td,{children:"DNS resolution correctness"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"StepTypeNAT"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CircuitBreakerDiagnostics.CheckNAT"})}),(0,i.jsx)(n.td,{children:"NAT masquerade rule presence"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Session statuses:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"SessionStatusIdle         // just created\nSessionStatusInitializing // detecting network config\nSessionStatusRunning      // steps can be executed\nSessionStatusApplyingFix  // fix command in progress\nSessionStatusCompleted    // all steps done\nSessionStatusCanceled     // user canceled\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Step statuses:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"StepStatusPending  // not yet run\nStepStatusRunning  // currently executing\nStepStatusPassed   // diagnostic passed\nStepStatusFailed   // diagnostic failed, Fix populated\nStepStatusSkipped  // not applicable\n"})}),"\n",(0,i.jsxs)(n.h4,{id:"session_storego--sessionstore",children:[(0,i.jsx)(n.code,{children:"session_store.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"SessionStore"})]}),"\n",(0,i.jsx)(n.p,{children:"In-memory, thread-safe session store. Sessions expire after 1 hour via a background cleanup goroutine."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type SessionStore struct {\n    sessions   map[string]*Session\n    sessionTTL time.Duration  // 1 hour\n    mu         sync.RWMutex\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Session IDs are generated as 16-byte random hex strings (",(0,i.jsx)(n.code,{children:"crypto/rand"}),")."]}),"\n",(0,i.jsxs)(n.h4,{id:"diagnostics-sub-package",children:[(0,i.jsx)(n.code,{children:"diagnostics/"})," sub-package"]}),"\n",(0,i.jsxs)(n.p,{children:["Three diagnostic engines, each operating via ",(0,i.jsx)(n.code,{children:"RouterPort"}),":"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"circuit_breaker.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"CircuitBreakerDiagnostics"})]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func (d *CircuitBreakerDiagnostics) CheckWAN(ctx, wanInterface) (*StepResult, error)\nfunc (d *CircuitBreakerDiagnostics) CheckGateway(ctx, gateway) (*StepResult, error)\nfunc (d *CircuitBreakerDiagnostics) CheckInternet(ctx) (*StepResult, error)\nfunc (d *CircuitBreakerDiagnostics) CheckNAT(ctx, wanInterface) (*StepResult, error)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Each returns ",(0,i.jsx)(n.code,{children:"StepResult{Success, Message, Details, ExecutionTimeMs, IssueCode, Target}"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"dns.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"DNSDiagnostics"})]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func (d *DNSDiagnostics) CheckDNS(ctx) (*StepResult, error)\n"})}),"\n",(0,i.jsx)(n.p,{children:"Tests DNS by resolving a known hostname and checking for valid answers."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"route_lookup.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"RouteLookupDiagnostics"})]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func (d *RouteLookupDiagnostics) DetectNetworkConfig(ctx, routerID) (*NetworkConfig, error)\nfunc (d *RouteLookupDiagnostics) DetectWanInterface(ctx, routerID) (string, error)\nfunc (d *RouteLookupDiagnostics) DetectGateway(ctx, routerID) (string, error)\nfunc (d *RouteLookupDiagnostics) DetectISP(ctx, wanIP) (*ISPInfo, error)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"DetectWanInterface"})," queries ",(0,i.jsx)(n.code,{children:"/ip/route/print"})," for the default route (",(0,i.jsx)(n.code,{children:"dst-address=0.0.0.0/0"}),") and extracts the ",(0,i.jsx)(n.code,{children:"gateway-interface"})," field."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"DetectISP"})," makes an HTTP call to ",(0,i.jsx)(n.code,{children:"ip-api.com"})," with the router's WAN IP to retrieve ISP name, phone, and URL."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"internalservicesnetif",children:(0,i.jsx)(n.code,{children:"internal/services/netif"})}),"\n",(0,i.jsx)(n.p,{children:"Network interface IP address management."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ip_address_service.go"})})," \u2014 CRUD for IP addresses assigned to interfaces:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// GetIPAddresses(ctx, port, interfaceName) \u2014 /ip/address print where interface=name\n// AddIPAddress(ctx, port, input)           \u2014 /ip/address add address=... interface=...\n// RemoveIPAddress(ctx, port, id)           \u2014 /ip/address remove .id=...\n// SetIPAddress(ctx, port, id, input)       \u2014 /ip/address set .id=...\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ip_conflicts.go"})})," \u2014 Detects conflicting IP addresses across interfaces by comparing assigned addresses and checking for overlapping subnets."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"internalservicesnetworkingvlan",children:(0,i.jsx)(n.code,{children:"internal/services/networking/vlan"})}),"\n",(0,i.jsx)(n.p,{children:"VLAN registry and allocation."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"operations.go"})})," \u2014 Manages VLAN IDs across bridges and interfaces:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// AllocateVLAN(ctx, db, bridgeName, purpose) \u2192 VLANAllocation{ID, VLAN, Bridge}\n// ReleaseVLAN(ctx, db, vlanID)\n// GetVLANRegistry(ctx, db) \u2192 []VLANRegistryEntry\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Uses the ent-backed ",(0,i.jsx)(n.code,{children:"VLANAllocationRepository"})," from ",(0,i.jsx)(n.code,{children:"internal/adapters/ent_vlan_allocation_repo.go"}),"."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,i.jsx)(n.h3,{id:"firewall-address-list-query",children:"Firewall Address List Query"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'resolver \u2192 firewall.GetAddressLists(ctx, port)\n         \u2192 fetchAddressListEntries(ctx, port)\n             \u2192 port.ExecuteCommand({Path: "/ip/firewall/address-list", Action: "print"})\n             \u2192 parse response \u2192 []AddressListEntry\n         \u2192 group by name \u2192 map[name]*AddressListAggregate\n         \u2192 for each name: goroutine \u2192 fetchRules(ctx, port, name) \u2192 count rules\n         \u2192 wg.Wait()\n         \u2192 return []AddressListAggregate\n'})}),"\n",(0,i.jsx)(n.h3,{id:"dns-lookup-routeros-native-a-record",children:"DNS Lookup (RouterOS native A record)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'resolver \u2192 dns.PerformLookup(ctx, &LookupInput{Hostname: "google.com", RecordType: "A"})\n         \u2192 s.resolveServer(ctx, input) \u2192 "" (router\'s own DNS)\n         \u2192 input.RecordType == "A" && server == "" \u2192 lookupViaRouterOS(ctx, input)\n             \u2192 port.ExecuteCommand({Path: "/ip/dns/cache", Action: "print"})\n             \u2192 parse response \u2192 records, authoritative\n         \u2192 return LookupResult{Records, QueryTime, Authoritative}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"troubleshoot-session-flow",children:"Troubleshoot Session Flow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'resolver \u2192 troubleshoot.StartTroubleshoot(ctx, routerID)\n         \u2192 session created (5 pending steps: WAN, Gateway, Internet, DNS, NAT)\n         \u2192 DetectNetworkConfig \u2192 discover WAN iface + gateway from routing table\n\nresolver \u2192 RunTroubleshootStep(ctx, sessionID, StepTypeGateway)\n         \u2192 step.Status = running\n         \u2192 circuitBreakerDiag.CheckGateway(ctx, session.Gateway)\n             \u2192 port.ExecuteCommand({Path: "/tool/ping", ...})\n         \u2192 step.Status = passed | failed\n         \u2192 if failed: GetFix("NO_GATEWAY_REPLY") \u2192 FixSuggestion{Command, IsManualFix}\n\nresolver \u2192 ApplyTroubleshootFix(ctx, sessionID, "NO_GATEWAY_REPLY")\n         \u2192 fix.Command \u2192 parseRouterOSCommand \u2192 router.Command\n         \u2192 port.ExecuteCommand(cmd)\n         \u2192 session.AppliedFixes = ["NO_GATEWAY_REPLY"]\n'})}),"\n",(0,i.jsx)(n.h3,{id:"network-scan-flow",children:"Network Scan Flow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'resolver \u2192 scanner.ScanSubnet(ctx, "192.168.88.0/24", DefaultConfig())\n         \u2192 ParseIPRange("192.168.88.0/24") \u2192 []string{all 254 host IPs}\n         \u2192 semaphore (MaxWorkers=20)\n         \u2192 for each ip: goroutine \u2192 ScanIP(ctx, ip, [80,443,8728,8729,8291], 2s)\n             \u2192 for each port: goroutine (semaphore=5) \u2192 IsPortOpen (TCP dial)\n             \u2192 if port 8728 open: MikroTik binary API probe \u2192 vendor = "MikroTik"\n             \u2192 if port 80 open: HTTP GET, check response headers\n         \u2192 collect []Device\n         \u2192 return []Device (MikroTik devices + other open-port devices)\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Setting"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Package"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Scanner max workers"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"20"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"router/scanner.DefaultConfig()"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Scanner port timeout"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"2s"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"router/scanner.DefaultConfig()"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Scanner target ports"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"[80, 443, 8728, 8729, 8291]"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"router/scanner.DefaultConfig()"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Scanner per-IP concurrency"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"5"})," (semaphore)"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"scanner.ScanIP"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"DNS benchmark concurrency"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"5"})," workers"]}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"dns"})," package"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Bridge undo TTL"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"10 seconds"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UndoStore"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Troubleshoot session TTL"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"1 hour"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"SessionStore"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"DNS lookup timeout"}),(0,i.jsx)(n.td,{children:"inherits from RouterPort context"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"dns.Service"})})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Firewall services"})," return wrapped errors with operation context:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'fmt.Errorf("failed to fetch address list entries: %w", err)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["A ",(0,i.jsx)(n.code,{children:"nil"})," ",(0,i.jsx)(n.code,{children:"RouterPort"})," passed to stateless services returns an immediate error without panicking."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"DNS service"})," never returns an error for lookup failures \u2014 it encodes the failure in ",(0,i.jsx)(n.code,{children:"LookupResult.Status"})," and ",(0,i.jsx)(n.code,{children:"LookupResult.Error"}),". Only structural errors (nil input, missing hostname) return a Go error."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Scanner"})," returns ",(0,i.jsx)(n.code,{children:"nil"})," for an IP if context is canceled before scanning completes. The caller (subnet scan) skips nil results."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Troubleshoot service"})," returns typed sentinel errors:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'var (\n    ErrStepNotFound        = errors.New("diagnostic step not found")\n    ErrFixNotFound         = errors.New("fix not found for issue code")\n    ErrUnknownStepType     = errors.New("unknown diagnostic step type")\n    ErrNilDiagnosticResult = errors.New("diagnostic check returned nil result")\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Fix application returns ",(0,i.jsx)(n.code,{children:"(success bool, message string, status FixApplicationStatus, err error)"}),' \u2014 distinguishing between "fix not available" (',(0,i.jsx)(n.code,{children:"FixStatusAvailable"}),', no error) and "fix failed" (',(0,i.jsx)(n.code,{children:"FixStatusFailed"}),", with error)."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Firewall tests"})," use mock ",(0,i.jsx)(n.code,{children:"RouterPort"})," that returns pre-canned command results; parallel goroutine tests verify the ",(0,i.jsx)(n.code,{children:"sync.WaitGroup"})," pattern"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Scanner tests"})," use ",(0,i.jsx)(n.code,{children:"net.Listener"})," on random ports to simulate open ports; ",(0,i.jsx)(n.code,{children:"ParseIPRange"})," has table-driven unit tests for all three input formats"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"DNS tests"})," mock ",(0,i.jsx)(n.code,{children:"RouterPort"})," for RouterOS-native path; Go resolver path tested with real DNS or a local DNS server fixture"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Troubleshoot tests"})," use mock diagnostic engines returning controlled ",(0,i.jsx)(n.code,{children:"StepResult"}),"; session store tested for TTL expiry and concurrent access"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Bridge service tests"})," verify the undo chain: create \u2192 undo, update \u2192 undo, delete \u2192 undo; ",(0,i.jsx)(n.code,{children:"UndoStore"})," TTL tested with a fast clock"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["[See: 04-router-communication.md \xa7RouterPort Interface] \u2014 the ",(0,i.jsx)(n.code,{children:"RouterPort"})," that all services operate through"]}),"\n",(0,i.jsx)(n.li,{children:"[See: 04-router-communication.md \xa7Batch Executor] \u2014 batch commands used for bulk firewall rule imports"}),"\n",(0,i.jsx)(n.li,{children:"[See: 08-provisioning-engine.md \xa7Network Provisioning] \u2014 how provisioning stages call firewall and bridge services"}),"\n",(0,i.jsx)(n.li,{children:"[See: 06-service-orchestrator.md \xa7VIF System] \u2014 VIF uses bridge service for interface creation"}),"\n",(0,i.jsxs)(n.li,{children:["Pattern reference: ",(0,i.jsx)(n.code,{children:"Docs/architecture/backend-architecture.md \xa7Service Layer"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var s=r(14041);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);