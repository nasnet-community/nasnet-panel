"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[38493],{55396:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"state-management/apollo-client","title":"Apollo Client Configuration","description":"Source: libs/api-client/core/src/apollo/","source":"@site/../connect/docs/state-management/apollo-client.md","sourceDirName":"state-management","slug":"/state-management/apollo-client","permalink":"/docs/frontend/state-management/apollo-client","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../connect/docs/state-management/apollo-client.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Storybook Guide","permalink":"/docs/frontend/operations/storybook"},"next":{"title":"Drift Detection System","permalink":"/docs/frontend/state-management/drift-detection"}}');var s=r(31085),t=r(71184);const c={},l="Apollo Client Configuration",o={},d=[{value:"Link Chain",id:"link-chain",level:2},{value:"Auth Link",id:"auth-link",level:3},{value:"Error Link",id:"error-link",level:3},{value:"Retry Link",id:"retry-link",level:3},{value:"Split Link",id:"split-link",level:3},{value:"WebSocket Client",id:"websocket-client",level:2},{value:"Cache Configuration",id:"cache-configuration",level:2},{value:"Resource Type Policies",id:"resource-type-policies",level:3},{value:"Pagination Policies",id:"pagination-policies",level:3},{value:"Router Type Policy",id:"router-type-policy",level:3},{value:"Default Fetch Policies",id:"default-fetch-policies",level:2},{value:"Cache Persistence",id:"cache-persistence",level:2},{value:"Apollo Provider",id:"apollo-provider",level:2},{value:"Mock Provider for Tests",id:"mock-provider-for-tests",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"apollo-client-configuration",children:"Apollo Client Configuration"})}),"\n",(0,s.jsxs)(n.p,{children:["Source: ",(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/"})]}),"\n",(0,s.jsxs)(n.p,{children:["Apollo Client is configured as a singleton instance exported from ",(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-client.ts"}),". It assembles a link chain, an in-memory cache with custom type policies, and default fetch-policy options."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"link-chain",children:"Link Chain"}),"\n",(0,s.jsx)(n.p,{children:"The full request pipeline is:"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph LR\n    A["Request"] --\x3e B["errorLink"]\n    B --\x3e C["retryLink"]\n    C --\x3e D["splitLink"]\n    D --\x3e|subscription| E["wsLink<br/>(WebSocket)"]\n    D --\x3e|query/mutation| F["authLink"]\n    F --\x3e G["httpLink"]\n    G --\x3e H["Server"]'}),"\n",(0,s.jsxs)(n.p,{children:["Defined in ",(0,s.jsx)(n.code,{children:"apollo-client.ts"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const link = from([errorLink, retryLink, splitLink]);\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each link has a focused responsibility:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Link"}),(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Responsibility"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"errorLink"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"apollo-error-link.ts"})}),(0,s.jsx)(n.td,{children:"Catch GraphQL and network errors, show notifications, clear auth on 401"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"retryLink"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"apollo-retry-link.ts"})}),(0,s.jsx)(n.td,{children:"Retry transient network failures with exponential backoff"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"splitLink"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"apollo-client.ts"})," (inline)"]}),(0,s.jsx)(n.td,{children:"Route subscriptions to WebSocket, everything else to HTTP"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"authLink"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"apollo-auth-link.ts"})}),(0,s.jsxs)(n.td,{children:["Inject ",(0,s.jsx)(n.code,{children:"X-Router-Id"})," and ",(0,s.jsx)(n.code,{children:"Authorization"})," headers"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"httpLink"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"apollo-client.ts"})," (inline)"]}),(0,s.jsxs)(n.td,{children:["Send HTTP requests to ",(0,s.jsx)(n.code,{children:"/graphql"})," with credentials included"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"wsLink"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"apollo-ws-client.ts"})}),(0,s.jsxs)(n.td,{children:["WebSocket transport for subscriptions via ",(0,s.jsx)(n.code,{children:"graphql-ws"})]})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"auth-link",children:"Auth Link"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-auth-link.ts"})}),"\n",(0,s.jsx)(n.p,{children:"Injects two headers on every query and mutation:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"X-Router-Id"})," \u2014 the currently active router ID, read from ",(0,s.jsx)(n.code,{children:"useConnectionStore.getState().currentRouterId"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Authorization"})," \u2014 either a ",(0,s.jsx)(n.code,{children:"Bearer <jwt>"})," from ",(0,s.jsx)(n.code,{children:"useAuthStore"})," (via ",(0,s.jsx)(n.code,{children:"getAuthToken()"}),"), or ",(0,s.jsx)(n.code,{children:"Basic <base64>"})," from router credentials stored in ",(0,s.jsx)(n.code,{children:"sessionStorage"})," keyed as ",(0,s.jsx)(n.code,{children:"router-credentials-<routerId>"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"export const authLink = setContext((_, { headers }) => {\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorizationHeader(currentRouterId);\n\n  return {\n    headers: {\n      ...headers,\n      'X-Router-Id': currentRouterId || '',\n      ...(authorization && { Authorization: authorization }),\n    },\n  };\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"The auth priority is: JWT Bearer token first, Basic auth second. This enables both the JWT-authenticated admin flow and the legacy Basic auth flow used for direct router access."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"error-link",children:"Error Link"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-error-link.ts"})}),"\n",(0,s.jsx)(n.p,{children:"Handles all GraphQL and network errors centrally:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"GraphQL error codes handled:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Code"}),(0,s.jsx)(n.th,{children:"Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"UNAUTHENTICATED"})}),(0,s.jsxs)(n.td,{children:["Calls ",(0,s.jsx)(n.code,{children:"useAuthStore.getState().clearAuth()"}),", dispatches ",(0,s.jsx)(n.code,{children:"auth:expired"})," event"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FORBIDDEN"})}),(0,s.jsx)(n.td,{children:'Shows "Access denied" notification'})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NOT_FOUND"})}),(0,s.jsx)(n.td,{children:'Shows "Not found" warning notification'})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"VALIDATION_FAILED"})," (and A5xx variants)"]}),(0,s.jsx)(n.td,{children:"Skipped \u2014 left to form-level handling"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Other codes"}),(0,s.jsxs)(n.td,{children:["Maps through ",(0,s.jsx)(n.code,{children:"getErrorInfo()"})," for user-friendly messages"]})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"HTTP status codes handled:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Status"}),(0,s.jsx)(n.th,{children:"Action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"401"}),(0,s.jsxs)(n.td,{children:["Same as ",(0,s.jsx)(n.code,{children:"UNAUTHENTICATED"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"403"}),(0,s.jsx)(n.td,{children:'Shows "Access denied" notification'})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Other"}),(0,s.jsx)(n.td,{children:'Shows generic "Network error" notification'})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Custom error links can be created via ",(0,s.jsx)(n.code,{children:"createErrorLink(options)"})," for testing or isolated components."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"retry-link",children:"Retry Link"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-retry-link.ts"})}),"\n",(0,s.jsxs)(n.p,{children:["Retries ",(0,s.jsx)(n.strong,{children:"network errors only"})," (not GraphQL errors). Client errors (4xx) are never retried."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"export const retryLink = new RetryLink({\n  delay: {\n    initial: 300,   // ms before first retry\n    max: 3000,      // ms maximum delay\n    jitter: true,   // adds random jitter\n  },\n  attempts: {\n    max: 3,\n    retryIf: (error) => {\n      const isNetworkError = !!error && !error.result;\n      const isClientError = typeof error?.statusCode === 'number'\n        && error.statusCode >= 400 && error.statusCode < 500;\n      return isNetworkError && !isClientError;\n    },\n  },\n});\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"split-link",children:"Split Link"}),"\n",(0,s.jsxs)(n.p,{children:["Defined inline in ",(0,s.jsx)(n.code,{children:"apollo-client.ts"}),". Routes operations based on type:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const splitLink = split(\n  ({ query }) => {\n    const definition = getMainDefinition(query);\n    return (\n      definition.kind === 'OperationDefinition' &&\n      definition.operation === 'subscription'\n    );\n  },\n  wsLink,\n  authLink.concat(httpLink)\n);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note that ",(0,s.jsx)(n.code,{children:"authLink"})," is only composed with ",(0,s.jsx)(n.code,{children:"httpLink"}),", not ",(0,s.jsx)(n.code,{children:"wsLink"}),". The WebSocket client handles its own authentication via ",(0,s.jsx)(n.code,{children:"connectionParams"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"websocket-client",children:"WebSocket Client"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-ws-client.ts"})}),"\n",(0,s.jsxs)(n.p,{children:["Uses ",(0,s.jsx)(n.code,{children:"graphql-ws"})," with the ",(0,s.jsx)(n.code,{children:"createClient"})," factory. The default export ",(0,s.jsx)(n.code,{children:"wsClient"})," is created with ",(0,s.jsx)(n.code,{children:"createWsClient()"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"URL detection:"})," Automatically uses ",(0,s.jsx)(n.code,{children:"wss:"})," when the page is served over HTTPS, ",(0,s.jsx)(n.code,{children:"ws:"})," otherwise."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Authentication:"})," On each connection (and reconnection), ",(0,s.jsx)(n.code,{children:"connectionParams"})," is called to re-read current credentials:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"connectionParams: () => {\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorization(currentRouterId);\n  return { routerId: currentRouterId, authorization };\n},\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Reconnection strategy:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Attempt"}),(0,s.jsx)(n.th,{children:"Delay (approx.)"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:"~1 s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:"~2 s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"~4 s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"4"}),(0,s.jsx)(n.td,{children:"~8 s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"5"}),(0,s.jsx)(n.td,{children:"~16 s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"6+"}),(0,s.jsx)(n.td,{children:"~30 s (capped)"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Maximum 10 attempts. Does ",(0,s.jsx)(n.strong,{children:"not"})," retry on close codes ",(0,s.jsx)(n.code,{children:"4401"})," (auth failed) or ",(0,s.jsx)(n.code,{children:"4403"})," (forbidden)."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Connection lifecycle events"})," update ",(0,s.jsx)(n.code,{children:"useConnectionStore"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Event"}),(0,s.jsx)(n.th,{children:"Store action"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"connecting"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"setWsStatus('connecting')"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"connected"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"setWsStatus('connected')"}),", ",(0,s.jsx)(n.code,{children:"resetReconnection()"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"closed"})," (unclean)"]}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"setWsStatus('error', reason)"}),", ",(0,s.jsx)(n.code,{children:"incrementReconnectAttempts()"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"error"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"setWsStatus('error', message)"})})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cache-configuration",children:"Cache Configuration"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-client.ts"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"InMemoryCache"})," uses:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"possibleTypes"})," from codegen output for union/interface resolution"]}),"\n",(0,s.jsx)(n.li,{children:"Custom type policies for resources and pagination"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"resource-type-policies",children:"Resource Type Policies"}),"\n",(0,s.jsxs)(n.p,{children:["All resources are keyed by ",(0,s.jsx)(n.code,{children:"uuid"})," (ULID), not ",(0,s.jsx)(n.code,{children:"id"}),". This is required because the Universal State v2 model uses ULIDs as stable identifiers."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"Resource: {\n  keyFields: ['uuid'],\n  fields: {\n    runtime: {\n      merge(existing, incoming) {\n        return { ...existing, ...incoming }; // Merge, don't replace\n      },\n    },\n    telemetry: {\n      merge(existing, incoming) {\n        return {\n          ...existing,\n          ...incoming,\n          // Append bandwidth history, cap at 288 entries (24h at 5-min intervals)\n          bandwidthHistory: [\n            ...(existing.bandwidthHistory ?? []),\n            ...(incoming.bandwidthHistory ?? []),\n          ].slice(-288),\n        };\n      },\n    },\n    deployment: { merge: false }, // Always replace\n    validation: { merge: false }, // Always replace\n  },\n},\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Merge strategy by layer:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Layer"}),(0,s.jsx)(n.th,{children:"Strategy"}),(0,s.jsx)(n.th,{children:"Reason"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"runtime"})}),(0,s.jsx)(n.td,{children:"Merge"}),(0,s.jsx)(n.td,{children:"Real-time metrics; incoming may be partial updates"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"telemetry"})}),(0,s.jsx)(n.td,{children:"Merge + append"}),(0,s.jsx)(n.td,{children:"History should accumulate"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"deployment"})}),(0,s.jsx)(n.td,{children:"Replace"}),(0,s.jsx)(n.td,{children:"Applied state snapshot; must be authoritative"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"validation"})}),(0,s.jsx)(n.td,{children:"Replace"}),(0,s.jsx)(n.td,{children:"Latest validation result is the only relevant one"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"pagination-policies",children:"Pagination Policies"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"Query: {\n  fields: {\n    routers: {\n      keyArgs: ['filter'],\n      merge(existing, incoming) { return incoming; }, // Replace for now\n    },\n    resources: {\n      keyArgs: ['routerId', 'category', 'type', 'state'],\n      merge(existing, incoming) { return incoming; },\n    },\n  },\n},\n"})}),"\n",(0,s.jsx)(n.h3,{id:"router-type-policy",children:"Router Type Policy"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"Router: {\n  keyFields: ['id'],\n  fields: {\n    status: { merge: true }, // Preserve partial runtime updates\n  },\n},\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"default-fetch-policies",children:"Default Fetch Policies"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"defaultOptions: {\n  watchQuery: {\n    fetchPolicy: 'cache-and-network',  // Return cache immediately, refresh in background\n    nextFetchPolicy: 'cache-first',    // Subsequent renders use cache\n    errorPolicy: 'all',                // Return partial data on error\n  },\n  query: {\n    fetchPolicy: 'cache-first',\n    errorPolicy: 'all',\n  },\n  mutate: {\n    errorPolicy: 'all',\n  },\n},\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cache-persistence",children:"Cache Persistence"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-cache-persist.ts"})}),"\n",(0,s.jsxs)(n.p,{children:["Optional IndexedDB persistence via ",(0,s.jsx)(n.code,{children:"apollo3-cache-persist"})," and ",(0,s.jsx)(n.code,{children:"localforage"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { initializeCachePersistence, apolloCache } from '@nasnet/api-client/core';\n\n// Call before first render to hydrate cache from storage\nawait initializeCachePersistence(apolloCache, {\n  maxSize: 5 * 1024 * 1024, // 5 MB\n  debounce: 1000,           // Write to storage after 1s of inactivity\n  key: 'nasnet-apollo-cache',\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"To clear on logout:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { clearPersistedCache } from '@nasnet/api-client/core';\n\nawait clearPersistedCache();\napolloClient.clearStore();\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Storage driver priority:"})," IndexedDB \u2192 localStorage (automatic fallback via localforage)."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"apollo-provider",children:"Apollo Provider"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-provider.tsx"})}),"\n",(0,s.jsxs)(n.p,{children:["Wraps the app with ",(0,s.jsx)(n.code,{children:"ApolloProvider"})," using the pre-configured ",(0,s.jsx)(n.code,{children:"apolloClient"})," singleton. Import from ",(0,s.jsx)(n.code,{children:"@nasnet/api-client/core"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"mock-provider-for-tests",children:"Mock Provider for Tests"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"libs/api-client/core/src/apollo/apollo-mock-provider.tsx"})}),"\n",(0,s.jsxs)(n.p,{children:["Used in Storybook and unit tests to provide a mock Apollo client without making real network requests. Accepts ",(0,s.jsx)(n.code,{children:"mocks"})," for ",(0,s.jsx)(n.code,{children:"MockedProvider"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>l});var i=r(14041);const s={},t=i.createContext(s);function c(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);