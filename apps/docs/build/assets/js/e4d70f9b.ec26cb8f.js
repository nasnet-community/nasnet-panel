"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[63148],{20726:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"virtual-interface-factory","title":"Virtual Interface Factory (VIF)","description":"Transforms service instances into routable VLAN-isolated network interfaces on MikroTik routers, enabling per-device traffic steering through services like Tor, sing-box, and Xray.","source":"@site/../backend/docs/virtual-interface-factory.md","sourceDirName":".","slug":"/virtual-interface-factory","permalink":"/docs/backend/virtual-interface-factory","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/virtual-interface-factory.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Validation Pipeline","permalink":"/docs/backend/validation-pipeline"}}');var t=r(31085),s=r(71184);const c={},l="Virtual Interface Factory (VIF)",a={},o=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>vif</code> (core)",id:"vif-core",level:3},{value:"<code>vif/routing</code>",id:"vifrouting",level:3},{value:"<code>vif/traffic</code>",id:"viftraffic",level:3},{value:"<code>vif/isolation</code>",id:"vifisolation",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Service Instance Setup (Full VIF Pipeline)",id:"service-instance-setup-full-vif-pipeline",level:3},{value:"Kill Switch Activation",id:"kill-switch-activation",level:3},{value:"Multi-Hop Chain",id:"multi-hop-chain",level:3},{value:"VLAN ID Allocation",id:"vlan-id-allocation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"virtual-interface-factory-vif",children:"Virtual Interface Factory (VIF)"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Transforms service instances into routable VLAN-isolated network interfaces on MikroTik routers, enabling per-device traffic steering through services like Tor, sing-box, and Xray."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Packages:"})," ",(0,t.jsx)(n.code,{children:"internal/vif/"}),", ",(0,t.jsx)(n.code,{children:"internal/vif/routing/"}),", ",(0,t.jsx)(n.code,{children:"internal/vif/traffic/"}),", ",(0,t.jsx)(n.code,{children:"internal/vif/isolation/"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Key Files:"})," ",(0,t.jsx)(n.code,{children:"vif/types.go"}),", ",(0,t.jsx)(n.code,{children:"vif/interface_factory.go"}),", ",(0,t.jsx)(n.code,{children:"vif/bridge.go"}),", ",(0,t.jsx)(n.code,{children:"vif/gateway_manager.go"}),", ",(0,t.jsx)(n.code,{children:"vif/gateway_config.go"}),", ",(0,t.jsx)(n.code,{children:"routing/chain_router.go"}),", ",(0,t.jsx)(n.code,{children:"routing/pbr_engine.go"}),", ",(0,t.jsx)(n.code,{children:"traffic/aggregator.go"}),", ",(0,t.jsx)(n.code,{children:"traffic/quota_enforcer.go"}),", ",(0,t.jsx)(n.code,{children:"isolation/kill_switch_listener.go"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Prerequisites:"})," [See: 06-service-orchestrator.md \xa7BridgeOrchestrator], [See: 04-router-communication.md \xa7RouterPort]"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"The Virtual Interface Factory (VIF) is a core architectural innovation that solves a fundamental challenge: how do you route specific client devices through a privacy service (Tor, VPN, proxy) running inside a container on the router, while keeping other devices on the normal internet?"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"The answer: VLAN-isolated virtual interfaces with policy-based routing."})}),"\n",(0,t.jsx)(n.p,{children:"Each service instance gets:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["A dedicated ",(0,t.jsx)(n.strong,{children:"VLAN interface"})," on the MikroTik router (e.g., ",(0,t.jsx)(n.code,{children:"nnc-tor-myrelay"}),", VLAN ID 42)"]}),"\n",(0,t.jsxs)(n.li,{children:["An ",(0,t.jsx)(n.strong,{children:"IP address"})," in the ",(0,t.jsx)(n.code,{children:"10.99.x.0/24"})," space (e.g., ",(0,t.jsx)(n.code,{children:"10.99.42.1/24"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.strong,{children:"dedicated routing table"})," with a default route through the service"]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.strong,{children:"mangle rule"})," per assigned device (MAC \u2192 routing mark \u2192 routing table)"]}),"\n",(0,t.jsxs)(n.li,{children:["An optional ",(0,t.jsx)(n.strong,{children:"TUN gateway"})," (hev-socks5-tunnel) to bridge SOCKS5 \u2192 TUN"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"[See: ADR 007 \u2014 IP Binding Isolation] and [See: ADR 012 \u2014 Universal State v2] for design rationale."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["Client Device<br/>MAC: aa:bb:cc:dd:ee:ff"]\n    B["MikroTik mangle rule<br/>src-mac=aa:bb:cc:dd:ee:ff<br/>\u2192 mark-routing=tor-myrelay"]\n    C["Routing Table: tor-myrelay<br/>default route \u2192 gateway 10.99.42.2"]\n    D["VLAN Interface: nnc-tor-myrelay<br/>VLAN 42 on ether1<br/>IP: 10.99.42.1/24"]\n    E["optional TUN gateway<br/>hev-socks5-tunnel"]\n    F["GatewayManager<br/>TUN interface: tun-tor-myrelay<br/>bridges SOCKS5 \u2192 kernel TUN"]\n    G["Service Process<br/>e.g., Tor, sing-box<br/>SOCKS5 on 10.99.42.2:1080"]\n    H["Internet<br/>via Tor network / VPN / etc."]\n\n    I["Multi-Hop Chain<br/>Device \u2192 Hop1 VPN \u2192 Hop2 Tor \u2192 Internet<br/>Each hop is separate VLAN/routing-table<br/>chained via mangle rules"]\n\n    A --\x3e B --\x3e C --\x3e D\n    D --\x3e E\n    E --\x3e F --\x3e G --\x3e H'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,t.jsxs)(n.h3,{id:"vif-core",children:[(0,t.jsx)(n.code,{children:"vif"})," (core)"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"types.go"})," \u2014 VLAN Allocation"]})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"VLANAllocator"})}),(0,t.jsxs)(n.td,{children:["Interface: ",(0,t.jsx)(n.code,{children:"Allocate(ctx, routerID, instanceID, serviceType) (int, error)"})," / ",(0,t.jsx)(n.code,{children:"Release(ctx, routerID, id) error"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SimpleVLANAllocator"})}),(0,t.jsx)(n.td,{children:"In-memory sequential allocator (unit tests only)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"NetworkVLANAllocatorAdapter"})}),(0,t.jsxs)(n.td,{children:["Wraps ",(0,t.jsx)(n.code,{children:"network.VLANAllocator"})," (DB-backed, production)"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"VLANPurpose"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"ingress"}),", ",(0,t.jsx)(n.code,{children:"egress"}),", or ",(0,t.jsx)(n.code,{children:'""'})," (legacy)"]})]})]})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Production wiring\nadapter := vif.NewNetworkVLANAllocatorAdapter(network.NewVLANAllocator(...))\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"interface_factory.go"})," \u2014 InterfaceFactory"]})}),"\n",(0,t.jsx)(n.p,{children:"Creates and removes VLAN-based virtual interfaces on MikroTik routers with transactional rollback."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type InterfaceFactory struct {\n    router      router.RouterPort\n    store       *ent.Client\n    eventBus    events.EventBus\n    parentIface string // e.g., "ether1"\n}\n\ntype InterfaceFactoryConfig struct {\n    RouterPort  router.RouterPort\n    Store       *ent.Client\n    EventBus    events.EventBus\n    ParentIface string // defaults to "ether1"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"CreateInterface"})})," \u2014 4-step transactional creation with LIFO rollback:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"1. Save VirtualInterface DB record (status=creating)\n2. /interface/vlan add name=nnc-{featureID}-{name} vlan-id={id} interface={parent}\n3. /ip/address add address=10.99.{id}.1/24 interface={name}\n4. /routing/table add name={mark}\n5. /ip/route add dst-address=0.0.0.0/0 gateway=10.99.{id}.2 routing-table={mark}\n6. Update DB record (status=active)\n7. Publish interface.created event\n"})}),"\n",(0,t.jsxs)(n.p,{children:["On any step failure: all previous steps are rolled back in reverse order. The DB record is set to ",(0,t.jsx)(n.code,{children:"status=error"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Naming conventions:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Interface: ",(0,t.jsx)(n.code,{children:"nnc-{featureID}-{instanceName}"})," (e.g., ",(0,t.jsx)(n.code,{children:"nnc-tor-myrelay"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["IP: ",(0,t.jsx)(n.code,{children:"10.99.{vlanID}.1/24"})]}),"\n",(0,t.jsxs)(n.li,{children:["Routing table / mark: ",(0,t.jsx)(n.code,{children:"{featureID}-{instanceName}"})]}),"\n",(0,t.jsxs)(n.li,{children:["Gateway IP: ",(0,t.jsx)(n.code,{children:"10.99.{vlanID}.2"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"RemoveInterface"})})," \u2014 Reverse teardown (best-effort):"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Update DB status to ",(0,t.jsx)(n.code,{children:"removing"})]}),"\n",(0,t.jsx)(n.li,{children:"Remove default route"}),"\n",(0,t.jsx)(n.li,{children:"Remove routing table"}),"\n",(0,t.jsx)(n.li,{children:"Remove IP address"}),"\n",(0,t.jsx)(n.li,{children:"Remove VLAN interface"}),"\n",(0,t.jsx)(n.li,{children:"Delete DB record"}),"\n",(0,t.jsxs)(n.li,{children:["Publish ",(0,t.jsx)(n.code,{children:"interface.removed"})," event"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"bridge.go"})," \u2014 BridgeOrchestrator"]})}),"\n",(0,t.jsx)(n.p,{children:"Coordinates the full bridge lifecycle: VLAN allocation, interface creation, optional TUN gateway, and VIF reconciliation."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type BridgeOrchestrator struct {\n    interfaceFactory *InterfaceFactory\n    gatewayManager   *GatewayManager\n    vlanAllocator    VLANAllocator\n    store            *ent.Client\n    eventBus         events.EventBus\n    routerPort       router.RouterPort\n    ingressService   *ingress.Service\n    egressService    *wan.EgressService\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"SetupBridge(ctx, instance, manifest)"})})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Allocate VLAN ID from ",(0,t.jsx)(n.code,{children:"VLANAllocator"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"InterfaceFactory.CreateInterface"})," \u2014 creates router VLAN + routing table"]}),"\n",(0,t.jsxs)(n.li,{children:["If manifest declares SOCKS5 gateway: ",(0,t.jsx)(n.code,{children:"GatewayManager.StartGateway"})]}),"\n",(0,t.jsxs)(n.li,{children:["Configure ingress DHCP (via ",(0,t.jsx)(n.code,{children:"ingressService"}),") if needed"]}),"\n",(0,t.jsxs)(n.li,{children:["Configure egress WAN routing (via ",(0,t.jsx)(n.code,{children:"egressService"}),") if needed"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"TeardownBridge(ctx, instanceID)"})})," \u2014 Reverses setup in order."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"ReconcileOnStartup(ctx)"})})," \u2014 Called at boot to detect and clean up orphaned VIF records (DB records without matching router resources)."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"gateway_config.go"})," \u2014 Gateway Configuration"]})}),"\n",(0,t.jsxs)(n.p,{children:["Generates YAML configuration for ",(0,t.jsx)(n.code,{children:"hev-socks5-tunnel"}),", which bridges a SOCKS5 proxy to a kernel TUN interface."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type GatewayConfig struct {\n    Tunnel Socks5Config `yaml:"tunnel"` // TUN name, MTU (8500)\n    Socks5 Socks5Config `yaml:"socks5"` // SOCKS5 address + port + UDP flag\n    Misc   MiscConfig   `yaml:"misc"`   // log level\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["TUN interface name: ",(0,t.jsx)(n.code,{children:"tun-{featureID[0:4]}-{instanceID[0:8]}"})," (max 15 chars for Linux TUN limit)."]}),"\n",(0,t.jsxs)(n.p,{children:["SOCKS endpoint is extracted from ",(0,t.jsx)(n.code,{children:'ServiceInstance.Config["socks_port"]'})," and ",(0,t.jsx)(n.code,{children:'Config["vlan_ip"]'}),"."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"gateway_manager.go"})," \u2014 GatewayManager"]})}),"\n",(0,t.jsxs)(n.p,{children:["Manages ",(0,t.jsx)(n.code,{children:"hev-socks5-tunnel"})," processes that bridge SOCKS5 \u2192 TUN."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'type GatewayManager struct {\n    supervisor    ProcessSupervisor\n    hevBinaryPath string   // default: /app/hev-socks5-tunnel\n    pathResolver  storage.PathResolverPort\n    gateways      map[string]*GatewayInstance\n}\n\ntype GatewayInstance struct {\n    InstanceID      string\n    TunName         string\n    SocksAddr       string\n    SocksPort       int\n    UDPEnabled      bool\n    EgressInterface string // e.g., "eth0.154" for DHCP bridge mode\n    StartTime       time.Time\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"StartGateway(ctx, instance, manifest)"})})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"GenerateGatewayConfig"})," \u2192 write YAML config file"]}),"\n",(0,t.jsxs)(n.li,{children:["Build ",(0,t.jsx)(n.code,{children:"ProcessConfig"})," for ",(0,t.jsx)(n.code,{children:"hev-socks5-tunnel"})]}),"\n",(0,t.jsxs)(n.li,{children:["Register + start via ",(0,t.jsx)(n.code,{children:"ProcessSupervisor"})]}),"\n",(0,t.jsxs)(n.li,{children:["Wait for TUN interface to appear in ",(0,t.jsx)(n.code,{children:"/proc/net/dev"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"StopGateway(ctx, instanceID)"})})," \u2014 Stops process and removes TUN interface record."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"vifrouting",children:(0,t.jsx)(n.code,{children:"vif/routing"})}),"\n",(0,t.jsx)(n.p,{children:"Multi-hop routing chain management and policy-based routing (PBR)."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"chain_router.go"})," \u2014 ChainRouter"]})}),"\n",(0,t.jsx)(n.p,{children:"Manages chains where traffic flows sequentially through multiple services."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type ChainRouter struct {\n    router    router.RouterPort\n    store     *ent.Client\n    eventBus  events.EventBus\n}\n\ntype CreateRoutingChainInput struct {\n    DeviceID          string\n    DeviceMAC         string\n    DeviceIP          string\n    RoutingMode       routingchain.RoutingMode  // per-device, global, scheduled\n    KillSwitchEnabled bool\n    KillSwitchMode    routingchain.KillSwitchMode\n    Hops              []ChainHopInput           // ordered list of VIF IDs\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"chain_router_hops.go"})})," \u2014 Creates per-hop router rules with LIFO rollback:"]}),"\n",(0,t.jsx)(n.p,{children:"For each hop:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Create mangle rule: ",(0,t.jsx)(n.code,{children:"src-mac \u2192 mark-routing=chain-{chainID}-hop{N}"})]}),"\n",(0,t.jsxs)(n.li,{children:["Create routing rule: ",(0,t.jsx)(n.code,{children:"routing-mark=chain-{chainID}-hop{N} \u2192 use table chain-{chainID}-hop{N}"})]}),"\n",(0,t.jsxs)(n.li,{children:["Create DB ",(0,t.jsx)(n.code,{children:"ChainHop"})," record"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Cleanup rolls back in reverse order on any hop failure."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"chain_latency.go"})," \u2014 ChainLatencyMeasurer"]})}),"\n",(0,t.jsx)(n.p,{children:"Measures per-hop latency by probing each hop's SOCKS5 port."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type HopLatency struct {\n    HopOrder  int\n    Interface string\n    LatencyMs float64  // -1 if unreachable\n    Healthy   bool\n}\n\ntype ChainLatencyResult struct {\n    ChainID      string\n    Hops         []HopLatency\n    TotalLatency float64\n    AllHealthy   bool\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"pbr_engine.go"})," \u2014 PBREngine"]})}),"\n",(0,t.jsx)(n.p,{children:"Policy-Based Routing via MAC-based MikroTik mangle rules."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type PBREngine struct {\n    routerPort router.RouterPort\n    client     *ent.Client\n    eventBus   events.EventBus\n}\n\ntype DeviceRoutingAssignment struct {\n    DeviceID       string\n    MacAddress     string\n    RoutingMark    string\n    MangleRuleID   string\n    Success        bool\n    ConflictExists bool\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"AssignDeviceRouting(ctx, deviceID, instanceID)"})})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Check for existing mangle rule conflict"}),"\n",(0,t.jsxs)(n.li,{children:["Create mangle rule: ",(0,t.jsx)(n.code,{children:"chain=prerouting src-mac={MAC} action=mark-routing new-routing-mark={mark}"})]}),"\n",(0,t.jsxs)(n.li,{children:["Save ",(0,t.jsx)(n.code,{children:"DeviceRouting"})," record to DB"]}),"\n",(0,t.jsxs)(n.li,{children:["Publish ",(0,t.jsx)(n.code,{children:"device.routed"})," event"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"UnassignDeviceRouting(ctx, deviceID)"})})," \u2014 Removes mangle rule from router and DB record."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"viftraffic",children:(0,t.jsx)(n.code,{children:"vif/traffic"})}),"\n",(0,t.jsx)(n.p,{children:"Traffic statistics collection and quota enforcement."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"aggregator.go"})," \u2014 TrafficAggregator"]})}),"\n",(0,t.jsx)(n.p,{children:"Write-behind buffer for high-frequency traffic data (polled every 10s by the resource poller, flushed to DB every 5 minutes)."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type TrafficAggregator struct {\n    client   *ent.Client\n    buffer   map[string]map[string]*hourlyStats  // instanceID \u2192 hourKey \u2192 stats\n    stopChan chan struct{}\n}\n"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Constant"}),(0,t.jsx)(n.th,{children:"Value"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"FlushInterval"})}),(0,t.jsx)(n.td,{children:"5 minutes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RetentionDays"})}),(0,t.jsx)(n.td,{children:"30 days"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CleanupInterval"})}),(0,t.jsx)(n.td,{children:"24 hours"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"hourlyStats"})})," accumulates ",(0,t.jsx)(n.code,{children:"txBytes"}),", ",(0,t.jsx)(n.code,{children:"rxBytes"}),", ",(0,t.jsx)(n.code,{children:"txPackets"}),", ",(0,t.jsx)(n.code,{children:"rxPackets"})," per instance per hour bucket. On flush, upserts ",(0,t.jsx)(n.code,{children:"ServiceTrafficHourly"})," records."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"quota_enforcer.go"})," \u2014 QuotaEnforcer"]})}),"\n",(0,t.jsx)(n.p,{children:"Enforces traffic quotas at 80%, 90%, and 100% thresholds."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Quota thresholds\n// 80% \u2192 publish QuotaWarning event\n// 90% \u2192 publish QuotaWarning event (escalated)\n// 100% \u2192 THROTTLE action: apply 1 Mbps bandwidth cap via router queue rule\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Throttle bandwidth cap: ",(0,t.jsx)(n.strong,{children:"1 Mbps"})," (",(0,t.jsx)(n.code,{children:"defaultThrottleBitsPerSecond = 1_000_000"}),")."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (e *QuotaEnforcer) CheckQuota(ctx context.Context, instanceID string, newBytes int64) (bool, error)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Called by ",(0,t.jsx)(n.code,{children:"TrafficAggregator"})," after each flush."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"vifisolation",children:(0,t.jsx)(n.code,{children:"vif/isolation"})}),"\n",(0,t.jsx)(n.p,{children:"Kill switch management: blocks device traffic when service becomes unhealthy."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"kill_switch_listener.go"})," \u2014 KillSwitchListener"]})}),"\n",(0,t.jsxs)(n.p,{children:["Subscribes to ",(0,t.jsx)(n.code,{children:"EventTypeHealthChanged"})," and triggers kill switch transitions."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"type KillSwitchListener struct {\n    client        *ent.Client\n    eventBus      events.EventBus\n    killSwitchMgr *KillSwitchManager\n}\n\nfunc (l *KillSwitchListener) Start() error  // subscribes to health events\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Health \u2192 Kill Switch Logic:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"Action"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.td,{children:["Service becomes ",(0,t.jsx)(n.code,{children:"UNHEALTHY"})]}),(0,t.jsx)(n.td,{children:"Activate kill switch \u2192 block all device traffic"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.td,{children:["Service recovers to ",(0,t.jsx)(n.code,{children:"HEALTHY"})]}),(0,t.jsx)(n.td,{children:"Deactivate kill switch \u2192 resume device traffic"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Kill Switch Implementation"})}),"\n",(0,t.jsxs)(n.p,{children:["Blocking: creates MikroTik firewall rule ",(0,t.jsx)(n.code,{children:"chain=forward src-mac={MAC} action=reject"})," for all devices routed through the affected instance."]}),"\n",(0,t.jsx)(n.p,{children:"Resuming: removes the blocking rules."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"kill_switch_coordinator_test.go"})})}),"\n",(0,t.jsx)(n.p,{children:"Tests coordinator behavior: concurrent activation, idempotent operations, and recovery after health restoration."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,t.jsx)(n.h3,{id:"service-instance-setup-full-vif-pipeline",children:"Service Instance Setup (Full VIF Pipeline)"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["1. User installs + starts service<br/>e.g., Tor"]\n    A --\x3e B["2. InstanceManager.startInstanceInternal"]\n\n    B --\x3e B1["process start<br/>supervisor starts Tor binary"]\n    B --\x3e B2["bridge setup<br/>BridgeOrchestrator.SetupBridge"]\n\n    B2 --\x3e B2A["VLANAllocator.Allocate<br/>\u2192 vlanID = 42"]\n    B2 --\x3e B2B["InterfaceFactory.CreateInterface"]\n    B2B --\x3e B2B1["/interface/vlan add<br/>nnc-tor-myrelay vlan-id=42"]\n    B2B --\x3e B2B2["/ip/address add 10.99.42.1/24"]\n    B2B --\x3e B2B3["/routing/table add tor-myrelay"]\n    B2B --\x3e B2B4["/ip/route add 0.0.0.0/0<br/>via 10.99.42.2<br/>table tor-myrelay"]\n\n    B2 --\x3e B2C["GatewayManager.StartGateway"]\n    B2C --\x3e B2C1["write /data/tor-myrelay/hev.yaml"]\n    B2C --\x3e B2C2["start hev-socks5-tunnel process<br/>tun interface: tun-tor0-abc12345<br/>SOCKS5: 10.99.42.2:1080<br/>\u2192 tun \u2192 route"]\n\n    C["3. User assigns device<br/>MAC: aa:bb to Tor"]\n    C --\x3e D["4. PBREngine.AssignDeviceRouting"]\n    D --\x3e D1["/ip/firewall/mangle add<br/>src-mac=aa:bb mark-routing=tor-myrelay"]\n    D --\x3e D2["save DeviceRouting record"]\n\n    E["5. Device traffic:<br/>aa:bb \u2192 mangle \u2192 routing mark<br/>\u2192 routing table \u2192 VIF \u2192 Tor \u2192 Internet"]'}),"\n",(0,t.jsx)(n.h3,{id:"kill-switch-activation",children:"Kill Switch Activation"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["Tor process crashes"]\n    A --\x3e B["HealthChecker detects failure"]\n    B --\x3e C["Publish EventTypeHealthChanged<br/>state: UNHEALTHY, instanceID: ..."]\n    C --\x3e D["KillSwitchListener.handleHealthEvent"]\n    D --\x3e E["KillSwitchManager.Activate instanceID"]\n\n    E --\x3e E1["Query DeviceRouting<br/>WHERE instance_id = X AND active = true"]\n    E --\x3e E2["For each device:<br/>/ip/firewall/filter add<br/>chain=forward src-mac=MAC action=reject<br/>device traffic now blocked<br/>no internet leak"]\n\n    F["Tor process recovers<br/>HealthChecker detects HEALTHY"]\n    F --\x3e G["KillSwitchManager.Deactivate instanceID"]\n    G --\x3e G1["Remove blocking firewall rules<br/>\u2192 traffic resumes"]'}),"\n",(0,t.jsx)(n.h3,{id:"multi-hop-chain",children:"Multi-Hop Chain"}),"\n",(0,t.jsx)(n.mermaid,{value:'graph TD\n    A["User creates chain:<br/>Device \u2192 VPN \u2192 Tor \u2192 Internet"]\n    A --\x3e B["ChainRouter.CreateRoutingChain input"]\n\n    B --\x3e B1["DB: RoutingChain record"]\n\n    B --\x3e B2["Hop 1 VPN order=1"]\n    B2 --\x3e B2A["mangle: src-mac<br/>\u2192 mark=chain-abc-hop1"]\n    B2 --\x3e B2B["routing rule: mark=chain-abc-hop1<br/>\u2192 table chain-abc-hop1"]\n    B2 --\x3e B2C["route in table: 0.0.0.0/0<br/>via VPN VIF gateway"]\n\n    B --\x3e B3["Hop 2 Tor order=2"]\n    B3 --\x3e B3A["mangle: mark=chain-abc-hop1<br/>\u2192 mark=chain-abc-hop2"]\n    B3 --\x3e B3B["routing rule: mark=chain-abc-hop2<br/>\u2192 table chain-abc-hop2"]\n    B3 --\x3e B3C["route in table: 0.0.0.0/0<br/>via Tor VIF gateway"]\n\n    C["Result: Device \u2192 VPN interface<br/>\u2192 Tor interface \u2192 Internet"]'}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"vlan-id-allocation",children:"VLAN ID Allocation"}),"\n",(0,t.jsxs)(n.p,{children:["Two implementations of ",(0,t.jsx)(n.code,{children:"VLANAllocator"}),":"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Impl"}),(0,t.jsx)(n.th,{children:"Use Case"}),(0,t.jsx)(n.th,{children:"Backing"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SimpleVLANAllocator"})}),(0,t.jsx)(n.td,{children:"Unit tests"}),(0,t.jsx)(n.td,{children:"In-memory map, sequential"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"NetworkVLANAllocatorAdapter"})}),(0,t.jsx)(n.td,{children:"Production"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"network.VLANAllocator"})," with DB persistence"]})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["VLAN IDs are scoped per router. The allocator tracks ",(0,t.jsx)(n.code,{children:"(routerID, instanceID, serviceType)"})," to enable deterministic re-allocation after restarts."]}),"\n",(0,t.jsxs)(n.p,{children:["Production VLAN range: typically ",(0,t.jsx)(n.code,{children:"10\u20134000"})," (MikroTik supports 1\u20134094)."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["VIF is configured during bootstrap in ",(0,t.jsx)(n.code,{children:"internal/bootstrap/vif.go"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Only enabled when VLANAllocator is configured (requires supported router)\nif cfg.VLANAllocator != nil {\n    bridgeOrch = vif.NewBridgeOrchestrator(vif.BridgeOrchestratorConfig{\n        InterfaceFactory: vif.NewInterfaceFactory(...),\n        GatewayManager:   vif.NewGatewayManager(...),\n        VLANAllocator:    vif.NewNetworkVLANAllocatorAdapter(cfg.VLANAllocator),\n        RouterPort:       cfg.RouterPort,\n        ...\n    })\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key parameters:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"parentIface"}),": parent MikroTik interface for VLAN tagging (default: ",(0,t.jsx)(n.code,{children:"ether1"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"hevBinaryPath"}),": path to ",(0,t.jsx)(n.code,{children:"hev-socks5-tunnel"})," binary (default: ",(0,t.jsx)(n.code,{children:"/app/hev-socks5-tunnel"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"AllowedBaseDir"}),": base path for service files (isolation verifier)"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error"}),(0,t.jsx)(n.th,{children:"Behavior"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"VLAN allocation failure"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"SetupBridge"})," returns error; no router changes made"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"VLAN interface creation failure"}),(0,t.jsxs)(n.td,{children:["Rollback previous steps; DB record set to ",(0,t.jsx)(n.code,{children:"error"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Gateway start failure"}),(0,t.jsx)(n.td,{children:"VIF remains (can retry); instance marked degraded"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Hop creation failure"}),(0,t.jsx)(n.td,{children:"Entire chain rolled back in reverse order"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Kill switch activation failure"}),(0,t.jsx)(n.td,{children:"Logged as error; best-effort on all devices"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Traffic flush failure"}),(0,t.jsx)(n.td,{children:"Logged; in-memory buffer retained for next flush"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Quota enforcement failure"}),(0,t.jsx)(n.td,{children:"Logged; does not stop the service"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"All VIF operations emit events to the event bus for audit and UI updates."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"benchmark_test.go"})})}),"\n",(0,t.jsx)(n.p,{children:"Benchmarks VIF operations: VLAN allocation throughput, interface name generation, routing mark lookups."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"isolation/kill_switch_coordinator_test.go"})})}),"\n",(0,t.jsx)(n.p,{children:"Tests concurrent kill switch activation, idempotency, and state recovery:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Multiple simultaneous activations for the same instance"}),"\n",(0,t.jsx)(n.li,{children:"Deactivation when no blocking rules exist"}),"\n",(0,t.jsx)(n.li,{children:"Round-trip activate \u2192 deactivate \u2192 verify clean state"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["[See: 06-service-orchestrator.md \xa7lifecycle_starter] \u2014 ",(0,t.jsx)(n.code,{children:"setupBridgeIfNeeded"})," calls ",(0,t.jsx)(n.code,{children:"BridgeOrchestrator.SetupBridge"})]}),"\n",(0,t.jsxs)(n.li,{children:["[See: 04-router-communication.md \xa7RouterPort] \u2014 All VIF router commands go through ",(0,t.jsx)(n.code,{children:"router.RouterPort"})]}),"\n",(0,t.jsx)(n.li,{children:"[See: 11-data-layer.md \xa7VirtualInterface] \u2014 Ent schema for VIF persistence"}),"\n",(0,t.jsxs)(n.li,{children:["[See: 05-event-system.md] \u2014 Events: ",(0,t.jsx)(n.code,{children:"interface.created"}),", ",(0,t.jsx)(n.code,{children:"interface.removed"}),", ",(0,t.jsx)(n.code,{children:"device.routed"}),", ",(0,t.jsx)(n.code,{children:"EventTypeHealthChanged"})]}),"\n",(0,t.jsx)(n.li,{children:"[See: ADR 007 \u2014 IP Binding Isolation] \u2014 Design rationale for per-instance binding"}),"\n",(0,t.jsx)(n.li,{children:"[See: ADR 012 \u2014 Universal State v2] \u2014 8-layer resource model that includes VIF as a routing layer"}),"\n",(0,t.jsx)(n.li,{children:"[See: ADR 017 \u2014 Three-Layer Component Architecture] \u2014 Frontend components for VIF management"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>l});var i=r(14041);const t={},s=i.createContext(t);function c(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);