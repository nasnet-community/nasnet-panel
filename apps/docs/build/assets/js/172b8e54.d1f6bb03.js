"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[87585],{42240:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"feature-services","title":"Feature Services Module (libs/features/services)","description":"Overview","source":"@site/../../libs/features/docs/feature-services.md","sourceDirName":".","slug":"/feature-services","permalink":"/docs/features/feature-services","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/features/docs/feature-services.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Feature: Network (libs/features/network)","permalink":"/docs/features/feature-network"},"next":{"title":"VPN Feature Module Documentation","permalink":"/docs/features/feature-vpn"}}');var r=n(31085),t=n(71184);const l={},c="Feature Services Module (libs/features/services)",d={},o=[{value:"Overview",id:"overview",level:2},{value:"Supported Services (Feature IDs)",id:"supported-services-feature-ids",level:3},{value:"Core Concepts",id:"core-concepts",level:3},{value:"Directory Tree",id:"directory-tree",level:2},{value:"Pages",id:"pages",level:2},{value:"<code>ServicesPage</code>",id:"servicespage",level:3},{value:"<code>ServiceDetailPage</code>",id:"servicedetailpage",level:3},{value:"<code>DeviceRoutingPage</code>",id:"deviceroutingpage",level:3},{value:"<code>VLANSettingsPage</code>",id:"vlansettingspage",level:3},{value:"Components",id:"components",level:2},{value:"Components Table",id:"components-table",level:3},{value:"Service Install Flow",id:"service-install-flow",level:2},{value:"Direct Install (<code>InstallDialog</code>)",id:"direct-install-installdialog",level:3},{value:"Template Install Flow (<code>TemplateInstallWizard</code>)",id:"template-install-flow-templateinstallwizard",level:3},{value:"XState Machine: <code>templateInstallMachine</code>",id:"xstate-machine-templateinstallmachine",level:4},{value:"<code>useTemplateInstallWizard</code> Hook",id:"usetemplateinstallwizard-hook",level:4},{value:"<code>VariablesStep</code> (Wizard Step 1)",id:"variablesstep-wizard-step-1",level:4},{value:"<code>RoutingStep</code> (Wizard Step 4)",id:"routingstep-wizard-step-4",level:4},{value:"Templates Browser",id:"templates-browser",level:2},{value:"<code>TemplatesBrowser</code>",id:"templatesbrowser",level:3},{value:"<code>useTemplatesBrowser</code> Hook",id:"usetemplatesbrowser-hook",level:3},{value:"Dynamic Configuration Forms",id:"dynamic-configuration-forms",level:2},{value:"Architecture",id:"architecture",level:3},{value:"<code>useServiceConfigForm</code> Hook",id:"useserviceconfigform-hook",level:3},{value:"<code>buildZodSchema</code> Utility",id:"buildzodschema-utility",level:3},{value:"<code>DynamicField</code> Component",id:"dynamicfield-component",level:3},{value:"Platform Presenters for <code>ServiceConfigForm</code>",id:"platform-presenters-for-serviceconfigform",level:3},{value:"Service Updates",id:"service-updates",level:2},{value:"Update Check Flow",id:"update-check-flow",level:3},{value:"<code>UpdateAllPanel</code>",id:"updateallpanel",level:3},{value:"<code>updateMachine</code> (XState)",id:"updatemachine-xstate",level:3},{value:"VLAN Pool",id:"vlan-pool",level:2},{value:"<code>VLANPoolConfig</code> Component",id:"vlanpoolconfig-component",level:3},{value:"<code>VLANSettingsPage</code> VLAN Allocation Table",id:"vlansettingspage-vlan-allocation-table",level:3},{value:"Kill Switch",id:"kill-switch",level:2},{value:"Integration Points",id:"integration-points",level:3},{value:"Device Routing",id:"device-routing",level:2},{value:"<code>DeviceRoutingMatrix</code> Pattern",id:"deviceroutingmatrix-pattern",level:3},{value:"<code>RoutingChainViz</code> Pattern",id:"routingchainviz-pattern",level:3},{value:"Traffic and Quota",id:"traffic-and-quota",level:2},{value:"<code>ServiceTrafficPanel</code>",id:"servicetrafficpanel",level:3},{value:"<code>useServiceTrafficPanel</code> Hook",id:"useservicetrafficpanel-hook",level:3},{value:"<code>QuotaSettingsForm</code>",id:"quotasettingsform",level:3},{value:"Storage Management",id:"storage-management",level:2},{value:"<code>StorageSettings</code>",id:"storagesettings",level:3},{value:"Service Sharing (Import/Export)",id:"service-sharing-importexport",level:2},{value:"Export Flow",id:"export-flow",level:3},{value:"Import Flow",id:"import-flow",level:3},{value:"Service Dependencies",id:"service-dependencies",level:2},{value:"<code>StopDependentsDialog</code>",id:"stopdependentsdialog",level:3},{value:"Service Alerts",id:"service-alerts",level:2},{value:"<code>ServiceAlertsTab</code>",id:"servicealertstab",level:3},{value:"<code>useServiceAlertsTab</code> Hook",id:"useservicealertstab-hook",level:3},{value:"<code>useServiceAlertToasts</code> Hook",id:"useservicealerttoasts-hook",level:3},{value:"Diagnostics",id:"diagnostics",level:2},{value:"<code>DiagnosticsPanel</code>",id:"diagnosticspanel",level:3},{value:"Zustand Store: <code>useServiceUIStore</code>",id:"zustand-store-useserviceuistore",level:2},{value:"Persisted State",id:"persisted-state",level:3},{value:"Non-Persisted State",id:"non-persisted-state",level:3},{value:"Selector Hooks (for optimized subscription)",id:"selector-hooks-for-optimized-subscription",level:3},{value:"Key Hooks Summary",id:"key-hooks-summary",level:2},{value:"XState Machines",id:"xstate-machines",level:2},{value:"Zod Schemas Summary",id:"zod-schemas-summary",level:2},{value:"Public API (<code>src/index.ts</code>)",id:"public-api-srcindexts",level:2},{value:"Design Patterns",id:"design-patterns",level:2}];function a(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsxs)(s.h1,{id:"feature-services-module-libsfeaturesservices",children:["Feature Services Module (",(0,r.jsx)(s.code,{children:"libs/features/services"}),")"]})}),"\n",(0,r.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(s.p,{children:"The services module is the Feature Marketplace for NasNetConnect. It enables users to install, configure, monitor, and manage downloadable network service instances that run inside the MikroTik router's Docker environment. Each service is an isolated binary managed by the NasNet supervisor."}),"\n",(0,r.jsx)(s.h3,{id:"supported-services-feature-ids",children:"Supported Services (Feature IDs)"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Feature ID"}),(0,r.jsx)(s.th,{children:"Category"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"tor"})}),(0,r.jsx)(s.td,{children:"privacy"}),(0,r.jsx)(s.td,{children:"Tor anonymization proxy"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"sing-box"})}),(0,r.jsx)(s.td,{children:"proxy"}),(0,r.jsx)(s.td,{children:"Universal proxy platform"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"xray-core"})}),(0,r.jsx)(s.td,{children:"proxy"}),(0,r.jsx)(s.td,{children:"Xray protocol suite"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"mtproxy"})}),(0,r.jsx)(s.td,{children:"proxy"}),(0,r.jsx)(s.td,{children:"MTProxy Telegram proxy"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"psiphon"})}),(0,r.jsx)(s.td,{children:"privacy"}),(0,r.jsx)(s.td,{children:"Psiphon censorship circumvention"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"adguard-home"})}),(0,r.jsx)(s.td,{children:"dns"}),(0,r.jsx)(s.td,{children:"Network-wide DNS ad blocker"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Service Instance"}),": A running (or stopped) instance of a downloaded feature binary. A single feature can have multiple instances (e.g., two Tor instances)."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Template"}),": A pre-packaged configuration bundle that installs one or more related service instances with a single flow. Templates come from the NasNet marketplace or are user-created."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"VLAN Isolation"}),": Each service instance may be assigned its own VLAN for network isolation, managed by the VLAN pool allocator."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Virtual Interface (VIF) Bridge"}),": The network bridge connecting the service's isolated VLAN subnet to the router. Used for policy-based routing (PBR) to route specific devices through specific services."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Device Routing"}),": The mapping from a client device (identified by MAC address or IP) to a specific service instance's VIF for selective traffic routing."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Kill Switch"}),": A safety mechanism that blocks all traffic for a device if its assigned service goes down, preventing traffic from leaking to the unprotected network."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Traffic Quota"}),": Configurable data limits per service instance with warning and hard-limit thresholds."]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"directory-tree",children:"Directory Tree"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"libs/features/services/\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 tsconfig.json\n\u251c\u2500\u2500 tsconfig.lib.json\n\u251c\u2500\u2500 tsconfig.spec.json\n\u251c\u2500\u2500 tsconfig.storybook.json\n\u251c\u2500\u2500 vitest.config.ts\n\u251c\u2500\u2500 vitest.setup.js\n\u251c\u2500\u2500 vitest.setup.ts\n\u2514\u2500\u2500 src/\n    \u251c\u2500\u2500 index.ts                        # Public API barrel export\n    \u251c\u2500\u2500 components/\n    \u2502   \u251c\u2500\u2500 InstallDialog.tsx            # Multi-step service install wizard (dialog)\n    \u2502   \u251c\u2500\u2500 InstallDialog.stories.tsx\n    \u2502   \u251c\u2500\u2500 ChangelogModal.tsx           # Service changelog viewer\n    \u2502   \u251c\u2500\u2500 ChangelogModal.stories.tsx\n    \u2502   \u251c\u2500\u2500 GatewayStatusCard.tsx        # SOCKS-to-TUN gateway status (platform wrapper)\n    \u2502   \u251c\u2500\u2500 GatewayStatusCardDesktop.tsx\n    \u2502   \u251c\u2500\u2500 GatewayStatusCardMobile.tsx\n    \u2502   \u251c\u2500\u2500 GatewayStatusCard.stories.tsx\n    \u2502   \u251c\u2500\u2500 PortRegistryView.tsx         # Port allocation registry (platform wrapper)\n    \u2502   \u251c\u2500\u2500 PortRegistryViewDesktop.tsx\n    \u2502   \u251c\u2500\u2500 PortRegistryViewMobile.tsx\n    \u2502   \u251c\u2500\u2500 PortRegistryView.stories.tsx\n    \u2502   \u251c\u2500\u2500 ResourceLimitsForm.tsx       # cgroup resource limits form\n    \u2502   \u251c\u2500\u2500 ResourceLimitsForm.stories.tsx\n    \u2502   \u251c\u2500\u2500 ServiceAlertsTab.tsx         # Alert tab (platform wrapper)\n    \u2502   \u251c\u2500\u2500 ServiceAlertsTabDesktop.tsx\n    \u2502   \u251c\u2500\u2500 ServiceAlertsTabMobile.tsx\n    \u2502   \u251c\u2500\u2500 ServiceAlertsTab.stories.tsx\n    \u2502   \u251c\u2500\u2500 StopDependentsDialog.tsx     # Dependency-aware stop confirmation\n    \u2502   \u251c\u2500\u2500 StopDependentsDialog.stories.tsx\n    \u2502   \u251c\u2500\u2500 UpdateAllPanel.tsx           # Bulk update panel with severity grouping\n    \u2502   \u251c\u2500\u2500 UpdateAllPanel.stories.tsx\n    \u2502   \u251c\u2500\u2500 VLANPoolConfig.tsx           # VLAN range configuration form\n    \u2502   \u251c\u2500\u2500 VLANPoolConfig.stories.tsx\n    \u2502   \u251c\u2500\u2500 ServiceConfigForm/\n    \u2502   \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceConfigForm.tsx    # Platform wrapper\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceConfigFormDesktop.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceConfigFormMobile.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 DynamicField.tsx         # Renders a single field by type\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceConfigForm.stories.tsx\n    \u2502   \u2502   \u2514\u2500\u2500 fields/\n    \u2502   \u2502       \u251c\u2500\u2500 index.ts\n    \u2502   \u2502       \u251c\u2500\u2500 TextField.tsx\n    \u2502   \u2502       \u251c\u2500\u2500 TextArea.tsx\n    \u2502   \u2502       \u251c\u2500\u2500 PasswordField.tsx\n    \u2502   \u2502       \u251c\u2500\u2500 NumberField.tsx\n    \u2502   \u2502       \u251c\u2500\u2500 Select.tsx\n    \u2502   \u2502       \u251c\u2500\u2500 MultiSelect.tsx\n    \u2502   \u2502       \u2514\u2500\u2500 ArrayField.tsx\n    \u2502   \u251c\u2500\u2500 DiagnosticsPanel/\n    \u2502   \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2502   \u251c\u2500\u2500 DiagnosticsPanel.tsx     # Platform wrapper\n    \u2502   \u2502   \u251c\u2500\u2500 DiagnosticsPanelDesktop.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 DiagnosticsPanelMobile.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 useDiagnosticsPanel.ts  # Headless hook\n    \u2502   \u2502   \u2514\u2500\u2500 DiagnosticsPanel.stories.tsx\n    \u2502   \u251c\u2500\u2500 ServiceLogViewer/\n    \u2502   \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceLogViewer.tsx     # Platform wrapper\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceLogViewerDesktop.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceLogViewerMobile.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 useServiceLogViewer.ts  # Headless hook\n    \u2502   \u2502   \u2514\u2500\u2500 ServiceLogViewer.stories.tsx\n    \u2502   \u251c\u2500\u2500 service-traffic/\n    \u2502   \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2502   \u251c\u2500\u2500 service-traffic-panel.types.ts\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceTrafficPanel.tsx  # Platform wrapper\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceTrafficPanelDesktop.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 ServiceTrafficPanelMobile.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 use-service-traffic-panel.ts  # Headless hook\n    \u2502   \u2502   \u251c\u2500\u2500 QuotaSettingsForm.tsx    # Traffic quota configuration\n    \u2502   \u2502   \u2514\u2500\u2500 ServiceTrafficPanel.stories.tsx\n    \u2502   \u251c\u2500\u2500 storage/\n    \u2502   \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2502   \u251c\u2500\u2500 StorageSettings.tsx      # Platform wrapper\n    \u2502   \u2502   \u251c\u2500\u2500 StorageSettingsDesktop.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 StorageSettingsMobile.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 StorageDisconnectBanner.tsx\n    \u2502   \u2502   \u251c\u2500\u2500 StorageUsageBar.tsx\n    \u2502   \u2502   \u2514\u2500\u2500 useStorageSettings.ts   # Headless hook\n    \u2502   \u2514\u2500\u2500 templates/\n    \u2502       \u251c\u2500\u2500 index.ts\n    \u2502       \u251c\u2500\u2500 types.ts                 # Shared type definitions\n    \u2502       \u251c\u2500\u2500 templateInstallMachine.ts  # XState machine (4-step wizard)\n    \u2502       \u251c\u2500\u2500 useTemplatesBrowser.ts   # Headless filter/sort hook\n    \u2502       \u251c\u2500\u2500 useTemplateInstallWizard.ts  # Headless machine integration hook\n    \u2502       \u251c\u2500\u2500 TemplatesBrowser.tsx     # Platform wrapper\n    \u2502       \u251c\u2500\u2500 TemplatesBrowserDesktop.tsx\n    \u2502       \u251c\u2500\u2500 TemplatesBrowserMobile.tsx\n    \u2502       \u251c\u2500\u2500 TemplateFilters.tsx      # Filter sidebar/sheet\n    \u2502       \u251c\u2500\u2500 TemplateInstallWizard.tsx   # Platform wrapper\n    \u2502       \u251c\u2500\u2500 TemplateInstallWizardDesktop.tsx\n    \u2502       \u251c\u2500\u2500 TemplateInstallWizardMobile.tsx\n    \u2502       \u2514\u2500\u2500 wizard-steps/\n    \u2502           \u251c\u2500\u2500 index.ts\n    \u2502           \u251c\u2500\u2500 VariablesStep.tsx    # Step 1: Configure template variables\n    \u2502           \u251c\u2500\u2500 ReviewStep.tsx       # Step 2: Review before install\n    \u2502           \u251c\u2500\u2500 InstallingStep.tsx   # Step 3: Progress indicator\n    \u2502           \u2514\u2500\u2500 RoutingStep.tsx      # Step 4: Optional routing rules\n    \u251c\u2500\u2500 hooks/\n    \u2502   \u251c\u2500\u2500 useServiceConfigForm.ts      # Dynamic config form state + submit\n    \u2502   \u251c\u2500\u2500 useServiceAlertsTab.ts       # Alert list + filtering + pagination\n    \u2502   \u2514\u2500\u2500 useServiceAlertToasts.ts     # Real-time alert toast notifications\n    \u251c\u2500\u2500 machines/\n    \u2502   \u2514\u2500\u2500 update-machine.ts            # XState machine for service updates\n    \u251c\u2500\u2500 pages/\n    \u2502   \u251c\u2500\u2500 ServicesPage.tsx             # Main service marketplace page\n    \u2502   \u251c\u2500\u2500 ServiceDetailPage.tsx        # Per-instance detail with tabs\n    \u2502   \u251c\u2500\u2500 DeviceRoutingPage.tsx        # Device-to-service routing matrix\n    \u2502   \u2514\u2500\u2500 VLANSettingsPage.tsx         # VLAN pool management page\n    \u251c\u2500\u2500 schemas/\n    \u2502   \u251c\u2500\u2500 index.ts\n    \u2502   \u2514\u2500\u2500 service-sharing.schema.ts    # Zod schemas for import/export\n    \u2514\u2500\u2500 utils/\n        \u251c\u2500\u2500 index.ts\n        \u2514\u2500\u2500 zodSchemaBuilder.ts          # Dynamic Zod schema from backend ConfigSchema\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"pages",children:"Pages"}),"\n",(0,r.jsx)(s.h3,{id:"servicespage",children:(0,r.jsx)(s.code,{children:"ServicesPage"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/pages/ServicesPage.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["The primary landing page for the Feature Marketplace. Combines collapsible sections for system resource overview, available updates, storage management, and port allocations, followed by the main ",(0,r.jsx)(s.code,{children:"InstanceManager"})," pattern component displaying installed service instances."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Key behaviors:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Fetches all installed service instances via ",(0,r.jsx)(s.code,{children:"useServiceInstances(routerId)"})]}),"\n",(0,r.jsxs)(s.li,{children:["Maps instances to the ",(0,r.jsx)(s.code,{children:"Service"})," type expected by the ",(0,r.jsx)(s.code,{children:"InstanceManager"})," pattern"]}),"\n",(0,r.jsxs)(s.li,{children:["Reads UI state (search, filters, view mode, selection) from Zustand ",(0,r.jsx)(s.code,{children:"useServiceUIStore"})]}),"\n",(0,r.jsx)(s.li,{children:"Handles bulk lifecycle operations (start, stop, restart, delete) with toast feedback"}),"\n",(0,r.jsxs)(s.li,{children:["Opens ",(0,r.jsx)(s.code,{children:"InstallDialog"})," for new installations"]}),"\n",(0,r.jsxs)(s.li,{children:["Opens ",(0,r.jsx)(s.code,{children:"ServiceImportDialog"})," for importing shared service configurations"]}),"\n",(0,r.jsxs)(s.li,{children:["Opens ",(0,r.jsx)(s.code,{children:"StopDependentsDialog"})," when stopping an instance that has dependents"]}),"\n",(0,r.jsxs)(s.li,{children:["Collapsible ",(0,r.jsx)(s.code,{children:"UpdateAllPanel"})," appears only when ",(0,r.jsx)(s.code,{children:"useAvailableUpdates"})," returns results"]}),"\n",(0,r.jsxs)(s.li,{children:["Collapsible ",(0,r.jsx)(s.code,{children:"StorageSettings"})," auto-expands if external storage is configured or disconnected"]}),"\n",(0,r.jsxs)(s.li,{children:["Collapsible ",(0,r.jsx)(s.code,{children:"PortRegistryView"})," shows all port allocations across services"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"GraphQL queries used:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useServiceInstances(routerId)"})," - all service instances for this router"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useStorageConfig()"})," - external storage configuration"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useSystemResources(routerId)"})," - RAM/CPU totals and per-instance breakdown"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useAvailableUpdates({ routerId })"})," - update availability check"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useDependencies(featureId)"})," - dependency chain for stop safety checks"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Zustand selectors used:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"useServiceSearch()         // search query string\nuseCategoryFilter()        // 'all' | 'privacy' | 'proxy' | 'dns' | ...\nuseStatusFilter()          // 'all' | 'running' | 'stopped' | 'failed' | ...\nuseServiceViewMode()       // 'grid' | 'list'\nuseShowResourceMetrics()   // boolean - whether to show CPU/RAM gauges\nuseSelectedServices()      // string[] - currently selected instance IDs\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"servicedetailpage",children:(0,r.jsx)(s.code,{children:"ServiceDetailPage"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/pages/ServiceDetailPage.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:"Per-instance detail page organized as a tabbed interface. Automatically switches to the Diagnostics tab when an instance enters FAILED status."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Tabs:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Tab"}),(0,r.jsx)(s.th,{children:"Contents"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Overview"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"ServiceCard"}),", ",(0,r.jsx)(s.code,{children:"VirtualInterfaceBridge"}),", ",(0,r.jsx)(s.code,{children:"ResourceLimitsForm"}),", ",(0,r.jsx)(s.code,{children:"IsolationStatus"}),", ",(0,r.jsx)(s.code,{children:"GatewayStatusCard"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Configuration"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"ServiceConfigForm"})," using ",(0,r.jsx)(s.code,{children:"useServiceConfigForm"})," hook"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Traffic"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"ServiceTrafficPanel"})," (stats) + ",(0,r.jsx)(s.code,{children:"QuotaSettingsForm"})," (limits)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Logs"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"ServiceLogViewer"})," with filter and auto-scroll"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Alerts"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"ServiceAlertsTab"})," with real-time subscription"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Diagnostics"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"DiagnosticsPanel"})," with test history and manual run controls"]})]})]})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Key behaviors:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Fetches instance via ",(0,r.jsx)(s.code,{children:"useServiceInstance(routerId, instanceId)"})]}),"\n",(0,r.jsxs)(s.li,{children:["Polls gateway status every 5 seconds via ",(0,r.jsx)(s.code,{children:"useGatewayStatus"})]}),"\n",(0,r.jsxs)(s.li,{children:["Fetches isolation data via ",(0,r.jsx)(s.code,{children:"useInstanceIsolation"})]}),"\n",(0,r.jsxs)(s.li,{children:["Fetches health badge data via ",(0,r.jsx)(s.code,{children:"useInstanceHealth"})," (polling every 30 seconds for running instances)"]}),"\n",(0,r.jsxs)(s.li,{children:["Fetches binary verification status via ",(0,r.jsx)(s.code,{children:"useFeatureVerification"})]}),"\n",(0,r.jsxs)(s.li,{children:["Checks for available updates and renders ",(0,r.jsx)(s.code,{children:"UpdateIndicator"})," when an update is available"]}),"\n",(0,r.jsxs)(s.li,{children:["Export button opens ",(0,r.jsx)(s.code,{children:"ServiceExportDialog"})," for sharing the instance configuration"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"deviceroutingpage",children:(0,r.jsx)(s.code,{children:"DeviceRoutingPage"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/pages/DeviceRoutingPage.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:"Device-to-service routing management page. Allows administrators to assign network devices (discovered via DHCP and ARP) to service virtual interfaces, which routes that device's traffic through a specific service (e.g., route all traffic from a laptop through Tor)."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Key behaviors:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Fetches the routing matrix via ",(0,r.jsx)(s.code,{children:"useDeviceRoutingMatrix(routerId)"})," which returns devices, VIF interfaces, and current routing assignments"]}),"\n",(0,r.jsxs)(s.li,{children:["Subscribes to real-time routing changes via ",(0,r.jsx)(s.code,{children:"useDeviceRoutingSubscription(routerId)"})]}),"\n",(0,r.jsxs)(s.li,{children:["Shows a ",(0,r.jsx)(s.code,{children:"KillSwitchToggle"})," for global kill switch control at the top"]}),"\n",(0,r.jsxs)(s.li,{children:["Renders up to 5 active routing chains using ",(0,r.jsx)(s.code,{children:"RoutingChainViz"})," with hop-click to open ",(0,r.jsx)(s.code,{children:"ScheduleEditor"})]}),"\n",(0,r.jsxs)(s.li,{children:["Renders ",(0,r.jsx)(s.code,{children:"DeviceRoutingMatrix"})," pattern component with assign/remove/bulk-assign action handlers"]}),"\n",(0,r.jsxs)(s.li,{children:["Shows a bulk assignment progress bar when ",(0,r.jsx)(s.code,{children:"useBulkAssignRouting"})," is in progress"]}),"\n",(0,r.jsxs)(s.li,{children:["Opens ",(0,r.jsx)(s.code,{children:"ScheduleEditor"})," modal when a routing hop is clicked (for time-based routing schedules)"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Routing modes:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"MAC"})," - identifies the device by its MAC address (survives IP changes)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"IP"})," - identifies the device by its current IP address"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"vlansettingspage",children:(0,r.jsx)(s.code,{children:"VLANSettingsPage"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/pages/VLANSettingsPage.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:"VLAN pool configuration and allocation management page. Platform-aware layout: desktop shows a sidebar gauge + tabbed content area; mobile stacks the gauge at top followed by tabs."}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Three tabs:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Tab"}),(0,r.jsx)(s.th,{children:"Contents"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Pool Config"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"VLANPoolConfig"})," form - configure allocatable VLAN ID range (1-4094)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Allocations"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"VLANAllocationTable"})," pattern component with filter controls"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Diagnostics"}),(0,r.jsx)(s.td,{children:"Orphan detection and cleanup tools"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"VLAN allocation model:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Each installed service instance that uses VLAN isolation is allocated a VLAN ID from the pool"}),"\n",(0,r.jsx)(s.li,{children:"Pool range is configurable (e.g., VLANs 100-4000)"}),"\n",(0,r.jsxs)(s.li,{children:["Each VLAN generates a subnet template: ",(0,r.jsx)(s.code,{children:"10.{VLAN_ID}.0.0/24"})]}),"\n",(0,r.jsx)(s.li,{children:"Orphaned allocations arise when service instances are deleted without proper cleanup"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"components",children:"Components"}),"\n",(0,r.jsx)(s.h3,{id:"components-table",children:"Components Table"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Component"}),(0,r.jsx)(s.th,{children:"File"}),(0,r.jsx)(s.th,{children:"Purpose"}),(0,r.jsx)(s.th,{children:"Platform"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"InstallDialog"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/InstallDialog.tsx"})}),(0,r.jsx)(s.td,{children:"4-step install wizard: Select \u2192 Configure \u2192 Installing \u2192 Complete"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ChangelogModal"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ChangelogModal.tsx"})}),(0,r.jsx)(s.td,{children:"Display service version changelog"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"GatewayStatusCard"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/GatewayStatusCard.tsx"})}),(0,r.jsx)(s.td,{children:"SOCKS-to-TUN gateway health status"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"GatewayStatusCardDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/GatewayStatusCardDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Desktop presenter for gateway status"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"GatewayStatusCardMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/GatewayStatusCardMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Mobile presenter for gateway status"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PortRegistryView"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/PortRegistryView.tsx"})}),(0,r.jsx)(s.td,{children:"Port allocation registry viewer"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PortRegistryViewDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/PortRegistryViewDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Desktop port registry (dense table)"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PortRegistryViewMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/PortRegistryViewMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Mobile port registry (card list)"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ResourceLimitsForm"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ResourceLimitsForm.tsx"})}),(0,r.jsx)(s.td,{children:"cgroup memory/CPU limit configuration"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceAlertsTab"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceAlertsTab.tsx"})}),(0,r.jsx)(s.td,{children:"Alert list with filtering, pagination, multi-select acknowledge"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceAlertsTabDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceAlertsTabDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Desktop presenter (data table layout)"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceAlertsTabMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceAlertsTabMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Mobile presenter (card list layout)"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"StopDependentsDialog"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/StopDependentsDialog.tsx"})}),(0,r.jsx)(s.td,{children:"Warning dialog when stopping a service with dependents"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"UpdateAllPanel"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/UpdateAllPanel.tsx"})}),(0,r.jsx)(s.td,{children:"Bulk update with severity grouping"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"VLANPoolConfig"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/VLANPoolConfig.tsx"})}),(0,r.jsx)(s.td,{children:"VLAN range configuration form"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceConfigForm"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceConfigForm/ServiceConfigForm.tsx"})}),(0,r.jsx)(s.td,{children:"Dynamic config form (platform wrapper)"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceConfigFormDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceConfigForm/ServiceConfigFormDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Tabbed + 2-column grid layout"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceConfigFormMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceConfigForm/ServiceConfigFormMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Accordion layout, sticky buttons"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"DynamicField"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceConfigForm/DynamicField.tsx"})}),(0,r.jsxs)(s.td,{children:["Renders a single config field by its ",(0,r.jsx)(s.code,{children:"ConfigFieldType"})]}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"DiagnosticsPanel"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/DiagnosticsPanel/DiagnosticsPanel.tsx"})}),(0,r.jsx)(s.td,{children:"Diagnostic test results with run controls"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"DiagnosticsPanelDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/DiagnosticsPanel/DiagnosticsPanelDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Dense collapsible layout"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"DiagnosticsPanelMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/DiagnosticsPanel/DiagnosticsPanelMobile.tsx"})}),(0,r.jsx)(s.td,{children:"44px touch-friendly accordion"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceLogViewer"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceLogViewer/ServiceLogViewer.tsx"})}),(0,r.jsx)(s.td,{children:"Real-time service log stream"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceLogViewerDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceLogViewer/ServiceLogViewerDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Dense log table with inline filters"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceLogViewerMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceLogViewer/ServiceLogViewerMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Scrollable log list, bottom filters"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceTrafficPanel"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/service-traffic/ServiceTrafficPanel.tsx"})}),(0,r.jsx)(s.td,{children:"Traffic stats + rate display"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceTrafficPanelDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/service-traffic/ServiceTrafficPanelDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Grid layout with chart and breakdown"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceTrafficPanelMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/service-traffic/ServiceTrafficPanelMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Card stacked layout"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"QuotaSettingsForm"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/service-traffic/QuotaSettingsForm.tsx"})}),(0,r.jsx)(s.td,{children:"Configure traffic quota limits"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"StorageSettings"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/storage/StorageSettings.tsx"})}),(0,r.jsx)(s.td,{children:"External storage configuration"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"StorageSettingsDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/storage/StorageSettingsDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Two-column layout, dense tables"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"StorageSettingsMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/storage/StorageSettingsMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Stacked vertical layout"}),(0,r.jsx)(s.td,{children:"Mobile"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"StorageDisconnectBanner"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/storage/StorageDisconnectBanner.tsx"})}),(0,r.jsx)(s.td,{children:"Warning banner when storage is disconnected"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"StorageUsageBar"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/storage/StorageUsageBar.tsx"})}),(0,r.jsx)(s.td,{children:"Storage usage progress bar"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplatesBrowser"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplatesBrowser.tsx"})}),(0,r.jsx)(s.td,{children:"Template catalog (platform wrapper)"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplatesBrowserDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplatesBrowserDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"2-column grid + left sidebar filters"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplatesBrowserMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplatesBrowserMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Vertical list + bottom sheet filters"}),(0,r.jsx)(s.td,{children:"Mobile/Tablet"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplateFilters"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplateFilters.tsx"})}),(0,r.jsx)(s.td,{children:"Category/scope/type filter controls"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplateInstallWizard"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplateInstallWizard.tsx"})}),(0,r.jsx)(s.td,{children:"Install wizard (platform wrapper)"}),(0,r.jsx)(s.td,{children:"Auto"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplateInstallWizardDesktop"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplateInstallWizardDesktop.tsx"})}),(0,r.jsx)(s.td,{children:"Centered modal with side step nav"}),(0,r.jsx)(s.td,{children:"Desktop"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TemplateInstallWizardMobile"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/TemplateInstallWizardMobile.tsx"})}),(0,r.jsx)(s.td,{children:"Full-screen modal with bottom nav"}),(0,r.jsx)(s.td,{children:"Mobile/Tablet"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"VariablesStep"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/wizard-steps/VariablesStep.tsx"})}),(0,r.jsx)(s.td,{children:"Wizard step 1: configure template variables"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ReviewStep"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/wizard-steps/ReviewStep.tsx"})}),(0,r.jsx)(s.td,{children:"Wizard step 2: review before install"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"InstallingStep"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/wizard-steps/InstallingStep.tsx"})}),(0,r.jsx)(s.td,{children:"Wizard step 3: live installation progress"}),(0,r.jsx)(s.td,{children:"Any"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"RoutingStep"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/wizard-steps/RoutingStep.tsx"})}),(0,r.jsx)(s.td,{children:"Wizard step 4: optional routing rule selection"}),(0,r.jsx)(s.td,{children:"Any"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"service-install-flow",children:"Service Install Flow"}),"\n",(0,r.jsxs)(s.h3,{id:"direct-install-installdialog",children:["Direct Install (",(0,r.jsx)(s.code,{children:"InstallDialog"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:["The simplest installation path. Used from ",(0,r.jsx)(s.code,{children:"ServicesPage"}),' via the "Install" button.']}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"[ServicesPage]\n  \u2192 Button click \u2192 setInstallDialogOpen(true)\n  \u2192 <InstallDialog open routerId onSuccess>\n      Step 1: select    \u2192 useAvailableServices() \u2192 render service cards\n      Step 2: configure \u2192 instance name, VLAN ID, bind IP, ports\n      Step 3: installing \u2192 useInstallService() mutation\n                         \u2192 useInstallProgressSubscription(routerId) subscription\n                         \u2192 Progress bar updates on every subscription event\n                         \u2192 progress.status === 'completed' \u2192 step 4\n      Step 4: complete  \u2192 success icon, done button \u2192 onSuccess() \u2192 refetch()\n"})}),"\n",(0,r.jsx)(s.p,{children:"The install mutation input shape:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"installService({\n  variables: {\n    input: {\n      routerID: string,\n      featureID: string,        // e.g., 'tor', 'sing-box'\n      instanceName: string,\n      vlanID?: number,          // optional VLAN isolation (1-4094)\n      bindIP?: string,          // optional bind address\n      ports?: number[],         // optional port list\n      config: {},               // initial config (empty; configured later)\n    }\n  }\n})\n"})}),"\n",(0,r.jsxs)(s.h3,{id:"template-install-flow-templateinstallwizard",children:["Template Install Flow (",(0,r.jsx)(s.code,{children:"TemplateInstallWizard"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:["The template install flow is a 4-step guided process powered by ",(0,r.jsx)(s.code,{children:"templateInstallMachine"})," (XState) and orchestrated by ",(0,r.jsx)(s.code,{children:"useTemplateInstallWizard"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"[ServicesPage or TemplatesBrowser]\n  \u2192 User selects template \u2192 onInstall(template) callback\n  \u2192 <TemplateInstallWizard open routerId template onComplete>\n      \u2192 useTemplateInstallWizard hook (XState machine integration)\n          \u2192 createTemplateInstallMachine({ routerId, template, templateId })\n          \u2192 [state: variables]  \u2192 <VariablesStep>\n          \u2192 [state: review]     \u2192 <ReviewStep>\n          \u2192 [state: installing] \u2192 <InstallingStep>\n                                  \u2192 useInstallTemplate mutation fires\n                                  \u2192 useTemplateInstallProgress subscription\n                                  \u2192 PROGRESS_UPDATE events \u2192 machine context\n                                  \u2192 INSTALL_COMPLETE \u2192 [state: routing]\n          \u2192 [state: routing]    \u2192 <RoutingStep>\n                                  \u2192 User selects routing rules (optional)\n                                  \u2192 APPLY_ROUTING or SKIP_ROUTING \u2192 [final: completed]\n          \u2192 [final: completed]  \u2192 onComplete(instanceIDs)\n"})}),"\n",(0,r.jsxs)(s.h4,{id:"xstate-machine-templateinstallmachine",children:["XState Machine: ",(0,r.jsx)(s.code,{children:"templateInstallMachine"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/templates/templateInstallMachine.ts"})]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"// States\n'variables'   // Step 1: user fills template config variables\n'review'      // Step 2: user reviews the planned installation\n'installing'  // Step 3: mutation in progress, subscription updates context\n'routing'     // Step 4: optional routing rule selection\n'completed'   // Final: installation done\n'cancelled'   // Final: user cancelled\n'failed'      // Final: install failed\n\n// Context\ninterface TemplateInstallContext {\n  routerId: string;\n  template: ServiceTemplate | null;\n  templateId: string;\n  variables: Record<string, unknown>;\n  dryRun: boolean;\n  installResult: { success: boolean; instanceIDs: string[]; errors: string[] } | null;\n  progress: { phase: string; current: number; total: number; currentService: string | null } | null;\n  selectedRoutingRules: string[];\n  currentStep: number;         // 1-4, drives step indicator UI\n  errors: Record<string, string>;\n}\n\n// Key events\nSET_VARIABLES  \u2192 updates context.variables\nNEXT           \u2192 advances state (guarded by canGoNext)\nPREV           \u2192 goes back (blocked during installing)\nSTART_INSTALL  \u2192 transitions from review \u2192 installing\nINSTALL_COMPLETE \u2192 transitions from installing \u2192 routing\nINSTALL_FAILED  \u2192 transitions from installing \u2192 failed\nPROGRESS_UPDATE \u2192 updates context.progress (no state change)\nTOGGLE_ROUTING_RULE \u2192 toggles selected routing rules\nSKIP_ROUTING / APPLY_ROUTING \u2192 from routing \u2192 completed\nCANCEL         \u2192 from any non-final state \u2192 cancelled\n"})}),"\n",(0,r.jsxs)(s.h4,{id:"usetemplateinstallwizard-hook",children:[(0,r.jsx)(s.code,{children:"useTemplateInstallWizard"})," Hook"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/templates/useTemplateInstallWizard.ts"})]}),"\n",(0,r.jsx)(s.p,{children:"Integrates the XState machine with Apollo Client mutations and subscriptions:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const {\n  state,          // XState state object\n  context,        // TemplateInstallContext\n  send,           // (event: TemplateInstallEvent) => void\n  currentStep,    // 1 | 2 | 3 | 4\n  canGoNext,      // boolean\n  canGoPrev,      // boolean\n  isInstalling,   // boolean (state === 'installing')\n  isCompleted,    // boolean (state === 'completed')\n  isCancelled,    // boolean (state === 'cancelled')\n  isFailed,       // boolean (state === 'failed')\n} = useTemplateInstallWizard({ routerId, template, onComplete, onCancel, onError });\n"})}),"\n",(0,r.jsx)(s.p,{children:"Key integration details:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useInstallTemplate"})," mutation fires when ",(0,r.jsx)(s.code,{children:"state.matches('installing')"})," becomes true"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"useTemplateInstallProgress"})," subscription is enabled only while in the ",(0,r.jsx)(s.code,{children:"installing"})," state"]}),"\n",(0,r.jsxs)(s.li,{children:["Subscription progress events are forwarded to the machine as ",(0,r.jsx)(s.code,{children:"PROGRESS_UPDATE"})]}),"\n",(0,r.jsxs)(s.li,{children:["Mutation completion triggers ",(0,r.jsx)(s.code,{children:"INSTALL_COMPLETE"})," or ",(0,r.jsx)(s.code,{children:"INSTALL_FAILED"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"onCancel"})," callback is called when the machine reaches the ",(0,r.jsx)(s.code,{children:"cancelled"})," state"]}),"\n"]}),"\n",(0,r.jsxs)(s.h4,{id:"variablesstep-wizard-step-1",children:[(0,r.jsx)(s.code,{children:"VariablesStep"})," (Wizard Step 1)"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/templates/wizard-steps/VariablesStep.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Dynamically generates a React Hook Form from ",(0,r.jsx)(s.code,{children:"template.configVariables"}),". Builds a Zod schema inline using ",(0,r.jsx)(s.code,{children:"buildValidationSchema"})," which maps each ",(0,r.jsx)(s.code,{children:"TemplateVariable.type"})," to a Zod validator:"]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Variable Type"}),(0,r.jsx)(s.th,{children:"Input Rendered"}),(0,r.jsx)(s.th,{children:"Zod Validator"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"STRING"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:'<Input type="text">'})}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"z.string()"})," + optional regex"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"NUMBER"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:'<Input type="number">'})}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"z.coerce.number()"})," + min/max"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PORT"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:'<Input type="number">'})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.coerce.number().min(1).max(65535)"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"IP"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:'<Input type="text">'})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string().ip({ version: 'v4' })"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"BOOLEAN"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"<Switch>"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.boolean()"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ENUM"})}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"<Select>"})," with ",(0,r.jsx)(s.code,{children:"enumValues"})," options"]}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.enum([...enumValues])"})})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:["Changes are propagated to the parent via ",(0,r.jsx)(s.code,{children:"form.watch()"})," with debounced emission through ",(0,r.jsx)(s.code,{children:"onVariablesChange"}),"."]}),"\n",(0,r.jsxs)(s.h4,{id:"routingstep-wizard-step-4",children:[(0,r.jsx)(s.code,{children:"RoutingStep"})," (Wizard Step 4)"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/templates/wizard-steps/RoutingStep.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Displays ",(0,r.jsx)(s.code,{children:"template.suggestedRouting"})," rules as checkboxes. Each rule shows:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rule.description"})," - human-readable description"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rule.devicePattern"})," - which devices this rule applies to"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rule.targetService"})," - the service this rule routes to"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rule.protocol"})," - optional protocol filter"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rule.destinationPort"})," - optional destination port"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"If the template has no suggested routing, a placeholder card is shown and the user can proceed directly to completion."}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"templates-browser",children:"Templates Browser"}),"\n",(0,r.jsx)(s.h3,{id:"templatesbrowser",children:(0,r.jsx)(s.code,{children:"TemplatesBrowser"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/templates/TemplatesBrowser.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Platform detection: Mobile and Tablet use ",(0,r.jsx)(s.code,{children:"TemplatesBrowserMobile"})," (vertical list + bottom sheet filters); Desktop uses ",(0,r.jsx)(s.code,{children:"TemplatesBrowserDesktop"})," (2-column grid with left sidebar)."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-tsx",children:"<TemplatesBrowser\n  routerId={routerId}\n  onInstall={(template) => {\n    setSelectedTemplate(template);\n    setWizardOpen(true);\n  }}\n  onViewDetails={(template) => {\n    navigateToTemplateDetail(template.id);\n  }}\n/>\n"})}),"\n",(0,r.jsxs)(s.h3,{id:"usetemplatesbrowser-hook",children:[(0,r.jsx)(s.code,{children:"useTemplatesBrowser"})," Hook"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/templates/useTemplatesBrowser.ts"})]}),"\n",(0,r.jsxs)(s.p,{children:["Headless hook managing filter state and API calls. Applies server-side category/scope/text filtering via ",(0,r.jsx)(s.code,{children:"useServiceTemplates"})," query and client-side sort."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const {\n  templates,         // ServiceTemplate[] (filtered + sorted)\n  loading,           // boolean\n  error,             // Error | undefined\n  filters,           // TemplateBrowserFilters\n  updateFilters,     // (partial: Partial<TemplateBrowserFilters>) => void\n  resetFilters,      // () => void\n  hasActiveFilters,  // boolean\n  refetch,           // () => void\n} = useTemplatesBrowser(routerId);\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Filter shape:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"interface TemplateBrowserFilters {\n  searchQuery: string;                    // text search\n  category: ServiceTemplateCategory | null;  // 'privacy' | 'proxy' | 'dns' | null\n  scope: TemplateScope | null;            // 'GLOBAL' | 'PER_DEVICE' | 'PER_VLAN' | null\n  showBuiltIn: boolean;                   // marketplace templates\n  showCustom: boolean;                    // user-created templates\n  sortBy: TemplateSortBy;                 // 'name' | 'updated' | 'category' | 'services'\n}\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"dynamic-configuration-forms",children:"Dynamic Configuration Forms"}),"\n",(0,r.jsx)(s.h3,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsxs)(s.p,{children:["Every service exposes a ",(0,r.jsx)(s.code,{children:"ConfigSchema"})," from the backend that describes all configuration fields with their types, constraints, defaults, and conditional visibility rules. The frontend uses this schema to dynamically build:"]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["A Zod validation schema (via ",(0,r.jsx)(s.code,{children:"buildZodSchema"}),")"]}),"\n",(0,r.jsx)(s.li,{children:"A React Hook Form instance"}),"\n",(0,r.jsxs)(s.li,{children:["A set of rendered field components (via ",(0,r.jsx)(s.code,{children:"DynamicField"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(s.h3,{id:"useserviceconfigform-hook",children:[(0,r.jsx)(s.code,{children:"useServiceConfigForm"})," Hook"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/hooks/useServiceConfigForm.ts"})]}),"\n",(0,r.jsxs)(s.p,{children:["The master hook for service configuration forms. Fetches schema and current config from the backend, builds a Zod schema, initializes React Hook Form, evaluates ",(0,r.jsx)(s.code,{children:"showIf"})," conditions for field visibility, and handles two-phase validation (client + server)."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const formState = useServiceConfigForm({\n  serviceType: 'tor',\n  routerID: 'router-1',\n  instanceID: 'instance-123',\n  onSuccess: (configPath) => toast.success('Configuration applied!'),\n  onError: (message) => toast.error(message),\n});\n\n// formState.form              - UseFormReturn<any> from react-hook-form\n// formState.schema            - ConfigSchema | undefined\n// formState.visibleFields     - ConfigSchemaField[] (filtered by showIf conditions)\n// formState.handleSubmit      - () => Promise<void>\n// formState.isValidating      - boolean (client + server validation in progress)\n// formState.isSubmitting      - boolean (applyConfig mutation in progress)\n// formState.loading           - { schema: boolean; config: boolean }\n// formState.errors            - { schema: Error | undefined; config: Error | undefined }\n// formState.validate          - () => Promise<boolean> (manual trigger)\n// formState.refetch           - () => void\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Submit flow:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"handleSubmit()\n  \u2192 validate()\n      \u2192 form.trigger() (Zod client-side)\n      \u2192 validateConfig({ routerID, instanceID, config }) (server-side)\n      \u2192 if errors: form.setError() per field \u2192 return false\n  \u2192 applyConfig({ routerID, instanceID, config })\n  \u2192 if result.success: onSuccess(configPath)\n  \u2192 if !result.success: form.setError() per field + onError(message)\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Conditional field visibility:"}),"\nThe ",(0,r.jsx)(s.code,{children:"showIf"})," property on a ",(0,r.jsx)(s.code,{children:"ConfigSchemaField"})," is a simple expression string:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'"enableProxy === true"\n"authMode !== \'none\'"\n"enableProxy"   // simple boolean check\n'})}),"\n",(0,r.jsxs)(s.p,{children:["These are evaluated by ",(0,r.jsx)(s.code,{children:"evaluateCondition(condition, formValues)"})," in ",(0,r.jsx)(s.code,{children:"utils/zodSchemaBuilder.ts"}),"."]}),"\n",(0,r.jsxs)(s.h3,{id:"buildzodschema-utility",children:[(0,r.jsx)(s.code,{children:"buildZodSchema"})," Utility"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/utils/zodSchemaBuilder.ts"})]}),"\n",(0,r.jsxs)(s.p,{children:["Converts a ",(0,r.jsx)(s.code,{children:"ConfigSchema"})," from the backend GraphQL API into a ",(0,r.jsx)(s.code,{children:"z.ZodObject"})," for use with ",(0,r.jsx)(s.code,{children:"zodResolver"}),"."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Supported field types and their Zod schemas:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:(0,r.jsx)(s.code,{children:"ConfigFieldType"})}),(0,r.jsx)(s.th,{children:"Zod Schema"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TEXT"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string()"})}),(0,r.jsx)(s.td,{children:"+ optional regex, min/max length"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TEXT_AREA"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string()"})}),(0,r.jsx)(s.td,{children:"Same as TEXT"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PASSWORD"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string().min(8)"})}),(0,r.jsx)(s.td,{children:"+ optional regex, max"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"EMAIL"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string().email()"})}),(0,r.jsx)(s.td,{children:"Standard email format"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"URL"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string().url()"})}),(0,r.jsx)(s.td,{children:"Standard URL format"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"NUMBER"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.number()"})}),(0,r.jsx)(s.td,{children:"+ optional min/max"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TOGGLE"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.boolean()"})}),(0,r.jsx)(s.td,{})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"SELECT"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.enum([...options])"})}),(0,r.jsxs)(s.td,{children:["Options from ",(0,r.jsx)(s.code,{children:"field.options"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"MULTI_SELECT"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.array(z.enum([...options]))"})}),(0,r.jsx)(s.td,{children:"+ optional min/max items"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"TEXT_ARRAY"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.array(z.string())"})}),(0,r.jsx)(s.td,{children:"+ optional regex per item, min/max"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"IP"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string().regex(ipv4Regex)"})}),(0,r.jsx)(s.td,{children:"IPv4 only"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PORT"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.number().int().min(1).max(65535)"})}),(0,r.jsx)(s.td,{})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"PATH"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"z.string()"})}),(0,r.jsx)(s.td,{children:"+ optional regex"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:["Fields without ",(0,r.jsx)(s.code,{children:"required: true"})," are wrapped in ",(0,r.jsx)(s.code,{children:".optional()"}),"."]}),"\n",(0,r.jsxs)(s.h3,{id:"dynamicfield-component",children:[(0,r.jsx)(s.code,{children:"DynamicField"})," Component"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/ServiceConfigForm/DynamicField.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Renders the appropriate primitive field component based on ",(0,r.jsx)(s.code,{children:"field.type"}),", integrating with the React Hook Form ",(0,r.jsx)(s.code,{children:"control"})," object. Handles ",(0,r.jsx)(s.code,{children:"showIf"})," visibility gating so hidden fields are not rendered."]}),"\n",(0,r.jsxs)(s.h3,{id:"platform-presenters-for-serviceconfigform",children:["Platform Presenters for ",(0,r.jsx)(s.code,{children:"ServiceConfigForm"})]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Mobile"})," (",(0,r.jsx)(s.code,{children:"ServiceConfigFormMobile"}),"): Fields grouped in an accordion layout. Sections expand/collapse. Submit/cancel buttons are sticky at the bottom."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Desktop"})," (",(0,r.jsx)(s.code,{children:"ServiceConfigFormDesktop"}),"): Fields organized in a 2-column grid. Optional tabbed section grouping. Buttons inline at the bottom."]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"service-updates",children:"Service Updates"}),"\n",(0,r.jsx)(s.h3,{id:"update-check-flow",children:"Update Check Flow"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"ServicesPage\n  \u2192 useAvailableUpdates({ routerId })\n  \u2192 If updates.length > 0: show UpdateAllPanel in collapsible section\n  \u2192 ServiceDetailPage\n      \u2192 useAvailableUpdates + find update for this instanceId\n      \u2192 Show UpdateIndicator badge in page header\n"})}),"\n",(0,r.jsx)(s.h3,{id:"updateallpanel",children:(0,r.jsx)(s.code,{children:"UpdateAllPanel"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/UpdateAllPanel.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Displays available updates grouped by severity with a confirmation dialog before bulk updating. Updates are sorted by severity priority: ",(0,r.jsx)(s.code,{children:"SECURITY > MAJOR > MINOR > PATCH"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"interface UpdateAllPanelProps {\n  updates: AvailableUpdate[];\n  onUpdateAll?: () => void;          // triggers bulk update\n  onUpdate?: (instanceId: string) => void;  // single update\n  updatingInstances?: Record<string, boolean>;  // per-instance loading state\n  updateProgress?: Record<string, number>;  // per-instance progress (0-100)\n  loading?: boolean;\n}\n"})}),"\n",(0,r.jsx)(s.p,{children:"The component:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Renders severity badges (Security/Major/Minor/Patch counts)"}),"\n",(0,r.jsx)(s.li,{children:"Shows a security alert if any SECURITY updates are present"}),"\n",(0,r.jsx)(s.li,{children:"Lists first 5 updates sorted by severity"}),"\n",(0,r.jsxs)(s.li,{children:['"Update All" button opens a confirmation dialog before calling ',(0,r.jsx)(s.code,{children:"onUpdateAll"})]}),"\n"]}),"\n",(0,r.jsxs)(s.h3,{id:"updatemachine-xstate",children:[(0,r.jsx)(s.code,{children:"updateMachine"})," (XState)"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/machines/update-machine.ts"})]}),"\n",(0,r.jsx)(s.p,{children:"Tracks the lifecycle of a single service update operation. Used when updating an individual service instance."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"// States\n'idle'       // ready to start\n'updating'   // update in progress\n'complete'   // succeeded\n'rolledBack' // health check failed, auto-rolled back\n'failed'     // update failed\n\n// Context\ninterface UpdateContext {\n  instanceId: string | null;\n  fromVersion: string | null;\n  toVersion: string | null;\n  stage: UpdateStage;          // PENDING | DOWNLOADING | APPLYING | COMPLETE | FAILED | ROLLED_BACK\n  progress: number;            // 0-100\n  message: string;\n  error: string | null;\n  rolledBack: boolean;\n  startedAt: Date | null;\n  completedAt: Date | null;\n}\n\n// Usage with GraphQL subscription\nconst [state, send] = useMachine(updateMachine);\n\nsend({ type: 'START_UPDATE', instanceId, fromVersion, toVersion });\n\n// In useEffect watching the progress subscription:\nsend({ type: 'PROGRESS', stage, progress, message });\nsend({ type: 'COMPLETE', toVersion });           // on stage COMPLETE\nsend({ type: 'ROLLED_BACK', error });            // on rolledBack flag\nsend({ type: 'FAILED', error });                 // on stage FAILED\n\n// Reset after viewing result:\nsend({ type: 'RESET' });\n"})}),"\n",(0,r.jsxs)(s.p,{children:["The machine distinguishes between ",(0,r.jsx)(s.code,{children:"rolledBack"})," (backend health check triggered automatic rollback) and ",(0,r.jsx)(s.code,{children:"failed"})," (hard failure with no rollback). Both require an explicit ",(0,r.jsx)(s.code,{children:"RESET"})," event to return to ",(0,r.jsx)(s.code,{children:"idle"}),"."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"vlan-pool",children:"VLAN Pool"}),"\n",(0,r.jsxs)(s.h3,{id:"vlanpoolconfig-component",children:[(0,r.jsx)(s.code,{children:"VLANPoolConfig"})," Component"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/VLANPoolConfig.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:"Form for configuring the VLAN pool range used when allocating VLANs to new service instances. Uses React Hook Form + Zod with cross-field validation."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"// Validation schema\nconst vlanPoolConfigSchema = z.object({\n  poolStart: z.number().int().min(1).max(4094),\n  poolEnd:   z.number().int().min(1).max(4094),\n}).refine(\n  (data) => data.poolStart <= data.poolEnd,\n  { message: 'Pool start must be <= pool end', path: ['poolEnd'] }\n);\n"})}),"\n",(0,r.jsx)(s.p,{children:"The form shows warnings when:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["The new pool range is smaller than the current range (",(0,r.jsx)(s.code,{children:"isShrinking"})," flag)"]}),"\n",(0,r.jsxs)(s.li,{children:["The new range excludes VLANs that are currently allocated (",(0,r.jsx)(s.code,{children:"wouldExcludeCurrent"})," flag)"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"It also renders a live preview of:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Pool size (current vs. new)"}),"\n",(0,r.jsxs)(s.li,{children:["Subnet template: ",(0,r.jsx)(s.code,{children:"10.{VLAN_ID}.0.0/24"})," with an example"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Shrinking the pool requires an explicit browser ",(0,r.jsx)(s.code,{children:"window.confirm()"})," acknowledgment due to the risk of disrupting existing allocations."]}),"\n",(0,r.jsxs)(s.h3,{id:"vlansettingspage-vlan-allocation-table",children:[(0,r.jsx)(s.code,{children:"VLANSettingsPage"})," VLAN Allocation Table"]}),"\n",(0,r.jsxs)(s.p,{children:["The Allocations tab in ",(0,r.jsx)(s.code,{children:"VLANSettingsPage"})," uses the ",(0,r.jsx)(s.code,{children:"VLANAllocationTable"})," pattern component. Each row maps:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"{\n  id: alloc.id,\n  vlanID: alloc.vlanID,\n  serviceType: alloc.serviceType,\n  instanceName: alloc.serviceInstance.instanceName,\n  bindIP: alloc.subnet,\n  interfaceName: `vlan${alloc.vlanID}`,\n  status: alloc.status,\n  allocatedAt: alloc.allocatedAt,\n}\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"kill-switch",children:"Kill Switch"}),"\n",(0,r.jsx)(s.p,{children:"The Kill Switch is a network safety mechanism that blocks all traffic for a device if its assigned service instance goes down. This prevents traffic from leaking onto the unprotected network."}),"\n",(0,r.jsx)(s.h3,{id:"integration-points",children:"Integration Points"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.code,{children:"DeviceRoutingPage"})}),": Renders a global ",(0,r.jsx)(s.code,{children:"KillSwitchToggle"})," at the top of the page"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.code,{children:"RoutingChainViz"})}),": Each routing chain hop can show kill switch state via ",(0,r.jsx)(s.code,{children:"showKillSwitch"})," prop"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.code,{children:"RoutingChainData"})})," shape includes ",(0,r.jsx)(s.code,{children:"killSwitchEnabled"}),", ",(0,r.jsx)(s.code,{children:"killSwitchMode: 'BLOCK_ALL'"}),", and ",(0,r.jsx)(s.code,{children:"killSwitchActive"})," per chain"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"The backend enforces the kill switch at the VIF layer via MikroTik firewall rules. The frontend only provides the control UI - it sends mutations to enable/disable per device or globally."}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"device-routing",children:"Device Routing"}),"\n",(0,r.jsx)(s.p,{children:"Device routing implements Policy-Based Routing (PBR) on the MikroTik router. When a device is assigned to a service:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"The backend creates a routing mark tied to the service's VIF"}),"\n",(0,r.jsx)(s.li,{children:"A mangle rule marks all packets from that device's MAC/IP with the routing mark"}),"\n",(0,r.jsx)(s.li,{children:"A routing table entry sends marked packets through the service's VIF gateway"}),"\n"]}),"\n",(0,r.jsxs)(s.h3,{id:"deviceroutingmatrix-pattern",children:[(0,r.jsx)(s.code,{children:"DeviceRoutingMatrix"})," Pattern"]}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"DeviceRoutingMatrix"})," pattern component (from ",(0,r.jsx)(s.code,{children:"@nasnet/ui/patterns"}),") receives the routing matrix and action handlers:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"// Matrix data from useDeviceRoutingMatrix(routerId)\n{\n  devices: [{ deviceID, macAddress, ipAddress, hostname, ... }],\n  interfaces: [{ id, instanceID, instanceName, routingMark, gatewayType, ... }],\n  routings: [{ id, deviceID, macAddress, deviceIP, interfaceID, routingMark, active, routingMode, ... }],\n}\n\n// Actions\ninterface DeviceRoutingActions {\n  onAssign: (deviceID: string, interfaceID: string) => Promise<void>;\n  onRemove: (routingID: string) => Promise<void>;\n  onBulkAssign: (deviceIDs: string[], interfaceID: string) => Promise<void>;\n}\n"})}),"\n",(0,r.jsxs)(s.h3,{id:"routingchainviz-pattern",children:[(0,r.jsx)(s.code,{children:"RoutingChainViz"})," Pattern"]}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"RoutingChainViz"})," pattern (from ",(0,r.jsx)(s.code,{children:"@nasnet/ui/patterns"}),") visualizes the chain of services a device's traffic passes through. In ",(0,r.jsx)(s.code,{children:"DeviceRoutingPage"}),", chains are derived from ",(0,r.jsx)(s.code,{children:"matrix.routings"})," by grouping all routing entries by ",(0,r.jsx)(s.code,{children:"deviceID"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"interface RoutingChainData {\n  id: string;\n  deviceId: string;\n  deviceName: string | null;\n  deviceMac: string | null;\n  deviceIp: string | null;\n  hops: Array<{\n    id: string;\n    order: number;\n    serviceName: string;\n    serviceType?: string;\n    routingMark: string;\n    latencyMs: number | null;\n    healthy: boolean;\n    killSwitchActive: boolean;\n  }>;\n  active: boolean;\n  routingMode: 'MAC' | 'IP';\n  killSwitchEnabled: boolean;\n  killSwitchMode: 'BLOCK_ALL';\n  killSwitchActive: boolean;\n  totalLatencyMs: number | null;\n}\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"traffic-and-quota",children:"Traffic and Quota"}),"\n",(0,r.jsx)(s.h3,{id:"servicetrafficpanel",children:(0,r.jsx)(s.code,{children:"ServiceTrafficPanel"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/service-traffic/ServiceTrafficPanel.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Platform-aware wrapper that renders ",(0,r.jsx)(s.code,{children:"ServiceTrafficPanelDesktop"})," or ",(0,r.jsx)(s.code,{children:"ServiceTrafficPanelMobile"}),". Displays:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Total upload/download byte counters"}),"\n",(0,r.jsx)(s.li,{children:"Real-time upload/download rates (calculated via BigInt arithmetic)"}),"\n",(0,r.jsxs)(s.li,{children:["Historical traffic chart (last N hours, configurable via ",(0,r.jsx)(s.code,{children:"historyHours"})," prop)"]}),"\n",(0,r.jsx)(s.li,{children:"Per-device bandwidth breakdown"}),"\n",(0,r.jsx)(s.li,{children:"Traffic quota status with warning/exceeded indicators"}),"\n"]}),"\n",(0,r.jsxs)(s.h3,{id:"useservicetrafficpanel-hook",children:[(0,r.jsx)(s.code,{children:"useServiceTrafficPanel"})," Hook"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/service-traffic/use-service-traffic-panel.ts"})]}),"\n",(0,r.jsx)(s.p,{children:"Headless hook for traffic data management. Key behaviors:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Uses ",(0,r.jsx)(s.code,{children:"useTrafficMonitoring({ routerID, instanceID, historyHours })"})," for combined query + subscription"]}),"\n",(0,r.jsxs)(s.li,{children:["Calculates rates using ",(0,r.jsx)(s.code,{children:"BigInt"})," arithmetic to handle large byte counts without floating-point errors"]}),"\n",(0,r.jsx)(s.li,{children:"Detects counter resets (negative delta after service restart) and suppresses invalid rate values"}),"\n",(0,r.jsxs)(s.li,{children:["1-second delayed ",(0,r.jsx)(s.code,{children:"previousStats"})," ref prevents same-timestamp rate artifacts"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const trafficState = useServiceTrafficPanel({\n  routerID: 'router-1',\n  instanceID: 'xray-instance-1',\n  historyHours: 24,\n});\n\n// trafficState.stats             - ServiceTrafficStats | null\n// trafficState.uploadRate        - bigint | null (bytes/sec)\n// trafficState.downloadRate      - bigint | null (bytes/sec)\n// trafficState.quotaUsagePercent - number (0-100)\n// trafficState.quotaWarning      - boolean (warning threshold crossed)\n// trafficState.quotaExceeded     - boolean (hard limit reached)\n// trafficState.loading           - boolean\n// trafficState.error             - Error | null\n"})}),"\n",(0,r.jsx)(s.p,{children:"Rate calculation formula:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const intervalMs = currentTime - previousTime;\nconst uploadRate = (uploadDiff * 1000n) / BigInt(intervalMs); // bytes/sec\n"})}),"\n",(0,r.jsx)(s.h3,{id:"quotasettingsform",children:(0,r.jsx)(s.code,{children:"QuotaSettingsForm"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/service-traffic/QuotaSettingsForm.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:"Form for configuring traffic quota limits per service instance. Fields include:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Quota limit (total bytes allowed per period)"}),"\n",(0,r.jsx)(s.li,{children:"Warning threshold (percentage of quota that triggers a warning alert)"}),"\n",(0,r.jsx)(s.li,{children:"Period (daily, weekly, monthly)"}),"\n",(0,r.jsx)(s.li,{children:"Action on limit reached (block, alert-only)"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"storage-management",children:"Storage Management"}),"\n",(0,r.jsx)(s.h3,{id:"storagesettings",children:(0,r.jsx)(s.code,{children:"StorageSettings"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/storage/StorageSettings.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Platform-aware wrapper selecting ",(0,r.jsx)(s.code,{children:"StorageSettingsMobile"})," or ",(0,r.jsx)(s.code,{children:"StorageSettingsDesktop"}),". External storage allows service instances to persist their data (configs, databases, caches) to a USB drive or NFS mount, circumventing the router's limited flash storage."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Presenter differences:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Desktop"}),": Two-column layout with service breakdown table, inline mount point input, hover states"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Mobile"}),": Stacked vertical cards, full-width buttons, 44px touch targets, progressive disclosure"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsxs)(s.strong,{children:["Key features implemented in both presenters (via ",(0,r.jsx)(s.code,{children:"useStorageSettings"})," hook):"]})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Real-time storage status and usage metrics"}),"\n",(0,r.jsx)(s.li,{children:"Service-aware disconnect flow: lists which running services will be affected"}),"\n",(0,r.jsx)(s.li,{children:"Mount point validation"}),"\n",(0,r.jsxs)(s.li,{children:["Percentage-based usage bar (",(0,r.jsx)(s.code,{children:"StorageUsageBar"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:["Disconnect warning banner (",(0,r.jsx)(s.code,{children:"StorageDisconnectBanner"}),")"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"service-sharing-importexport",children:"Service Sharing (Import/Export)"}),"\n",(0,r.jsx)(s.h3,{id:"export-flow",children:"Export Flow"}),"\n",(0,r.jsxs)(s.p,{children:["From ",(0,r.jsx)(s.code,{children:"ServiceDetailPage"}),', the "Export" button opens ',(0,r.jsx)(s.code,{children:"ServiceExportDialog"})," (from ",(0,r.jsx)(s.code,{children:"@nasnet/ui/patterns"}),"). The export configuration is validated client-side using:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"// libs/features/services/src/schemas/service-sharing.schema.ts\n\nexport const exportServiceSchema = z.object({\n  routerID: z.string().min(1),\n  instanceID: z.string().min(1),\n  redactSecrets: z.boolean().default(true),     // redact passwords/keys\n  includeRoutingRules: z.boolean().default(false),\n});\n\nexport const generateQRSchema = z.object({\n  routerID: z.string().min(1),\n  instanceID: z.string().min(1),\n  redactSecrets: z.boolean().default(true),\n  includeRoutingRules: z.boolean().default(false),\n  imageSize: z.number().int().min(128).max(1024).default(256),\n});\n"})}),"\n",(0,r.jsx)(s.h3,{id:"import-flow",children:"Import Flow"}),"\n",(0,r.jsxs)(s.p,{children:["From ",(0,r.jsx)(s.code,{children:"ServicesPage"}),', the "Import" button opens ',(0,r.jsx)(s.code,{children:"ServiceImportDialog"})," (from ",(0,r.jsx)(s.code,{children:"@nasnet/ui/patterns"}),"). The import package JSON structure is validated before submission:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"export const importPackageSchema = z.object({\n  version: z.literal('1.0'),\n  exportedAt: z.string().datetime(),\n  exportedBy: z.string().min(1),\n  sourceRouter: z.object({ id: z.string(), name: z.string() }).optional(),\n  service: z.object({\n    featureID: z.string().min(1),\n    instanceName: z.string().min(1),\n    config: z.record(z.unknown()),\n    ports: z.array(z.number().int()).optional(),\n    vlanID: z.number().int().optional(),\n    bindIP: z.string().optional(),\n  }),\n  routingRules: z.array(z.object({\n    deviceMAC: z.string(),\n    deviceName: z.string().optional(),\n    mode: z.enum(['direct', 'through_service', 'blocked']),\n  })).optional(),\n  redactedFields: z.array(z.string()).optional(),  // field names that were redacted\n});\n\nexport const importServiceSchema = z.object({\n  routerID: z.string().min(1),\n  package: importPackageSchema,\n  dryRun: z.boolean().default(true),\n  conflictResolution: z.enum(['skip', 'rename', 'replace']).optional(),\n  deviceFilter: z.array(z.string()).optional(),\n  redactedFieldValues: z.record(z.string()).optional(),  // user-provided values for redacted fields\n});\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Validation helper:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"validateImportPackageJSON(jsonString: string): {\n  valid: boolean;\n  data?: ImportPackageData;\n  errors?: z.ZodError;\n}\n"})}),"\n",(0,r.jsxs)(s.p,{children:["If the imported package contains ",(0,r.jsx)(s.code,{children:"redactedFields"}),", the user is prompted to enter values for those fields before the import is submitted."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"service-dependencies",children:"Service Dependencies"}),"\n",(0,r.jsx)(s.h3,{id:"stopdependentsdialog",children:(0,r.jsx)(s.code,{children:"StopDependentsDialog"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/StopDependentsDialog.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:"Warning dialog displayed before stopping a service instance that other services depend on. Prevents accidental breakage of service chains."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"type StopMode = 'stop-dependents-first' | 'force-stop';\n\ninterface StopDependentsDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  instanceName: string;\n  featureId: string;\n  dependents: ServiceDependency[];   // from useServiceDependencies()\n  onConfirm: (mode: StopMode) => void;\n  isLoading?: boolean;\n}\n"})}),"\n",(0,r.jsx)(s.p,{children:"The dialog presents two options with RadioGroup:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Stop dependents first"})," (recommended): Gracefully stops dependent services in reverse dependency order before stopping the target instance"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Force stop"})," (dangerous): Immediately stops the instance; dependent services will receive ",(0,r.jsx)(s.code,{children:"FAILED"})," status"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Each dependent is shown with:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"StatusBadge"})," for current status"]}),"\n",(0,r.jsx)(s.li,{children:"Instance name and feature ID (monospace)"}),"\n",(0,r.jsxs)(s.li,{children:["Dependency type badge: ",(0,r.jsx)(s.code,{children:"REQUIRES"})," (red) or ",(0,r.jsx)(s.code,{children:"OPTIONAL"})," (warning/amber)"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"service-alerts",children:"Service Alerts"}),"\n",(0,r.jsx)(s.h3,{id:"servicealertstab",children:(0,r.jsx)(s.code,{children:"ServiceAlertsTab"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/ServiceAlertsTab.tsx"})]}),"\n",(0,r.jsxs)(s.p,{children:["Platform-aware wrapper for service instance alert management. Routes to ",(0,r.jsx)(s.code,{children:"ServiceAlertsTabDesktop"})," or ",(0,r.jsx)(s.code,{children:"ServiceAlertsTabMobile"})," based on ",(0,r.jsx)(s.code,{children:"usePlatform()"}),"."]}),"\n",(0,r.jsxs)(s.h3,{id:"useservicealertstab-hook",children:[(0,r.jsx)(s.code,{children:"useServiceAlertsTab"})," Hook"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/hooks/useServiceAlertsTab.ts"})]}),"\n",(0,r.jsx)(s.p,{children:"Complete headless hook for the alerts tab. Manages alert querying, real-time subscription, client-side search filtering, server-side severity/ack filtering, cursor-based pagination, multi-select, and bulk acknowledge."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"const tabState = useServiceAlertsTab({\n  routerId: 'router-1',\n  instanceId: 'instance-123',\n  initialPageSize: 25,\n  enableSubscription: true,\n});\n\n// tabState.alerts              - ServiceAlert[] (raw from GraphQL)\n// tabState.filteredAlerts      - ServiceAlert[] (after client-side searchTerm filter)\n// tabState.loading             - boolean\n// tabState.acknowledging       - boolean\n// tabState.error               - Error | undefined\n// tabState.filters             - { severity?, acknowledged?, searchTerm? }\n// tabState.setFilters          - (partial) => void\n// tabState.clearFilters        - () => void\n// tabState.pagination          - { currentPage, pageSize, totalCount, totalPages }\n// tabState.goToPage            - (page) => void\n// tabState.nextPage / prevPage - () => void\n// tabState.setPageSize         - (size) => void\n// tabState.selectedAlertIds    - Set<string>\n// tabState.toggleSelect        - (id) => void\n// tabState.selectAll           - () => void\n// tabState.clearSelection      - () => void\n// tabState.hasSelection        - boolean\n// tabState.acknowledgeAlert    - (id) => Promise<void>\n// tabState.acknowledgeBulk     - () => Promise<void>\n// tabState.refetch             - () => void\n// tabState.stats               - { total, critical, warning, info, unacknowledged }\n"})}),"\n",(0,r.jsx)(s.p,{children:"The hook layers two levels of filtering:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Server-side"}),": ",(0,r.jsx)(s.code,{children:"severity"})," and ",(0,r.jsx)(s.code,{children:"acknowledged"})," are sent as GraphQL query variables, reducing payload size"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Client-side"}),": ",(0,r.jsx)(s.code,{children:"searchTerm"})," is applied to ",(0,r.jsx)(s.code,{children:"alert.title"}),", ",(0,r.jsx)(s.code,{children:"alert.message"}),", and ",(0,r.jsx)(s.code,{children:"alert.eventType"})," after data arrives"]}),"\n"]}),"\n",(0,r.jsxs)(s.h3,{id:"useservicealerttoasts-hook",children:[(0,r.jsx)(s.code,{children:"useServiceAlertToasts"})," Hook"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/hooks/useServiceAlertToasts.ts"})]}),"\n",(0,r.jsx)(s.p,{children:"Subscribes to real-time alert events and displays toast notifications for new alerts. Used in the main app shell to provide ambient notifications regardless of which page is active."}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"diagnostics",children:"Diagnostics"}),"\n",(0,r.jsx)(s.h3,{id:"diagnosticspanel",children:(0,r.jsx)(s.code,{children:"DiagnosticsPanel"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/features/services/src/components/DiagnosticsPanel/DiagnosticsPanel.tsx"})]}),"\n",(0,r.jsx)(s.p,{children:'Displays diagnostic test history with pass/fail indicators and a manual "Run Diagnostics" button. Auto-scrolls to the latest result. Features:'}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Shows startup failure alerts when an instance enters the ",(0,r.jsx)(s.code,{children:"FAILED"})," state"]}),"\n",(0,r.jsxs)(s.li,{children:["Displays historical diagnostic runs (limited by ",(0,r.jsx)(s.code,{children:"maxHistory"})," prop)"]}),"\n",(0,r.jsx)(s.li,{children:"Real-time progress tracking during a manual diagnostic run"}),"\n",(0,r.jsx)(s.li,{children:"Expandable per-test details showing individual check results"}),"\n",(0,r.jsx)(s.li,{children:"Tablet/Desktop: dense collapsible layout; Mobile: 44px touch-friendly accordion"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-tsx",children:'<DiagnosticsPanel\n  routerId={routerId}\n  instanceId={instanceId}\n  serviceName="tor"     // used for display\n  maxHistory={10}\n  onDiagnosticsComplete={(results) => { /* results */ }}\n/>\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.h2,{id:"zustand-store-useserviceuistore",children:["Zustand Store: ",(0,r.jsx)(s.code,{children:"useServiceUIStore"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"File:"})," ",(0,r.jsx)(s.code,{children:"libs/state/stores/src/service-ui.store.ts"})]}),"\n",(0,r.jsxs)(s.p,{children:["Manages all transient UI state for the services feature. Uses ",(0,r.jsx)(s.code,{children:"zustand/middleware/persist"})," to selectively persist preferences to ",(0,r.jsx)(s.code,{children:"localStorage"}),"."]}),"\n",(0,r.jsx)(s.h3,{id:"persisted-state",children:"Persisted State"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Field"}),(0,r.jsx)(s.th,{children:"Type"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"wizardDraft"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceInstallWizardDraft | null"})}),(0,r.jsx)(s.td,{children:"Recovers in-progress wizard on page refresh"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"viewMode"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"'grid' | 'list'"})}),(0,r.jsx)(s.td,{children:"User's preferred instance list layout"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"showResourceMetrics"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"boolean"})}),(0,r.jsx)(s.td,{children:"Whether resource gauges are visible"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"showAdvancedConfig"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"boolean"})}),(0,r.jsx)(s.td,{children:"Whether advanced config sections are expanded"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"non-persisted-state",children:"Non-Persisted State"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Field"}),(0,r.jsx)(s.th,{children:"Type"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"serviceSearch"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"string"})}),(0,r.jsx)(s.td,{children:"Current search query in instance list"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"categoryFilter"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceCategory"})}),(0,r.jsx)(s.td,{children:"Active category filter"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"statusFilter"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ServiceStatusFilter"})}),(0,r.jsx)(s.td,{children:"Active status filter"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"selectedServices"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"string[]"})}),(0,r.jsx)(s.td,{children:"IDs of currently selected instances for bulk ops"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"wizardStep"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"number"})}),(0,r.jsx)(s.td,{children:"Current install wizard step"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"updateInProgress"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"Record<string, boolean>"})}),(0,r.jsx)(s.td,{children:"Per-instance update loading state"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"updateStage"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"Record<string, UpdateStage>"})}),(0,r.jsx)(s.td,{children:"Per-instance update stage"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"showUpdateAll"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"boolean"})}),(0,r.jsx)(s.td,{children:"Whether the update-all panel is expanded"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"selector-hooks-for-optimized-subscription",children:"Selector Hooks (for optimized subscription)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"import {\n  useServiceSearch,\n  useCategoryFilter,\n  useStatusFilter,\n  useSelectedServices,\n  useServiceWizardDraft,\n  useWizardStep,\n  useServiceViewMode,\n  useShowResourceMetrics,\n  useShowAdvancedConfig,\n  useUpdateInProgress,   // (instanceId: string) => boolean\n  useUpdateStage,        // (instanceId: string) => UpdateStage | undefined\n  useShowUpdateAll,\n} from '@nasnet/state/stores';\n"})}),"\n",(0,r.jsx)(s.p,{children:"Each selector subscribes only to the relevant slice, preventing unnecessary re-renders."}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"key-hooks-summary",children:"Key Hooks Summary"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Hook"}),(0,r.jsx)(s.th,{children:"File"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useServiceConfigForm"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"hooks/useServiceConfigForm.ts"})}),(0,r.jsx)(s.td,{children:"Schema fetch, Zod build, RHF integration, two-phase validation, apply mutation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useServiceAlertsTab"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"hooks/useServiceAlertsTab.ts"})}),(0,r.jsx)(s.td,{children:"Alert list with filtering, pagination, multi-select, acknowledge"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useServiceAlertToasts"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"hooks/useServiceAlertToasts.ts"})}),(0,r.jsx)(s.td,{children:"Real-time toast notifications for new alerts"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useTemplatesBrowser"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/useTemplatesBrowser.ts"})}),(0,r.jsxs)(s.td,{children:["Filter/sort state + ",(0,r.jsx)(s.code,{children:"useServiceTemplates"})," query"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useTemplateInstallWizard"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/useTemplateInstallWizard.ts"})}),(0,r.jsx)(s.td,{children:"XState machine + install mutation + progress subscription"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useServiceTrafficPanel"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/service-traffic/use-service-traffic-panel.ts"})}),(0,r.jsx)(s.td,{children:"Traffic stats + BigInt rate calculation + quota metrics"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useStorageSettings"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/storage/useStorageSettings.ts"})}),(0,r.jsx)(s.td,{children:"External storage config + status query"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useServiceLogViewer"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/ServiceLogViewer/useServiceLogViewer.ts"})}),(0,r.jsx)(s.td,{children:"Log streaming + filter state + auto-scroll"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"useDiagnosticsPanel"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/DiagnosticsPanel/useDiagnosticsPanel.ts"})}),(0,r.jsx)(s.td,{children:"Diagnostic history + run trigger + progress"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"xstate-machines",children:"XState Machines"}),"\n",(0,r.jsxs)(s.p,{children:["Cross-reference: see ",(0,r.jsx)(s.code,{children:"libs/features/docs/xstate-machines.md"})," for full XState documentation."]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Machine"}),(0,r.jsx)(s.th,{children:"File"}),(0,r.jsx)(s.th,{children:"States"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"templateInstallMachine"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/templateInstallMachine.ts"})}),(0,r.jsx)(s.td,{children:"variables, review, installing, routing, completed, cancelled, failed"}),(0,r.jsx)(s.td,{children:"Drives the 4-step template installation wizard"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"updateMachine"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"machines/update-machine.ts"})}),(0,r.jsx)(s.td,{children:"idle, updating, complete, rolledBack, failed"}),(0,r.jsx)(s.td,{children:"Tracks a single service update lifecycle with rollback detection"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"zod-schemas-summary",children:"Zod Schemas Summary"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Schema"}),(0,r.jsx)(s.th,{children:"File"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"exportServiceSchema"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"schemas/service-sharing.schema.ts"})}),(0,r.jsx)(s.td,{children:"Validates export configuration (redact flags, routing inclusion)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"generateQRSchema"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"schemas/service-sharing.schema.ts"})}),(0,r.jsx)(s.td,{children:"Validates QR code generation parameters"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"importPackageSchema"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"schemas/service-sharing.schema.ts"})}),(0,r.jsx)(s.td,{children:"Validates the structure of an imported service JSON package"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"importServiceSchema"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"schemas/service-sharing.schema.ts"})}),(0,r.jsx)(s.td,{children:"Full import request including conflict resolution and redacted values"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"redactedFieldValuesSchema"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"schemas/service-sharing.schema.ts"})}),(0,r.jsx)(s.td,{children:"Validates user-entered values for redacted secrets"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"vlanPoolConfigSchema"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/VLANPoolConfig.tsx"})}),(0,r.jsx)(s.td,{children:"VLAN range validation with cross-field refinement"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Dynamic config schemas"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"utils/zodSchemaBuilder.ts"})}),(0,r.jsxs)(s.td,{children:["Built at runtime from backend ",(0,r.jsx)(s.code,{children:"ConfigSchema"})," for each service type"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Variable schemas"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"components/templates/wizard-steps/VariablesStep.tsx"})}),(0,r.jsxs)(s.td,{children:["Built at runtime from ",(0,r.jsx)(s.code,{children:"template.configVariables"})]})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.h2,{id:"public-api-srcindexts",children:["Public API (",(0,r.jsx)(s.code,{children:"src/index.ts"}),")"]}),"\n",(0,r.jsx)(s.p,{children:"The module exports are organized into these groups:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Pages"}),": ",(0,r.jsx)(s.code,{children:"ServicesPage"}),", ",(0,r.jsx)(s.code,{children:"ServiceDetailPage"}),", ",(0,r.jsx)(s.code,{children:"VLANSettingsPage"}),", ",(0,r.jsx)(s.code,{children:"DeviceRoutingPage"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Install Components"}),": ",(0,r.jsx)(s.code,{children:"InstallDialog"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Port & Gateway"}),": ",(0,r.jsx)(s.code,{children:"PortRegistryView"}),", ",(0,r.jsx)(s.code,{children:"PortRegistryViewDesktop"}),", ",(0,r.jsx)(s.code,{children:"PortRegistryViewMobile"}),", ",(0,r.jsx)(s.code,{children:"GatewayStatusCard"}),", ",(0,r.jsx)(s.code,{children:"GatewayStatusCardDesktop"}),", ",(0,r.jsx)(s.code,{children:"GatewayStatusCardMobile"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Instance Management"}),": ",(0,r.jsx)(s.code,{children:"VLANPoolConfig"}),", ",(0,r.jsx)(s.code,{children:"StopDependentsDialog"}),", ",(0,r.jsx)(s.code,{children:"UpdateAllPanel"}),", ",(0,r.jsx)(s.code,{children:"ChangelogModal"}),", ",(0,r.jsx)(s.code,{children:"ResourceLimitsForm"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Storage Sub-module"}),": ",(0,r.jsx)(s.code,{children:"StorageSettings"}),", ",(0,r.jsx)(s.code,{children:"StorageSettingsDesktop"}),", ",(0,r.jsx)(s.code,{children:"StorageSettingsMobile"}),", ",(0,r.jsx)(s.code,{children:"StorageDisconnectBanner"}),", ",(0,r.jsx)(s.code,{children:"StorageUsageBar"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Logs & Diagnostics"}),": ",(0,r.jsx)(s.code,{children:"ServiceLogViewer"}),", ",(0,r.jsx)(s.code,{children:"DiagnosticsPanel"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Alerts"}),": ",(0,r.jsx)(s.code,{children:"ServiceAlertsTab"}),", ",(0,r.jsx)(s.code,{children:"ServiceAlertsTabDesktop"}),", ",(0,r.jsx)(s.code,{children:"ServiceAlertsTabMobile"}),", ",(0,r.jsx)(s.code,{children:"useServiceAlertsTab"}),", ",(0,r.jsx)(s.code,{children:"useServiceAlertToasts"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Traffic"}),": ",(0,r.jsx)(s.code,{children:"ServiceTrafficPanel"}),", ",(0,r.jsx)(s.code,{children:"ServiceTrafficPanelDesktop"}),", ",(0,r.jsx)(s.code,{children:"ServiceTrafficPanelMobile"}),", ",(0,r.jsx)(s.code,{children:"useServiceTrafficPanel"}),", ",(0,r.jsx)(s.code,{children:"QuotaSettingsForm"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Config Utilities"}),": ",(0,r.jsx)(s.code,{children:"buildZodSchema"}),", ",(0,r.jsx)(s.code,{children:"evaluateCondition"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Config Hooks"}),": ",(0,r.jsx)(s.code,{children:"useServiceConfigForm"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Config Components"}),": ",(0,r.jsx)(s.code,{children:"ServiceConfigForm"}),", ",(0,r.jsx)(s.code,{children:"ServiceConfigFormMobile"}),", ",(0,r.jsx)(s.code,{children:"ServiceConfigFormDesktop"}),", ",(0,r.jsx)(s.code,{children:"DynamicField"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Template Components"}),": ",(0,r.jsx)(s.code,{children:"TemplatesBrowser"}),", ",(0,r.jsx)(s.code,{children:"TemplatesBrowserMobile"}),", ",(0,r.jsx)(s.code,{children:"TemplatesBrowserDesktop"}),", ",(0,r.jsx)(s.code,{children:"TemplateFilters"}),", ",(0,r.jsx)(s.code,{children:"TemplateInstallWizard"}),", ",(0,r.jsx)(s.code,{children:"TemplateInstallWizardMobile"}),", ",(0,r.jsx)(s.code,{children:"TemplateInstallWizardDesktop"}),", ",(0,r.jsx)(s.code,{children:"useTemplatesBrowser"}),", ",(0,r.jsx)(s.code,{children:"useTemplateInstallWizard"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Wizard Steps"}),": ",(0,r.jsx)(s.code,{children:"VariablesStep"}),", ",(0,r.jsx)(s.code,{children:"ReviewStep"}),", ",(0,r.jsx)(s.code,{children:"InstallingStep"}),", ",(0,r.jsx)(s.code,{children:"RoutingStep"})]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"design-patterns",children:"Design Patterns"}),"\n",(0,r.jsx)(s.p,{children:"All components in this module adhere to the project-wide architectural patterns:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Headless + Platform Presenters"}),": Every significant component has a headless hook that owns business logic and separate Mobile/Desktop presenters that own rendering. The platform wrapper uses ",(0,r.jsx)(s.code,{children:"usePlatform()"})," to select the presenter."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"React.memo"}),": All presenters are wrapped in ",(0,r.jsx)(s.code,{children:"React.memo()"})," to prevent unnecessary re-renders. Display names are always set for React DevTools."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"XState for complex flows"}),": Multi-step workflows (template install, service update) use XState machines to make state transitions explicit, auditable, and testable."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Apollo Client for server state"}),": All router data (instances, traffic, alerts, templates) comes from GraphQL queries and subscriptions. No manual cache manipulation; subscription updates flow through Apollo's normalized cache automatically."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Zustand for UI state"}),": Ephemeral UI preferences (view mode, filters, selections) and wizard drafts live in ",(0,r.jsx)(s.code,{children:"useServiceUIStore"}),". Only preferences that should survive page refresh are persisted."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Zod for validation"}),": Both static (sharing schemas) and dynamic (config forms, template variables) validation uses Zod. Dynamic schemas are built at runtime from backend GraphQL types."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"WCAG AAA Accessibility"}),": All interactive elements have 44px minimum touch targets, ",(0,r.jsx)(s.code,{children:"aria-label"})," attributes, and ",(0,r.jsx)(s.code,{children:"role"})," attributes. Error states use ",(0,r.jsx)(s.code,{children:'role="alert"'})," with ",(0,r.jsx)(s.code,{children:'aria-live="polite"'}),". Progress indicators use ",(0,r.jsx)(s.code,{children:"aria-valuenow"}),", ",(0,r.jsx)(s.code,{children:"aria-valuemin"}),", ",(0,r.jsx)(s.code,{children:"aria-valuemax"}),"."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},71184:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>c});var i=n(14041);const r={},t=i.createContext(r);function l(e){const s=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(t.Provider,{value:s},e.children)}}}]);