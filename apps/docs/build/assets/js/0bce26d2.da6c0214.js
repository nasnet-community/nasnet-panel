"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[83411],{23589:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"flows/service-update-flow","title":"Flow: Service Update","description":"Traces the lifecycle of a service binary update \u2014 from scheduled version check through atomic 6-phase swap with config migration, health validation, and crash recovery.","source":"@site/../backend/docs/flows/service-update-flow.md","sourceDirName":"flows","slug":"/flows/service-update-flow","permalink":"/docs/backend/flows/service-update-flow","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/flows/service-update-flow.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Flow: Service Installation","permalink":"/docs/backend/flows/service-installation-flow"},"next":{"title":"Getting Started","permalink":"/docs/backend/getting-started"}}');var s=i(31085),t=i(71184);const a={},c="Flow: Service Update",d={},l=[{value:"Overview",id:"overview",level:2},{value:"Sequence Diagram \u2014 Scheduled Check",id:"sequence-diagram--scheduled-check",level:2},{value:"Sequence Diagram \u2014 6-Phase Atomic Update",id:"sequence-diagram--6-phase-atomic-update",level:2},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough",level:2},{value:"Step 1: Scheduler Tick and Gate Checks",id:"step-1-scheduler-tick-and-gate-checks",level:3},{value:"Step 2: Version Check via GitHub Registry",id:"step-2-version-check-via-github-registry",level:3},{value:"Step 3: Update Available Event",id:"step-3-update-available-event",level:3},{value:"Step 4: Auto-Apply Decision",id:"step-4-auto-apply-decision",level:3},{value:"Phase 1 \u2014 STAGING (Download and Verify)",id:"phase-1--staging-download-and-verify",level:3},{value:"Phase 2 \u2014 BACKUP (Backup Current Binary and Config)",id:"phase-2--backup-backup-current-binary-and-config",level:3},{value:"Phase 3 \u2014 SWAP (Stop Service, Atomic Binary Swap)",id:"phase-3--swap-stop-service-atomic-binary-swap",level:3},{value:"Phase 4 \u2014 MIGRATION (Config Migrations)",id:"phase-4--migration-config-migrations",level:3},{value:"Phase 5 \u2014 VALIDATION (Start Service and Health Check)",id:"phase-5--validation-start-service-and-health-check",level:3},{value:"Phase 6 \u2014 COMMIT (Finalize)",id:"phase-6--commit-finalize",level:3},{value:"Crash Recovery on Boot",id:"crash-recovery-on-boot",level:3},{value:"Journal Schema",id:"journal-schema",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Observability",id:"observability",level:2},{value:"Cross-References",id:"cross-references",level:2}];function o(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"flow-service-update",children:"Flow: Service Update"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Traces the lifecycle of a service binary update \u2014 from scheduled version check through atomic 6-phase swap with config migration, health validation, and crash recovery."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Touches:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/"}),", ",(0,s.jsx)(n.code,{children:"internal/registry/"}),"\n",(0,s.jsx)(n.strong,{children:"Entry Point:"})," ",(0,s.jsx)(n.code,{children:"UpdateScheduler.checkForUpdates()"})," in ",(0,s.jsx)(n.code,{children:"internal/features/updates/scheduler.go"}),"\n",(0,s.jsx)(n.strong,{children:"Prerequisites:"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"[See: 10-feature-marketplace.md \xa7Registry] \u2014 GitHub release registry and version checking"}),"\n",(0,s.jsx)(n.li,{children:"[See: 10-feature-marketplace.md \xa7Download] \u2014 DownloadManager used in Staging phase"}),"\n",(0,s.jsx)(n.li,{children:"[See: 06-service-orchestrator.md \xa7Supervisor] \u2014 InstanceStopper/InstanceStarter used in Swap/Validation phases"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["The update scheduler runs every 6 hours (configurable), checks each installed service instance against the GitHub release registry, and emits ",(0,s.jsx)(n.code,{children:"service.update.available"})," events. Security-critical updates (",(0,s.jsx)(n.code,{children:"SeverityCritical"}),") are auto-applied immediately; others require user action via GraphQL mutation. The 6-phase atomic update ensures zero data loss: a backup is taken before the swap, migrations run after, and the old binary is restored if the new one fails health checks. A SQLite-backed journal provides crash recovery if the update process is interrupted mid-flight."]}),"\n",(0,s.jsx)(n.h2,{id:"sequence-diagram--scheduled-check",children:"Sequence Diagram \u2014 Scheduled Check"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant UpdateScheduler\n    participant UpdateService\n    participant GitHub Registry\n    participant EventBus\n\n    UpdateScheduler->>UpdateService: tick (6h)\n    Note over UpdateScheduler: isQuietHours()<br/>[skip if 02-06]\n    Note over UpdateScheduler: isMeteredNetwork()<br/>[skip if LTE]\n    UpdateScheduler->>UpdateService: CheckForUpdate(featureID, currentVersion)\n    UpdateService->>GitHub Registry: GET /api/releases/latest\n    GitHub Registry--\x3e>UpdateService: {tag, assets, checksums}\n    Note over UpdateService: semver compare\n    UpdateService--\x3e>UpdateScheduler: {available, updateInfo}\n    UpdateScheduler->>EventBus: emitUpdateAvailable()\n    Note over EventBus: EventTypeServiceUpdateAvailable\n    Note over UpdateScheduler: shouldAutoApply()<br/>[yes: severity==CRITICAL]\n    Note over UpdateScheduler: go applyUpdate() (async)"}),"\n",(0,s.jsx)(n.h2,{id:"sequence-diagram--6-phase-atomic-update",children:"Sequence Diagram \u2014 6-Phase Atomic Update"}),"\n",(0,s.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant UpdateEngine\n    participant Journal (SQLite)\n    participant DownloadMgr\n    participant Verifier\n    participant InstanceStopper/Starter\n\n    UpdateEngine->>Journal (SQLite): ApplyUpdate()\n\n    rect rgb(200, 220, 255)\n    Note over UpdateEngine: PHASE 1: STAGING\n    UpdateEngine->>Journal (SQLite): BeginPhase(STAGING)\n    UpdateEngine->>DownloadMgr: fetchChecksum(checksumURL)\n    UpdateEngine->>DownloadMgr: Download(featureID, url, checksum)\n    DownloadMgr->>Verifier: HTTP GET\n    Verifier--\x3e>DownloadMgr: binary data\n    DownloadMgr->>DownloadMgr: SHA256 verify\n    UpdateEngine->>Journal (SQLite): CompletePhase(STAGING)\n    end\n\n    rect rgb(200, 220, 255)\n    Note over UpdateEngine: PHASE 2: BACKUP\n    UpdateEngine->>Journal (SQLite): BeginPhase(BACKUP)\n    UpdateEngine->>UpdateEngine: copyFile(current \u2192 backup)\n    UpdateEngine->>UpdateEngine: copyDir(config \u2192 backup/config)\n    UpdateEngine->>Journal (SQLite): CompletePhase(BACKUP)\n    end\n\n    rect rgb(200, 220, 255)\n    Note over UpdateEngine: PHASE 3: SWAP\n    UpdateEngine->>Journal (SQLite): BeginPhase(SWAP)\n    UpdateEngine->>InstanceStopper/Starter: Stop(instanceID)\n    UpdateEngine->>UpdateEngine: Rename(current \u2192 current.old)\n    UpdateEngine->>UpdateEngine: copyFile(staging \u2192 current)\n    UpdateEngine->>UpdateEngine: Chmod(current, 0755)\n    UpdateEngine->>UpdateEngine: Remove(current.old)\n    UpdateEngine->>Journal (SQLite): CompletePhase(SWAP)\n    end\n\n    rect rgb(200, 220, 255)\n    Note over UpdateEngine: PHASE 4: MIGRATION\n    UpdateEngine->>Journal (SQLite): BeginPhase(MIGRATION)\n    UpdateEngine->>UpdateEngine: MigratorRegistry.Get(featureID)\n    Note over UpdateEngine: migrator.CanMigrate(v1, v2)?\n    UpdateEngine->>UpdateEngine: ReadFile(config.json)\n    UpdateEngine->>UpdateEngine: migrator.Migrate(v1, v2, config)\n    UpdateEngine->>UpdateEngine: WriteFile(migrated config)\n    UpdateEngine->>Journal (SQLite): CompletePhase(MIGRATION)\n    end\n\n    rect rgb(200, 220, 255)\n    Note over UpdateEngine: PHASE 5: VALIDATION\n    UpdateEngine->>Journal (SQLite): BeginPhase(VALIDATION)\n    UpdateEngine->>InstanceStopper/Starter: Start(instanceID)\n    UpdateEngine->>UpdateEngine: sleep(3s)\n    UpdateEngine->>UpdateEngine: HealthChecker.GetStatus(instanceID)\n    Note over UpdateEngine: [status must == "HEALTHY"]\n    UpdateEngine->>Journal (SQLite): CompletePhase(VALIDATION)\n    end\n\n    rect rgb(200, 220, 255)\n    Note over UpdateEngine: PHASE 6: COMMIT\n    UpdateEngine->>Journal (SQLite): BeginPhase(COMMIT)\n    UpdateEngine->>UpdateEngine: RemoveAll(staging dir)\n    UpdateEngine->>Journal (SQLite): CompletePhase(COMMIT)\n    end\n\n    UpdateEngine->>UpdateEngine: emitUpdateCompleted event'}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Rollback (VALIDATION fails):"})}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant UpdateEngine\n    participant InstanceStopper\n    participant FS (backup)\n    participant InstanceStarter\n\n    Note over UpdateEngine: [VALIDATION fails: health != HEALTHY]\n    UpdateEngine->>UpdateEngine: rollback(instanceID, featureID, v1, v2)\n    UpdateEngine->>UpdateEngine: BeginPhase(ROLLBACK)\n    UpdateEngine->>InstanceStopper: Stop()\n    UpdateEngine->>FS (backup): copyFile(backup/featureID \u2192 current)\n    UpdateEngine->>FS (backup): copyDir(backup/config \u2192 config)\n    UpdateEngine->>InstanceStarter: Start()\n    UpdateEngine->>UpdateEngine: CompletePhase(ROLLBACK)"}),"\n",(0,s.jsx)(n.h2,{id:"step-by-step-walkthrough",children:"Step-by-Step Walkthrough"}),"\n",(0,s.jsx)(n.h3,{id:"step-1-scheduler-tick-and-gate-checks",children:"Step 1: Scheduler Tick and Gate Checks"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UpdateScheduler.schedulerLoop()"})," receives a tick from ",(0,s.jsx)(n.code,{children:"time.NewTicker(6h)"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/scheduler.go:150"})]}),"\n",(0,s.jsxs)(n.li,{children:["Gate 1: ",(0,s.jsx)(n.code,{children:"isQuietHours()"})," \u2014 checks configured quiet window (default: 02:00\u201306:00 in configured timezone). Overnight ranges handled correctly (e.g., 22:00\u201306:00)"]}),"\n",(0,s.jsxs)(n.li,{children:["Gate 2: ",(0,s.jsx)(n.code,{children:"isMeteredNetwork()"})," \u2014 checks ",(0,s.jsx)(n.code,{children:"NASNET_METERED_NETWORK=true"})," env var (or future LTE detection)"]}),"\n",(0,s.jsxs)(n.li,{children:["Queries all ",(0,s.jsx)(n.code,{children:"ServiceInstance"})," records from database"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-2-version-check-via-github-registry",children:"Step 2: Version Check via GitHub Registry"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UpdateService.CheckForUpdate(ctx, featureID, currentVersion)"})," is called per instance"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/registry/github.go"})]}),"\n",(0,s.jsxs)(n.li,{children:["Fetches latest release from GitHub API: ",(0,s.jsx)(n.code,{children:"GET /repos/{owner}/{repo}/releases/latest"})]}),"\n",(0,s.jsxs)(n.li,{children:["Parses semver tag (e.g., ",(0,s.jsx)(n.code,{children:"v1.2.3"}),") and compares to ",(0,s.jsx)(n.code,{children:"instance.BinaryVersion"})]}),"\n",(0,s.jsxs)(n.li,{children:["If ",(0,s.jsx)(n.code,{children:"latestVersion > currentVersion"}),": returns ",(0,s.jsx)(n.code,{children:"(updateInfo, true, nil)"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UpdateInfo"})," includes: ",(0,s.jsx)(n.code,{children:"AvailableVersion"}),", ",(0,s.jsx)(n.code,{children:"DownloadURL"}),", ",(0,s.jsx)(n.code,{children:"ChecksumURL"}),", ",(0,s.jsx)(n.code,{children:"ReleaseNotes"}),", ",(0,s.jsx)(n.code,{children:"Severity"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-3-update-available-event",children:"Step 3: Update Available Event"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"emitUpdateAvailableEvent(instance, updateInfo)"})," publishes to event bus"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/scheduler.go:362"})]}),"\n",(0,s.jsxs)(n.li,{children:["Event type: ",(0,s.jsx)(n.code,{children:"service.update.available"})," (priority: Low)"]}),"\n",(0,s.jsx)(n.li,{children:"GraphQL subscription receives this event \u2192 frontend shows update notification"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"step-4-auto-apply-decision",children:"Step 4: Auto-Apply Decision"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"shouldAutoApply(instance, updateInfo)"})," checks severity"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/scheduler.go:253"})]}),"\n",(0,s.jsxs)(n.li,{children:["Auto-applies only ",(0,s.jsx)(n.code,{children:"SeverityCritical"})," updates (security hotfixes)"]}),"\n",(0,s.jsxs)(n.li,{children:["Other severities (",(0,s.jsx)(n.code,{children:"SeverityNormal"}),", ",(0,s.jsx)(n.code,{children:"SeverityMajor"}),") wait for user confirmation"]}),"\n",(0,s.jsxs)(n.li,{children:["Auto-apply runs in a goroutine: ",(0,s.jsx)(n.code,{children:"go applyUpdate(instance, updateInfo)"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-1--staging-download-and-verify",children:"Phase 1 \u2014 STAGING (Download and Verify)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:175"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.BeginPhase(STAGING, metadata: {downloadURL, checksumURL})"})}),"\n",(0,s.jsxs)(n.li,{children:["Creates staging directory: ",(0,s.jsx)(n.code,{children:"{baseDir}/updates/{featureID}/{version}/staging/"})]}),"\n",(0,s.jsxs)(n.li,{children:["Fetches checksum from ",(0,s.jsx)(n.code,{children:"checksumURL"})," (sha256sum format: ",(0,s.jsx)(n.code,{children:'"hash  filename"'}),")"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"DownloadManager.Download(ctx, featureID, downloadURL, expectedChecksum)"})}),"\n",(0,s.jsx)(n.li,{children:"On checksum fetch failure: proceeds without verification (best-effort)"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.CompletePhase(STAGING)"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-2--backup-backup-current-binary-and-config",children:"Phase 2 \u2014 BACKUP (Backup Current Binary and Config)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:216"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.BeginPhase(BACKUP)"})}),"\n",(0,s.jsxs)(n.li,{children:["Creates backup directory: ",(0,s.jsx)(n.code,{children:"{baseDir}/updates/{featureID}/{instanceID}/backup/{currentVersion}/"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"copyFile(currentBinary \u2192 backupBinary)"})," \u2014 byte-for-byte copy"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"copyDir(configDir \u2192 backupDir/config)"})," \u2014 recursive directory copy (non-fatal if no config)"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.CompletePhase(BACKUP)"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-3--swap-stop-service-atomic-binary-swap",children:"Phase 3 \u2014 SWAP (Stop Service, Atomic Binary Swap)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:255"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.BeginPhase(SWAP)"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"InstanceStopper.Stop(instanceID)"})," \u2014 graceful stop via supervisor"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"os.Rename(current \u2192 current.old)"})," \u2014 move current binary out of the way"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"copyFile(stagingBinary \u2192 currentBinary)"})," \u2014 copy new binary into place","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["On failure: ",(0,s.jsx)(n.code,{children:"os.Rename(current.old \u2192 current)"})," restores the original"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"os.Chmod(currentBinary, 0755)"})," \u2014 make executable"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"os.Remove(current.old)"})," \u2014 cleanup"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.CompletePhase(SWAP)"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Triggers rollback if this fails"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-4--migration-config-migrations",children:"Phase 4 \u2014 MIGRATION (Config Migrations)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:306"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.BeginPhase(MIGRATION)"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"MigratorRegistry.Get(featureID)"})," \u2014 gets feature-specific migrator"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"migrator.CanMigrate(currentVersion, targetVersion)"})," \u2014 checks migration path exists"]}),"\n",(0,s.jsxs)(n.li,{children:["Reads current config JSON \u2192 runs ",(0,s.jsx)(n.code,{children:"migrator.Migrate(v1, v2, configMap)"})," \u2192 writes back"]}),"\n",(0,s.jsx)(n.li,{children:"If no config file: migration is skipped (non-fatal)"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.CompletePhase(MIGRATION)"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Triggers rollback if this fails"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-5--validation-start-service-and-health-check",children:"Phase 5 \u2014 VALIDATION (Start Service and Health Check)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:373"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.BeginPhase(VALIDATION)"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"InstanceStarter.Start(instanceID)"})," \u2014 starts via supervisor"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"time.Sleep(3s)"})," \u2014 wait for service to initialize"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"HealthChecker.GetStatus(instanceID)"})," \u2014 must return ",(0,s.jsx)(n.code,{children:'"HEALTHY"'})]}),"\n",(0,s.jsxs)(n.li,{children:["If health check fails: returns error \u2192 ",(0,s.jsx)(n.strong,{children:"triggers rollback"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.CompletePhase(VALIDATION)"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"phase-6--commit-finalize",children:"Phase 6 \u2014 COMMIT (Finalize)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:409"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.BeginPhase(COMMIT)"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"os.RemoveAll(stagingDir)"})," \u2014 cleanup temporary download"]}),"\n",(0,s.jsx)(n.li,{children:"Backup directory is retained for a rollback window (manual cleanup later)"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Journal.CompletePhase(COMMIT)"})}),"\n",(0,s.jsxs)(n.li,{children:["Emits ",(0,s.jsx)(n.code,{children:"service.update.completed"})," event with ",(0,s.jsx)(n.code,{children:"{previousVersion, newVersion, severity}"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"crash-recovery-on-boot",children:"Crash Recovery on Boot"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UpdateEngine.RecoverFromCrash(ctx)"})," is called on application startup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File:"})," ",(0,s.jsx)(n.code,{children:"internal/features/updates/engine.go:469"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Journal.GetIncompleteUpdates(ctx)"})," queries SQLite for rows with ",(0,s.jsx)(n.code,{children:"status='pending'"})," or ",(0,s.jsx)(n.code,{children:"status='failed'"})]}),"\n",(0,s.jsxs)(n.li,{children:["For each incomplete update: ",(0,s.jsx)(n.code,{children:"rollback(instanceID, featureID, fromVersion, toVersion)"})]}),"\n",(0,s.jsx)(n.li,{children:"Guarantees: even a power failure mid-SWAP can be recovered from"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"journal-schema",children:"Journal Schema"}),"\n",(0,s.jsxs)(n.p,{children:["The SQLite journal (",(0,s.jsx)(n.code,{children:"update_journal.db"}),") uses WAL mode (",(0,s.jsx)(n.code,{children:"PRAGMA journal_mode=WAL"}),") and ",(0,s.jsx)(n.code,{children:"PRAGMA synchronous=FULL"})," for power-safe writes:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE update_journal (\n  id INTEGER PRIMARY KEY,\n  instance_id TEXT NOT NULL,\n  feature_id  TEXT NOT NULL,\n  from_version TEXT NOT NULL,\n  to_version   TEXT NOT NULL,\n  phase        TEXT NOT NULL,  -- STAGING/BACKUP/SWAP/MIGRATION/VALIDATION/COMMIT/ROLLBACK\n  status       TEXT NOT NULL,  -- pending/success/failed\n  started_at   TIMESTAMP NOT NULL,\n  completed_at TIMESTAMP,\n  error_message TEXT,\n  metadata     TEXT,           -- JSON\n  UNIQUE(instance_id, to_version, phase)\n)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"UNIQUE"})," constraint ensures idempotent ",(0,s.jsx)(n.code,{children:"BeginPhase()"})," \u2014 re-running a failed phase from the same update restarts cleanly."]}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Phase"}),(0,s.jsx)(n.th,{children:"Failure"}),(0,s.jsx)(n.th,{children:"Recovery"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"STAGING: download fails"}),(0,s.jsx)(n.td,{children:"Network error / checksum mismatch"}),(0,s.jsxs)(n.td,{children:["Staging dir cleaned up; ",(0,s.jsx)(n.code,{children:"FailPhase(STAGING)"})," journaled; no rollback (BACKUP not started)"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SWAP: rename fails"}),(0,s.jsx)(n.td,{children:"Filesystem error"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"current.old"})," restored; ",(0,s.jsx)(n.code,{children:"FailPhase(SWAP)"}),"; ",(0,s.jsx)(n.strong,{children:"rollback triggered"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"MIGRATION: no migration path"}),(0,s.jsx)(n.td,{children:"Version gap"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"FailPhase(MIGRATION)"}),"; ",(0,s.jsx)(n.strong,{children:"rollback triggered"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"VALIDATION: health check fails"}),(0,s.jsx)(n.td,{children:"Service crashes / unhealthy"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"Rollback triggered"})," (backup restored, service restarted with old binary)"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ROLLBACK: backup restore fails"}),(0,s.jsx)(n.td,{children:"Backup corrupted / missing"}),(0,s.jsx)(n.td,{children:"Error logged; service may be left in broken state; manual intervention required"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Crash during SWAP"}),(0,s.jsx)(n.td,{children:"Power loss"}),(0,s.jsxs)(n.td,{children:["Journal has ",(0,s.jsx)(n.code,{children:"SWAP"})," as ",(0,s.jsx)(n.code,{children:"pending"})," \u2192 ",(0,s.jsx)(n.code,{children:"RecoverFromCrash"})," runs rollback on next boot"]})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"observability",children:"Observability"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Events emitted (event bus):"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service.update.available"})," (PriorityLow) \u2014 update detected, not yet applied"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service.update.started"})," (PriorityCritical) \u2014 update application beginning"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service.update.completed"})," (PriorityCritical) \u2014 update applied successfully"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service.update.failed"})," (PriorityCritical) \u2014 update failed, rollback performed"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Logs generated:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"INFO: Starting atomic update"})," with instanceID, featureID, currentVersion, targetVersion"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"INFO: Starting STAGING phase"}),", ",(0,s.jsx)(n.code,{children:"BACKUP phase"}),", etc. per phase"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"ERROR: SWAP phase failed, attempting rollback"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"WARN: config backup skipped (no config directory or copy failed)"})," \u2014 non-fatal"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"INFO: Atomic update completed successfully"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"WARN: Found incomplete updates, attempting recovery"})," with count"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"[See: 10-feature-marketplace.md \xa7Updates] \u2014 UpdateService and UpdateInfo model"}),"\n",(0,s.jsx)(n.li,{children:"[See: 10-feature-marketplace.md \xa7Registry] \u2014 GitHub registry API and checksum format"}),"\n",(0,s.jsx)(n.li,{children:"[See: 10-feature-marketplace.md \xa7Download] \u2014 DownloadManager (reused in Staging phase)"}),"\n",(0,s.jsx)(n.li,{children:"[See: 06-service-orchestrator.md \xa7Supervisor] \u2014 InstanceStopper/InstanceStarter interfaces"}),"\n",(0,s.jsx)(n.li,{children:"[See: 06-service-orchestrator.md \xa7Health] \u2014 HealthChecker used in Validation phase"}),"\n",(0,s.jsx)(n.li,{children:"[See: 01-service-installation-flow.md] \u2014 related initial installation flow"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},71184:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>c});var r=i(14041);const s={},t=r.createContext(s);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);