"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[43794],{63552:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"cross-cutting-features/virtual-interface-factory","title":"Virtual Interface Factory (VIF)","description":"A Virtual Interface (VIF) is a dedicated network interface created on the MikroTik router for each service instance. It provides complete network isolation: each service gets its own VLAN, IP address, and routing mark, so service traffic is kept separate from LAN, WAN, and other services.","source":"@site/../connect/docs/cross-cutting-features/virtual-interface-factory.md","sourceDirName":"cross-cutting-features","slug":"/cross-cutting-features/virtual-interface-factory","permalink":"/docs/frontend/cross-cutting-features/virtual-interface-factory","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../connect/docs/cross-cutting-features/virtual-interface-factory.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Service Marketplace","permalink":"/docs/frontend/cross-cutting-features/service-marketplace"},"next":{"title":"GraphQL Code Generation","permalink":"/docs/frontend/data-fetching/codegen"}}');var s=t(31085),i=t(71184);const a={},c="Virtual Interface Factory (VIF)",d={},l=[{value:"What VIF Provides",id:"what-vif-provides",level:2},{value:"VIF Lifecycle",id:"vif-lifecycle",level:2},{value:"GraphQL Types",id:"graphql-types",level:2},{value:"Frontend GraphQL Queries",id:"frontend-graphql-queries",level:2},{value:"React Hooks",id:"react-hooks",level:2},{value:"<code>useVirtualInterfaces(routerId)</code>",id:"usevirtualinterfacesrouterid",level:3},{value:"<code>useVirtualInterface(routerId, instanceId)</code>",id:"usevirtualinterfacerouterid-instanceid",level:3},{value:"TypeScript Interface",id:"typescript-interface",level:2},{value:"Isolation Model",id:"isolation-model",level:2},{value:"VLAN Isolation",id:"vlan-isolation",level:3},{value:"IP Addressing",id:"ip-addressing",level:3},{value:"Policy-Based Routing (PBR)",id:"policy-based-routing-pbr",level:3},{value:"Gateway Chaining",id:"gateway-chaining",level:3},{value:"Displaying VIF Status",id:"displaying-vif-status",level:2},{value:"VLAN Pool Management",id:"vlan-pool-management",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"virtual-interface-factory-vif",children:"Virtual Interface Factory (VIF)"})}),"\n",(0,s.jsx)(n.p,{children:"A Virtual Interface (VIF) is a dedicated network interface created on the MikroTik router for each service instance. It provides complete network isolation: each service gets its own VLAN, IP address, and routing mark, so service traffic is kept separate from LAN, WAN, and other services."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key files:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"libs/api-client/queries/src/services/useVirtualInterfaces.ts"})," \u2014 GraphQL hooks"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"apps/backend/internal/vif/"})," \u2014 backend VIF management (reference)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"apps/backend/internal/ent-schema/schema/virtualinterface.go"})," \u2014 database schema"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Cross-references:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["See ",(0,s.jsx)(n.code,{children:"service-marketplace.md"})," for how services use VIFs"]}),"\n",(0,s.jsxs)(n.li,{children:["See ",(0,s.jsx)(n.code,{children:"../data-fetching/graphql-hooks.md"})," for polling patterns"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"what-vif-provides",children:"What VIF Provides"}),"\n",(0,s.jsx)(n.p,{children:"Each service instance gets:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Resource"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"VLAN ID"}),(0,s.jsx)(n.td,{children:"Traffic segregation at Layer 2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"IP address"}),(0,s.jsx)(n.td,{children:"Unique address in a private subnet"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Routing mark"}),(0,s.jsx)(n.td,{children:"Policy-based routing \u2014 routes service traffic separately"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"TUN interface (optional)"}),(0,s.jsx)(n.td,{children:"For services that need a tun/tap device (e.g., VPN clients)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Gateway tunnel (optional)"}),(0,s.jsx)(n.td,{children:"For chain routing through another service"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"This means a Tor instance and a sing-box instance on the same router are completely isolated. If sing-box is misconfigured and drops all traffic, Tor continues running normally."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"vif-lifecycle",children:"VIF Lifecycle"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Service Installation\n    \u2502\n    \u2502  Backend creates VIF entry (status: CREATING)\n    \u25bc\nCREATING \u2014 backend applies MikroTik config (VLAN, IP, routing rules)\n    \u2502\n    \u2502  MikroTik confirms\n    \u25bc\nACTIVE \u2014 service traffic routing enabled\n    \u2502\n    \u2502  Service uninstall\n    \u25bc\nREMOVING \u2014 backend tears down MikroTik config\n    \u2502\n    \u25bc\n(deleted)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["On error during creation or removal: status becomes ",(0,s.jsx)(n.code,{children:"ERROR"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"graphql-types",children:"GraphQL Types"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:'type VirtualInterface {\n  id: ID!\n  instanceId: ID!           # Service instance this VIF belongs to\n  name: String!             # Interface name on the router (e.g., "vlan100-tor")\n  vlanId: Int!              # VLAN tag (auto-allocated from VLAN pool)\n  ipAddress: String!        # IP address (e.g., "10.100.0.1/24")\n  gatewayType: GatewayType! # NONE or HEV_SOCKS5_TUNNEL\n  gatewayStatus: GatewayStatus!\n  tunName: String           # TUN device name (optional)\n  routingMark: String!      # MikroTik routing mark for PBR\n  status: VirtualInterfaceStatus!\n  createdAt: DateTime!\n  updatedAt: DateTime!\n}\n\nenum VirtualInterfaceStatus { CREATING, ACTIVE, ERROR, REMOVING }\nenum GatewayType { NONE, HEV_SOCKS5_TUNNEL }\nenum GatewayStatus { STOPPED, STARTING, RUNNING, FAILED }\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"frontend-graphql-queries",children:"Frontend GraphQL Queries"}),"\n",(0,s.jsxs)(n.p,{children:["Defined in ",(0,s.jsx)(n.code,{children:"useVirtualInterfaces.ts"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-graphql",children:"query GetVirtualInterfaces($routerID: ID!) {\n  virtualInterfaces(routerID: $routerID) {\n    id instanceId name vlanId ipAddress\n    gatewayType gatewayStatus tunName routingMark status\n    createdAt updatedAt\n  }\n}\n\nquery GetVirtualInterface($routerID: ID!, $instanceID: ID!) {\n  virtualInterface(routerID: $routerID, instanceID: $instanceID) {\n    # same fields\n  }\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"react-hooks",children:"React Hooks"}),"\n",(0,s.jsx)(n.h3,{id:"usevirtualinterfacesrouterid",children:(0,s.jsx)(n.code,{children:"useVirtualInterfaces(routerId)"})}),"\n",(0,s.jsx)(n.p,{children:"Fetches all VIFs for a router. Polls every 10 seconds for status updates."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { useVirtualInterfaces } from '@nasnet/api-client/queries';\n\nconst { interfaces, loading, error, refetch } = useVirtualInterfaces('router-1');\n\n// interfaces: VirtualInterface[]\n// loading: boolean\n// error: ApolloError | undefined\n// refetch: () => void\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Uses ",(0,s.jsx)(n.code,{children:"fetchPolicy: 'cache-and-network'"})," so stale cache is shown immediately while fresh data loads."]}),"\n",(0,s.jsx)(n.h3,{id:"usevirtualinterfacerouterid-instanceid",children:(0,s.jsx)(n.code,{children:"useVirtualInterface(routerId, instanceId)"})}),"\n",(0,s.jsx)(n.p,{children:"Fetches a single VIF by service instance ID. Also polls every 10 seconds."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { useVirtualInterface } from '@nasnet/api-client/queries';\n\nconst { interface: vif, loading } = useVirtualInterface('router-1', 'instance-123');\n\nif (vif) {\n  console.log(`${vif.name}: ${vif.ipAddress} (VLAN ${vif.vlanId})`);\n  console.log(`Status: ${vif.status}, Gateway: ${vif.gatewayType} (${vif.gatewayStatus})`);\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"typescript-interface",children:"TypeScript Interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface VirtualInterface {\n  id: string;\n  instanceId: string;\n  name: string;\n  vlanId: number;\n  ipAddress: string;\n  gatewayType: GatewayType;     // NONE | HEV_SOCKS5_TUNNEL\n  gatewayStatus: GatewayStatus; // STOPPED | STARTING | RUNNING | FAILED\n  tunName?: string;\n  routingMark: string;\n  status: VirtualInterfaceStatus; // CREATING | ACTIVE | ERROR | REMOVING\n  createdAt: string;\n  updatedAt: string;\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"isolation-model",children:"Isolation Model"}),"\n",(0,s.jsx)(n.h3,{id:"vlan-isolation",children:"VLAN Isolation"}),"\n",(0,s.jsxs)(n.p,{children:["Each VIF is assigned a VLAN ID from the VLAN pool (tracked by ",(0,s.jsx)(n.code,{children:"useVLANAllocations"}),"). Traffic from the service is tagged with this VLAN ID, so the MikroTik bridge separates it at hardware level."]}),"\n",(0,s.jsx)(n.h3,{id:"ip-addressing",children:"IP Addressing"}),"\n",(0,s.jsxs)(n.p,{children:["Each VIF gets a /24 subnet from a private pool (e.g., ",(0,s.jsx)(n.code,{children:"10.100.{vlanId}.0/24"}),"). The service binds to the ",(0,s.jsx)(n.code,{children:".1"})," address; the router interface is the gateway."]}),"\n",(0,s.jsx)(n.h3,{id:"policy-based-routing-pbr",children:"Policy-Based Routing (PBR)"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"routingMark"})," is applied to packets from the service's process. The router uses this mark to route packets through a specific routing table \u2014 separate from the main routing table. This allows:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Service traffic to exit through a specific WAN interface"}),"\n",(0,s.jsx)(n.li,{children:"Service traffic to chain through another proxy service (gateway)"}),"\n",(0,s.jsx)(n.li,{children:"Kill-switch enforcement when the gateway is down"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"gateway-chaining",children:"Gateway Chaining"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.code,{children:"gatewayType"})," is ",(0,s.jsx)(n.code,{children:"HEV_SOCKS5_TUNNEL"}),", the VIF's gateway routes all service egress through a local SOCKS5 tunnel that connects to another service instance. This is how you chain Tor \u2192 sing-box or Psiphon \u2192 sing-box."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"gatewayStatus"})," field tells the frontend whether the gateway tunnel is running. If ",(0,s.jsx)(n.code,{children:"gatewayStatus"})," is ",(0,s.jsx)(n.code,{children:"FAILED"}),", the kill-switch may activate (see ",(0,s.jsx)(n.code,{children:"useKillSwitch"}),")."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"displaying-vif-status",children:"Displaying VIF Status"}),"\n",(0,s.jsx)(n.p,{children:"Status badges in the UI:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Status"}),(0,s.jsx)(n.th,{children:"Color"}),(0,s.jsx)(n.th,{children:"Meaning"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ACTIVE"}),(0,s.jsx)(n.td,{children:"Green"}),(0,s.jsx)(n.td,{children:"VIF is fully configured and routing traffic"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"CREATING"}),(0,s.jsx)(n.td,{children:"Amber"}),(0,s.jsx)(n.td,{children:"VIF is being provisioned (polling until ACTIVE)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"ERROR"}),(0,s.jsx)(n.td,{children:"Red"}),(0,s.jsx)(n.td,{children:"Provisioning failed; manual inspection needed"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"REMOVING"}),(0,s.jsx)(n.td,{children:"Amber"}),(0,s.jsx)(n.td,{children:"VIF teardown in progress"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Gateway status badges:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Status"}),(0,s.jsx)(n.th,{children:"Color"}),(0,s.jsx)(n.th,{children:"Meaning"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"RUNNING"}),(0,s.jsx)(n.td,{children:"Green"}),(0,s.jsx)(n.td,{children:"Gateway tunnel is active"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"STOPPED"}),(0,s.jsx)(n.td,{children:"Gray"}),(0,s.jsx)(n.td,{children:"Gateway not in use or stopped"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"STARTING"}),(0,s.jsx)(n.td,{children:"Amber"}),(0,s.jsx)(n.td,{children:"Gateway tunnel starting up"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"FAILED"}),(0,s.jsx)(n.td,{children:"Red"}),(0,s.jsx)(n.td,{children:"Gateway tunnel failed; kill-switch may activate"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"vlan-pool-management",children:"VLAN Pool Management"}),"\n",(0,s.jsx)(n.p,{children:"VLAN IDs are managed server-side but surfaced to the UI via:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Get current VLAN pool config\nconst { poolStatus } = useVLANPoolStatus(routerId);\n\n// Get current allocations\nconst { allocations } = useVLANAllocations(routerId);\n\n// Update pool configuration\nconst { updatePoolConfig } = useUpdateVLANPoolConfig();\n\n// Clean up orphaned VLANs (allocated but no matching instance)\nconst { cleanupOrphanedVLANs } = useCleanupOrphanedVLANs();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The VLAN pool is shown in ",(0,s.jsx)(n.code,{children:"VLANSettingsPage"})," (",(0,s.jsx)(n.code,{children:"libs/features/services/src/pages/VLANSettingsPage.tsx"}),")."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var r=t(14041);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);