"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[17897],{41974:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"xstate-machines","title":"XState Machines Reference","description":"This document catalogues every XState machine in NasNetConnect. Machines are used for workflows where simple boolean flags or Zustand state become insufficient \u2014 specifically where there are multiple sequential async steps, guards that prevent invalid transitions, and rollback/error recovery paths.","source":"@site/../../libs/features/docs/xstate-machines.md","sourceDirName":".","slug":"/xstate-machines","permalink":"/docs/features/xstate-machines","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/features/docs/xstate-machines.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Testing and Storybook","permalink":"/docs/features/testing-and-storybook"}}');var t=i(31085),r=i(71184);const c={},d="XState Machines Reference",l={},a=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"XState v5 Quick Reference",id:"xstate-v5-quick-reference",level:2},{value:"createConfigPipelineMachine",id:"createconfigpipelinemachine",level:2},{value:"Purpose",id:"purpose",level:3},{value:"When It Is Used",id:"when-it-is-used",level:3},{value:"State Diagram",id:"state-diagram",level:3},{value:"States",id:"states",level:3},{value:"Events",id:"events",level:3},{value:"Guards",id:"guards",level:3},{value:"Context Shape",id:"context-shape",level:3},{value:"Configuration (Required Callbacks)",id:"configuration-required-callbacks",level:3},{value:"Usage Example",id:"usage-example",level:3},{value:"Helper Utilities",id:"helper-utilities",level:3},{value:"createChangeSetMachine",id:"createchangesetmachine",level:2},{value:"Purpose",id:"purpose-1",level:3},{value:"When It Is Used",id:"when-it-is-used-1",level:3},{value:"State Diagram",id:"state-diagram-1",level:3},{value:"States",id:"states-1",level:3},{value:"Events",id:"events-1",level:3},{value:"Context Shape",id:"context-shape-1",level:3},{value:"Rollback Plan Construction",id:"rollback-plan-construction",level:3},{value:"Usage Example",id:"usage-example-1",level:3},{value:"createTemplateApplyMachine",id:"createtemplateapplymachine",level:2},{value:"Purpose",id:"purpose-2",level:3},{value:"When It Is Used",id:"when-it-is-used-2",level:3},{value:"State Diagram",id:"state-diagram-2",level:3},{value:"States",id:"states-2",level:3},{value:"High-Risk Thresholds",id:"high-risk-thresholds",level:3},{value:"Events",id:"events-2",level:3},{value:"Context Shape",id:"context-shape-2",level:3},{value:"10-Second Rollback Window",id:"10-second-rollback-window",level:3},{value:"Usage Example",id:"usage-example-2",level:3},{value:"Helper Utilities",id:"helper-utilities-1",level:3},{value:"createResourceLifecycleMachine",id:"createresourcelifecyclemachine",level:2},{value:"Purpose",id:"purpose-3",level:3},{value:"When It Is Used",id:"when-it-is-used-3",level:3},{value:"State Diagram",id:"state-diagram-3",level:3},{value:"States",id:"states-3",level:3},{value:"Events",id:"events-3",level:3},{value:"Context Shape",id:"context-shape-3",level:3},{value:"Runtime Updates",id:"runtime-updates",level:3},{value:"createWizardMachine",id:"createwizardmachine",level:2},{value:"Purpose",id:"purpose-4",level:3},{value:"When It Is Used",id:"when-it-is-used-4",level:3},{value:"State Diagram",id:"state-diagram-4",level:3},{value:"States",id:"states-4",level:3},{value:"Events",id:"events-4",level:3},{value:"Context Shape",id:"context-shape-4",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Usage Example",id:"usage-example-3",level:3},{value:"Session Recovery",id:"session-recovery",level:3},{value:"updateMachine",id:"updatemachine",level:2},{value:"Purpose",id:"purpose-5",level:3},{value:"When It Is Used",id:"when-it-is-used-5",level:3},{value:"State Diagram",id:"state-diagram-5",level:3},{value:"States",id:"states-5",level:3},{value:"Events",id:"events-5",level:3},{value:"Context Shape",id:"context-shape-5",level:3},{value:"Usage Example",id:"usage-example-4",level:3},{value:"pingMachine",id:"pingmachine",level:2},{value:"Purpose",id:"purpose-6",level:3},{value:"When It Is Used",id:"when-it-is-used-6",level:3},{value:"State Diagram",id:"state-diagram-6",level:3},{value:"States",id:"states-6",level:3},{value:"Events",id:"events-6",level:3},{value:"Context Shape",id:"context-shape-6",level:3},{value:"Statistics Calculation",id:"statistics-calculation",level:3},{value:"Usage Example",id:"usage-example-5",level:3},{value:"createTroubleshootMachine",id:"createtroubleshootmachine",level:2},{value:"Purpose",id:"purpose-7",level:3},{value:"When It Is Used",id:"when-it-is-used-7",level:3},{value:"State Diagram",id:"state-diagram-7",level:3},{value:"Diagnostic Steps (Fixed Sequence)",id:"diagnostic-steps-fixed-sequence",level:3},{value:"States",id:"states-7",level:3},{value:"Events",id:"events-7",level:3},{value:"Context Shape",id:"context-shape-7",level:3},{value:"Actor Configuration (Provided at Runtime)",id:"actor-configuration-provided-at-runtime",level:3},{value:"createVPNConnectionMachine",id:"createvpnconnectionmachine",level:2},{value:"Purpose",id:"purpose-8",level:3},{value:"When It Is Used",id:"when-it-is-used-8",level:3},{value:"State Diagram",id:"state-diagram-8",level:3},{value:"States",id:"states-8",level:3},{value:"Events",id:"events-8",level:3},{value:"Context Shape",id:"context-shape-8",level:3},{value:"Exponential Backoff",id:"exponential-backoff",level:3},{value:"React Hook",id:"react-hook",level:3},{value:"Pattern: Factory Functions vs. Singleton Machines",id:"pattern-factory-functions-vs-singleton-machines",level:2},{value:"Factory Functions (Most Machines)",id:"factory-functions-most-machines",level:3},{value:"Singleton Machines (Simple Workflows)",id:"singleton-machines-simple-workflows",level:3},{value:"Choosing the Right Pattern",id:"choosing-the-right-pattern",level:3},{value:"Cross-References",id:"cross-references",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"xstate-machines-reference",children:"XState Machines Reference"})}),"\n",(0,t.jsx)(n.p,{children:"This document catalogues every XState machine in NasNetConnect. Machines are used for workflows where simple boolean flags or Zustand state become insufficient \u2014 specifically where there are multiple sequential async steps, guards that prevent invalid transitions, and rollback/error recovery paths."}),"\n",(0,t.jsxs)(n.p,{children:["All machines use ",(0,t.jsx)(n.strong,{children:"XState v5"})," (",(0,t.jsx)(n.code,{children:"xstate@5.x"}),") with the ",(0,t.jsx)(n.code,{children:"setup()"})," API. The ",(0,t.jsx)(n.code,{children:"@xstate/react"})," package provides ",(0,t.jsx)(n.code,{children:"useMachine()"})," and ",(0,t.jsx)(n.code,{children:"useActor()"})," for React integration."]}),"\n",(0,t.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#xstate-v5-quick-reference",children:"XState v5 Quick Reference"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createconfigpipelinemachine",children:"createConfigPipelineMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createchangesetmachine",children:"createChangeSetMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createtemplateapplymachine",children:"createTemplateApplyMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createresourcelifecyclemachine",children:"createResourceLifecycleMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createwizardmachine",children:"createWizardMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#updatemachine",children:"updateMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#pingmachine",children:"pingMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createtroubleshootmachine",children:"createTroubleshootMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#createvpnconnectionmachine",children:"createVPNConnectionMachine"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#pattern-factory-functions-vs-singleton-machines",children:"Pattern: Factory Functions vs. Singleton Machines"})}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"xstate-v5-quick-reference",children:"XState v5 Quick Reference"}),"\n",(0,t.jsxs)(n.p,{children:["NasNetConnect uses XState v5's ",(0,t.jsx)(n.code,{children:"setup()"})," API throughout. The key differences from v4:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { setup, assign, fromPromise, useMachine } from 'xstate';\nimport { useMachine } from '@xstate/react';\n\n// V5 pattern: setup() + createMachine()\nconst machine = setup({\n  types: {} as {\n    context: MyContext;\n    events: MyEvent;\n  },\n  actors: {\n    // Async actors replace v4 services\n    myActor: fromPromise<Output, Input>(async ({ input }) => {\n      return doSomething(input);\n    }),\n  },\n  guards: {\n    myGuard: ({ context, event }) => context.value > 0,\n  },\n  actions: {\n    myAction: assign({ field: ({ event }) => event.value }),\n  },\n}).createMachine({\n  id: 'myMachine',\n  initial: 'idle',\n  context: { /* initial context */ },\n  states: { /* states */ },\n});\n\n// React usage\nconst [state, send] = useMachine(machine);\nsend({ type: 'MY_EVENT', value: 42 });\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Factory functions"})," (machines that return different instances per configuration) use ",(0,t.jsx)(n.code,{children:"setup().createMachine()"})," inside a function rather than at the module level."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createconfigpipelinemachine",children:"createConfigPipelineMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/state/machines/src/configPipelineMachine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createConfigPipelineMachine<TConfig>(config)"}),", ",(0,t.jsx)(n.code,{children:"createSimpleConfigPipelineMachine<TConfig>(config)"})]}),"\n",(0,t.jsx)(n.h3,{id:"purpose",children:"Purpose"}),"\n",(0,t.jsxs)(n.p,{children:["The core safety pipeline for all configuration changes in NasNetConnect. Prevents accidental network lockouts by enforcing: validation before apply, explicit acknowledgment for high-risk operations, and automatic rollback if verification fails. This is a ",(0,t.jsx)(n.strong,{children:"generic machine"})," parameterized by the configuration type ",(0,t.jsx)(n.code,{children:"TConfig"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"WireGuard peer configuration"}),"\n",(0,t.jsx)(n.li,{children:"WAN interface changes (PPPoE, DHCP, static)"}),"\n",(0,t.jsx)(n.li,{children:"VPN server setup"}),"\n",(0,t.jsx)(n.li,{children:"Any configuration that, if applied incorrectly, could disconnect the user from the router"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"                    EDIT\n   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502                                             \u2502\n   \u25bc                                             \u2502\n idle \u2500\u2500EDIT\u2500\u2500\u25ba draft \u2500\u2500VALIDATE\u2500\u2500\u25ba validating\n                  \u2502                     \u2502\n                CANCEL              \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2510\n                  \u2502           errors\u2502       \u2502no errors\n                  \u25bc                 \u25bc       \u25bc\n                idle            invalid  previewing\n                               \u2502            \u2502\n                             EDIT        CONFIRM\n                               \u2502            \u2502\n                               \u25bc        \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                             draft  highRisk\u2502            normal\u2502\n                                          \u25bc                  \u25bc\n                                      confirming \u2500\u2500\u2500\u2500\u2500\u2500\u25ba applying\n                                          \u2502                  \u2502\n                                     ACKNOWLEDGED          done\u2502\n                                          \u2502             error \u2502\n                                          \u25bc                  \u25bc\n                                       applying          verifying\n                                          \u2502                  \u2502\n                                         done            \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2510\n                                          \u2502         pass \u2502       \u2502 fail\n                                          \u25bc              \u25bc       \u25bc\n                                      verifying       active  rollback\n                                                      (final)    \u2502\n                                                              done\u2502\n                                                                  \u25bc\n                                                             rolled_back\n                                                              (final)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"states",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.td,{children:"Waiting for first edit"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"draft"})}),(0,t.jsx)(n.td,{children:"User is modifying configuration"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"validating"})}),(0,t.jsx)(n.td,{children:"Running 7-stage async validation pipeline"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"invalid"})}),(0,t.jsx)(n.td,{children:"Validation failed; errors shown to user"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"previewing"})}),(0,t.jsx)(n.td,{children:"Showing diff of proposed changes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"confirming"})}),(0,t.jsx)(n.td,{children:"High-risk acknowledgment dialog (countdown)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"applying"})}),(0,t.jsx)(n.td,{children:"Sending configuration to router via API"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"verifying"})}),(0,t.jsx)(n.td,{children:"Polling/checking that router accepted the change"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"active"})}),(0,t.jsx)(n.td,{children:"Final success state"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rollback"})}),(0,t.jsx)(n.td,{children:"Executing rollback after verification failure"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rolled_back"})}),(0,t.jsx)(n.td,{children:"Final state: safe rollback complete"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"error"})}),(0,t.jsx)(n.td,{children:"Unrecoverable error; offers RETRY, FORCE_ROLLBACK, RESET"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"EDIT"})}),(0,t.jsx)(n.td,{children:"idle, draft, invalid, previewing"}),(0,t.jsx)(n.td,{children:"Update pending configuration"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"VALIDATE"})}),(0,t.jsx)(n.td,{children:"draft"}),(0,t.jsx)(n.td,{children:"Start the validation pipeline"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONFIRM"})}),(0,t.jsx)(n.td,{children:"previewing"}),(0,t.jsx)(n.td,{children:"Proceed to apply (or confirming if high-risk)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ACKNOWLEDGED"})}),(0,t.jsx)(n.td,{children:"confirming"}),(0,t.jsx)(n.td,{children:"User acknowledges high-risk warning"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CANCEL"})}),(0,t.jsx)(n.td,{children:"draft, invalid, previewing, confirming"}),(0,t.jsx)(n.td,{children:"Abandon pipeline"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RETRY"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Retry from validating"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"FORCE_ROLLBACK"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Manually trigger rollback (requires rollbackData)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESET"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Return to idle"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"guards",children:"Guards"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Guard"}),(0,t.jsx)(n.th,{children:"Condition"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hasValidationErrors"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"output.errors.length > 0"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"noValidationErrors"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"output.errors.length === 0"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"isHighRisk"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"context.diff?.isHighRisk === true"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"isNotHighRisk"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"context.diff?.isHighRisk !== true"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hasRollbackData"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"context.rollbackData !== null"})})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ConfigPipelineContext<TConfig> {\n  resourceId: string | null;\n  originalConfig: TConfig | null;\n  pendingConfig: TConfig | null;\n  validationErrors: ValidationError[];\n  diff: ConfigDiff | null;          // isHighRisk flag lives here\n  rollbackData: TConfig | null;     // Populated after successful apply\n  applyStartedAt: number | null;    // Timestamp for UI countdown display\n  errorMessage: string | null;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-required-callbacks",children:"Configuration (Required Callbacks)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ConfigPipelineConfig<TConfig> {\n  id?: string;\n  runValidationPipeline: (config: TConfig) => Promise<{ errors: ValidationError[]; diff: ConfigDiff }>;\n  applyConfig: (params: { resourceId: string; config: TConfig }) => Promise<{ rollbackData: TConfig }>;\n  verifyApplied: (resourceId: string) => Promise<void>;\n  executeRollback: (rollbackData: TConfig) => Promise<void>;\n  onSuccess?: () => void;\n  onRollback?: () => void;\n  onError?: (error: string) => void;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"usage-example",children:"Usage Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createConfigPipelineMachine } from '@nasnet/state/machines';\nimport { useMachine } from '@xstate/react';\n\ninterface WireGuardConfig {\n  privateKey: string;\n  listenPort: number;\n  peers: Peer[];\n}\n\nconst wireguardPipelineMachine = createConfigPipelineMachine<WireGuardConfig>({\n  runValidationPipeline: async (config) => {\n    const result = await validateWireGuardConfig(config);\n    return { errors: result.errors, diff: result.diff };\n  },\n  applyConfig: async ({ resourceId, config }) => {\n    const backup = await getWireGuardBackup(resourceId);\n    await applyWireGuardConfig(resourceId, config);\n    return { rollbackData: backup };\n  },\n  verifyApplied: async (resourceId) => {\n    const status = await checkWireGuardStatus(resourceId);\n    if (!status.running) throw new Error('WireGuard failed to start');\n  },\n  executeRollback: async (rollbackData) => {\n    await restoreWireGuardConfig(rollbackData);\n  },\n  onSuccess: () => toast.success('WireGuard configuration applied'),\n  onRollback: () => toast.warning('Configuration rolled back to previous state'),\n});\n\n// In a component\nconst [state, send] = useMachine(wireguardPipelineMachine);\n\n// User edits form field\nsend({ type: 'EDIT', config: updatedConfig });\n\n// User clicks \"Apply\"\nsend({ type: 'VALIDATE' });\n\n// Check state\nif (state.matches('previewing')) {\n  showDiffPreview(state.context.diff);\n}\nif (state.matches('invalid')) {\n  showErrors(state.context.validationErrors);\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"helper-utilities",children:"Helper Utilities"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"isPipelineFinal(state)       // \u2192 boolean (active | rolled_back)\nisPipelineCancellable(state) // \u2192 boolean (draft | invalid | previewing | confirming)\nisPipelineProcessing(state)  // \u2192 boolean (validating | applying | verifying | rollback)\ngetPipelineStateDescription(state) // \u2192 string for UI labels\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createchangesetmachine",children:"createChangeSetMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/state/machines/src/changeSetMachine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createChangeSetMachine(config)"})]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-1",children:"Purpose"}),"\n",(0,t.jsxs)(n.p,{children:["Orchestrates atomic multi-resource operations. While ",(0,t.jsx)(n.code,{children:"createConfigPipelineMachine"})," handles a single resource, this machine applies an entire ",(0,t.jsx)(n.strong,{children:"change set"})," of items in topologically-sorted dependency order. If any item fails, it automatically rolls back all previously applied items in reverse order."]}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-1",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"LAN network creation wizard (bridge \u2192 IP address \u2192 DHCP server)"}),"\n",(0,t.jsx)(n.li,{children:"Bulk interface configuration"}),"\n",(0,t.jsx)(n.li,{children:"Any operation touching multiple interdependent resources atomically"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-1",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  idle \u2500\u2500LOAD\u2500\u2500\u25ba idle (loads change set)\n   \u2502\n   \u2514\u2500\u2500START_VALIDATION\u2500\u2500\u25ba validating \u2500\u2500fail\u2500\u2500\u25ba idle (with error)\n                               \u2502\n                            success\n                               \u2502\n                               \u25bc\n                            ready \u2500\u2500APPLY\u2500\u2500\u25ba applying\n                              \u2502               \u2502\n                            CANCEL          applyingItem (compound)\n                              \u2502               \u2502    \u2502\n                              \u25bc           done\u2502  error\u2502\n                          cancelled           \u25bc       \u25bc\n                                       checkingMore  rollingBack\n                                         \u2502       \u2502       \u2502\n                                    more \u2502  done \u2502   done\u2502\n                                    items\u2502       \u2502       \u25bc\n                                         \u2502       \u25bc   rolledBack (final)\n                                         \u2502   completed (final)\n                                         \u25bc\n                                    applyingItem (loop)\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"applying"})," state is a compound state with two sub-states: ",(0,t.jsx)(n.code,{children:"applyingItem"})," (executing the current item's API call) and ",(0,t.jsx)(n.code,{children:"checkingMore"})," (an ",(0,t.jsx)(n.code,{children:"always"})," transition that decides whether to loop to the next item or transition to ",(0,t.jsx)(n.code,{children:"completed"}),")."]}),"\n",(0,t.jsx)(n.h3,{id:"states-1",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.td,{children:"Ready to receive a change set via LOAD event"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"validating"})}),(0,t.jsx)(n.td,{children:"Running async validation on all items"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ready"})}),(0,t.jsx)(n.td,{children:"Validation passed; awaiting user confirmation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"applying"})}),(0,t.jsx)(n.td,{children:"Compound: applyingItem \u2192 checkingMore \u2192 loop or done"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"completed"})}),(0,t.jsx)(n.td,{children:"Final: all items applied successfully"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rollingBack"})}),(0,t.jsx)(n.td,{children:"Executing rollback steps in reverse order"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rolledBack"})}),(0,t.jsx)(n.td,{children:"Final: rollback successful"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"failed"})}),(0,t.jsx)(n.td,{children:"Apply or validation failed; offers retry/rollback/reset"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"partialFailure"})}),(0,t.jsx)(n.td,{children:"Final: rollback itself partially failed (manual intervention required)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"cancelled"})}),(0,t.jsx)(n.td,{children:"Final: user cancelled"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-1",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"LOAD"})}),(0,t.jsx)(n.td,{children:"idle"}),(0,t.jsx)(n.td,{children:"Load a change set into machine context"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"START_VALIDATION"})}),(0,t.jsx)(n.td,{children:"idle"}),(0,t.jsx)(n.td,{children:"Begin validation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"APPLY"})}),(0,t.jsx)(n.td,{children:"ready"}),(0,t.jsx)(n.td,{children:"Start applying items"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CANCEL"})}),(0,t.jsx)(n.td,{children:"validating, ready, applying"}),(0,t.jsx)(n.td,{children:"Cancel operation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RETRY"})}),(0,t.jsx)(n.td,{children:"failed"}),(0,t.jsx)(n.td,{children:"Re-run validation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"FORCE_ROLLBACK"})}),(0,t.jsx)(n.td,{children:"failed, cancelled"}),(0,t.jsx)(n.td,{children:"Manually trigger rollback"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESET"})}),(0,t.jsx)(n.td,{children:"ready, failed, cancelled"}),(0,t.jsx)(n.td,{children:"Return machine to idle"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-1",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ChangeSetMachineContext {\n  changeSet: ChangeSet | null;\n  routerId: string | null;\n  validationResult: ChangeSetValidationResult | null;\n  currentItemIndex: number;          // Position in sortedItems array\n  sortedItems: ChangeSetItem[];      // Topologically sorted apply order\n  appliedItems: ChangeSetItem[];     // Items successfully applied so far\n  rollbackPlan: RollbackStep[];      // Built up as items are applied (reverse order)\n  error: ChangeSetError | null;\n  errorMessage: string | null;\n  cancelRequested: boolean;          // Set by CANCEL during applying\n  applyStartedAt: number | null;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"rollback-plan-construction",children:"Rollback Plan Construction"}),"\n",(0,t.jsxs)(n.p,{children:["As each item is applied, a ",(0,t.jsx)(n.code,{children:"RollbackStep"})," is prepended to ",(0,t.jsx)(n.code,{children:"context.rollbackPlan"}),". This means the rollback plan is always in reverse apply order (last applied = first to roll back):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// CREATE \u2192 DELETE\n// UPDATE \u2192 REVERT (uses previousState)\n// DELETE \u2192 RESTORE (uses previousState)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"usage-example-1",children:"Usage Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createChangeSetMachine } from '@nasnet/state/machines';\nimport { useActor } from '@xstate/react';\n\nconst machine = createChangeSetMachine({\n  validateChangeSet: async (changeSet) => {\n    const response = await client.query({ query: VALIDATE_CHANGE_SET, variables: { id: changeSet.id } });\n    return response.data.validation;\n  },\n  applyItem: async ({ item, routerId }) => {\n    const response = await client.mutate({\n      mutation: APPLY_RESOURCE,\n      variables: { routerId, itemId: item.id, operation: item.operation, config: item.configuration },\n    });\n    return { confirmedState: response.data.confirmedState, resourceUuid: response.data.resourceUuid };\n  },\n  rollbackItem: async ({ rollbackStep, routerId }) => {\n    await client.mutate({ mutation: ROLLBACK_RESOURCE, variables: { routerId, ...rollbackStep } });\n  },\n  onProgress: (event) => {\n    console.log(`Applying ${event.currentItem?.name} (${event.appliedCount}/${event.totalCount})`);\n  },\n  onComplete: (changeSet) => {\n    toast.success(`Applied ${changeSet.items.length} changes successfully`);\n  },\n});\n\nconst [state, send] = useActor(machine);\n\n// Load and validate\nsend({ type: 'LOAD', changeSet, routerId });\nsend({ type: 'START_VALIDATION' });\n\n// After validation passes (state.matches('ready'))\nsend({ type: 'APPLY' });\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createtemplateapplymachine",children:"createTemplateApplyMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/features/firewall/src/machines/template-apply.machine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createTemplateApplyMachine(config)"})]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-2",children:"Purpose"}),"\n",(0,t.jsx)(n.p,{children:"Safety pipeline for applying firewall rule templates. Adds template-specific concerns on top of the basic config pipeline: variable resolution, conflict detection, impact analysis, high-risk thresholds, and a 10-second undo (rollback) window after successful apply."}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-2",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Firewall template browser (",(0,t.jsx)(n.code,{children:"libs/features/firewall/src/components/TemplateApplyFlow.tsx"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Alert template application"}),"\n",(0,t.jsx)(n.li,{children:"Any templated rule set with variable substitution"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-2",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  idle \u2500\u2500SELECT_TEMPLATE\u2500\u2500\u25ba configuring \u2500\u2500PREVIEW\u2500\u2500\u25ba previewing (async)\n                               \u2502                          \u2502\n                             CANCEL                      done\n                               \u2502                          \u2502\n                               \u25bc                          \u25bc\n                              idle                     reviewing\n                                                          \u2502\n                                                       CONFIRM\n                                                    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                               high \u2502                 \u2502 normal\n                                               risk \u2502                 \u2502\n                                                    \u25bc                 \u25bc\n                                               confirming \u2500\u2500\u2500\u2500\u2500\u2500\u25ba applying (async)\n                                                                       \u2502\n                                                              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                                        success\u2502                fail\u2502\n                                                               \u25bc                   \u25bc\n                                                            success              error\n                                                           (10s timer)             \u2502\n                                                               \u2502              ROLLBACK\u2502RETRY\n                                                            ROLLBACK              \u2502\n                                                               \u2502                  \u25bc\n                                                               \u25bc               rollingBack (async)\n                                                           rollingBack             \u2502\n                                                               \u2502                done\u2502\n                                                              done                  \u25bc\n                                                               \u2502                rolledBack\n                                                               \u25bc\n                                                           rolledBack\n"})}),"\n",(0,t.jsx)(n.h3,{id:"states-2",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.td,{children:"Waiting for template selection"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"configuring"})}),(0,t.jsx)(n.td,{children:"User filling in template variable values"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"previewing"})}),(0,t.jsx)(n.td,{children:"Async: calling previewTemplate API"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"reviewing"})}),(0,t.jsx)(n.td,{children:"User inspecting resolved rules and conflict report"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"confirming"})}),(0,t.jsx)(n.td,{children:"High-risk acknowledgment for large or conflicting templates"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"applying"})}),(0,t.jsx)(n.td,{children:"Async: calling applyTemplate API"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"success"})}),(0,t.jsx)(n.td,{children:"Apply succeeded; 10-second rollback window active"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rollingBack"})}),(0,t.jsx)(n.td,{children:"Async: calling executeRollback API"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rolledBack"})}),(0,t.jsx)(n.td,{children:"Rollback complete"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"error"})}),(0,t.jsx)(n.td,{children:"Apply or rollback failed"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"high-risk-thresholds",children:"High-Risk Thresholds"}),"\n",(0,t.jsx)(n.p,{children:"A template application is classified as high-risk (requiring explicit acknowledgment) when any of these conditions are true:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Adding more than 10 new rules (",(0,t.jsx)(n.code,{children:"impactAnalysis.newRulesCount > 10"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Affecting more than 3 firewall chains (",(0,t.jsx)(n.code,{children:"impactAnalysis.affectedChains.length > 3"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Any conflicts detected (",(0,t.jsx)(n.code,{children:"conflicts.length > 0"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Any warnings from impact analysis (",(0,t.jsx)(n.code,{children:"impactAnalysis.warnings.length > 0"}),")"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"events-2",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SELECT_TEMPLATE"})}),(0,t.jsx)(n.td,{children:"idle"}),(0,t.jsx)(n.td,{children:"Select template and router"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"UPDATE_VARIABLES"})}),(0,t.jsx)(n.td,{children:"configuring, reviewing"}),(0,t.jsx)(n.td,{children:"Update variable values"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PREVIEW"})}),(0,t.jsx)(n.td,{children:"configuring"}),(0,t.jsx)(n.td,{children:"Generate preview with conflict detection"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONFIRM"})}),(0,t.jsx)(n.td,{children:"reviewing"}),(0,t.jsx)(n.td,{children:"Proceed to apply (or confirming if high-risk)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ACKNOWLEDGED"})}),(0,t.jsx)(n.td,{children:"confirming"}),(0,t.jsx)(n.td,{children:"Explicitly acknowledge high-risk operation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ROLLBACK"})}),(0,t.jsx)(n.td,{children:"success, error"}),(0,t.jsx)(n.td,{children:"Initiate rollback"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RETRY"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Retry from previewing"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CANCEL"})}),(0,t.jsx)(n.td,{children:"configuring, reviewing, confirming"}),(0,t.jsx)(n.td,{children:"Abandon flow"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESET"})}),(0,t.jsx)(n.td,{children:"success, rolledBack, error"}),(0,t.jsx)(n.td,{children:"Return to idle"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-2",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface TemplateApplyContext {\n  routerId: string | null;\n  template: FirewallTemplate | null;\n  variables: Record<string, string>;\n  validationErrors: Array<{ field: string; message: string }>;\n  previewResult: TemplatePreviewResult | null;\n  applyResult: FirewallTemplateResult | null;\n  applyStartedAt: number | null;    // For 10-second rollback countdown UI\n  errorMessage: string | null;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"10-second-rollback-window",children:"10-Second Rollback Window"}),"\n",(0,t.jsxs)(n.p,{children:["After ",(0,t.jsx)(n.code,{children:"success"})," is entered, ",(0,t.jsx)(n.code,{children:"applyStartedAt"})," is set to ",(0,t.jsx)(n.code,{children:"Date.now()"}),". The UI reads this to display a countdown. The user can send ",(0,t.jsx)(n.code,{children:"ROLLBACK"})," at any time while in ",(0,t.jsx)(n.code,{children:"success"})," state (there is no machine-enforced timeout \u2014 the 10 seconds is a UI convention). If the user navigates away or dismisses without rolling back, they must use ",(0,t.jsx)(n.code,{children:"RESET"})," to clear the machine."]}),"\n",(0,t.jsx)(n.h3,{id:"usage-example-2",children:"Usage Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createTemplateApplyMachine } from '@nasnet/features/firewall';\nimport { createActor } from 'xstate';\n\nconst machine = createTemplateApplyMachine({\n  previewTemplate: async ({ routerId, template, variables }) => {\n    return previewTemplateAPI(routerId, template.id, variables);\n  },\n  applyTemplate: async ({ routerId, template, variables }) => {\n    return applyTemplateAPI(routerId, template.id, variables);\n  },\n  executeRollback: async ({ routerId, rollbackId }) => {\n    await rollbackTemplateAPI(routerId, rollbackId);\n  },\n  onSuccess: () => toast.success('Template applied successfully'),\n  onRollback: () => toast.info('Template changes rolled back'),\n});\n\nconst actor = createActor(machine).start();\n\nactor.send({ type: 'SELECT_TEMPLATE', template, routerId });\n// User fills in variables\nactor.send({ type: 'UPDATE_VARIABLES', variables: { TRUSTED_NET: '192.168.1.0/24' } });\nactor.send({ type: 'PREVIEW' });\n// After preview arrives...\nactor.send({ type: 'CONFIRM' });\n"})}),"\n",(0,t.jsx)(n.h3,{id:"helper-utilities-1",children:"Helper Utilities"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"isTemplateFinal(state)       // success | rolledBack\nisTemplateCancellable(state) // configuring | reviewing | confirming\nisTemplateProcessing(state)  // previewing | applying | rollingBack\ngetTemplateStateDescription(state) // Human-readable label\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createresourcelifecyclemachine",children:"createResourceLifecycleMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/state/machines/src/resourceLifecycleMachine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createResourceLifecycleMachine<TConfig>(config)"})]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-3",children:"Purpose"}),"\n",(0,t.jsx)(n.p,{children:"Models the complete 9-state lifecycle of a Universal State v2 resource from initial creation through eventual archiving. Handles the validation-apply-verify loop, runtime degradation detection, and sync from router."}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-3",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Individual WireGuard peers, OpenVPN tunnels, etc."}),"\n",(0,t.jsx)(n.li,{children:"Network bridge interfaces"}),"\n",(0,t.jsx)(n.li,{children:"VPN server instances"}),"\n",(0,t.jsx)(n.li,{children:"Any resource in the 8-layer Universal State model"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-3",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  draft \u2500\u2500VALIDATE\u2500\u2500\u25ba validating\n    \u25b2                     \u2502\n    \u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   EDIT            \u2502 fail        \u2502 pass\n    \u2502              \u25bc             \u25bc\n    \u2502           error          valid \u2500\u2500APPLY\u2500\u2500\u25ba applying\n    \u2502                                              \u2502\n    \u2502                                     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502                               success\u2502             fail\u2502\n    \u2502                                      \u25bc                 \u25bc\n    \u2502                                   active            error\n    \u2502                                     \u2502\n    \u2502                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502               DEGRADE\u2502         SYNC \u2502           DEPRECATE\u2502\n    \u2502                      \u25bc              \u25bc                   \u25bc\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 degraded \u2500\u25ba    syncing \u2500\u2500\u25ba active    deprecated\n                       \u2502                                      \u2502\n                     RECOVER                       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n                       \u2502                      RESTORE\u2502    ARCHIVE\u2502\n                       \u25bc                           \u25bc           \u25bc\n                     active                     active      archived (final)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"states-3",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"draft"})}),(0,t.jsx)(n.td,{children:"Resource created or edited, not yet validated"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"validating"})}),(0,t.jsx)(n.td,{children:"Async: running 7-stage validation pipeline"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"valid"})}),(0,t.jsx)(n.td,{children:"Validation passed; ready to apply"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"applying"})}),(0,t.jsx)(n.td,{children:"Async: pushing configuration to router"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"active"})}),(0,t.jsx)(n.td,{children:"Running on router; receiving real-time runtime updates"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"degraded"})}),(0,t.jsx)(n.td,{children:"Running but health is DEGRADED or CRITICAL"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"error"})}),(0,t.jsx)(n.td,{children:"Validation or apply failure"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deprecated"})}),(0,t.jsx)(n.td,{children:"Marked for eventual removal"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"archived"})}),(0,t.jsx)(n.td,{children:"Final state; resource permanently decommissioned"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"syncing"})}),(0,t.jsx)(n.td,{children:"Async: pulling current configuration from router"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-3",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"EDIT"})}),(0,t.jsx)(n.td,{children:"draft, valid, active, degraded, error"}),(0,t.jsx)(n.td,{children:"Update pending configuration"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"VALIDATE"})}),(0,t.jsx)(n.td,{children:"draft"}),(0,t.jsxs)(n.td,{children:["Start validation (requires ",(0,t.jsx)(n.code,{children:"uuid"}),")"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"APPLY"})}),(0,t.jsx)(n.td,{children:"valid"}),(0,t.jsx)(n.td,{children:"Push configuration to router"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RUNTIME_UPDATE"})}),(0,t.jsx)(n.td,{children:"active, degraded"}),(0,t.jsx)(n.td,{children:"Real-time health/metrics update"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DEGRADE"})}),(0,t.jsx)(n.td,{children:"active"}),(0,t.jsx)(n.td,{children:"Manual degradation signal"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RECOVER"})}),(0,t.jsx)(n.td,{children:"degraded"}),(0,t.jsx)(n.td,{children:"Recovery signal (health restored)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DEPRECATE"})}),(0,t.jsx)(n.td,{children:"active, degraded"}),(0,t.jsx)(n.td,{children:"Mark for removal"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESTORE"})}),(0,t.jsx)(n.td,{children:"deprecated"}),(0,t.jsx)(n.td,{children:"Reactivate deprecated resource"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ARCHIVE"})}),(0,t.jsx)(n.td,{children:"deprecated"}),(0,t.jsx)(n.td,{children:"Permanently archive"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RETRY"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Retry validation (max 3 attempts)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESET"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Clear errors and return to draft"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SYNC"})}),(0,t.jsx)(n.td,{children:"active"}),(0,t.jsx)(n.td,{children:"Pull current state from router"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-3",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ResourceLifecycleContext<TConfig> {\n  uuid: string | null;\n  routerId: string | null;\n  resourceType: string | null;\n  configuration: TConfig | null;\n  pendingConfiguration: TConfig | null;\n  validationResult: ValidationResult | null;\n  runtime: RuntimeState | null;        // CPU, memory, health from router\n  errorMessage: string | null;\n  errorCode: string | null;\n  rollbackData: TConfig | null;\n  lastTransitionAt: number | null;\n  retryCount: number;\n  maxRetries: number;                  // Default: 3\n  degradationReason: string | null;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"runtime-updates",children:"Runtime Updates"}),"\n",(0,t.jsxs)(n.p,{children:["When the router reports a health change via a subscription event, ",(0,t.jsx)(n.code,{children:"RUNTIME_UPDATE"})," is sent. In the ",(0,t.jsx)(n.code,{children:"active"})," state, this uses guards to decide whether to transition to ",(0,t.jsx)(n.code,{children:"degraded"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"RUNTIME_UPDATE: [\n  {\n    target: 'degraded',\n    guard: ({ event }) => event.runtime.health === 'DEGRADED' || event.runtime.health === 'CRITICAL',\n    actions: ['updateRuntime', 'setDegradation'],\n  },\n  {\n    actions: 'updateRuntime',  // Stay in active, just update metrics\n  },\n],\n"})}),"\n",(0,t.jsxs)(n.p,{children:["In the ",(0,t.jsx)(n.code,{children:"degraded"})," state, ",(0,t.jsx)(n.code,{children:"RUNTIME_UPDATE"})," with ",(0,t.jsx)(n.code,{children:"health === 'HEALTHY'"})," automatically transitions back to ",(0,t.jsx)(n.code,{children:"active"}),"."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createwizardmachine",children:"createWizardMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/state/machines/src/wizardMachine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createWizardMachine<TData>(config)"})," (exports V2 which is the recommended version)"]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-4",children:"Purpose"}),"\n",(0,t.jsxs)(n.p,{children:["Reusable multi-step wizard with per-step async validation, session persistence (for crash recovery), and data accumulation across steps. Generic over the wizard's data type ",(0,t.jsx)(n.code,{children:"TData"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-4",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Service installation wizard (4 steps: feature selection \u2192 network \u2192 configuration \u2192 review)"}),"\n",(0,t.jsx)(n.li,{children:"VPN client setup wizard"}),"\n",(0,t.jsxs)(n.li,{children:["Router onboarding wizard in ",(0,t.jsx)(n.code,{children:"apps/star-setup-web/"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-4",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502 step (active step \u2014 user is editing)                              \u2502\n  \u2502                                                                   \u2502\n  \u2502  NEXT \u2500\u2500\u25ba validating \u2500\u2500\u25ba (pass, not last) \u2500\u2500\u25ba step (next step)   \u2502\n  \u2502                     \u2514\u2500\u2500\u25ba (pass, last step) \u2500\u2500\u25ba submitting         \u2502\n  \u2502                     \u2514\u2500\u2500\u25ba (fail) \u2500\u2500\u25ba step (same step, with errors) \u2502\n  \u2502                                                                   \u2502\n  \u2502  BACK (if canGoBack) \u2500\u2500\u25ba step (prev step)                        \u2502\n  \u2502  CANCEL \u2500\u2500\u25ba cancelled (final)                                    \u2502\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n  submitting (async: calling onSubmit)\n      \u2502\n  \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2510\n  \u2502success\u2502 fail\n  \u25bc       \u25bc\ncompleted  step (with _form error)\n(final)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"states-4",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"step"})}),(0,t.jsx)(n.td,{children:"User is editing the current step's fields"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"validating"})}),(0,t.jsx)(n.td,{children:"Async: calling validateStep for the current step"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"submitting"})}),(0,t.jsx)(n.td,{children:"Async: calling onSubmit with all accumulated data"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"completed"})}),(0,t.jsx)(n.td,{children:"Final: wizard finished successfully"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"cancelled"})}),(0,t.jsx)(n.td,{children:"Final: user cancelled"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-4",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"NEXT"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Validate and advance (or submit on last step)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"BACK"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Go back (guard: canGoBack)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SET_DATA"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Update field values without advancing"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CLEAR_ERRORS"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Clear validation error messages"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CANCEL"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Abandon wizard"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESTORE"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Restore previously saved session context"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"GOTO"})}),(0,t.jsx)(n.td,{children:"step"}),(0,t.jsx)(n.td,{children:"Jump to specific step (V1 only)"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-4",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface WizardContext<TData> {\n  currentStep: number;        // 1-indexed\n  totalSteps: number;\n  data: Partial<TData>;       // Accumulated across all steps\n  errors: Record<string, string>;  // Field-level validation errors\n  sessionId: string;          // UUID for session persistence/recovery\n  canSkip: boolean;           // Whether forward navigation is allowed without validation\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface WizardConfig<TData> {\n  id: string;\n  totalSteps: number;\n  validateStep: (step: number, data: Partial<TData>) => Promise<{ valid: boolean; errors?: Record<string, string> }>;\n  onSubmit: (data: TData) => Promise<void>;\n  initialData?: Partial<TData>;\n  persist?: boolean;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"usage-example-3",children:"Usage Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createWizardMachine } from '@nasnet/state/machines';\nimport { useMachine } from '@xstate/react';\n\ninterface ServiceInstallData {\n  featureId: string;\n  instanceName: string;\n  vlanId: number;\n  bindIp: string;\n  config: Record<string, unknown>;\n}\n\nconst installWizard = createWizardMachine<ServiceInstallData>({\n  id: 'service-install-wizard',\n  totalSteps: 4,\n  validateStep: async (step, data) => {\n    const schema = STEP_SCHEMAS[step - 1];\n    const result = schema.safeParse(data);\n    if (!result.success) {\n      const errors: Record<string, string> = {};\n      result.error.issues.forEach(issue => {\n        errors[issue.path.join('.')] = issue.message;\n      });\n      return { valid: false, errors };\n    }\n    return { valid: true };\n  },\n  onSubmit: async (data) => {\n    await installService(data);\n  },\n});\n\nconst [state, send] = useMachine(installWizard);\n\n// Display current step\nconsole.log(`Step ${state.context.currentStep} of ${state.context.totalSteps}`);\n\n// User fills step 1 and clicks Next\nsend({ type: 'NEXT', data: { featureId: 'tor', instanceName: 'my-tor' } });\n\n// Handle validation errors\nif (state.context.errors.instanceName) {\n  showError(state.context.errors.instanceName);\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"session-recovery",children:"Session Recovery"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"RESTORE"})," event allows rehydrating wizard state from a persisted draft (e.g., from ",(0,t.jsx)(n.code,{children:"useServiceUIStore.wizardDraft"}),"):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const draft = useServiceWizardDraft();\nuseEffect(() => {\n  if (draft) {\n    send({ type: 'RESTORE', savedContext: { currentStep: draft.step, data: draft.data, sessionId: draft.sessionId } });\n  }\n}, []);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"updatemachine",children:"updateMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/features/services/src/machines/update-machine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"updateMachine"})," (singleton, not a factory)"]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-5",children:"Purpose"}),"\n",(0,t.jsxs)(n.p,{children:["Manages the lifecycle of a service instance update. Unlike other machines, this is a singleton (not a factory) because the update states are simple and don't vary by configuration. Progress events arrive via GraphQL subscription and are fed into the machine with ",(0,t.jsx)(n.code,{children:"send()"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-5",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Service update dialog in the Feature Marketplace"}),"\n",(0,t.jsx)(n.li,{children:"Update-all batch operation"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-5",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  idle \u2500\u2500START_UPDATE\u2500\u2500\u25ba updating\n                             \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         COMPLETE\u2502       ROLLED_BACK\u2502           FAILED\u2502\n              \u25bc                 \u25bc                    \u25bc\n           complete          rolledBack            failed\n              \u2502                 \u2502                    \u2502\n            RESET             RESET               RESET\n              \u2502                 \u2502                    \u2502\n              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                \u25bc\n                              idle\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"updating"})," state also accepts ",(0,t.jsx)(n.code,{children:"PROGRESS"})," events (without transition \u2014 just context update) and ",(0,t.jsx)(n.code,{children:"CANCEL"})," (back to idle with reset)."]}),"\n",(0,t.jsx)(n.h3,{id:"states-5",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.td,{children:"Ready for a new update"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"updating"})}),(0,t.jsx)(n.td,{children:"Update in progress; receives PROGRESS subscription events"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"complete"})}),(0,t.jsx)(n.td,{children:"Update succeeded"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"rolledBack"})}),(0,t.jsx)(n.td,{children:"Update was automatically rolled back by health check"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"failed"})}),(0,t.jsx)(n.td,{children:"Update failed with error"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-5",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"START_UPDATE"})}),(0,t.jsx)(n.td,{children:"idle"}),(0,t.jsx)(n.td,{children:"Begin update with instance and version info"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PROGRESS"})}),(0,t.jsx)(n.td,{children:"updating"}),(0,t.jsx)(n.td,{children:"Progress event from subscription (no transition)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"COMPLETE"})}),(0,t.jsx)(n.td,{children:"updating"}),(0,t.jsx)(n.td,{children:"Update finished successfully"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ROLLED_BACK"})}),(0,t.jsx)(n.td,{children:"updating"}),(0,t.jsx)(n.td,{children:"Backend health check triggered rollback"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"FAILED"})}),(0,t.jsx)(n.td,{children:"updating"}),(0,t.jsx)(n.td,{children:"Update failed with error message"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CANCEL"})}),(0,t.jsx)(n.td,{children:"updating"}),(0,t.jsx)(n.td,{children:"User cancels (returns to idle immediately)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESET"})}),(0,t.jsx)(n.td,{children:"complete, rolledBack, failed"}),(0,t.jsx)(n.td,{children:"Return to idle"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-5",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface UpdateContext {\n  instanceId: string | null;\n  fromVersion: string | null;\n  toVersion: string | null;\n  stage: UpdateStage;           // 'PENDING' | 'DOWNLOADING' | 'INSTALLING' | 'VERIFYING' | 'COMPLETE' | 'FAILED' | 'ROLLED_BACK'\n  progress: number;             // 0-100\n  message: string;              // Human-readable status message\n  error: string | null;\n  rolledBack: boolean;\n  startedAt: Date | null;\n  completedAt: Date | null;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"usage-example-4",children:"Usage Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { updateMachine } from '@nasnet/features/services';\nimport { useMachine } from '@xstate/react';\n\nconst [state, send] = useMachine(updateMachine);\n\n// Start update\nsend({ type: 'START_UPDATE', instanceId: 'inst-123', fromVersion: '1.0.0', toVersion: '1.1.0' });\n\n// Bridge subscription events to machine\nuseEffect(() => {\n  if (!progressData) return;\n  const e = progressData.serviceUpdateProgress;\n  send({ type: 'PROGRESS', stage: e.stage, progress: e.progress, message: e.message });\n  if (e.stage === 'COMPLETE') send({ type: 'COMPLETE', toVersion: e.newVersion });\n  else if (e.rolledBack) send({ type: 'ROLLED_BACK', error: e.error });\n  else if (e.stage === 'FAILED') send({ type: 'FAILED', error: e.error });\n}, [progressData, send]);\n\n// Display progress\nconst { progress, message, stage } = state.context;\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"pingmachine",children:"pingMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/features/diagnostics/src/machines/ping-machine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"pingMachine"})," (singleton)"]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-6",children:"Purpose"}),"\n",(0,t.jsxs)(n.p,{children:["Manages the lifecycle of a single ping diagnostic test. Tracks results as they arrive from a backend subscription, computes statistics in real time, and automatically transitions to ",(0,t.jsx)(n.code,{children:"complete"})," when all expected packets have been received."]}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-6",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Ping tool in ",(0,t.jsx)(n.code,{children:"libs/features/diagnostics/src/components/PingTool/"})]}),"\n",(0,t.jsx)(n.li,{children:"Diagnostics dashboard"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-6",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  idle \u2500\u2500START\u2500\u2500\u25ba running\n   \u25b2                \u2502\n   \u2502     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502   STOP\u2502  RESULT_RECEIVED\u2502           ERROR\u2502\n   \u2502     \u25bc            \u25bc                       \u25bc\n   \u2502  stopped    (if isComplete) \u2500\u2500\u25ba complete  error\n   \u2502     \u2502              \u2502\n   \u2502   START          START\n   \u2502     \u2502              \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u25b2 START from any terminal state\n"})}),"\n",(0,t.jsxs)(n.p,{children:["In ",(0,t.jsx)(n.code,{children:"running"}),", ",(0,t.jsx)(n.code,{children:"RESULT_RECEIVED"})," triggers a guard (",(0,t.jsx)(n.code,{children:"isComplete"}),") that checks if ",(0,t.jsx)(n.code,{children:"results.length + 1 >= count"}),". When true, the machine transitions to ",(0,t.jsx)(n.code,{children:"complete"}),"; otherwise it stays in ",(0,t.jsx)(n.code,{children:"running"})," and accumulates the result."]}),"\n",(0,t.jsx)(n.h3,{id:"states-6",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.td,{children:"Ready to start a test"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"running"})}),(0,t.jsx)(n.td,{children:"Test in progress; accumulating results"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"stopped"})}),(0,t.jsx)(n.td,{children:"User manually stopped; results preserved"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"complete"})}),(0,t.jsx)(n.td,{children:"All packets sent; final statistics available"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"error"})}),(0,t.jsx)(n.td,{children:"Test failed; error message in context"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-6",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"START"})}),(0,t.jsx)(n.td,{children:"any"}),(0,t.jsx)(n.td,{children:"Begin new test (resets all state)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"JOB_STARTED"})}),(0,t.jsx)(n.td,{children:"running"}),(0,t.jsx)(n.td,{children:"Backend job ID received"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESULT_RECEIVED"})}),(0,t.jsx)(n.td,{children:"running"}),(0,t.jsx)(n.td,{children:"New ping result from subscription"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"STOP"})}),(0,t.jsx)(n.td,{children:"running"}),(0,t.jsx)(n.td,{children:"User manually stops test"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ERROR"})}),(0,t.jsx)(n.td,{children:"running"}),(0,t.jsx)(n.td,{children:"Test failed with error"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-6",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface PingContext {\n  target: string;            // Host or IP being pinged\n  count: number;             // Total packets to send\n  jobId: string | null;      // Backend job ID for cancellation\n  results: PingResult[];     // RTT, sequence number, success per packet\n  statistics: PingStatistics; // min/max/avg/stdDev RTT, sent/received/lost/lossPercent\n  error: string | null;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"statistics-calculation",children:"Statistics Calculation"}),"\n",(0,t.jsxs)(n.p,{children:["After each ",(0,t.jsx)(n.code,{children:"RESULT_RECEIVED"}),", the ",(0,t.jsx)(n.code,{children:"updateStatistics"})," action calls ",(0,t.jsx)(n.code,{children:"calculateStatistics(context.results)"})," to recompute all statistics from the current results array. This keeps statistics live-updating during the test."]}),"\n",(0,t.jsx)(n.h3,{id:"usage-example-5",children:"Usage Example"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { pingMachine } from '@nasnet/features/diagnostics';\nimport { useActorRef, useSelector } from '@xstate/react';\n\nconst pingActor = useActorRef(pingMachine);\n\n// Start ping test\npingActor.send({ type: 'START', target: '8.8.8.8', count: 10 });\n\n// Feed results from subscription\nuseEffect(() => {\n  if (subscriptionData?.pingResult) {\n    pingActor.send({ type: 'RESULT_RECEIVED', result: subscriptionData.pingResult });\n  }\n}, [subscriptionData]);\n\n// Subscribe to specific context slices (performance optimization)\nconst statistics = useSelector(pingActor, state => state.context.statistics);\nconst isRunning = useSelector(pingActor, state => state.matches('running'));\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createtroubleshootmachine",children:"createTroubleshootMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/features/diagnostics/src/machines/troubleshoot-machine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createTroubleshootMachine(routerId)"})]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-7",children:"Purpose"}),"\n",(0,t.jsx)(n.p,{children:"Guides the user through a 5-step network diagnostic wizard (WAN \u2192 Gateway \u2192 Internet \u2192 DNS \u2192 NAT). For each failing step, it optionally presents a suggested fix, applies it, and verifies whether the fix resolved the issue. Uses compound states for the diagnostic loop."}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-7",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Troubleshoot wizard in ",(0,t.jsx)(n.code,{children:"libs/features/diagnostics/src/components/TroubleshootWizard/"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-7",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  idle \u2500\u2500START\u2500\u2500\u25ba initializing (async: detect WAN interface + gateway)\n                       \u2502\n                  done (or fail gracefully)\n                       \u2502\n                       \u25bc\n              runningDiagnostic (compound)\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u2502                                                         \u2502\n              \u2502  executingStep (async: run current diagnostic)          \u2502\n              \u2502       \u2502                                                 \u2502\n              \u2502      done                                               \u2502\n              \u2502       \u2502                                                 \u2502\n              \u2502  stepComplete (always transitions)                      \u2502\n              \u2502       \u2502                                                 \u2502\n              \u2502  \u250c\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                         \u2502\n              \u2502  \u2502fail+\u2502fix avail        more \u2502 steps              last \u2502\n              \u2502  \u2502     \u25bc                  \u25bc                           step\n              \u2502  \u2502  awaitingFixDecision nextStep \u2500\u2500\u25ba executingStep   \u2500\u2500\u25ba\u2502\n              \u2502  \u2502     \u2502 APPLY_FIX \u2502 SKIP_FIX   (increment index)     \u2502\n              \u2502  \u2502     \u2502           \u2502                                   \u2502\n              \u2502  \u2502     \u25bc           \u2514\u2500\u2500\u25ba nextStep                      \u2502\n              \u2502  \u2502  applyingFix (async)                                \u2502\n              \u2502  \u2502     \u2502                                               \u2502\n              \u2502  \u2502    done                                             \u2502\n              \u2502  \u2502     \u2502                                               \u2502\n              \u2502  \u2502  verifyingFix (async: re-run same diagnostic)       \u2502\n              \u2502  \u2502     \u2502                                               \u2502\n              \u2502  \u2502  \u250c\u2500\u2500\u2534\u2500\u2500\u2510                                            \u2502\n              \u2502  \u2502 fix \u2502   \u2502 fix didn't                                \u2502\n              \u2502  \u2502worked\u2502  \u2502 work                                      \u2502\n              \u2502  \u2502  \u25bc   \u25bc  \u2502                                           \u2502\n              \u2502  \u2502nextStep  awaitingFixDecision (loop)                 \u2502\n              \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              \u2502\n              \u25bc\n           completed (all 5 steps done)\n              \u2502\n           RESTART \u2500\u2500\u25ba idle\n"})}),"\n",(0,t.jsxs)(n.p,{children:["A global ",(0,t.jsx)(n.code,{children:"CANCEL"})," event transitions from any state to ",(0,t.jsx)(n.code,{children:"idle"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"diagnostic-steps-fixed-sequence",children:"Diagnostic Steps (Fixed Sequence)"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"WAN Interface"})," (",(0,t.jsx)(n.code,{children:"wan"}),") \u2014 Check physical connection"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Gateway"})," (",(0,t.jsx)(n.code,{children:"gateway"}),") \u2014 Ping default gateway"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Internet"})," (",(0,t.jsx)(n.code,{children:"internet"}),") \u2014 Ping external server (8.8.8.8)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"DNS"})," (",(0,t.jsx)(n.code,{children:"dns"}),") \u2014 Test name resolution"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"NAT"})," (",(0,t.jsx)(n.code,{children:"nat"}),") \u2014 Verify masquerade rules"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"states-7",children:"States"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Top-level:"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"idle"})}),(0,t.jsx)(n.td,{children:"Waiting to start"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"initializing"})}),(0,t.jsx)(n.td,{children:"Detecting WAN interface and gateway"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"runningDiagnostic"})}),(0,t.jsx)(n.td,{children:"Compound: executing diagnostic steps"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"completed"})}),(0,t.jsx)(n.td,{children:"All steps finished"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["Inside ",(0,t.jsx)(n.code,{children:"runningDiagnostic"}),":"]})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Sub-state"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"executingStep"})}),(0,t.jsx)(n.td,{children:"Running current diagnostic step async"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"stepComplete"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"always"})," transition evaluator"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"awaitingFixDecision"})}),(0,t.jsx)(n.td,{children:"Showing suggested fix; waiting for user"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"applyingFix"})}),(0,t.jsx)(n.td,{children:"Applying the suggested fix async"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"verifyingFix"})}),(0,t.jsx)(n.td,{children:"Re-running diagnostic to confirm fix worked"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"nextStep"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"always"})," transition: increment index or complete"]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-7",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"START"})}),(0,t.jsx)(n.td,{children:"idle"}),(0,t.jsx)(n.td,{children:"Begin diagnostics"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"APPLY_FIX"})}),(0,t.jsx)(n.td,{children:"awaitingFixDecision"}),(0,t.jsx)(n.td,{children:"Apply the suggested fix"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SKIP_FIX"})}),(0,t.jsx)(n.td,{children:"awaitingFixDecision"}),(0,t.jsx)(n.td,{children:"Skip fix, continue to next step"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RESTART"})}),(0,t.jsx)(n.td,{children:"completed"}),(0,t.jsx)(n.td,{children:"Reset all steps and return to idle"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CANCEL"})}),(0,t.jsx)(n.td,{children:"any (global)"}),(0,t.jsx)(n.td,{children:"Abort and return to idle"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-7",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface TroubleshootContext {\n  routerId: string;\n  wanInterface: string;          // Detected in initializing (default: 'ether1')\n  gateway: string | null;        // Detected default gateway\n  steps: DiagnosticStep[];       // Status and results for each of 5 steps\n  currentStepIndex: number;      // 0-indexed position in steps array\n  overallStatus: 'idle' | 'running' | 'completed';\n  appliedFixes: string[];        // Issue codes of fixes that were applied\n  startTime: Date | null;\n  endTime: Date | null;\n  error: string | null;\n}\n\ninterface DiagnosticStep {\n  id: string;\n  name: string;\n  description: string;\n  status: 'pending' | 'running' | 'passed' | 'failed';\n  result?: DiagnosticResult;\n  fix?: DiagnosticFix;           // Populated from fix-registry when step fails\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"actor-configuration-provided-at-runtime",children:"Actor Configuration (Provided at Runtime)"}),"\n",(0,t.jsxs)(n.p,{children:["The machine uses XState's ",(0,t.jsx)(n.code,{children:"provide()"})," at runtime to inject diagnostic implementations:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const machine = createTroubleshootMachine(routerId);\n\nconst actor = createActor(machine.provide({\n  actors: {\n    detectNetworkConfig: fromPromise(async ({ input }) => {\n      const config = await api.detectWanInterface(input.routerId);\n      return { wanInterface: config.interface, gateway: config.gateway };\n    }),\n    executeDiagnosticStep: fromPromise(async ({ input }) => {\n      return api.runDiagnosticStep(input.step.id, input.routerId, input.wanInterface, input.gateway);\n    }),\n    applyFix: fromPromise(async ({ input }) => {\n      return api.applyDiagnosticFix(input.routerId, input.fix);\n    }),\n  },\n})).start();\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"createvpnconnectionmachine",children:"createVPNConnectionMachine"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"File:"})," ",(0,t.jsx)(n.code,{children:"libs/state/machines/src/vpnConnectionMachine.ts"}),"\n",(0,t.jsx)(n.strong,{children:"Export:"})," ",(0,t.jsx)(n.code,{children:"createVPNConnectionMachine(services)"}),", ",(0,t.jsx)(n.code,{children:"useVPNConnection(services)"})]}),"\n",(0,t.jsx)(n.h3,{id:"purpose-8",children:"Purpose"}),"\n",(0,t.jsx)(n.p,{children:"Manages the VPN connection lifecycle: connection establishment with 30-second timeout, automatic reconnection with exponential backoff (max 3 attempts), real-time metrics updates, and graceful disconnection."}),"\n",(0,t.jsx)(n.h3,{id:"when-it-is-used-8",children:"When It Is Used"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"VPN status panel"}),"\n",(0,t.jsx)(n.li,{children:"VPN connection button components"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram-8",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"  disconnected \u2500\u2500CONNECT\u2500\u2500\u25ba connecting (30s timeout)\n       \u25b2                        \u2502               \u2502\n       \u2502                   success\u2502         timeout/error\u2502\n   clearConnection               \u25bc                      \u25bc\n       \u2502                     connected             error \u2500\u2500RETRY\u2500\u2500\u25ba connecting\n       \u2502                    \u2502   \u2502   \u2502                \u2502\n   DISCONNECT          METRICS\u2502  \u2502   \u2502CONNECTION_LOST  DISMISS\u2500\u2500\u25ba disconnected\n       \u2502                UPDATE  \u2502   \u2502\n       \u2502                      DISCONNECT\u2502\n       \u25bc                         \u2502\n  disconnecting (async)          \u25bc\n       \u2502                   reconnecting (exponential backoff, max 3)\n      done                       \u2502\n       \u2502               \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n       \u25bc          success\u2502              fail\u2502\n  disconnected           \u25bc                 \u2502\n                     connected    canReconnect? yes \u2500\u2500\u25ba reconnecting\n                                           \u2502 no\n                                           \u25bc\n                                      disconnected\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"reconnecting"})," state also has a 10-second timeout that forces ",(0,t.jsx)(n.code,{children:"disconnected"})," if the reconnection attempt hangs."]}),"\n",(0,t.jsx)(n.h3,{id:"states-8",children:"States"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"disconnected"})}),(0,t.jsx)(n.td,{children:"Not connected; clears connection context on entry"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"connecting"})}),(0,t.jsx)(n.td,{children:"Establishing connection (30s timeout)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"connected"})}),(0,t.jsx)(n.td,{children:"Active connection; receives real-time metrics"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"reconnecting"})}),(0,t.jsx)(n.td,{children:"Auto-reconnect with exponential backoff"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"disconnecting"})}),(0,t.jsx)(n.td,{children:"Graceful closure (close API call)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"error"})}),(0,t.jsx)(n.td,{children:"Connection failed; offers RETRY or DISMISS"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"events-8",children:"Events"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Event"}),(0,t.jsx)(n.th,{children:"From States"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONNECT"})}),(0,t.jsx)(n.td,{children:"disconnected"}),(0,t.jsx)(n.td,{children:"Initiate connection with serverAddress + provider"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DISCONNECT"})}),(0,t.jsx)(n.td,{children:"connected"}),(0,t.jsx)(n.td,{children:"Graceful disconnect"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"METRICS_UPDATE"})}),(0,t.jsx)(n.td,{children:"connected"}),(0,t.jsx)(n.td,{children:"Real-time bandwidth/traffic data (no transition)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONNECTION_LOST"})}),(0,t.jsx)(n.td,{children:"connected"}),(0,t.jsx)(n.td,{children:"Unexpected drop; triggers reconnect"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RETRY"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Retry after error"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DISMISS"})}),(0,t.jsx)(n.td,{children:"error"}),(0,t.jsx)(n.td,{children:"Dismiss error and go to disconnected"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"context-shape-8",children:"Context Shape"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface VPNConnectionContext {\n  connectionId: string | null;\n  provider: string | null;          // 'wireguard' | 'openvpn' | etc.\n  serverAddress: string | null;\n  metrics: ConnectionMetrics | null; // Bandwidth, uptime, packets\n  error: string | null;\n  reconnectAttempts: number;\n  maxReconnectAttempts: number;      // Default: 3\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"exponential-backoff",children:"Exponential Backoff"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"attemptReconnect"})," actor applies backoff before calling the reconnection API:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const delay = BACKOFF_BASE_MS * Math.pow(2, input.attempt || 0);\nawait new Promise(resolve => setTimeout(resolve, Math.min(delay, 8000)));\n// attempt 0 \u2192 1s, attempt 1 \u2192 2s, attempt 2 \u2192 4s, capped at 8s\n"})}),"\n",(0,t.jsx)(n.h3,{id:"react-hook",children:"React Hook"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"useVPNConnection"})," hook wraps ",(0,t.jsx)(n.code,{children:"useMachine"})," and provides a clean API:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { useVPNConnection } from '@nasnet/state/machines';\n\nfunction VPNStatusPanel() {\n  const vpn = useVPNConnection({\n    establishConnection: async ({ serverAddress, provider }) => {\n      const result = await api.connectVPN(serverAddress, provider);\n      return { connectionId: result.id };\n    },\n    attemptReconnect: async ({ serverAddress, provider }) => {\n      const result = await api.reconnectVPN(serverAddress, provider);\n      return { connectionId: result.id };\n    },\n    closeConnection: async (connectionId) => {\n      await api.disconnectVPN(connectionId);\n    },\n  });\n\n  return (\n    <div>\n      <StatusBadge status={vpn.state} />\n      {vpn.isConnected && <MetricsDisplay metrics={vpn.metrics} />}\n      {vpn.isError && <ErrorPanel error={vpn.error} onRetry={vpn.retry} />}\n      <Button onClick={vpn.isConnected ? vpn.disconnect : () => vpn.connect('vpn.example.com', 'wireguard')}>\n        {vpn.isConnected ? 'Disconnect' : 'Connect'}\n      </Button>\n    </div>\n  );\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Return value includes: ",(0,t.jsx)(n.code,{children:"state"}),", ",(0,t.jsx)(n.code,{children:"connectionId"}),", ",(0,t.jsx)(n.code,{children:"provider"}),", ",(0,t.jsx)(n.code,{children:"serverAddress"}),", ",(0,t.jsx)(n.code,{children:"metrics"}),", ",(0,t.jsx)(n.code,{children:"error"}),", ",(0,t.jsx)(n.code,{children:"reconnectAttempts"}),", ",(0,t.jsx)(n.code,{children:"isConnected"}),", ",(0,t.jsx)(n.code,{children:"isConnecting"}),", ",(0,t.jsx)(n.code,{children:"isError"}),", ",(0,t.jsx)(n.code,{children:"connect()"}),", ",(0,t.jsx)(n.code,{children:"disconnect()"}),", ",(0,t.jsx)(n.code,{children:"retry()"}),", ",(0,t.jsx)(n.code,{children:"dismissError()"}),", ",(0,t.jsx)(n.code,{children:"updateMetrics()"}),", ",(0,t.jsx)(n.code,{children:"reportConnectionLost()"}),"."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"pattern-factory-functions-vs-singleton-machines",children:"Pattern: Factory Functions vs. Singleton Machines"}),"\n",(0,t.jsx)(n.p,{children:"NasNetConnect uses two patterns for defining machines:"}),"\n",(0,t.jsx)(n.h3,{id:"factory-functions-most-machines",children:"Factory Functions (Most Machines)"}),"\n",(0,t.jsx)(n.p,{children:"Used when the machine needs different async implementations per use case, or when multiple independent instances must coexist:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Each call produces a distinct machine instance with its own actor\nconst wireguardMachine = createConfigPipelineMachine<WireGuardConfig>({ ... });\nconst openvpnMachine = createConfigPipelineMachine<OpenVPNConfig>({ ... });\nconst troubleshootMachine1 = createTroubleshootMachine('router-id-1');\nconst troubleshootMachine2 = createTroubleshootMachine('router-id-2');\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Factory machines: ",(0,t.jsx)(n.code,{children:"createConfigPipelineMachine"}),", ",(0,t.jsx)(n.code,{children:"createChangeSetMachine"}),", ",(0,t.jsx)(n.code,{children:"createTemplateApplyMachine"}),", ",(0,t.jsx)(n.code,{children:"createResourceLifecycleMachine"}),", ",(0,t.jsx)(n.code,{children:"createWizardMachine"}),", ",(0,t.jsx)(n.code,{children:"createTroubleshootMachine"}),", ",(0,t.jsx)(n.code,{children:"createVPNConnectionMachine"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"singleton-machines-simple-workflows",children:"Singleton Machines (Simple Workflows)"}),"\n",(0,t.jsx)(n.p,{children:"Used when the machine is stateless by configuration (all variation comes from events/context) and only one instance runs at a time per component:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// The machine definition is shared; each useMachine() call creates a new actor\nimport { updateMachine } from '@nasnet/features/services';\nimport { pingMachine } from '@nasnet/features/diagnostics';\n\nconst [updateState, sendUpdate] = useMachine(updateMachine);\nconst [pingState, sendPing] = useMachine(pingMachine);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Singleton machines: ",(0,t.jsx)(n.code,{children:"updateMachine"}),", ",(0,t.jsx)(n.code,{children:"pingMachine"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"choosing-the-right-pattern",children:"Choosing the Right Pattern"}),"\n",(0,t.jsxs)(n.p,{children:["Use a ",(0,t.jsx)(n.strong,{children:"factory"})," when:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The machine needs access to specific API functions (e.g., ",(0,t.jsx)(n.code,{children:"applyConfig"})," for a specific resource type)"]}),"\n",(0,t.jsx)(n.li,{children:"Multiple isolated instances run simultaneously (e.g., one troubleshooter per router panel)"}),"\n",(0,t.jsxs)(n.li,{children:["The machine has configurable callbacks (",(0,t.jsx)(n.code,{children:"onSuccess"}),", ",(0,t.jsx)(n.code,{children:"onError"}),")"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Use a ",(0,t.jsx)(n.strong,{children:"singleton"})," when:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"All variation is driven by events and context (no closure dependencies)"}),"\n",(0,t.jsx)(n.li,{children:"Only one instance runs at a time within a component tree"}),"\n",(0,t.jsx)(n.li,{children:"The machine is simple and self-contained"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["For Zustand stores that feed events into these machines: ",(0,t.jsx)(n.code,{children:"libs/features/docs/state-management.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["For the Apply-Confirm-Merge pattern overview: ",(0,t.jsx)(n.code,{children:"Docs/architecture/data-architecture.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["For safety pipeline pattern ADR: ",(0,t.jsx)(n.code,{children:"Docs/architecture/novel-pattern-designs.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["For the config pipeline's 7-stage validation pipeline: ",(0,t.jsx)(n.code,{children:"Docs/architecture/api-contracts.md"})]}),"\n",(0,t.jsxs)(n.li,{children:["For XState v5 official docs: ",(0,t.jsx)(n.a,{href:"https://stately.ai/docs",children:"https://stately.ai/docs"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},71184:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>d});var s=i(14041);const t={},r=s.createContext(t);function c(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);