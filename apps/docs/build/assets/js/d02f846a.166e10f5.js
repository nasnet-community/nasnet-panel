"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[90956],{40765:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"stores/connection","title":"Connection Stores (useConnectionStore & useNetworkStore)","description":"WebSocket connection management, per-router status tracking, and network quality monitoring.","source":"@site/../../libs/state/docs/stores/connection.md","sourceDirName":"stores","slug":"/stores/connection","permalink":"/docs/state/stores/connection","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/stores/connection.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Command and Shortcut Registry Stores","permalink":"/docs/state/stores/command-shortcut"},"next":{"title":"Domain UI Stores","permalink":"/docs/state/stores/domain-ui-stores"}}');var c=t(31085),r=t(71184);const o={},i="Connection Stores (useConnectionStore & useNetworkStore)",l={},a=[{value:"Connection Store (useConnectionStore)",id:"connection-store-useconnectionstore",level:2},{value:"State Shape",id:"state-shape",level:3},{value:"WebSocket Status Actions",id:"websocket-status-actions",level:3},{value:"Router Connection Actions",id:"router-connection-actions",level:3},{value:"Reconnection Actions",id:"reconnection-actions",level:3},{value:"Selectors",id:"selectors",level:3},{value:"Network Store (useNetworkStore)",id:"network-store-usenetworkstore",level:2},{value:"State Shape",id:"state-shape-1",level:3},{value:"Status Actions",id:"status-actions",level:3},{value:"Metrics Actions",id:"metrics-actions",level:3},{value:"Quality Tracking (NAS-4.15)",id:"quality-tracking-nas-415",level:3},{value:"Event Listener Management",id:"event-listener-management",level:3},{value:"Selectors",id:"selectors-1",level:3},{value:"Reconnection Manager",id:"reconnection-manager",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Creating a Manager",id:"creating-a-manager",level:3},{value:"Manager API",id:"manager-api",level:3},{value:"Backoff Formula",id:"backoff-formula",level:3},{value:"Helper Functions",id:"helper-functions",level:3},{value:"Integration with Connection Store",id:"integration-with-connection-store",level:2},{value:"Latency Debouncing",id:"latency-debouncing",level:2},{value:"Connection Flow Diagram",id:"connection-flow-diagram",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Connecting to Router",id:"connecting-to-router",level:3},{value:"Monitoring Network Quality",id:"monitoring-network-quality",level:3},{value:"Showing Connection Status",id:"showing-connection-status",level:3},{value:"Performance Optimization",id:"performance-optimization",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"connection-stores-useconnectionstore--usenetworkstore",children:"Connection Stores (useConnectionStore & useNetworkStore)"})}),"\n",(0,c.jsx)(n.p,{children:"WebSocket connection management, per-router status tracking, and network quality monitoring."}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Sources:"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"libs/state/stores/src/connection/connection.store.ts"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"libs/state/stores/src/connection/network.store.ts"})}),"\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.code,{children:"libs/state/stores/src/utils/reconnect.ts"})}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"connection-store-useconnectionstore",children:"Connection Store (useConnectionStore)"}),"\n",(0,c.jsx)(n.p,{children:"Manages WebSocket connection status and per-router connection metadata."}),"\n",(0,c.jsx)(n.h3,{id:"state-shape",children:"State Shape"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"interface ConnectionState {\n  // Global WebSocket status\n  wsStatus: 'connecting' | 'connected' | 'disconnected' | 'error';\n  wsError: string | null;               // Error message if status is 'error'\n\n  // Per-router connections map\n  routers: Record<string, RouterConnection>;\n  activeRouterId: string | null;        // Currently active router\n\n  // Reconnection state\n  reconnectAttempts: number;            // Current attempt count (0-10)\n  maxReconnectAttempts: number;         // Max attempts before giving up (10)\n  isReconnecting: boolean;              // Currently attempting reconnection\n\n  // Legacy compatibility (deprecated but preserved)\n  state: 'connected' | 'disconnected' | 'reconnecting';\n  lastConnectedAt: Date | null;\n  currentRouterId: string | null;\n  currentRouterIp: string | null;\n}\n\ninterface RouterConnection {\n  routerId: string;                     // Router ID\n  status: WebSocketStatus;              // Connection status\n  protocol: 'rest' | 'api' | 'ssh';    // Communication protocol\n  latencyMs: number | null;             // Current latency\n  lastConnected: Date | null;           // Last successful connection time\n  lastError: string | null;             // Last error message\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"websocket-status-actions",children:"WebSocket Status Actions"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setWsStatus(status, error?)"})})," - Set WebSocket connection status"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setWsStatus } = useConnectionStore();\n\n// Connection successful\nsetWsStatus('connected');\n\n// Connection error\nsetWsStatus('error', 'Failed to establish WebSocket');\n\n// Attempting reconnect\nsetWsStatus('connecting');\n"})}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Status transitions:"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"disconnected"})," \u2192 ",(0,c.jsx)(n.code,{children:"connecting"})," \u2192 ",(0,c.jsx)(n.code,{children:"connected"})," (success)"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"disconnected"})," \u2192 ",(0,c.jsx)(n.code,{children:"connecting"})," \u2192 ",(0,c.jsx)(n.code,{children:"error"})," (failure)"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"connected"})," \u2192 ",(0,c.jsx)(n.code,{children:"disconnected"})," (lost connection)"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"router-connection-actions",children:"Router Connection Actions"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setRouterConnection(routerId, connection)"})})," - Set/update router connection info"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setRouterConnection } = useConnectionStore();\n\nsetRouterConnection('router-1', {\n  status: 'connected',\n  protocol: 'api',\n  latencyMs: 45,\n  lastConnected: new Date(),\n  lastError: null,\n});\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setActiveRouter(routerId)"})})," - Switch active router"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setActiveRouter } = useConnectionStore();\n\n// Switch to router-1\nsetActiveRouter('router-1');\n\n// Clear active router\nsetActiveRouter(null);\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"updateLatency(routerId, latencyMs)"})})," - Record latency measurement (debounced)"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { updateLatency } = useConnectionStore();\n\n// Call frequently from ping/heartbeat\nupdateLatency('router-1', 42);\n"})}),"\n",(0,c.jsx)(n.h3,{id:"reconnection-actions",children:"Reconnection Actions"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"incrementReconnectAttempts()"})})," - Increment attempt counter"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { incrementReconnectAttempts } = useConnectionStore();\n\n// Called by reconnection manager on each failed attempt\nincrementReconnectAttempts();\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"resetReconnection()"})})," - Reset attempt counter and isReconnecting flag"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { resetReconnection } = useConnectionStore();\n\n// Called on successful connection\nresetReconnection();\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"hasExceededMaxAttempts(): boolean"})})," - Check if max attempts reached"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { hasExceededMaxAttempts } = useConnectionStore();\n\nif (hasExceededMaxAttempts()) {\n  // Show manual retry UI\n  showError('Unable to reconnect. Please check your connection.');\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"selectors",children:"Selectors"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Selector"}),(0,c.jsx)(n.th,{children:"Returns"}),(0,c.jsx)(n.th,{children:"Usage"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectWsStatus"})}),(0,c.jsx)(n.td,{children:"WebSocketStatus"}),(0,c.jsx)(n.td,{children:"Current WebSocket status"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectIsConnected"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"Whether connected (wsStatus === 'connected')"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectIsReconnecting"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"Whether attempting reconnection"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectActiveRouterId"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"string | null"})}),(0,c.jsx)(n.td,{children:"Currently active router"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectActiveRouterConnection"})}),(0,c.jsx)(n.td,{children:"RouterConnection | null"}),(0,c.jsx)(n.td,{children:"Connection info for active router"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectReconnectAttempts"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"number"})}),(0,c.jsx)(n.td,{children:"Current attempt count"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectHasExceededMaxAttempts"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"Whether max attempts exceeded"})]})]})]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Example:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"// Only re-render when connection status changes\nconst isConnected = useConnectionStore(s => s.wsStatus === 'connected');\n\n// Get active router connection info\nconst router = useConnectionStore(s => {\n  if (!s.activeRouterId) return null;\n  return s.routers[s.activeRouterId];\n});\n"})}),"\n",(0,c.jsx)(n.h2,{id:"network-store-usenetworkstore",children:"Network Store (useNetworkStore)"}),"\n",(0,c.jsx)(n.p,{children:"Monitors browser online status, backend reachability, and network quality."}),"\n",(0,c.jsx)(n.h3,{id:"state-shape-1",children:"State Shape"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"interface NetworkState {\n  // Connectivity status\n  isOnline: boolean;                    // navigator.onLine (browser online/offline)\n  isRouterReachable: boolean;           // Backend health endpoint reachable\n  isRouterConnected: boolean;           // WebSocket subscription active\n\n  // Metrics\n  lastSuccessfulRequest: Date | null;   // Timestamp of last successful API call\n  reconnectAttempts: number;            // Reconnection attempts since last success\n\n  // NAS-4.15: Enhanced status tracking\n  wasOffline: boolean;                  // Was recently offline (for status message)\n  quality: 'excellent' | 'good' | 'poor' | 'offline';  // Network quality\n  latencyMs: number | null;             // Last measured latency\n  lastError: string | null;             // Last network error\n  lastErrorTime: Date | null;           // When last error occurred\n  listenersInitialized: boolean;        // Event listeners set up\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"status-actions",children:"Status Actions"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setOnline(online)"})})," - Update browser online status"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setOnline } = useNetworkStore();\n\n// Called by online/offline event listeners\nsetOnline(true);   // Browser went online\nsetOnline(false);  // Browser went offline\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setRouterReachable(reachable)"})})," - Update backend reachability"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setRouterReachable } = useNetworkStore();\n\n// Called by health check endpoint\nif (healthCheckOK) {\n  setRouterReachable(true);\n} else {\n  setRouterReachable(false);\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setRouterConnected(connected)"})})," - Update WebSocket connection"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setRouterConnected } = useNetworkStore();\n\n// Called when subscription connects/disconnects\nsetRouterConnected(true);   // WebSocket connected\nsetRouterConnected(false);  // WebSocket disconnected\n"})}),"\n",(0,c.jsx)(n.h3,{id:"metrics-actions",children:"Metrics Actions"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"recordSuccessfulRequest()"})})," - Record successful API request"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { recordSuccessfulRequest } = useNetworkStore();\n\n// Called on successful GraphQL query\nrecordSuccessfulRequest();\n// Resets: lastSuccessfulRequest, reconnectAttempts, lastError\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"incrementReconnectAttempts()"})})," - Increment retry counter"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { incrementReconnectAttempts } = useNetworkStore();\n\n// Called on API failure\nincrementReconnectAttempts();\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"resetReconnectAttempts()"})})," - Reset retry counter"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { resetReconnectAttempts } = useNetworkStore();\nresetReconnectAttempts();\n"})}),"\n",(0,c.jsx)(n.h3,{id:"quality-tracking-nas-415",children:"Quality Tracking (NAS-4.15)"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"setQuality(quality)"})})," - Set network quality assessment"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { setQuality } = useNetworkStore();\n\nsetQuality('excellent');  // < 100ms latency\nsetQuality('good');       // < 300ms latency\nsetQuality('poor');       // >= 300ms latency\nsetQuality('offline');    // No internet\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"updateLatency(latencyMs)"})})," - Record latency and update quality"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { updateLatency } = useNetworkStore();\n\nupdateLatency(42);\n// Auto-updates quality: excellent\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"recordNetworkError(error)"})})," - Log network error"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { recordNetworkError } = useNetworkStore();\n\nrecordNetworkError('CORS error: No Access-Control-Allow-Origin');\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"clearWasOffline()"})}),' - Clear "was offline" flag']}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:'const { clearWasOffline } = useNetworkStore();\n\n// Call after showing "back online" message\nclearWasOffline();\n'})}),"\n",(0,c.jsx)(n.h3,{id:"event-listener-management",children:"Event Listener Management"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"initializeListeners()"})})," - Set up browser online/offline events"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { initializeListeners } = useNetworkStore();\n\n// Call once on app initialization\nuseEffect(() => {\n  useNetworkStore.getState().initializeListeners();\n}, []);\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"cleanupListeners()"})})," - Remove event listeners on app unmount"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const { cleanupListeners } = useNetworkStore();\n\nuseEffect(() => {\n  const { initializeListeners, cleanupListeners } = useNetworkStore.getState();\n\n  initializeListeners();\n\n  return () => {\n    cleanupListeners();\n  };\n}, []);\n"})}),"\n",(0,c.jsx)(n.h3,{id:"selectors-1",children:"Selectors"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Selector"}),(0,c.jsx)(n.th,{children:"Returns"}),(0,c.jsx)(n.th,{children:"Usage"})]})}),(0,c.jsxs)(n.tbody,{children:[(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectIsFullyConnected"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"All layers connected (online + reachable + subscribed)"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectIsDegraded"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"Online but backend issues"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectIsOffline"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"Browser offline"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectNetworkQuality"})}),(0,c.jsx)(n.td,{children:"NetworkQuality"}),(0,c.jsx)(n.td,{children:"Quality assessment"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectLatency"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"number | null"})}),(0,c.jsx)(n.td,{children:"Current latency in ms"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectWasOffline"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"Was recently offline"})]}),(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"selectLastError"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"string | null"})}),(0,c.jsx)(n.td,{children:"Last error message"})]})]})]}),"\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Example:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"// Show offline banner\nconst isOffline = useNetworkStore(s => s.isOnline === false);\n\n// Check if fully operational\nconst isFullyConnected = useNetworkStore(s =>\n  s.isOnline && s.isRouterReachable && s.isRouterConnected\n);\n\n// Monitor quality\nconst { quality, latencyMs } = useNetworkStore(\n  s => ({ quality: s.quality, latencyMs: s.latencyMs }),\n  shallow\n);\n"})}),"\n",(0,c.jsx)(n.h2,{id:"reconnection-manager",children:"Reconnection Manager"}),"\n",(0,c.jsx)(n.p,{children:"Exponential backoff reconnection utility for WebSocket reconnection."}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Source:"})," ",(0,c.jsx)(n.code,{children:"libs/state/stores/src/utils/reconnect.ts"})]}),"\n",(0,c.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"interface ReconnectionManagerConfig {\n  maxAttempts?: number;                 // Default: 10\n  connect: () => Promise<void>;         // Actual connection function\n  onStatusChange?: (status: WebSocketStatus) => void;\n  showNotifications?: boolean;          // Default: true\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"creating-a-manager",children:"Creating a Manager"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"import { createReconnectionManager } from '@nasnet/state/stores';\n\nconst reconnectManager = createReconnectionManager({\n  maxAttempts: 10,\n\n  connect: async () => {\n    await websocket.connect();\n  },\n\n  onStatusChange: (status) => {\n    console.log('Connection status:', status);\n  },\n\n  showNotifications: true,\n});\n"})}),"\n",(0,c.jsx)(n.h3,{id:"manager-api",children:"Manager API"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"start()"})})," - Begin reconnection attempts"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"reconnectManager.start();\n// Starts exponential backoff: 1s, 2s, 4s, 8s, 16s, 30s (capped)\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"stop()"})})," - Stop reconnection attempts"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"reconnectManager.stop();\n// Cancels pending timeout\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"reset()"})})," - Reset attempt counter"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"reconnectManager.reset();\n// Sets attempts back to 0\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"getAttempts(): number"})})," - Get current attempt count"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const attempts = reconnectManager.getAttempts();\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"isActive(): boolean"})})," - Check if reconnecting"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"if (reconnectManager.isActive()) {\n  // Currently attempting to reconnect\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"backoff-formula",children:"Backoff Formula"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"delay = min(baseDelay * 2^attempt + jitter, maxDelay)\n\nbaseDelay = 1000ms\nmaxDelay = 30000ms\njitter = 0-1000ms random\n\nAttempt 0: ~1-2s\nAttempt 1: ~2-3s\nAttempt 2: ~4-5s\nAttempt 3: ~8-9s\nAttempt 4: ~16-17s\nAttempt 5+: ~30s (capped)\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Prevents thundering herd"})," by adding random jitter."]}),"\n",(0,c.jsx)(n.h3,{id:"helper-functions",children:"Helper Functions"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"calculateBackoff(attempt)"})})," - Calculate delay for attempt"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const delay = calculateBackoff(0);  // ~1000ms\nconst delay = calculateBackoff(4);  // ~16000ms\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"sleep(ms)"})})," - Promise-based sleep utility"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"await sleep(1000);  // Wait 1 second\n"})}),"\n",(0,c.jsx)(n.h2,{id:"integration-with-connection-store",children:"Integration with Connection Store"}),"\n",(0,c.jsx)(n.p,{children:"The reconnection manager automatically updates connection store:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const reconnectManager = createReconnectionManager({\n  connect: async () => {\n    await websocket.connect();\n  },\n  onStatusChange: (status) => {\n    // Automatically updates useConnectionStore\n    useConnectionStore.getState().setWsStatus(status);\n  },\n});\n\n// When reconnection succeeds:\n// - resets reconnectAttempts \u2192 0\n// - sets wsStatus \u2192 'connected'\n// - shows success toast\n\n// When max attempts exceeded:\n// - sets wsStatus \u2192 'error'\n// - shows error toast with retry option\n"})}),"\n",(0,c.jsx)(n.h2,{id:"latency-debouncing",children:"Latency Debouncing"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"createLatencyUpdater(intervalMs)"})})," - Debounced latency updates"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"import { createLatencyUpdater } from '@nasnet/state/stores';\n\nconst updateLatency = createLatencyUpdater(100); // Update max 10x per second\n\n// In ping handler (called very frequently)\nupdateLatency('router-1', 42);  // Batched updates\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Why debounce?"})," Prevents excessive store updates from high-frequency pings."]}),"\n",(0,c.jsx)(n.h2,{id:"connection-flow-diagram",children:"Connection Flow Diagram"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{children:"Browser Events (online/offline)\n         \u2193\n   setOnline()\n         \u2193\nNetwork Status Listeners\n         \u2193\nAPI Requests\n         \u2193\n   recordSuccessfulRequest() \u2190 Success\n   incrementReconnectAttempts() \u2190 Failure\n         \u2193\nGraphQL Subscription\n         \u2193\n   setRouterConnected() \u2190 Connected/Disconnected\n         \u2193\nuseConnectionStore\n         \u2193\nWebSocket Status\n         \u2193\nReconnection Manager (if needed)\n         \u2193\ncreateReconnectionManager() \u2192 Exponential backoff\n         \u2193\nConnection restored or max attempts exceeded\n"})}),"\n",(0,c.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,c.jsx)(n.h3,{id:"connecting-to-router",children:"Connecting to Router"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"async function connectToRouter(routerId: string, ip: string) {\n  const { setWsStatus } = useConnectionStore();\n\n  setWsStatus('connecting');\n\n  try {\n    const ws = new WebSocket(`ws://${ip}:8080`);\n\n    ws.onopen = () => {\n      setWsStatus('connected');\n      useConnectionStore.getState().setRouterConnection(routerId, {\n        status: 'connected',\n        protocol: 'api',\n        lastConnected: new Date(),\n        lastError: null,\n      });\n    };\n\n    ws.onerror = () => {\n      setWsStatus('error', 'WebSocket connection failed');\n    };\n  } catch (error) {\n    setWsStatus('error', error.message);\n  }\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"monitoring-network-quality",children:"Monitoring Network Quality"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"function setupNetworkMonitoring() {\n  const { updateLatency, recordNetworkError } = useNetworkStore();\n\n  // Health check every 30 seconds\n  setInterval(async () => {\n    const start = Date.now();\n\n    try {\n      const response = await fetch('/api/health');\n      const latency = Date.now() - start;\n\n      updateLatency(latency);\n      useNetworkStore.getState().recordSuccessfulRequest();\n    } catch (error) {\n      recordNetworkError(error.message);\n    }\n  }, 30000);\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"showing-connection-status",children:"Showing Connection Status"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"function ConnectionStatus() {\n  const isOnline = useNetworkStore(s => s.isOnline);\n  const quality = useNetworkStore(s => s.quality);\n  const latency = useNetworkStore(s => s.latencyMs);\n\n  if (!isOnline) {\n    return <OfflineBanner />;\n  }\n\n  return (\n    <StatusBar>\n      Quality: {quality} | Latency: {latency}ms\n    </StatusBar>\n  );\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Always use selectors:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"// \u2705 Good\nconst isConnected = useConnectionStore(s => s.wsStatus === 'connected');\n\n// \u274c Bad\nconst { wsStatus } = useConnectionStore();\n"})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Batch router updates:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"// \u2705 Good: Single call\nsetRouterConnection('router-1', { status, protocol, latency });\n\n// \u274c Bad: Multiple calls\nsetStatus('router-1', status);\nsetProtocol('router-1', protocol);\nsetLatency('router-1', latency);\n"})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:(0,c.jsx)(n.strong,{children:"Debounce latency updates:"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:"const updateLatency = createLatencyUpdater(100);\n\n// Can call frequently without store churn\nws.onmessage = (msg) => {\n  const latency = calculateLatency(msg.timestamp);\n  updateLatency(routerId, latency);\n};\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["See ",(0,c.jsx)(n.code,{children:"Docs/architecture/frontend-architecture.md"})," for state architecture overview."]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var s=t(14041);const c={},r=s.createContext(c);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);