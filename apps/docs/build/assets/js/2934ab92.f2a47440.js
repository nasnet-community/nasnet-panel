"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[49413],{71184:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var s=r(14041);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}},78078:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"process-isolation","title":"Process Isolation","description":"Overview","source":"@site/../backend/docs/process-isolation.md","sourceDirName":".","slug":"/process-isolation","permalink":"/docs/backend/process-isolation","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/process-isolation.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Network Services","permalink":"/docs/backend/network-services"},"next":{"title":"Provisioning Engine","permalink":"/docs/backend/provisioning-engine"}}');var i=r(31085),t=r(71184);const o={},c="Process Isolation",d={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/orchestrator/isolation</code> \u2014 Pre-Start Verification",id:"internalorchestratorisolation--pre-start-verification",level:3},{value:"<code>internal/server</code> \u2014 HTTP Server",id:"internalserver--http-server",level:3},{value:"<code>internal/common/health</code> \u2014 Health Probes",id:"internalcommonhealth--health-probes",level:3},{value:"<code>internal/middleware</code> \u2014 Request Processing",id:"internalmiddleware--request-processing",level:3},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"process-isolation",children:"Process Isolation"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.p,{children:["Process isolation ensures that each service instance (Tor, sing-box, Xray, etc.) operates within a strictly bounded environment: a specific VLAN IP address, a sandboxed directory with correct permissions, and non-conflicting ports. The system enforces these constraints through a ",(0,i.jsx)(n.strong,{children:"four-layer pre-start verification pipeline"})," (",(0,i.jsx)(n.code,{children:"IsolationVerifier"}),") that runs before any process is started or restarted."]}),"\n",(0,i.jsxs)(n.p,{children:["In addition, this document covers the HTTP server that hosts the frontend and API (",(0,i.jsx)(n.code,{children:"server.go"}),"/",(0,i.jsx)(n.code,{children:"static.go"}),"), health probe types used by the orchestrator and container healthcheck, and the authentication + request-ID middleware applied to every API request."]}),"\n",(0,i.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                \u2502              IsolationVerifier                   \u2502\n                \u2502  PortRegistryPort (interface)                    \u2502\n                \u2502  ConfigBindingValidatorPort (interface, optional)\u2502\n                \u2502  EventBus                                        \u2502\n                \u2502  allowedBaseDir ("/data/services")               \u2502\n                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502 VerifyPreStart(ctx, instanceID, ...)\n                               \u25bc\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502            4-Layer Verification Pipeline        \u2502\n          \u2502                                                \u2502\n          \u2502  Layer 1: verifyIPBinding                      \u2502\n          \u2502    \u251c\u2500 ConfigBindingValidatorPort.Validate()    \u2502\n          \u2502    \u2514\u2500 or: direct ValidateBindIP(bindIP)        \u2502\n          \u2502                                                \u2502\n          \u2502  Layer 2: verifyDirectory                      \u2502\n          \u2502    \u251c\u2500 os.Stat (must exist)                     \u2502\n          \u2502    \u251c\u2500 perm & 0777 == 0750 (no group/other w)   \u2502\n          \u2502    \u251c\u2500 filepath.EvalSymlinks (no escape)        \u2502\n          \u2502    \u2514\u2500 strings.HasPrefix(allowedBaseDir)        \u2502\n          \u2502                                                \u2502\n          \u2502  Layer 3: verifyPorts                          \u2502\n          \u2502    \u2514\u2500 PortRegistryPort.IsPortAllocated()       \u2502\n          \u2502       (each allocatedPort must be registered)  \u2502\n          \u2502                                                \u2502\n          \u2502  Layer 4: verifyProcessBinding (warning only)  \u2502\n          \u2502    \u2514\u2500 /proc/net/tcp check (Linux)              \u2502\n          \u2502       no hard failure \u2014 informational only     \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502 returns *IsolationReport\n                              \u25bc\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502           IsolationReport            \u2502\n          \u2502  Violations []IsolationViolation     \u2502\n          \u2502  BindIP      string                  \u2502\n          \u2502  AllocatedPorts []int                \u2502\n          \u2502  HasViolations() bool                \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502 on violations\n                              \u25bc\n                    emitIsolationViolationEvent \u2192 EventBus\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"HTTP Server (Echo v4)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Server.Start(e *echo.Echo, cfg Config)\u2502\n\u2502    \u251c\u2500 goroutine: wait SIGINT/SIGTERM   \u2502\n\u2502    \u251c\u2500 shutdownFn() (app cleanup)       \u2502\n\u2502    \u2514\u2500 e.Shutdown(ctx, 15s timeout)    \u2502\n\u2502                                        \u2502\n\u2502  PerformHealthCheck()                  \u2502\n\u2502    \u2514\u2500 GET /health, 10s timeout        \u2502\n\u2502       exit(0) on 200, exit(1) else    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nStatic File Handler (SPA)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  NewFrontendHandler(fs embed.FS)         \u2502\n\u2502    \u251c\u2500 Skip: /api/*, /graphql, /health    \u2502\n\u2502    \u251c\u2500 Path normalization + traversal guard\u2502\n\u2502    \u251c\u2500 .gz pre-compressed serving         \u2502\n\u2502    \u2502    (JS/CSS + Accept-Encoding: gzip) \u2502\n\u2502    \u251c\u2500 SPA fallback \u2192 index.html          \u2502\n\u2502    \u2514\u2500 Cache headers:                     \u2502\n\u2502         assets/ \u2192 immutable (1yr)        \u2502\n\u2502         index.html \u2192 no-cache            \u2502\n\u2502         others  \u2192 1h                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Middleware Stack (per request)\n  RequestIDMiddleware \u2192 AuthMiddleware \u2192 ProductionModeMiddleware \u2192 handler\n\nRequestIDMiddleware:\n  Read X-Request-ID header | generate ULID (monotonic, mutex-protected)\n  Set on response header + context (internalerrors.WithRequestID)\n\nAuthMiddleware:\n  Skipper: /health, /ready, /playground\n  Try: JWT Bearer \u2192 JWT Cookie \u2192 API Key\n  On success: set context keys (User, Claims, AuthMethod, Session)\n  JWT: sliding session refresh (ShouldRefresh \u2192 RefreshToken \u2192 set cookie)\n\nProductionModeMiddleware:\n  Adds production flag to context (controls error detail in responses)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,i.jsxs)(n.h3,{id:"internalorchestratorisolation--pre-start-verification",children:[(0,i.jsx)(n.code,{children:"internal/orchestrator/isolation"})," \u2014 Pre-Start Verification"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"isolation_verifier.go"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// IsolationVerifier runs 4-layer pre-start checks.\ntype IsolationVerifier struct {\n    portRegistry      PortRegistryPort\n    configValidator   ConfigBindingValidatorPort  // optional, nil-safe\n    eventBus          events.EventBus\n    log               *zap.SugaredLogger\n    allowedBaseDir    string  // default: "/data/services"\n}\n\n// VerifyPreStart runs all layers and returns an IsolationReport.\n// Non-nil report is always returned; check report.HasViolations() for failures.\nfunc (v *IsolationVerifier) VerifyPreStart(\n    ctx context.Context,\n    instanceID string,\n    bindIP string,\n    workDir string,\n    allocatedPorts []int,\n) (*IsolationReport, error)\n\n// IsolationReport summarises results of all verification layers.\ntype IsolationReport struct {\n    Violations     []IsolationViolation\n    BindIP         string\n    AllocatedPorts []int\n}\nfunc (r *IsolationReport) HasViolations() bool\n\n// IsolationViolation describes a single failed check.\ntype IsolationViolation struct {\n    Layer   int     // 1\u20134\n    Code    string  // e.g. "IP_BINDING_INVALID", "DIRECTORY_PERM_INSECURE"\n    Message string\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Layer 1 \u2014 IP Binding (",(0,i.jsx)(n.code,{children:"verifyIPBinding"}),")"]})}),"\n",(0,i.jsxs)(n.p,{children:["Calls ",(0,i.jsx)(n.code,{children:"ConfigBindingValidatorPort.ValidateBinding(instanceID, bindIP)"})," if the port is configured. Falls back to calling ",(0,i.jsx)(n.code,{children:"cfglib.ValidateBindIP(bindIP)"})," directly. Rejects ",(0,i.jsx)(n.code,{children:'""'}),", ",(0,i.jsx)(n.code,{children:"0.0.0.0"}),", ",(0,i.jsx)(n.code,{children:"::"}),", and all loopback addresses."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Layer 2 \u2014 Directory (",(0,i.jsx)(n.code,{children:"verifyDirectory"}),")"]})}),"\n",(0,i.jsxs)(n.p,{children:["Sequence of checks applied to ",(0,i.jsx)(n.code,{children:"workDir"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"os.Stat(workDir)"})," \u2014 directory must exist"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"stat.Mode() & 0777 != 0750"})," \u2014 must be exactly ",(0,i.jsx)(n.code,{children:"0750"}),"; ",(0,i.jsx)(n.code,{children:"0755"}),"/",(0,i.jsx)(n.code,{children:"0777"}),"/",(0,i.jsx)(n.code,{children:"0700"})," are violations"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"filepath.EvalSymlinks(workDir)"})," \u2014 resolves any symlinks"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"strings.HasPrefix(resolved, allowedBaseDir)"})," \u2014 must be under ",(0,i.jsx)(n.code,{children:"/data/services"})," (or configured base); symlink escapes are caught here"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Layer 3 \u2014 Ports (",(0,i.jsx)(n.code,{children:"verifyPorts"}),")"]})}),"\n",(0,i.jsxs)(n.p,{children:["For each port in ",(0,i.jsx)(n.code,{children:"allocatedPorts"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"allocated, err := v.portRegistry.IsPortAllocated(ctx, instanceID, port)\n// allocated == false \u2192 violation: port not in registry\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Ensures all ports the instance expects to use were legitimately allocated via the PortRegistry before the process starts. Ports that aren't registered are flagged as ",(0,i.jsx)(n.code,{children:"PORT_NOT_ALLOCATED"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Layer 4 \u2014 Process Binding (",(0,i.jsx)(n.code,{children:"verifyProcessBinding"}),")"]})}),"\n",(0,i.jsxs)(n.p,{children:["Checks ",(0,i.jsx)(n.code,{children:"/proc/net/tcp"})," on Linux to detect if another process is already listening on the same port. This layer emits ",(0,i.jsx)(n.strong,{children:"warnings only"})," \u2014 it never causes a hard violation. This is intentional: on some platforms (Windows), the check is a no-op, and race conditions between check and bind are acceptable given the port-registry lock provides the primary guard."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Event emission:"})}),"\n",(0,i.jsxs)(n.p,{children:["When ",(0,i.jsx)(n.code,{children:"HasViolations()"})," is true after all layers, ",(0,i.jsx)(n.code,{children:"emitIsolationViolationEvent"})," publishes a structured event to the ",(0,i.jsx)(n.code,{children:"EventBus"})," containing the instance ID, bind IP, and violation details."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Test coverage highlights:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Layer 1: empty bind IP \u2192 violation; valid VLAN IP \u2192 passes; ",(0,i.jsx)(n.code,{children:"ConfigBindingValidator"})," called when configured"]}),"\n",(0,i.jsxs)(n.li,{children:["Layer 2: missing binary dir \u2192 violation; workDir outside allowedBaseDir \u2192 violation; ",(0,i.jsx)(n.code,{children:"0755"})," permissions \u2192 violation (",(0,i.jsx)(n.code,{children:"DIRECTORY_PERM_INSECURE"}),"); ",(0,i.jsx)(n.code,{children:"0750"})," \u2192 passes"]}),"\n",(0,i.jsx)(n.li,{children:"Layer 2: symlink pointing outside allowedBaseDir \u2192 violation (symlink escape)"}),"\n",(0,i.jsx)(n.li,{children:"Layer 3: port not in registry \u2192 violation; port properly allocated \u2192 passes"}),"\n",(0,i.jsx)(n.li,{children:"Layer 4: warning only, no blocking failure regardless of binding state"}),"\n",(0,i.jsx)(n.li,{children:"Cross-instance access: known limitation (one instance cannot be isolated from another instance's dir \u2014 controlled by OS user/group, not this verifier)"}),"\n"]}),"\n",(0,i.jsxs)(n.h3,{id:"internalserver--http-server",children:[(0,i.jsx)(n.code,{children:"internal/server"})," \u2014 HTTP Server"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"server.go"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// Config holds HTTP server tuning parameters.\ntype Config struct {\n    Port         int\n    ReadTimeout  time.Duration  // prod: 30s, dev: 60s\n    WriteTimeout time.Duration  // prod: 30s, dev: 60s\n    IdleTimeout  time.Duration  // prod: 60s, dev: 120s\n}\n\n// Start starts the Echo server and blocks until shutdown signal.\n// On SIGINT or SIGTERM: calls shutdownFn, then e.Shutdown(15s ctx).\nfunc Start(e *echo.Echo, cfg Config, shutdownFn func()) error\n\n// PerformHealthCheck performs a container health check.\n// GET /health with 10s timeout. Exits 0 on HTTP 200, exits 1 otherwise.\n// Called by Dockerfile HEALTHCHECK instruction.\nfunc PerformHealthCheck(port int)\n"})}),"\n",(0,i.jsx)(n.p,{children:"The graceful shutdown sequence:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"SIGINT/SIGTERM received\n    \u2502\n    \u251c\u2500 shutdownFn()          // app-level cleanup (close DB, stop services)\n    \u2514\u2500 e.Shutdown(ctx)       // 15s drain window for in-flight requests\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"static.go"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// NewFrontendHandler returns an Echo handler serving the embedded SPA.\nfunc NewFrontendHandler(fs embed.FS) echo.HandlerFunc\n"})}),"\n",(0,i.jsx)(n.p,{children:"Request processing:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Route skipping:"})," If path starts with ",(0,i.jsx)(n.code,{children:"/api/"}),", ",(0,i.jsx)(n.code,{children:"/graphql"}),", or ",(0,i.jsx)(n.code,{children:"/health"})," \u2014 return ",(0,i.jsx)(n.code,{children:"next(c)"})," (let Echo route it)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Path normalization:"})," ",(0,i.jsx)(n.code,{children:"path.Clean(urlPath)"}),", strip leading ",(0,i.jsx)(n.code,{children:"/"}),", reject ",(0,i.jsx)(n.code,{children:".."})," components."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Traversal guard:"})," Constructed file path must stay within the FS root."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Pre-compressed serving:"})," For ",(0,i.jsx)(n.code,{children:".js"})," and ",(0,i.jsx)(n.code,{children:".css"})," files, if ",(0,i.jsx)(n.code,{children:"Accept-Encoding"})," contains ",(0,i.jsx)(n.code,{children:"gzip"})," and a ",(0,i.jsx)(n.code,{children:".gz"})," sibling exists in the FS, serve the ",(0,i.jsx)(n.code,{children:".gz"})," file with ",(0,i.jsx)(n.code,{children:"Content-Encoding: gzip"})," and correct MIME type."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SPA fallback:"})," If the requested file doesn't exist \u2192 serve ",(0,i.jsx)(n.code,{children:"index.html"})," with ",(0,i.jsx)(n.code,{children:"Content-Type: text/html"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cache headers:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Path contains ",(0,i.jsx)(n.code,{children:"assets/"})," \u2192 ",(0,i.jsx)(n.code,{children:"Cache-Control: public, max-age=31536000, immutable"})]}),"\n",(0,i.jsxs)(n.li,{children:["File is ",(0,i.jsx)(n.code,{children:"index.html"})," \u2192 ",(0,i.jsx)(n.code,{children:"Cache-Control: no-cache"})]}),"\n",(0,i.jsxs)(n.li,{children:["Otherwise \u2192 ",(0,i.jsx)(n.code,{children:"Cache-Control: public, max-age=3600"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"MIME type mapping (subset):"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Extension"}),(0,i.jsx)(n.th,{children:"MIME"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:".js"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"application/javascript"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:".css"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"text/css"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:".json"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"application/json"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:".png"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"image/png"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:".svg"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"image/svg+xml"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:".woff2"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"font/woff2"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"(default)"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"text/html"})})]})]})]}),"\n",(0,i.jsxs)(n.h3,{id:"internalcommonhealth--health-probes",children:[(0,i.jsx)(n.code,{children:"internal/common/health"})," \u2014 Health Probes"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// Probe is implemented by all health check types.\ntype Probe interface {\n    Check(ctx context.Context) error\n    Name() string\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"TCPProbe"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type TCPProbe struct {\n    Address string        // "host:port"\n    Timeout time.Duration // default 5s\n}\nfunc (p *TCPProbe) Check(ctx context.Context) error  // net.Dialer.DialContext\nfunc (p *TCPProbe) Name() string\n'})}),"\n",(0,i.jsx)(n.p,{children:"Dials the target address. Returns nil on successful TCP connection. Used by the orchestrator to verify a service's listener is up before marking it healthy."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"HTTPProbe"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type HTTPProbe struct {\n    URL            string\n    ExpectedStatus int           // 0 = any 2xx\n    Timeout        time.Duration\n}\nfunc (p *HTTPProbe) Check(ctx context.Context) error\nfunc (p *HTTPProbe) Name() string\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Issues an HTTP GET and checks the response status. Returns an error if the status doesn't match ",(0,i.jsx)(n.code,{children:"ExpectedStatus"})," (or is non-2xx when ",(0,i.jsx)(n.code,{children:"ExpectedStatus == 0"}),")."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ProcessProbe"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type ProcessProbe struct {\n    Name string\n    mu   sync.RWMutex\n    pid  int\n}\nfunc (p *ProcessProbe) Check(ctx context.Context) error  // os.FindProcess + signal(0)\nfunc (p *ProcessProbe) UpdatePID(pid int)\nfunc (p *ProcessProbe) GetPID() int\nfunc (p *ProcessProbe) Name() string\n"})}),"\n",(0,i.jsxs)(n.p,{children:["On Linux/macOS: sends ",(0,i.jsx)(n.code,{children:"signal(0)"})," to the PID \u2014 succeeds if process is alive, returns error otherwise. On Windows: ",(0,i.jsx)(n.code,{children:"os.FindProcess"})," is trusted directly (Windows always returns non-nil). ",(0,i.jsx)(n.code,{children:"UpdatePID"})," is called by the supervisor when a process is (re)started."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"CompositeProbe"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type CompositeProbe struct {\n    Probes []Probe\n    name   string\n}\nfunc (p *CompositeProbe) Check(ctx context.Context) error  // all probes must pass\nfunc (p *CompositeProbe) Name() string\n"})}),"\n",(0,i.jsx)(n.p,{children:"Runs all constituent probes. Returns the first error encountered. Used for services that have both a TCP listener and an HTTP health endpoint."}),"\n",(0,i.jsxs)(n.h3,{id:"internalmiddleware--request-processing",children:[(0,i.jsx)(n.code,{children:"internal/middleware"})," \u2014 Request Processing"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"auth.go"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// Context key types (unexported, prevent collisions)\ntype contextKey string\nconst (\n    UserContextKey       contextKey = "user"\n    ClaimsContextKey     contextKey = "claims"\n    AuthMethodContextKey contextKey = "auth_method"\n    SessionContextKey    contextKey = "session"\n)\n\n// Cookie names\nconst (\n    AccessTokenCookie  = "access_token"\n    RefreshTokenCookie = "refresh_token"\n)\n\n// AuthMiddleware returns an Echo middleware function.\n// Skipper: /health, /ready, /playground (always pass through unauthenticated).\nfunc AuthMiddleware(jwtSvc JWTService, apiKeySvc APIKeyService) echo.MiddlewareFunc\n'})}),"\n",(0,i.jsx)(n.p,{children:"Authentication attempt order (first success wins):"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"JWT Bearer:"})," ",(0,i.jsx)(n.code,{children:"Authorization: Bearer <token>"})," header \u2192 ",(0,i.jsx)(n.code,{children:"JWTService.ValidateToken"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"JWT Cookie:"})," ",(0,i.jsx)(n.code,{children:"access_token"})," cookie \u2192 ",(0,i.jsx)(n.code,{children:"JWTService.ValidateToken"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"API Key:"})," ",(0,i.jsx)(n.code,{children:"X-API-Key"})," header \u2192 ",(0,i.jsx)(n.code,{children:"APIKeyService.ValidateKey"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["On successful JWT authentication, ",(0,i.jsx)(n.code,{children:"handleTokenRefresh"})," checks ",(0,i.jsx)(n.code,{children:"JWTService.ShouldRefresh(claims)"}),". If true: calls ",(0,i.jsx)(n.code,{children:"RefreshToken"})," and sets the new ",(0,i.jsx)(n.code,{children:"access_token"})," cookie on the response, then invokes a configured refresh callback (for event publishing)."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Context helper functions (for downstream handlers):"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func UserFromContext(ctx context.Context) (*ent.User, bool)\nfunc ClaimsFromContext(ctx context.Context) (*jwt.Claims, bool)\nfunc AuthMethodFromContext(ctx context.Context) (string, bool)\nfunc SessionFromContext(ctx context.Context) (*ent.Session, bool)\nfunc IsAuthenticated(ctx context.Context) bool\nfunc HasRole(ctx context.Context, role string) bool\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Role middleware:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// AuthRequiredMiddleware rejects unauthenticated requests with 401.\nfunc AuthRequiredMiddleware() echo.MiddlewareFunc\n\n// RoleRequiredMiddleware rejects requests without the specified role with 403.\nfunc RoleRequiredMiddleware(role string) echo.MiddlewareFunc\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"request_id.go"})})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"// RequestIDMiddleware generates or propagates X-Request-ID using ULID.\n// ULID properties: time-sortable, globally unique, URL-safe, monotonic entropy.\n// Mutex protects the monotonic counter across concurrent requests.\nfunc RequestIDMiddleware() echo.MiddlewareFunc\n\n// ProductionModeMiddleware adds a production flag to the context.\n// Used downstream to suppress stack traces and internal error details.\nfunc ProductionModeMiddleware() echo.MiddlewareFunc\n\n// ChainMiddleware chains middlewares in reverse order (first applied = outermost).\nfunc ChainMiddleware(middlewares ...echo.MiddlewareFunc) echo.MiddlewareFunc\n"})}),"\n",(0,i.jsx)(n.p,{children:"Request ID logic:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Read ",(0,i.jsx)(n.code,{children:"X-Request-ID"})," from incoming request headers"]}),"\n",(0,i.jsxs)(n.li,{children:["If absent or empty: generate new ULID (",(0,i.jsx)(n.code,{children:"ulid.NewString()"})," with monotonic entropy under mutex)"]}),"\n",(0,i.jsxs)(n.li,{children:["Set ",(0,i.jsx)(n.code,{children:"X-Request-ID"})," on response"]}),"\n",(0,i.jsxs)(n.li,{children:["Store in context via ",(0,i.jsx)(n.code,{children:"internalerrors.WithRequestID(ctx, id)"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"[See: 18-config-generation.md \xa7ValidateBindIP] \u2014 validator called in Layer 1 IP binding check"}),"\n",(0,i.jsx)(n.li,{children:"[See: 10-port-registry.md \xa7AllocatePort] \u2014 ports verified in Layer 3 against PortRegistry"}),"\n",(0,i.jsx)(n.li,{children:"[See: 13-network-services.md \xa7Lifecycle Installer] \u2014 IsolationVerifier called before process start"}),"\n",(0,i.jsx)(n.li,{children:"[See: 05-auth-jwt.md \xa7JWT Service] \u2014 JWTService interface used by AuthMiddleware"}),"\n",(0,i.jsx)(n.li,{children:"[See: 20-router-services.md \xa7Port Registry] \u2014 PortRegistryPort implementation details"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);