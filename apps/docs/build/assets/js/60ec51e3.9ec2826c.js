"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[88167],{16342:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"stores/change-set","title":"Change Set Store","description":"This document covers the change set store that manages atomic multi-resource operations and their execution flow.","source":"@site/../../libs/state/docs/stores/change-set.md","sourceDirName":"stores","slug":"/stores/change-set","permalink":"/docs/state/stores/change-set","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/stores/change-set.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Authentication Store (useAuthStore)","permalink":"/docs/state/stores/auth"},"next":{"title":"Command and Shortcut Registry Stores","permalink":"/docs/state/stores/command-shortcut"}}');var s=t(31085),i=t(71184);const a={},d="Change Set Store",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Change Set Types",id:"change-set-types",level:2},{value:"ChangeSet Interface",id:"changeset-interface",level:3},{value:"ChangeSetStatus Enum",id:"changesetstatus-enum",level:3},{value:"ChangeSetItem Interface",id:"changesetitem-interface",level:3},{value:"ChangeSetItemStatus Enum",id:"changesetitemstatus-enum",level:3},{value:"Store State and Actions",id:"store-state-and-actions",level:2},{value:"State Shape",id:"state-shape",level:3},{value:"Lifecycle Actions",id:"lifecycle-actions",level:3},{value:"Item Management Actions",id:"item-management-actions",level:3},{value:"Status Update Actions",id:"status-update-actions",level:3},{value:"Utility Actions",id:"utility-actions",level:3},{value:"Dependency Management",id:"dependency-management",level:2},{value:"Dependency Graph and Topological Ordering",id:"dependency-graph-and-topological-ordering",level:3},{value:"buildDependencyGraph()",id:"builddependencygraph",level:3},{value:"computeApplyOrder()",id:"computeapplyorder",level:3},{value:"Create Change Set Workflow",id:"create-change-set-workflow",level:2},{value:"1. Create Draft",id:"1-create-draft",level:3},{value:"2. Add Items",id:"2-add-items",level:3},{value:"3. Edit Before Apply",id:"3-edit-before-apply",level:3},{value:"4. Validate and Mark Ready",id:"4-validate-and-mark-ready",level:3},{value:"5. Apply (via state machine, not store)",id:"5-apply-via-state-machine-not-store",level:3},{value:"Persistence Model",id:"persistence-model",level:2},{value:"Storage",id:"storage",level:3},{value:"Rehydration",id:"rehydration",level:3},{value:"Summary for Display",id:"summary-for-display",level:2},{value:"Operation Counts",id:"operation-counts",level:2},{value:"Usage Example",id:"usage-example",level:2},{value:"Integration with XState Machine",id:"integration-with-xstate-machine",level:2},{value:"Conflict Detection",id:"conflict-detection",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"change-set-store",children:"Change Set Store"})}),"\n",(0,s.jsx)(n.p,{children:"This document covers the change set store that manages atomic multi-resource operations and their execution flow."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Source:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"libs/state/stores/src/change-set/change-set.store.ts"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The change set store provides:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Multi-Resource Operations"}),": Atomic changes to multiple resources"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Dependency Tracking"}),": Topological ordering ensures correct apply sequence"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Status Management"}),": DRAFT \u2192 READY \u2192 APPLYING \u2192 COMPLETED/FAILED/ROLLED_BACK"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Validation"}),": Pre-apply validation and dependency cycle detection"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rollback Planning"}),": Automatic reverse operations for failed applies"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Session Persistence"}),": Survives page refresh (draft change sets only)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"change-set-types",children:"Change Set Types"}),"\n",(0,s.jsx)(n.h3,{id:"changeset-interface",children:"ChangeSet Interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ChangeSet {\n  // Unique identifier\n  id: string;\n\n  // Display name (e.g., \"Create LAN Network\")\n  name: string;\n\n  // Optional description\n  description?: string;\n\n  // Router this change set applies to\n  routerId: string;\n\n  // Items in this change set\n  items: ChangeSetItem[];\n\n  // Current status\n  status: ChangeSetStatus;\n\n  // Validation results before apply\n  validation: {\n    isValid: boolean;\n    errors?: string[];\n    warnings?: string[];\n  } | null;\n\n  // For failed applies, instructions to recover\n  rollbackPlan: string[];\n\n  // Error info if apply failed\n  error: {\n    message: string;\n    failedItemId: string;\n    partiallyAppliedItemIds: string[];\n    failedRollbackItemIds: string[];\n    requiresManualIntervention: boolean;\n  } | null;\n\n  // Timestamps\n  createdAt: Date;\n  applyStartedAt: Date | null;\n  completedAt: Date | null;\n\n  // Source (e.g., 'lan-wizard', 'manual-edit')\n  source?: string;\n\n  // Version for optimistic concurrency\n  version: number;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"changesetstatus-enum",children:"ChangeSetStatus Enum"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"export enum ChangeSetStatus {\n  DRAFT = 'DRAFT',               // Initial state, editable\n  READY = 'READY',               // Validated, ready to apply\n  APPLYING = 'APPLYING',         // Currently applying items\n  COMPLETED = 'COMPLETED',       // All items applied successfully\n  FAILED = 'FAILED',             // Apply failed, partial rollback\n  ROLLING_BACK = 'ROLLING_BACK', // Undoing partial apply\n  ROLLED_BACK = 'ROLLED_BACK',   // All changes undone\n  CANCELLED = 'CANCELLED',       // User cancelled before apply\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"changesetitem-interface",children:"ChangeSetItem Interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ChangeSetItem {\n  // Unique ID within change set\n  id: string;\n\n  // Resource type (e.g., 'network.bridge', 'vpn.wireguard')\n  resourceType: string;\n\n  // Resource category (e.g., 'network', 'vpn')\n  resourceCategory: string;\n\n  // UUID of resource (if updating existing)\n  resourceUuid?: string;\n\n  // Display name\n  name: string;\n\n  // Optional description\n  description?: string;\n\n  // Operation type\n  operation: 'CREATE' | 'UPDATE' | 'DELETE';\n\n  // New configuration (for CREATE/UPDATE)\n  configuration: unknown;\n\n  // Previous configuration (for UPDATE/DELETE, used in rollback)\n  previousState?: unknown;\n\n  // IDs of items this depends on (must apply first)\n  dependencies: string[];\n\n  // Current status\n  status: ChangeSetItemStatus;\n\n  // Error message if apply failed\n  error: string | null;\n\n  // Timestamps\n  applyStartedAt: Date | null;\n  applyCompletedAt: Date | null;\n\n  // State confirmed from router after successful apply\n  confirmedState: unknown | null;\n\n  // Order in which to apply (computed from dependencies)\n  applyOrder: number;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"changesetitemstatus-enum",children:"ChangeSetItemStatus Enum"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"export type ChangeSetItemStatus =\n  | 'PENDING'       // Waiting to apply\n  | 'APPLYING'      // Currently applying\n  | 'APPLIED'       // Successfully applied\n  | 'FAILED'        // Apply failed\n  | 'ROLLED_BACK';  // Undone during rollback\n"})}),"\n",(0,s.jsx)(n.h2,{id:"store-state-and-actions",children:"Store State and Actions"}),"\n",(0,s.jsx)(n.h3,{id:"state-shape",children:"State Shape"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"export interface ChangeSetState {\n  // Map of change set ID \u2192 change set (JSON serializable for persistence)\n  changeSets: Record<string, ChangeSet>;\n\n  // Currently selected change set (for UI focus)\n  activeChangeSetId: string | null;\n\n  // IDs of change sets currently applying\n  applyingChangeSetIds: string[];\n\n  // Last error message for display\n  lastError: string | null;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"lifecycle-actions",children:"Lifecycle Actions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Action"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"createChangeSet({name, description, routerId, source})"})}),(0,s.jsx)(n.td,{children:"Create draft change set, return ID"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"getChangeSet(id)"})}),(0,s.jsx)(n.td,{children:"Get by ID or null"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"getChangeSetsForRouter(routerId)"})}),(0,s.jsx)(n.td,{children:"Get all for a router"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"deleteChangeSet(id)"})}),(0,s.jsx)(n.td,{children:"Delete (fails if applying)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"setActiveChangeSet(id | null)"})}),(0,s.jsx)(n.td,{children:"Set UI focus"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"item-management-actions",children:"Item Management Actions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Action"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"addItem(changeSetId, item)"})}),(0,s.jsx)(n.td,{children:"Add item, recalculate apply order"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"updateItem(changeSetId, itemId, updates)"})}),(0,s.jsx)(n.td,{children:"Update fields, recalculate if deps change"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"removeItem(changeSetId, itemId)"})}),(0,s.jsx)(n.td,{children:"Remove item and its dependent references"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"setItemDependencies(changeSetId, itemId, deps)"})}),(0,s.jsx)(n.td,{children:"Update dependencies, recalculate order"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"status-update-actions",children:"Status Update Actions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Action"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"updateStatus(id, status)"})}),(0,s.jsx)(n.td,{children:"Update change set status"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"updateItemStatus(id, itemId, status, error?)"})}),(0,s.jsx)(n.td,{children:"Update item status + timestamps"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"markApplying(id)"})}),(0,s.jsx)(n.td,{children:"Set to APPLYING, record start time"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"markCompleted(id)"})}),(0,s.jsx)(n.td,{children:"Set to COMPLETED, record end time"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"markFailed(id, error, failedItemId)"})}),(0,s.jsx)(n.td,{children:"Mark failed, store error info"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"markRolledBack(id)"})}),(0,s.jsx)(n.td,{children:"Mark as ROLLED_BACK, update applied items"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"utility-actions",children:"Utility Actions"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Action"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"recalculateApplyOrder(id)"})}),(0,s.jsx)(n.td,{children:"Recompute order from dependencies"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"getChangeSetSummary(id)"})}),(0,s.jsx)(n.td,{children:"Get summary for list views"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"getAllSummaries(routerId)"})}),(0,s.jsx)(n.td,{children:"Get summaries for all change sets"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"clearCompleted(routerId?)"})}),(0,s.jsx)(n.td,{children:"Remove completed/failed/rolled back"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"clearError()"})}),(0,s.jsx)(n.td,{children:"Clear lastError"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"reset()"})}),(0,s.jsx)(n.td,{children:"Clear all state (testing)"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"dependency-management",children:"Dependency Management"}),"\n",(0,s.jsx)(n.h3,{id:"dependency-graph-and-topological-ordering",children:"Dependency Graph and Topological Ordering"}),"\n",(0,s.jsx)(n.p,{children:"Changes are applied in dependency order to ensure prerequisites are met:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Example: Create LAN network requires bridge before DHCP\nconst items = [\n  {\n    id: 'item-1',\n    name: 'Bridge Interface',\n    operation: 'CREATE',\n    dependencies: [],           // No dependencies, apply first\n    applyOrder: 0,\n  },\n  {\n    id: 'item-2',\n    name: 'DHCP Configuration',\n    operation: 'CREATE',\n    dependencies: ['item-1'],   // Depends on bridge\n    applyOrder: 1,\n  },\n  {\n    id: 'item-3',\n    name: 'Firewall Rules',\n    operation: 'CREATE',\n    dependencies: ['item-1'],   // Also depends on bridge\n    applyOrder: 1,              // Can apply in parallel with item-2\n  },\n];\n"})}),"\n",(0,s.jsx)(n.h3,{id:"builddependencygraph",children:"buildDependencyGraph()"}),"\n",(0,s.jsx)(n.p,{children:"Converts dependency list to graph structure:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const nodes = buildDependencyGraph([\n  { id: 'item-1', dependencies: [] },\n  { id: 'item-2', dependencies: ['item-1'] },\n  { id: 'item-3', dependencies: ['item-1'] },\n]);\n\n// Returns graph with parent/child relationships\n// Detects cycles (error if found)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"computeapplyorder",children:"computeApplyOrder()"}),"\n",(0,s.jsx)(n.p,{children:"Topological sort to determine apply sequence:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const orderMap = computeApplyOrder(nodes);\n// Returns Map<itemId, applyOrder>\n\n// orderMap.get('item-1') \u2192 0 (apply first)\n// orderMap.get('item-2') \u2192 1 (apply after item-1)\n// orderMap.get('item-3') \u2192 1 (apply after item-1, parallel with item-2)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Automatic recalculation on:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Item added"}),"\n",(0,s.jsx)(n.li,{children:"Dependencies updated"}),"\n",(0,s.jsx)(n.li,{children:"Item removed"}),"\n",(0,s.jsx)(n.li,{children:"Item moved"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"create-change-set-workflow",children:"Create Change Set Workflow"}),"\n",(0,s.jsx)(n.h3,{id:"1-create-draft",children:"1. Create Draft"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const { createChangeSet, addItem } = useChangeSetStore();\n\nconst csId = createChangeSet({\n  name: 'Create LAN Network',\n  description: 'Set up new LAN with bridge, DHCP, and firewall',\n  routerId: 'router-123',\n  source: 'lan-wizard',\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-add-items",children:"2. Add Items"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Add bridge first (no dependencies)\nconst itemId1 = addItem(csId, {\n  resourceType: 'network.bridge',\n  resourceCategory: 'network',\n  name: 'LAN Bridge',\n  operation: 'CREATE',\n  configuration: { name: 'bridge-lan', ports: ['ether2', 'ether3'] },\n  dependencies: [],\n});\n\n// Add DHCP (depends on bridge)\nconst itemId2 = addItem(csId, {\n  resourceType: 'dhcp.server',\n  resourceCategory: 'network',\n  name: 'DHCP Configuration',\n  operation: 'CREATE',\n  configuration: { ... },\n  dependencies: [itemId1],\n});\n\n// Add firewall (also depends on bridge)\nconst itemId3 = addItem(csId, {\n  resourceType: 'firewall.rules',\n  resourceCategory: 'firewall',\n  name: 'Firewall Rules',\n  operation: 'CREATE',\n  configuration: { ... },\n  dependencies: [itemId1],\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-edit-before-apply",children:"3. Edit Before Apply"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const { updateItem, setItemDependencies } = useChangeSetStore();\n\n// Edit DHCP configuration\nupdateItem(csId, itemId2, {\n  configuration: { ...newConfig },\n  description: 'Updated DHCP range',\n});\n\n// Add new dependency\nsetItemDependencies(csId, itemId3, [itemId1, itemId2]);\n// Now firewall applies after DHCP\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-validate-and-mark-ready",children:"4. Validate and Mark Ready"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Validation happens before apply (not in store)\n// Application code:\nconst validation = await validateChangeSet(changeSet);\n\nif (validation.isValid) {\n  updateStatus(csId, ChangeSetStatus.READY);\n} else {\n  // Show validation errors to user\n  console.error(validation.errors);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"5-apply-via-state-machine-not-store",children:"5. Apply (via state machine, not store)"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"changeSetMachine"})," (XState) orchestrates apply flow:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"DRAFT \u2192 READY \u2192 APPLYING \u2192 COMPLETED/FAILED \u2192 ROLLED_BACK\n"})}),"\n",(0,s.jsx)(n.p,{children:"During APPLYING:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"markApplying(csId)"})," sets status and start time"]}),"\n",(0,s.jsxs)(n.li,{children:["Apply each item in ",(0,s.jsx)(n.code,{children:"applyOrder"})," sequence"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"updateItemStatus(csId, itemId, 'APPLIED')"})," on success"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"updateItemStatus(csId, itemId, 'FAILED', error)"})," on failure"]}),"\n",(0,s.jsxs)(n.li,{children:["On first failure: ",(0,s.jsx)(n.code,{children:"markFailed(csId, error, failedItemId)"})]}),"\n",(0,s.jsxs)(n.li,{children:["Rollback partial changes: ",(0,s.jsx)(n.code,{children:"markRolledBack(csId)"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.code,{children:"changeSetMachine"})," documentation for full flow."]}),"\n",(0,s.jsx)(n.h2,{id:"persistence-model",children:"Persistence Model"}),"\n",(0,s.jsx)(n.h3,{id:"storage",children:"Storage"}),"\n",(0,s.jsx)(n.p,{children:"Only draft and ready change sets are persisted to localStorage:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"partialize: (state) => ({\n  changeSets: Object.fromEntries(\n    Object.entries(state.changeSets).filter(\n      ([, cs]) => cs.status === CS.DRAFT || cs.status === CS.READY\n    )\n  ),\n  activeChangeSetId: state.activeChangeSetId,\n}),\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Rationale"}),": Applied/failed change sets are historical; draft/ready are work-in-progress."]}),"\n",(0,s.jsx)(n.h3,{id:"rehydration",children:"Rehydration"}),"\n",(0,s.jsx)(n.p,{children:"On app load, draft change sets are restored:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Draft change set from last session is available\nconst draftCS = getChangeSet(previousCsId);\nif (draftCS) {\n  // User can continue editing or apply\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"summary-for-display",children:"Summary for Display"}),"\n",(0,s.jsx)(n.p,{children:"Get concise info for lists without full change set:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ChangeSetSummary {\n  id: string;\n  name: string;\n  status: ChangeSetStatus;\n  operationCounts: { create: number; update: number; delete: number };\n  totalItems: number;\n  createdAt: Date;\n  hasErrors: boolean;\n  hasWarnings: boolean;\n}\n\nconst summary = getChangeSetSummary(csId);\n// Use in list views, progress displays\n"})}),"\n",(0,s.jsx)(n.p,{children:"Example display:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500 Create LAN Network \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Status: READY                   \u2502\n\u2502 3 items: 2 CREATE, 0 UPDATE, 0 DELETE\n\u2502 Created: 2024-01-15 10:30 AM    \u2502\n\u2502 Warnings: \u26a0\ufe0f 2                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"operation-counts",children:"Operation Counts"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function getOperationCounts(\n  items: ChangeSetItem[]\n): { create: number; update: number; delete: number }\n"})}),"\n",(0,s.jsx)(n.p,{children:"Useful for summary displays and validation rules."}),"\n",(0,s.jsx)(n.h2,{id:"usage-example",children:"Usage Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"function ChangeSetEditor({ changeSetId }) {\n  const {\n    getChangeSet,\n    addItem,\n    updateItem,\n    removeItem,\n    recalculateApplyOrder,\n  } = useChangeSetStore();\n\n  const changeSet = getChangeSet(changeSetId);\n  if (!changeSet) return null;\n\n  const handleAddItem = async (itemData) => {\n    const itemId = addItem(changeSetId, itemData);\n    // Order auto-recalculated\n  };\n\n  const handleUpdateDependencies = (itemId, newDeps) => {\n    setItemDependencies(changeSetId, itemId, newDeps);\n    // Order auto-recalculated\n  };\n\n  return (\n    <div>\n      <h2>{changeSet.name}</h2>\n      <p>Status: {changeSet.status}</p>\n\n      <ItemsList items={changeSet.items} />\n\n      <DependencyGraph items={changeSet.items} />\n\n      {changeSet.validation?.errors && (\n        <ErrorBanner errors={changeSet.validation.errors} />\n      )}\n    </div>\n  );\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-xstate-machine",children:"Integration with XState Machine"}),"\n",(0,s.jsxs)(n.p,{children:["The change set store is the ",(0,s.jsx)(n.strong,{children:"data layer"}),"; ",(0,s.jsx)(n.code,{children:"changeSetMachine"})," (XState) is the ",(0,s.jsx)(n.strong,{children:"orchestration layer"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Change Set Store     \u2502 \u2190 Manages data, status, items\n\u2502 (Zustand)            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502 mutates\n           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Change Set Machine   \u2502 \u2190 Orchestrates apply flow\n\u2502 (XState)             \u2502   Transitions states\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502 calls\n           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 GraphQL API          \u2502 \u2190 Applies changes to router\n\u2502 (Apollo Client)      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.code,{children:"changeSetMachine"})," documentation (Agent 4) for complete orchestration details."]}),"\n",(0,s.jsx)(n.h2,{id:"conflict-detection",children:"Conflict Detection"}),"\n",(0,s.jsx)(n.p,{children:"Before applying, check for conflicts:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Application code\nfunction validateChangeSet(changeSet: ChangeSet) {\n  const errors: string[] = [];\n\n  // Cycle detection\n  const hasCycle = detectDependencyCycle(changeSet.items);\n  if (hasCycle) {\n    errors.push('Circular dependencies detected');\n  }\n\n  // Resource conflicts\n  const conflicts = findResourceConflicts(changeSet.items);\n  if (conflicts.length > 0) {\n    errors.push(`Resource conflicts: ${conflicts.join(', ')}`);\n  }\n\n  // Validation errors from backend\n  const validation = await validateWithBackend(changeSet);\n  if (!validation.isValid) {\n    errors.push(...validation.errors);\n  }\n\n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings: validation.warnings,\n  };\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Always Set Dependencies"}),": Don't rely on apply order; explicit dependencies make intent clear"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Batch Related Changes"}),": Group logically related operations in one change set"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Test Before Apply"}),": Validate with backend before marking READY"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Display Dependency Graph"}),": Show users the execution order"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Handle Partial Failures"}),": Plan rollback for each item"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use Meaningful Names"}),": Help users understand what each change set does"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Clear Completed"}),": Don't accumulate old change sets; archive or delete"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Atomic Operations"}),": Don't break large operations into multiple change sets if they should be all-or-nothing"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Document Rollback Plan"}),": Include steps to recover if apply fails"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Change Set Machine"}),": (Agent 4 documentation) - XState orchestration of apply flow"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Undo/Redo Integration"}),": ",(0,s.jsx)(n.code,{children:"history-undo-redo.md"})," - Change sets as history entries"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Drift Detection"}),": ",(0,s.jsx)(n.code,{children:"drift-detection.md"})," - Monitor after apply"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Apply-Confirm-Merge"}),": ",(0,s.jsx)(n.code,{children:"../../architecture/data-architecture.md#state-flow-apply--confirm--merge"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Data Architecture"}),": ",(0,s.jsx)(n.code,{children:"../../architecture/data-architecture.md"})," - 8-layer model context"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>d});var r=t(14041);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);