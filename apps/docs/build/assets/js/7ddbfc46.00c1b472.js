"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[70199],{49779:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"data-layer","title":"Data Layer","description":"Hybrid SQLite architecture with a single system database, lazy-loaded per-router databases, the \\"Light Repository\\" pattern, and ent ORM as the query layer.","source":"@site/../backend/docs/data-layer.md","sourceDirName":".","slug":"/data-layer","permalink":"/docs/backend/data-layer","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/data-layer.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Connection Management","permalink":"/docs/backend/connection-management"},"next":{"title":"Error Handling & Structured Logging","permalink":"/docs/backend/error-handling"}}');var s=r(31085),i=r(71184);const c={},d="Data Layer",o={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/database</code>",id:"internaldatabase",level:3},{value:"<code>manager.go</code> \u2014 <code>Manager</code>",id:"managergo--manager",level:4},{value:"<code>config.go</code> \u2014 <code>Config</code> and <code>OpenDatabase</code>",id:"configgo--config-and-opendatabase",level:4},{value:"<code>backup.go</code> \u2014 Backup and Restore",id:"backupgo--backup-and-restore",level:4},{value:"<code>internal/repository</code>",id:"internalrepository",level:3},{value:"<code>repository.go</code> \u2014 Interfaces and Shared Types",id:"repositorygo--interfaces-and-shared-types",level:4},{value:"<code>router_repository.go</code> \u2014 <code>routerRepository</code>",id:"router_repositorygo--routerrepository",level:4},{value:"<code>cleanup_queue.go</code> \u2014 <code>CleanupQueue</code>",id:"cleanup_queuego--cleanupqueue",level:4},{value:"<code>internal/adapters</code> (ent repositories)",id:"internaladapters-ent-repositories",level:3},{value:"<code>generated/ent</code> \u2014 ent ORM Output",id:"generatedent--ent-orm-output",level:3},{value:"<code>internal/ent-schema/schema</code> \u2014 Schema Definitions",id:"internalent-schemaschema--schema-definitions",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Startup (System DB)",id:"startup-system-db",level:3},{value:"Router DB Access (Lazy-Load)",id:"router-db-access-lazy-load",level:3},{value:"Router Deletion (Eventual Consistency)",id:"router-deletion-eventual-consistency",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"data-layer",children:"Data Layer"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:'Hybrid SQLite architecture with a single system database, lazy-loaded per-router databases, the "Light Repository" pattern, and ent ORM as the query layer.'}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Packages:"})," ",(0,s.jsx)(n.code,{children:"internal/database/"}),", ",(0,s.jsx)(n.code,{children:"internal/repository/"}),", ",(0,s.jsx)(n.code,{children:"internal/adapters/"})," (ent repos), ",(0,s.jsx)(n.code,{children:"generated/ent/"}),", ",(0,s.jsx)(n.code,{children:"internal/ent-schema/schema/"}),"\n",(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"database/manager.go"}),", ",(0,s.jsx)(n.code,{children:"database/backup.go"}),", ",(0,s.jsx)(n.code,{children:"database/config.go"}),", ",(0,s.jsx)(n.code,{children:"repository/repository.go"}),", ",(0,s.jsx)(n.code,{children:"repository/router_repository.go"}),", ",(0,s.jsx)(n.code,{children:"repository/cleanup_queue.go"}),"\n",(0,s.jsx)(n.strong,{children:"Prerequisites:"})," [See: application-bootstrap.md \xa7Database Initialization]"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["NasNetConnect uses a ",(0,s.jsx)(n.strong,{children:"hybrid SQLite architecture"})," optimized for the single-container deployment model. Rather than one monolithic database, data is split into:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"system.db"})})," \u2014 always open; stores fleet metadata (routers, users, settings, events)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"router-{id}.db"})})," \u2014 lazy-loaded; stores per-router operational data (resources, configurations)"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This design allows the system to serve many routers without holding open file handles for idle connections, while keeping the system database always consistent."}),"\n",(0,s.jsx)(n.p,{children:"The data layer is built on three foundations:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"internal/database"})})," \u2014 manages file lifecycle, WAL mode, integrity checks, and backup/restore"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"internal/repository"})}),' \u2014 business logic over complex entities using the "Light Repository" pattern']}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"generated/ent"})})," \u2014 type-safe query builder generated from ",(0,s.jsx)(n.code,{children:"internal/ent-schema/schema/"})]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Application Layer                        \u2502\n\u2502        (Graph Resolvers, Services, Bootstrap)                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                \u2502                     \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502  Repositories       \u2502  \u2502  Direct ent Client  \u2502\n     \u2502  (complex entities) \u2502  \u2502  (simple entities)  \u2502\n     \u2502  Router, User,      \u2502  \u2502  Resource, Event,   \u2502\n     \u2502  Feature            \u2502  \u2502  Setting, Session   \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                \u2502                     \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502              database.Manager                \u2502\n     \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n     \u2502  \u2502   system.db      \u2502  \u2502  router-{id}.db  \u2502  \u2502\n     \u2502  \u2502  (always open)   \u2502  \u2502  (lazy-loaded)   \u2502  \u2502\n     \u2502  \u2502  ent.Client      \u2502  \u2502  ent.Client      \u2502  \u2502\n     \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n     \u2502          SQLite WAL + PRAGMA settings          \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,s.jsx)(n.h3,{id:"internaldatabase",children:(0,s.jsx)(n.code,{children:"internal/database"})}),"\n",(0,s.jsx)(n.p,{children:"Manages the lifecycle of SQLite database files. There are no business entities here \u2014 only connection management, PRAGMA configuration, integrity checks, and backup operations."}),"\n",(0,s.jsxs)(n.h4,{id:"managergo--manager",children:[(0,s.jsx)(n.code,{children:"manager.go"})," \u2014 ",(0,s.jsx)(n.code,{children:"Manager"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Manager struct {\n    systemClient *ent.Client         // always open\n    systemDB     *sql.DB\n    routerDBs    map[string]*routerDBEntry  // lazy-loaded per router\n    mu           sync.RWMutex\n    dataDir      string\n    idleTimeout  time.Duration       // default: 5 minutes\n    closed       bool\n    closeMu      sync.RWMutex\n}\n\ntype routerDBEntry struct {\n    client   *ent.Client\n    db       *sql.DB\n    timer    *time.Timer   // resets idle timeout on each access\n    lastUsed time.Time\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key functions:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NewManager(ctx, ...ManagerOption)"})}),(0,s.jsxs)(n.td,{children:["Opens ",(0,s.jsx)(n.code,{children:"system.db"}),", runs migrations, returns configured Manager"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"SystemDB()"})}),(0,s.jsx)(n.td,{children:"Returns always-open system ent client"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GetRouterDB(ctx, routerID)"})}),(0,s.jsx)(n.td,{children:"Fast-path read lock check; slow-path write lock with double-checked locking to open and cache router DB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ForceCloseRouterDB(routerID)"})}),(0,s.jsx)(n.td,{children:"Immediately closes a router DB (for maintenance)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DeleteRouterDB(routerID)"})}),(0,s.jsxs)(n.td,{children:["Closes + deletes ",(0,s.jsx)(n.code,{children:".db"}),", ",(0,s.jsx)(n.code,{children:"-wal"}),", and ",(0,s.jsx)(n.code,{children:"-shm"})," files"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"IsRouterDBLoaded(routerID)"})}),(0,s.jsx)(n.td,{children:"Reports whether a router DB is currently cached"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"LoadedRouterCount()"})}),(0,s.jsx)(n.td,{children:"Returns number of open router DBs"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Close()"})}),(0,s.jsx)(n.td,{children:"Closes all router DBs (stops timers, flushes ent clients, closes sql.DB) then closes system DB"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Idle timeout pattern:"})}),"\n",(0,s.jsxs)(n.p,{children:["Every call to ",(0,s.jsx)(n.code,{children:"GetRouterDB"})," resets a ",(0,s.jsx)(n.code,{children:"time.Timer"})," via ",(0,s.jsx)(n.code,{children:"touchActivity"}),". When the timer fires, ",(0,s.jsx)(n.code,{children:"closeRouterDB"})," acquires the write lock, stops the timer, closes the ent client, closes ",(0,s.jsx)(n.code,{children:"sql.DB"}),", and removes the entry from the map."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"PRAGMA configuration (applied to every database):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"PRAGMA journal_mode=WAL          -- Enable Write-Ahead Logging\nPRAGMA synchronous=NORMAL        -- Balance durability vs. speed\nPRAGMA cache_size=-64000         -- 64MB cache (system), -32000 for routers\nPRAGMA busy_timeout=5000         -- 5s retry before BUSY error\nPRAGMA foreign_keys=ON           -- Enforce FK constraints\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Constants:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'DefaultIdleTimeout = 5 * time.Minute\nDefaultDataDir     = "/var/nasnet"\nSystemDBFile       = "system.db"\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Options:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"WithIdleTimeout(d time.Duration) ManagerOption\nWithDataDir(dir string)          ManagerOption\n"})}),"\n",(0,s.jsxs)(n.h4,{id:"configgo--config-and-opendatabase",children:[(0,s.jsx)(n.code,{children:"config.go"})," \u2014 ",(0,s.jsx)(n.code,{children:"Config"})," and ",(0,s.jsx)(n.code,{children:"OpenDatabase"})]}),"\n",(0,s.jsxs)(n.p,{children:["Provides ",(0,s.jsx)(n.code,{children:"DefaultConfig(path)"})," returning a ",(0,s.jsx)(n.code,{children:"Config"})," struct with all default PRAGMA values, and ",(0,s.jsx)(n.code,{children:"OpenDatabase(ctx, cfg)"})," which:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Opens the SQLite file with ",(0,s.jsx)(n.code,{children:"modernc.org/sqlite"})," (pure Go, no CGO)"]}),"\n",(0,s.jsxs)(n.li,{children:["Sets ",(0,s.jsx)(n.code,{children:"MaxOpenConns=1"})," (SQLite single-writer constraint)"]}),"\n",(0,s.jsxs)(n.li,{children:["Applies PRAGMAs via ",(0,s.jsx)(n.code,{children:"applyPRAGMAs"})]}),"\n",(0,s.jsxs)(n.li,{children:["Runs ",(0,s.jsx)(n.code,{children:"PRAGMA quick_check"}),"; falls back to ",(0,s.jsx)(n.code,{children:"PRAGMA integrity_check"})," on failure"]}),"\n",(0,s.jsxs)(n.li,{children:["Enforces file permissions ",(0,s.jsx)(n.code,{children:"0o600"})," via ",(0,s.jsx)(n.code,{children:"ensureSecurePermissions"})]}),"\n",(0,s.jsxs)(n.li,{children:["Returns ",(0,s.jsx)(n.code,{children:"OpenResult{DB, StartupDuration, IntegrityCheckPassed, JournalMode}"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type Config struct {\n    Path               string\n    JournalMode        string  // default: "WAL"\n    Synchronous        string  // default: "NORMAL"\n    CacheSize          int     // default: -64000 (64MB)\n    BusyTimeout        int     // default: 5000ms\n    ForeignKeys        bool    // default: true\n    SkipIntegrityCheck bool    // default: false (testing only)\n}\n'})}),"\n",(0,s.jsxs)(n.h4,{id:"backupgo--backup-and-restore",children:[(0,s.jsx)(n.code,{children:"backup.go"})," \u2014 Backup and Restore"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"BackupDatabase(ctx, db, sourcePath, backupDir)"})})}),"\n",(0,s.jsxs)(n.p,{children:["Primary strategy: ",(0,s.jsx)(n.code,{children:"VACUUM INTO '{backupPath}'"})," \u2014 creates a consistent snapshot of the live database without locking it for readers."]}),"\n",(0,s.jsxs)(n.p,{children:["Fallback strategy (if VACUUM INTO fails): ",(0,s.jsx)(n.code,{children:"PRAGMA wal_checkpoint(TRUNCATE)"})," followed by ",(0,s.jsx)(n.code,{children:"atomicCopyFile"})," (temp file + rename)."]}),"\n",(0,s.jsxs)(n.p,{children:["Naming: ",(0,s.jsx)(n.code,{children:"{name}.{timestamp}.db.bak"})," where timestamp includes nanoseconds for uniqueness."]}),"\n",(0,s.jsxs)(n.p,{children:["Rotation: After backup, calls ",(0,s.jsx)(n.code,{children:"cleanupOldBackups"})," keeping at most ",(0,s.jsx)(n.code,{children:"MaxBackupCount = 3"})," files (sorted by mtime)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type BackupResult struct {\n    SourcePath string\n    BackupPath string\n    Size       int64\n    Duration   time.Duration\n    Timestamp  time.Time\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"RestoreDatabase(ctx, backupPath, targetPath)"})})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Creates a pre-restore safety backup at ",(0,s.jsx)(n.code,{children:"{targetPath}.pre-restore.bak"})]}),"\n",(0,s.jsxs)(n.li,{children:["Calls ",(0,s.jsx)(n.code,{children:"atomicCopyFile(backupPath, targetPath)"})]}),"\n",(0,s.jsxs)(n.li,{children:["Removes ",(0,s.jsx)(n.code,{children:"-wal"})," and ",(0,s.jsx)(n.code,{children:"-shm"})," sidecar files to force a fresh WAL start"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"atomicCopyFile(src, dst)"})})}),"\n",(0,s.jsxs)(n.p,{children:["Writes to a temp file in the same directory as ",(0,s.jsx)(n.code,{children:"dst"})," (same filesystem \u2192 rename is atomic), syncs to disk, then ",(0,s.jsx)(n.code,{children:"os.Rename"}),". Permissions set to ",(0,s.jsx)(n.code,{children:"0o600"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Other helpers:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"ListBackups(backupDir, baseName string) ([]BackupResult, error)\nGetLatestBackup(backupDir, baseName string) (*BackupResult, error)\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"internalrepository",children:(0,s.jsx)(n.code,{children:"internal/repository"})}),"\n",(0,s.jsxs)(n.p,{children:["Implements the ",(0,s.jsx)(n.strong,{children:"Light Repository Pattern"}),": repositories are created only for entities that require business logic, optimized queries with eager loading, or explicit transaction boundaries."]}),"\n",(0,s.jsxs)(n.h4,{id:"repositorygo--interfaces-and-shared-types",children:[(0,s.jsx)(n.code,{children:"repository.go"})," \u2014 Interfaces and Shared Types"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Container for all repositories (passed via dependency injection)\ntype Repositories struct {\n    Router  RouterRepository\n    User    UserRepository\n    Feature FeatureRepository\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Rule: Use Repository For:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Router"})," \u2014 complex relationships (secrets), connection state, event publishing"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"User"})," \u2014 password hashing, bcrypt, session management"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Feature"})," \u2014 lifecycle management, dependency graph traversal"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Rule: Use Direct ent Client For:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Resource"}),", ",(0,s.jsx)(n.code,{children:"Event"}),", ",(0,s.jsx)(n.code,{children:"Setting"}),", ",(0,s.jsx)(n.code,{children:"Session"}),", ",(0,s.jsx)(n.code,{children:"APIKey"})," \u2014 simple CRUD, no business logic"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.code,{children:"RouterRepository"})," interface:"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type RouterRepository interface {\n    GetWithRelations(ctx context.Context, id ulid.ULID) (*ent.Router, error)\n    GetByHost(ctx context.Context, host string, port int) (*ent.Router, error)\n    CreateWithSecrets(ctx context.Context, input CreateRouterInput) (*ent.Router, error)\n    UpdateStatus(ctx context.Context, id ulid.ULID, status RouterStatus) error\n    ListWithCapabilities(ctx context.Context, filter RouterFilter) ([]*ent.Router, error)\n    Delete(ctx context.Context, id ulid.ULID) error\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.strong,{children:[(0,s.jsx)(n.code,{children:"UserRepository"})," interface:"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type UserRepository interface {\n    Create(ctx context.Context, input CreateUserInput) (*ent.User, error)\n    GetByUsername(ctx context.Context, username string) (*ent.User, error)\n    GetByID(ctx context.Context, id ulid.ULID) (*ent.User, error)\n    GetWithSessions(ctx context.Context, id ulid.ULID) (*ent.User, error)\n    UpdatePassword(ctx context.Context, id ulid.ULID, newPassword string) error\n    VerifyPassword(ctx context.Context, id ulid.ULID, password string) error\n    UpdateLastLogin(ctx context.Context, id ulid.ULID) error\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Audit context:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type AuditContext struct {\n    UserID    ulid.ULID\n    Username  string\n    IPAddress string\n    RequestID string\n    Timestamp time.Time\n}\n\nfunc WithAuditContext(ctx context.Context, audit AuditContext) context.Context\nfunc GetAuditContext(ctx context.Context) *AuditContext\n"})}),"\n",(0,s.jsxs)(n.h4,{id:"router_repositorygo--routerrepository",children:[(0,s.jsx)(n.code,{children:"router_repository.go"})," \u2014 ",(0,s.jsx)(n.code,{children:"routerRepository"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type routerRepository struct {\n    systemDB     *ent.Client\n    dbManager    *database.Manager\n    eventBus     events.EventBus\n    cleanupQueue *CleanupQueue\n    logger       *zap.Logger\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"GetWithRelations"})})," \u2014 eager-loads secrets in one query (no N+1):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"result, err := r.systemDB.Router.\n    Query().\n    Where(router.ID(id.String())).\n    WithSecrets().   // Eager load credentials\n    Only(ctx)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"CreateWithSecrets"})})," \u2014 2-query transaction:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"result, txErr := WithTxResult(ctx, r.systemDB, func(tx *ent.Tx) (*ent.Router, error) {\n    // INSERT INTO routers...\n    newRouter, _ := tx.Router.Create()...Save(ctx)\n    // INSERT INTO router_secrets...\n    _, _ = tx.RouterSecret.Create()...Save(ctx)\n    return newRouter, nil\n})\n// Publish RouterConnectedEvent (after commit)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"Delete"})})," \u2014 two-phase cleanup pattern:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Phase 1: Atomic deletion from system.db\nWithTx(ctx, r.systemDB, func(tx *ent.Tx) error {\n    // DELETE FROM router_secrets WHERE router_id = ?\n    // DELETE FROM routers WHERE id = ?\n})\n// Phase 2: Eventual router-{id}.db cleanup\nr.cleanupQueue.Enqueue(CleanupTask{Type: CleanupRouterDB, RouterID: id.String()})\n// Phase 3: Publish RouterDisconnectedEvent\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"UpdateStatus"})})," \u2014 publishes ",(0,s.jsx)(n.code,{children:"RouterStatusChangedEvent"})," after every status change."]}),"\n",(0,s.jsxs)(n.h4,{id:"cleanup_queuego--cleanupqueue",children:[(0,s.jsx)(n.code,{children:"cleanup_queue.go"})," \u2014 ",(0,s.jsx)(n.code,{children:"CleanupQueue"})]}),"\n",(0,s.jsx)(n.p,{children:"Implements eventual consistency for cross-database operations where SQLite cannot support distributed transactions."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type CleanupQueue struct {\n    tasks         []CleanupTask\n    dbManager     *database.Manager\n    maxRetries    int           // default: 5\n    retryInterval time.Duration // default: 30s\n    ticker        *time.Ticker  // processInterval: 10s\n    done          chan struct{}\n    wg            sync.WaitGroup\n    mu            sync.Mutex\n}\n\ntype CleanupTask struct {\n    Type       CleanupType // "router_db"\n    RouterID   string\n    EnqueuedAt time.Time\n    RetryCount int\n    LastError  error\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Lifecycle:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Start(ctx)"})," \u2014 spawns background goroutine, fires every ",(0,s.jsx)(n.code,{children:"processInterval"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"processTasks"})," \u2014 snapshots queue under lock, executes each task, re-queues failures"]}),"\n",(0,s.jsxs)(n.li,{children:["Tasks exceeding ",(0,s.jsx)(n.code,{children:"maxRetries"})," are logged at ERROR level and discarded"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Stop()"})," \u2014 closes done channel, stops ticker, waits for goroutine"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internaladapters-ent-repositories",children:[(0,s.jsx)(n.code,{children:"internal/adapters"})," (ent repositories)"]}),"\n",(0,s.jsx)(n.p,{children:"Thin adapter structs that wrap ent queries behind domain-specific interfaces."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"ent_service_instance_repo.go"})})," \u2014 wraps ",(0,s.jsx)(n.code,{children:"ent.ServiceInstanceQuery"})," behind a ",(0,s.jsx)(n.code,{children:"network.ServiceInstanceQuery"})," interface. No business logic; purely a translation layer to keep the domain package decoupled from ent."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"ent_port_allocation_repo.go"})})," \u2014 similarly wraps port allocation queries."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"ent_vlan_allocation_repo.go"})})," \u2014 wraps VLAN allocation queries."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"ent_global_settings_repo.go"})})," \u2014 wraps global settings read/write."]}),"\n",(0,s.jsxs)(n.p,{children:["All adapters follow the same pattern: implement a domain interface, delegate to the injected ",(0,s.jsx)(n.code,{children:"*ent.Client"}),", return domain types (or wrapped ent types)."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"generatedent--ent-orm-output",children:[(0,s.jsx)(n.code,{children:"generated/ent"})," \u2014 ent ORM Output"]}),"\n",(0,s.jsxs)(n.p,{children:["Generated by ",(0,s.jsx)(n.code,{children:"go generate ./internal/ent-schema/..."})," (via ",(0,s.jsx)(n.code,{children:"entc"}),"). ",(0,s.jsx)(n.strong,{children:"Never edit manually."})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key generated files:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"client.go"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"ent.Client"})," with typed sub-clients per entity"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"migrate/schema.go"})}),(0,s.jsx)(n.td,{children:"Auto-migration DDL definitions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"mutation.go"})}),(0,s.jsx)(n.td,{children:"Generated mutation builders"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"runtime.go"})}),(0,s.jsx)(n.td,{children:"Runtime hooks (validators, interceptors)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"router.go"}),", ",(0,s.jsx)(n.code,{children:"user.go"}),", etc."]}),(0,s.jsx)(n.td,{children:"Entity structs with typed fields"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"router/router.go"})}),(0,s.jsx)(n.td,{children:"Field/edge constants and predicate builders"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"router_query.go"})}),(0,s.jsx)(n.td,{children:"Fluent query API for Router entity"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Using the ent client directly (simple entities):"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// List resources without repository\nresources, err := db.Resource.\n    Query().\n    Where(resource.RouterID(routerID)).\n    Limit(50).\n    All(ctx)\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"internalent-schemaschema--schema-definitions",children:[(0,s.jsx)(n.code,{children:"internal/ent-schema/schema"})," \u2014 Schema Definitions"]}),"\n",(0,s.jsx)(n.p,{children:"Input to ent code generation. Each file defines entity fields, edges (relations), and validators."}),"\n",(0,s.jsx)(n.p,{children:"Files (examples):"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"router.go"})," \u2014 Router entity with Host, Port, Platform, Status, Version, Model fields; edge to RouterSecret"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"user.go"})," \u2014 User entity with Username, Email, PasswordHash fields; edge to Session"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"virtualinterface.go"})," \u2014 VirtualInterface entity for the VIF system"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"globalSettings.go"})," \u2014 global key/value settings entity"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"To add a new field or entity:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Edit or add a schema file in ",(0,s.jsx)(n.code,{children:"internal/ent-schema/schema/"})]}),"\n",(0,s.jsxs)(n.li,{children:["Run ",(0,s.jsx)(n.code,{children:"npm run codegen:ent"})," to regenerate ",(0,s.jsx)(n.code,{children:"generated/ent/"})]}),"\n",(0,s.jsxs)(n.li,{children:["The next application start automatically runs ",(0,s.jsx)(n.code,{children:"client.Schema.Create(ctx)"})," (auto-migration)"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,s.jsx)(n.h3,{id:"startup-system-db",children:"Startup (System DB)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'main() \u2192 database.NewManager(ctx)\n       \u2192 os.MkdirAll("/var/nasnet")\n       \u2192 sql.Open("sqlite", "file:/var/nasnet/system.db?_time_format=sqlite")\n       \u2192 db.SetMaxOpenConns(1) + apply PRAGMAs\n       \u2192 PRAGMA quick_check \u2192 "ok"\n       \u2192 ent.NewClient(ent.Driver(drv))\n       \u2192 client.Schema.Create(ctx)   \u2190 auto-migration\n       \u2192 Manager.systemClient = client\n'})}),"\n",(0,s.jsx)(n.h3,{id:"router-db-access-lazy-load",children:"Router DB Access (Lazy-Load)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"resolver \u2192 repos.Router.GetWithRelations(ctx, id)\n         \u2192 routerRepository.GetWithRelations\n         \u2192 systemDB.Router.Query().WithSecrets().Only(ctx)\n\n# If resolver also needs router DB (resources, etc.)\nresolver \u2192 dbManager.GetRouterDB(ctx, routerID)\n         \u2192 [Fast path] RLock \u2192 entry found \u2192 touchActivity \u2192 return client\n         \u2192 [Slow path] WLock \u2192 double-check \u2192 openRouterDB(path, routerID)\n             \u2192 sql.Open + PRAGMAs + quick_check + Schema.Create\n             \u2192 time.AfterFunc(5m, closeRouterDB)\n         \u2192 return client\n"})}),"\n",(0,s.jsx)(n.h3,{id:"router-deletion-eventual-consistency",children:"Router Deletion (Eventual Consistency)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'mutation \u2192 repos.Router.Delete(ctx, id)\n         \u2192 WithTx(systemDB):\n             DELETE router_secrets WHERE router_id = id\n             DELETE routers WHERE id = id\n         \u2192 cleanupQueue.Enqueue({Type: CleanupRouterDB, RouterID: id})\n         \u2192 eventBus.Publish(RouterDisconnectedEvent)\n\n# Background (10s tick):\ncleanupQueue.processTasks()\n  \u2192 dbManager.DeleteRouterDB(routerID)\n      \u2192 ForceCloseRouterDB (stop timer + close client + close db)\n      \u2192 os.Remove("router-{id}.db")\n      \u2192 os.Remove("router-{id}.db-wal")\n      \u2192 os.Remove("router-{id}.db-shm")\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Setting"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Override"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Data directory"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/var/nasnet"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithDataDir(dir)"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Idle timeout"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"5 minutes"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithIdleTimeout(d)"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Max router DB connections"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"1"})}),(0,s.jsx)(n.td,{children:"Hardcoded (SQLite constraint)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Cache size (system DB)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"64MB"})}),(0,s.jsxs)(n.td,{children:["Hardcoded in ",(0,s.jsx)(n.code,{children:"openSystemDB"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Cache size (router DB)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"32MB"})}),(0,s.jsxs)(n.td,{children:["Hardcoded in ",(0,s.jsx)(n.code,{children:"openRouterDB"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Busy timeout"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"5000ms"})}),(0,s.jsxs)(n.td,{children:["Hardcoded in ",(0,s.jsx)(n.code,{children:"Config"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Max backup count"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"3"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"MaxBackupCount"})," constant"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Cleanup queue max retries"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"5"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DefaultCleanupQueueConfig"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Cleanup process interval"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"10s"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DefaultCleanupQueueConfig"})})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"internal/database"})," package defines typed database errors with context:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// ErrCodeDBConnectionFailed  \u2014 connection or PRAGMA failed\n// ErrCodeDBIntegrityFailed   \u2014 quick_check or integrity_check returned non-ok\n// ErrCodeDBMigrationFailed   \u2014 Schema.Create failed\n// ErrCodeDBBackupFailed      \u2014 VACUUM INTO or checkpoint+copy failed\n// ErrCodeDBRestoreFailed     \u2014 atomicCopyFile for restore failed\n// ErrCodeDBClosed            \u2014 operation on closed Manager\n\n// Errors carry structured context:\nNewError(code, message, cause).WithPath(path).WithRouterID(id).WithContext("key", val)\n'})}),"\n",(0,s.jsx)(n.p,{children:"Repository errors:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// errors.Is-compatible sentinel errors from internal/repository:\n// NotFound("Router", id)               \u2192 ErrNotFound\n// Duplicate("Router", "host:port", v)  \u2192 ErrDuplicate\n// InvalidInput(...)                    \u2192 ErrInvalidInput\n// ErrInvalidCredentials                \u2192 password mismatch\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Integrity check degradation:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"system.db"})," integrity failure \u2192 fatal, Manager construction returns error"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"router-{id}.db"})," integrity failure \u2192 graceful degradation (connection continues, router marked degraded in system.db)"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Database tests use ",(0,s.jsx)(n.code,{children:"SkipIntegrityCheck: true"})," in ",(0,s.jsx)(n.code,{children:"Config"})," for faster open"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Manager"})," can be created with ",(0,s.jsx)(n.code,{children:"WithDataDir(t.TempDir())"})," for test isolation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"CleanupQueue.ProcessNow(ctx)"})," forces immediate processing (no ticker wait)"]}),"\n",(0,s.jsxs)(n.li,{children:["Repository tests inject ",(0,s.jsx)(n.code,{children:"*ent.Client"})," opened against ",(0,s.jsx)(n.code,{children:":memory:"})," SQLite"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["[See: 02-application-bootstrap.md \xa7Database Initialization] \u2014 how ",(0,s.jsx)(n.code,{children:"Manager"})," is wired at startup"]}),"\n",(0,s.jsxs)(n.li,{children:["[See: 04-router-communication.md \xa7FallbackChain] \u2014 router connection state written via ",(0,s.jsx)(n.code,{children:"UpdateStatus"})]}),"\n",(0,s.jsx)(n.li,{children:"[See: 05-event-system.md \xa7RouterStatusChangedEvent] \u2014 events published by repository mutations"}),"\n",(0,s.jsxs)(n.li,{children:["Architecture ADR: ",(0,s.jsx)(n.code,{children:"Docs/architecture/adrs/014-sqlite-database-architecture.md"})]}),"\n",(0,s.jsxs)(n.li,{children:["Pattern reference: ",(0,s.jsx)(n.code,{children:"Docs/architecture/implementation-patterns/15-database-architecture-patterns.md"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},71184:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>d});var t=r(14041);const s={},i=t.createContext(s);function c(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);