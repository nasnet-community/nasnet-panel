"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[90748],{71184:(e,n,t)=>{t.d(n,{R:()=>d,x:()=>c});var s=t(14041);const r={},i=s.createContext(r);function d(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(i.Provider,{value:n},e.children)}},87447:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"persistence","title":"Persistence","description":"This document maps all localStorage keys used by @nasnet/state stores and machines, custom","source":"@site/../../libs/state/docs/persistence.md","sourceDirName":".","slug":"/persistence","permalink":"/docs/state/persistence","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/persistence.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Persistence"},"sidebar":"sidebar","previous":{"title":"Architecture","permalink":"/docs/state/architecture"},"next":{"title":"Performance","permalink":"/docs/state/performance"}}');var r=t(31085),i=t(71184);const d={sidebar_position:3,title:"Persistence"},c="Storage & Persistence",l={},o=[{value:"localStorage Keys Reference",id:"localstorage-keys-reference",level:2},{value:"Custom Storage Handlers",id:"custom-storage-handlers",level:2},{value:"Auth Store: Date Object Rehydration",id:"auth-store-date-object-rehydration",level:3},{value:"History Store: Function Serialization (No-op on Rehydration)",id:"history-store-function-serialization-no-op-on-rehydration",level:3},{value:"Command Registry: Map Serialization",id:"command-registry-map-serialization",level:3},{value:"Hydration/Rehydration Lifecycle",id:"hydrationrehydration-lifecycle",level:2},{value:"Initial Load (App Startup)",id:"initial-load-app-startup",level:3},{value:"During User Session",id:"during-user-session",level:3},{value:"Browser Close \u2192 Reopen",id:"browser-close--reopen",level:3},{value:"Example: Theme Store Rehydration",id:"example-theme-store-rehydration",level:3},{value:"Machine Persistence: Session Recovery",id:"machine-persistence-session-recovery",level:2},{value:"localStorage Key Format for Machines",id:"localstorage-key-format-for-machines",level:3},{value:"Storage Quota &amp; Limits",id:"storage-quota--limits",level:2},{value:"Browser localStorage Limits",id:"browser-localstorage-limits",level:3},{value:"What Happens if Quota Exceeded",id:"what-happens-if-quota-exceeded",level:3},{value:"Privacy &amp; Security",id:"privacy--security",level:2},{value:"What&#39;s Stored",id:"whats-stored",level:3},{value:"Best Practices",id:"best-practices",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"storage--persistence",children:"Storage & Persistence"})}),"\n",(0,r.jsxs)(n.p,{children:["This document maps ",(0,r.jsx)(n.strong,{children:"all localStorage keys"})," used by ",(0,r.jsx)(n.code,{children:"@nasnet/state"})," stores and machines, custom\nserialization handlers, and hydration/rehydration lifecycle."]}),"\n",(0,r.jsx)(n.h2,{id:"localstorage-keys-reference",children:"localStorage Keys Reference"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"localStorage Key"}),(0,r.jsx)(n.th,{children:"Store"}),(0,r.jsx)(n.th,{children:"Persisted Data"}),(0,r.jsx)(n.th,{children:"Max Size"}),(0,r.jsx)(n.th,{children:"Lifetime"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-theme"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useThemeStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"theme: 'light' | 'dark' | 'system'"})}),(0,r.jsx)(n.td,{children:"~20 bytes"}),(0,r.jsx)(n.td,{children:"Until user changes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-sidebar"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useSidebarStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"desktopCollapsed: boolean"})}),(0,r.jsx)(n.td,{children:"~20 bytes"}),(0,r.jsx)(n.td,{children:"Until user changes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"compactMode, animationsEnabled, activeTab, defaultNotificationDuration"})}),(0,r.jsx)(n.td,{children:"~100 bytes"}),(0,r.jsx)(n.td,{children:"Until user changes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-modal"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useModalStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"activeModal: string | null, modalData: Record<string, unknown>"})}),(0,r.jsx)(n.td,{children:"~500 bytes"}),(0,r.jsx)(n.td,{children:"Until user closes modal"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-notification"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useNotificationStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"notifications: Notification[]"})}),(0,r.jsx)(n.td,{children:"~5KB (max 50 notifications)"}),(0,r.jsx)(n.td,{children:"Auto-expire by duration"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-help-mode"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useHelpModeStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"mode: 'simple' | 'technical'"})}),(0,r.jsx)(n.td,{children:"~20 bytes"}),(0,r.jsx)(n.td,{children:"Until user changes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"auth-storage"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useAuthStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"token, tokenExpiry, refreshToken, user, isAuthenticated"})}),(0,r.jsx)(n.td,{children:"~2KB"}),(0,r.jsx)(n.td,{children:"Until logout or expiry"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-connection"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useConnectionStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"routerId, isConnected, lastPing"})}),(0,r.jsx)(n.td,{children:"~100 bytes"}),(0,r.jsx)(n.td,{children:"Until disconnect"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-network"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useNetworkStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"isOnline: boolean"})}),(0,r.jsx)(n.td,{children:"~10 bytes"}),(0,r.jsx)(n.td,{children:"Real-time"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-router"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useRouterStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"selectedRouterId, recentRouters[]"})}),(0,r.jsx)(n.td,{children:"~500 bytes"}),(0,r.jsx)(n.td,{children:"Until user clears"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-dhcp-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useDHCPUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"selectedPool, filters, search, wizardDraft"})}),(0,r.jsx)(n.td,{children:"~1KB"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-service-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useServiceUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"filters, search, selection, installWizardDraft"})}),(0,r.jsx)(n.td,{children:"~1KB"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-mangle-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useMangleUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"selectedChain, expandedRules, filters"})}),(0,r.jsx)(n.td,{children:"~500 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-nat-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useNATUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"selectedChain, expandedRules, filters"})}),(0,r.jsx)(n.td,{children:"~500 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-raw-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useRawUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"selectedChain, filters, expandedSection"})}),(0,r.jsx)(n.td,{children:"~300 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-port-knock-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"usePortKnockUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"activeTab, filters, selectedRule"})}),(0,r.jsx)(n.td,{children:"~300 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-rate-limiting-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useRateLimitingUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"activeTab, filters, ruleEditorOpen"})}),(0,r.jsx)(n.td,{children:"~300 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-firewall-log-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useFirewallLogUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"filters, autoRefresh, sortBy, selectedLogId"})}),(0,r.jsx)(n.td,{children:"~500 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-alert-notification"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useAlertNotificationStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"alerts: Alert[]"})}),(0,r.jsx)(n.td,{children:"~2KB"}),(0,r.jsx)(n.td,{children:"Persisted across sessions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-alert-rule-template-ui"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useAlertRuleTemplateUIStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"filters, viewMode, selectedTemplateId, dialogs"})}),(0,r.jsx)(n.td,{children:"~500 bytes"}),(0,r.jsx)(n.td,{children:"Until navigation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-interface-stats"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useInterfaceStatsStore"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"selectedInterfaces, refreshInterval"})}),(0,r.jsx)(n.td,{children:"~300 bytes"}),(0,r.jsx)(n.td,{children:"Until user changes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-command-registry"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useCommandRegistry"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"recentIds: string[], usageCount: Record<string, number>"})}),(0,r.jsx)(n.td,{children:"~1KB"}),(0,r.jsx)(n.td,{children:"Until user clears"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-shortcut-registry"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useShortcutRegistry"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"shortcuts: Record<string, string>"})}),(0,r.jsx)(n.td,{children:"~2KB"}),(0,r.jsx)(n.td,{children:"Until user changes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-history"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"useHistoryStore"})}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"past: SerializedAction[], future: SerializedAction[]"})," (global-scope only)"]}),(0,r.jsx)(n.td,{children:"~5KB"}),(0,r.jsx)(n.td,{children:"Until user clears"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"nasnet-machine-{id}"})}),(0,r.jsx)(n.td,{children:"XState Machines"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{ state, context, timestamp, machineId }"})}),(0,r.jsx)(n.td,{children:"~5KB per machine"}),(0,r.jsx)(n.td,{children:"24 hours (auto-cleanup)"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Total localStorage footprint: ~30KB"})," (within 10MB limits)"]}),"\n",(0,r.jsx)(n.h2,{id:"custom-storage-handlers",children:"Custom Storage Handlers"}),"\n",(0,r.jsx)(n.h3,{id:"auth-store-date-object-rehydration",children:"Auth Store: Date Object Rehydration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," JSON serialization converts ",(0,r.jsx)(n.code,{children:"Date"})," objects to ISO strings, losing instanceof checks and\ntimezone info."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Custom storage handler that rehydrates Date objects:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const authStorage: StateStorage = {\n  getItem: (name: string): string | null => {\n    if (typeof localStorage === 'undefined') return null;\n\n    const str = localStorage.getItem(name);\n    if (!str) return null;\n\n    try {\n      const parsed = JSON.parse(str);\n\n      // Rehydrate Date objects from ISO strings\n      if (parsed.state?.tokenExpiry) {\n        parsed.state.tokenExpiry = new Date(parsed.state.tokenExpiry);\n      }\n      if (parsed.state?.lastActivity) {\n        parsed.state.lastActivity = new Date(parsed.state.lastActivity);\n      }\n\n      return JSON.stringify(parsed);\n    } catch {\n      return str;\n    }\n  },\n\n  setItem: (name: string, value: string): void => {\n    if (typeof localStorage === 'undefined') return;\n    localStorage.setItem(name, value);\n  },\n\n  removeItem: (name: string): void => {\n    if (typeof localStorage === 'undefined') return;\n    localStorage.removeItem(name);\n  },\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Usage in auth store:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const useAuthStore = create<AuthState & AuthActions>()(\n  devtools(\n    persist(\n      (set, get) => ({\n        /* ... */\n      }),\n      {\n        name: 'auth-storage',\n        storage: createJSONStorage(() => authStorage),\n        partialize: (state) => ({\n          token: state.token,\n          tokenExpiry: state.tokenExpiry, // Serialized as ISO string\n          refreshToken: state.refreshToken,\n          user: state.user,\n          isAuthenticated: state.isAuthenticated,\n        }),\n      }\n    ),\n    { name: 'auth-store' }\n  )\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Persist:"})," ",(0,r.jsx)(n.code,{children:"tokenExpiry: Date(2025-03-27T12:00:00Z)"})," \u2192 JSON string"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"localStorage:"})," ",(0,r.jsx)(n.code,{children:'"2025-03-27T12:00:00Z"'})," (stored as string)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rehydrate:"})," Custom handler converts \u2192 ",(0,r.jsx)(n.code,{children:'new Date("2025-03-27T12:00:00Z")'})," \u2192 Date object"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Usage:"})," ",(0,r.jsx)(n.code,{children:"tokenExpiry.getTime() <= Date.now()"})," works correctly"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Source:"})," ",(0,r.jsx)(n.code,{children:"libs/state/stores/src/auth/auth.store.ts:191-230"})]}),"\n",(0,r.jsx)(n.h3,{id:"history-store-function-serialization-no-op-on-rehydration",children:"History Store: Function Serialization (No-op on Rehydration)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," Functions (",(0,r.jsx)(n.code,{children:"execute"}),", ",(0,r.jsx)(n.code,{children:"undo"}),") cannot be JSON serialized."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Custom storage that provides no-op functions on rehydration (action metadata only):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface SerializedAction {\n  id: string;\n  type: string;\n  description: string;\n  timestamp: string;  // ISO string\n  scope: 'page' | 'global';\n  resourceId?: string;\n  resourceType?: string;\n  // No execute/undo functions\n}\n\ninterface UndoableAction extends SerializedAction {\n  execute: () => Promise<void>;\n  undo: () => Promise<void>;\n}\n\n// Custom storage handler\nstorage: {\n  getItem: (name) => {\n    const str = localStorage.getItem(name);\n    if (!str) return null;\n\n    const data = JSON.parse(str);\n\n    // Convert serialized actions back to full type with no-op functions\n    if (data.state) {\n      data.state.past = (data.state.past || []).map((a: SerializedAction) => ({\n        ...a,\n        timestamp: new Date(a.timestamp),\n        execute: () => {\n          console.warn('[history-store] Cannot re-execute persisted action');\n        },\n        undo: () => {\n          console.warn('[history-store] Cannot undo persisted action');\n        },\n      }));\n\n      data.state.future = (data.state.future || []).map((a: SerializedAction) => ({\n        ...a,\n        timestamp: new Date(a.timestamp),\n        execute: () => console.warn('[history-store] Cannot re-execute persisted action'),\n        undo: () => console.warn('[history-store] Cannot undo persisted action'),\n      }));\n    }\n\n    return data;\n  },\n  setItem: (name, value) => localStorage.setItem(name, JSON.stringify(value)),\n  removeItem: (name) => localStorage.removeItem(name),\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Why this design:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Only ",(0,r.jsx)(n.strong,{children:"action metadata"})," (description, timestamp, scope) is persisted"]}),"\n",(0,r.jsxs)(n.li,{children:["Actual ",(0,r.jsx)(n.code,{children:"execute()"})," and ",(0,r.jsx)(n.code,{children:"undo()"})," functions require the original state, which may not exist after\nreload"]}),"\n",(0,r.jsx)(n.li,{children:"History UI displays persisted actions (for audit trail), but full undo/redo requires\nre-registration"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Usage:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Store persisted actions for display\nconst pastActions = useHistoryStore((state) => state.past);\npastActions.forEach((action) => {\n  console.log(`${action.timestamp}: ${action.description} (${action.scope})`);\n});\n\n// Redo on persisted action will warn (can't re-execute after reload)\n// This is expected behavior\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Source:"})," ",(0,r.jsx)(n.code,{children:"libs/state/stores/src/history/history.store.ts:54-78, 293-335"})]}),"\n",(0,r.jsx)(n.h3,{id:"command-registry-map-serialization",children:"Command Registry: Map Serialization"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem:"})," ",(0,r.jsx)(n.code,{children:"Map<string, Command>"})," and ",(0,r.jsx)(n.code,{children:"Map<string, number>"})," don't JSON serialize."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution:"})," Convert Map \u2194 Record in ",(0,r.jsx)(n.code,{children:"partialize"})," and ",(0,r.jsx)(n.code,{children:"merge"})," functions:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const useCommandRegistry = create<CommandRegistryState & CommandRegistryActions>()(\n  persist(\n    (set, get) => ({\n      /* ... */\n    }),\n    {\n      name: 'nasnet-command-registry',\n      version: 1,\n      storage: createJSONStorage(() => localStorage),\n\n      // On persist: Convert Map \u2192 Record\n      partialize: (state) => ({\n        recentIds: state.recentIds,\n        usageCount: Object.fromEntries(state.usageCount), // Map \u2192 Record\n      }),\n\n      // On rehydrate: Convert Record \u2192 Map\n      merge: (persistedState, currentState) => {\n        const persisted = persistedState as Partial<CommandRegistryState> & {\n          usageCount?: Record<string, number>;\n        };\n\n        return {\n          ...currentState,\n          recentIds: persisted.recentIds || [],\n          usageCount: new Map(Object.entries(persisted.usageCount || {})), // Record \u2192 Map\n        };\n      },\n    }\n  ),\n  { name: 'command-registry' }\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Data flow:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"In memory:"})," ",(0,r.jsx)(n.code,{children:"usageCount: Map<string, number>"})," \u2192 ",(0,r.jsx)(n.code,{children:"{ 'cmd-1': 3, 'cmd-2': 5, ... }"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"In localStorage:"})," ",(0,r.jsx)(n.code,{children:'"usageCount":{"cmd-1":3,"cmd-2":5}'})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"On reload:"})," ",(0,r.jsx)(n.code,{children:"Object.entries(...)"})," \u2192 ",(0,r.jsx)(n.code,{children:"[ ['cmd-1', 3], ['cmd-2', 5] ]"})," \u2192 ",(0,r.jsx)(n.code,{children:"new Map(...)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Usage:"})," ",(0,r.jsx)(n.code,{children:"usageCount.get('cmd-1')"})," works immediately after rehydration"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Source:"})," ",(0,r.jsx)(n.code,{children:"libs/state/stores/src/command/command-registry.store.ts:280-300"})]}),"\n",(0,r.jsx)(n.h2,{id:"hydrationrehydration-lifecycle",children:"Hydration/Rehydration Lifecycle"}),"\n",(0,r.jsx)(n.h3,{id:"initial-load-app-startup",children:"Initial Load (App Startup)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. Zustand initializes stores\n   \u251c\u2500 Read localStorage with persist middleware\n   \u251c\u2500 Run custom storage handlers (Date rehydration, Map conversion)\n   \u2514\u2500 Merge persisted state with initial state\n\n2. Components mount\n   \u251c\u2500 Selector reads current store state (already hydrated)\n   \u251c\u2500 useEffect triggers (hydration complete)\n   \u2514\u2500 Component renders with persisted data\n\n3. DevTools connect (if enabled)\n   \u2514\u2500 Can now inspect/replay actions\n"})}),"\n",(0,r.jsx)(n.h3,{id:"during-user-session",children:"During User Session"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. User action triggers store mutation\n   \u251c\u2500 Reducer updates in-memory state\n   \u251c\u2500 DevTools logs mutation\n   \u251c\u2500 Persist middleware saves to localStorage\n   \u2514\u2500 Components with selectors re-render (if selected value changed)\n\n2. persist middleware lifecycle:\n   \u251c\u2500 Call partialize() to extract persistable subset\n   \u251c\u2500 Call custom setItem() to write to localStorage\n   \u251c\u2500 Error handling if quota exceeded\n   \u2514\u2500 Silent failure (doesn't throw)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"browser-close--reopen",children:"Browser Close \u2192 Reopen"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1. App startup (see \"Initial Load\" above)\n\n2. Persist middleware rehydration:\n   \u251c\u2500 Check for localStorage key\n   \u251c\u2500 Call custom getItem() to read\n   \u251c\u2500 Custom handlers convert Date strings \u2192 Date objects, etc.\n   \u251c\u2500 Call merge() function to combine with initial state\n   \u2514\u2500 Update store state with hydrated data\n\n3. onRehydrateStorage hook (if provided):\n   \u251c\u2500 Called after rehydration\n   \u251c\u2500 Can initialize side effects based on hydrated state\n   \u251c\u2500 Example: Auth store uses this to validate token expiry\n   \u2514\u2500 Example: Theme store uses this to resolve 'system' theme\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-theme-store-rehydration",children:"Example: Theme Store Rehydration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"export const useThemeStore = create<ThemeState & ThemeActions>()(\n  persist(\n    (set, get) => ({\n      /* ... */\n    }),\n    {\n      name: 'nasnet-theme',\n      onRehydrateStorage: () => {\n        return (state, error) => {\n          if (error) {\n            console.warn('Failed to hydrate theme:', error);\n          }\n\n          // After rehydration, resolve system theme if needed\n          if (state && state.theme === 'system') {\n            state._setResolvedTheme(getSystemTheme());\n          }\n        };\n      },\n    }\n  ),\n  { name: 'theme-store' }\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Flow:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["User opens app with ",(0,r.jsx)(n.code,{children:"theme: 'system'"})," persisted"]}),"\n",(0,r.jsxs)(n.li,{children:["Rehydrate from localStorage \u2192 ",(0,r.jsx)(n.code,{children:"theme: 'system'"})]}),"\n",(0,r.jsxs)(n.li,{children:["Call ",(0,r.jsx)(n.code,{children:"onRehydrateStorage"})," hook"]}),"\n",(0,r.jsxs)(n.li,{children:["Detect OS preference: ",(0,r.jsx)(n.code,{children:"getSystemTheme()"})," \u2192 ",(0,r.jsx)(n.code,{children:"'dark'"})]}),"\n",(0,r.jsxs)(n.li,{children:["Set ",(0,r.jsx)(n.code,{children:"resolvedTheme: 'dark'"})]}),"\n",(0,r.jsx)(n.li,{children:"Components see correct theme immediately"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"machine-persistence-session-recovery",children:"Machine Persistence: Session Recovery"}),"\n",(0,r.jsx)(n.p,{children:"XState machines use separate persistence API (not Zustand persist middleware):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import {\n  persistMachineState,\n  restoreMachineState,\n  hasSavedSession,\n  cleanupStaleSessions,\n  clearMachineState,\n  SESSION_TIMEOUT_MS,\n  STORAGE_KEY_PREFIX,\n} from '@nasnet/state/machines';\n\n// ===== Persist on state transition =====\n\nmachine.onTransition((state) => {\n  persistMachineState('vpn-wizard', state.value, state.context);\n});\n\n// ===== Restore on component mount =====\n\nfunction VPNWizardPage() {\n  useEffect(() => {\n    // Check for saved session\n    const saved = restoreMachineState('vpn-wizard');\n    if (saved) {\n      // Resume wizard\n      actor.send({ type: 'RESTORE', data: saved.context });\n    }\n  }, []);\n}\n\n// ===== Cleanup =====\n\n// On logout: clear all machine sessions\nuseEffect(() => {\n  if (!isAuthenticated) {\n    clearAllMachineStates();\n  }\n}, [isAuthenticated]);\n\n// Periodic cleanup: remove stale sessions (24hr+ old)\nuseEffect(() => {\n  const cleaned = cleanupStaleSessions();\n  console.log(`Cleaned ${cleaned} stale sessions`);\n}, []);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"localstorage-key-format-for-machines",children:"localStorage Key Format for Machines"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Pattern:"})," ",(0,r.jsx)(n.code,{children:"nasnet-machine-{machineId}"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nasnet-machine-vpn-wizard"})," \u2192 VPN setup wizard session"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nasnet-machine-config-pipeline"})," \u2192 Configuration pipeline session"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"nasnet-machine-router-config"})," \u2192 Router configuration wizard"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Storage structure:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"{\n  state: 'step2',                    // Current state value\n  context: {                         // Machine context (arbitrary)\n    vpnType: 'wireguard',\n    selectedRouter: 'router-123',\n    formData: { ... },\n  },\n  timestamp: 1709025600000,          // When saved (ms since epoch)\n  machineId: 'vpn-wizard',           // For recovery validation\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Auto-cleanup:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Sessions older than 24 hours (default ",(0,r.jsx)(n.code,{children:"SESSION_TIMEOUT_MS"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Call ",(0,r.jsx)(n.code,{children:"cleanupStaleSessions()"})," on app startup"]}),"\n",(0,r.jsxs)(n.li,{children:["Or call ",(0,r.jsx)(n.code,{children:"clearMachineState(id)"})," to manually clear"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Source:"})," ",(0,r.jsx)(n.code,{children:"libs/state/machines/src/persistence.ts"})]}),"\n",(0,r.jsx)(n.h2,{id:"storage-quota--limits",children:"Storage Quota & Limits"}),"\n",(0,r.jsx)(n.h3,{id:"browser-localstorage-limits",children:"Browser localStorage Limits"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Browser"}),(0,r.jsx)(n.th,{children:"Limit"}),(0,r.jsx)(n.th,{children:"NasNet Usage"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Chrome"}),(0,r.jsx)(n.td,{children:"~10MB"}),(0,r.jsx)(n.td,{children:"~30KB (0.3%)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Firefox"}),(0,r.jsx)(n.td,{children:"~10MB"}),(0,r.jsx)(n.td,{children:"~30KB (0.3%)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Safari"}),(0,r.jsx)(n.td,{children:"~5MB"}),(0,r.jsx)(n.td,{children:"~30KB (0.6%)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Edge"}),(0,r.jsx)(n.td,{children:"~10MB"}),(0,r.jsx)(n.td,{children:"~30KB (0.3%)"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Current usage is well within safe limits"})," (30KB \u226a 5MB)."]}),"\n",(0,r.jsx)(n.h3,{id:"what-happens-if-quota-exceeded",children:"What Happens if Quota Exceeded"}),"\n",(0,r.jsx)(n.p,{children:"Zustand persist middleware catches errors silently (doesn't throw). If quota exceeded:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"try {\n  localStorage.setItem(key, JSON.stringify(data));\n} catch (error) {\n  console.error('Failed to persist state:', error);\n  // State remains in memory, just not persisted\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Recovery strategies:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Clear old machine sessions: ",(0,r.jsx)(n.code,{children:"cleanupStaleSessions()"})]}),"\n",(0,r.jsxs)(n.li,{children:["Clear history: ",(0,r.jsx)(n.code,{children:"useHistoryStore.getState().clearHistory()"})]}),"\n",(0,r.jsxs)(n.li,{children:["Clear router cache: ",(0,r.jsx)(n.code,{children:"useRouterStore.getState().clearHistory()"})]}),"\n",(0,r.jsxs)(n.li,{children:["Clear command registry: ",(0,r.jsx)(n.code,{children:"useCommandRegistry.getState().clearRecent()"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"privacy--security",children:"Privacy & Security"}),"\n",(0,r.jsx)(n.h3,{id:"whats-stored",children:"What's Stored"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Data"}),(0,r.jsx)(n.th,{children:"Stored?"}),(0,r.jsx)(n.th,{children:"Risk"}),(0,r.jsx)(n.th,{children:"Mitigation"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"JWT tokens"}),(0,r.jsx)(n.td,{children:"Yes (auth-storage)"}),(0,r.jsx)(n.td,{children:"Session hijacking"}),(0,r.jsx)(n.td,{children:"Only valid for 24hr, httpOnly cookies preferred for production"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"User info"}),(0,r.jsx)(n.td,{children:"Yes (auth-storage)"}),(0,r.jsx)(n.td,{children:"Privacy"}),(0,r.jsx)(n.td,{children:"Encrypted in transit, not sensitive (username/email)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Router ID"}),(0,r.jsx)(n.td,{children:"Yes (ui stores)"}),(0,r.jsx)(n.td,{children:"Privacy"}),(0,r.jsx)(n.td,{children:"Non-sensitive, required for UX (recent routers)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Theme preference"}),(0,r.jsx)(n.td,{children:"Yes (theme-storage)"}),(0,r.jsx)(n.td,{children:"None"}),(0,r.jsx)(n.td,{children:"Not sensitive"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Command history"}),(0,r.jsx)(n.td,{children:"Yes (command-registry)"}),(0,r.jsx)(n.td,{children:"Privacy (weak)"}),(0,r.jsx)(n.td,{children:"Could reveal user behavior, cleared on logout"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Undo/redo history"}),(0,r.jsx)(n.td,{children:"Yes (history-storage)"}),(0,r.jsx)(n.td,{children:"Privacy (weak)"}),(0,r.jsx)(n.td,{children:"Could reveal user actions, page-scope cleared on navigation"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Clear session data on logout:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Auth store clears token automatically on logout\nuseAuthStore.getState().clearAuth();\n\n// Also clear all machine sessions\nclearAllMachineStates();\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Clear page-specific history on navigation:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Called by route guard or layout\nuseHistoryStore.getState().clearPageHistory();\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use httpOnly cookies for production:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tokens should be stored in httpOnly cookies, not localStorage"}),"\n",(0,r.jsx)(n.li,{children:"This prevents XSS from accessing auth tokens"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Next Steps:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Read ",(0,r.jsx)(n.a,{href:"/docs/state/performance",children:"Performance"})," for selector patterns and re-render optimization"]}),"\n",(0,r.jsxs)(n.li,{children:["Read ",(0,r.jsx)(n.a,{href:"/docs/state/architecture",children:"Architecture"})," for custom storage handler implementation details"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);