"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[38072],{14153:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"cross-cutting-flows","title":"Cross-Cutting Flows","description":"This document traces six end-to-end flows that span multiple packages. Each flow shows how data moves from user interaction through frontend state, API client, GraphQL schema, and into the backend.","source":"@site/../../libs/features/docs/cross-cutting-flows.md","sourceDirName":".","slug":"/cross-cutting-flows","permalink":"/docs/features/cross-cutting-flows","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/features/docs/cross-cutting-flows.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Architecture Overview","permalink":"/docs/features/architecture-overview"},"next":{"title":"Error Handling Architecture","permalink":"/docs/features/error-handling"}}');var r=i(31085),t=i(71184);const a={},l="Cross-Cutting Flows",c={},o=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"1. Apply-Confirm-Merge Pipeline",id:"1-apply-confirm-merge-pipeline",level:2},{value:"Overview",id:"overview",level:3},{value:"Package Chain",id:"package-chain",level:3},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough",level:3},{value:"Error Handling and Rollback",id:"error-handling-and-rollback",level:3},{value:"2. Firewall Template Safety Pipeline",id:"2-firewall-template-safety-pipeline",level:2},{value:"Overview",id:"overview-1",level:3},{value:"Package Chain",id:"package-chain-1",level:3},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough-1",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"3. Service Install Flow",id:"3-service-install-flow",level:2},{value:"Overview",id:"overview-2",level:3},{value:"Package Chain",id:"package-chain-2",level:3},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough-2",level:3},{value:"Dependency Resolution",id:"dependency-resolution",level:3},{value:"Error Handling",id:"error-handling-1",level:3},{value:"4. Diagnostics Troubleshoot Wizard",id:"4-diagnostics-troubleshoot-wizard",level:2},{value:"Overview",id:"overview-3",level:3},{value:"Package Chain",id:"package-chain-3",level:3},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough-3",level:3},{value:"Error Handling",id:"error-handling-2",level:3},{value:"5. Alert Notification Dispatch Chain",id:"5-alert-notification-dispatch-chain",level:2},{value:"Overview",id:"overview-4",level:3},{value:"Package Chain",id:"package-chain-4",level:3},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough-4",level:3},{value:"Alert Rule Templates",id:"alert-rule-templates",level:3},{value:"6. VIF Pattern for Service Isolation",id:"6-vif-pattern-for-service-isolation",level:2},{value:"Overview",id:"overview-5",level:3},{value:"Package Chain",id:"package-chain-5",level:3},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough-5",level:3},{value:"VIF Schema",id:"vif-schema",level:3},{value:"Isolation Verification",id:"isolation-verification",level:3},{value:"Cross-References",id:"cross-references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"cross-cutting-flows",children:"Cross-Cutting Flows"})}),"\n",(0,r.jsx)(n.p,{children:"This document traces six end-to-end flows that span multiple packages. Each flow shows how data moves from user interaction through frontend state, API client, GraphQL schema, and into the backend."}),"\n",(0,r.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#1-apply-confirm-merge-pipeline",children:"Apply-Confirm-Merge Pipeline"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#2-firewall-template-safety-pipeline",children:"Firewall Template Safety Pipeline"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#3-service-install-flow",children:"Service Install Flow"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#4-diagnostics-troubleshoot-wizard",children:"Diagnostics Troubleshoot Wizard"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#5-alert-notification-dispatch-chain",children:"Alert Notification Dispatch Chain"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#6-vif-pattern-for-service-isolation",children:"VIF Pattern for Service Isolation"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-apply-confirm-merge-pipeline",children:"1. Apply-Confirm-Merge Pipeline"}),"\n",(0,r.jsx)(n.p,{children:"The Apply-Confirm-Merge pipeline is the core safety mechanism for all configuration changes. It prevents accidental network lockouts by requiring explicit validation, preview, and (for high-risk operations) acknowledgment before any change reaches the router."}),"\n",(0,r.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"User edits form\n       \u2502\n       \u25bc\n [change-set.store]  \u2500\u2500\u2500 Zustand, persisted to sessionStorage\n       \u2502\n       \u25bc\n [configPipelineMachine]  \u2500\u2500\u2500 XState FSM (12 states)\n       \u2502\n       \u251c\u2500 draft \u2192 validating \u2192 invalid (show errors)\n       \u2502                    \u2514\u2500 previewing \u2192 confirming (high-risk)\n       \u2502                                 \u2514\u2500 applying \u2192 verifying \u2192 active\n       \u2502                                                         \u2514\u2500 rollback \u2192 rolled_back\n       \u2514\u2500 error (manual intervention)\n       \u2502\n       \u25bc\n [useChangeSetMutations]  \u2500\u2500\u2500 @nasnet/api-client/queries\n       \u2502\n       \u25bc\n schema/changeset/  \u2500\u2500\u2500 GraphQL change set operations\n       \u2502\n       \u25bc\n apps/backend/graph/resolver/changeset-operations.resolvers.go\n"})}),"\n",(0,r.jsx)(n.h3,{id:"package-chain",children:"Package Chain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"libs/features/*/components\n  \u2192 libs/state/stores/src/change-set/change-set.store.ts\n    \u2192 libs/state/machines/src/configPipelineMachine.ts\n      \u2192 libs/api-client/queries/src/change-set/\n        \u2192 schema/changeset/\n          \u2192 apps/backend/graph/resolver/changeset-*.resolvers.go\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-by-step-walkthrough",children:"Step-by-Step Walkthrough"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: User Edits a Form"})}),"\n",(0,r.jsx)(n.p,{children:"The user changes a field in a configuration form (e.g., WireGuard MTU, DHCP lease time). The form uses React Hook Form + Zod and calls into the feature-level hook:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// In a feature component\nconst { createChangeSet, addItem } = useChangeSetStore();\n\nconst changeSetId = createChangeSet({\n  name: 'Update WireGuard Config',\n  routerId: currentRouterId,\n  source: 'wireguard-form',\n});\n\naddItem(changeSetId, {\n  name: 'WireGuard Interface',\n  resourceType: 'vpn.wireguard',\n  operation: 'UPDATE',\n  configuration: { mtu: 1420, privateKey: '...' },\n  dependencies: [],\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The store is persisted to ",(0,r.jsx)(n.code,{children:"localStorage"})," under the key ",(0,r.jsx)(n.code,{children:"nasnet-change-sets"})," (only DRAFT and READY status change sets survive page refresh)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Machine Start"})}),"\n",(0,r.jsxs)(n.p,{children:["The config pipeline machine is instantiated per resource type via ",(0,r.jsx)(n.code,{children:"createConfigPipelineMachine<TConfig>"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// libs/state/machines/src/configPipelineMachine.ts\nconst machine = createConfigPipelineMachine<WireGuardConfig>({\n  runValidationPipeline: async (config) => {\n    const errors = await validateWireGuardConfig(config);\n    const diff = await computeConfigDiff(config);\n    return { errors, diff };\n  },\n  applyConfig: async ({ resourceId, config }) => {\n    const backup = await getBackup(resourceId);\n    await applyWireGuardConfig(resourceId, config);\n    return { rollbackData: backup };\n  },\n  verifyApplied: async (resourceId) => {\n    const status = await checkWireGuardStatus(resourceId);\n    if (!status.running) throw new Error('WireGuard failed to start');\n  },\n  executeRollback: async (rollbackData) => {\n    await restoreWireGuardConfig(rollbackData);\n  },\n  onSuccess: () => showSuccess('Configuration applied'),\n  onRollback: () => showWarning('Configuration rolled back'),\n});\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 3: 12-State Validation Pipeline"})}),"\n",(0,r.jsx)(n.p,{children:"The machine transitions through states automatically:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"State"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Transitions Out"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"idle"})}),(0,r.jsx)(n.td,{children:"Waiting for edit"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"EDIT"})," \u2192 ",(0,r.jsx)(n.code,{children:"draft"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"draft"})}),(0,r.jsx)(n.td,{children:"Editing in progress"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"VALIDATE"})," \u2192 ",(0,r.jsx)(n.code,{children:"validating"}),", ",(0,r.jsx)(n.code,{children:"CANCEL"})," \u2192 ",(0,r.jsx)(n.code,{children:"idle"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"validating"})}),(0,r.jsx)(n.td,{children:"Running 7-stage pipeline"}),(0,r.jsxs)(n.td,{children:["onDone \u2192 ",(0,r.jsx)(n.code,{children:"invalid"})," or ",(0,r.jsx)(n.code,{children:"previewing"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"invalid"})}),(0,r.jsx)(n.td,{children:"Validation errors shown"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"EDIT"})," \u2192 ",(0,r.jsx)(n.code,{children:"draft"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"previewing"})}),(0,r.jsx)(n.td,{children:"Diff shown to user"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"CONFIRM"})," \u2192 ",(0,r.jsx)(n.code,{children:"confirming"})," (high-risk) or ",(0,r.jsx)(n.code,{children:"applying"})," (normal)"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"confirming"})}),(0,r.jsx)(n.td,{children:"User acknowledges risk"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"ACKNOWLEDGED"})," \u2192 ",(0,r.jsx)(n.code,{children:"applying"}),", ",(0,r.jsx)(n.code,{children:"CANCEL"})," \u2192 ",(0,r.jsx)(n.code,{children:"previewing"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"applying"})}),(0,r.jsx)(n.td,{children:"Mutation sent to backend"}),(0,r.jsxs)(n.td,{children:["onDone \u2192 ",(0,r.jsx)(n.code,{children:"verifying"}),", onError \u2192 ",(0,r.jsx)(n.code,{children:"error"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"verifying"})}),(0,r.jsx)(n.td,{children:"Backend confirms change"}),(0,r.jsxs)(n.td,{children:["onDone \u2192 ",(0,r.jsx)(n.code,{children:"active"}),", onError \u2192 ",(0,r.jsx)(n.code,{children:"rollback"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"active"})}),(0,r.jsx)(n.td,{children:"Success (final)"}),(0,r.jsx)(n.td,{children:"\u2014"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"rollback"})}),(0,r.jsx)(n.td,{children:"Executing rollback"}),(0,r.jsxs)(n.td,{children:["onDone \u2192 ",(0,r.jsx)(n.code,{children:"rolled_back"}),", onError \u2192 ",(0,r.jsx)(n.code,{children:"error"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"rolled_back"})}),(0,r.jsx)(n.td,{children:"Rollback complete (final)"}),(0,r.jsx)(n.td,{children:"\u2014"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"error"})}),(0,r.jsx)(n.td,{children:"Unrecoverable"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"RETRY"})," \u2192 ",(0,r.jsx)(n.code,{children:"validating"}),", ",(0,r.jsx)(n.code,{children:"FORCE_ROLLBACK"})," \u2192 ",(0,r.jsx)(n.code,{children:"rollback"}),", ",(0,r.jsx)(n.code,{children:"RESET"})," \u2192 ",(0,r.jsx)(n.code,{children:"idle"})]})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 4: Drift Detection"})}),"\n",(0,r.jsxs)(n.p,{children:["After ",(0,r.jsx)(n.code,{children:"verifying"}),", drift detection runs via ",(0,r.jsx)(n.code,{children:"useApplyConfirmDrift"})," and ",(0,r.jsx)(n.code,{children:"useDriftDetection"})," from ",(0,r.jsx)(n.code,{children:"libs/state/stores/src/drift-detection/"}),". If the confirmed state diverges from the router's actual state, a drift warning appears and the reconciliation scheduler re-queues the operation."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 5: GraphQL Mutation"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"useChangeSetMutations"})," hook sends the atomic change set to the backend:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// libs/api-client/queries/src/change-set/useChangeSetMutations.ts\nconst { applyChangeSet } = useChangeSetMutations();\nawait applyChangeSet({ changeSetId, routerId });\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 6: Backend Processing"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"apps/backend/graph/resolver/changeset-operations.resolvers.go"})," orchestrates:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Deserializes the change set items"}),"\n",(0,r.jsx)(n.li,{children:"Resolves dependency order (topological sort)"}),"\n",(0,r.jsx)(n.li,{children:"Applies items sequentially"}),"\n",(0,r.jsx)(n.li,{children:"Records rollback plan per item"}),"\n",(0,r.jsx)(n.li,{children:"Returns apply result with confirmed states"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"error-handling-and-rollback",children:"Error Handling and Rollback"}),"\n",(0,r.jsxs)(n.p,{children:["If ",(0,r.jsx)(n.code,{children:"verifyApplied"})," throws, the machine automatically transitions to ",(0,r.jsx)(n.code,{children:"rollback"})," and calls ",(0,r.jsx)(n.code,{children:"executeRollback"})," with the saved ",(0,r.jsx)(n.code,{children:"rollbackData"}),". The ",(0,r.jsx)(n.code,{children:"rollbackData"})," is captured in ",(0,r.jsx)(n.code,{children:"setRollbackData"})," action immediately after ",(0,r.jsx)(n.code,{children:"applying"})," succeeds (before ",(0,r.jsx)(n.code,{children:"verifying"}),")."]}),"\n",(0,r.jsxs)(n.p,{children:["If the user manually triggers ",(0,r.jsx)(n.code,{children:"FORCE_ROLLBACK"})," from ",(0,r.jsx)(n.code,{children:"error"})," state, the guard ",(0,r.jsx)(n.code,{children:"hasRollbackData"})," must pass."]}),"\n",(0,r.jsx)(n.p,{children:"Utility helpers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { isPipelineProcessing, isPipelineCancellable, getPipelineStateDescription } from '@nasnet/state/machines';\n\nif (isPipelineProcessing(state)) showSpinner();\nif (isPipelineCancellable(state)) showCancelButton();\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-firewall-template-safety-pipeline",children:"2. Firewall Template Safety Pipeline"}),"\n",(0,r.jsx)(n.p,{children:"Firewall templates are pre-built rule sets that can be applied to a router's firewall in bulk. The safety pipeline ensures the user reviews and can undo the change."}),"\n",(0,r.jsx)(n.h3,{id:"overview-1",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"TemplatesPage  \u2192  TemplateApplyFlow  \u2192  templateApplyMachine\n      \u2502                                        \u2502\n      \u2502                              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n      \u2502                              \u2502 7 validation stages  \u2502\n      \u2502                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502                                         \u2502\n      \u2502                              GraphQL mutation (applyTemplate)\n      \u2502                                         \u2502\n      \u2502                              10-second undo window\n      \u2502                              (UNDO event \u2192 rollback)\n      \u2514\u2500 subscription \u2192 onTemplateApplied \u2192 refresh rules\n"})}),"\n",(0,r.jsx)(n.h3,{id:"package-chain-1",children:"Package Chain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"libs/features/firewall/src/pages/TemplatesPage.tsx\n  \u2192 libs/features/firewall/src/components/TemplateApplyFlow.tsx\n    \u2192 libs/state/machines (createTemplateApplyMachine variant)\n      \u2192 libs/api-client/queries/src/firewall/templates.ts\n        \u2192 schema/firewall/firewall-address-template-mutations.graphql\n          \u2192 apps/backend/graph/resolver/firewall-address-template-mutations.resolvers.go\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-by-step-walkthrough-1",children:"Step-by-Step Walkthrough"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: Template Browse"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"TemplatesPage.tsx"})," renders the templates catalog. Users can filter by category (Security, Monitoring, etc.) and preview template details via ",(0,r.jsx)(n.code,{children:"TemplateDetailPanel"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Apply Initiation"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"TemplateApplyFlow.tsx"}),' is mounted when the user clicks "Apply". It accepts:']}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"templateId"})," - the template to apply"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"routerId"})," - target router"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onSuccess"})," / ",(0,r.jsx)(n.code,{children:"onCancel"})," callbacks"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 3: Validation"})}),"\n",(0,r.jsx)(n.p,{children:"The underlying machine runs 7 validation stages before allowing apply:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Syntax validation (rule format)"}),"\n",(0,r.jsx)(n.li,{children:"Conflict detection (duplicate rules)"}),"\n",(0,r.jsx)(n.li,{children:"Dependency checks (required interfaces exist)"}),"\n",(0,r.jsx)(n.li,{children:"Platform capability check (router supports required features)"}),"\n",(0,r.jsx)(n.li,{children:"Security analysis (no overly permissive rules)"}),"\n",(0,r.jsx)(n.li,{children:"IP address sanity check"}),"\n",(0,r.jsx)(n.li,{children:"Final summary"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 4: Apply Mutation"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// libs/api-client/queries/src/firewall/templates.ts\nconst { applyTemplate } = useFirewallTemplates();\nconst result = await applyTemplate({ templateId, routerId, dryRun: false });\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 5: 10-Second Undo Window"})}),"\n",(0,r.jsxs)(n.p,{children:["After successful apply, the machine enters a ",(0,r.jsx)(n.code,{children:"pendingUndo"})," state with a 10-second countdown. The ",(0,r.jsx)(n.code,{children:"UndoFloatingButton.tsx"})," component renders a floating action button showing the remaining time. If the user clicks Undo:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"UNDO event \u2192 machine transitions to undoing state\n           \u2192 sends rollback mutation (removeAppliedRules)\n           \u2192 on success: machine returns to idle\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If no undo is triggered within 10 seconds, the machine moves to ",(0,r.jsx)(n.code,{children:"committed"})," (final state)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 6: Rules Refresh"})}),"\n",(0,r.jsxs)(n.p,{children:["On ",(0,r.jsx)(n.code,{children:"committed"}),", ",(0,r.jsx)(n.code,{children:"refetchQueries"})," for filter rules, mangle rules, NAT rules, and raw rules is triggered to reflect the new state."]}),"\n",(0,r.jsx)(n.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsxs)(n.p,{children:["If the ",(0,r.jsx)(n.code,{children:"apply"})," mutation fails:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Machine moves to ",(0,r.jsx)(n.code,{children:"applyError"})," state"]}),"\n",(0,r.jsx)(n.li,{children:'Error message is shown with a "Try Again" option'}),"\n",(0,r.jsx)(n.li,{children:"No partial rollback is needed since firewall rule creation is atomic per template"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-service-install-flow",children:"3. Service Install Flow"}),"\n",(0,r.jsx)(n.p,{children:"Installing a network service (Tor, sing-box, Xray-core, etc.) from the feature marketplace involves browsing, configuration, installation, and real-time progress tracking."}),"\n",(0,r.jsx)(n.h3,{id:"overview-2",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"ServicesPage (browse)\n      \u2502\nTemplateBrowser \u2192 service selection\n      \u2502\nServiceDetailPage \u2192 install button\n      \u2502\nuseInstanceMutations.installService\n      \u2502\nGraphQL: installService mutation\n      \u2502\nBackend: provisioning orchestrator\n      \u2502\nWebSocket subscription: onInstallProgress\n      \u2502\nFrontend: progress UI update\n      \u2502\nOn success: navigate to ServiceDetailPage\n"})}),"\n",(0,r.jsx)(n.h3,{id:"package-chain-2",children:"Package Chain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"libs/features/services/src/pages/ServicesPage.tsx\n  \u2192 libs/features/services/src/components/templates/TemplateFilters.tsx\n    \u2192 libs/api-client/queries/src/services/useAvailableServices.ts\n      \u2192 schema/services/services-templates-ops.graphql\n\nlibs/features/services/src/pages/ServiceDetailPage.tsx\n  \u2192 libs/api-client/queries/src/services/useInstanceMutations.ts\n    \u2192 schema/services/services-types.graphql\n      \u2192 apps/backend/graph/resolver/services-crud-ops.resolvers.go\n        \u2192 apps/backend/internal/orchestrator/lifecycle/lifecycle_installer.go\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-by-step-walkthrough-2",children:"Step-by-Step Walkthrough"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: Browsing Available Services"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ServicesPage.tsx"})," fetches available services:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const { services, loading } = useAvailableServices({ routerId });\n"})}),"\n",(0,r.jsx)(n.p,{children:"The query returns services from the feature registry, filtered by router capability (e.g., container support required)."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Template Filtering and Selection"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"TemplateFilters.tsx"})," provides category, search, and compatibility filters. The service list is organized by category (VPN, Privacy, Monitoring, etc.)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 3: Configuration"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ServiceDetailPage.tsx"})," presents a dynamic configuration form driven by the service's JSON schema. The ",(0,r.jsx)(n.code,{children:"ServiceConfigForm"})," component renders the appropriate fields using ",(0,r.jsx)(n.code,{children:"DynamicField"})," components (TextField, NumberField, PasswordField, Select, MultiSelect, ArrayField)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 4: Install Mutation"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const { installService, loading } = useInstanceMutations();\n\nawait installService({\n  serviceId: 'tor',\n  routerId,\n  configuration: formValues,\n  storageConfig: { path: '/usb/tor' },\n});\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 5: Progress Tracking via Subscription"})}),"\n",(0,r.jsx)(n.p,{children:"Installation is asynchronous on the backend. The frontend subscribes to install progress events:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"useResourceStateSubscription(instanceUuid, {\n  onStateChange: (event) => {\n    if (event.newState === 'RUNNING') {\n      setInstalled(true);\n    }\n  },\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The backend sends state transitions: ",(0,r.jsx)(n.code,{children:"PENDING"})," \u2192 ",(0,r.jsx)(n.code,{children:"DOWNLOADING"})," \u2192 ",(0,r.jsx)(n.code,{children:"INSTALLING"})," \u2192 ",(0,r.jsx)(n.code,{children:"CONFIGURING"})," \u2192 ",(0,r.jsx)(n.code,{children:"RUNNING"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 6: Navigation on Success"})}),"\n",(0,r.jsxs)(n.p,{children:["On ",(0,r.jsx)(n.code,{children:"RUNNING"})," state, the user is navigated to the service's detail page where they can configure, start/stop/restart, view logs, and monitor resources."]}),"\n",(0,r.jsx)(n.h3,{id:"dependency-resolution",children:"Dependency Resolution"}),"\n",(0,r.jsxs)(n.p,{children:["Before install, ",(0,r.jsx)(n.code,{children:"useDependencies"})," checks if required services are running (e.g., sing-box depends on certain kernel modules). If dependencies are missing, ",(0,r.jsx)(n.code,{children:"StopDependentsDialog"})," may be shown."]}),"\n",(0,r.jsx)(n.h3,{id:"error-handling-1",children:"Error Handling"}),"\n",(0,r.jsx)(n.p,{children:"If install fails, the backend automatically rolls back:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Removes downloaded binaries"}),"\n",(0,r.jsx)(n.li,{children:"Removes created virtual interfaces"}),"\n",(0,r.jsx)(n.li,{children:"Removes allocated VLANs"}),"\n",(0,r.jsxs)(n.li,{children:["Returns ",(0,r.jsx)(n.code,{children:"FAILED"})," state with error message"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-diagnostics-troubleshoot-wizard",children:"4. Diagnostics Troubleshoot Wizard"}),"\n",(0,r.jsx)(n.p,{children:'The Troubleshoot Wizard guides users through diagnosing "No Internet" connectivity problems. It runs five sequential diagnostic steps, collects results, identifies issues, and suggests fixes.'}),"\n",(0,r.jsx)(n.h3,{id:"overview-3",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"TroubleshootWizard (root)\n      \u2502\n      \u251c\u2500\u2500 [mobile] TroubleshootWizardMobile\n      \u2514\u2500\u2500 [desktop] TroubleshootWizardDesktop\n                \u2502\n         useTroubleshootWizard hook\n                \u2502\n         createTroubleshootMachine (XState)\n                \u2502\n         diagnostic-executor \u2192 GraphQL mutations\n                \u2502\n         fix-registry \u2192 fix-applicator\n                \u2502\n         verify after fix\n"})}),"\n",(0,r.jsx)(n.h3,{id:"package-chain-3",children:"Package Chain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"libs/features/diagnostics/src/components/TroubleshootWizard/TroubleshootWizard.tsx\n  \u2192 libs/features/diagnostics/src/components/TroubleshootWizard/TroubleshootWizardDesktop.tsx\n  \u2192 libs/features/diagnostics/src/components/TroubleshootWizard/TroubleshootWizardMobile.tsx\n    \u2192 libs/features/diagnostics/src/hooks/useTroubleshootWizard.ts\n      \u2192 libs/features/diagnostics/src/services/diagnostic-executor.ts\n        \u2192 libs/api-client/core (apolloClient.mutate)\n          \u2192 schema/diagnostics/diagnostics-troubleshoot-ops.graphql\n            \u2192 apps/backend/graph/resolver/diagnostics-troubleshoot-ops.resolvers.go\n              \u2192 apps/backend/internal/troubleshoot/service.go\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-by-step-walkthrough-3",children:"Step-by-Step Walkthrough"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: Wizard Entry"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"TroubleshootWizard"})," auto-detects platform and renders the appropriate presenter. It accepts:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"routerId"})," - the router to diagnose"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"autoStart"})," - skip idle screen and begin immediately"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ispInfo"})," - optional ISP contact details for ISP-related failures"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onClose"})," - close callback"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Machine Start"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"createTroubleshootMachine"})," creates an XState machine that orchestrates the five diagnostic steps in sequence:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"WAN"})," - Is the WAN interface up and getting a DHCP lease?"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Gateway"})," - Can the router ping the default gateway?"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Internet"})," - Can the router reach the internet (ping 8.8.8.8)?"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"DNS"})," - Is DNS resolution working?"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"NAT"})," - Is NAT/masquerade configured correctly?"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 3: Diagnostic Execution"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"diagnostic-executor.ts"})," translates step IDs to ",(0,r.jsx)(n.code,{children:"TroubleshootStepType"})," enum values and calls the backend:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// libs/features/diagnostics/src/services/diagnostic-executor.ts\nexport async function executeDiagnosticStep(\n  stepId: string,\n  routerId: string,\n  sessionId: string\n): Promise<StepResult> {\n  const stepType = STEP_ID_TO_TYPE[stepId]; // 'wan' \u2192 TroubleshootStepType.WAN\n\n  const { data } = await apolloClient.mutate({\n    mutation: RUN_TROUBLESHOOT_STEP,\n    variables: { input: { routerId, sessionId, stepType } },\n  });\n\n  return data.runTroubleshootStep.step.result;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 4: DiagnosticStep UI"})}),"\n",(0,r.jsxs)(n.p,{children:["Each step is displayed via ",(0,r.jsx)(n.code,{children:"DiagnosticStep.tsx"})," with status (pending, running, success, failure) and the result message and timing."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 5: Fix Registry and Application"})}),"\n",(0,r.jsxs)(n.p,{children:["When a step fails, ",(0,r.jsx)(n.code,{children:"fix-registry"})," maps the ",(0,r.jsx)(n.code,{children:"issueCode"})," to available fixes:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"issueCode: 'WAN_DHCP_FAILED'  \u2192  fix: 'Release and renew DHCP lease'\nissueCode: 'DNS_TIMEOUT'      \u2192  fix: 'Use backup DNS servers (8.8.8.8, 1.1.1.1)'\nissueCode: 'NAT_MISSING'      \u2192  fix: 'Add masquerade rule on WAN interface'\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"fix-applicator.ts"})," applies the fix using GraphQL mutations (DHCP release, DNS config change, firewall rule add), then re-runs the failed step to verify."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 6: WizardSummary"})}),"\n",(0,r.jsxs)(n.p,{children:["When all steps are complete (or no more fixes are available), ",(0,r.jsx)(n.code,{children:"WizardSummary.tsx"})," shows:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Overall pass/fail"}),"\n",(0,r.jsx)(n.li,{children:"Per-step results"}),"\n",(0,r.jsx)(n.li,{children:"Fix suggestions for remaining failures"}),"\n",(0,r.jsx)(n.li,{children:"ISP contact info if the failure is external (e.g., ISP outage)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"StepAnnouncer.tsx"})," provides ARIA live region announcements for each step transition, ensuring screen reader accessibility during the automated diagnostic sequence."]}),"\n",(0,r.jsx)(n.h3,{id:"error-handling-2",children:"Error Handling"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"diagnostic-executor.ts"})," handles three error types:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Unknown step ID - returns actionable error\nif (!stepType) {\n  return { success: false, message: `Unsupported diagnostic step. Supported: wan, gateway, internet, dns, nat` };\n}\n\n// Missing result - indicates backend overload\nif (!result) {\n  return { success: false, message: 'No result received. The backend may be overloaded.' };\n}\n\n// Network error - returns error message\ncatch (error) {\n  return { success: false, message: error instanceof Error ? error.message : 'Please check your router connection' };\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-alert-notification-dispatch-chain",children:"5. Alert Notification Dispatch Chain"}),"\n",(0,r.jsx)(n.p,{children:"The alert notification system delivers real-time and queued notifications from backend alert rule evaluation through multiple delivery channels to the frontend."}),"\n",(0,r.jsx)(n.h3,{id:"overview-4",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Router metrics / events\n       \u2502\nbackend alert engine (engine.go + engine_evaluate.go)\n       \u2502\nthrottle queue (alert_queue.go)\n       \u2502\nquiet hours filter (quiet_hours_queue.go)\n       \u2502\nnotification dispatcher (dispatcher.go + dispatcher_routing.go)\n       \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 channels:                                    \u2502\n\u2502  - in-app (push/inapp.go)                   \u2502\n\u2502  - email (http/email.go)                    \u2502\n\u2502  - webhook (http/webhook.go)                \u2502\n\u2502  - ntfy (push/ntfy.go)                      \u2502\n\u2502  - pushover (push/pushover.go)              \u2502\n\u2502  - telegram (push/telegram.go)              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\nGraphQL subscription (alerts-subscriptions-channel.graphql)\n       \u2502\nfrontend useResourceStateSubscription / useDigestQueueCount\n       \u2502\nalert-notification.store (Zustand)\n       \u2502\nAlertBadge component (QueuedAlertBadge shows count)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"package-chain-4",children:"Package Chain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"apps/backend/internal/alerts/engine.go\n  \u2192 apps/backend/internal/alerts/engine_evaluate.go\n    \u2192 apps/backend/internal/alerts/throttle/alert_queue.go\n      \u2192 apps/backend/internal/alerts/throttle/quiet_hours_queue.go\n        \u2192 apps/backend/internal/notifications/dispatcher.go\n          \u2192 apps/backend/internal/notifications/channels/\n            \u2192 apps/backend/graph/resolver/alerts-subscriptions-channel.resolvers.go\n              \u2192 GraphQL subscription event\n                \u2192 libs/api-client/queries/src/alerts/useDigestQueueCount.ts\n                  \u2192 libs/state/stores/src/alert-notification.store.ts\n                    \u2192 libs/features/alerts/src/components/AlertBadge.tsx\n                    \u2192 libs/features/alerts/src/components/QueuedAlertBadge.tsx\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-by-step-walkthrough-4",children:"Step-by-Step Walkthrough"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: Alert Engine Evaluation"})}),"\n",(0,r.jsx)(n.p,{children:"The backend alert engine runs on a configurable schedule. For each active alert rule, it evaluates conditions against current router metrics or events."}),"\n",(0,r.jsxs)(n.p,{children:["The engine uses the bridge pattern (",(0,r.jsx)(n.code,{children:"alerts/bridge/bridge.go"}),") to receive metric updates from the monitoring subsystem without tight coupling."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Throttle and Storm Protection"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"alert_queue.go"})," implements throttling to prevent alert floods:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Each rule has a ",(0,r.jsx)(n.code,{children:"cooldown"})," period (minimum interval between firings)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"quiet_hours_queue.go"})," checks the configured quiet hours schedule and timezone before dispatching"]}),"\n",(0,r.jsxs)(n.li,{children:["Alerts outside quiet hours are held and dispatched at the quiet period end, or dropped if ",(0,r.jsx)(n.code,{children:"dropOnQuietHours"})," is set"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 3: Notification Dispatch"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"dispatcher.go"})," routes each alert to configured channels. ",(0,r.jsx)(n.code,{children:"dispatcher_routing.go"})," handles channel selection based on rule configuration (severity, channel assignment)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 4: In-App Notification"})}),"\n",(0,r.jsxs)(n.p,{children:["The in-app channel (",(0,r.jsx)(n.code,{children:"push/inapp.go"}),") publishes the notification to the GraphQL subscription system. The backend GraphQL resolver broadcasts via WebSocket."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 5: Frontend Subscription"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Digest queue count (badge count)\nconst { count } = useDigestQueueCount({ routerId });\n\n// Full digest history\nconst { notifications } = useDigestHistory({ routerId, limit: 50 });\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"alert-notification.store.ts"})," maintains the notification list with unread count, read state, and snooze functionality."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 6: UI Components"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"AlertBadge      - shows colored badge with severity indicator\nQueuedAlertBadge - shows numeric count of queued (unread) alerts\nAlertList       - expandable list of recent alerts\nAlertRuleForm   - create/edit alert rules\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"InAppNotificationPreferences.tsx"})," component lets users configure:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Which alert severities trigger in-app notifications"}),"\n",(0,r.jsx)(n.li,{children:"Notification sound preferences"}),"\n",(0,r.jsx)(n.li,{children:"Auto-dismiss timing"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"alert-rule-templates",children:"Alert Rule Templates"}),"\n",(0,r.jsxs)(n.p,{children:["Alert rule templates (",(0,r.jsx)(n.code,{children:"alerts/useAlertRuleTemplates"}),") provide pre-built rule configurations (high CPU, low disk, VPN tunnel down, etc.) that users can customize and apply."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"6-vif-pattern-for-service-isolation",children:"6. VIF Pattern for Service Isolation"}),"\n",(0,r.jsx)(n.p,{children:"Virtual Interface (VIF) is the core network isolation mechanism that gives each installed service its own private network namespace within the MikroTik router. This prevents services from interfering with each other or with the router's main routing table."}),"\n",(0,r.jsx)(n.h3,{id:"overview-5",children:"Overview"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Service install request\n       \u2502\nVIF factory (vif/interface_factory.go)\n       \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Creates:                                     \u2502\n\u2502  - Virtual bridge interface                 \u2502\n\u2502  - VLAN allocation (vlan_allocator.go)       \u2502\n\u2502  - Gateway configuration (gateway_config.go) \u2502\n\u2502  - Virtual interface entry in DB            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\nKill Switch Coordinator\n(vif/isolation/kill_switch_coordinator.go)\n       \u2502\nBridge membership management\n(services/bridge/service.go)\n       \u2502\nVLAN tag assignment\n       \u2502\nVirtual interface persisted to ent schema (schema/virtualinterface.go)\n       \u2502\nGraphQL: useVirtualInterfaces hook\n       \u2502\nFrontend: VIF status display\n"})}),"\n",(0,r.jsx)(n.h3,{id:"package-chain-5",children:"Package Chain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"apps/backend/internal/vif/interface_factory.go\n  \u2192 apps/backend/internal/vif/bridge.go\n    \u2192 apps/backend/internal/network/vlan_allocator.go\n      \u2192 apps/backend/internal/adapters/ent_vlan_allocation_repo.go\n        \u2192 apps/backend/generated/ent/virtualinterface.go\n\napps/backend/internal/vif/isolation/kill_switch_listener.go\n  \u2192 apps/backend/internal/vif/isolation/kill_switch_coordinator.go\n\nlibs/api-client/queries/src/services/useVirtualInterfaces.ts\n  \u2192 schema/services/services-isolation.graphql\n    \u2192 apps/backend/graph/resolver/services-isolation.resolvers.go\n"})}),"\n",(0,r.jsx)(n.h3,{id:"step-by-step-walkthrough-5",children:"Step-by-Step Walkthrough"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 1: VIF Allocation"})}),"\n",(0,r.jsx)(n.p,{children:"When a service is installed, the VIF factory creates the virtual network topology:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"interface_factory.go\n  \u251c\u2500\u2500 Allocate VLAN ID from pool (vlan_allocator.go)\n  \u251c\u2500\u2500 Create bridge interface on router\n  \u251c\u2500\u2500 Configure gateway IP for the bridge\n  \u2514\u2500\u2500 Persist VirtualInterface entity to database\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The VLAN allocator maintains a pool of available VLAN IDs (typically 100\u20134094) and assigns the next available one. VLAN IDs are persisted to the ",(0,r.jsx)(n.code,{children:"ent"})," schema via ",(0,r.jsx)(n.code,{children:"ent_vlan_allocation_repo.go"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 2: Gateway Configuration"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"gateway_config.go"})," and ",(0,r.jsx)(n.code,{children:"gateway_manager.go"})," manage the gateway IP address that the service will use as its default route:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Service VIF subnet: 172.16.X.0/30 (per VLAN)\nGateway IP:         172.16.X.1 (router-side)\nService IP:         172.16.X.2 (service-side)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 3: Kill Switch"})}),"\n",(0,r.jsxs)(n.p,{children:["The kill switch coordinator (",(0,r.jsx)(n.code,{children:"vif/isolation/kill_switch_coordinator.go"}),") monitors VPN tunnel state. When the upstream VPN tunnel goes down:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kill_switch_listener.go"})," detects the state change"]}),"\n",(0,r.jsx)(n.li,{children:"Coordinator blocks all traffic through the service's bridge"}),"\n",(0,r.jsx)(n.li,{children:"Service traffic stops immediately (kill switch active)"}),"\n",(0,r.jsx)(n.li,{children:"When VPN recovers, coordinator restores traffic flow"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This ensures services with VPN-dependency never leak traffic over unprotected connections."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 4: Bridge Port Management"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"services/bridge/service.go"})," handles port membership in the bridge:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Adds service container ports to the bridge on start"}),"\n",(0,r.jsx)(n.li,{children:"Removes ports on stop"}),"\n",(0,r.jsx)(n.li,{children:"Manages VLAN tagging for traffic isolation"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"vlans.go"})," ensures correct VLAN membership per service"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 5: Chain Routing"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"vif/routing/chain_router.go"})," manages multi-hop routing for service chains (e.g., traffic \u2192 WireGuard \u2192 Tor \u2192 internet):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"vif/routing/chain_router.go\n  \u2192 chain_router_hops.go  (per-hop configuration)\n    \u2192 chain_latency.go    (latency measurement per hop)\n      \u2192 pbr_engine.go     (policy-based routing rules)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 6: Frontend VIF Status"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// libs/api-client/queries/src/services/useVirtualInterfaces.ts\nconst { interfaces, loading } = useVirtualInterfaces({ serviceId });\n\n// Each interface includes:\n// - vlanId\n// - bridgeName\n// - gatewayIp\n// - status (active/inactive)\n// - killSwitchActive (boolean)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"GatewayStatusCard.tsx"})," component displays real-time VIF health including gateway ping latency and kill switch state."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Step 7: Traffic Statistics"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"vif/traffic/aggregator.go"})," collects per-interface traffic statistics (bytes in/out, packets, drops). ",(0,r.jsx)(n.code,{children:"vif/traffic/quota_enforcer.go"})," enforces configured data quotas by blocking traffic when the limit is reached."]}),"\n",(0,r.jsx)(n.h3,{id:"vif-schema",children:"VIF Schema"}),"\n",(0,r.jsxs)(n.p,{children:["The VIF is persisted in the ",(0,r.jsx)(n.code,{children:"virtualinterface"})," ent entity:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"// apps/backend/internal/ent-schema/schema/virtualinterface.go\n// Fields: ID, ServiceID, VLANID, BridgeName, GatewayIP, Status, CreatedAt\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This maps to the GraphQL ",(0,r.jsx)(n.code,{children:"VirtualInterface"})," type in ",(0,r.jsx)(n.code,{children:"schema/services/services-isolation.graphql"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"isolation-verification",children:"Isolation Verification"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"apps/backend/internal/orchestrator/isolation/isolation_verifier.go"})," periodically verifies that isolation rules are correctly applied. If verification fails (e.g., bridge membership mismatch), it triggers automatic reapplication and emits an alert event."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["API client details: ",(0,r.jsx)(n.code,{children:"libs/features/docs/api-client-and-graphql.md"})]}),"\n",(0,r.jsxs)(n.li,{children:["State management (Zustand stores, XState machines): ",(0,r.jsx)(n.code,{children:"libs/features/docs/state-management.md"})]}),"\n",(0,r.jsxs)(n.li,{children:["Backend architecture: ",(0,r.jsx)(n.code,{children:"Docs/architecture/backend-architecture.md"})]}),"\n",(0,r.jsxs)(n.li,{children:["Novel patterns (VIF, Safety Pipeline, etc.): ",(0,r.jsx)(n.code,{children:"Docs/architecture/novel-pattern-designs.md"})]}),"\n",(0,r.jsxs)(n.li,{children:["Universal State v2 resource model: ",(0,r.jsx)(n.code,{children:"Docs/architecture/data-architecture.md"})]}),"\n",(0,r.jsxs)(n.li,{children:["ADR-012 (Universal State v2): ",(0,r.jsx)(n.code,{children:"Docs/architecture/adrs/012-universal-state-v2.md"})]}),"\n",(0,r.jsxs)(n.li,{children:["ADR-017 (Three-Layer Component Architecture): ",(0,r.jsx)(n.code,{children:"Docs/architecture/adrs/017-three-layer-component-architecture.md"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},71184:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>l});var s=i(14041);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);