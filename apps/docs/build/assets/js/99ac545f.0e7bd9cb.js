"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[32235],{71184:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>o});var i=r(14041);const s={},c=i.createContext(s);function d(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),i.createElement(c.Provider,{value:n},e.children)}},89158:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>a,frontMatter:()=>d,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"provisioning-engine","title":"Provisioning Engine","description":"Translates a wizard-configured StarState into live RouterOS configuration via an 8-phase ordered pipeline with per-step rollback.","source":"@site/../backend/docs/provisioning-engine.md","sourceDirName":".","slug":"/provisioning-engine","permalink":"/docs/backend/provisioning-engine","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/provisioning-engine.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Process Isolation","permalink":"/docs/backend/process-isolation"},"next":{"title":"Router Communication","permalink":"/docs/backend/router-communication"}}');var s=r(31085),c=r(71184);const d={},o="Provisioning Engine",t={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>orchestrator</code> \u2014 8-Phase Pipeline",id:"orchestrator--8-phase-pipeline",level:3},{value:"Phase Definitions",id:"phase-definitions",level:4},{value:"Key Types",id:"key-types",level:4},{value:"Rollback",id:"rollback",level:4},{value:"<code>types</code> \u2014 Provisioning State Model",id:"types--provisioning-state-model",level:3},{value:"WAN Types (<code>wan.go</code>)",id:"wan-types-wango",level:4},{value:"VPN Client Types (<code>vpnclient.go</code>)",id:"vpn-client-types-vpnclientgo",level:4},{value:"VPN Server Types (<code>vpnserver.go</code>)",id:"vpn-server-types-vpnservergo",level:4},{value:"LAN Types (<code>lan.go</code>)",id:"lan-types-lango",level:4},{value:"Extra Config (<code>extra.go</code>)",id:"extra-config-extrago",level:4},{value:"<code>network</code> \u2014 LAN Network Provisioning",id:"network--lan-network-provisioning",level:3},{value:"<code>vpnclient</code> \u2014 VPN Client Provisioning",id:"vpnclient--vpn-client-provisioning",level:3},{value:"<code>wan</code> \u2014 WAN Link Provisioning",id:"wan--wan-link-provisioning",level:3},{value:"<code>services/provisioning</code> \u2014 Session Coordinator",id:"servicesprovisioning--session-coordinator",level:3},{value:"Session Lifecycle",id:"session-lifecycle",level:4},{value:"Resource Dispatch (<code>apply.go</code>)",id:"resource-dispatch-applygo",level:4},{value:"Data Flow",id:"data-flow",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Cross-References",id:"cross-references",level:2}];function h(e){const n={blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"provisioning-engine",children:"Provisioning Engine"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Translates a wizard-configured ",(0,s.jsx)(n.code,{children:"StarState"})," into live RouterOS configuration via an 8-phase ordered pipeline with per-step rollback."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Packages:"})," ",(0,s.jsx)(n.code,{children:"internal/provisioning/orchestrator/"}),", ",(0,s.jsx)(n.code,{children:"internal/provisioning/types/"}),", ",(0,s.jsx)(n.code,{children:"internal/provisioning/network/"}),", ",(0,s.jsx)(n.code,{children:"internal/provisioning/vpnclient/"}),", ",(0,s.jsx)(n.code,{children:"internal/provisioning/vpnserver/"}),", ",(0,s.jsx)(n.code,{children:"internal/provisioning/wan/"}),", ",(0,s.jsx)(n.code,{children:"internal/services/provisioning/"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"orchestrator/phases.go"}),", ",(0,s.jsx)(n.code,{children:"orchestrator/rollback.go"}),", ",(0,s.jsx)(n.code,{children:"services/provisioning/service.go"}),", ",(0,s.jsx)(n.code,{children:"services/provisioning/apply.go"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Prerequisites:"})," [See: 04-router-communication.md], [See: 05-event-system.md]"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["The provisioning engine transforms an abstract wizard configuration (",(0,s.jsx)(n.code,{children:"StarState"}),") into concrete MikroTik RouterOS commands. It is the core mechanism used by the setup wizard to configure a router from scratch."]}),"\n",(0,s.jsx)(n.p,{children:"Key design principles:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Phase ordering"})," \u2014 resources are created in dependency order (interfaces before addresses, addresses before DHCP)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Comment tagging"})," \u2014 every created resource is tagged ",(0,s.jsx)(n.code,{children:"nnc-provisioned-<sessionID>"})," for idempotent cleanup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rollback on failure"})," \u2014 phases 8\u21921 are rolled back in reverse order if any phase fails"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Protocol dispatch"})," \u2014 VPN protocols are handled by dedicated sub-services; generic RouterOS paths use the flat orchestrator"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["services/provisioning.Service"]\n    A1["Session Draft"]\n    A2["ValidateSession"]\n    A3["ApplySession<br/>dispatch loop"]\n\n    A --\x3e A1 --\x3e A2 --\x3e A3\n\n    A3 --\x3e B["wan.Service<br/>WAN links"]\n    A3 --\x3e C["vpnclient.Service<br/>6 VPN protocols"]\n    A3 --\x3e D["orchestrator.Orchestrator<br/>8-phase flat"]\n\n    D --\x3e D1["Phase 1: Interface Setup"]\n    D --\x3e D2["Phase 2: Tunnel Peers"]\n    D --\x3e D3["Phase 3: IP Address Pools"]\n    D --\x3e D4["Phase 4: PPP/VPN Servers"]\n    D --\x3e D5["Phase 5: DHCP Networking"]\n    D --\x3e D6["Phase 6: Routing"]\n    D --\x3e D7["Phase 7: Firewall"]\n    D --\x3e D8["Phase 8: System/DNS"]'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,s.jsxs)(n.h3,{id:"orchestrator--8-phase-pipeline",children:[(0,s.jsx)(n.code,{children:"orchestrator"})," \u2014 8-Phase Pipeline"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"phases.go"}),", ",(0,s.jsx)(n.code,{children:"rollback.go"})]}),"\n",(0,s.jsx)(n.h4,{id:"phase-definitions",children:"Phase Definitions"}),"\n",(0,s.jsxs)(n.p,{children:["Eight phases are executed in strict dependency order (defined in ",(0,s.jsx)(n.code,{children:"phases.go"}),"):"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"#"}),(0,s.jsx)(n.th,{children:"Constant"}),(0,s.jsx)(n.th,{children:"RouterOS Paths"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseInterfaceSetup"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/interface/bridge"}),", ",(0,s.jsx)(n.code,{children:"/interface/wireguard"}),", ",(0,s.jsx)(n.code,{children:"/interface/pppoe-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/l2tp-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/sstp-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/pptp-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/ovpn-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/wifi/*"}),", ",(0,s.jsx)(n.code,{children:"/interface/ipip"}),", ",(0,s.jsx)(n.code,{children:"/interface/eoip"}),", ",(0,s.jsx)(n.code,{children:"/interface/gre"}),", ",(0,s.jsx)(n.code,{children:"/interface/vxlan"}),", ",(0,s.jsx)(n.code,{children:"/interface/vlan"}),", ",(0,s.jsx)(n.code,{children:"/interface/macvlan"}),", ",(0,s.jsx)(n.code,{children:"/interface/lte"}),", ",(0,s.jsx)(n.code,{children:"/interface/list"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseTunnelPeers"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/interface/wireguard/peers"}),", ",(0,s.jsx)(n.code,{children:"/ip/ipsec/profile"}),", ",(0,s.jsx)(n.code,{children:"/ip/ipsec/peer"}),", ",(0,s.jsx)(n.code,{children:"/ip/ipsec/proposal"}),", ",(0,s.jsx)(n.code,{children:"/ip/ipsec/mode-config"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseIPAddressPools"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/ip/pool"}),", ",(0,s.jsx)(n.code,{children:"/ip/address"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"4"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhasePPPVPNServers"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/ppp/profile"}),", ",(0,s.jsx)(n.code,{children:"/ppp/secret"}),", ",(0,s.jsx)(n.code,{children:"/interface/pptp-server"}),", ",(0,s.jsx)(n.code,{children:"/interface/l2tp-server"}),", ",(0,s.jsx)(n.code,{children:"/interface/sstp-server"}),", ",(0,s.jsx)(n.code,{children:"/interface/ovpn-server"}),", ",(0,s.jsx)(n.code,{children:"/ip/ipsec/identity"}),", ",(0,s.jsx)(n.code,{children:"/ip/ipsec/policy"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"5"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseDHCPNetworking"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/interface/wifi/provisioning"}),", ",(0,s.jsx)(n.code,{children:"/ip/dhcp-server/network"}),", ",(0,s.jsx)(n.code,{children:"/ip/dhcp-server"}),", ",(0,s.jsx)(n.code,{children:"/ip/dhcp-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/bridge/port"}),", ",(0,s.jsx)(n.code,{children:"/interface/list/member"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"6"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseRouting"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/routing/table"}),", ",(0,s.jsx)(n.code,{children:"/ip/route"}),", ",(0,s.jsx)(n.code,{children:"/routing/rule"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"7"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseFirewall"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/ip/firewall/address-list"}),", ",(0,s.jsx)(n.code,{children:"/ip/firewall/mangle"}),", ",(0,s.jsx)(n.code,{children:"/ip/firewall/nat"}),", ",(0,s.jsx)(n.code,{children:"/ip/firewall/filter"}),", ",(0,s.jsx)(n.code,{children:"/ip/firewall/raw"}),", ",(0,s.jsx)(n.code,{children:"/ip/upnp/interfaces"}),", ",(0,s.jsx)(n.code,{children:"/ip/nat-pmp/interfaces"}),", ",(0,s.jsx)(n.code,{children:"/ip/upnp"}),", ",(0,s.jsx)(n.code,{children:"/ip/nat-pmp"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"8"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PhaseSystemDNS"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"/ip/dns"}),", ",(0,s.jsx)(n.code,{children:"/system/identity"}),", ",(0,s.jsx)(n.code,{children:"/system/ntp/client"}),", ",(0,s.jsx)(n.code,{children:"/system/scheduler"}),", ",(0,s.jsx)(n.code,{children:"/system/script"}),", ",(0,s.jsx)(n.code,{children:"/system/logging"}),", ",(0,s.jsx)(n.code,{children:"/ip/service"}),", ",(0,s.jsx)(n.code,{children:"/ip/cloud"}),", ",(0,s.jsx)(n.code,{children:"/certificate"}),", and more"]})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"key-types",children:"Key Types"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Phase is the numeric identifier for a pipeline step.\ntype Phase int\n\n// PhaseDefinition describes a phase with its RouterOS paths.\ntype PhaseDefinition struct {\n    Phase       Phase\n    Name        string\n    Description string\n    Paths       []string  // RouterOS API paths this phase owns\n}\n\n// ClassifyResourcePath maps a RouterOS path to its phase using longest-prefix matching.\nfunc ClassifyResourcePath(path string) Phase\n\n// PhaseOrder returns all 8 phases in canonical execution order.\nfunc PhaseOrder() []Phase\n"})}),"\n",(0,s.jsx)(n.h4,{id:"rollback",children:"Rollback"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// RollbackResult summarizes a rollback operation.\ntype RollbackResult struct {\n    TotalResources int\n    Removed        int\n    Failed         int\n    Errors         []RollbackError\n}\n\n// Rollback removes resources in reverse phase order (8\u21921), within each phase\n// in reverse creation order. Only "add" resources can be removed; "set" resources\n// are skipped. Best-effort: all resources are attempted even if some fail.\nfunc (o *Orchestrator) Rollback(ctx context.Context, results []PhaseResult) *RollbackResult\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"types--provisioning-state-model",children:[(0,s.jsx)(n.code,{children:"types"})," \u2014 Provisioning State Model"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"state.go"}),", ",(0,s.jsx)(n.code,{children:"wan.go"}),", ",(0,s.jsx)(n.code,{children:"vpnclient.go"}),", ",(0,s.jsx)(n.code,{children:"vpnserver.go"}),", ",(0,s.jsx)(n.code,{children:"lan.go"}),", ",(0,s.jsx)(n.code,{children:"extra.go"})]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"StarState"})," is the top-level struct that aggregates all wizard sections:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type StarState struct {\n    Choose     ChooseState            `json:"choose"`    // Mode, firmware, WAN type\n    WAN        WANState               `json:"wan"`       // WAN links, VPN clients, DNS\n    LAN        *LANState              `json:"lan"`       // Wireless, VPN server, subnets\n    Extra      *ExtraConfigState      `json:"extra"`     // Identity, NTP, certificates, etc.\n    ShowConfig map[string]interface{} `json:"showConfig"`\n}\n'})}),"\n",(0,s.jsxs)(n.h4,{id:"wan-types-wango",children:["WAN Types (",(0,s.jsx)(n.code,{children:"wan.go"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type WANState struct {\n    WANLink   WANLinks   // Domestic + Foreign WAN link groups\n    VPNClient *VPNClient // WAN-side VPN clients\n    DNSConfig *DNSConfig // Per-network DNS configuration\n}\n\ntype WANLinkConfig struct {\n    Name             string\n    InterfaceConfig  InterfaceConfig   // Physical interface, VLAN, MAC\n    ConnectionConfig *ConnectionConfig // DHCP / PPPoE / Static / LTE\n    Priority         *int\n    Weight           *int\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Connection types: ",(0,s.jsx)(n.code,{children:"IsDHCP"}),", ",(0,s.jsx)(n.code,{children:"PPPoE"})," (",(0,s.jsx)(n.code,{children:"PPPoEConfig"}),"), ",(0,s.jsx)(n.code,{children:"Static"})," (",(0,s.jsx)(n.code,{children:"StaticIPConfig"}),"), ",(0,s.jsx)(n.code,{children:"LTESettings"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"vpn-client-types-vpnclientgo",children:["VPN Client Types (",(0,s.jsx)(n.code,{children:"vpnclient.go"}),")"]}),"\n",(0,s.jsxs)(n.p,{children:["All VPN client configs embed ",(0,s.jsx)(n.code,{children:"BaseVPNClientConfig"})," (name, priority, weight, WAN interface):"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Protocol"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WireguardClientConfig"})}),(0,s.jsx)(n.td,{children:"WireGuard (interface private key, peer public key, endpoint, allowed IPs)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenVpnClientConfig"})}),(0,s.jsx)(n.td,{children:"OpenVPN (server, mode, protocol, auth, cipher, certificates)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PptpClientConfig"})}),(0,s.jsx)(n.td,{children:"PPTP (server, credentials, auth method)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"L2tpClientConfig"})}),(0,s.jsx)(n.td,{children:"L2TP (server, IPsec, auth, fast-path)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"SstpClientConfig"})}),(0,s.jsx)(n.td,{children:"SSTP (server, TLS, proxy, SNI, PFS)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Ike2ClientConfig"})}),(0,s.jsx)(n.td,{children:"IKEv2/IPsec (profile, proposal, mode-config, policy, certificates)"})]})]})]}),"\n",(0,s.jsxs)(n.h4,{id:"vpn-server-types-vpnservergo",children:["VPN Server Types (",(0,s.jsx)(n.code,{children:"vpnserver.go"}),")"]}),"\n",(0,s.jsxs)(n.p,{children:["All VPN server configs embed ",(0,s.jsx)(n.code,{children:"BaseVPNServerConfig"})," (enabled, profile, network):"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Protocol"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"PptpServerConfig"})}),(0,s.jsx)(n.td,{children:"PPTP server"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"L2tpServerConfig"})}),(0,s.jsx)(n.td,{children:"L2TP server (IPsec, L2TPv3 support)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"SstpServerConfig"})}),(0,s.jsx)(n.td,{children:"SSTP server (certificate, TLS)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"OpenVpnServerConfig"})}),(0,s.jsx)(n.td,{children:"OpenVPN server (protocol, cipher, certificates)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Ike2ServerConfig"})}),(0,s.jsx)(n.td,{children:"IKEv2 server (IPsec profile/proposal/identity/policy-group)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WireguardServerConfig"})}),(0,s.jsx)(n.td,{children:"WireGuard server (interface + peers list)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Socks5ServerConfig"})}),(0,s.jsx)(n.td,{children:"SOCKS5 proxy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"SSHServerConfig"})}),(0,s.jsx)(n.td,{children:"SSH server"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"HTTPProxyServerConfig"})}),(0,s.jsx)(n.td,{children:"HTTP proxy"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"BackToHomeServerConfig"})}),(0,s.jsx)(n.td,{children:"Back-to-home routing"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ZeroTierServerConfig"})}),(0,s.jsx)(n.td,{children:"ZeroTier overlay"})]})]})]}),"\n",(0,s.jsxs)(n.h4,{id:"lan-types-lango",children:["LAN Types (",(0,s.jsx)(n.code,{children:"lan.go"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type LANState struct {\n    Wireless  []WirelessConfig          // WiFi networks with target network assignment\n    VPNServer *VPNServer                // All VPN server configs\n    Tunnel    *Tunnel                   // IPIP/EoIP/GRE/VXLAN tunnels\n    Interface []EthernetInterfaceConfig // Physical port \u2192 bridge mapping\n    Subnets   *Subnets                  // Per-network subnet allocations\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["WiFi targets: ",(0,s.jsx)(n.code,{children:"Domestic"}),", ",(0,s.jsx)(n.code,{children:"Foreign"}),", ",(0,s.jsx)(n.code,{children:"VPN"}),", ",(0,s.jsx)(n.code,{children:"Split"}),", ",(0,s.jsx)(n.code,{children:"SingleDomestic"}),", ",(0,s.jsx)(n.code,{children:"SingleForeign"}),", ",(0,s.jsx)(n.code,{children:"SingleVPN"}),"."]}),"\n",(0,s.jsxs)(n.h4,{id:"extra-config-extrago",children:["Extra Config (",(0,s.jsx)(n.code,{children:"extra.go"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type ExtraConfigState struct {\n    RouterIdentity *RouterIdentityRomon  // Router name, RoMON\n    ServiceConfig  *ServiceConfig        // API/SSH/Telnet/Winbox ports\n    RUIConfig      *RUIConfig            // RouterOS UI, timezone, schedules\n    CertificateConfig *CertificateConfig // Self-signed or Let's Encrypt\n    NTPConfig      *NTPConfig            // NTP servers\n    GraphingConfig *GraphingConfig       // Bandwidth/resource graphing\n    CloudDDNSConfig *CloudDDNSConfig     // DDNS entries\n    UPNPConfig     *UPNPConfig           // UPnP configuration\n    NATPMPConfig   *NATPMPConfig         // NAT-PMP configuration\n    UsefulServices *UsefulServicesConfig // SMTP/DNS/DHCP relay, proxy\n    Games          []GameConfigEntry     // Game-specific port forwarding\n}\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"network--lan-network-provisioning",children:[(0,s.jsx)(n.code,{children:"network"})," \u2014 LAN Network Provisioning"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"addresslist.go"}),", ",(0,s.jsx)(n.code,{children:"mangle.go"})]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"network.Service"})," implements LAN-side provisioning (bridge, DHCP, address lists, mangle rules) for the four-network architecture (Domestic / Foreign / VPN / Split)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// createAddressListEntries creates a firewall address list entry for a network.\nfunc (s *Service) createAddressListEntries(ctx, networkName, address, comment string) ([]string, error)\n\n// createMangleRules creates prerouting mangle rules for policy-based routing.\n// Each rule marks traffic from srcAddress with "to-<networkName>" routing mark.\nfunc (s *Service) createMangleRules(ctx, srcAddress, networkName, comment string) ([]string, error)\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"MangleRuleConfig"})})," fields: ",(0,s.jsx)(n.code,{children:"Chain"}),", ",(0,s.jsx)(n.code,{children:"SrcAddress"}),", ",(0,s.jsx)(n.code,{children:"DstAddress"}),", ",(0,s.jsx)(n.code,{children:"InInterface"}),", ",(0,s.jsx)(n.code,{children:"OutInterface"}),", ",(0,s.jsx)(n.code,{children:"Action"})," (",(0,s.jsx)(n.code,{children:"mark-routing"}),", ",(0,s.jsx)(n.code,{children:"mark-connection"}),", ",(0,s.jsx)(n.code,{children:"mark-packet"}),"), ",(0,s.jsx)(n.code,{children:"NewRoutingMark"}),", ",(0,s.jsx)(n.code,{children:"Passthrough"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Cleanup uses comment-based removal (",(0,s.jsx)(n.code,{children:"removeByComment"}),") for idempotency."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"vpnclient--vpn-client-provisioning",children:[(0,s.jsx)(n.code,{children:"vpnclient"})," \u2014 VPN Client Provisioning"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"service.go"}),", ",(0,s.jsx)(n.code,{children:"wireguard.go"}),", ",(0,s.jsx)(n.code,{children:"ikev2.go"}),", ",(0,s.jsx)(n.code,{children:"openvpn.go"}),", ",(0,s.jsx)(n.code,{children:"l2tp.go"}),", ",(0,s.jsx)(n.code,{children:"pptp.go"}),", ",(0,s.jsx)(n.code,{children:"sstp.go"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Service handles VPN client provisioning.\ntype Service struct {\n    routerPort router.RouterPort\n    eventBus   events.EventBus\n    publisher  *events.Publisher\n    logger     *zap.SugaredLogger\n}\n\n// ProvisionResult holds provisioned resource IDs and generated fields.\ntype ProvisionResult struct {\n    RouterResourceIDs map[string]string // path \u2192 RouterOS .id\n    InterfaceName     string            // Final interface name\n    GeneratedFields   map[string]string // Router-generated values (e.g., WireGuard public key)\n}\n\n// ProvisionVPNClient dispatches to the appropriate protocol provisioner.\nfunc (s *Service) ProvisionVPNClient(ctx, routerID, sessionID string, vpnClient types.VPNClient) ([]*ProvisionResult, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"WireGuard provisioning"})," (6 ordered steps in ",(0,s.jsx)(n.code,{children:"wireguard.go"}),"):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'Step 1: /interface/wireguard          \u2190 Create WireGuard interface (private key, listen port)\nStep 2: /interface/wireguard/peers    \u2190 Create peer (public key, endpoint, allowed IPs, keepalive=25s)\nStep 3: /ip/address                   \u2190 Assign tunnel IP address\nStep 4: /interface/list/member        \u2190 Add to "VPN-WAN" interface list (non-critical)\nStep 5: /routing/table + /ip/route    \u2190 Create "to-VPN-<name>" routing table + default route\nStep 6: /ip/firewall/address-list     \u2190 Add endpoint to "VPNE" list (prevents routing loop)\nConfirm: /interface/wireguard print   \u2190 Read back router-generated public key\n'})}),"\n",(0,s.jsxs)(n.p,{children:["On any step failure, ",(0,s.jsx)(n.code,{children:"rollbackWireGuard"})," calls ",(0,s.jsx)(n.code,{children:"RemoveVPNClient"})," which removes resources in reverse path order."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"RemoveVPNClient"})})," removal order (reverse of creation):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/ip/firewall/address-list \u2192 /ip/route \u2192 /routing/table \u2192 /interface/list/member \u2192\n/ip/address \u2192 /interface/wireguard/peers \u2192 /interface/wireguard \u2192\n/interface/ovpn-client \u2192 /interface/pptp-client \u2192 /interface/l2tp-client \u2192\n/interface/sstp-client \u2192 /ip/ipsec/policy \u2192 /ip/ipsec/identity \u2192\n/ip/ipsec/peer \u2192 /ip/ipsec/mode-config \u2192 /ip/ipsec/proposal \u2192 /ip/ipsec/profile\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"wan--wan-link-provisioning",children:[(0,s.jsx)(n.code,{children:"wan"})," \u2014 WAN Link Provisioning"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"service.go"}),", ",(0,s.jsx)(n.code,{children:"dhcp_client.go"}),", ",(0,s.jsx)(n.code,{children:"pppoe.go"}),", ",(0,s.jsx)(n.code,{children:"static.go"}),", ",(0,s.jsx)(n.code,{children:"lte.go"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Service handles WAN link provisioning.\ntype Service struct {\n    routerPort router.RouterPort\n    eventBus   events.EventBus\n    logger     *zap.SugaredLogger\n}\n\n// ProvisionResult tracks what was created for a WAN link.\ntype ProvisionResult struct {\n    InterfaceID   string // PPPoE/LTE interface .id\n    DHCPClientID  string // DHCP client .id\n    IPAddressID   string // Static IP address .id\n    RouteID       string // Default route .id\n    InterfaceName string // Final interface name\n}\n\n// ProvisionWANLink configures a WAN link in 3 steps:\n//  1. Create VLAN/MACVLAN virtual interfaces if needed\n//  2. Add final interface to WAN interface list\n//  3. Configure connection (DHCP/PPPoE/Static/LTE)\nfunc (s *Service) ProvisionWANLink(ctx, routerID, sessionID string, link types.WANLinkConfig, networkType string) (*ProvisionResult, error)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Connection dispatch:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"IsDHCP == true"})," \u2192 ",(0,s.jsx)(n.code,{children:"provisionDHCP"})," (creates ",(0,s.jsx)(n.code,{children:"/ip/dhcp-client"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"PPPoE != nil"})," \u2192 ",(0,s.jsx)(n.code,{children:"provisionPPPoE"})," (creates ",(0,s.jsx)(n.code,{children:"/interface/pppoe-client"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Static != nil"})," \u2192 ",(0,s.jsx)(n.code,{children:"provisionStatic"})," (creates ",(0,s.jsx)(n.code,{children:"/ip/address"})," + ",(0,s.jsx)(n.code,{children:"/ip/route"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LTESettings != nil"})," \u2192 ",(0,s.jsx)(n.code,{children:"provisionLTE"})," (creates LTE APN profile + activates interface)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"RemoveWANLink"})})," uses comment-based removal across: ",(0,s.jsx)(n.code,{children:"/ip/dhcp-client"}),", ",(0,s.jsx)(n.code,{children:"/interface/pppoe-client"}),", ",(0,s.jsx)(n.code,{children:"/ip/address"}),", ",(0,s.jsx)(n.code,{children:"/ip/route"}),", ",(0,s.jsx)(n.code,{children:"/interface/lte/apn"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h3,{id:"servicesprovisioning--session-coordinator",children:[(0,s.jsx)(n.code,{children:"services/provisioning"})," \u2014 Session Coordinator"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Key Files:"})," ",(0,s.jsx)(n.code,{children:"service.go"}),", ",(0,s.jsx)(n.code,{children:"apply.go"}),", ",(0,s.jsx)(n.code,{children:"import.go"}),", ",(0,s.jsx)(n.code,{children:"decompose_vpnclient.go"})]}),"\n",(0,s.jsxs)(n.p,{children:["The top-level ",(0,s.jsx)(n.code,{children:"Service"})," manages provisioning sessions and coordinates all sub-services."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// Service coordinates all provisioning sub-services.\ntype Service struct {\n    orchestrator  *orchestrator.Orchestrator\n    vpnClientSvc  *vpnclient.Service\n    vpnServerSvc  *vpnserver.Service\n    multiWANSvc   *multiwan.Service\n    networkSvc    *network.Service\n    wanSvc        *wan.Service\n    baseConfigSvc *baseconfig.Service\n    securitySvc   *security.Service\n    domesticIPSvc *domesticips.Service\n    certSvc       *certificate.Service\n    wifiSvc       *wifi.Service\n    trunkSvc      *trunk.Service\n    sessions      map[string]*Session  // In-memory session store\n    // ...\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"session-lifecycle",children:"Session Lifecycle"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph LR\n    A["Draft"]\n    B["Validated"]\n    C["Applying"]\n    D["Applied"]\n    E["Failed"]\n\n    A --\x3e|ValidateSession| B\n    B --\x3e|ApplySession| C\n    C --\x3e|Success| D\n    C --\x3e|Failure| E'}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// ValidateSession checks all session resources for config problems.\n// Transitions Draft \u2192 Validated if no blocking errors.\nfunc (s *Service) ValidateSession(ctx, sessionID string) ([]ValidationIssue, error)\n\n// ApplySession provisions all validated resources.\n// Transitions Validated \u2192 Applying \u2192 Applied | Failed.\nfunc (s *Service) ApplySession(ctx, sessionID string) error\n"})}),"\n",(0,s.jsxs)(n.h4,{id:"resource-dispatch-applygo",children:["Resource Dispatch (",(0,s.jsx)(n.code,{children:"apply.go"}),")"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"ApplySession"})," iterates resources and dispatches by ",(0,s.jsx)(n.code,{children:"ResourceType"})," prefix:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Resource Type Pattern"}),(0,s.jsx)(n.th,{children:"Dispatched To"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"wan.link.*"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchWANLink"})," \u2192 ",(0,s.jsx)(n.code,{children:"wan.Service.ProvisionWANLink"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"vpn.*.client"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchVPNClient"})," \u2192 ",(0,s.jsx)(n.code,{children:"vpnclient.Service.Provision*"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"vpn.*.server"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchVPNServer"})," \u2192 ",(0,s.jsx)(n.code,{children:"vpnserver.Service.Provision*"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"wan.multilink.*"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchMultiWAN"})," \u2192 ",(0,s.jsx)(n.code,{children:"multiwan.Service.ProvisionMultiWAN"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system.baseconfig"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchBaseConfig"})," \u2192 ",(0,s.jsx)(n.code,{children:"baseconfig.Service.Provision"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system.security"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchSecurity"})," \u2192 ",(0,s.jsx)(n.code,{children:"security.Service.Provision"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system.certificate"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchCertificate"})," \u2192 ",(0,s.jsx)(n.code,{children:"certificate.Service.Provision*"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system.domesticips"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchDomesticIPs"})," \u2192 ",(0,s.jsx)(n.code,{children:"domesticips.Service.Provision"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system.wireless.*"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchWifi"})," \u2192 ",(0,s.jsx)(n.code,{children:"wifi.Service.ProvisionMasterAP"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"lan.network.*"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"dispatchNetwork"})," \u2192 ",(0,s.jsx)(n.code,{children:"network.Service.ProvisionNetwork"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.em,{children:"all others"})}),(0,s.jsxs)(n.td,{children:["Flat orchestrator via ",(0,s.jsx)(n.code,{children:"sessionResourcesToProvisioningResources"})]})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["VPN server protocol dispatch in ",(0,s.jsx)(n.code,{children:"dispatchVPNServer"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Protocol"}),(0,s.jsx)(n.th,{children:"Provisioner"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"wireguard"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionWireGuardServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pptp"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionPPTPServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"l2tp"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionL2TPServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"sstp"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionSSTServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"openvpn"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionOpenVPNServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ikev2"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionIKEv2Server"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"socks5"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionSocks5Server"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ssh"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionSSHServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"httpproxy"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionHTTPProxyServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"backtohome"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionBackToHomeServer"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"zerotier"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ProvisionZeroTierServer"})})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TD\n    A["1. Wizard UI creates StarState<br/>JSON"]\n    A --\x3e B["2. Import service decomposes<br/>StarState into typed SessionResources"]\n    B --\x3e C["3. Service.CreateSession<br/>status: Draft"]\n    C --\x3e D["4. Service.ValidateSession<br/>\u2192 ValidationIssues<br/>status: Validated"]\n    D --\x3e E["5. Service.ApplySession<br/>status: Applying"]\n\n    E --\x3e E1["Typed resources<br/>\u2192 Sub-services<br/>WAN/VPN/WiFi/Network<br/>Each sub-service<br/>\u2192 RouterPort.ExecuteCommand<br/>On failure<br/>\u2192 sub-service rollback"]\n\n    E --\x3e E2["Simple resources<br/>\u2192 orchestrator.Provision<br/>8-phase flat<br/>Phase 1 \u2192 Phase 8 in order<br/>On phase failure<br/>\u2192 orchestrator.Rollback<br/>phases 8\u21921"]\n\n    E --\x3e F["6. Events:<br/>ProvisioningSessionAppliedEvent<br/>ProvisioningSessionFailedEvent"]\n    F --\x3e G["7. Status: Applied | Failed"]'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["All provisioned resources are tagged with comment ",(0,s.jsx)(n.code,{children:"nnc-provisioned-<sessionID>"}),". This enables:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Idempotent cleanup"})," via ",(0,s.jsx)(n.code,{children:"removeByComment"})," without needing stored IDs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Session-scoped removal"})," for rollback and re-provisioning"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Audit visibility"})," in RouterOS resource lists"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Scenario"}),(0,s.jsx)(n.th,{children:"Behavior"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Step failure in WireGuard"}),(0,s.jsxs)(n.td,{children:["Rollback all steps created so far in ",(0,s.jsx)(n.code,{children:"rollbackWireGuard"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Phase failure in flat orchestrator"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Rollback(results)"})," removes phases 8\u21921 in reverse"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Sub-service dispatch failure"}),(0,s.jsxs)(n.td,{children:["Session transitions to ",(0,s.jsx)(n.code,{children:"Failed"}),", event published"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Non-critical failure (interface list)"}),(0,s.jsx)(n.td,{children:"Logged as warning, provisioning continues"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Context cancellation"}),(0,s.jsx)(n.td,{children:"Propagated through all RouterOS commands"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Comment-based removal failure"}),(0,s.jsx)(n.td,{children:"Logged as warning, best-effort cleanup continues"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Integration tests exist in ",(0,s.jsx)(n.code,{children:"internal/config/integration_test.go"})," (uses CHR Docker for router simulation)"]}),"\n",(0,s.jsxs)(n.li,{children:["WAN provisioning: test ",(0,s.jsx)(n.code,{children:"provisionDHCP"}),", ",(0,s.jsx)(n.code,{children:"provisionPPPoE"}),", ",(0,s.jsx)(n.code,{children:"provisionStatic"})," with mock ",(0,s.jsx)(n.code,{children:"RouterPort"})]}),"\n",(0,s.jsxs)(n.li,{children:["Orchestrator: verify phase classification via ",(0,s.jsx)(n.code,{children:"ClassifyResourcePath"}),"; test rollback ordering"]}),"\n",(0,s.jsxs)(n.li,{children:["VPN client: mock ",(0,s.jsx)(n.code,{children:"RouterPort.ExecuteCommand"})," to return resource IDs; verify 6-step WireGuard sequence"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["[See: 04-router-communication.md \xa7RouterPort] \u2014 ",(0,s.jsx)(n.code,{children:"router.RouterPort"})," interface used by all provisioners"]}),"\n",(0,s.jsxs)(n.li,{children:["[See: 05-event-system.md \xa7Events] \u2014 ",(0,s.jsx)(n.code,{children:"ProvisioningSessionAppliedEvent"}),", ",(0,s.jsx)(n.code,{children:"ProvisioningSessionFailedEvent"})]}),"\n",(0,s.jsx)(n.li,{children:"[See: 06-service-orchestrator.md] \u2014 Orchestrator lifecycle that calls provisioning during service install"}),"\n",(0,s.jsx)(n.li,{children:"[See: flows/04-config-provisioning-flow.md] \u2014 End-to-end provisioning flow diagram"}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);