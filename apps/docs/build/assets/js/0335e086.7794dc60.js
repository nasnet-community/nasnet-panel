"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[11537],{17400:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"authentication","title":"Authentication","description":"NasNetConnect uses two parallel authentication systems that operate independently: an Apollo auth link for GraphQL operations and an Axios interceptor for REST API calls. Both systems share the same JWT-first, Basic-fallback priority but differ in credential storage scope \u2014 the Apollo link uses per-router sessionStorage keys while the Axios interceptor uses a global localStorage key. Authentication for WebSocket subscriptions is handled separately via connectionParams on every connect/reconnect cycle.","source":"@site/../../libs/api-client/docs/authentication.md","sourceDirName":".","slug":"/authentication","permalink":"/docs/api-client/authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/api-client/docs/authentication.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Authentication"},"sidebar":"sidebar","previous":{"title":"Axios HTTP Client","permalink":"/docs/api-client/axios-http-client"},"next":{"title":"Error Handling","permalink":"/docs/api-client/error-handling"}}');var i=t(31085),s=t(71184);const o={sidebar_position:4,title:"Authentication"},c="Authentication",a={},l=[{value:"Overview",id:"overview",level:2},{value:"Apollo Authentication Link",id:"apollo-authentication-link",level:2},{value:"Exported Symbols",id:"exported-symbols",level:3},{value:"<code>authLink</code>",id:"authlink",level:4},{value:"<code>createAuthLink(getToken)</code>",id:"createauthlinkgettoken",level:4},{value:"Header Injection Logic",id:"header-injection-logic",level:3},{value:"JWT vs Basic Auth Priority",id:"jwt-vs-basic-auth-priority",level:3},{value:"Per-Router sessionStorage Credentials",id:"per-router-sessionstorage-credentials",level:3},{value:"Axios Authentication Interceptor",id:"axios-authentication-interceptor",level:2},{value:"Exported Symbols",id:"exported-symbols-1",level:3},{value:"<code>authInterceptor(config)</code>",id:"authinterceptorconfig",level:4},{value:"<code>storeCredentials(credentials)</code>",id:"storecredentialscredentials",level:4},{value:"<code>clearCredentials()</code>",id:"clearcredentials",level:4},{value:"Storage Comparison: Apollo vs Axios",id:"storage-comparison-apollo-vs-axios",level:3},{value:"WebSocket Authentication (connectionParams)",id:"websocket-authentication-connectionparams",level:2},{value:"connectionParams callback",id:"connectionparams-callback",level:3},{value:"WebSocket JWT vs Basic Priority",id:"websocket-jwt-vs-basic-priority",level:3},{value:"Authentication-Aware Retry",id:"authentication-aware-retry",level:3},{value:"Session Expiry Flow",id:"session-expiry-flow",level:2},{value:"Link Chain Position",id:"link-chain-position",level:2},{value:"See Also",id:"see-also",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"authentication",children:"Authentication"})}),"\n",(0,i.jsxs)(n.p,{children:["NasNetConnect uses two parallel authentication systems that operate independently: an ",(0,i.jsx)(n.strong,{children:"Apollo auth link"})," for GraphQL operations and an ",(0,i.jsx)(n.strong,{children:"Axios interceptor"})," for REST API calls. Both systems share the same JWT-first, Basic-fallback priority but differ in credential storage scope \u2014 the Apollo link uses per-router ",(0,i.jsx)(n.code,{children:"sessionStorage"})," keys while the Axios interceptor uses a global ",(0,i.jsx)(n.code,{children:"localStorage"})," key. Authentication for WebSocket subscriptions is handled separately via ",(0,i.jsx)(n.code,{children:"connectionParams"})," on every connect/reconnect cycle."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GraphQL (Apollo)                    REST (Axios)\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500              \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nuseQuery / useMutation              apiClient.get/post/...\n        \u2502                                   \u2502\n        \u25bc                                   \u25bc\n  apollo-auth-link                   authInterceptor\n  (setContext)                       (request interceptor)\n        \u2502                                   \u2502\n   JWT Bearer?  \u2500\u2500\u2500\u2500 yes \u2500\u2500\u2500\u25ba Bearer <token>\n        \u2502 no                                \u2502\n   Per-router creds                  Global localStorage\n   (sessionStorage)                  (nasnet:api:credentials)\n        \u2502                                   \u2502\n   Basic <b64>                       Basic <b64>\n        \u2502                                   \u2502\n        \u25bc                                   \u25bc\n   X-Router-Id header            Authorization header only\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"apollo-authentication-link",children:"Apollo Authentication Link"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-auth-link.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["The Apollo auth link runs as a ",(0,i.jsx)(n.code,{children:"setContext"})," link in the link chain, injecting two headers before every HTTP-transported GraphQL operation (queries and mutations; subscriptions use ",(0,i.jsx)(n.code,{children:"connectionParams"})," instead)."]}),"\n",(0,i.jsx)(n.h3,{id:"exported-symbols",children:"Exported Symbols"}),"\n",(0,i.jsx)(n.h4,{id:"authlink",children:(0,i.jsx)(n.code,{children:"authLink"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const authLink = setContext((_, { headers }) => {\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorizationHeader(currentRouterId);\n\n  return {\n    headers: {\n      ...headers,\n      'X-Router-Id': currentRouterId || '',\n      ...(authorization && { Authorization: authorization }),\n    },\n  };\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The singleton ",(0,i.jsx)(n.code,{children:"authLink"})," instance. This is what ",(0,i.jsx)(n.code,{children:"apollo-client.ts"})," wires into the link chain:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// From core/src/apollo/apollo-client.ts:59\nauthLink.concat(httpLink)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["It reads ",(0,i.jsx)(n.code,{children:"currentRouterId"})," from the Zustand ",(0,i.jsx)(n.code,{children:"useConnectionStore"})," on every request, ensuring multi-router scenarios always attach the correct context header."]}),"\n",(0,i.jsx)(n.h4,{id:"createauthlinkgettoken",children:(0,i.jsx)(n.code,{children:"createAuthLink(getToken)"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function createAuthLink(getToken: () => string | null)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Factory variant for tests or embedded use cases where JWT retrieval needs custom logic. Accepts a ",(0,i.jsx)(n.code,{children:"getToken"})," callback and builds an equivalent ",(0,i.jsx)(n.code,{children:"setContext"})," link. The ",(0,i.jsx)(n.code,{children:"X-Router-Id"})," header is still sourced from ",(0,i.jsx)(n.code,{children:"useConnectionStore"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"header-injection-logic",children:"Header Injection Logic"}),"\n",(0,i.jsx)(n.p,{children:"Two headers are injected:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Header"}),(0,i.jsx)(n.th,{children:"Value"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"X-Router-Id"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"currentRouterId"})," or ",(0,i.jsx)(n.code,{children:"''"})]}),(0,i.jsx)(n.td,{children:"Backend routes the request to the correct MikroTik connection"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Authorization"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Bearer <jwt>"})," or ",(0,i.jsx)(n.code,{children:"Basic <b64>"})]}),(0,i.jsx)(n.td,{children:"Authenticates the request"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"jwt-vs-basic-auth-priority",children:"JWT vs Basic Auth Priority"}),"\n",(0,i.jsxs)(n.p,{children:["The function ",(0,i.jsx)(n.code,{children:"getAuthorizationHeader(routerId)"})," implements a deterministic two-step priority:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// core/src/apollo/apollo-auth-link.ts:54\nfunction getAuthorizationHeader(routerId: string | null): string | undefined {\n  // 1. JWT from auth store takes priority\n  const jwtToken = getAuthToken();\n  if (jwtToken) {\n    return `Bearer ${jwtToken}`;\n  }\n\n  // 2. Fall back to per-router Basic auth\n  const credentials = getStoredCredentials(routerId);\n  if (credentials) {\n    return `Basic ${btoa(`${credentials.username}:${credentials.password}`)}`;\n  }\n\n  return undefined;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Step 1 \u2014 JWT Bearer:"})," ",(0,i.jsx)(n.code,{children:"getAuthToken()"})," is imported from ",(0,i.jsx)(n.code,{children:"@nasnet/state/stores"})," and reads the current JWT from the ",(0,i.jsx)(n.code,{children:"useAuthStore"}),". If a valid (non-null) token is present, it always wins."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Step 2 \u2014 Basic auth fallback:"})," If no JWT is present, ",(0,i.jsx)(n.code,{children:"getStoredCredentials(routerId)"})," looks up ",(0,i.jsx)(n.code,{children:"sessionStorage"})," for the key ",(0,i.jsx)(n.code,{children:"router-credentials-<routerId>"}),". This allows the app to manage the MikroTik router directly with username/password credentials when the NasNet JWT auth layer is bypassed or not yet active."]}),"\n",(0,i.jsx)(n.h3,{id:"per-router-sessionstorage-credentials",children:"Per-Router sessionStorage Credentials"}),"\n",(0,i.jsx)(n.p,{children:"Credentials are namespaced to the router:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// core/src/apollo/apollo-auth-link.ts:22\nfunction getStoredCredentials(routerId: string | null) {\n  const stored = sessionStorage.getItem(`router-credentials-${routerId}`);\n  // parses JSON, validates { username: string, password: string }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Key format: ",(0,i.jsx)(n.code,{children:"router-credentials-<routerId>"})," (e.g., ",(0,i.jsx)(n.code,{children:"router-credentials-01HXYZ123"}),")."]}),"\n",(0,i.jsxs)(n.p,{children:["Using ",(0,i.jsx)(n.code,{children:"sessionStorage"})," (not ",(0,i.jsx)(n.code,{children:"localStorage"}),") gives the following security properties:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Credentials are cleared automatically when the browser tab is closed."}),"\n",(0,i.jsx)(n.li,{children:"Credentials from one router never appear in another router's request \u2014 each router ID produces a distinct key."}),"\n",(0,i.jsxs)(n.li,{children:["If the user switches active routers (",(0,i.jsx)(n.code,{children:"currentRouterId"})," changes), the auth header automatically updates on the next request without any cache invalidation."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"axios-authentication-interceptor",children:"Axios Authentication Interceptor"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/interceptors/auth.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["The Axios interceptor handles REST requests made through the ",(0,i.jsx)(n.code,{children:"apiClient"})," instance. REST calls are primarily used for health checks, binary downloads, and legacy endpoints not yet migrated to GraphQL."]}),"\n",(0,i.jsx)(n.h3,{id:"exported-symbols-1",children:"Exported Symbols"}),"\n",(0,i.jsx)(n.h4,{id:"authinterceptorconfig",children:(0,i.jsx)(n.code,{children:"authInterceptor(config)"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function authInterceptor(\n  config: InternalAxiosRequestConfig\n): InternalAxiosRequestConfig {\n  const credentials = getStoredCredentials();\n  if (credentials?.username && credentials?.password) {\n    const encoded = btoa(`${credentials.username}:${credentials.password}`);\n    config.headers.Authorization = `Basic ${encoded}`;\n  }\n  return config;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["A pure request interceptor \u2014 it never throws, always returns the config. If no credentials exist it returns ",(0,i.jsx)(n.code,{children:"config"})," unmodified (no ",(0,i.jsx)(n.code,{children:"Authorization"})," header)."]}),"\n",(0,i.jsx)(n.h4,{id:"storecredentialscredentials",children:(0,i.jsx)(n.code,{children:"storeCredentials(credentials)"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function storeCredentials(credentials: StoredCredentials): void\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Persists ",(0,i.jsx)(n.code,{children:"{ username, password }"})," to ",(0,i.jsx)(n.code,{children:"localStorage"})," under the key ",(0,i.jsx)(n.code,{children:"nasnet:api:credentials"}),". Throws ",(0,i.jsx)(n.code,{children:"Error('Failed to store credentials')"})," if ",(0,i.jsx)(n.code,{children:"localStorage"})," is unavailable (e.g., private browsing with storage blocked)."]}),"\n",(0,i.jsx)(n.h4,{id:"clearcredentials",children:(0,i.jsx)(n.code,{children:"clearCredentials()"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function clearCredentials(): void\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Removes the key ",(0,i.jsx)(n.code,{children:"nasnet:api:credentials"})," from ",(0,i.jsx)(n.code,{children:"localStorage"}),". Safe to call if the key does not exist."]}),"\n",(0,i.jsx)(n.h3,{id:"storage-comparison-apollo-vs-axios",children:"Storage Comparison: Apollo vs Axios"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{}),(0,i.jsx)(n.th,{children:"Apollo auth link"}),(0,i.jsx)(n.th,{children:"Axios auth interceptor"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Storage"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sessionStorage"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"localStorage"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Scope"}),(0,i.jsxs)(n.td,{children:["Per-router (",(0,i.jsx)(n.code,{children:"router-credentials-<id>"}),")"]}),(0,i.jsxs)(n.td,{children:["Global (",(0,i.jsx)(n.code,{children:"nasnet:api:credentials"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Auth type"}),(0,i.jsx)(n.td,{children:"JWT (primary) + Basic (fallback)"}),(0,i.jsx)(n.td,{children:"Basic only"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Cleared on tab close"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"JWT awareness"}),(0,i.jsxs)(n.td,{children:["Yes (via ",(0,i.jsx)(n.code,{children:"getAuthToken"}),")"]}),(0,i.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"The Axios interceptor is intentionally simpler \u2014 it handles infrastructure-level REST calls that use Basic auth throughout, while the Apollo link handles the full JWT lifecycle for GraphQL operations."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"websocket-authentication-connectionparams",children:"WebSocket Authentication (connectionParams)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-ws-client.ts"})]}),"\n",(0,i.jsxs)(n.p,{children:["GraphQL subscriptions travel over WebSocket, which does not support HTTP headers. Instead, the ",(0,i.jsx)(n.code,{children:"graphql-ws"})," protocol sends authentication as part of the ",(0,i.jsx)(n.code,{children:"ConnectionInit"})," message payload via ",(0,i.jsx)(n.code,{children:"connectionParams"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"connectionparams-callback",children:"connectionParams callback"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// core/src/apollo/apollo-ws-client.ts:149\nconnectionParams: () => {\n  const { currentRouterId } = useConnectionStore.getState();\n  const authorization = getAuthorization(currentRouterId);\n\n  return {\n    routerId: currentRouterId,\n    authorization,\n  };\n},\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The callback is a ",(0,i.jsx)(n.strong,{children:"function"})," (not a static object). ",(0,i.jsx)(n.code,{children:"graphql-ws"})," calls it on every new connection attempt, including reconnects after network disruption. This means fresh credentials are always used \u2014 if the JWT was refreshed or credentials were updated while a reconnect was in progress, the new values are used automatically."]}),"\n",(0,i.jsx)(n.h3,{id:"websocket-jwt-vs-basic-priority",children:"WebSocket JWT vs Basic Priority"}),"\n",(0,i.jsxs)(n.p,{children:["The WebSocket ",(0,i.jsx)(n.code,{children:"getAuthorization(routerId)"})," function mirrors the Apollo link logic exactly:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// core/src/apollo/apollo-ws-client.ts:92\nfunction getAuthorization(routerId: string | null): string | undefined {\n  const jwtToken = getAuthToken();\n  if (jwtToken) return `Bearer ${jwtToken}`;\n\n  const credentials = getStoredCredentials(routerId);\n  if (credentials) return `Basic ${btoa(`${credentials.username}:${credentials.password}`)}`;\n\n  return undefined;\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The same ",(0,i.jsx)(n.code,{children:"sessionStorage"})," key pattern (",(0,i.jsx)(n.code,{children:"router-credentials-<routerId>"}),") is used."]}),"\n",(0,i.jsx)(n.h3,{id:"authentication-aware-retry",children:"Authentication-Aware Retry"}),"\n",(0,i.jsx)(n.p,{children:"The WebSocket client refuses to retry after receiving close codes that indicate authentication failure:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// core/src/apollo/apollo-ws-client.ts:169\nshouldRetry: (errOrCloseEvent) => {\n  if (errOrCloseEvent instanceof CloseEvent) {\n    // 4401 = Authentication failed\n    // 4403 = Forbidden\n    if (errOrCloseEvent.code === 4401 || errOrCloseEvent.code === 4403) {\n      return false;\n    }\n  }\n  // ...\n},\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Retrying with the same bad credentials would be pointless. Close code ",(0,i.jsx)(n.code,{children:"4401"})," is a custom application-level code used by the NasNet backend to signal JWT expiry or missing credentials."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"session-expiry-flow",children:"Session Expiry Flow"}),"\n",(0,i.jsx)(n.p,{children:"When a session expires, the error link (not the auth link) is responsible for clearing state and notifying the user. The flow is triggered from two directions:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GraphQL error UNAUTHENTICATED          HTTP 401 on network error\n         \u2502                                      \u2502\n         \u25bc                                      \u25bc\n  apollo-error-link.ts                   apollo-error-link.ts\n  checkAuthError(code) \u2192 true            statusCode === 401\n         \u2502                                      \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u25bc\n              handleAuthError(message)\n                        \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u25bc             \u25bc             \u25bc\n  useAuthStore     addNotification   window.dispatchEvent\n  .clearAuth()     type: 'error'     'auth:expired'\n                   title: 'Session   (for router redirect)\n                   expired'\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-error-link.ts:37"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function handleAuthError(message?: string) {\n  useAuthStore.getState().clearAuth();\n  useNotificationStore.getState().addNotification({\n    type: 'error',\n    title: 'Session expired',\n    message: message || 'Your session has expired. Please log in again.',\n  });\n  if (typeof window !== 'undefined') {\n    window.dispatchEvent(new CustomEvent('auth:expired'));\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"auth:expired"})," custom event is the decoupling point \u2014 the router (TanStack Router) or any other listener can catch this event and redirect to the login page without the API client layer knowing anything about routing."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"link-chain-position",children:"Link Chain Position"}),"\n",(0,i.jsx)(n.p,{children:"The auth link sits just before the HTTP link in the chain:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Request \u2192 errorLink \u2192 retryLink \u2192 splitLink \u2500\u252c\u2500\u25ba wsLink (subscriptions)\n                                              \u2514\u2500\u25ba authLink \u2192 httpLink (queries/mutations)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Source:"})," ",(0,i.jsx)(n.code,{children:"core/src/apollo/apollo-client.ts:72"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const link = from([errorLink, retryLink, splitLink]);\n// splitLink wires: authLink.concat(httpLink) for HTTP traffic\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The auth link is placed after ",(0,i.jsx)(n.code,{children:"errorLink"})," and ",(0,i.jsx)(n.code,{children:"retryLink"})," so that errors and retries are handled at the top level, but before the actual HTTP transport so credentials are always fresh on each attempt (including retried attempts)."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"./intro.md"})," \u2014 Library overview and structure"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"./apollo-client.md"})," \u2014 Full link chain assembly and cache configuration"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"./axios-http-client.md"})," \u2014 Axios client creation and interceptor registration order"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"./error-handling.md"})," \u2014 How auth errors are caught and routed"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"./websocket-subscriptions.md"})," \u2014 WebSocket reconnection and subscription lifecycle"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},71184:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var r=t(14041);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);