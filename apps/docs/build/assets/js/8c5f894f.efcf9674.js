"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[62686],{52228:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"flows/service-installation-flow","title":"Flow: Service Installation","description":"Traces the full lifecycle of installing a marketplace feature \u2014 from the GraphQL mutation to a running, supervised process.","source":"@site/../backend/docs/flows/service-installation-flow.md","sourceDirName":"flows","slug":"/flows/service-installation-flow","permalink":"/docs/backend/flows/service-installation-flow","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/flows/service-installation-flow.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Flow: Router Connection Establishment","permalink":"/docs/backend/flows/router-connection-flow"},"next":{"title":"Flow: Service Update","permalink":"/docs/backend/flows/service-update-flow"}}');var s=n(31085),t=n(71184);const l={},c="Flow: Service Installation",a={},o=[{value:"Overview",id:"overview",level:2},{value:"Sequence Diagram",id:"sequence-diagram",level:2},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough",level:2},{value:"Step 1: GraphQL Mutation Entry",id:"step-1-graphql-mutation-entry",level:3},{value:"Step 2: Binary Download",id:"step-2-binary-download",level:3},{value:"Step 3: Checksum Verification",id:"step-3-checksum-verification",level:3},{value:"Step 4: Atomic Finalization",id:"step-4-atomic-finalization",level:3},{value:"Step 5: VIF Creation (Virtual Interface)",id:"step-5-vif-creation-virtual-interface",level:3},{value:"Step 6: Config Generation",id:"step-6-config-generation",level:3},{value:"Step 7: Supervisor Registration and Start",id:"step-7-supervisor-registration-and-start",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Observability",id:"observability",level:2},{value:"Cross-References",id:"cross-references",level:2}];function d(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"flow-service-installation",children:"Flow: Service Installation"})}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"Traces the full lifecycle of installing a marketplace feature \u2014 from the GraphQL mutation to a running, supervised process."}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Touches:"})," ",(0,s.jsx)(r.code,{children:"graph/resolver/"}),", ",(0,s.jsx)(r.code,{children:"internal/features/"}),", ",(0,s.jsx)(r.code,{children:"internal/features/verification/"}),", ",(0,s.jsx)(r.code,{children:"internal/vif/"}),", ",(0,s.jsx)(r.code,{children:"internal/config/services/"}),", ",(0,s.jsx)(r.code,{children:"internal/orchestrator/supervisor/"}),"\n",(0,s.jsx)(r.strong,{children:"Entry Point:"})," ",(0,s.jsx)(r.code,{children:"InstallFeature"})," mutation in ",(0,s.jsx)(r.code,{children:"graph/resolver/services-crud-ops.resolvers.go"}),"\n",(0,s.jsx)(r.strong,{children:"Prerequisites:"})]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"[See: 03-graphql-api.md \xa7Mutations] \u2014 GraphQL resolver layer"}),"\n",(0,s.jsx)(r.li,{children:"[See: 07-virtual-interface-factory.md] \u2014 VIF VLAN interface creation"}),"\n",(0,s.jsx)(r.li,{children:"[See: 06-service-orchestrator.md] \u2014 Supervisor process management"}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(r.p,{children:"Service installation is triggered when a user selects a marketplace feature (Tor, sing-box, Xray-core, etc.) and requests installation. The flow downloads the binary, verifies its integrity, provisions a dedicated VLAN network interface on the router, generates a service-specific config file, and finally starts the process under supervisor control with automatic restart on crash."}),"\n",(0,s.jsxs)(r.p,{children:["The installation is asynchronous: the GraphQL mutation returns immediately after validation, and progress events are streamed via subscriptions using ",(0,s.jsx)(r.code,{children:"service.install.progress"})," events on the event bus."]}),"\n",(0,s.jsx)(r.h2,{id:"sequence-diagram",children:"Sequence Diagram"}),"\n",(0,s.jsx)(r.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant GraphQL\n    participant FeatureService\n    participant DownloadManager\n    participant Verifier\n\n    Client->>GraphQL: InstallFeature\n    GraphQL->>FeatureService: validate input\n    FeatureService->>FeatureService: create DB record<br/>(status: queued)\n    GraphQL--\x3e>Client: { instanceID }\n    FeatureService->>DownloadManager: go install()<br/>(async)\n\n    Note over DownloadManager: HTTP GET binary URL\n    DownloadManager->>Verifier: progress event<br/>(downloading %)\n    Client->>Client: \u2190 progress event\n\n    Verifier->>Verifier: VerifySHA256<br/>(checksum)\n    Verifier->>Verifier: atomic rename<br/>(.tmp \u2192 bin)\n    DownloadManager--\x3e>FeatureService: download done\n\n    Note over FeatureService: InterfaceFactory\n    FeatureService->>FeatureService: CreateInterface()\n    Note over FeatureService: 1. DB record (CREATING)<br/>2. /interface/vlan add<br/>3. /ip/address add<br/>4. /routing/table add<br/>5. /ip/route add (default)<br/>6. DB update (ACTIVE)\n\n    Note over FeatureService: ConfigGenerator\n    FeatureService->>FeatureService: GenerateConfig()<br/>(write JSON/YAML)\n\n    Note over FeatureService: Supervisor\n    FeatureService->>FeatureService: Register process\n    FeatureService->>FeatureService: process.Start()<br/>(goroutine: run)\n\n    FeatureService--\x3e>Client: \u2190 installed event"}),"\n",(0,s.jsx)(r.h2,{id:"step-by-step-walkthrough",children:"Step-by-Step Walkthrough"}),"\n",(0,s.jsx)(r.h3,{id:"step-1-graphql-mutation-entry",children:"Step 1: GraphQL Mutation Entry"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Client calls ",(0,s.jsx)(r.code,{children:"InstallFeature(featureID, routerID, name)"})," mutation"]}),"\n",(0,s.jsx)(r.li,{children:"Resolver validates the input and checks the router connection exists"}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Key function:"})," ",(0,s.jsx)(r.code,{children:"installFeature"})," resolver in ",(0,s.jsx)(r.code,{children:"graph/resolver/services-crud-ops.resolvers.go"})]}),"\n",(0,s.jsxs)(r.li,{children:["A ",(0,s.jsx)(r.code,{children:"ServiceInstance"})," database record is created with status ",(0,s.jsx)(r.code,{children:'"queued"'})]}),"\n",(0,s.jsxs)(r.li,{children:["The mutation returns the new ",(0,s.jsx)(r.code,{children:"instanceID"})," immediately (non-blocking)"]}),"\n",(0,s.jsx)(r.li,{children:"A goroutine is launched to perform the actual installation asynchronously"}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"step-2-binary-download",children:"Step 2: Binary Download"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"DownloadManager.Download(ctx, featureID, url, expectedChecksum)"})," is called"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"File:"})," ",(0,s.jsx)(r.code,{children:"internal/features/download.go"})]}),"\n",(0,s.jsxs)(r.li,{children:["Deduplication: if a download is already active for the same ",(0,s.jsx)(r.code,{children:"featureID"}),", returns an error"]}),"\n",(0,s.jsxs)(r.li,{children:["Creates directory: ",(0,s.jsx)(r.code,{children:"{baseDir}/{featureID}/bin/"})]}),"\n",(0,s.jsxs)(r.li,{children:["Downloads to a temp file ",(0,s.jsx)(r.code,{children:"{featureID}.tmp"})," using HTTP with resumable support (Range headers)"]}),"\n",(0,s.jsxs)(r.li,{children:["Progress is tracked every 100ms via ",(0,s.jsx)(r.code,{children:"progressReader"})," and emitted as ",(0,s.jsx)(r.code,{children:"service.install.progress"})," events"]}),"\n",(0,s.jsxs)(r.li,{children:["For archives (tar.gz, zip): ",(0,s.jsx)(r.code,{children:"DownloadAndExtract"})," downloads to ",(0,s.jsx)(r.code,{children:"archive/"})," then extracts the binary"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"step-3-checksum-verification",children:"Step 3: Checksum Verification"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["After download completes, ",(0,s.jsx)(r.code,{children:"VerifySHA256(tmpFile, expectedChecksum)"})," is called"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"File:"})," ",(0,s.jsx)(r.code,{children:"internal/features/download.go"})," (delegates to ",(0,s.jsx)(r.code,{children:"internal/features/verification/"}),")"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"Verifier.VerifyArchive()"})," reads the checksums.txt file, parses GNU sha256sum format"]}),"\n",(0,s.jsxs)(r.li,{children:["Calculates the SHA256 of the downloaded file using ",(0,s.jsx)(r.code,{children:"registry.CalculateSHA256()"})]}),"\n",(0,s.jsx)(r.li,{children:"Compares expected vs. actual hash using constant-time comparison"}),"\n",(0,s.jsxs)(r.li,{children:["On mismatch: temp file is deleted, a ",(0,s.jsx)(r.code,{children:"verification_failed"})," event is emitted, error returned"]}),"\n",(0,s.jsxs)(r.li,{children:["GPG verification: if ",(0,s.jsx)(r.code,{children:"spec.RequireGPG && !spec.TrustOnFirstUse"})," \u2192 returns ",(0,s.jsx)(r.code,{children:"ErrGPGNotImplemented"})]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"step-4-atomic-finalization",children:"Step 4: Atomic Finalization"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["On checksum success: ",(0,s.jsx)(r.code,{children:"os.Rename(tmpFile, finalFile)"})," \u2014 atomic move on Linux/macOS"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"os.Chmod(finalFile, 0755)"})," makes the binary executable"]}),"\n",(0,s.jsxs)(r.li,{children:["A ",(0,s.jsx)(r.code,{children:"service.install.progress"})," event with ",(0,s.jsx)(r.code,{children:'status: "completed"'})," is emitted"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"step-5-vif-creation-virtual-interface",children:"Step 5: VIF Creation (Virtual Interface)"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"InterfaceFactory.CreateInterface(ctx, instanceID, featureID, instanceName, vlanID)"})," is called"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"File:"})," ",(0,s.jsx)(r.code,{children:"internal/vif/interface_factory.go"})]}),"\n",(0,s.jsxs)(r.li,{children:["Creates a DB record with ",(0,s.jsx)(r.code,{children:"status: CREATING"})," first (for crash recovery)"]}),"\n",(0,s.jsxs)(r.li,{children:["Executes 4 router commands in order, with LIFO cleanup (deferred rollback) on any failure:","\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"/interface/vlan add name=nnc-{featureID}-{name} vlan-id={vlanID} interface=ether1"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"/ip/address add address=10.99.{vlanID}.1/24 interface={interfaceName}"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"/routing/table add name={routingMark}"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"/ip/route add dst-address=0.0.0.0/0 gateway=10.99.{vlanID}.2 routing-table={routingMark}"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["On success: DB record updated to ",(0,s.jsx)(r.code,{children:"status: ACTIVE"})]}),"\n",(0,s.jsxs)(r.li,{children:["Emits ",(0,s.jsx)(r.code,{children:"interface.created"})," event"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"step-6-config-generation",children:"Step 6: Config Generation"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["The feature-specific config generator is called based on the ",(0,s.jsx)(r.code,{children:"featureID"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Files:"})," ",(0,s.jsx)(r.code,{children:"internal/config/services/{featureID}.go"})," (e.g., ",(0,s.jsx)(r.code,{children:"tor.go"}),", ",(0,s.jsx)(r.code,{children:"singbox.go"}),", ",(0,s.jsx)(r.code,{children:"xray.go"}),")"]}),"\n",(0,s.jsxs)(r.li,{children:["Config is written to ",(0,s.jsx)(r.code,{children:"{baseDir}/{featureID}/config/{featureID}.json"})," (or ",(0,s.jsx)(r.code,{children:".yaml"}),")"]}),"\n",(0,s.jsx)(r.li,{children:"Config contains: listen port, routing mark (links to VIF), log path, feature-specific settings"}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"step-7-supervisor-registration-and-start",children:"Step 7: Supervisor Registration and Start"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"ManagedProcess"})," is created with ",(0,s.jsx)(r.code,{children:"NewManagedProcess(ProcessConfig{...})"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"File:"})," ",(0,s.jsx)(r.code,{children:"internal/orchestrator/supervisor/process.go"})]}),"\n",(0,s.jsx)(r.li,{children:"Config includes: binary path, args, working dir, health probe, log dir, isolation strategy"}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"process.Start(ctx)"})," transitions state to ",(0,s.jsx)(r.code,{children:"ProcessStateStarting"})," and launches the ",(0,s.jsx)(r.code,{children:"run()"})," goroutine"]}),"\n",(0,s.jsxs)(r.li,{children:["The ",(0,s.jsx)(r.code,{children:"run()"})," goroutine: starts the OS process, captures stdout/stderr via ",(0,s.jsx)(r.code,{children:"LogCapture"}),", monitors for exit"]}),"\n",(0,s.jsxs)(r.li,{children:["On crash: exponential backoff restart (1s initial, 2x multiplier, 30s max) if ",(0,s.jsx)(r.code,{children:"AutoRestart: true"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"ServiceInstance"})," DB record is updated to ",(0,s.jsx)(r.code,{children:'status: "running"'})]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Step"}),(0,s.jsx)(r.th,{children:"Failure"}),(0,s.jsx)(r.th,{children:"Recovery"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Download"}),(0,s.jsx)(r.td,{children:"Network error / timeout"}),(0,s.jsxs)(r.td,{children:["Context cancellation cleans up ",(0,s.jsx)(r.code,{children:".tmp"})," file; ",(0,s.jsx)(r.code,{children:"verification_failed"})," event emitted"]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Checksum"}),(0,s.jsx)(r.td,{children:"Hash mismatch"}),(0,s.jsxs)(r.td,{children:[(0,s.jsx)(r.code,{children:".tmp"})," deleted; ",(0,s.jsx)(r.code,{children:"verification_failed"})," event; installation aborted"]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"VIF Creation"}),(0,s.jsx)(r.td,{children:"Router command fails"}),(0,s.jsxs)(r.td,{children:["LIFO cleanup runs router ",(0,s.jsx)(r.code,{children:"remove"})," commands in reverse; DB record set to ",(0,s.jsx)(r.code,{children:"ERROR"})]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Config generation"}),(0,s.jsx)(r.td,{children:"Template error"}),(0,s.jsxs)(r.td,{children:["Instance marked ",(0,s.jsx)(r.code,{children:"error"}),"; no process started"]})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Process start"}),(0,s.jsx)(r.td,{children:"Binary not found / permission"}),(0,s.jsxs)(r.td,{children:["State set to ",(0,s.jsx)(r.code,{children:"ProcessStateCrashed"}),"; backoff restart attempted"]})]})]})]}),"\n",(0,s.jsx)(r.h2,{id:"observability",children:"Observability"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Events emitted (on event bus):"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"service.install.progress"})," \u2014 emitted every 100ms during download with ",(0,s.jsx)(r.code,{children:"{percent, bytesDownloaded, status}"})]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"interface.created"})," \u2014 after VIF is successfully provisioned on the router"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"service.installed"})," \u2014 when the full installation completes"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"service.install.failed"})," \u2014 if any step fails"]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Logs generated:"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"[download-manager]"})," \u2014 download start, progress, verification, completion"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"[interface-factory]"})," \u2014 VIF creation steps, rollback warnings"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"[supervisor]"})," \u2014 process state transitions, restart counts, backoff delays"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["[See: 06-service-orchestrator.md \xa7Supervisor] \u2014 how ",(0,s.jsx)(r.code,{children:"ManagedProcess"})," and ",(0,s.jsx)(r.code,{children:"Registry"})," work"]}),"\n",(0,s.jsx)(r.li,{children:"[See: 07-virtual-interface-factory.md] \u2014 VIF VLAN lifecycle details"}),"\n",(0,s.jsx)(r.li,{children:"[See: 10-feature-marketplace.md \xa7Download] \u2014 feature manifest and registry"}),"\n",(0,s.jsx)(r.li,{children:"[See: 05-event-system.md] \u2014 event bus publish/subscribe model"}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},71184:(e,r,n)=>{n.d(r,{R:()=>l,x:()=>c});var i=n(14041);const s={},t=i.createContext(s);function l(e){const r=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(t.Provider,{value:r},e.children)}}}]);