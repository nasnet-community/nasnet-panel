"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[91326],{71184:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(14041);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}},93183:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"architecture","title":"Architecture","description":"The @nasnet/state library implements a four-layer state model that separates concerns by data origin, update frequency, and complexity.","source":"@site/../../libs/state/docs/architecture.md","sourceDirName":".","slug":"/architecture","permalink":"/docs/state/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../../libs/state/docs/architecture.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Architecture"},"sidebar":"sidebar","previous":{"title":"Introduction","permalink":"/docs/state/intro"},"next":{"title":"Persistence","permalink":"/docs/state/persistence"}}');var s=t(31085),o=t(71184);const i={sidebar_position:2,title:"Architecture"},a="State Architecture",c={},l=[{value:"Four-Layer State Model",id:"four-layer-state-model",level:2},{value:"Data Flow Diagram",id:"data-flow-diagram",level:2},{value:"Decision Tree",id:"decision-tree",level:2},{value:"Zustand Pattern: Singleton Stores with Persist Middleware",id:"zustand-pattern-singleton-stores-with-persist-middleware",level:2},{value:"Custom Storage Handlers",id:"custom-storage-handlers",level:2},{value:"1. Auth Store: Date Object Rehydration",id:"1-auth-store-date-object-rehydration",level:3},{value:"2. History Store: Function Serialization (No-op on Rehydration)",id:"2-history-store-function-serialization-no-op-on-rehydration",level:3},{value:"3. Command Registry: Map \u2194 Record Serialization",id:"3-command-registry-map--record-serialization",level:3},{value:"Selector Patterns: Optimized Re-renders",id:"selector-patterns-optimized-re-renders",level:2},{value:"Basic Selector: Primitive Value",id:"basic-selector-primitive-value",level:3},{value:"Shallow Comparison: Multiple Fields",id:"shallow-comparison-multiple-fields",level:3},{value:"Memoized Selector: Computed Values",id:"memoized-selector-computed-values",level:3},{value:"Parameterized Selector: ID-based Lookups",id:"parameterized-selector-id-based-lookups",level:3},{value:"XState v5 Pattern: Actor Model",id:"xstate-v5-pattern-actor-model",level:2},{value:"Machine Persistence: Session Recovery",id:"machine-persistence-session-recovery",level:2},{value:"Cross-Layer Integration",id:"cross-layer-integration",level:2},{value:"Example: Configuration Pipeline (All 4 Layers)",id:"example-configuration-pipeline-all-4-layers",level:3},{value:"Example: VPN Connection (Layers 1, 2, 3)",id:"example-vpn-connection-layers-1-2-3",level:3},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"state-architecture",children:"State Architecture"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"@nasnet/state"})," library implements a ",(0,s.jsx)(n.strong,{children:"four-layer state model"})," that separates concerns by data origin, update frequency, and complexity."]}),"\n",(0,s.jsx)(n.h2,{id:"four-layer-state-model",children:"Four-Layer State Model"}),"\n",(0,s.jsx)(n.mermaid,{value:'flowchart TD\n    L4["<b>Layer 4: Form State</b><br/>(React Hook Form + Zod)<br/>\u2500<br/>Form validation, field errors, dirty tracking<br/>LocalStorage: None form-specific, cleared on submit"]\n    L3["<b>Layer 3: Complex Flows</b><br/>(XState Machines)<br/>\u2500<br/>Multi-step wizards, config pipeline, VPN connection<br/>Orchestrates side effects, state machines, rollback logic<br/>LocalStorage: Persisted sessions wizard progress"]\n    L2["<b>Layer 2: Client State</b><br/>(Zustand Stores)<br/>\u2500<br/>Theme, sidebar, modals, notifications, UI preferences<br/>Domain UI state filters, selections, drafts<br/>LocalStorage: UI preferences, recent items, user selections"]\n    L1["<b>Layer 1: Server State</b><br/>(Apollo Client)<br/>\u2500<br/>Router config, VPN lists, logs, interface stats<br/>Cached GraphQL queries, mutations, subscriptions<br/>Memory: Apollo Client cache not localStorage"]\n\n    L4 --\x3e L3\n    L3 --\x3e L2\n    L2 --\x3e L1'}),"\n",(0,s.jsx)(n.h2,{id:"data-flow-diagram",children:"Data Flow Diagram"}),"\n",(0,s.jsx)(n.mermaid,{value:'flowchart TD\n    API["Backend/Router API"]\n\n    API --\x3e GQL["GraphQL Server<br/>(Apollo Client)<br/>\u2500<br/>Queries: GET_ROUTER_CONFIG,<br/>GET_DHCP_LEASES, GET_VPN_LIST<br/>Mutations: APPLY_FIREWALL_RULE,<br/>RESTART_SERVICE<br/>Subscriptions: ROUTER_STATUS, LOG_STREAM"]\n    API --\x3e REST["REST API<br/>(discovery, scanning)"]\n    API --\x3e WS["WebSocket<br/>(real-time router events)"]\n\n    GQL --\x3e CACHE["Apollo Cache<br/>(in-memory)"]\n\n    UI["Component UI"]\n\n    UI --\x3e APOLLO["useQuery/useMutation<br/>(Apollo)<br/>\u2192 Display router config"]\n    UI --\x3e AUTH["useAuthStore<br/>\u2192 Display user info,<br/>check permissions"]\n    UI --\x3e THEME["useThemeStore<br/>\u2192 Apply theme class to DOM"]\n    UI --\x3e NOTIF["useNotificationStore<br/>\u2192 Show toast on mutation"]\n    UI --\x3e PIPELINE["useConfigPipeline<br/>\u2192 Orchestrate<br/>apply-confirm-rollback"]\n    UI --\x3e FORM["useForm RHF<br/>\u2192 Manage form state<br/>before mutation"]\n\n    APOLLO -.-> CACHE\n    APOLLO -.-> GQL\n    APOLLO -.-> REST\n    APOLLO -.-> WS'}),"\n",(0,s.jsx)(n.h2,{id:"decision-tree",children:"Decision Tree"}),"\n",(0,s.jsx)(n.mermaid,{value:'flowchart TD\n    Q1{"Data from<br/>router/backend?"}\n\n    Q1 --\x3e|YES| Apollo["Apollo Client<br/>(GraphQL)<br/>\u2500<br/>Cache in memory,<br/>invalidate on mutation"]\n\n    Q1 --\x3e|NO| Q2{"Multi-step workflow<br/>with side effects?"}\n\n    Q2 --\x3e|YES| XState["XState Machine<br/>\u2500<br/>State persists in<br/>localStorage opt-in"]\n\n    Q2 --\x3e|NO| Q3{"Form-specific<br/>validation,<br/>dirty tracking?"}\n\n    Q3 --\x3e|YES| RHF["React Hook Form + Zod<br/>\u2500<br/>Clears on unmount<br/>or submit"]\n\n    Q3 --\x3e|NO| Q4{"Global UI state<br/>theme, sidebar, modal?"}\n\n    Q4 --\x3e|YES| Zustand["Zustand Store<br/>\u2500<br/>Persist UI preferences<br/>to localStorage"]\n\n    Q4 --\x3e|NO| Component["Component state<br/>useState"]'}),"\n",(0,s.jsx)(n.h2,{id:"zustand-pattern-singleton-stores-with-persist-middleware",children:"Zustand Pattern: Singleton Stores with Persist Middleware"}),"\n",(0,s.jsxs)(n.p,{children:["All Zustand stores follow the ",(0,s.jsx)(n.strong,{children:"singleton + middleware"})," pattern:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// 1. Define state + action types\ninterface ThemeState {\n  theme: ThemeMode;\n  resolvedTheme: 'light' | 'dark';\n}\n\ninterface ThemeActions {\n  setTheme: (theme: ThemeMode) => void;\n  toggleTheme: () => void;\n}\n\n// 2. Create store with middleware stack\nexport const useThemeStore = create<ThemeState & ThemeActions>()(\n  devtools(           // Layer 3: DevTools debugging (outermost)\n    persist(          // Layer 2: localStorage persistence\n      (set, get) => ({ // Layer 1: Reducer logic (innermost)\n        // State\n        theme: 'system',\n        resolvedTheme: getSystemTheme(),\n\n        // Actions\n        setTheme: (theme) => {\n          set({ theme, resolvedTheme: theme === 'system' ? getSystemTheme() : theme });\n        },\n        toggleTheme: () => {\n          const current = get().resolvedTheme;\n          set({ resolvedTheme: current === 'dark' ? 'light' : 'dark' });\n        },\n      }),\n      {\n        name: 'nasnet-theme',  // localStorage key\n        version: 1,\n        partialize: (state) => ({ theme: state.theme }), // Only persist theme mode\n      }\n    ),\n    { name: 'theme-store' }  // DevTools store name\n  )\n);\n\n// 3. Use in components with selectors\nfunction ThemeToggle() {\n  const theme = useThemeStore(state => state.theme);\n  const toggleTheme = useThemeStore(state => state.toggleTheme);\n  return <button onClick={toggleTheme}>{theme}</button>;\n}\n\n// 4. Access outside React\nconst { theme } = useThemeStore.getState();\nconst unsubscribe = useThemeStore.subscribe(\n  (state) => state.theme,\n  (theme) => console.log('Theme changed:', theme)\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Middleware order matters:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"devtools (outermost)"})," - Intercepts all mutations for debugging"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"persist (middle)"})," - Saves to localStorage on mutations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Reducer (innermost)"})," - Core state logic"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/stores/src/ui/theme.store.ts"})]}),"\n",(0,s.jsx)(n.h2,{id:"custom-storage-handlers",children:"Custom Storage Handlers"}),"\n",(0,s.jsx)(n.p,{children:"Some stores require custom serialization for JSON:"}),"\n",(0,s.jsx)(n.h3,{id:"1-auth-store-date-object-rehydration",children:"1. Auth Store: Date Object Rehydration"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Problem:"})," ",(0,s.jsx)(n.code,{children:"new Date()"})," \u2192 JSON \u2192 ",(0,s.jsx)(n.code,{children:'"2025-02-27T12:00:00Z"'})," (lost instanceof check)"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution:"})," Custom storage handler that converts ISO strings back to Date objects:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const authStorage: StateStorage = {\n  getItem: (name: string) => {\n    const str = localStorage.getItem(name);\n    if (!str) return null;\n\n    const parsed = JSON.parse(str);\n\n    // Rehydrate Date objects\n    if (parsed.state?.tokenExpiry) {\n      parsed.state.tokenExpiry = new Date(parsed.state.tokenExpiry);\n    }\n    if (parsed.state?.lastActivity) {\n      parsed.state.lastActivity = new Date(parsed.state.lastActivity);\n    }\n\n    return JSON.stringify(parsed);\n  },\n  setItem: (name, value) => localStorage.setItem(name, value),\n  removeItem: (name) => localStorage.removeItem(name),\n};\n\nexport const useAuthStore = create<AuthState & AuthActions>()(\n  persist(\n    (set, get) => ({ /* ... */ }),\n    {\n      name: 'auth-storage',\n      storage: createJSONStorage(() => authStorage),  // Use custom handler\n    }\n  )\n);\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Usage:"})," Auth store now preserves Date semantics for expiry checks:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const { tokenExpiry } = useAuthStore.getState();\nconst isExpired = tokenExpiry.getTime() <= Date.now();  // Works correctly\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/stores/src/auth/auth.store.ts:191-230"})]}),"\n",(0,s.jsx)(n.h3,{id:"2-history-store-function-serialization-no-op-on-rehydration",children:"2. History Store: Function Serialization (No-op on Rehydration)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Problem:"})," ",(0,s.jsx)(n.code,{children:"execute()"})," and ",(0,s.jsx)(n.code,{children:"undo()"})," functions can't serialize to JSON"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution:"})," Custom storage that converts functions to no-ops on rehydration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"storage: {\n  getItem: (name) => {\n    const str = localStorage.getItem(name);\n    if (!str) return null;\n\n    const data = JSON.parse(str);\n\n    // Convert persisted actions back to full UndoableAction type\n    // Functions are provided as no-ops (can't execute after reload)\n    data.state.past = (data.state.past || []).map((a: SerializedAction) => ({\n      ...a,\n      timestamp: new Date(a.timestamp),\n      execute: () => console.warn('Cannot re-execute persisted action'),\n      undo: () => console.warn('Cannot undo persisted action'),\n    }));\n\n    return data;\n  },\n  setItem: (name, value) => localStorage.setItem(name, JSON.stringify(value)),\n  removeItem: (name) => localStorage.removeItem(name),\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Why:"})," Only action metadata is persisted (for display in history UI), not the actual execute/undo logic."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/stores/src/history/history.store.ts:293-335"})]}),"\n",(0,s.jsx)(n.h3,{id:"3-command-registry-map--record-serialization",children:"3. Command Registry: Map \u2194 Record Serialization"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Problem:"})," ",(0,s.jsx)(n.code,{children:"Map<string, Command>"})," and ",(0,s.jsx)(n.code,{children:"Map<string, number>"})," don't JSON serialize"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution:"})," Custom ",(0,s.jsx)(n.code,{children:"merge"})," function converts Record back to Map on rehydration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// In command-registry.store.ts\nexport const useCommandRegistry = create<CommandRegistryState & CommandRegistryActions>()(\n  persist(\n    (set, get) => ({ /* ... */ }),\n    {\n      name: 'nasnet-command-registry',\n      partialize: (state) => ({\n        recentIds: state.recentIds,\n        usageCount: Object.fromEntries(state.usageCount), // Map \u2192 Record\n      }),\n      merge: (persistedState, currentState) => {\n        // Convert Record back to Map on rehydration\n        return {\n          ...currentState,\n          recentIds: persistedState.recentIds || [],\n          usageCount: new Map(Object.entries(persistedState.usageCount || {})),\n        };\n      },\n    }\n  )\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Data flow:"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Persist:"})," ",(0,s.jsx)(n.code,{children:"usageCount: Map<string, number>"})," \u2192 ",(0,s.jsx)(n.code,{children:"Object.fromEntries()"})," \u2192 ",(0,s.jsx)(n.code,{children:'{ "cmd-1": 3, "cmd-2": 5 }'})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rehydrate:"})," ",(0,s.jsx)(n.code,{children:'{ "cmd-1": 3, "cmd-2": 5 }'})," \u2192 ",(0,s.jsx)(n.code,{children:"new Map(Object.entries(...))"})," \u2192 ",(0,s.jsx)(n.code,{children:"Map<string, number>"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/stores/src/command/command-registry.store.ts:280-300"})]}),"\n",(0,s.jsx)(n.h2,{id:"selector-patterns-optimized-re-renders",children:"Selector Patterns: Optimized Re-renders"}),"\n",(0,s.jsxs)(n.p,{children:["Selectors are ",(0,s.jsx)(n.strong,{children:"critical"})," for performance. Without them, components re-render on ANY store mutation."]}),"\n",(0,s.jsx)(n.h3,{id:"basic-selector-primitive-value",children:"Basic Selector: Primitive Value"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// \u2705 BEST: Only re-renders when isAuthenticated changes\nconst isAuthenticated = useAuthStore(state => state.isAuthenticated);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"shallow-comparison-multiple-fields",children:"Shallow Comparison: Multiple Fields"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { shallow } from 'zustand/shallow';\n\n// \u2705 GOOD: Re-renders only when user OR token changes\nconst { user, token } = useAuthStore(\n  state => ({ user: state.user, token: state.token }),\n  shallow  // Prevents re-render if same object reference\n);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"memoized-selector-computed-values",children:"Memoized Selector: Computed Values"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Cache computed results based on dependency changes\nconst selectUIPreferencesMemoized = createMemoizedSelector(\n  (state: UIState) => [\n    state.compactMode,\n    state.animationsEnabled,\n    state.defaultNotificationDuration,\n  ] as const,\n  ([compactMode, animationsEnabled, duration]) => ({\n    compactMode,\n    animationsEnabled,\n    duration,\n  })\n);\n\n// Usage\nconst prefs = useUIStore(selectUIPreferencesMemoized);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"parameterized-selector-id-based-lookups",children:"Parameterized Selector: ID-based Lookups"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Create selector factory for searching by parameter\nconst selectNotificationById = createParameterizedSelector(\n  (state: NotificationState, id: string) =>\n    state.notifications.find(n => n.id === id) ?? null\n);\n\n// Each ID gets its own cached selector\nconst notification = useNotificationStore(selectNotificationById('abc-123'));\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/stores/src/ui/selectors.ts:25-112"})]}),"\n",(0,s.jsx)(n.h2,{id:"xstate-v5-pattern-actor-model",children:"XState v5 Pattern: Actor Model"}),"\n",(0,s.jsxs)(n.p,{children:["XState machines use the ",(0,s.jsx)(n.strong,{children:"setup() factory"})," for cleaner type safety and async handling:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// 1. Define context and event types\ninterface WizardContext {\n  currentStep: number;\n  formData: Record<string, unknown>;\n  error?: string;\n}\n\ntype WizardEvent =\n  | { type: 'NEXT' }\n  | { type: 'BACK' }\n  | { type: 'SUBMIT'; data: Record<string, unknown> };\n\n// 2. Create machine with setup()\nexport const wizardMachine = setup({\n  types: {\n    context: {} as WizardContext,\n    events: {} as WizardEvent,\n  },\n  actions: {\n    recordFormData: assign({\n      formData: ({ event }) => {\n        if (event.type === 'SUBMIT') {\n          return event.data;\n        }\n        return {};\n      },\n    }),\n  },\n}).createMachine({\n  id: 'wizard',\n  initial: 'step1',\n  context: {\n    currentStep: 1,\n    formData: {},\n  },\n  states: {\n    step1: {\n      on: {\n        NEXT: { target: 'step2' },\n      },\n    },\n    step2: {\n      on: {\n        BACK: { target: 'step1' },\n        SUBMIT: {\n          target: 'success',\n          actions: 'recordFormData',\n        },\n      },\n    },\n    success: {\n      type: 'final',\n    },\n  },\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key differences from XState v4:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"setup()"})," wraps machine definition for better type inference"]}),"\n",(0,s.jsxs)(n.li,{children:["Actions have direct access to ",(0,s.jsx)(n.code,{children:"event"})," and ",(0,s.jsx)(n.code,{children:"context"})]}),"\n",(0,s.jsxs)(n.li,{children:["No need for ",(0,s.jsx)(n.code,{children:"assign()"})," function at top level (inside actions only)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/machines/src/wizardMachine.ts"})]}),"\n",(0,s.jsx)(n.h2,{id:"machine-persistence-session-recovery",children:"Machine Persistence: Session Recovery"}),"\n",(0,s.jsx)(n.p,{children:"Machines support localStorage-based session recovery for long-running operations:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { persistMachineState, restoreMachineState } from '@nasnet/state/machines';\n\n// On machine transition: persist context\nfunction handleStateChange(state) {\n  persistMachineState('vpn-wizard', state.value, state.context);\n}\n\n// On app load: restore if available\nfunction App() {\n  const saved = restoreMachineState('vpn-wizard');\n  if (saved) {\n    // Resume wizard from saved context\n    send({ type: 'RESTORE', data: saved.context });\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Persistence API:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"persistMachineState(id, stateValue, context)"})," - Save to localStorage"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"restoreMachineState(id, maxAge?)"})," - Restore from localStorage (24hr timeout by default)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"hasSavedSession(id)"})," - Check if session exists"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cleanupStaleSessions()"})," - Remove sessions older than maxAge"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"clearMachineState(id)"})," - Manually clear a session"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Storage key format:"})," ",(0,s.jsx)(n.code,{children:"nasnet-machine-{machineId}"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Source:"})," ",(0,s.jsx)(n.code,{children:"libs/state/machines/src/persistence.ts"})]}),"\n",(0,s.jsx)(n.h2,{id:"cross-layer-integration",children:"Cross-Layer Integration"}),"\n",(0,s.jsx)(n.h3,{id:"example-configuration-pipeline-all-4-layers",children:"Example: Configuration Pipeline (All 4 Layers)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'Layer 1 (Apollo):\n  useQuery(GET_CURRENT_CONFIG) \u2192 { currentConfig: {...} }\n\nLayer 2 (Zustand):\n  useUIStore() \u2192 { pendingChanges: {...} }\n  useNotificationStore() \u2192 show("Applying config...")\n\nLayer 3 (XState):\n  useConfigPipeline() \u2192 {\n    state: \'applying\',\n    send: (event) => void,\n  }\n\nLayer 4 (RHF):\n  useForm() \u2192 {\n    formState: { errors, isDirty },\n    watch: (field) => value,\n  }\n\nFlow:\n  User fills form (RHF) \u2192 Clicks "Apply" \u2192\n  Trigger config pipeline (XState) \u2192\n  Validate + Preview (show in UI with Zustand) \u2192\n  Show countdown confirm (Zustand modal) \u2192\n  Send mutation to backend (Apollo) \u2192\n  Verify result (Apollo requery) \u2192\n  Show success toast (Zustand notification)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"example-vpn-connection-layers-1-2-3",children:"Example: VPN Connection (Layers 1, 2, 3)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Layer 1 (Apollo):\n  useMutation(CONNECT_VPN) \u2192 mutation function\n\nLayer 2 (Zustand):\n  useConnectionStore() \u2192 {\n    isConnected: boolean,\n    status: string,\n    connectionStrength: number,\n  }\n\nLayer 3 (XState):\n  useVPNConnection() \u2192 {\n    state: 'idle' | 'connecting' | 'connected' | 'error',\n    send: (event) => void,\n  }\n\nMachine orchestrates:\n  1. CONNECT event \u2192 state: 'connecting'\n  2. Call Apollo mutation\n  3. Update Zustand store with progress\n  4. On success \u2192 state: 'connected', update store\n  5. Start health check polling\n  6. On failure \u2192 state: 'error', show toast notification\n"})}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Aspect"}),(0,s.jsx)(n.th,{children:"Zustand"}),(0,s.jsx)(n.th,{children:"XState"}),(0,s.jsx)(n.th,{children:"Apollo"}),(0,s.jsx)(n.th,{children:"RHF"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Data Origin"})}),(0,s.jsx)(n.td,{children:"Client"}),(0,s.jsx)(n.td,{children:"Client"}),(0,s.jsx)(n.td,{children:"Server"}),(0,s.jsx)(n.td,{children:"Form"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Update Frequency"})}),(0,s.jsx)(n.td,{children:"On user action"}),(0,s.jsx)(n.td,{children:"On state transition"}),(0,s.jsx)(n.td,{children:"On mutation/query"}),(0,s.jsx)(n.td,{children:"On field change"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Side Effects"})}),(0,s.jsx)(n.td,{children:"Imperative"}),(0,s.jsx)(n.td,{children:"Declarative (actions/guards)"}),(0,s.jsx)(n.td,{children:"Async mutations"}),(0,s.jsx)(n.td,{children:"On form submit"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Persistence"})}),(0,s.jsx)(n.td,{children:"localStorage (optional)"}),(0,s.jsx)(n.td,{children:"localStorage (opt-in)"}),(0,s.jsx)(n.td,{children:"Apollo cache (memory)"}),(0,s.jsx)(n.td,{children:"None"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Debugging"})}),(0,s.jsx)(n.td,{children:"Redux DevTools"}),(0,s.jsx)(n.td,{children:"XState visualizer"}),(0,s.jsx)(n.td,{children:"Apollo DevTools"}),(0,s.jsx)(n.td,{children:"React DevTools"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Next Steps:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Read ",(0,s.jsx)(n.a,{href:"/docs/state/persistence",children:"Persistence"})," for localStorage key reference and custom handlers"]}),"\n",(0,s.jsxs)(n.li,{children:["Read ",(0,s.jsx)(n.a,{href:"/docs/state/performance",children:"Performance"})," for selector patterns and re-render optimization"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);