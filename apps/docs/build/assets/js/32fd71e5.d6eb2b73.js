"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[2392],{70081:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"flows/graphql-request-lifecycle","title":"Flow: GraphQL Request Lifecycle","description":"Traces the complete path of a GraphQL request from TCP arrival at the Echo HTTP server through","source":"@site/../backend/docs/flows/graphql-request-lifecycle.md","sourceDirName":"flows","slug":"/flows/graphql-request-lifecycle","permalink":"/docs/backend/flows/graphql-request-lifecycle","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/flows/graphql-request-lifecycle.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Flow: Device Routing Chain","permalink":"/docs/backend/flows/device-routing-chain-flow"},"next":{"title":"Flow: Router Connection Establishment","permalink":"/docs/backend/flows/router-connection-flow"}}');var i=n(31085),s=n(71184);const l={},a="Flow: GraphQL Request Lifecycle",d={},o=[{value:"Overview",id:"overview",level:2},{value:"High-Level Sequence Diagram",id:"high-level-sequence-diagram",level:2},{value:"Step-by-Step Walkthrough",id:"step-by-step-walkthrough",level:2},{value:"Step 1: TCP Arrival and Echo Routing",id:"step-1-tcp-arrival-and-echo-routing",level:3},{value:"Step 2: Middleware Stack",id:"step-2-middleware-stack",level:3},{value:"2a. Request ID Middleware",id:"2a-request-id-middleware",level:4},{value:"2b. Auth Middleware",id:"2b-auth-middleware",level:4},{value:"Step 3: GraphQL Handler Entry",id:"step-3-graphql-handler-entry",level:3},{value:"Step 4: DataLoader Initialization (Per-Request)",id:"step-4-dataloader-initialization-per-request",level:3},{value:"Step 5: Custom Directive Evaluation",id:"step-5-custom-directive-evaluation",level:3},{value:"@auth \u2014 Authorization",id:"auth--authorization",level:4},{value:"@validate \u2014 Input Validation",id:"validate--input-validation",level:4},{value:"@sensitive \u2014 Log Redaction",id:"sensitive--log-redaction",level:4},{value:"@capability \u2014 Router Feature Gating",id:"capability--router-feature-gating",level:4},{value:"Step 6: Resolver Execution",id:"step-6-resolver-execution",level:3},{value:"Step 7: Router Command Translation",id:"step-7-router-command-translation",level:3},{value:"Step 8: RouterOS Command Execution via FallbackChain",id:"step-8-routeros-command-execution-via-fallbackchain",level:3},{value:"Step 9: Response Translation",id:"step-9-response-translation",level:3},{value:"Step 10: Error Presentation",id:"step-10-error-presentation",level:3},{value:"Step 11: Response Serialization",id:"step-11-response-serialization",level:3},{value:"Subscription Lifecycle (WebSocket)",id:"subscription-lifecycle-websocket",level:2},{value:"Full Timing Breakdown",id:"full-timing-breakdown",level:2},{value:"Cross-References",id:"cross-references",level:2}];function c(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"flow-graphql-request-lifecycle",children:"Flow: GraphQL Request Lifecycle"})}),"\n",(0,i.jsxs)(r.blockquote,{children:["\n",(0,i.jsx)(r.p,{children:"Traces the complete path of a GraphQL request from TCP arrival at the Echo HTTP server through\nmiddleware, directive evaluation, DataLoader batching, resolver execution, router command dispatch\nvia the fallback chain, and response serialization back to the client."}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Touches:"})," ",(0,i.jsx)(r.code,{children:"internal/server/"}),", ",(0,i.jsx)(r.code,{children:"internal/middleware/"}),", ",(0,i.jsx)(r.code,{children:"internal/graphql/directives/"}),",\n",(0,i.jsx)(r.code,{children:"internal/graphql/loaders/"}),", ",(0,i.jsx)(r.code,{children:"graph/resolver/"}),", ",(0,i.jsx)(r.code,{children:"internal/router/"})," ",(0,i.jsx)(r.strong,{children:"Entry Point:"})," Echo HTTP\nlistener on ",(0,i.jsx)(r.code,{children:"0.0.0.0:80"})," (production) or ",(0,i.jsx)(r.code,{children:"0.0.0.0:8080"})," (development) ",(0,i.jsx)(r.strong,{children:"Prerequisites:"})]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"[See: 03-graphql-api.md \xa7Resolvers] \u2014 resolver layer architecture and generated code"}),"\n",(0,i.jsx)(r.li,{children:"[See: 04-router-communication.md \xa7FallbackChain] \u2014 protocol negotiation and command dispatch"}),"\n",(0,i.jsx)(r.li,{children:"[See: 12-security.md \xa7JWT Authentication] \u2014 token validation internals"}),"\n"]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(r.p,{children:"Every GraphQL operation (query, mutation, or subscription) passes through a well-defined stack:\nEcho's HTTP server, a middleware chain for correlation and authentication, the gqlgen-generated\nexecutor which applies custom directives, per-request DataLoaders for batched database reads, domain\nresolvers that translate operations to RouterOS commands, the fallback chain for protocol-agnostic\ncommand dispatch, and finally error presentation and JSON serialization."}),"\n",(0,i.jsx)(r.p,{children:"The entire path is synchronous within a single goroutine for queries/mutations. Subscriptions follow\nthe same middleware path but diverge at execution by establishing a WebSocket upgrade and streaming\nevents from the event bus."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"high-level-sequence-diagram",children:"High-Level Sequence Diagram"}),"\n",(0,i.jsx)(r.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant EchoServer as Echo Server\n    participant Middleware\n    participant gqlgen\n    participant Resolver\n    participant FallbackChain\n\n    Client->>EchoServer: POST /graphql\n    EchoServer->>Middleware: RequestID\n    Note over Middleware: ULID generated\n    EchoServer->>Middleware: Auth\n    Note over Middleware: JWT validated<br/>ctx enriched\n    Middleware--\x3e>EchoServer: (middleware complete)\n    EchoServer->>gqlgen: GraphQL handler\n    Note over gqlgen: parse operation<br/>complexity check<br/>init DataLoaders<br/>@directive eval\n    gqlgen->>Resolver: resolve fields\n    Resolver->>Resolver: service call\n    Resolver->>FallbackChain: ExecuteCommand()\n    Note over FallbackChain: CB check<br/>adapter.Exec\n    FallbackChain--\x3e>Resolver: CommandResult\n    Resolver--\x3e>gqlgen: domain object\n    gqlgen--\x3e>EchoServer: GraphQL field\n    EchoServer--\x3e>Client: JSON response (200 OK)"}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"step-by-step-walkthrough",children:"Step-by-Step Walkthrough"}),"\n",(0,i.jsx)(r.h3,{id:"step-1-tcp-arrival-and-echo-routing",children:"Step 1: TCP Arrival and Echo Routing"}),"\n",(0,i.jsxs)(r.p,{children:["The Echo HTTP server (",(0,i.jsx)(r.code,{children:"internal/server/server.go"}),") listens on ",(0,i.jsx)(r.code,{children:"0.0.0.0:{PORT}"})," (defaults: 80 in\nproduction, 8080 in development). Echo's router matches the incoming ",(0,i.jsx)(r.code,{children:"POST /graphql"})," path and\ndispatches to the registered GraphQL handler."]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Server configuration"})," (",(0,i.jsx)(r.code,{children:"DefaultProdConfig"}),"):"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"ReadTimeout: 30s"})," \u2014 maximum time to read the full request body"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"WriteTimeout: 30s"})," \u2014 maximum time to write the response"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"IdleTimeout: 60s"})," \u2014 keep-alive idle timeout"]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["The server uses ",(0,i.jsx)(r.code,{children:"echo.New()"})," with ",(0,i.jsx)(r.code,{children:"HideBanner: true"})," and ",(0,i.jsx)(r.code,{children:"HidePort: true"})," for clean log output.\nGraceful shutdown is managed via ",(0,i.jsx)(r.code,{children:"SIGINT"}),"/",(0,i.jsx)(r.code,{children:"SIGTERM"})," handling with a 15-second drain window."]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"File:"})," ",(0,i.jsx)(r.code,{children:"internal/server/server.go"})]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-2-middleware-stack",children:"Step 2: Middleware Stack"}),"\n",(0,i.jsx)(r.p,{children:"Middleware executes in registration order before the GraphQL handler is invoked. Two key middlewares\nrun for every GraphQL request:"}),"\n",(0,i.jsx)(r.h4,{id:"2a-request-id-middleware",children:"2a. Request ID Middleware"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"File:"})," ",(0,i.jsx)(r.code,{children:"internal/middleware/request_id.go"})]}),"\n",(0,i.jsx)(r.mermaid,{value:'flowchart TD\n    A["RequestIDMiddleware"] --\x3e B["Read X-Request-ID header"]\n    B --\x3e C{Header absent?}\n    C --\x3e|Yes| D["GenerateRequestID() \u2192 ULID"]\n    D --\x3e E["(time-sortable, globally unique)"]\n    C --\x3e|No| F["Use existing ID"]\n    E --\x3e G["Set X-Request-ID response header"]\n    F --\x3e G\n    G --\x3e H["ctx = apperrors.WithRequestID(ctx, requestID)"]'}),"\n",(0,i.jsxs)(r.p,{children:["The ULID is stored in context via ",(0,i.jsx)(r.code,{children:"apperrors.WithRequestID()"})," and propagates through the entire call\nstack. It surfaces in:"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Error responses (as ",(0,i.jsx)(r.code,{children:"extensions.requestId"}),")"]}),"\n",(0,i.jsxs)(r.li,{children:["Structured log fields (",(0,i.jsx)(r.code,{children:"request_id"}),")"]}),"\n",(0,i.jsx)(r.li,{children:"Event bus events emitted during request handling"}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Key constant:"})," ",(0,i.jsx)(r.code,{children:'RequestIDHeader = "X-Request-ID"'})]}),"\n",(0,i.jsx)(r.h4,{id:"2b-auth-middleware",children:"2b. Auth Middleware"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"File:"})," ",(0,i.jsx)(r.code,{children:"internal/middleware/auth.go"})]}),"\n",(0,i.jsx)(r.mermaid,{value:'flowchart TD\n    A["AuthMiddleware"] --\x3e B["Skipper check:<br/>/health, /ready, /playground"]\n    B --\x3e|Skip auth| C["Return"]\n    B --\x3e|Continue| D["tryAuthenticate()"]\n\n    D --\x3e E["Method 1: Authorization Bearer"]\n    E --\x3e E1["JWTService.ValidateToken token"]\n\n    D --\x3e F["Method 2: access_token cookie"]\n    F --\x3e F1["JWTService.ValidateToken cookieValue"]\n\n    D --\x3e G["Method 3: X-API-Key header"]\n    G --\x3e G1["APIKeyValidator ctx, apiKey"]\n\n    E1 --\x3e H{Any method<br/>succeeded?}\n    F1 --\x3e H\n    G1 --\x3e H\n\n    H --\x3e|No| I["401 Unauthorized"]\n    H --\x3e|Yes| J["setAuthContext ctx, result"]\n\n    J --\x3e J1["ctx UserContextKey = AuthUser"]\n    J1 --\x3e J2["ctx ClaimsContextKey = Claims"]\n    J2 --\x3e J3["ctx AuthMethodContextKey = jwt | api_key | session"]\n    J3 --\x3e J4["ctx SessionContextKey = SessionInfo"]\n\n    J4 --\x3e K["handleTokenRefresh: sliding session"]\n    K --\x3e K1["Refreshes token if near expiry"]\n    K1 --\x3e K2["Sets new access_token cookie"]'}),"\n",(0,i.jsxs)(r.p,{children:["The authenticated ",(0,i.jsx)(r.code,{children:"AuthUser"})," is available in all downstream resolvers via\n",(0,i.jsx)(r.code,{children:"middleware.UserFromContext(ctx)"}),"."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Supported auth methods:"})}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Method"}),(0,i.jsx)(r.th,{children:"Header/Cookie"}),(0,i.jsx)(r.th,{children:"Flow"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"JWT Bearer"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"Authorization: Bearer <token>"})}),(0,i.jsx)(r.td,{children:"Validate \u2192 decode claims"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Session cookie"}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:"access_token"})," cookie (HttpOnly)"]}),(0,i.jsx)(r.td,{children:"Validate \u2192 decode claims"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"API key"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"X-API-Key: nas_xxx"})}),(0,i.jsxs)(r.td,{children:["Call ",(0,i.jsx)(r.code,{children:"APIKeyValidator"})]})]})]})]}),"\n",(0,i.jsx)(r.p,{children:"[See: 12-security.md \xa7JWT Authentication] for token structure and signing details."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-3-graphql-handler-entry",children:"Step 3: GraphQL Handler Entry"}),"\n",(0,i.jsx)(r.p,{children:"The gqlgen-generated GraphQL handler receives the parsed HTTP request and begins operation\nprocessing:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Parse operation"})," \u2014 deserialize the JSON body (",(0,i.jsx)(r.code,{children:"{ query, variables, operationName }"}),")"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Validate schema"})," \u2014 check that field selections and arguments are valid per the schema"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Complexity calculation"})," \u2014 prevent expensive queries (depth limiting, field counting)"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"DataLoader initialization"})," \u2014 create per-request batching loaders (see Step 4)"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Directive evaluation"})," \u2014 apply ",(0,i.jsx)(r.code,{children:"@auth"}),", ",(0,i.jsx)(r.code,{children:"@validate"}),", ",(0,i.jsx)(r.code,{children:"@sensitive"}),", ",(0,i.jsx)(r.code,{children:"@capability"})," directives\n(see Step 5)"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Resolver dispatch"})," \u2014 call root resolvers for selected fields (see Step 6)"]}),"\n"]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-4-dataloader-initialization-per-request",children:"Step 4: DataLoader Initialization (Per-Request)"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Files:"})," ",(0,i.jsx)(r.code,{children:"internal/graphql/loaders/resource_loader.go"}),",\n",(0,i.jsx)(r.code,{children:"internal/graphql/loaders/router_loader.go"}),", ",(0,i.jsx)(r.code,{children:"internal/graphql/loaders/helpers.go"})]}),"\n",(0,i.jsx)(r.p,{children:"DataLoaders are initialized fresh per request (not shared across requests) to prevent cross-request\ncache pollution:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"Request context\n  \u2514\u2500 ResourceLoader    (batches resource IDs \u2192 single DB query)\n  \u2514\u2500 RouterLoader      (batches router IDs \u2192 single DB query)\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"How DataLoader batching works:"})}),"\n",(0,i.jsxs)(r.p,{children:["When a resolver calls ",(0,i.jsx)(r.code,{children:"loader.Load(ctx, id)"}),", the DataLoader does not immediately execute a database\nquery. Instead, it collects all load calls made during the same scheduler tick, then fires a single\nbatch query:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'Resolver A: loader.Load(ctx, "id-1")  \u2510\nResolver B: loader.Load(ctx, "id-2")  \u251c\u2500 collected \u2192 db.Query(WHERE id IN ("id-1","id-2","id-3"))\nResolver C: loader.Load(ctx, "id-3")  \u2518\n'})}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"mapToResults()"})," helper maps batch results back to the original key order, handling partial\nfailures with per-key ",(0,i.jsx)(r.code,{children:"NotFoundError"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Batch capacity:"})," 100 keys per batch (configurable). Prevents unbounded queries on large result\nsets."]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"After mutations:"})," Call ",(0,i.jsx)(r.code,{children:"loader.Clear(ctx, id)"})," or ",(0,i.jsx)(r.code,{children:"loader.ClearAll()"})," to invalidate cached\nentries and ensure fresh reads."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-5-custom-directive-evaluation",children:"Step 5: Custom Directive Evaluation"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"File:"})," ",(0,i.jsx)(r.code,{children:"internal/graphql/directives/directives.go"})]}),"\n",(0,i.jsx)(r.p,{children:"Four custom directives intercept field resolution before resolver functions execute:"}),"\n",(0,i.jsx)(r.h4,{id:"auth--authorization",children:"@auth \u2014 Authorization"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'@auth(requires: "ADMIN")\n  \u251c\u2500 GetAuthInfo(ctx) \u2014 reads auth info placed by middleware\n  \u251c\u2500 authInfo.Authenticated == false \u2192 gqlerror A401 (auth/authentication-required)\n  \u2514\u2500 requires != nil \u2192 check authInfo.Roles contains required role\n      \u2514\u2500 missing role \u2192 gqlerror A401 (auth/insufficient-permissions)\n'})}),"\n",(0,i.jsxs)(r.p,{children:["Note: The HTTP-layer ",(0,i.jsx)(r.code,{children:"AuthMiddleware"})," enforces authentication for all requests. The ",(0,i.jsx)(r.code,{children:"@auth"}),"\ndirective provides ",(0,i.jsx)(r.strong,{children:"field-level"})," role checks within already-authenticated requests."]}),"\n",(0,i.jsx)(r.h4,{id:"validate--input-validation",children:"@validate \u2014 Input Validation"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"@validate(minLength: 1, maxLength: 255, format: IPV4)\n  \u251c\u2500 Resolve field value first (calls next(ctx))\n  \u251c\u2500 Numeric: validateNumericRange(min, max)\n  \u2514\u2500 String: validateStringConstraints(minLength, maxLength, pattern, format)\n      \u2514\u2500 format: EMAIL | URL | UUID | IPV4 | IPV6 | MAC | CIDR | HOSTNAME | FQDN\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Validation errors are returned as ",(0,i.jsx)(r.code,{children:"gqlerror.Error"})," with ",(0,i.jsx)(r.code,{children:'extensions.code = "V400"'})," and a\n",(0,i.jsx)(r.code,{children:"suggestedFix"})," field for the client."]}),"\n",(0,i.jsx)(r.h4,{id:"sensitive--log-redaction",children:"@sensitive \u2014 Log Redaction"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'@sensitive\n  \u251c\u2500 Track field path in ctx[sensitiveContextKey]\n  \u2514\u2500 createValidationError() checks: if field is sensitive \u2192 value = "[REDACTED]"\n'})}),"\n",(0,i.jsx)(r.p,{children:"Marks fields containing credentials or PII. The directive does not prevent the value from being\nreturned to the client \u2014 it prevents the value from appearing in error extensions and logs."}),"\n",(0,i.jsx)(r.h4,{id:"capability--router-feature-gating",children:"@capability \u2014 Router Feature Gating"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'@capability(requires: ["wireguard", "container"])\n  \u251c\u2500 GetCapabilities(ctx) \u2014 capabilities loaded per-request from CapabilityService\n  \u251c\u2500 Check each required cap against capMap\n  \u2514\u2500 Missing caps \u2192 gqlerror C403 (capability/unsupported) with missingCapabilities list\n'})}),"\n",(0,i.jsxs)(r.p,{children:["Router capabilities are detected once per connection and cached by ",(0,i.jsx)(r.code,{children:"CapabilityService"}),". They are\ninjected into the request context before the GraphQL handler runs."]}),"\n",(0,i.jsx)(r.p,{children:"[See: 17-validation-pipeline.md] for complete validation error structure and error codes."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-6-resolver-execution",children:"Step 6: Resolver Execution"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Files:"})," ",(0,i.jsx)(r.code,{children:"graph/resolver/resolver.go"}),", ",(0,i.jsx)(r.code,{children:"graph/resolver/common_helpers.go"})]}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"Resolver"})," struct holds references to all domain services injected at startup. Each generated\nresolver file (e.g., ",(0,i.jsx)(r.code,{children:"core-queries.resolvers.go"}),", ",(0,i.jsx)(r.code,{children:"services-crud-ops.resolvers.go"}),") implements\nmethods on ",(0,i.jsx)(r.code,{children:"*queryResolver"})," or ",(0,i.jsx)(r.code,{children:"*mutationResolver"})," which embed ",(0,i.jsx)(r.code,{children:"*Resolver"}),"."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Context helpers used in resolvers:"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:"// Extract authenticated user\nuser := middleware.UserFromContext(ctx)\n\n// Extract request ID for error correlation\nrequestID := apperrors.GetRequestID(ctx)\n\n// Extract user ID (validated, returns error if unauthenticated)\nuserID, err := getUserIDFromContext(ctx)\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Typical query resolver pattern:"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"resolver.GetRouter(ctx, id)\n  \u251c\u2500 middleware.UserFromContext(ctx)           \u2192 verify authenticated\n  \u251c\u2500 r.RouterService.GetByID(ctx, id)         \u2192 service call\n  \u2502   \u2514\u2500 entDB.Router.Query().Where(id)       \u2192 database read\n  \u2514\u2500 convert ent.Router \u2192 model.Router        \u2192 return GraphQL type\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Typical mutation resolver pattern:"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'resolver.UpdateFirewallRule(ctx, input)\n  \u251c\u2500 middleware.UserFromContext(ctx)\n  \u251c\u2500 validate input (service-level)\n  \u251c\u2500 r.RouterService.GetConnection(ctx, routerID) \u2192 get RouterPort\n  \u251c\u2500 build Command{Path: "/ip/firewall/filter/set", Params: {...}}\n  \u251c\u2500 conn.ExecuteCommand(ctx, cmd)             \u2192 send to router\n  \u251c\u2500 update local DB record\n  \u2514\u2500 return updated model\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-7-router-command-translation",children:"Step 7: Router Command Translation"}),"\n",(0,i.jsx)(r.p,{children:"Before commands reach the wire, they are translated from the GraphQL input model to\nRouterOS-specific command parameters."}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Key layer:"})," ",(0,i.jsx)(r.code,{children:"internal/router/ssh/translator.go"})," (SSH adapter) and\n",(0,i.jsx)(r.code,{children:"internal/router/adapters/mikrotik/"})," (API/REST adapters)."]}),"\n",(0,i.jsx)(r.p,{children:"The translation layer handles:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Field name mapping (camelCase GraphQL fields \u2192 kebab-case RouterOS properties)"}),"\n",(0,i.jsxs)(r.li,{children:["Type coercion (Go booleans \u2192 ",(0,i.jsx)(r.code,{children:'"yes"/"no"'})," strings for RouterOS)"]}),"\n",(0,i.jsxs)(r.li,{children:["Duration formatting (Go ",(0,i.jsx)(r.code,{children:"time.Duration"})," \u2192 RouterOS duration strings like ",(0,i.jsx)(r.code,{children:'"1h30m"'}),")"]}),"\n",(0,i.jsx)(r.li,{children:"Enumeration mapping (GraphQL enum values \u2192 RouterOS constants)"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"[See: 16-translator-layer.md] for complete field mapping tables and formatter implementations."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-8-routeros-command-execution-via-fallbackchain",children:"Step 8: RouterOS Command Execution via FallbackChain"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"File:"})," ",(0,i.jsx)(r.code,{children:"internal/router/fallback_chain.go"})]}),"\n",(0,i.jsxs)(r.p,{children:["Every router command executes through the ",(0,i.jsx)(r.code,{children:"FallbackChain"}),", which provides:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"FallbackChain.ExecuteCommand(ctx, cmd)\n  \u2502\n  \u251c\u2500 fc.mu.RLock() \u2192 get currentPort (adapter) + currentProto\n  \u2502\n  \u251c\u2500 CircuitBreaker.Execute(func):\n  \u2502   \u251c\u2500 CB state == Open \u2192 return error (skip this protocol)\n  \u2502   \u251c\u2500 CB state == HalfOpen \u2192 allow 1 test request\n  \u2502   \u2514\u2500 CB state == Closed \u2192 allow request\n  \u2502       \u2514\u2500 adapter.ExecuteCommand(ctx, cmd)\n  \u2502           \u251c\u2500 REST adapter: HTTP PUT/POST to RouterOS REST API\n  \u2502           \u251c\u2500 API adapter: binary RouterOS API sentence\n  \u2502           \u251c\u2500 SSH adapter: SSH command via translator\n  \u2502           \u2514\u2500 Telnet adapter: legacy terminal commands\n  \u2502\n  \u251c\u2500 On success \u2192 return *CommandResult\n  \u2514\u2500 On error:\n      \u251c\u2500 CB records failure\n      \u251c\u2500 If CB opens \u2192 go fc.attemptReconnect(background ctx)\n      \u2514\u2500 Return error to resolver\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Protocol fallback order:"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"REST \u2192 API \u2192 API+SSL \u2192 SSH \u2192 Telnet\n"})}),"\n",(0,i.jsx)(r.p,{children:"Each protocol has its own circuit breaker (3 consecutive failures \u2192 open for 5 minutes)."}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Automatic reconnection:"})," When a circuit breaker opens, a background goroutine attempts\nreconnection through the fallback chain, trying each protocol in order and skipping open circuits.\nStatus changes are published as ",(0,i.jsx)(r.code,{children:"RouterStatusChangedEvent"})," on the event bus (within 100ms)."]}),"\n",(0,i.jsx)(r.p,{children:"[See: 04-router-communication.md \xa7FallbackChain] for circuit breaker state machine and reconnection\ndetails. [See: 15-connection-management.md] for the connection pool and per-router connection lifecycle."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-9-response-translation",children:"Step 9: Response Translation"}),"\n",(0,i.jsx)(r.p,{children:"After the router returns raw output (e.g., RouterOS API response maps or SSH parsed tables), the\ntranslator converts it back to Go structs and then to GraphQL model types."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'RouterOS response (map[string]string or []map[string]string)\n    \u2502\n    \u251c\u2500 SSH adapter: parser (terse/table/keyvalue/detail)\n    \u251c\u2500 API adapter: binary sentence \u2192 Go map\n    \u2514\u2500 REST adapter: JSON \u2192 Go map\n    \u2502\n    \u2514\u2500 Translator.ResponseToModel(rawOutput, targetType)\n        \u2514\u2500 Field mapper: "mac-address" \u2192 MacAddress, "tx-byte" \u2192 TxBytes\n        \u2514\u2500 Return *model.Interface or []model.FirewallRule etc.\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-10-error-presentation",children:"Step 10: Error Presentation"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"File:"})," ",(0,i.jsx)(r.code,{children:"internal/apperrors/"})," (see internal errors package)"]}),"\n",(0,i.jsxs)(r.p,{children:["Errors propagate up through the resolver stack as Go errors. The gqlgen error presenter converts\nthem to ",(0,i.jsx)(r.code,{children:"gqlerror.Error"})," entries in the ",(0,i.jsx)(r.code,{children:"errors"})," array of the GraphQL response."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Error categories and codes:"})}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Code"}),(0,i.jsx)(r.th,{children:"Category"}),(0,i.jsx)(r.th,{children:"Example"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"V400"})}),(0,i.jsx)(r.td,{children:"Validation"}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:"@validate"})," directive violation"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"A401"})}),(0,i.jsx)(r.td,{children:"Auth"}),(0,i.jsx)(r.td,{children:"Missing authentication, insufficient role"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"C403"})}),(0,i.jsx)(r.td,{children:"Capability"}),(0,i.jsx)(r.td,{children:"Router lacks required feature"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"N404"})}),(0,i.jsx)(r.td,{children:"Not found"}),(0,i.jsx)(r.td,{children:"Resource not in database"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"R500"})}),(0,i.jsx)(r.td,{children:"Router"}),(0,i.jsx)(r.td,{children:"RouterOS command failed"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"S503"})}),(0,i.jsx)(r.td,{children:"Service"}),(0,i.jsx)(r.td,{children:"Backend service unavailable"})]})]})]}),"\n",(0,i.jsxs)(r.p,{children:["In production mode (",(0,i.jsx)(r.code,{children:"GO_ENV=production"}),"), error messages are sanitized:"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Internal implementation details stripped"}),"\n",(0,i.jsxs)(r.li,{children:["Sensitive field values redacted (",(0,i.jsx)(r.code,{children:"[REDACTED]"}),")"]}),"\n",(0,i.jsx)(r.li,{children:"Stack traces removed from response"}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"requestId"})," field in every error extension enables correlation with server logs."]}),"\n",(0,i.jsx)(r.p,{children:"[See: 14-error-handling.md] for complete error code taxonomy, redaction rules, and suggestion generation."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"step-11-response-serialization",children:"Step 11: Response Serialization"}),"\n",(0,i.jsx)(r.p,{children:"gqlgen assembles the final JSON response:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\n  "data": {\n    "router": {\n      "id": "01JZABC123",\n      "name": "HomeRouter",\n      "interfaces": [...]\n    }\n  },\n  "errors": [],\n  "extensions": {}\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:["For partial success (some fields errored, others succeeded): both ",(0,i.jsx)(r.code,{children:"data"})," and ",(0,i.jsx)(r.code,{children:"errors"})," are populated.\nGraphQL clients must handle this case."]}),"\n",(0,i.jsxs)(r.p,{children:["For complete failure (auth error, parse error): ",(0,i.jsx)(r.code,{children:"data"})," is ",(0,i.jsx)(r.code,{children:"null"}),", ",(0,i.jsx)(r.code,{children:"errors"})," array is non-empty."]}),"\n",(0,i.jsxs)(r.p,{children:["The HTTP status code is always ",(0,i.jsx)(r.code,{children:"200 OK"})," for valid GraphQL responses, even when the ",(0,i.jsx)(r.code,{children:"errors"})," array is\nnon-empty. HTTP 4xx/5xx are only returned for transport-level failures (malformed JSON body,\nconnection errors)."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"subscription-lifecycle-websocket",children:"Subscription Lifecycle (WebSocket)"}),"\n",(0,i.jsx)(r.p,{children:"Subscriptions diverge from queries/mutations after Step 2 (middleware):"}),"\n",(0,i.jsx)(r.mermaid,{value:'sequenceDiagram\n    participant Client\n    participant EchoServer as Echo Server\n    participant gqlgen\n    participant EventBus\n\n    Client->>EchoServer: GET /graphql (Upgrade)\n    Note over EchoServer: WebSocket upgrade<br/>Auth middleware\n    EchoServer--\x3e>Client: 101 Switching Protocols\n\n    Client->>EchoServer: { type: "subscribe" }\n    EchoServer->>gqlgen: start resolver\n    gqlgen->>EventBus: Subscribe()\n\n    loop Streaming\n        EventBus--\x3e>gqlgen: event\n        gqlgen--\x3e>EchoServer: { type: "next" }\n        EchoServer--\x3e>Client: subscription event\n    end\n\n    Client->>EchoServer: { type: "complete" }\n    EchoServer->>EventBus: Unsubscribe()'}),"\n",(0,i.jsxs)(r.p,{children:["Auth middleware applies identically on the WebSocket upgrade request. The subscription resolver\ncreates a channel, subscribes to the appropriate event bus topic, and streams events until the\nclient disconnects or sends ",(0,i.jsx)(r.code,{children:"complete"}),"."]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"full-timing-breakdown",children:"Full Timing Breakdown"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Phase"}),(0,i.jsx)(r.th,{children:"Typical Duration"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"TCP + Echo routing"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"<1ms"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Request ID generation (ULID)"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"<0.1ms"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"JWT validation"}),(0,i.jsx)(r.td,{children:"1\u20133ms"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"GraphQL parse + validate"}),(0,i.jsx)(r.td,{children:"1\u20135ms"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Directive evaluation"}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:"<1ms"})," per field"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"DataLoader scheduling (tick)"}),(0,i.jsx)(r.td,{children:"~1ms wait"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"DataLoader batch DB query"}),(0,i.jsx)(r.td,{children:"1\u201310ms"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Resolver logic"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"<1ms"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Router command (REST)"}),(0,i.jsx)(r.td,{children:"10\u201350ms"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Router command (SSH)"}),(0,i.jsx)(r.td,{children:"50\u2013200ms"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Response serialization"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"<1ms"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Total (REST path)"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"~20\u201370ms"})})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"Total (SSH path)"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.strong,{children:"~60\u2013220ms"})})]})]})]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"[See: 03-graphql-api.md \xa7Resolvers] \u2014 resolver structure, generated files, schema-first\nconventions"}),"\n",(0,i.jsx)(r.li,{children:"[See: 03-graphql-api.md \xa7Mutations] \u2014 mutation resolver patterns, changeset flow"}),"\n",(0,i.jsx)(r.li,{children:"[See: 04-router-communication.md \xa7FallbackChain] \u2014 protocol selection, circuit breaker state\nmachine"}),"\n",(0,i.jsx)(r.li,{children:"[See: 12-security.md \xa7JWT Authentication] \u2014 token structure, claims, signing algorithm"}),"\n",(0,i.jsx)(r.li,{children:"[See: 14-error-handling.md] \u2014 error code taxonomy, redaction, suggestions"}),"\n",(0,i.jsx)(r.li,{children:"[See: 15-connection-management.md] \u2014 connection pool, per-router lifecycle, reconnection"}),"\n",(0,i.jsx)(r.li,{children:"[See: 16-translator-layer.md] \u2014 field mapping, type coercion, response translation"}),"\n",(0,i.jsx)(r.li,{children:"[See: 17-validation-pipeline.md] \u2014 @validate directive constraints and error format"}),"\n",(0,i.jsx)(r.li,{children:"[See: 05-event-system.md] \u2014 event bus topics consumed by subscription resolvers"}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},71184:(e,r,n)=>{n.d(r,{R:()=>l,x:()=>a});var t=n(14041);const i={},s=t.createContext(i);function l(e){const r=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);