"use strict";(globalThis.webpackChunk_nas_net_docs=globalThis.webpackChunk_nas_net_docs||[]).push([[29837],{48265:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"error-handling","title":"Error Handling & Structured Logging","description":"Hierarchical error types, automatic log-level routing, GraphQL error presentation, and sensitive-data redaction across the NasNetConnect backend.","source":"@site/../backend/docs/error-handling.md","sourceDirName":".","slug":"/error-handling","permalink":"/docs/backend/error-handling","draft":false,"unlisted":false,"editUrl":"https://github.com/nasnet-community/nasnet-panel/tree/main/../backend/docs/error-handling.md","tags":[],"version":"current","frontMatter":{},"sidebar":"sidebar","previous":{"title":"Data Layer","permalink":"/docs/backend/data-layer"},"next":{"title":"Event System","permalink":"/docs/backend/event-system"}}');var o=n(31085),d=n(71184);const i={},t="Error Handling & Structured Logging",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Package Reference",id:"package-reference",level:2},{value:"<code>internal/apperrors</code>",id:"internalapperrors",level:3},{value:"Error Categories &amp; Codes",id:"error-categories--codes",level:4},{value:"Base Type: <code>RouterError</code>",id:"base-type-routererror",level:4},{value:"Specialized Error Types",id:"specialized-error-types",level:4},{value:"Helper Functions",id:"helper-functions",level:4},{value:"Error Presentation for GraphQL (<code>presenter.go</code>)",id:"error-presentation-for-graphql-presentergo",level:3},{value:"Suggested Fixes &amp; Docs URLs (<code>suggestions.go</code>)",id:"suggested-fixes--docs-urls-suggestionsgo",level:3},{value:"Sensitive Data Redaction (<code>redactor.go</code>)",id:"sensitive-data-redaction-redactorgo",level:3},{value:"Structured Logging (<code>logger.go</code>)",id:"structured-logging-loggergo",level:3},{value:"Error Logging Integration (<code>logging.go</code>)",id:"error-logging-integration-logginggo",level:3},{value:"Request ID Correlation",id:"request-id-correlation",level:2},{value:"GraphQL Directive Error Handling",id:"graphql-directive-error-handling",level:2},{value:"Error Handling Patterns",id:"error-handling-patterns",level:2},{value:"Cross-References",id:"cross-references",level:2}];function a(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"error-handling--structured-logging",children:"Error Handling & Structured Logging"})}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"Hierarchical error types, automatic log-level routing, GraphQL error presentation, and sensitive-data redaction across the NasNetConnect backend."}),"\n"]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Packages:"})," ",(0,o.jsx)(r.code,{children:"internal/apperrors/"}),", ",(0,o.jsx)(r.code,{children:"internal/logger/"}),"\n",(0,o.jsx)(r.strong,{children:"Key Files:"})," ",(0,o.jsx)(r.code,{children:"apperrors/errors.go"}),", ",(0,o.jsx)(r.code,{children:"apperrors/presenter.go"}),", ",(0,o.jsx)(r.code,{children:"apperrors/logging.go"}),", ",(0,o.jsx)(r.code,{children:"apperrors/redactor.go"}),", ",(0,o.jsx)(r.code,{children:"apperrors/suggestions.go"}),", ",(0,o.jsx)(r.code,{children:"logger/logger.go"}),"\n",(0,o.jsx)(r.strong,{children:"Prerequisites:"})," [See: 03-graphql-api.md \xa7Error Handling], [See: 12-security.md \xa7Audit Logging]"]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsx)(r.p,{children:"NasNetConnect uses a two-layer approach to error handling:"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"internal/apperrors"})})," \u2014 A domain-specific error hierarchy with codes, categories, suggested fixes, and documentation URLs. All errors that cross a package boundary should be expressed as a ",(0,o.jsx)(r.code,{children:"RouterError"})," or one of its specializations."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"internal/logger"})})," \u2014 A thin wrapper around ",(0,o.jsx)(r.code,{children:"go.uber.org/zap"})," that initializes a global logger, attaches request-ID correlation, and exposes convenience helpers for context-aware logging."]}),"\n"]}),"\n",(0,o.jsxs)(r.p,{children:["The two layers connect through ",(0,o.jsx)(r.code,{children:"apperrors.LogLevel()"}),", which maps each error category to the appropriate zap level, and ",(0,o.jsx)(r.code,{children:"apperrors.ErrorFields()"}),", which extracts structured zap fields (with automatic redaction of sensitive keys) for use in ",(0,o.jsx)(r.code,{children:"logger.Error(\u2026)"})," calls."]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"GraphQL Resolver\n      \u2502\n      \u2502  returns error\n      \u25bc\napperrors.ErrorPresenter (gqlgen hook)\n      \u2502\n      \u251c\u2500\u25ba errors.As(RouterError) \u2500\u2500\u25ba presentRouterError()\n      \u2502                                    \u2502\n      \u2502                                    \u251c\u2500 RedactErrorForProduction() (isProduction=true)\n      \u2502                                    \u251c\u2500 buildExtensions()           \u2192 code, category, requestId\n      \u2502                                    \u251c\u2500 SuggestedFix()              \u2192 human-readable hint\n      \u2502                                    \u251c\u2500 DocsURL()                   \u2192 https://docs.nasnet.io/errors/\u2026\n      \u2502                                    \u2514\u2500 TroubleshootingSteps()      \u2192 ordered checklist\n      \u2502\n      \u251c\u2500\u25ba errors.As(*gqlerror.Error) \u2500\u2500\u25ba pass-through + inject requestId\n      \u2502\n      \u2514\u2500\u25ba unknown error \u2500\u2500\u25ba presentUnknownError() \u2192 generic I500 response (redacted in prod)\n\ninternal/logger\n      \u2502\n      \u251c\u2500 logger.Init(cfg)  \u2500 once.Do singleton (JSON prod / console dev)\n      \u251c\u2500 logger.L()        \u2500 global *zap.Logger\n      \u251c\u2500 logger.WithRequestID(ctx) \u2500 attaches request_id field from context\n      \u2514\u2500 logger.{Debug,Info,Warn,Error}Ctx(ctx, \u2026) \u2500 shorthand with request correlation\n\napperrors.LogError(logger, err)\n      \u2502\n      \u251c\u2500 GetRouterError(err)        \u2192 unwrap to RouterError\n      \u251c\u2500 LogLevel(category)         \u2192 map category \u2192 zap.Level\n      \u2514\u2500 ErrorFields(err)           \u2192 []zap.Field with redacted context\n"})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"package-reference",children:"Package Reference"}),"\n",(0,o.jsx)(r.h3,{id:"internalapperrors",children:(0,o.jsx)(r.code,{children:"internal/apperrors"})}),"\n",(0,o.jsx)(r.h4,{id:"error-categories--codes",children:"Error Categories & Codes"}),"\n",(0,o.jsxs)(r.p,{children:["Every error has an ",(0,o.jsx)(r.code,{children:"ErrorCategory"})," string and a short alphanumeric error code."]}),"\n",(0,o.jsxs)(r.table,{children:[(0,o.jsx)(r.thead,{children:(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.th,{children:"Category"}),(0,o.jsx)(r.th,{children:"Prefix"}),(0,o.jsx)(r.th,{children:"Example Code"}),(0,o.jsx)(r.th,{children:"Log Level"})]})}),(0,o.jsxs)(r.tbody,{children:[(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"platform"})}),(0,o.jsx)(r.td,{children:"P1xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"P100"})," PlatformNotSupported"]}),(0,o.jsx)(r.td,{children:"Warn"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"protocol"})}),(0,o.jsx)(r.td,{children:"R2xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"R200"})," ConnectionFailed"]}),(0,o.jsx)(r.td,{children:"Warn"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"network"})}),(0,o.jsx)(r.td,{children:"N3xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"N300"})," HostUnreachable"]}),(0,o.jsx)(r.td,{children:"Warn"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"validation"})}),(0,o.jsx)(r.td,{children:"V4xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"V400"})," ValidationFailed"]}),(0,o.jsx)(r.td,{children:"Warn"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"auth"})}),(0,o.jsx)(r.td,{children:"A5xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"A500"})," AuthFailed"]}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.strong,{children:"Info"})})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"resource"})}),(0,o.jsx)(r.td,{children:"S6xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"S600"})," ResourceNotFound"]}),(0,o.jsx)(r.td,{children:"Warn"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"internal"})}),(0,o.jsx)(r.td,{children:"I5xx"}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"I500"})," Internal"]}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.strong,{children:"Error"})})]})]})]}),"\n",(0,o.jsxs)(r.p,{children:["Auth failures are intentionally logged at ",(0,o.jsx)(r.code,{children:"Info"})," because they are expected operational events; internal errors are ",(0,o.jsx)(r.code,{children:"Error"})," because they require investigation."]}),"\n",(0,o.jsxs)(r.h4,{id:"base-type-routererror",children:["Base Type: ",(0,o.jsx)(r.code,{children:"RouterError"})]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'type RouterError struct {\n    Code        string                 // e.g. "V400", "R200"\n    Category    ErrorCategory\n    Message     string\n    Recoverable bool\n    Context     map[string]interface{} // additional structured data (redacted before logging)\n    Cause       error                  // wrapped underlying error\n}\n\nfunc (e *RouterError) Error() string        // "[V400] Validation failed\u2026: cause"\nfunc (e *RouterError) Unwrap() error        // errors.Is / errors.As chain\nfunc (e *RouterError) Is(target error) bool // match by Code\nfunc (e *RouterError) WithContext(key, value) *RouterError\nfunc (e *RouterError) WithCause(err) *RouterError\n'})}),"\n",(0,o.jsx)(r.h4,{id:"specialized-error-types",children:"Specialized Error Types"}),"\n",(0,o.jsxs)(r.table,{children:[(0,o.jsx)(r.thead,{children:(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.th,{children:"Type"}),(0,o.jsx)(r.th,{children:"Constructor"}),(0,o.jsx)(r.th,{children:"Extra Fields"})]})}),(0,o.jsxs)(r.tbody,{children:[(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"PlatformError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewPlatformError(code, msg, platform)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"Platform"}),", ",(0,o.jsx)(r.code,{children:"Version"}),", ",(0,o.jsx)(r.code,{children:"NativeError"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"ProtocolError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewProtocolError(code, msg, protocol)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"Protocol"}),", ",(0,o.jsx)(r.code,{children:"RouterID"}),", ",(0,o.jsx)(r.code,{children:"RouterHost"}),", ",(0,o.jsx)(r.code,{children:"ConnectionID"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"ValidationError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewValidationError(field, value, constraint)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"Field"}),", ",(0,o.jsx)(r.code,{children:"Value"}),", ",(0,o.jsx)(r.code,{children:"Constraint"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"AuthError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewAuthError(code, msg)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"RequiredPermission"}),", ",(0,o.jsx)(r.code,{children:"CurrentPermission"}),", ",(0,o.jsx)(r.code,{children:"UserID"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NetworkError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewNetworkError(code, msg, host)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"Host"}),", ",(0,o.jsx)(r.code,{children:"Port"}),", ",(0,o.jsx)(r.code,{children:"Timeout"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"ResourceError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewResourceError(code, msg, type, id)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"ResourceType"}),", ",(0,o.jsx)(r.code,{children:"ResourceID"}),", ",(0,o.jsx)(r.code,{children:"CurrentState"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"InternalError"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"NewInternalError(msg, cause)"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"StackTrace"})," (dev only), ",(0,o.jsx)(r.code,{children:"Component"})]})]})]})]}),"\n",(0,o.jsx)(r.p,{children:"Fluid builder methods attach extra context without mutating the original:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'err := NewProtocolError(CodeConnectionFailed, "SSH refused", "SSH").\n    WithRouter(routerID, host).\n    WithConnectionID(connID)\n'})}),"\n",(0,o.jsx)(r.h4,{id:"helper-functions",children:"Helper Functions"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"// Inspection\nIsRouterError(err error) bool\nGetRouterError(err error) *RouterError\nIsCategory(err error, category ErrorCategory) bool\nIsRecoverable(err error) bool\n\n// Wrapping a raw error into RouterError\nWrap(err error, code string, category ErrorCategory, message string) *RouterError\n\n// Convenience GraphQL error constructors (for resolver use)\nNewGraphQLValidationError(ctx, field, message string, value interface{}) *gqlerror.Error\nNewGraphQLAuthError(ctx, message, code string) *gqlerror.Error\nNewGraphQLProtocolError(ctx, message, protocol, routerID string) *gqlerror.Error\n"})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.h3,{id:"error-presentation-for-graphql-presentergo",children:["Error Presentation for GraphQL (",(0,o.jsx)(r.code,{children:"presenter.go"}),")"]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"ErrorPresenter"})," is registered as the gqlgen error presenter (see ",(0,o.jsx)(r.code,{children:"03-graphql-api.md"}),"). It runs on every error returned from a resolver before it is sent to the client."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"func ErrorPresenter(ctx context.Context, err error) *gqlerror.Error\n"})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Flow:"})}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:["Extract ",(0,o.jsx)(r.code,{children:"requestID"})," from context (",(0,o.jsx)(r.code,{children:"apperrors.RequestIDKey"}),")."]}),"\n",(0,o.jsxs)(r.li,{children:["Check ",(0,o.jsx)(r.code,{children:"isProduction"})," flag from context (",(0,o.jsx)(r.code,{children:"apperrors.ProductionModeKey"}),")."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"errors.As(RouterError)"})," \u2192 ",(0,o.jsx)(r.code,{children:"presentRouterError()"}),":","\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["Production mode: call ",(0,o.jsx)(r.code,{children:"RedactErrorForProduction()"})," (strips internal details, redacts context)."]}),"\n",(0,o.jsxs)(r.li,{children:["Build ",(0,o.jsx)(r.code,{children:"extensions"})," map: ",(0,o.jsx)(r.code,{children:"code"}),", ",(0,o.jsx)(r.code,{children:"category"}),", ",(0,o.jsx)(r.code,{children:"recoverable"}),", ",(0,o.jsx)(r.code,{children:"requestId"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["Append ",(0,o.jsx)(r.code,{children:"suggestedFix"})," from ",(0,o.jsx)(r.code,{children:"SuggestedFix(err)"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["Append ",(0,o.jsx)(r.code,{children:"docsUrl"})," from ",(0,o.jsx)(r.code,{children:"DocsURL(code)"})," \u2192 ",(0,o.jsx)(r.code,{children:"https://docs.nasnet.io/errors/{category}#{code}"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["For ",(0,o.jsx)(r.code,{children:"protocol"}),"/",(0,o.jsx)(r.code,{children:"network"})," categories, append ",(0,o.jsx)(r.code,{children:"troubleshootingSteps"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["For validation errors, include ",(0,o.jsx)(r.code,{children:"field"})," and ",(0,o.jsx)(r.code,{children:"value"}),"."]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"errors.As(*gqlerror.Error)"})," \u2192 pass through + inject ",(0,o.jsx)(r.code,{children:"requestId"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["Unknown error \u2192 ",(0,o.jsx)(r.code,{children:"presentUnknownError()"})," (generic ",(0,o.jsx)(r.code,{children:"I500"}),", message redacted in production)."]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Configuring the presenter:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'presenter := apperrors.NewErrorPresenter(&apperrors.PresenterConfig{\n    Production:    true,\n    BaseDocsURL:   "https://docs.nasnet.io/errors",\n    IncludeStacks: false,\n})\n// Register with gqlgen server config\nsrv := handler.New(schema)\nsrv.SetErrorPresenter(presenter)\n'})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Example client response (validation error):"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-json",children:'{\n  "errors": [{\n    "message": "Validation failed for field \'listenPort\': must be >= 1024",\n    "path": ["createService", "input", "listenPort"],\n    "extensions": {\n      "code": "V400",\n      "category": "validation",\n      "field": "input.listenPort",\n      "value": 80,\n      "recoverable": true,\n      "requestId": "01H7XK\u2026",\n      "suggestedFix": "The field \'listenPort\' is out of range. Use a value >= 1024.",\n      "docsUrl": "https://docs.nasnet.io/errors/validation#v400"\n    }\n  }]\n}\n'})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Panic recovery:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"func ErrorRecoverer(ctx context.Context, p interface{}) error\n"})}),"\n",(0,o.jsxs)(r.p,{children:["Registered as gqlgen's ",(0,o.jsx)(r.code,{children:"RecoverFunc"}),". Converts panics to ",(0,o.jsx)(r.code,{children:"InternalError"})," with the request ID and panic value attached to the context map."]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.h3,{id:"suggested-fixes--docs-urls-suggestionsgo",children:["Suggested Fixes & Docs URLs (",(0,o.jsx)(r.code,{children:"suggestions.go"}),")"]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"SuggestedFix(err)"})," inspects the concrete error type and code to produce a human-readable action item:"]}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Validation"})," \u2014 field name + constraint description"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Protocol"})," \u2014 per-code hint mentioning the protocol and possible causes"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Auth"})," \u2014 distinguishes expired session, insufficient permissions, invalid credentials"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Network"})," \u2014 mentions the target host, suggests ping/traceroute"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Platform"})," \u2014 suggests firmware upgrade or package installation"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Resource"})," \u2014 mentions the resource type, ID, and current state"]}),"\n"]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"DocsURL(code)"})," generates the documentation URL:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"https://docs.nasnet.io/errors/{category_path}#{lowercase_code}\n"})}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"TroubleshootingSteps(err)"})," returns an ordered ",(0,o.jsx)(r.code,{children:"[]string"})," checklist for ",(0,o.jsx)(r.code,{children:"protocol"})," and ",(0,o.jsx)(r.code,{children:"network"})," errors (also included in the GraphQL error extension)."]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"HTTPStatusCode(err)"})," maps error categories to HTTP status codes for any REST error responses:"]}),"\n",(0,o.jsxs)(r.table,{children:[(0,o.jsx)(r.thead,{children:(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.th,{children:"Category"}),(0,o.jsx)(r.th,{children:"Status"})]})}),(0,o.jsxs)(r.tbody,{children:[(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"validation"})}),(0,o.jsx)(r.td,{children:"400"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"auth"})," (session/credentials)"]}),(0,o.jsx)(r.td,{children:"401"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"auth"})," (permissions)"]}),(0,o.jsx)(r.td,{children:"403"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"resource"})," (not found)"]}),(0,o.jsx)(r.td,{children:"404"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"resource"})," (locked/busy)"]}),(0,o.jsx)(r.td,{children:"409"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"resource"})," (bad state)"]}),(0,o.jsx)(r.td,{children:"422"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"network"}),", ",(0,o.jsx)(r.code,{children:"protocol"})]}),(0,o.jsx)(r.td,{children:"503"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"internal"})}),(0,o.jsx)(r.td,{children:"500"})]})]})]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.h3,{id:"sensitive-data-redaction-redactorgo",children:["Sensitive Data Redaction (",(0,o.jsx)(r.code,{children:"redactor.go"}),")"]}),"\n",(0,o.jsx)(r.p,{children:"The redactor automatically removes credentials and PII from error context before they appear in logs or API responses."}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Key-based redaction"})," \u2014 ",(0,o.jsx)(r.code,{children:"IsSensitiveKey(key)"})," matches (case-insensitive):"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"password, passwd, secret, token, api_key, apikey, credential,\nauthorization, bearer, private_key, ssh_key, access_token,\nrefresh_token, session_id, cookie, auth_code, auth_header, client_secret\n"})}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Value-based redaction"})," \u2014 ",(0,o.jsx)(r.code,{children:"IsSensitiveValue(value)"})," detects:"]}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["JWT tokens (",(0,o.jsx)(r.code,{children:"eyJ\u2026"}),")"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"Bearer \u2026"})," strings"]}),"\n",(0,o.jsx)(r.li,{children:"Long alphanumeric strings (32\u201364 chars)"}),"\n",(0,o.jsx)(r.li,{children:"SHA-256 hashes (64 hex chars)"}),"\n",(0,o.jsx)(r.li,{children:"Base64-encoded blobs (40+ chars)"}),"\n",(0,o.jsx)(r.li,{children:"IPv4 addresses (device-identifying)"}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Functions:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'// Global helpers\nIsSensitiveKey(key string) bool\nIsSensitiveValue(value string) bool\nRedactString(key, value string) string\nRedactMap(data map[string]interface{}) map[string]interface{}\nRedactError(err *RouterError) *RouterError\n\n// Production-mode stripping\nRedactErrorForProduction(err *RouterError, requestID string) *RouterError\n// \u2192 Internal errors: replace message with generic "An internal error occurred."\n// \u2192 Other errors: RedactMap context, strip Cause, ensure requestId present\n\n// Configurable redactor (custom patterns + allowlist)\nr := apperrors.NewRedactor()\n_ = r.AddPattern(`(?i)my_custom_field`)\nr.AllowKey("model_version") // safe even if it looks like a token\nredacted := r.Redact(dataMap)\n'})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.h3,{id:"structured-logging-loggergo",children:["Structured Logging (",(0,o.jsx)(r.code,{children:"logger.go"}),")"]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"internal/logger"})," wraps zap in a singleton pattern with two pre-defined configurations:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"// Production (default)\nlogger.DefaultConfig()\n// \u2192 Level: info, JSONOutput: true, Development: false\n\n// Development\nlogger.DevelopmentConfig()\n// \u2192 Level: debug, JSONOutput: false (console with color), Development: true\n"})}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"Initialization"})," (call once at startup):"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"logger.Init(logger.DefaultConfig()) // or DevelopmentConfig()\ndefer logger.Sync()                 // flush buffered entries\n"})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Global accessors:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"logger.L() *zap.Logger          // structured logger\nlogger.S() *zap.SugaredLogger   // printf-style sugared logger\n"})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Request-correlated helpers:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'// Attach request_id field from context\nlogger.WithRequestID(ctx) *zap.Logger\n\n// Convenience shorthand (attaches request_id automatically)\nlogger.DebugCtx(ctx, "msg", zap.String("key", "value"))\nlogger.InfoCtx(ctx, "msg", ...)\nlogger.WarnCtx(ctx, "msg", ...)\nlogger.ErrorCtx(ctx, "msg", ...)\n'})}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.strong,{children:"JSON field names"})," (production output):"]}),"\n",(0,o.jsxs)(r.table,{children:[(0,o.jsx)(r.thead,{children:(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.th,{children:"Key"}),(0,o.jsx)(r.th,{children:"Content"})]})}),(0,o.jsxs)(r.tbody,{children:[(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"timestamp"})}),(0,o.jsx)(r.td,{children:"ISO 8601"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"level"})}),(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"debug"})," / ",(0,o.jsx)(r.code,{children:"info"})," / ",(0,o.jsx)(r.code,{children:"warn"})," / ",(0,o.jsx)(r.code,{children:"error"})]})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"caller"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"package/file.go:line"})})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"message"})}),(0,o.jsx)(r.td,{children:"log message"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"request_id"})}),(0,o.jsx)(r.td,{children:"from context (when set)"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"stacktrace"})}),(0,o.jsx)(r.td,{children:"only in development mode"})]})]})]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.h3,{id:"error-logging-integration-logginggo",children:["Error Logging Integration (",(0,o.jsx)(r.code,{children:"logging.go"}),")"]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"apperrors.LogLevel(category)"})," maps error category to zap level:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"CategoryAuth      \u2192 InfoLevel   // expected, not alarming\nCategoryValidation \u2192 WarnLevel\nCategoryProtocol  \u2192 WarnLevel\nCategoryNetwork   \u2192 WarnLevel\nCategoryPlatform  \u2192 WarnLevel\nCategoryResource  \u2192 WarnLevel\nCategoryInternal  \u2192 ErrorLevel  // requires investigation\n"})}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"apperrors.ErrorFields(err)"})," extracts zap fields with automatic redaction:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'[]zap.Field{\n    zap.String("error_code", "R200"),\n    zap.String("error_category", "protocol"),\n    zap.String("error_message", "SSH connection refused"),\n    zap.Bool("recoverable", true),\n    zap.Any("context", redactedCtxMap),\n    zap.Bool("has_cause", true), // true if Cause != nil (cause itself not logged)\n}\n'})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"Convenience functions for resolvers:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"// Log at correct level with structured fields\napperrors.LogError(logger, err)\n\n// Same + request_id from context\napperrors.LogErrorCtx(ctx, logger, err)\n\n// Include operation duration\napperrors.LogErrorWithDuration(logger, err, duration)\napperrors.LogErrorCtxWithDuration(ctx, logger, err, duration)\n\n// OOP-style ErrorLogger\nel := apperrors.NewErrorLogger(logger)\nel.LogCtx(ctx, err)\nel.WithRequestID(ctx).LogWithDuration(err, elapsed)\n"})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"request-id-correlation",children:"Request ID Correlation"}),"\n",(0,o.jsx)(r.p,{children:"The request ID flows through every layer:"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Middleware"})," (",(0,o.jsx)(r.code,{children:"internal/middleware/request_id.go"}),") generates a ULID at the HTTP boundary and stores it:","\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"ctx = apperrors.WithRequestID(ctx, ulid.New())\n"})}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Resolvers"})," extract it via ",(0,o.jsx)(r.code,{children:"apperrors.GetRequestID(ctx)"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"logger.WithRequestID(ctx)"})})," attaches it as a ",(0,o.jsx)(r.code,{children:"request_id"})," zap field."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:(0,o.jsx)(r.code,{children:"apperrors.ErrorPresenter"})})," includes it in every GraphQL error extension."]}),"\n"]}),"\n",(0,o.jsxs)(r.p,{children:["This allows correlating a client-facing error with the exact server log line using only the ",(0,o.jsx)(r.code,{children:"requestId"})," value."]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"graphql-directive-error-handling",children:"GraphQL Directive Error Handling"}),"\n",(0,o.jsxs)(r.p,{children:["The ",(0,o.jsx)(r.code,{children:"@validate"}),", ",(0,o.jsx)(r.code,{children:"@auth"}),", ",(0,o.jsx)(r.code,{children:"@sensitive"}),", and ",(0,o.jsx)(r.code,{children:"@capability"})," directives in ",(0,o.jsx)(r.code,{children:"internal/graphql/directives/"})," each produce structured ",(0,o.jsx)(r.code,{children:"*gqlerror.Error"})," objects with typed error codes:"]}),"\n",(0,o.jsxs)(r.table,{children:[(0,o.jsx)(r.thead,{children:(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.th,{children:"Directive"}),(0,o.jsx)(r.th,{children:"Code"}),(0,o.jsx)(r.th,{children:"Category"})]})}),(0,o.jsxs)(r.tbody,{children:[(0,o.jsxs)(r.tr,{children:[(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"@validate"})}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"V400"})}),(0,o.jsx)(r.td,{children:"validation"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"@auth"})," (unauthenticated)"]}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"A401"})}),(0,o.jsx)(r.td,{children:"auth"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"@auth"})," (wrong role)"]}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"A401"})}),(0,o.jsx)(r.td,{children:"auth"})]}),(0,o.jsxs)(r.tr,{children:[(0,o.jsxs)(r.td,{children:[(0,o.jsx)(r.code,{children:"@capability"})," (missing)"]}),(0,o.jsx)(r.td,{children:(0,o.jsx)(r.code,{children:"C403"})}),(0,o.jsx)(r.td,{children:"capability"})]})]})]}),"\n",(0,o.jsxs)(r.p,{children:["All include ",(0,o.jsx)(r.code,{children:"suggestedFix"}),", ",(0,o.jsx)(r.code,{children:"docsUrl"}),", ",(0,o.jsx)(r.code,{children:"requestId"}),", and ",(0,o.jsx)(r.code,{children:"recoverable"})," in extensions."]}),"\n",(0,o.jsxs)(r.p,{children:["The ",(0,o.jsx)(r.code,{children:"@sensitive"})," directive marks fields for log redaction: when ",(0,o.jsx)(r.code,{children:"GetSensitiveFields(ctx)"})," shows a field is sensitive, ",(0,o.jsx)(r.code,{children:"redactIfSensitive()"})," replaces the value with ",(0,o.jsx)(r.code,{children:"[REDACTED]"})," in error extensions."]}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"error-handling-patterns",children:"Error Handling Patterns"}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"In resolvers:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'// Prefer typed errors over raw fmt.Errorf\nif err := doSomething(); err != nil {\n    return nil, apperrors.Wrap(err, apperrors.CodeConnectionFailed,\n        apperrors.CategoryProtocol, "failed to execute command")\n}\n\n// Use convenience constructors for common cases\nif !authenticated {\n    return nil, apperrors.NewGraphQLAuthError(ctx, "login required", apperrors.CodeAuthFailed)\n}\n'})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"In services (non-GraphQL):"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:'// Build rich errors for cross-package boundaries\nreturn nil, apperrors.NewNetworkError(apperrors.CodeHostUnreachable, "router unreachable", host).\n    WithPort(8728).\n    WithTimeout(int(timeout.Milliseconds()))\n'})}),"\n",(0,o.jsx)(r.p,{children:(0,o.jsx)(r.strong,{children:"In background goroutines:"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-go",children:"if err != nil {\n    apperrors.LogErrorCtx(ctx, logger.L(), err)\n    // Continue or return depending on severity\n    if !apperrors.IsRecoverable(err) {\n        return\n    }\n}\n"})}),"\n",(0,o.jsx)(r.hr,{}),"\n",(0,o.jsx)(r.h2,{id:"cross-references",children:"Cross-References"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"[See: 03-graphql-api.md \xa7Error Handling] \u2014 gqlgen presenter/recoverer registration"}),"\n",(0,o.jsx)(r.li,{children:"[See: 12-security.md \xa7Audit Logging] \u2014 auth error audit trail"}),"\n",(0,o.jsxs)(r.li,{children:["[See: 02-application-bootstrap.md \xa7Logger Initialization] \u2014 ",(0,o.jsx)(r.code,{children:"logger.Init"})," call site"]}),"\n",(0,o.jsx)(r.li,{children:"[See: 04-router-communication.md \xa7Error Propagation] \u2014 ProtocolError usage in adapters"}),"\n",(0,o.jsx)(r.li,{children:"[See: 15-connection-management.md \xa7Circuit Breaker] \u2014 TransitionError from connection state"}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,d.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},71184:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>t});var s=n(14041);const o={},d=s.createContext(o);function i(e){const r=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(d.Provider,{value:r},e.children)}}}]);